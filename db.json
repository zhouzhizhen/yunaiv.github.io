{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/Staticfile","path":"Staticfile","modified":0,"renderable":0},{"_id":"themes/cactus-light/source/css/style.styl","path":"css/style.styl","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/images/favicon-192x192.png","path":"images/favicon-192x192.png","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/images/apple-touch-icon.png","path":"images/apple-touch-icon.png","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/images/favicon.ico","path":"images/favicon.ico","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/images/logo.png","path":"images/logo.png","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/justified-gallery/justifiedGallery.min.css","path":"lib/justified-gallery/justifiedGallery.min.css","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/justified-gallery/jquery.justifiedGallery.min.js","path":"lib/justified-gallery/jquery.justifiedGallery.min.js","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/styles.css","path":"lib/meslo-LG/styles.css","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/jquery/jquery.min.js","path":"lib/jquery/jquery.min.js","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGL-Italic.ttf","path":"lib/meslo-LG/fonts/MesloLGL-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGM-Italic.ttf","path":"lib/meslo-LG/fonts/MesloLGM-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGS-Italic.ttf","path":"lib/meslo-LG/fonts/MesloLGS-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGL-Bold.ttf","path":"lib/meslo-LG/fonts/MesloLGL-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGL-BoldItalic.ttf","path":"lib/meslo-LG/fonts/MesloLGL-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGL-Regular.ttf","path":"lib/meslo-LG/fonts/MesloLGL-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGM-Bold.ttf","path":"lib/meslo-LG/fonts/MesloLGM-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGM-BoldItalic.ttf","path":"lib/meslo-LG/fonts/MesloLGM-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGM-Regular.ttf","path":"lib/meslo-LG/fonts/MesloLGM-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGS-Bold.ttf","path":"lib/meslo-LG/fonts/MesloLGS-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGS-BoldItalic.ttf","path":"lib/meslo-LG/fonts/MesloLGS-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGS-Regular.ttf","path":"lib/meslo-LG/fonts/MesloLGS-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus-light/source/images/theme overview.psd","path":"images/theme overview.psd","modified":0,"renderable":1}],"Cache":[{"_id":"source/Staticfile","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1496860972000},{"_id":"themes/cactus-light/LICENSE","hash":"2f1530f30fbec68407daa54391553c3d5ff71f6a","modified":1496860972000},{"_id":"themes/cactus-light/_config.yml","hash":"22944704bd74bcbb29ecfd0b85eecbbbf413d4b1","modified":1496860972000},{"_id":"themes/cactus-light/README.md","hash":"da60bf6d6f800de621ea3a2600f4a850ddaff7d2","modified":1496860972000},{"_id":"themes/cactus-light/layout/archive.ejs","hash":"ab9798bf534485a4fed4d3089011421858afdd26","modified":1496860972000},{"_id":"themes/cactus-light/layout/index.ejs","hash":"c60cbe214fce2da24f1f4e57f54d35f47a59e867","modified":1496889778000},{"_id":"themes/cactus-light/layout/layout.ejs","hash":"56a555a41dfb9bb2e08bccfd806b647a0d4b8920","modified":1496860972000},{"_id":"themes/cactus-light/layout/page.ejs","hash":"b6b7b1e6dc856a0e62f35da0151f67ba41143e04","modified":1496860972000},{"_id":"themes/cactus-light/layout/post.ejs","hash":"2731e597b5d1714a6f5a775c432e99785f02a3e3","modified":1496860972000},{"_id":"themes/cactus-light/scripts/meta.js","hash":"fa6055a39851c9953d033e70c1614547b94dce60","modified":1496860972000},{"_id":"themes/cactus-light/scripts/thumbnail.js","hash":"df8829fd8c3119650037eba5ec11bdce06acff9d","modified":1496860972000},{"_id":"source/_posts/Architecture/2017_03_04_è°ˆè°ˆID.md","hash":"1d2d169a6003b57d8e561dab8fd0f6bc48fa9b24","modified":1496860972000},{"_id":"source/_posts/Architecture/2017_03_19_æ‰¯æ‰¯å•å…ƒæµ‹è¯•.md","hash":"a240eff5a529a634ee905a4a5bed8b2f53f247ae","modified":1496860972000},{"_id":"source/_posts/Docker/2017_02_04_Dockerç½‘ç»œâ€”â€”Flannelé…ç½®.md","hash":"c00a1e127fd3fbc656c920e66f9d9da2d8a7e633","modified":1496860972000},{"_id":"source/_posts/MyCAT/2017_05_22_ä¸ºä»€ä¹ˆé˜…è¯»MyCATæºç ï¼Ÿ.md","hash":"5c8d1c1589cab1b7edbb53a9f24809f566c09ee0","modified":1496860972000},{"_id":"source/_posts/MyCAT/2017_05_23_MyCATæºç åˆ†æâ€”â€”è°ƒè¯•ç¯å¢ƒæ­å»º.md","hash":"a9d2e90766c2d7c2b3e4ab919265f1785ea522c9","modified":1496860972000},{"_id":"source/_posts/MyCAT/2017_05_29_MyCATæºç åˆ†æâ€”â€”ã€å•åº“å•è¡¨ã€‘æ’å…¥.md","hash":"5ce0d9915a71bbab9b044b72f95d2f2347d9d7ce","modified":1496860972000},{"_id":"source/_posts/MyCAT/2017_05_30_MyCATæºç åˆ†æâ€”â€”ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢.md","hash":"bda1ca7cd75c606db6f55d65fa02c21cc418d24c","modified":1496860972000},{"_id":"source/_posts/Nginx/2017_01_07_NginxåŠ¨æ€é…ç½®upstream.md","hash":"cad717a6569e4f82aa3d3f89c84cc42ca8a5fdb0","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_03_23_ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ.md","hash":"4076dc5563e8efce60174b9b2543dfcf16f6171a","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_04_05_RocketMQä¹‹Namesrvå°ç»“.md","hash":"033b395d6134c6524db4883ef37c1f089a7b8c5b","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_04_07_RocketMQæºç åˆ†æâ€”â€”Topic.md","hash":"3b162722fa1ee8f00d539ccd5a4876ec959d955e","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_04_08_RocketMQæºç åˆ†æâ€”â€”MessageåŸºç¡€.md","hash":"06d2a199a0927bece31d4220eda23fdae636c1cd","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_04_18_RocketMQæºç åˆ†æâ€”â€”Messageå‘é€ä¸æ¥æ”¶.md","hash":"609591f4bc7f5f5835d8dec94db2ce5d15e1a5f4","modified":1496917267000},{"_id":"source/_posts/RocketMQ/2017_04_23_RocketMQæºç åˆ†æâ€”â€”Messageå­˜å‚¨.md","hash":"d4702eb6d0d27efe447e9067da23f995a38468f9","modified":1496918870000},{"_id":"source/_posts/RocketMQ/2017_05_12_RocketMQæºç åˆ†æâ€”â€”Storeåˆå§‹åŒ–ä¸å…³é—­.md","hash":"0a34e6f9b94ef5920c8e01e636bd848ffa09aaef","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_05_13_RocketMQæºç åˆ†æâ€”â€”Messageé¡ºåºå‘é€ä¸æ¶ˆè´¹.md","hash":"ed54dc7ef947a4d7a4a6ed5b075c6fffb1196b01","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_05_14_RocketMQæºç åˆ†æâ€”â€”é«˜å¯ç”¨.md","hash":"ef48198eeb40f8fe967a99f89f827a0bec99c1a0","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_05_15_RocketMQæºç åˆ†æâ€”â€”å®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•.md","hash":"4d025275cc75eeb021201efa32117a2fc715d084","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_05_17_RocketMQæºç åˆ†æâ€”â€”Filtersrv.md","hash":"9ff4e7b86323b7f2cfee137e61f9965fb9ac49e1","modified":1496860972000},{"_id":"themes/cactus-light/layout/_widget/lean-analytics.ejs","hash":"08233ac2027ec2aa76ca89435c2035a07904e34a","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/footer.ejs","hash":"eafacb50dd7585f1c4a217d113451e680de05784","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_05_21_RocketMQæºç åˆ†æâ€”â€”äº‹åŠ¡æ¶ˆæ¯.md","hash":"00ac7b5249eee21ac07d7d934a4c078309367b40","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/comments.ejs","hash":"853a4500da515ef3facc51a055886eaf8efd080d","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/head.ejs","hash":"15fd938e4e8c3f931195a4f495a800cee2587455","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/header.ejs","hash":"889fe54bbfd1fb3357e8c0614d57a437a72f782a","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/pagination.ejs","hash":"ca660c59aec56daa4a7b41715b97434d4a24c37e","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/scripts.ejs","hash":"5e2c7f394d1fb009eaaffe849104680525749901","modified":1496905377000},{"_id":"themes/cactus-light/layout/_partial/styles.ejs","hash":"e62b799d8ac369d1f1b36bd2649ecc34aec3384c","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_extend.styl","hash":"faca25132d55e8989d1c1d638e55d1e97de3c561","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_mixins.styl","hash":"c921ceb620deedddd38c9cec28190995e8764bab","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_util.styl","hash":"f8e286a21c7ec3e771d5ddeb2909ac92390af9bd","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_variables.styl","hash":"35d671e97f68b258aeb7f19d101a0850c6c20f62","modified":1496860972000},{"_id":"themes/cactus-light/source/css/style.styl","hash":"fd444326438df9d1fb26690943fd65459f0b20d3","modified":1496860972000},{"_id":"themes/cactus-light/source/images/favicon-192x192.png","hash":"96e6fcbbb13a5914a6131391e210eb7dfd13d692","modified":1496860972000},{"_id":"themes/cactus-light/source/images/apple-touch-icon.png","hash":"119559ffcb71bed428e88e28401a29aebfed674a","modified":1496860972000},{"_id":"themes/cactus-light/source/images/favicon.ico","hash":"189f9842bcb79a6f8f9e8445bc8bbd773443826b","modified":1496860972000},{"_id":"themes/cactus-light/source/images/logo.png","hash":"a25db3e5edb7be2182f4bcae98afb0dd7d6e5353","modified":1496860972000},{"_id":"themes/cactus-light/source/js/main.js","hash":"2703a7cb4fc7056d13215b9fde675da426b9cdc4","modified":1496860972000},{"_id":"source/_drafts/MyCAT/9999_99_99_MyCAT_UML.asta","hash":"9b41f540242fb30b4a90575429b05e7b61beefde","modified":1496860972000},{"_id":"source/_posts/RocketMQ/2017_05_04_RocketMQæºç åˆ†æâ€”â€”Messageæ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰.md","hash":"666960834b4ebdcbd3d4b85bfc23f35ca11d0a31","modified":1496927399000},{"_id":"source/_posts/RocketMQ/2017_05_11_RocketMQæºç åˆ†æâ€”â€”Messageæ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md","hash":"0ada8d3cc80ef803cbdb5d5db94fbb16a8df26b4","modified":1496927878000},{"_id":"source/_drafts/RocketMQ/9999_99_99_RocketMQ_UML.asta","hash":"0d2f4155546075bc31f5dfcf18359d35fe4f13d0","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/post/actions_mobile.ejs","hash":"e7638a83e5aaa4bf5b24440ca76fec8eb563bed7","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/post/actions_desktop.ejs","hash":"e454a4c3dd97ca0857431600b511e93217de353d","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/post/gallery.ejs","hash":"9aecd8908e8a684f33dc20c02497c0f1774137c7","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/post/date.ejs","hash":"12a4a7ba6334e3e5c03d9a9601d7779a27c2e082","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/post/share.ejs","hash":"25a3406f97e976ec13239f0d3f32f9e512511f50","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/post/tag.ejs","hash":"bfab03ef986d35ccad583f2d2b575db4a8d2789e","modified":1496860972000},{"_id":"themes/cactus-light/layout/_partial/post/title.ejs","hash":"a060f1c6e3718494a6b1d0e1981ea0bf4e549828","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/androidstudio.styl","hash":"65d09f1b0e81c6a182f549fd3de51e59823c97ae","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/agate.styl","hash":"601eb70448a16b918df132f6fc41e891ae053653","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/arta.styl","hash":"1a5accc115f41d1b669ed708ac6a29abac876599","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-cave-dark.styl","hash":"bc647b2c1d971d7cc947aa1ed66e9fd115261921","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-dune-dark.styl","hash":"df50a85a4b14c7ca6e825d665594b91229d0e460","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-estuary-dark.styl","hash":"d84382bc8298f96730757391d3e761b7e640f406","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-lakeside-dark.styl","hash":"bb0a8c4ad0dd8e3e7de7122ddf268fc42aa94acb","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-forest-dark.styl","hash":"57c154c6045a038dc7df0a25927853e10bf48c4a","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-heath-dark.styl","hash":"b0cf13b2233e7bc38342032d2d7296591a4c2bcf","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-plateau-dark.styl","hash":"09c64f1a7052aec9070c36c0431df25216afaea1","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-savanna-dark.styl","hash":"a16c919a1ccf2f845488078fb341381bec46b1f3","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-seaside-dark.styl","hash":"ce233a101daea7124cbfcd34add43ccfe2e1e1c7","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/codepen-embed.styl","hash":"f4dcc84d8e39f9831a5efe80e51923fc3054feb0","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/atelier-sulphurpool-dark.styl","hash":"414b0cfc142f70afe359c16450b651e28bf7325a","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/dark.styl","hash":"71ce56d311cc2f3a605f6e2c495ccd7236878404","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/darkula.styl","hash":"ad0d5728d21645039c9f199e7a56814170ed3bab","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/far.styl","hash":"d9928010ffe71e80b97a5afcba1a4975efdd7372","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/hopscotch.styl","hash":"b374c6550b89b4751aedc8fbc3cf98d95bd70ead","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/hybrid.styl","hash":"ea8d7ddc258b073308746385f5cb85aabb8bfb83","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/ir-black.styl","hash":"693078bbd72a2091ed30f506cc55949600b717af","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/kimbie.styl","hash":"45dbb168f22d739d0109745d2decd66b5f94e786","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/monokai-sublime.styl","hash":"25aa2fc1dbe38593e7c7ebe525438a39574d9935","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/monokai.styl","hash":"bd4b20bdbb3a62972f5c9e52f1f794090b8ff7f9","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/obsidian.styl","hash":"55572bbcfee1de6c31ac54681bb00336f5ae826d","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/paraiso.styl","hash":"f1537bd868579fa018ecdbfd2eb922dcf3ba2cac","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/pojoaque.styl","hash":"77dae9dc41945359d17fe84dbd317f1b40b2ee33","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/rainbow.styl","hash":"ce73b858fc0aba0e57ef9fb136c083082746bc1d","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/railscasts.styl","hash":"acd620f8bb7ff0e3fe5f9a22b4433ceef93a05e6","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/solarized-dark.styl","hash":"702b9299a48c90124e3ac1d45f1591042f2beccc","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/sunburst.styl","hash":"a0b5b5129547a23865d400cfa562ea0ac1ee3958","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/tomorrow-night-blue.styl","hash":"8b3087d4422be6eb800935a22eb11e035341c4ba","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/tomorrow-night-bright.styl","hash":"0ac6af6ecb446b5b60d6226748e4a6532db34f57","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/tomorrow-night-eighties.styl","hash":"fa57b3bb7857a160fc856dbe319b31e30cc5d771","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/tomorrow-night.styl","hash":"19b3080d4b066b40d50d7e7f297472482b5801fd","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_highlight/zenburn.styl","hash":"fc5ec840435dad80964d04519d3f882ddc03746a","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/comments.styl","hash":"11fb41241a13971d23fc3f7e6d60315c7f248396","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/archive.styl","hash":"18fa7f84a9783c5fb56c9f450ea93bd88408e682","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/footer.styl","hash":"e01bb6d5b745983148bd6b7eeccb7d4df2c55108","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/header.styl","hash":"63707d9103a283147ca222fd6f8ff9bffbffe427","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/article.styl","hash":"b90c7eebe9b39110aac089d65155e937dc1836e9","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/pagination.styl","hash":"f483e0b4e8aefaa81f5e1e5e8ab7c54f70557f75","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/index.styl","hash":"cf43702450ea1e5617541501886982a394cff8ec","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/justified-gallery/justifiedGallery.min.css","hash":"13fbcba5e97aa88b748d94d3efc4718475279907","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/justified-gallery/jquery.justifiedGallery.min.js","hash":"b2683e7a872bc109b1756a65188a37cef7d0bd5c","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/styles.css","hash":"eb88d0b9f1bbef99070e9627e2c96d892036bf7e","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/jquery/jquery.min.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/post/actions_desktop.styl","hash":"1fc72bf23c1eb93324edfb5877b45c24ae85eb99","modified":1496860972000},{"_id":"themes/cactus-light/source/css/_partial/post/actions_mobile.styl","hash":"dce6466e2ab708854c9e15173bfc19e5715d4303","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGL-Italic.ttf","hash":"96c97a0a098ca40802f948ae56fa37aa6683d034","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGM-Italic.ttf","hash":"68700db02debd4b922304134da83b829cbfddfc9","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGS-Italic.ttf","hash":"7f7cdbdcc26279c04046632e22d872f111bc9399","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGL-Bold.ttf","hash":"bfa1ed9a263ed78462f06d322de13bd5bd0906b2","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGL-BoldItalic.ttf","hash":"a9a431fc7a6c3a67c98021d4035c12a07a4f1070","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGL-Regular.ttf","hash":"2b912dd13f052f645ee19951604610bb350d50af","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGM-Bold.ttf","hash":"a8a8df3393bccc365335fc5eb0a62a6b7ccd32b9","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGM-BoldItalic.ttf","hash":"65ddb11e75ee93909e845ab912a36717c48f1c94","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGM-Regular.ttf","hash":"5e220152adefe905b2197f873d7cee99eca50e91","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGS-Bold.ttf","hash":"df202ce09cbdc70bc16b81983a13ef0f94e46f10","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGS-BoldItalic.ttf","hash":"d895a1bd25e36c58b7f463ebe14de09f186d5ab4","modified":1496860972000},{"_id":"themes/cactus-light/source/lib/meslo-LG/fonts/MesloLGS-Regular.ttf","hash":"56fa0e33a390b704afc56af93a31576ccdbbdd9e","modified":1496860972000},{"_id":"themes/cactus-light/source/images/theme overview.psd","hash":"8dc11d9d289c247423911e962c4eb3a556dc67d1","modified":1496860972000},{"_id":"public/baidu_urls.txt","hash":"7498a063f46bc76c09235c8fc03e87b7f3cbb7e7","modified":1496912800018},{"_id":"public/baidusitemap.xml","hash":"efe1c36c2da0dbf49fda9a970abdb500322b5704","modified":1496927911665},{"_id":"public/atom.xml","hash":"affffb1e60e09f329e4335bc01161719b91fa60d","modified":1496927912873},{"_id":"public/sitemap.xml","hash":"e52671a5f2a68d77e67c835dca91da550feada1f","modified":1496927912892},{"_id":"public/RocketMQ/message/index.html","hash":"fec5fc6a0533dde81e0db47ab148ecf4d70505d3","modified":1496912800923},{"_id":"public/RocketMQ/topic/index.html","hash":"75077a4965e701ee5ab87c466de5833e956c23c5","modified":1496912800923},{"_id":"public/archives/index.html","hash":"9955a47ffc3991dcbe7dca88bc07f5511763a6f7","modified":1496912800923},{"_id":"public/archives/2017/index.html","hash":"c480fbad6b36472738c8dbab94318ad61f7004e6","modified":1496912800923},{"_id":"public/archives/2017/01/index.html","hash":"b68e43c35416dd861990ebd9c96a90cddbfbb535","modified":1496912800923},{"_id":"public/archives/2017/02/index.html","hash":"e2e7724808a9731476e2d57a677ace0781d11ac5","modified":1496912800923},{"_id":"public/archives/2017/03/index.html","hash":"ebd83cfdf43dd36e67fc521f1fa6595ea1157ee4","modified":1496912800924},{"_id":"public/archives/2017/04/index.html","hash":"7f83575e5fb3306aba56ef4f70356a4e8bc3d4b9","modified":1496912800924},{"_id":"public/archives/2017/05/index.html","hash":"a5ee028fb9d9b829413e96f63b197e3ae896071f","modified":1496912800924},{"_id":"public/categories/æŠ€æœ¯æ‚æ–‡/index.html","hash":"c0746a81f64c5f8a1eea9097a0168bd9b88ff01a","modified":1496912800924},{"_id":"public/categories/Docker/index.html","hash":"2de05b950fd9c879d1dfbac03cb00b687ddc252c","modified":1496912800924},{"_id":"public/categories/MyCAT/index.html","hash":"eda531f4a283b6c8f32e1e8fac28202078538656","modified":1496912800924},{"_id":"public/categories/Nginx/index.html","hash":"3def41d267f239c91ffecf52ecf793a107f57970","modified":1496912800924},{"_id":"public/categories/RocketMQ/index.html","hash":"661c2b25fe9668c7b1aea5d4a4d2ebe4ba5123f6","modified":1496912800924},{"_id":"public/Mycat/single-db-single-table-insert/index.html","hash":"79d7c24ba06e5e84a94ea1e0f3c5ca0331c0719c","modified":1496912800924},{"_id":"public/Mycat/build-debugging-environment/index.html","hash":"0303a69507f49dc6caa2a9bc809710fad2908a5d","modified":1496912800924},{"_id":"public/RocketMQ/why-read-MyCAT-source-code/index.html","hash":"61580f088175582a14e4112f8df87d13b3c60ced","modified":1496912800924},{"_id":"public/RocketMQ/message-transaction/index.html","hash":"023a06db6bcec8b76467d463d14cfdfd2be2ac34","modified":1496912800924},{"_id":"public/RocketMQ/filtersrv/index.html","hash":"eb032751b5cb841a9349c32b0ad98e1e7772303a","modified":1496912800924},{"_id":"public/RocketMQ/message-schedule-and-retry/index.html","hash":"6f66d5229099024576210867de0b3beb7f21b5ba","modified":1496912800924},{"_id":"public/RocketMQ/high-availability/index.html","hash":"f820f0bea79b2164c5d8ded22cff12c58931c6fd","modified":1496912800924},{"_id":"public/RocketMQ/message-send-and-consume-orderly/index.html","hash":"fa4397166b5bf0fe1b784c94094abd2a1025d682","modified":1496912800925},{"_id":"public/RocketMQ/store-init-and-shutdown/index.html","hash":"dc4a60bff0da56a453b92ac1a56445ac51d7c1f7","modified":1496912800925},{"_id":"public/RocketMQ/message-pull-and-consume-second/index.html","hash":"35d234b522e306dd5111d30a0104a966d5356ac8","modified":1496927912901},{"_id":"public/RocketMQ/message-pull-and-consume-first/index.html","hash":"8a2d6f3c9aa5272a260b11a05cd0ec44ffa9d588","modified":1496927912901},{"_id":"public/RocketMQ/message-store/index.html","hash":"f9b3b8c1de7546caa9254834d642409f4371f2e1","modified":1496927912901},{"_id":"public/RocketMQ/message-send-and-receive/index.html","hash":"c40dd6036c3a03420857238a52eefaca05b56bc4","modified":1496917392261},{"_id":"public/RocketMQ/namesrv-intro/index.html","hash":"90e9d2ac024b95c71fcba1c3c60bb7eed161501b","modified":1496912800925},{"_id":"public/RocketMQ/why-read-RocketMQ-source-code/index.html","hash":"42cecefbae23dacb6fbae2c3107d54b58a2bb323","modified":1496912800925},{"_id":"public/Architecture/talk-about-java-unit-test/index.html","hash":"61cee24894859e4c88d7199c9ebe16129022d6fd","modified":1496912800925},{"_id":"public/Architecture/talk-about-global-id/index.html","hash":"309ba147b8bd59e3f4915eaba236a46d410c1093","modified":1496912800925},{"_id":"public/Docker/docker-network-flannel/index.html","hash":"5f49821886839767230996e015c507726134139a","modified":1496912800925},{"_id":"public/Nginx/nginx-dynamic-upstream/index.html","hash":"ad05d302ec33d43de1dfcea88cf2ed92478ab81e","modified":1496912800926},{"_id":"public/index.html","hash":"caa70d2bc26eb85aeec8b20a81b2641ebe2551a5","modified":1496912800926},{"_id":"public/Staticfile","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1496863372945},{"_id":"public/images/favicon-192x192.png","hash":"96e6fcbbb13a5914a6131391e210eb7dfd13d692","modified":1496863372951},{"_id":"public/images/favicon.ico","hash":"189f9842bcb79a6f8f9e8445bc8bbd773443826b","modified":1496863372951},{"_id":"public/images/apple-touch-icon.png","hash":"119559ffcb71bed428e88e28401a29aebfed674a","modified":1496863372951},{"_id":"public/images/logo.png","hash":"a25db3e5edb7be2182f4bcae98afb0dd7d6e5353","modified":1496863372951},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1496863373001},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1496863373006},{"_id":"public/js/main.js","hash":"2703a7cb4fc7056d13215b9fde675da426b9cdc4","modified":1496863373356},{"_id":"public/lib/justified-gallery/justifiedGallery.min.css","hash":"13fbcba5e97aa88b748d94d3efc4718475279907","modified":1496863373356},{"_id":"public/lib/meslo-LG/styles.css","hash":"eb88d0b9f1bbef99070e9627e2c96d892036bf7e","modified":1496863373357},{"_id":"public/lib/justified-gallery/jquery.justifiedGallery.min.js","hash":"b2683e7a872bc109b1756a65188a37cef7d0bd5c","modified":1496863373357},{"_id":"public/lib/jquery/jquery.min.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1496863373357},{"_id":"public/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1496863373357},{"_id":"public/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1496863373357},{"_id":"public/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1496863373357},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1496863373357},{"_id":"public/css/style.css","hash":"1c312411b10beb69d3534d5e1976ab0ee308848c","modified":1496863812689},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1496863373362},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1496863373381},{"_id":"public/lib/meslo-LG/fonts/MesloLGL-Italic.ttf","hash":"96c97a0a098ca40802f948ae56fa37aa6683d034","modified":1496863373384},{"_id":"public/lib/meslo-LG/fonts/MesloLGM-Italic.ttf","hash":"68700db02debd4b922304134da83b829cbfddfc9","modified":1496863373384},{"_id":"public/lib/meslo-LG/fonts/MesloLGS-Italic.ttf","hash":"7f7cdbdcc26279c04046632e22d872f111bc9399","modified":1496863373384},{"_id":"public/lib/meslo-LG/fonts/MesloLGL-Bold.ttf","hash":"bfa1ed9a263ed78462f06d322de13bd5bd0906b2","modified":1496863373385},{"_id":"public/lib/meslo-LG/fonts/MesloLGL-Regular.ttf","hash":"2b912dd13f052f645ee19951604610bb350d50af","modified":1496863373385},{"_id":"public/lib/meslo-LG/fonts/MesloLGL-BoldItalic.ttf","hash":"a9a431fc7a6c3a67c98021d4035c12a07a4f1070","modified":1496863373385},{"_id":"public/lib/meslo-LG/fonts/MesloLGM-Bold.ttf","hash":"a8a8df3393bccc365335fc5eb0a62a6b7ccd32b9","modified":1496863373386},{"_id":"public/lib/meslo-LG/fonts/MesloLGM-BoldItalic.ttf","hash":"65ddb11e75ee93909e845ab912a36717c48f1c94","modified":1496863373386},{"_id":"public/lib/meslo-LG/fonts/MesloLGS-Bold.ttf","hash":"df202ce09cbdc70bc16b81983a13ef0f94e46f10","modified":1496863373387},{"_id":"public/lib/meslo-LG/fonts/MesloLGS-BoldItalic.ttf","hash":"d895a1bd25e36c58b7f463ebe14de09f186d5ab4","modified":1496863373387},{"_id":"public/lib/meslo-LG/fonts/MesloLGS-Regular.ttf","hash":"56fa0e33a390b704afc56af93a31576ccdbbdd9e","modified":1496863373387},{"_id":"public/lib/meslo-LG/fonts/MesloLGM-Regular.ttf","hash":"5e220152adefe905b2197f873d7cee99eca50e91","modified":1496863373389},{"_id":"public/images/theme overview.psd","hash":"8dc11d9d289c247423911e962c4eb3a556dc67d1","modified":1496863373423},{"_id":"source/_posts/RocketMQ/images/1004/MappedFileçš„positionè¿ç§»å›¾.jpeg","hash":"5a5b52d1c9953acdb452303f04969ab91fc90499","modified":1492851990000},{"_id":"source/_posts/RocketMQ/images/1004/MappedFileçš„positionè¿ç§»å›¾.png","hash":"d52b4a443c39810428c1903764041ad178151802","modified":1493302307000},{"_id":"source/_posts/RocketMQ/images/1005/OffsetStoreç±»å›¾.png","hash":"4199478a664881f04da81447cb47dfa1e88b00aa","modified":1494232969000},{"_id":"source/_posts/RocketMQ/images/1005/æ¶ˆè´¹é€»è¾‘å›¾.png","hash":"af6efe1fc5110b62f7c3e8b413247f0ff4c2b91a","modified":1493471306000},{"_id":"source/_posts/RocketMQ/images/1009/HAç»„ä»¶å›¾.png","hash":"13b778de29ca42a34435467a8e1dd26bc4efa4c1","modified":1494690699000},{"_id":"source/_posts/RocketMQ/images/1001/NamesrvæŸ¥è¯¢Topicè·¯ç”±ä¿¡æ¯APIé¡ºåºå›¾.png","hash":"3268937b18691a2ee7e220f26e9a67bf2a2c0d4b","modified":1492166213000},{"_id":"source/_posts/RocketMQ/images/1003/Producerå‘é€æ¶ˆæ¯å…¨å±€é¡ºåºå›¾.png","hash":"b3aa628e59ada5030a747eb5e78a711f28162014","modified":1492189372000},{"_id":"source/_posts/RocketMQ/images/1008/Filtersrv.png","hash":"48a56b20758c4a7abffb4218fcb7c0513bfb9bcb","modified":1494946755000},{"_id":"source/_posts/RocketMQ/images/1008/Filtersrvè¿‡æ»¤ç±».png","hash":"222fbf2fc80569b9773fa74b0ea2b761d5b98148","modified":1494952095000},{"_id":"source/_posts/RocketMQ/images/1005/CommitLogé‡æ”¾ConsumeQueueå›¾.png","hash":"ebe6869dda6fd3b0a7786d7f5f66391dd3b6d98a","modified":1493472241000},{"_id":"source/_posts/RocketMQ/images/1005/Consumer&Brokeræ¶ˆè´¹ç²¾ç®€å›¾.png","hash":"1e6dbc66a38d8331770c70d0a21cfe48db111105","modified":1493471782000},{"_id":"source/_posts/RocketMQ/images/1005/ReputMessageServiceç”¨ä¾‹å›¾.png","hash":"a63f58e0effb3a8873ea2624b7fe1b8079b30b2b","modified":1493371089000},{"_id":"source/_posts/RocketMQ/images/1009/HA.WriteSocketServiceæµç¨‹å›¾.png","hash":"f3958c674425cb79ab06d4c1ccba7c70305a7adf","modified":1494739015000},{"_id":"source/_posts/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png","hash":"1c706df9958baabf2832906b60e0e95e0aed3bc0","modified":1494841151000},{"_id":"source/_posts/RocketMQ/images/1011/Broker_V4.0.0_åŸºäºæ•°æ®åº“.jpeg","hash":"b67fc3498fa04738d5a082c4516522c3e21898ef","modified":1495355263000},{"_id":"source/_posts/RocketMQ/images/1003/Brokeræ¥æ”¶å‘é€æ¶ˆæ¯APIé¡ºåºå›¾.png","hash":"5a25847f17e89e2dc06fbc9bbbf2d47d026abca0","modified":1492172881000},{"_id":"source/_posts/RocketMQ/images/1004/FlushCommitLogServiceç±»å›¾.png","hash":"4ceee5f7cba116bef932b1cb032d4a4f0f4056ad","modified":1492846846000},{"_id":"source/_posts/RocketMQ/images/1008/Filtersrvè¿‡å¯ç”¨.png","hash":"15ef6e0819964f494b3e399756875f12eb91a025","modified":1494955939000},{"_id":"source/_posts/RocketMQ/images/1009/HAClienté¡ºåºå›¾.png","hash":"345f2f4d20b127452e8284e69405b2921c8190bf","modified":1494729452000},{"_id":"source/_posts/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘.png","hash":"d7206b55564be60518e67e31167605c5c732e005","modified":1494856203000},{"_id":"source/_posts/RocketMQ/images/1005/DefaultMQPushConsumerImplæ¶ˆè´¹æ¶ˆæ¯.png","hash":"1b0c8e22ede0536ecd2e4c29adaf49dcc0d0edde","modified":1494176016000},{"_id":"source/_posts/RocketMQ/images/1005/RebalanceService&PushConsumeråˆ†é…é˜Ÿåˆ—.png","hash":"44f1db16ad2d8497c4be0128a1a5e63859ef399d","modified":1493653575000},{"_id":"source/_posts/RocketMQ/images/1011/Producerå‘é€äº‹åŠ¡æ¶ˆæ¯.png","hash":"4e910af427fed9129a3aefc9a61135e733eb35c2","modified":1495219487000},{"_id":"source/_posts/RocketMQ/images/1011/Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘.png","hash":"9259a6cfc076e49c887acce8bdd3fdc069be4b28","modified":1495264297000},{"_id":"source/_posts/RocketMQ/images/0002/D38F6CD6-79DF-4997-B611-13D4CE902A52.png","hash":"07f3c18934db85f47dcb5a53430365503e56047c","modified":1490510515000},{"_id":"source/_posts/RocketMQ/images/1003/Clientä¹‹Latencyç±»å›¾.png","hash":"e05c9896441da61078d4747938744a51250fa1e7","modified":1492279644000},{"_id":"source/_posts/RocketMQ/images/1005/PushConsumeræ‰‹ç»˜å›¾.png","hash":"a5939b38e84e994942ff2f442be9c2aaba6871be","modified":1493621739000},{"_id":"source/_posts/RocketMQ/images/1009/Producer.TopicPublishInfo.è°ƒè¯•.png","hash":"5c9027bae1aa229309a9a9492453c443de990cf0","modified":1494762116000},{"_id":"source/_posts/RocketMQ/images/1007/é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯.png","hash":"63ff3015ede1d63c8b5b6ab511c4dd1a896cfbb4","modified":1494433890000},{"_id":"source/_posts/RocketMQ/images/1004/Brokerå­˜å‚¨å‘é€æ¶ˆæ¯é¡ºåºå›¾.png","hash":"ee0ee05396ae9052d9277f969c63d866972530f4","modified":1492187361000},{"_id":"source/_posts/RocketMQ/images/1005/AllocateMessageQueueStrategyç±»å›¾.png","hash":"bb0f512587a1bdfc5a9e1484922c1bda14717590","modified":1493754186000},{"_id":"source/_posts/RocketMQ/images/1005/DefaultMQPushConsumerImplæ‹‰å–æ¶ˆæ¯.png","hash":"e170fe4da5e4a762a408a4e273f1d319c21d76ff","modified":1493806326000},{"_id":"source/_posts/RocketMQ/images/1005/PullMessageProcessoræ‹‰å–æ¶ˆæ¯çŠ¶æ€å›¾.png","hash":"8dc1b9f707739483f6cb348d4fe0c6fb2548960d","modified":1493476566000},{"_id":"source/_posts/RocketMQ/images/1003/Producerå‘é€æ¶ˆæ¯é¡ºåºå›¾.png","hash":"4ff2abc53584977f5893e8ba9d5302f3e80990d4","modified":1492135423000},{"_id":"source/_posts/RocketMQ/images/1004/MappedQueueä¸MappedFileç±»å›¾.png","hash":"eff480cc55c113b4180db49fb81b4f33fe57314c","modified":1492692090000},{"_id":"source/_posts/RocketMQ/images/1005/ReputMessageServiceé¡ºåºå›¾.png","hash":"8697557bbc343c17d10bd03ebca4fcc4e9b358eb","modified":1493320896000},{"_id":"source/_posts/RocketMQ/images/1011/Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ.jpeg","hash":"878551c2b92a57301bea7896fe892a3c36abc795","modified":1495335020000},{"_id":"source/_posts/RocketMQ/images/1005/ConsumeQueueç±»å›¾.png","hash":"e074abb44f625f9397be5d266e1f6510daf7c6cc","modified":1493392265000},{"_id":"source/_posts/RocketMQ/images/1004/CommitLog&MappedQueue&MappedFileç±»å›¾.png","hash":"6a38e586cb4265e200d90ac98bbb68eacdabd942","modified":1492762869000},{"_id":"source/_posts/RocketMQ/images/1009/HAæ€»ç»“.jpeg","hash":"4a361f1cbdb5fe47eda8bde9ee3abf46844954a8","modified":1494767504000}],"Category":[{"name":"æŠ€æœ¯æ‚æ–‡","_id":"cj3ndswy50002ak5dnd6bu0d3"},{"name":"Docker","_id":"cj3ndswyd0007ak5dmtdscxhm"},{"name":"MyCAT","_id":"cj3ndswyd0009ak5d4emm1j22"},{"name":"Nginx","_id":"cj3ndswz7000hak5dxnh6u0px"},{"name":"RocketMQ","_id":"cj3ndswzd000mak5d0zzzjv6s"}],"Data":[],"Page":[],"Post":[{"title":"è°ˆè°ˆ ID","date":"2017-03-03T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[è°ˆè°ˆID](https://github.com/YunaiV/Blog/blob/master/Architecture/0001-%E8%B0%88%E8%B0%88ID.md)  \n> **ğŸ˜ˆæ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ•°æ®åº“è‡ªå¢](#)\n- [2. ç±»UUIDç®—æ³•](#)\n- [3. SnowFlake](#)\n\t- [3.1 Twitter-Snowflake](#)\n\t- [3.2 Instagram SnowFlake](#)\n\t- [3.3 Simpleflake](#)\n\t- [3.4 Boundary flake](#)\n\t- [3.5 è‡ªå·±çš„æƒ³æ³•](#)\n- [4. å‚è€ƒæ–‡ç« ](#)\n- [è‰ç¨¿](#)\n\n\nåœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ•°æ®åº“çš„idæ˜¯ä¸å¯å°‘çš„ã€‚åœ¨å„ä¸ªåœºæ™¯ä¸‹ä¼šæœ‰ä¸åŒçš„é€‰æ‹©ï¼Œæœ¬æ–‡å¯¹äº’è”ç½‘ä¸Šå¸¸è§çš„IDç®—æ³•è¿›è¡Œå½’çº³ï¼Œå¸Œæœ›å¯¹å·¥ç¨‹å¸ˆä»¬æœ‰ä¸€ç‚¹ç‚¹å¸®åŠ©ã€‚\n\n# 1. æ•°æ®åº“è‡ªå¢\n1. MySQLã€Oracleã€PGSQLç­‰å…³ç³»æ•°æ®åº“çš„idä¸»é”®è‡ªå¢\n2. Redisã€Memcachedç­‰K/Væ•°æ®åº“çš„incræ“ä½œè‡ªå¢\n    * éœ€è¦è€ƒè™‘æŒä¹…åŒ–çš„é—®é¢˜\n3. MongoDBè‡ªå·±ç»´æŠ¤ä¸€ä¸ªidè‡ªå¢é›†åˆ\n    * MongoDBçš„Updateæ“ä½œæ”¯æŒincræ“ä½œï¼Œå› æ­¤å¯ä»¥è¿™ä¹ˆåšã€‚\n    * è¯¥æ–¹å¼é€‚ç”¨äºæ”¯æŒè¯¥æ“ä½œçš„å…¶ä»–æ•°æ®åº“ã€‚\n\n# 2. ç±»UUIDç®—æ³•\n1. UUID\n2. MongoDBçš„ObjectId\n\n# 3. SnowFlake\n\n## 3.1 Twitter-Snowflake\n \n>  Twitter-Snowflakeç®—æ³•äº§ç”Ÿçš„èƒŒæ™¯ç›¸å½“ç®€å•ï¼Œä¸ºäº†æ»¡è¶³Twitteræ¯ç§’ä¸Šä¸‡æ¡æ¶ˆæ¯çš„è¯·æ±‚ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½å¿…é¡»åˆ†é…ä¸€æ¡å”¯ä¸€çš„idï¼Œè¿™äº›idè¿˜éœ€è¦ä¸€äº›å¤§è‡´çš„é¡ºåºï¼ˆæ–¹ä¾¿å®¢æˆ·ç«¯æ’åºï¼‰ï¼Œå¹¶ä¸”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸åŒæœºå™¨äº§ç”Ÿçš„idå¿…é¡»ä¸åŒã€‚\n\n64bitsä»å·¦å¾€å³ä¾æ¬¡æ˜¯\n\n* 1bit ä¿ç•™\n* 41bits æ—¶é—´æˆ³\n    * æ”¯æŒ69.7å¹´éœ€è¦çš„idã€‚2 ^41 /365/24/60/60/1000=69.7\n* 10bits work-id\n    * æ”¯æŒ1024ä¸ªwork\n* 12bits sequence-id\n    * æ”¯æŒæ¯workæ¯æ¯«ç§’4096ä¸ªid\n    * æ”¯æŒæ¯workæ¯ç§’4096000ä¸ªid\n    * è‹¥å½“å‰æ¯«ç§’è¶…è¿‡4096ï¼Œåˆ™sleep1æ¯«ç§’ï¼Œè·å–ä¸‹ä¸€æ¯«ç§’çš„è‡ªå¢\n \n** snowflakeçš„æ„ä¹‰ï¼Œä¸ä»…ä»…åœ¨äºæä¾›äº†è§£å†³æ–¹å¼ï¼Œæ›´å¤šçš„æ˜¯ä¸€ç§åŸºäºLongé•¿åº¦å®ç°å…·æœ‰æ—¶é—´ç›¸å…³æ€§çš„idè‡ªå¢åºåˆ—ã€‚å› æ­¤ï¼Œå¾ˆå¤šå…¬å¸åŸºäºå®ƒè¿›è¡ŒäºŒæ¬¡æ”¹é€ é€‚åº”è‡ªå·±çš„åœºæ™¯ **\n\n## 3.2 Instagram SnowFlake\n\nå»ä¸­æ€§åŒ–ï¼ŒåŸºäºPGSQLå®ç°\n\n64bitsä»å·¦è‡³å³ä¾æ¬¡æ˜¯\n\n* 41bits æ—¶é—´æˆ³\n* 13bits logic-shard-id\n* 10bits sequence-id\n\nå®ç°æ–¹å¼\n\n* æ ¹æ®`share-key`è·å–å¯¹åº”çš„PGSQLå®ä¾‹-åº“\n* idä½¿ç”¨PGSQLçš„å­˜å‚¨è¿‡ç¨‹\n* 13bits = `share-keyå¯¹åº”å€¼%logic-share-id` \n* 10bits = `è¯¥Tableçš„auto_increment_id%(2 ^10)`\n\nå¥½å¤„\n\n* å»ä¸­æ€§åŒ–\n* æ ¹æ®idå¯ä»¥è·å¾—å¯¹åº”PGSQLå®ä¾‹-åº“\n\n## 3.3 Simpleflake\n\n64bits\n\n * å»ä¸­æ€§åŒ–\n * å°†work-idçš„12bitsç»™sequence-idã€‚å®Œå…¨éšæœºï¼Œæ¯æ¯«ç§’æœ‰1/(2^22 )å‡ºç°å†²çªçš„æƒ…å†µã€‚æ•°æ®é‡å¤§æ—¶éœ€è¦æ³¨æ„ã€‚\n * æœªæ¥å¯ä»¥å¹³æ»‘è¿ç§»åˆ°Twitter SnowFlake\n\n## 3.4 Boundary flake\n\nå»ä¸­æ€§åŒ–ï¼ŒåŸºäºerlangå®ç°\n128bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯\n\n* 64bits æ—¶é—´æˆ³\n    * å’Œæ¯«ç§’æ—¶é—´æˆ³ç­‰é•¿\n* 48bits work-id\n    * å’Œmacåœ°å€ç­‰é•¿ï¼Œä½¿ç”¨æ—¶è¦é¿å…ç›¸åŒmacå¤šä¸ªè¿›ç¨‹\n* 14bits sequence-id\n\n## 3.5 è‡ªå·±çš„æƒ³æ³•\n\n***å‚è€ƒInstagram SnowFlakeçš„åšæ³•***\n\nå»ä¸­å¿ƒåŒ–ï¼ŒåŸºäºrediså®ç°\n64bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯\n\n* 1bit ä¿ç•™\n* 41bits æ—¶é—´æˆ³\n* 12bits åŸºäºlogic-shard-id\n* 10bits åŸºäºæ—¶é—´æˆ³+logic-shard-idåœ¨redisé‡Œè‡ªå¢\n\n# 4. å‚è€ƒæ–‡ç« \n\n1. [äº’è”ç½‘åˆ†å¸ƒå¼idç”Ÿæˆæ–¹æ³•|msupå¾®è¯¾å¹²è´§](http://mp.weixin.qq.com/s?__biz=MzAwNjE3ODQ4NQ==&mid=2650896366&idx=1&sn=5d5acdf323df2b6d581249b32031ccd7&scene=1&srcid=0618GuDjWjenr7TacVTFj6VU#rd)\n2. [æœåŠ¡åŒ–æ¡†æ¶ï¼åˆ†å¸ƒå¼Unique IDçš„ç”Ÿæˆæ–¹æ³•ä¸€è§ˆ](http://calvin1978.blogcn.com/articles/uuid.html?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)\n3. [åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ Unique ID çš„ç”Ÿæˆæ–¹æ³•](https://www.google.co.jp/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&oq=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&aqs=chrome..69i57.291j0j1&sourceid=chrome&ie=UTF-8)\n\n\n# è‰ç¨¿\n\n1. 2å®ä¾‹ã€4åˆ†è¡¨\n* aï¼š0*2*4*6\n* bï¼š1*3*5*7\n\n2. 4å®ä¾‹ã€4åˆ†è¡¨\n* aï¼š0*4*8*12\n* bï¼š1*5*9*13\n* cï¼š2*6*10*14\n* dï¼š3*7*11*15\n\næ‰©å±•æ–¹å¼ï¼š\n* aä¸cåŒä¸»ã€ˆa cã€‰\n* bä¸dåŒä¸»ã€ˆb dã€‰","source":"_posts/Architecture/2017_03_04_è°ˆè°ˆID.md","raw":"title: è°ˆè°ˆ ID\ndate: 2017-03-04\ntags:\ncategories: æŠ€æœ¯æ‚æ–‡\npermalink: Architecture/talk-about-global-id\n\n---\n\n>  åŸæ–‡åœ°å€ï¼š[è°ˆè°ˆID](https://github.com/YunaiV/Blog/blob/master/Architecture/0001-%E8%B0%88%E8%B0%88ID.md)  \n> **ğŸ˜ˆæ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ•°æ®åº“è‡ªå¢](#)\n- [2. ç±»UUIDç®—æ³•](#)\n- [3. SnowFlake](#)\n\t- [3.1 Twitter-Snowflake](#)\n\t- [3.2 Instagram SnowFlake](#)\n\t- [3.3 Simpleflake](#)\n\t- [3.4 Boundary flake](#)\n\t- [3.5 è‡ªå·±çš„æƒ³æ³•](#)\n- [4. å‚è€ƒæ–‡ç« ](#)\n- [è‰ç¨¿](#)\n\n\nåœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ•°æ®åº“çš„idæ˜¯ä¸å¯å°‘çš„ã€‚åœ¨å„ä¸ªåœºæ™¯ä¸‹ä¼šæœ‰ä¸åŒçš„é€‰æ‹©ï¼Œæœ¬æ–‡å¯¹äº’è”ç½‘ä¸Šå¸¸è§çš„IDç®—æ³•è¿›è¡Œå½’çº³ï¼Œå¸Œæœ›å¯¹å·¥ç¨‹å¸ˆä»¬æœ‰ä¸€ç‚¹ç‚¹å¸®åŠ©ã€‚\n\n# 1. æ•°æ®åº“è‡ªå¢\n1. MySQLã€Oracleã€PGSQLç­‰å…³ç³»æ•°æ®åº“çš„idä¸»é”®è‡ªå¢\n2. Redisã€Memcachedç­‰K/Væ•°æ®åº“çš„incræ“ä½œè‡ªå¢\n    * éœ€è¦è€ƒè™‘æŒä¹…åŒ–çš„é—®é¢˜\n3. MongoDBè‡ªå·±ç»´æŠ¤ä¸€ä¸ªidè‡ªå¢é›†åˆ\n    * MongoDBçš„Updateæ“ä½œæ”¯æŒincræ“ä½œï¼Œå› æ­¤å¯ä»¥è¿™ä¹ˆåšã€‚\n    * è¯¥æ–¹å¼é€‚ç”¨äºæ”¯æŒè¯¥æ“ä½œçš„å…¶ä»–æ•°æ®åº“ã€‚\n\n# 2. ç±»UUIDç®—æ³•\n1. UUID\n2. MongoDBçš„ObjectId\n\n# 3. SnowFlake\n\n## 3.1 Twitter-Snowflake\n \n>  Twitter-Snowflakeç®—æ³•äº§ç”Ÿçš„èƒŒæ™¯ç›¸å½“ç®€å•ï¼Œä¸ºäº†æ»¡è¶³Twitteræ¯ç§’ä¸Šä¸‡æ¡æ¶ˆæ¯çš„è¯·æ±‚ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½å¿…é¡»åˆ†é…ä¸€æ¡å”¯ä¸€çš„idï¼Œè¿™äº›idè¿˜éœ€è¦ä¸€äº›å¤§è‡´çš„é¡ºåºï¼ˆæ–¹ä¾¿å®¢æˆ·ç«¯æ’åºï¼‰ï¼Œå¹¶ä¸”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸åŒæœºå™¨äº§ç”Ÿçš„idå¿…é¡»ä¸åŒã€‚\n\n64bitsä»å·¦å¾€å³ä¾æ¬¡æ˜¯\n\n* 1bit ä¿ç•™\n* 41bits æ—¶é—´æˆ³\n    * æ”¯æŒ69.7å¹´éœ€è¦çš„idã€‚2 ^41 /365/24/60/60/1000=69.7\n* 10bits work-id\n    * æ”¯æŒ1024ä¸ªwork\n* 12bits sequence-id\n    * æ”¯æŒæ¯workæ¯æ¯«ç§’4096ä¸ªid\n    * æ”¯æŒæ¯workæ¯ç§’4096000ä¸ªid\n    * è‹¥å½“å‰æ¯«ç§’è¶…è¿‡4096ï¼Œåˆ™sleep1æ¯«ç§’ï¼Œè·å–ä¸‹ä¸€æ¯«ç§’çš„è‡ªå¢\n \n** snowflakeçš„æ„ä¹‰ï¼Œä¸ä»…ä»…åœ¨äºæä¾›äº†è§£å†³æ–¹å¼ï¼Œæ›´å¤šçš„æ˜¯ä¸€ç§åŸºäºLongé•¿åº¦å®ç°å…·æœ‰æ—¶é—´ç›¸å…³æ€§çš„idè‡ªå¢åºåˆ—ã€‚å› æ­¤ï¼Œå¾ˆå¤šå…¬å¸åŸºäºå®ƒè¿›è¡ŒäºŒæ¬¡æ”¹é€ é€‚åº”è‡ªå·±çš„åœºæ™¯ **\n\n## 3.2 Instagram SnowFlake\n\nå»ä¸­æ€§åŒ–ï¼ŒåŸºäºPGSQLå®ç°\n\n64bitsä»å·¦è‡³å³ä¾æ¬¡æ˜¯\n\n* 41bits æ—¶é—´æˆ³\n* 13bits logic-shard-id\n* 10bits sequence-id\n\nå®ç°æ–¹å¼\n\n* æ ¹æ®`share-key`è·å–å¯¹åº”çš„PGSQLå®ä¾‹-åº“\n* idä½¿ç”¨PGSQLçš„å­˜å‚¨è¿‡ç¨‹\n* 13bits = `share-keyå¯¹åº”å€¼%logic-share-id` \n* 10bits = `è¯¥Tableçš„auto_increment_id%(2 ^10)`\n\nå¥½å¤„\n\n* å»ä¸­æ€§åŒ–\n* æ ¹æ®idå¯ä»¥è·å¾—å¯¹åº”PGSQLå®ä¾‹-åº“\n\n## 3.3 Simpleflake\n\n64bits\n\n * å»ä¸­æ€§åŒ–\n * å°†work-idçš„12bitsç»™sequence-idã€‚å®Œå…¨éšæœºï¼Œæ¯æ¯«ç§’æœ‰1/(2^22 )å‡ºç°å†²çªçš„æƒ…å†µã€‚æ•°æ®é‡å¤§æ—¶éœ€è¦æ³¨æ„ã€‚\n * æœªæ¥å¯ä»¥å¹³æ»‘è¿ç§»åˆ°Twitter SnowFlake\n\n## 3.4 Boundary flake\n\nå»ä¸­æ€§åŒ–ï¼ŒåŸºäºerlangå®ç°\n128bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯\n\n* 64bits æ—¶é—´æˆ³\n    * å’Œæ¯«ç§’æ—¶é—´æˆ³ç­‰é•¿\n* 48bits work-id\n    * å’Œmacåœ°å€ç­‰é•¿ï¼Œä½¿ç”¨æ—¶è¦é¿å…ç›¸åŒmacå¤šä¸ªè¿›ç¨‹\n* 14bits sequence-id\n\n## 3.5 è‡ªå·±çš„æƒ³æ³•\n\n***å‚è€ƒInstagram SnowFlakeçš„åšæ³•***\n\nå»ä¸­å¿ƒåŒ–ï¼ŒåŸºäºrediså®ç°\n64bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯\n\n* 1bit ä¿ç•™\n* 41bits æ—¶é—´æˆ³\n* 12bits åŸºäºlogic-shard-id\n* 10bits åŸºäºæ—¶é—´æˆ³+logic-shard-idåœ¨redisé‡Œè‡ªå¢\n\n# 4. å‚è€ƒæ–‡ç« \n\n1. [äº’è”ç½‘åˆ†å¸ƒå¼idç”Ÿæˆæ–¹æ³•|msupå¾®è¯¾å¹²è´§](http://mp.weixin.qq.com/s?__biz=MzAwNjE3ODQ4NQ==&mid=2650896366&idx=1&sn=5d5acdf323df2b6d581249b32031ccd7&scene=1&srcid=0618GuDjWjenr7TacVTFj6VU#rd)\n2. [æœåŠ¡åŒ–æ¡†æ¶ï¼åˆ†å¸ƒå¼Unique IDçš„ç”Ÿæˆæ–¹æ³•ä¸€è§ˆ](http://calvin1978.blogcn.com/articles/uuid.html?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)\n3. [åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ Unique ID çš„ç”Ÿæˆæ–¹æ³•](https://www.google.co.jp/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&oq=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&aqs=chrome..69i57.291j0j1&sourceid=chrome&ie=UTF-8)\n\n\n# è‰ç¨¿\n\n1. 2å®ä¾‹ã€4åˆ†è¡¨\n* aï¼š0*2*4*6\n* bï¼š1*3*5*7\n\n2. 4å®ä¾‹ã€4åˆ†è¡¨\n* aï¼š0*4*8*12\n* bï¼š1*5*9*13\n* cï¼š2*6*10*14\n* dï¼š3*7*11*15\n\næ‰©å±•æ–¹å¼ï¼š\n* aä¸cåŒä¸»ã€ˆa cã€‰\n* bä¸dåŒä¸»ã€ˆb dã€‰","slug":"Architecture/talk-about-global-id","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswxz0000ak5ddsagcmr8","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Architecture/0001-%E8%B0%88%E8%B0%88ID.md\" target=\"_blank\" rel=\"external\">è°ˆè°ˆID</a><br><strong>ğŸ˜ˆæ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ•°æ®åº“è‡ªå¢</a></li>\n<li><a href=\"#\">2. ç±»UUIDç®—æ³•</a></li>\n<li><a href=\"#\">3. SnowFlake</a><ul>\n<li><a href=\"#\">3.1 Twitter-Snowflake</a></li>\n<li><a href=\"#\">3.2 Instagram SnowFlake</a></li>\n<li><a href=\"#\">3.3 Simpleflake</a></li>\n<li><a href=\"#\">3.4 Boundary flake</a></li>\n<li><a href=\"#\">3.5 è‡ªå·±çš„æƒ³æ³•</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4. å‚è€ƒæ–‡ç« </a></li>\n<li><a href=\"#\">è‰ç¨¿</a></li>\n</ul>\n<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ•°æ®åº“çš„idæ˜¯ä¸å¯å°‘çš„ã€‚åœ¨å„ä¸ªåœºæ™¯ä¸‹ä¼šæœ‰ä¸åŒçš„é€‰æ‹©ï¼Œæœ¬æ–‡å¯¹äº’è”ç½‘ä¸Šå¸¸è§çš„IDç®—æ³•è¿›è¡Œå½’çº³ï¼Œå¸Œæœ›å¯¹å·¥ç¨‹å¸ˆä»¬æœ‰ä¸€ç‚¹ç‚¹å¸®åŠ©ã€‚</p>\n<h1 id=\"1-æ•°æ®åº“è‡ªå¢\"><a href=\"#1-æ•°æ®åº“è‡ªå¢\" class=\"headerlink\" title=\"1. æ•°æ®åº“è‡ªå¢\"></a>1. æ•°æ®åº“è‡ªå¢</h1><ol>\n<li>MySQLã€Oracleã€PGSQLç­‰å…³ç³»æ•°æ®åº“çš„idä¸»é”®è‡ªå¢</li>\n<li>Redisã€Memcachedç­‰K/Væ•°æ®åº“çš„incræ“ä½œè‡ªå¢<ul>\n<li>éœ€è¦è€ƒè™‘æŒä¹…åŒ–çš„é—®é¢˜</li>\n</ul>\n</li>\n<li>MongoDBè‡ªå·±ç»´æŠ¤ä¸€ä¸ªidè‡ªå¢é›†åˆ<ul>\n<li>MongoDBçš„Updateæ“ä½œæ”¯æŒincræ“ä½œï¼Œå› æ­¤å¯ä»¥è¿™ä¹ˆåšã€‚</li>\n<li>è¯¥æ–¹å¼é€‚ç”¨äºæ”¯æŒè¯¥æ“ä½œçš„å…¶ä»–æ•°æ®åº“ã€‚</li>\n</ul>\n</li>\n</ol>\n<h1 id=\"2-ç±»UUIDç®—æ³•\"><a href=\"#2-ç±»UUIDç®—æ³•\" class=\"headerlink\" title=\"2. ç±»UUIDç®—æ³•\"></a>2. ç±»UUIDç®—æ³•</h1><ol>\n<li>UUID</li>\n<li>MongoDBçš„ObjectId</li>\n</ol>\n<h1 id=\"3-SnowFlake\"><a href=\"#3-SnowFlake\" class=\"headerlink\" title=\"3. SnowFlake\"></a>3. SnowFlake</h1><h2 id=\"3-1-Twitter-Snowflake\"><a href=\"#3-1-Twitter-Snowflake\" class=\"headerlink\" title=\"3.1 Twitter-Snowflake\"></a>3.1 Twitter-Snowflake</h2><blockquote>\n<p> Twitter-Snowflakeç®—æ³•äº§ç”Ÿçš„èƒŒæ™¯ç›¸å½“ç®€å•ï¼Œä¸ºäº†æ»¡è¶³Twitteræ¯ç§’ä¸Šä¸‡æ¡æ¶ˆæ¯çš„è¯·æ±‚ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½å¿…é¡»åˆ†é…ä¸€æ¡å”¯ä¸€çš„idï¼Œè¿™äº›idè¿˜éœ€è¦ä¸€äº›å¤§è‡´çš„é¡ºåºï¼ˆæ–¹ä¾¿å®¢æˆ·ç«¯æ’åºï¼‰ï¼Œå¹¶ä¸”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸åŒæœºå™¨äº§ç”Ÿçš„idå¿…é¡»ä¸åŒã€‚</p>\n</blockquote>\n<p>64bitsä»å·¦å¾€å³ä¾æ¬¡æ˜¯</p>\n<ul>\n<li>1bit ä¿ç•™</li>\n<li>41bits æ—¶é—´æˆ³<ul>\n<li>æ”¯æŒ69.7å¹´éœ€è¦çš„idã€‚2 ^41 /365/24/60/60/1000=69.7</li>\n</ul>\n</li>\n<li>10bits work-id<ul>\n<li>æ”¯æŒ1024ä¸ªwork</li>\n</ul>\n</li>\n<li>12bits sequence-id<ul>\n<li>æ”¯æŒæ¯workæ¯æ¯«ç§’4096ä¸ªid</li>\n<li>æ”¯æŒæ¯workæ¯ç§’4096000ä¸ªid</li>\n<li>è‹¥å½“å‰æ¯«ç§’è¶…è¿‡4096ï¼Œåˆ™sleep1æ¯«ç§’ï¼Œè·å–ä¸‹ä¸€æ¯«ç§’çš„è‡ªå¢</li>\n</ul>\n</li>\n</ul>\n<p><strong> snowflakeçš„æ„ä¹‰ï¼Œä¸ä»…ä»…åœ¨äºæä¾›äº†è§£å†³æ–¹å¼ï¼Œæ›´å¤šçš„æ˜¯ä¸€ç§åŸºäºLongé•¿åº¦å®ç°å…·æœ‰æ—¶é—´ç›¸å…³æ€§çš„idè‡ªå¢åºåˆ—ã€‚å› æ­¤ï¼Œå¾ˆå¤šå…¬å¸åŸºäºå®ƒè¿›è¡ŒäºŒæ¬¡æ”¹é€ é€‚åº”è‡ªå·±çš„åœºæ™¯ </strong></p>\n<h2 id=\"3-2-Instagram-SnowFlake\"><a href=\"#3-2-Instagram-SnowFlake\" class=\"headerlink\" title=\"3.2 Instagram SnowFlake\"></a>3.2 Instagram SnowFlake</h2><p>å»ä¸­æ€§åŒ–ï¼ŒåŸºäºPGSQLå®ç°</p>\n<p>64bitsä»å·¦è‡³å³ä¾æ¬¡æ˜¯</p>\n<ul>\n<li>41bits æ—¶é—´æˆ³</li>\n<li>13bits logic-shard-id</li>\n<li>10bits sequence-id</li>\n</ul>\n<p>å®ç°æ–¹å¼</p>\n<ul>\n<li>æ ¹æ®<code>share-key</code>è·å–å¯¹åº”çš„PGSQLå®ä¾‹-åº“</li>\n<li>idä½¿ç”¨PGSQLçš„å­˜å‚¨è¿‡ç¨‹</li>\n<li>13bits = <code>share-keyå¯¹åº”å€¼%logic-share-id</code> </li>\n<li>10bits = <code>è¯¥Tableçš„auto_increment_id%(2 ^10)</code></li>\n</ul>\n<p>å¥½å¤„</p>\n<ul>\n<li>å»ä¸­æ€§åŒ–</li>\n<li>æ ¹æ®idå¯ä»¥è·å¾—å¯¹åº”PGSQLå®ä¾‹-åº“</li>\n</ul>\n<h2 id=\"3-3-Simpleflake\"><a href=\"#3-3-Simpleflake\" class=\"headerlink\" title=\"3.3 Simpleflake\"></a>3.3 Simpleflake</h2><p>64bits</p>\n<ul>\n<li>å»ä¸­æ€§åŒ–</li>\n<li>å°†work-idçš„12bitsç»™sequence-idã€‚å®Œå…¨éšæœºï¼Œæ¯æ¯«ç§’æœ‰1/(2^22 )å‡ºç°å†²çªçš„æƒ…å†µã€‚æ•°æ®é‡å¤§æ—¶éœ€è¦æ³¨æ„ã€‚</li>\n<li>æœªæ¥å¯ä»¥å¹³æ»‘è¿ç§»åˆ°Twitter SnowFlake</li>\n</ul>\n<h2 id=\"3-4-Boundary-flake\"><a href=\"#3-4-Boundary-flake\" class=\"headerlink\" title=\"3.4 Boundary flake\"></a>3.4 Boundary flake</h2><p>å»ä¸­æ€§åŒ–ï¼ŒåŸºäºerlangå®ç°<br>128bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯</p>\n<ul>\n<li>64bits æ—¶é—´æˆ³<ul>\n<li>å’Œæ¯«ç§’æ—¶é—´æˆ³ç­‰é•¿</li>\n</ul>\n</li>\n<li>48bits work-id<ul>\n<li>å’Œmacåœ°å€ç­‰é•¿ï¼Œä½¿ç”¨æ—¶è¦é¿å…ç›¸åŒmacå¤šä¸ªè¿›ç¨‹</li>\n</ul>\n</li>\n<li>14bits sequence-id</li>\n</ul>\n<h2 id=\"3-5-è‡ªå·±çš„æƒ³æ³•\"><a href=\"#3-5-è‡ªå·±çš„æƒ³æ³•\" class=\"headerlink\" title=\"3.5 è‡ªå·±çš„æƒ³æ³•\"></a>3.5 è‡ªå·±çš„æƒ³æ³•</h2><p><strong><em>å‚è€ƒInstagram SnowFlakeçš„åšæ³•</em></strong></p>\n<p>å»ä¸­å¿ƒåŒ–ï¼ŒåŸºäºrediså®ç°<br>64bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯</p>\n<ul>\n<li>1bit ä¿ç•™</li>\n<li>41bits æ—¶é—´æˆ³</li>\n<li>12bits åŸºäºlogic-shard-id</li>\n<li>10bits åŸºäºæ—¶é—´æˆ³+logic-shard-idåœ¨redisé‡Œè‡ªå¢</li>\n</ul>\n<h1 id=\"4-å‚è€ƒæ–‡ç« \"><a href=\"#4-å‚è€ƒæ–‡ç« \" class=\"headerlink\" title=\"4. å‚è€ƒæ–‡ç« \"></a>4. å‚è€ƒæ–‡ç« </h1><ol>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzAwNjE3ODQ4NQ==&amp;mid=2650896366&amp;idx=1&amp;sn=5d5acdf323df2b6d581249b32031ccd7&amp;scene=1&amp;srcid=0618GuDjWjenr7TacVTFj6VU#rd\" target=\"_blank\" rel=\"external\">äº’è”ç½‘åˆ†å¸ƒå¼idç”Ÿæˆæ–¹æ³•|msupå¾®è¯¾å¹²è´§</a></li>\n<li><a href=\"http://calvin1978.blogcn.com/articles/uuid.html?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\" target=\"_blank\" rel=\"external\">æœåŠ¡åŒ–æ¡†æ¶ï¼åˆ†å¸ƒå¼Unique IDçš„ç”Ÿæˆæ–¹æ³•ä¸€è§ˆ</a></li>\n<li><a href=\"https://www.google.co.jp/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&amp;oq=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&amp;aqs=chrome..69i57.291j0j1&amp;sourceid=chrome&amp;ie=UTF-8\" target=\"_blank\" rel=\"external\">åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ Unique ID çš„ç”Ÿæˆæ–¹æ³•</a></li>\n</ol>\n<h1 id=\"è‰ç¨¿\"><a href=\"#è‰ç¨¿\" class=\"headerlink\" title=\"è‰ç¨¿\"></a>è‰ç¨¿</h1><ol>\n<li>2å®ä¾‹ã€4åˆ†è¡¨</li>\n</ol>\n<ul>\n<li>aï¼š0<em>2</em>4*6</li>\n<li>bï¼š1<em>3</em>5*7</li>\n</ul>\n<ol>\n<li>4å®ä¾‹ã€4åˆ†è¡¨</li>\n</ol>\n<ul>\n<li>aï¼š0<em>4</em>8*12</li>\n<li>bï¼š1<em>5</em>9*13</li>\n<li>cï¼š2<em>6</em>10*14</li>\n<li>dï¼š3<em>7</em>11*15</li>\n</ul>\n<p>æ‰©å±•æ–¹å¼ï¼š</p>\n<ul>\n<li>aä¸cåŒä¸»ã€ˆa cã€‰</li>\n<li>bä¸dåŒä¸»ã€ˆb dã€‰</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Architecture/0001-%E8%B0%88%E8%B0%88ID.md\" target=\"_blank\" rel=\"external\">è°ˆè°ˆID</a><br><strong>ğŸ˜ˆæ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ•°æ®åº“è‡ªå¢</a></li>\n<li><a href=\"#\">2. ç±»UUIDç®—æ³•</a></li>\n<li><a href=\"#\">3. SnowFlake</a><ul>\n<li><a href=\"#\">3.1 Twitter-Snowflake</a></li>\n<li><a href=\"#\">3.2 Instagram SnowFlake</a></li>\n<li><a href=\"#\">3.3 Simpleflake</a></li>\n<li><a href=\"#\">3.4 Boundary flake</a></li>\n<li><a href=\"#\">3.5 è‡ªå·±çš„æƒ³æ³•</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4. å‚è€ƒæ–‡ç« </a></li>\n<li><a href=\"#\">è‰ç¨¿</a></li>\n</ul>\n<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ•°æ®åº“çš„idæ˜¯ä¸å¯å°‘çš„ã€‚åœ¨å„ä¸ªåœºæ™¯ä¸‹ä¼šæœ‰ä¸åŒçš„é€‰æ‹©ï¼Œæœ¬æ–‡å¯¹äº’è”ç½‘ä¸Šå¸¸è§çš„IDç®—æ³•è¿›è¡Œå½’çº³ï¼Œå¸Œæœ›å¯¹å·¥ç¨‹å¸ˆä»¬æœ‰ä¸€ç‚¹ç‚¹å¸®åŠ©ã€‚</p>\n<h1 id=\"1-æ•°æ®åº“è‡ªå¢\"><a href=\"#1-æ•°æ®åº“è‡ªå¢\" class=\"headerlink\" title=\"1. æ•°æ®åº“è‡ªå¢\"></a>1. æ•°æ®åº“è‡ªå¢</h1><ol>\n<li>MySQLã€Oracleã€PGSQLç­‰å…³ç³»æ•°æ®åº“çš„idä¸»é”®è‡ªå¢</li>\n<li>Redisã€Memcachedç­‰K/Væ•°æ®åº“çš„incræ“ä½œè‡ªå¢<ul>\n<li>éœ€è¦è€ƒè™‘æŒä¹…åŒ–çš„é—®é¢˜</li>\n</ul>\n</li>\n<li>MongoDBè‡ªå·±ç»´æŠ¤ä¸€ä¸ªidè‡ªå¢é›†åˆ<ul>\n<li>MongoDBçš„Updateæ“ä½œæ”¯æŒincræ“ä½œï¼Œå› æ­¤å¯ä»¥è¿™ä¹ˆåšã€‚</li>\n<li>è¯¥æ–¹å¼é€‚ç”¨äºæ”¯æŒè¯¥æ“ä½œçš„å…¶ä»–æ•°æ®åº“ã€‚</li>\n</ul>\n</li>\n</ol>\n<h1 id=\"2-ç±»UUIDç®—æ³•\"><a href=\"#2-ç±»UUIDç®—æ³•\" class=\"headerlink\" title=\"2. ç±»UUIDç®—æ³•\"></a>2. ç±»UUIDç®—æ³•</h1><ol>\n<li>UUID</li>\n<li>MongoDBçš„ObjectId</li>\n</ol>\n<h1 id=\"3-SnowFlake\"><a href=\"#3-SnowFlake\" class=\"headerlink\" title=\"3. SnowFlake\"></a>3. SnowFlake</h1><h2 id=\"3-1-Twitter-Snowflake\"><a href=\"#3-1-Twitter-Snowflake\" class=\"headerlink\" title=\"3.1 Twitter-Snowflake\"></a>3.1 Twitter-Snowflake</h2><blockquote>\n<p> Twitter-Snowflakeç®—æ³•äº§ç”Ÿçš„èƒŒæ™¯ç›¸å½“ç®€å•ï¼Œä¸ºäº†æ»¡è¶³Twitteræ¯ç§’ä¸Šä¸‡æ¡æ¶ˆæ¯çš„è¯·æ±‚ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½å¿…é¡»åˆ†é…ä¸€æ¡å”¯ä¸€çš„idï¼Œè¿™äº›idè¿˜éœ€è¦ä¸€äº›å¤§è‡´çš„é¡ºåºï¼ˆæ–¹ä¾¿å®¢æˆ·ç«¯æ’åºï¼‰ï¼Œå¹¶ä¸”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸åŒæœºå™¨äº§ç”Ÿçš„idå¿…é¡»ä¸åŒã€‚</p>\n</blockquote>\n<p>64bitsä»å·¦å¾€å³ä¾æ¬¡æ˜¯</p>\n<ul>\n<li>1bit ä¿ç•™</li>\n<li>41bits æ—¶é—´æˆ³<ul>\n<li>æ”¯æŒ69.7å¹´éœ€è¦çš„idã€‚2 ^41 /365/24/60/60/1000=69.7</li>\n</ul>\n</li>\n<li>10bits work-id<ul>\n<li>æ”¯æŒ1024ä¸ªwork</li>\n</ul>\n</li>\n<li>12bits sequence-id<ul>\n<li>æ”¯æŒæ¯workæ¯æ¯«ç§’4096ä¸ªid</li>\n<li>æ”¯æŒæ¯workæ¯ç§’4096000ä¸ªid</li>\n<li>è‹¥å½“å‰æ¯«ç§’è¶…è¿‡4096ï¼Œåˆ™sleep1æ¯«ç§’ï¼Œè·å–ä¸‹ä¸€æ¯«ç§’çš„è‡ªå¢</li>\n</ul>\n</li>\n</ul>\n<p><strong> snowflakeçš„æ„ä¹‰ï¼Œä¸ä»…ä»…åœ¨äºæä¾›äº†è§£å†³æ–¹å¼ï¼Œæ›´å¤šçš„æ˜¯ä¸€ç§åŸºäºLongé•¿åº¦å®ç°å…·æœ‰æ—¶é—´ç›¸å…³æ€§çš„idè‡ªå¢åºåˆ—ã€‚å› æ­¤ï¼Œå¾ˆå¤šå…¬å¸åŸºäºå®ƒè¿›è¡ŒäºŒæ¬¡æ”¹é€ é€‚åº”è‡ªå·±çš„åœºæ™¯ </strong></p>\n<h2 id=\"3-2-Instagram-SnowFlake\"><a href=\"#3-2-Instagram-SnowFlake\" class=\"headerlink\" title=\"3.2 Instagram SnowFlake\"></a>3.2 Instagram SnowFlake</h2><p>å»ä¸­æ€§åŒ–ï¼ŒåŸºäºPGSQLå®ç°</p>\n<p>64bitsä»å·¦è‡³å³ä¾æ¬¡æ˜¯</p>\n<ul>\n<li>41bits æ—¶é—´æˆ³</li>\n<li>13bits logic-shard-id</li>\n<li>10bits sequence-id</li>\n</ul>\n<p>å®ç°æ–¹å¼</p>\n<ul>\n<li>æ ¹æ®<code>share-key</code>è·å–å¯¹åº”çš„PGSQLå®ä¾‹-åº“</li>\n<li>idä½¿ç”¨PGSQLçš„å­˜å‚¨è¿‡ç¨‹</li>\n<li>13bits = <code>share-keyå¯¹åº”å€¼%logic-share-id</code> </li>\n<li>10bits = <code>è¯¥Tableçš„auto_increment_id%(2 ^10)</code></li>\n</ul>\n<p>å¥½å¤„</p>\n<ul>\n<li>å»ä¸­æ€§åŒ–</li>\n<li>æ ¹æ®idå¯ä»¥è·å¾—å¯¹åº”PGSQLå®ä¾‹-åº“</li>\n</ul>\n<h2 id=\"3-3-Simpleflake\"><a href=\"#3-3-Simpleflake\" class=\"headerlink\" title=\"3.3 Simpleflake\"></a>3.3 Simpleflake</h2><p>64bits</p>\n<ul>\n<li>å»ä¸­æ€§åŒ–</li>\n<li>å°†work-idçš„12bitsç»™sequence-idã€‚å®Œå…¨éšæœºï¼Œæ¯æ¯«ç§’æœ‰1/(2^22 )å‡ºç°å†²çªçš„æƒ…å†µã€‚æ•°æ®é‡å¤§æ—¶éœ€è¦æ³¨æ„ã€‚</li>\n<li>æœªæ¥å¯ä»¥å¹³æ»‘è¿ç§»åˆ°Twitter SnowFlake</li>\n</ul>\n<h2 id=\"3-4-Boundary-flake\"><a href=\"#3-4-Boundary-flake\" class=\"headerlink\" title=\"3.4 Boundary flake\"></a>3.4 Boundary flake</h2><p>å»ä¸­æ€§åŒ–ï¼ŒåŸºäºerlangå®ç°<br>128bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯</p>\n<ul>\n<li>64bits æ—¶é—´æˆ³<ul>\n<li>å’Œæ¯«ç§’æ—¶é—´æˆ³ç­‰é•¿</li>\n</ul>\n</li>\n<li>48bits work-id<ul>\n<li>å’Œmacåœ°å€ç­‰é•¿ï¼Œä½¿ç”¨æ—¶è¦é¿å…ç›¸åŒmacå¤šä¸ªè¿›ç¨‹</li>\n</ul>\n</li>\n<li>14bits sequence-id</li>\n</ul>\n<h2 id=\"3-5-è‡ªå·±çš„æƒ³æ³•\"><a href=\"#3-5-è‡ªå·±çš„æƒ³æ³•\" class=\"headerlink\" title=\"3.5 è‡ªå·±çš„æƒ³æ³•\"></a>3.5 è‡ªå·±çš„æƒ³æ³•</h2><p><strong><em>å‚è€ƒInstagram SnowFlakeçš„åšæ³•</em></strong></p>\n<p>å»ä¸­å¿ƒåŒ–ï¼ŒåŸºäºrediså®ç°<br>64bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯</p>\n<ul>\n<li>1bit ä¿ç•™</li>\n<li>41bits æ—¶é—´æˆ³</li>\n<li>12bits åŸºäºlogic-shard-id</li>\n<li>10bits åŸºäºæ—¶é—´æˆ³+logic-shard-idåœ¨redisé‡Œè‡ªå¢</li>\n</ul>\n<h1 id=\"4-å‚è€ƒæ–‡ç« \"><a href=\"#4-å‚è€ƒæ–‡ç« \" class=\"headerlink\" title=\"4. å‚è€ƒæ–‡ç« \"></a>4. å‚è€ƒæ–‡ç« </h1><ol>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzAwNjE3ODQ4NQ==&amp;mid=2650896366&amp;idx=1&amp;sn=5d5acdf323df2b6d581249b32031ccd7&amp;scene=1&amp;srcid=0618GuDjWjenr7TacVTFj6VU#rd\" target=\"_blank\" rel=\"external\">äº’è”ç½‘åˆ†å¸ƒå¼idç”Ÿæˆæ–¹æ³•|msupå¾®è¯¾å¹²è´§</a></li>\n<li><a href=\"http://calvin1978.blogcn.com/articles/uuid.html?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\" target=\"_blank\" rel=\"external\">æœåŠ¡åŒ–æ¡†æ¶ï¼åˆ†å¸ƒå¼Unique IDçš„ç”Ÿæˆæ–¹æ³•ä¸€è§ˆ</a></li>\n<li><a href=\"https://www.google.co.jp/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&amp;oq=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&amp;aqs=chrome..69i57.291j0j1&amp;sourceid=chrome&amp;ie=UTF-8\" target=\"_blank\" rel=\"external\">åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ Unique ID çš„ç”Ÿæˆæ–¹æ³•</a></li>\n</ol>\n<h1 id=\"è‰ç¨¿\"><a href=\"#è‰ç¨¿\" class=\"headerlink\" title=\"è‰ç¨¿\"></a>è‰ç¨¿</h1><ol>\n<li>2å®ä¾‹ã€4åˆ†è¡¨</li>\n</ol>\n<ul>\n<li>aï¼š0<em>2</em>4*6</li>\n<li>bï¼š1<em>3</em>5*7</li>\n</ul>\n<ol>\n<li>4å®ä¾‹ã€4åˆ†è¡¨</li>\n</ol>\n<ul>\n<li>aï¼š0<em>4</em>8*12</li>\n<li>bï¼š1<em>5</em>9*13</li>\n<li>cï¼š2<em>6</em>10*14</li>\n<li>dï¼š3<em>7</em>11*15</li>\n</ul>\n<p>æ‰©å±•æ–¹å¼ï¼š</p>\n<ul>\n<li>aä¸cåŒä¸»ã€ˆa cã€‰</li>\n<li>bä¸dåŒä¸»ã€ˆb dã€‰</li>\n</ul>\n"},{"title":"è°ˆè°ˆå•å…ƒæµ‹è¯•","date":"2017-03-18T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[è°ˆè°ˆå•å…ƒæµ‹è¯•](https://github.com/YunaiV/Blog/blob/master/Architecture/0002-%E6%89%AF%E6%89%AF%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.md)  \n> **ğŸ˜ˆæ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•](#)\n- [2. é€‰å‹](#)\n\t- [2.1 JUnit](#)\n\t- [2.2 Mockito](#)\n\t- [2.3 PowerMock](#)\n- [3. å®è·µ](#)\n\t- [3.1 Service å±‚](#)\n\t- [3.2 Controller å±‚](#)\n\t- [3.3 Dao å±‚](#)\n- [4. å»ºè®®](#)\n\n**æœ¬æ–‡ä¸»è¦é¢å‘Javaå·¥ç¨‹å¸ˆï¼Œè§è°…**\n\n# 1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•\n\n* æå‡é‡å¤æµ‹è¯•æ•ˆç‡\n* æå‡ä»£ç è´¨é‡\n* æå‡éƒ¨ç½²å¯é æ€§\n\n# 2. é€‰å‹\n\n## 2.1 JUnit\n\n> å•å…ƒæµ‹è¯•å¥—ä»¶\n\nä¸ºä»€ä¹ˆä¸ä½¿ç”¨ TestNG ï¼Ÿåœ¨æ•´åˆ TestNG + Mockito + PowerMock + Spring æ—¶ï¼ŒSpring å®¹å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œ `@Autowired` çš„å±æ€§æ— æ³•æ³¨å…¥ï¼ŒæŸ¥æ‰¾èµ„æ–™ï¼ŒåŸºæœ¬æ— è§£ï¼Œåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œé€‰æ‹© JUnit ã€‚ä»åŠŸèƒ½å¼ºå¤§ç¨‹åº¦ï¼Œæ˜“ç”¨æ€§ä¸Šï¼Œä¸ªäººè¾ƒä¸ºæ¨è TestNG ã€‚\n\n## 2.2 Mockito\n\n> Mock å·¥å…·\n\nä¸ºä»€ä¹ˆä¸ä½¿ç”¨ JMock ã€EasyMock ï¼Ÿå› ä¸º API ä¸Šæ›´åŠ è½»é‡çº§ï¼Œç”¨èµ·æ¥çˆ½çˆ½çš„ã€‚\n\n## 2.3 PowerMock\n\n> ä½œä¸º Mockito çš„è¡¥å……ï¼Œå¢åŠ å¯¹ `private`ã€`static`ã€`final` çš„æ”¯æŒã€‚\n\nä¸ºä»€ä¹ˆ Mockito ä¸è‡ªå·±æ”¯æŒï¼Ÿ[Mockito-And-Private-Methods](https://github.com/mockito/mockito/wiki/Mockito-And-Private-Methods) ä½œè€…æœ‰è‡ªå·±çš„è€ƒè™‘ï¼Œä¸è¿‡å¯¹äºä½¿ç”¨è€…ï¼Œå¢åŠ äº†å¾ˆå¤šæ•´åˆçš„ç—›è‹¦ã€‚\n\n# 3. å®è·µ\n\n## 3.1 Service å±‚\n\n> æ–¹æ¡ˆä¸€ï¼š\n\n* ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ\n* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ\n\n> æ–¹æ¡ˆäºŒï¼š\n\n* ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“ï¼Œä¾‹å¦‚è¯´ h2database \n* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ\n\n**ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚ä»å¯é æ€§è§’åº¦è€ƒè™‘ï¼Œç›¸å¯¹çœŸå®çš„æ¨¡æ‹Ÿäº† Dao å±‚ï¼Œä¾‹å¦‚æ•°æ®æ’å…¥åï¼Œå¯ä»¥è¿›è¡ŒæŸ¥è¯¢ï¼Œåˆ¤æ–­Serviceæ˜¯å¦æ­£ç¡®è®¾ç½®å€¼ï¼Œæ˜¯å¦æœ‰å±æ€§æ¼è®¾ç½®ä¼šè®¾ç½®é”™ï¼›å½“ç„¶ï¼Œè¯¥æ–¹æ¡ˆåœ¨ç»´æŠ¤ä¸Šä¼šç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œå„æœ‰åˆ©å¼Šã€‚**\n\n## 3.2 Controller å±‚\n\n> æ–¹æ¡ˆä¸€ï¼š\n\n* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ\n\n> æ–¹æ¡ˆäºŒï¼š\n\n* ä¾èµ–çš„ Service å±‚ã€**è¯»**ã€‘ç±»é€»è¾‘ï¼Œæ‰§è¡ŒçœŸå®é€»è¾‘ã€‚è¯»å–ä¾èµ–çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚\n* ä¾èµ–çš„ Service å±‚ã€**å†™**ã€‘ç±»é€»è¾‘ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿã€‚å’Œ Controller ç±»çš„é€»è¾‘æˆ–è€…è¿”å›æœ‰å…³ç³»çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚\n\n**ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚åŸå› åŒ Service å±‚å•å…ƒæµ‹è¯•ã€‚**\n\nå¦å¤–ï¼Œå¤§éƒ¨é—¨äº’è”ç½‘å…¬å¸ MVC æ¡†æ¶é€‰ç”¨çš„æ˜¯ SpringMVC ï¼Œå¯ä»¥ä½¿ç”¨ SpringMVC Test æ¡†æ¶ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š\n\n```\nMockMvcBuilders.standaloneSetup(XXXController).build()\n```\n\n## 3.3 Dao å±‚\n\nä½¿ç”¨å†…åµŒçš„æ•°æ®å®ç°è¿›è¡Œæµ‹è¯•ã€‚\n\n* MySQL ï¼š[h2database](https://github.com/h2database/h2database) \n* MongoDB ï¼š[fongo](https://github.com/fakemongo/fongo)\n* Redis ï¼š[embedded-redis](https://github.com/kstyrc/embedded-redis)\n\n# 4. å»ºè®®\n\n1. åŠ  QQï¼š**7685413**ï¼Œè¿›è¡Œäº’ç›¸äº¤æµã€‚ğŸ˜œã€‚\n2. å½“ä½¿ç”¨ TestNG + Mockito + PowerMock ï¼Œæµ‹è¯•ç±»ä½¿ç”¨ IObjectFactory è€Œä¸è¦å»ç»§æ‰¿ PowerMockTestCase ã€‚Java æ— æ³•å¤šç»§æ‰¿ï¼Œå¦‚æœæ­¤æ—¶ä½ æœ‰å¿…é¡»ç»§æ‰¿çš„ç±»å°±ååˆ†æ£˜æ‰‹ã€‚\n\n```\n@ObjectFactory  \npublic IObjectFactory getObjectFactory() {  \n\treturn new PowerMockObjectFactory();  \n}   \n```\t\n\n3. å½“ä½¿ç”¨ PowerMockTestCase æ¯ä¸ªæµ‹è¯•å•å…ƒæ‰§è¡Œå®Œåï¼Œä¼šæ¸…ç†æ‰å¯¹æ–¹æ³•çš„ mockã€‚å› æ­¤ï¼Œå¦‚æœæœ‰å…¬ç”¨çš„ mock æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ä¸‹ @BeforeMethodï¼ˆTestNGï¼‰ã€@Beforeï¼ˆJUnitï¼‰é‡Œåœ¨è¿›è¡Œä¸€æ¬¡mockã€‚\n4. å½“ä½¿ç”¨ Mockito + PowerMock ï¼Œå¯¹æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•æ—¶ï¼Œæœ‰éœ€è¦å¯¹æµ‹è¯•ç±»çš„ä¸€äº›ç§æœ‰æ–¹æ³•ã€æˆ–è€…é™æ€æ–¹æ³•è¿›è¡Œ mock æ—¶ï¼Œä¸è¦ä½¿ç”¨ @Spyï¼Œè€Œè¦ä½¿ç”¨PowerMokito.spy()è¿›è¡Œ mock ã€‚å¾ˆé…¸çˆ½ã€‚\n\n","source":"_posts/Architecture/2017_03_19_æ‰¯æ‰¯å•å…ƒæµ‹è¯•.md","raw":"title: è°ˆè°ˆå•å…ƒæµ‹è¯•\ndate: 2017-03-19\ntags:\ncategories: æŠ€æœ¯æ‚æ–‡\npermalink: Architecture/talk-about-java-unit-test\n\n---\n\n>  åŸæ–‡åœ°å€ï¼š[è°ˆè°ˆå•å…ƒæµ‹è¯•](https://github.com/YunaiV/Blog/blob/master/Architecture/0002-%E6%89%AF%E6%89%AF%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.md)  \n> **ğŸ˜ˆæ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•](#)\n- [2. é€‰å‹](#)\n\t- [2.1 JUnit](#)\n\t- [2.2 Mockito](#)\n\t- [2.3 PowerMock](#)\n- [3. å®è·µ](#)\n\t- [3.1 Service å±‚](#)\n\t- [3.2 Controller å±‚](#)\n\t- [3.3 Dao å±‚](#)\n- [4. å»ºè®®](#)\n\n**æœ¬æ–‡ä¸»è¦é¢å‘Javaå·¥ç¨‹å¸ˆï¼Œè§è°…**\n\n# 1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•\n\n* æå‡é‡å¤æµ‹è¯•æ•ˆç‡\n* æå‡ä»£ç è´¨é‡\n* æå‡éƒ¨ç½²å¯é æ€§\n\n# 2. é€‰å‹\n\n## 2.1 JUnit\n\n> å•å…ƒæµ‹è¯•å¥—ä»¶\n\nä¸ºä»€ä¹ˆä¸ä½¿ç”¨ TestNG ï¼Ÿåœ¨æ•´åˆ TestNG + Mockito + PowerMock + Spring æ—¶ï¼ŒSpring å®¹å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œ `@Autowired` çš„å±æ€§æ— æ³•æ³¨å…¥ï¼ŒæŸ¥æ‰¾èµ„æ–™ï¼ŒåŸºæœ¬æ— è§£ï¼Œåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œé€‰æ‹© JUnit ã€‚ä»åŠŸèƒ½å¼ºå¤§ç¨‹åº¦ï¼Œæ˜“ç”¨æ€§ä¸Šï¼Œä¸ªäººè¾ƒä¸ºæ¨è TestNG ã€‚\n\n## 2.2 Mockito\n\n> Mock å·¥å…·\n\nä¸ºä»€ä¹ˆä¸ä½¿ç”¨ JMock ã€EasyMock ï¼Ÿå› ä¸º API ä¸Šæ›´åŠ è½»é‡çº§ï¼Œç”¨èµ·æ¥çˆ½çˆ½çš„ã€‚\n\n## 2.3 PowerMock\n\n> ä½œä¸º Mockito çš„è¡¥å……ï¼Œå¢åŠ å¯¹ `private`ã€`static`ã€`final` çš„æ”¯æŒã€‚\n\nä¸ºä»€ä¹ˆ Mockito ä¸è‡ªå·±æ”¯æŒï¼Ÿ[Mockito-And-Private-Methods](https://github.com/mockito/mockito/wiki/Mockito-And-Private-Methods) ä½œè€…æœ‰è‡ªå·±çš„è€ƒè™‘ï¼Œä¸è¿‡å¯¹äºä½¿ç”¨è€…ï¼Œå¢åŠ äº†å¾ˆå¤šæ•´åˆçš„ç—›è‹¦ã€‚\n\n# 3. å®è·µ\n\n## 3.1 Service å±‚\n\n> æ–¹æ¡ˆä¸€ï¼š\n\n* ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ\n* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ\n\n> æ–¹æ¡ˆäºŒï¼š\n\n* ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“ï¼Œä¾‹å¦‚è¯´ h2database \n* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ\n\n**ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚ä»å¯é æ€§è§’åº¦è€ƒè™‘ï¼Œç›¸å¯¹çœŸå®çš„æ¨¡æ‹Ÿäº† Dao å±‚ï¼Œä¾‹å¦‚æ•°æ®æ’å…¥åï¼Œå¯ä»¥è¿›è¡ŒæŸ¥è¯¢ï¼Œåˆ¤æ–­Serviceæ˜¯å¦æ­£ç¡®è®¾ç½®å€¼ï¼Œæ˜¯å¦æœ‰å±æ€§æ¼è®¾ç½®ä¼šè®¾ç½®é”™ï¼›å½“ç„¶ï¼Œè¯¥æ–¹æ¡ˆåœ¨ç»´æŠ¤ä¸Šä¼šç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œå„æœ‰åˆ©å¼Šã€‚**\n\n## 3.2 Controller å±‚\n\n> æ–¹æ¡ˆä¸€ï¼š\n\n* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ\n\n> æ–¹æ¡ˆäºŒï¼š\n\n* ä¾èµ–çš„ Service å±‚ã€**è¯»**ã€‘ç±»é€»è¾‘ï¼Œæ‰§è¡ŒçœŸå®é€»è¾‘ã€‚è¯»å–ä¾èµ–çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚\n* ä¾èµ–çš„ Service å±‚ã€**å†™**ã€‘ç±»é€»è¾‘ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿã€‚å’Œ Controller ç±»çš„é€»è¾‘æˆ–è€…è¿”å›æœ‰å…³ç³»çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚\n\n**ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚åŸå› åŒ Service å±‚å•å…ƒæµ‹è¯•ã€‚**\n\nå¦å¤–ï¼Œå¤§éƒ¨é—¨äº’è”ç½‘å…¬å¸ MVC æ¡†æ¶é€‰ç”¨çš„æ˜¯ SpringMVC ï¼Œå¯ä»¥ä½¿ç”¨ SpringMVC Test æ¡†æ¶ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š\n\n```\nMockMvcBuilders.standaloneSetup(XXXController).build()\n```\n\n## 3.3 Dao å±‚\n\nä½¿ç”¨å†…åµŒçš„æ•°æ®å®ç°è¿›è¡Œæµ‹è¯•ã€‚\n\n* MySQL ï¼š[h2database](https://github.com/h2database/h2database) \n* MongoDB ï¼š[fongo](https://github.com/fakemongo/fongo)\n* Redis ï¼š[embedded-redis](https://github.com/kstyrc/embedded-redis)\n\n# 4. å»ºè®®\n\n1. åŠ  QQï¼š**7685413**ï¼Œè¿›è¡Œäº’ç›¸äº¤æµã€‚ğŸ˜œã€‚\n2. å½“ä½¿ç”¨ TestNG + Mockito + PowerMock ï¼Œæµ‹è¯•ç±»ä½¿ç”¨ IObjectFactory è€Œä¸è¦å»ç»§æ‰¿ PowerMockTestCase ã€‚Java æ— æ³•å¤šç»§æ‰¿ï¼Œå¦‚æœæ­¤æ—¶ä½ æœ‰å¿…é¡»ç»§æ‰¿çš„ç±»å°±ååˆ†æ£˜æ‰‹ã€‚\n\n```\n@ObjectFactory  \npublic IObjectFactory getObjectFactory() {  \n\treturn new PowerMockObjectFactory();  \n}   \n```\t\n\n3. å½“ä½¿ç”¨ PowerMockTestCase æ¯ä¸ªæµ‹è¯•å•å…ƒæ‰§è¡Œå®Œåï¼Œä¼šæ¸…ç†æ‰å¯¹æ–¹æ³•çš„ mockã€‚å› æ­¤ï¼Œå¦‚æœæœ‰å…¬ç”¨çš„ mock æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ä¸‹ @BeforeMethodï¼ˆTestNGï¼‰ã€@Beforeï¼ˆJUnitï¼‰é‡Œåœ¨è¿›è¡Œä¸€æ¬¡mockã€‚\n4. å½“ä½¿ç”¨ Mockito + PowerMock ï¼Œå¯¹æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•æ—¶ï¼Œæœ‰éœ€è¦å¯¹æµ‹è¯•ç±»çš„ä¸€äº›ç§æœ‰æ–¹æ³•ã€æˆ–è€…é™æ€æ–¹æ³•è¿›è¡Œ mock æ—¶ï¼Œä¸è¦ä½¿ç”¨ @Spyï¼Œè€Œè¦ä½¿ç”¨PowerMokito.spy()è¿›è¡Œ mock ã€‚å¾ˆé…¸çˆ½ã€‚\n\n","slug":"Architecture/talk-about-java-unit-test","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswy30001ak5dkacfib7t","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Architecture/0002-%E6%89%AF%E6%89%AF%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.md\" target=\"_blank\" rel=\"external\">è°ˆè°ˆå•å…ƒæµ‹è¯•</a><br><strong>ğŸ˜ˆæ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•</a></li>\n<li><a href=\"#\">2. é€‰å‹</a><ul>\n<li><a href=\"#\">2.1 JUnit</a></li>\n<li><a href=\"#\">2.2 Mockito</a></li>\n<li><a href=\"#\">2.3 PowerMock</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3. å®è·µ</a><ul>\n<li><a href=\"#\">3.1 Service å±‚</a></li>\n<li><a href=\"#\">3.2 Controller å±‚</a></li>\n<li><a href=\"#\">3.3 Dao å±‚</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4. å»ºè®®</a></li>\n</ul>\n<p><strong>æœ¬æ–‡ä¸»è¦é¢å‘Javaå·¥ç¨‹å¸ˆï¼Œè§è°…</strong></p>\n<h1 id=\"1-ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•\"><a href=\"#1-ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•\" class=\"headerlink\" title=\"1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•\"></a>1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•</h1><ul>\n<li>æå‡é‡å¤æµ‹è¯•æ•ˆç‡</li>\n<li>æå‡ä»£ç è´¨é‡</li>\n<li>æå‡éƒ¨ç½²å¯é æ€§</li>\n</ul>\n<h1 id=\"2-é€‰å‹\"><a href=\"#2-é€‰å‹\" class=\"headerlink\" title=\"2. é€‰å‹\"></a>2. é€‰å‹</h1><h2 id=\"2-1-JUnit\"><a href=\"#2-1-JUnit\" class=\"headerlink\" title=\"2.1 JUnit\"></a>2.1 JUnit</h2><blockquote>\n<p>å•å…ƒæµ‹è¯•å¥—ä»¶</p>\n</blockquote>\n<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ TestNG ï¼Ÿåœ¨æ•´åˆ TestNG + Mockito + PowerMock + Spring æ—¶ï¼ŒSpring å®¹å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œ <code>@Autowired</code> çš„å±æ€§æ— æ³•æ³¨å…¥ï¼ŒæŸ¥æ‰¾èµ„æ–™ï¼ŒåŸºæœ¬æ— è§£ï¼Œåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œé€‰æ‹© JUnit ã€‚ä»åŠŸèƒ½å¼ºå¤§ç¨‹åº¦ï¼Œæ˜“ç”¨æ€§ä¸Šï¼Œä¸ªäººè¾ƒä¸ºæ¨è TestNG ã€‚</p>\n<h2 id=\"2-2-Mockito\"><a href=\"#2-2-Mockito\" class=\"headerlink\" title=\"2.2 Mockito\"></a>2.2 Mockito</h2><blockquote>\n<p>Mock å·¥å…·</p>\n</blockquote>\n<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ JMock ã€EasyMock ï¼Ÿå› ä¸º API ä¸Šæ›´åŠ è½»é‡çº§ï¼Œç”¨èµ·æ¥çˆ½çˆ½çš„ã€‚</p>\n<h2 id=\"2-3-PowerMock\"><a href=\"#2-3-PowerMock\" class=\"headerlink\" title=\"2.3 PowerMock\"></a>2.3 PowerMock</h2><blockquote>\n<p>ä½œä¸º Mockito çš„è¡¥å……ï¼Œå¢åŠ å¯¹ <code>private</code>ã€<code>static</code>ã€<code>final</code> çš„æ”¯æŒã€‚</p>\n</blockquote>\n<p>ä¸ºä»€ä¹ˆ Mockito ä¸è‡ªå·±æ”¯æŒï¼Ÿ<a href=\"https://github.com/mockito/mockito/wiki/Mockito-And-Private-Methods\" target=\"_blank\" rel=\"external\">Mockito-And-Private-Methods</a> ä½œè€…æœ‰è‡ªå·±çš„è€ƒè™‘ï¼Œä¸è¿‡å¯¹äºä½¿ç”¨è€…ï¼Œå¢åŠ äº†å¾ˆå¤šæ•´åˆçš„ç—›è‹¦ã€‚</p>\n<h1 id=\"3-å®è·µ\"><a href=\"#3-å®è·µ\" class=\"headerlink\" title=\"3. å®è·µ\"></a>3. å®è·µ</h1><h2 id=\"3-1-Service-å±‚\"><a href=\"#3-1-Service-å±‚\" class=\"headerlink\" title=\"3.1 Service å±‚\"></a>3.1 Service å±‚</h2><blockquote>\n<p>æ–¹æ¡ˆä¸€ï¼š</p>\n</blockquote>\n<ul>\n<li>ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ</li>\n<li>ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ</li>\n</ul>\n<blockquote>\n<p>æ–¹æ¡ˆäºŒï¼š</p>\n</blockquote>\n<ul>\n<li>ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“ï¼Œä¾‹å¦‚è¯´ h2database </li>\n<li>ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ</li>\n</ul>\n<p><strong>ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚ä»å¯é æ€§è§’åº¦è€ƒè™‘ï¼Œç›¸å¯¹çœŸå®çš„æ¨¡æ‹Ÿäº† Dao å±‚ï¼Œä¾‹å¦‚æ•°æ®æ’å…¥åï¼Œå¯ä»¥è¿›è¡ŒæŸ¥è¯¢ï¼Œåˆ¤æ–­Serviceæ˜¯å¦æ­£ç¡®è®¾ç½®å€¼ï¼Œæ˜¯å¦æœ‰å±æ€§æ¼è®¾ç½®ä¼šè®¾ç½®é”™ï¼›å½“ç„¶ï¼Œè¯¥æ–¹æ¡ˆåœ¨ç»´æŠ¤ä¸Šä¼šç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œå„æœ‰åˆ©å¼Šã€‚</strong></p>\n<h2 id=\"3-2-Controller-å±‚\"><a href=\"#3-2-Controller-å±‚\" class=\"headerlink\" title=\"3.2 Controller å±‚\"></a>3.2 Controller å±‚</h2><blockquote>\n<p>æ–¹æ¡ˆä¸€ï¼š</p>\n</blockquote>\n<ul>\n<li>ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ</li>\n</ul>\n<blockquote>\n<p>æ–¹æ¡ˆäºŒï¼š</p>\n</blockquote>\n<ul>\n<li>ä¾èµ–çš„ Service å±‚ã€<strong>è¯»</strong>ã€‘ç±»é€»è¾‘ï¼Œæ‰§è¡ŒçœŸå®é€»è¾‘ã€‚è¯»å–ä¾èµ–çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚</li>\n<li>ä¾èµ–çš„ Service å±‚ã€<strong>å†™</strong>ã€‘ç±»é€»è¾‘ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿã€‚å’Œ Controller ç±»çš„é€»è¾‘æˆ–è€…è¿”å›æœ‰å…³ç³»çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚</li>\n</ul>\n<p><strong>ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚åŸå› åŒ Service å±‚å•å…ƒæµ‹è¯•ã€‚</strong></p>\n<p>å¦å¤–ï¼Œå¤§éƒ¨é—¨äº’è”ç½‘å…¬å¸ MVC æ¡†æ¶é€‰ç”¨çš„æ˜¯ SpringMVC ï¼Œå¯ä»¥ä½¿ç”¨ SpringMVC Test æ¡†æ¶ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">MockMvcBuilders.standaloneSetup(XXXController).build()</div></pre></td></tr></table></figure>\n<h2 id=\"3-3-Dao-å±‚\"><a href=\"#3-3-Dao-å±‚\" class=\"headerlink\" title=\"3.3 Dao å±‚\"></a>3.3 Dao å±‚</h2><p>ä½¿ç”¨å†…åµŒçš„æ•°æ®å®ç°è¿›è¡Œæµ‹è¯•ã€‚</p>\n<ul>\n<li>MySQL ï¼š<a href=\"https://github.com/h2database/h2database\" target=\"_blank\" rel=\"external\">h2database</a> </li>\n<li>MongoDB ï¼š<a href=\"https://github.com/fakemongo/fongo\" target=\"_blank\" rel=\"external\">fongo</a></li>\n<li>Redis ï¼š<a href=\"https://github.com/kstyrc/embedded-redis\" target=\"_blank\" rel=\"external\">embedded-redis</a></li>\n</ul>\n<h1 id=\"4-å»ºè®®\"><a href=\"#4-å»ºè®®\" class=\"headerlink\" title=\"4. å»ºè®®\"></a>4. å»ºè®®</h1><ol>\n<li>åŠ  QQï¼š<strong>7685413</strong>ï¼Œè¿›è¡Œäº’ç›¸äº¤æµã€‚ğŸ˜œã€‚</li>\n<li>å½“ä½¿ç”¨ TestNG + Mockito + PowerMock ï¼Œæµ‹è¯•ç±»ä½¿ç”¨ IObjectFactory è€Œä¸è¦å»ç»§æ‰¿ PowerMockTestCase ã€‚Java æ— æ³•å¤šç»§æ‰¿ï¼Œå¦‚æœæ­¤æ—¶ä½ æœ‰å¿…é¡»ç»§æ‰¿çš„ç±»å°±ååˆ†æ£˜æ‰‹ã€‚</li>\n</ol>\n<pre><code>@ObjectFactory  \npublic IObjectFactory getObjectFactory() {  \n    return new PowerMockObjectFactory();  \n}\n</code></pre><ol>\n<li>å½“ä½¿ç”¨ PowerMockTestCase æ¯ä¸ªæµ‹è¯•å•å…ƒæ‰§è¡Œå®Œåï¼Œä¼šæ¸…ç†æ‰å¯¹æ–¹æ³•çš„ mockã€‚å› æ­¤ï¼Œå¦‚æœæœ‰å…¬ç”¨çš„ mock æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ä¸‹ @BeforeMethodï¼ˆTestNGï¼‰ã€@Beforeï¼ˆJUnitï¼‰é‡Œåœ¨è¿›è¡Œä¸€æ¬¡mockã€‚</li>\n<li>å½“ä½¿ç”¨ Mockito + PowerMock ï¼Œå¯¹æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•æ—¶ï¼Œæœ‰éœ€è¦å¯¹æµ‹è¯•ç±»çš„ä¸€äº›ç§æœ‰æ–¹æ³•ã€æˆ–è€…é™æ€æ–¹æ³•è¿›è¡Œ mock æ—¶ï¼Œä¸è¦ä½¿ç”¨ @Spyï¼Œè€Œè¦ä½¿ç”¨PowerMokito.spy()è¿›è¡Œ mock ã€‚å¾ˆé…¸çˆ½ã€‚</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Architecture/0002-%E6%89%AF%E6%89%AF%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.md\" target=\"_blank\" rel=\"external\">è°ˆè°ˆå•å…ƒæµ‹è¯•</a><br><strong>ğŸ˜ˆæ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•</a></li>\n<li><a href=\"#\">2. é€‰å‹</a><ul>\n<li><a href=\"#\">2.1 JUnit</a></li>\n<li><a href=\"#\">2.2 Mockito</a></li>\n<li><a href=\"#\">2.3 PowerMock</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3. å®è·µ</a><ul>\n<li><a href=\"#\">3.1 Service å±‚</a></li>\n<li><a href=\"#\">3.2 Controller å±‚</a></li>\n<li><a href=\"#\">3.3 Dao å±‚</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4. å»ºè®®</a></li>\n</ul>\n<p><strong>æœ¬æ–‡ä¸»è¦é¢å‘Javaå·¥ç¨‹å¸ˆï¼Œè§è°…</strong></p>\n<h1 id=\"1-ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•\"><a href=\"#1-ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•\" class=\"headerlink\" title=\"1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•\"></a>1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•</h1><ul>\n<li>æå‡é‡å¤æµ‹è¯•æ•ˆç‡</li>\n<li>æå‡ä»£ç è´¨é‡</li>\n<li>æå‡éƒ¨ç½²å¯é æ€§</li>\n</ul>\n<h1 id=\"2-é€‰å‹\"><a href=\"#2-é€‰å‹\" class=\"headerlink\" title=\"2. é€‰å‹\"></a>2. é€‰å‹</h1><h2 id=\"2-1-JUnit\"><a href=\"#2-1-JUnit\" class=\"headerlink\" title=\"2.1 JUnit\"></a>2.1 JUnit</h2><blockquote>\n<p>å•å…ƒæµ‹è¯•å¥—ä»¶</p>\n</blockquote>\n<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ TestNG ï¼Ÿåœ¨æ•´åˆ TestNG + Mockito + PowerMock + Spring æ—¶ï¼ŒSpring å®¹å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œ <code>@Autowired</code> çš„å±æ€§æ— æ³•æ³¨å…¥ï¼ŒæŸ¥æ‰¾èµ„æ–™ï¼ŒåŸºæœ¬æ— è§£ï¼Œåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œé€‰æ‹© JUnit ã€‚ä»åŠŸèƒ½å¼ºå¤§ç¨‹åº¦ï¼Œæ˜“ç”¨æ€§ä¸Šï¼Œä¸ªäººè¾ƒä¸ºæ¨è TestNG ã€‚</p>\n<h2 id=\"2-2-Mockito\"><a href=\"#2-2-Mockito\" class=\"headerlink\" title=\"2.2 Mockito\"></a>2.2 Mockito</h2><blockquote>\n<p>Mock å·¥å…·</p>\n</blockquote>\n<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ JMock ã€EasyMock ï¼Ÿå› ä¸º API ä¸Šæ›´åŠ è½»é‡çº§ï¼Œç”¨èµ·æ¥çˆ½çˆ½çš„ã€‚</p>\n<h2 id=\"2-3-PowerMock\"><a href=\"#2-3-PowerMock\" class=\"headerlink\" title=\"2.3 PowerMock\"></a>2.3 PowerMock</h2><blockquote>\n<p>ä½œä¸º Mockito çš„è¡¥å……ï¼Œå¢åŠ å¯¹ <code>private</code>ã€<code>static</code>ã€<code>final</code> çš„æ”¯æŒã€‚</p>\n</blockquote>\n<p>ä¸ºä»€ä¹ˆ Mockito ä¸è‡ªå·±æ”¯æŒï¼Ÿ<a href=\"https://github.com/mockito/mockito/wiki/Mockito-And-Private-Methods\" target=\"_blank\" rel=\"external\">Mockito-And-Private-Methods</a> ä½œè€…æœ‰è‡ªå·±çš„è€ƒè™‘ï¼Œä¸è¿‡å¯¹äºä½¿ç”¨è€…ï¼Œå¢åŠ äº†å¾ˆå¤šæ•´åˆçš„ç—›è‹¦ã€‚</p>\n<h1 id=\"3-å®è·µ\"><a href=\"#3-å®è·µ\" class=\"headerlink\" title=\"3. å®è·µ\"></a>3. å®è·µ</h1><h2 id=\"3-1-Service-å±‚\"><a href=\"#3-1-Service-å±‚\" class=\"headerlink\" title=\"3.1 Service å±‚\"></a>3.1 Service å±‚</h2><blockquote>\n<p>æ–¹æ¡ˆä¸€ï¼š</p>\n</blockquote>\n<ul>\n<li>ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ</li>\n<li>ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ</li>\n</ul>\n<blockquote>\n<p>æ–¹æ¡ˆäºŒï¼š</p>\n</blockquote>\n<ul>\n<li>ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“ï¼Œä¾‹å¦‚è¯´ h2database </li>\n<li>ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ</li>\n</ul>\n<p><strong>ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚ä»å¯é æ€§è§’åº¦è€ƒè™‘ï¼Œç›¸å¯¹çœŸå®çš„æ¨¡æ‹Ÿäº† Dao å±‚ï¼Œä¾‹å¦‚æ•°æ®æ’å…¥åï¼Œå¯ä»¥è¿›è¡ŒæŸ¥è¯¢ï¼Œåˆ¤æ–­Serviceæ˜¯å¦æ­£ç¡®è®¾ç½®å€¼ï¼Œæ˜¯å¦æœ‰å±æ€§æ¼è®¾ç½®ä¼šè®¾ç½®é”™ï¼›å½“ç„¶ï¼Œè¯¥æ–¹æ¡ˆåœ¨ç»´æŠ¤ä¸Šä¼šç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œå„æœ‰åˆ©å¼Šã€‚</strong></p>\n<h2 id=\"3-2-Controller-å±‚\"><a href=\"#3-2-Controller-å±‚\" class=\"headerlink\" title=\"3.2 Controller å±‚\"></a>3.2 Controller å±‚</h2><blockquote>\n<p>æ–¹æ¡ˆä¸€ï¼š</p>\n</blockquote>\n<ul>\n<li>ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ</li>\n</ul>\n<blockquote>\n<p>æ–¹æ¡ˆäºŒï¼š</p>\n</blockquote>\n<ul>\n<li>ä¾èµ–çš„ Service å±‚ã€<strong>è¯»</strong>ã€‘ç±»é€»è¾‘ï¼Œæ‰§è¡ŒçœŸå®é€»è¾‘ã€‚è¯»å–ä¾èµ–çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚</li>\n<li>ä¾èµ–çš„ Service å±‚ã€<strong>å†™</strong>ã€‘ç±»é€»è¾‘ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿã€‚å’Œ Controller ç±»çš„é€»è¾‘æˆ–è€…è¿”å›æœ‰å…³ç³»çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚</li>\n</ul>\n<p><strong>ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚åŸå› åŒ Service å±‚å•å…ƒæµ‹è¯•ã€‚</strong></p>\n<p>å¦å¤–ï¼Œå¤§éƒ¨é—¨äº’è”ç½‘å…¬å¸ MVC æ¡†æ¶é€‰ç”¨çš„æ˜¯ SpringMVC ï¼Œå¯ä»¥ä½¿ç”¨ SpringMVC Test æ¡†æ¶ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">MockMvcBuilders.standaloneSetup(XXXController).build()</div></pre></td></tr></table></figure>\n<h2 id=\"3-3-Dao-å±‚\"><a href=\"#3-3-Dao-å±‚\" class=\"headerlink\" title=\"3.3 Dao å±‚\"></a>3.3 Dao å±‚</h2><p>ä½¿ç”¨å†…åµŒçš„æ•°æ®å®ç°è¿›è¡Œæµ‹è¯•ã€‚</p>\n<ul>\n<li>MySQL ï¼š<a href=\"https://github.com/h2database/h2database\" target=\"_blank\" rel=\"external\">h2database</a> </li>\n<li>MongoDB ï¼š<a href=\"https://github.com/fakemongo/fongo\" target=\"_blank\" rel=\"external\">fongo</a></li>\n<li>Redis ï¼š<a href=\"https://github.com/kstyrc/embedded-redis\" target=\"_blank\" rel=\"external\">embedded-redis</a></li>\n</ul>\n<h1 id=\"4-å»ºè®®\"><a href=\"#4-å»ºè®®\" class=\"headerlink\" title=\"4. å»ºè®®\"></a>4. å»ºè®®</h1><ol>\n<li>åŠ  QQï¼š<strong>7685413</strong>ï¼Œè¿›è¡Œäº’ç›¸äº¤æµã€‚ğŸ˜œã€‚</li>\n<li>å½“ä½¿ç”¨ TestNG + Mockito + PowerMock ï¼Œæµ‹è¯•ç±»ä½¿ç”¨ IObjectFactory è€Œä¸è¦å»ç»§æ‰¿ PowerMockTestCase ã€‚Java æ— æ³•å¤šç»§æ‰¿ï¼Œå¦‚æœæ­¤æ—¶ä½ æœ‰å¿…é¡»ç»§æ‰¿çš„ç±»å°±ååˆ†æ£˜æ‰‹ã€‚</li>\n</ol>\n<pre><code>@ObjectFactory  \npublic IObjectFactory getObjectFactory() {  \n    return new PowerMockObjectFactory();  \n}\n</code></pre><ol>\n<li>å½“ä½¿ç”¨ PowerMockTestCase æ¯ä¸ªæµ‹è¯•å•å…ƒæ‰§è¡Œå®Œåï¼Œä¼šæ¸…ç†æ‰å¯¹æ–¹æ³•çš„ mockã€‚å› æ­¤ï¼Œå¦‚æœæœ‰å…¬ç”¨çš„ mock æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ä¸‹ @BeforeMethodï¼ˆTestNGï¼‰ã€@Beforeï¼ˆJUnitï¼‰é‡Œåœ¨è¿›è¡Œä¸€æ¬¡mockã€‚</li>\n<li>å½“ä½¿ç”¨ Mockito + PowerMock ï¼Œå¯¹æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•æ—¶ï¼Œæœ‰éœ€è¦å¯¹æµ‹è¯•ç±»çš„ä¸€äº›ç§æœ‰æ–¹æ³•ã€æˆ–è€…é™æ€æ–¹æ³•è¿›è¡Œ mock æ—¶ï¼Œä¸è¦ä½¿ç”¨ @Spyï¼Œè€Œè¦ä½¿ç”¨PowerMokito.spy()è¿›è¡Œ mock ã€‚å¾ˆé…¸çˆ½ã€‚</li>\n</ol>\n"},{"title":"Docker ç½‘ç»œ â€”â€” Flannel é…ç½®","date":"2017-02-03T16:00:00.000Z","_content":"\ntodo flannelç®€ä»‹\n\n## A. å®‰è£…Etcd\n\nğŸ˜‰ç½‘ç»œä¸Šä¸€å¤§æŠ„ï¼Œæˆ‘ç›¸ä¿¡ä½ èƒ½æ‰¾åˆ°ã€‚\n\n##B. å®‰è£…Flannel\n\nåŸºäºCentOS 7.2\n\n### 1. ä¸‹è½½Flannel\n\n\n```\n$ mkdir /root/work/flannel -p\n$ cd /root/work/flannel\n$ wget https://github.com/coreos/flannel/releases/download/v0.7.0/flannel-v0.7.0-linux-amd64.tar.gz\n$ tar -zxvf flannel-v0.7.0-linux-amd64.tar.gz\n$ ls -ls\n```\n    \nç»“æœï¼š![](images/0002/00AD067C-53F7-43EF-A8CA-F77CD72471BA.png)    \n    \n### 2. å¯åŠ¨Flannel\n\n\n```\n$ nohup ./flanneld -etcd-endpoints=http://10.29.76.96:2379 &  \n# è¯´æ˜ï¼šhttp://10.29.76.96:2379 ä¸ºetcdè¯·æ±‚åœ°å€ï¼Œéœ€è¦æ”¹æˆä½ è‡ªå·±çš„å™¢\n$ cat /run/flannel/subnet.env\n```\n\nç»“æœï¼š![](images/0002/D7087C8C-E6D7-408E-A088-3517E454A592.png)    \n\npsï¼šé‡è¦ï¼é‡è¦ï¼é‡è¦ï¼ç›®å‰è¯¥æ–¹å¼ä»…ä»…ç”¨äºæµ‹è¯•ï¼Œå¦‚æœæ­£å¼ä½¿ç”¨ï¼Œè¯·å°†Flannelé…ç½®åˆ°Systemdã€‚\n\n### 3. é…ç½®Docker\n\n* Dockerç‰ˆæœ¬ï¼šDocker version 1.12.5, build 047e51b/1.12.5\n* Dockerå®‰è£…æ–¹å¼ï¼šyum\n\n**è¯¥æ­¥éª¤å¯èƒ½Dockerå®‰è£…æ–¹å¼ä¸åŒï¼Œé…ç½®æ–¹å¼ä¸åŒã€‚ç›®çš„æ˜¯ä¿®æ”¹Dockerçš„bipã€mtuã€‚**\n\n```\n$ vi /etc/sysconfig/docker-network \n# è¯´æ˜ï¼šDOCKER_NETWORK_OPTIONS=' --bip=10.1.77.1/24 --mtu=1472 ' \n# è¯´æ˜ï¼šbipä¸ºsubnet.envé‡Œçš„FLANNEL_SUBNETï¼Œmtuä¸ºsubnet.envé‡Œçš„FLANNEL_MTU\n$ systemctl daemon-reload\n$ systemctl restart docker\n$ ifconfig docker0\n$ ifconfig flannel0\n```\n\nç»“æœï¼š![](images/0002/3B5B0FEC-E65D-4D02-87FD-70C443952845.png)\n\n### 4. éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•… \n\n* èŠ‚ç‚¹1ï¼šip=10.1.97.1/24\n* èŠ‚ç‚¹2ï¼šip=10.1.77.1/24\n\nèŠ‚ç‚¹1ï¼š\n\n```\n$ docker run -it --rm ubuntu\n# å‡è®¾ipä¸º10.1.97.2\n```\n\nèŠ‚ç‚¹2:\n\n```\n$ docker run -it --rm ubuntu\n# å‡è®¾ipä¸º10.1.77.2\n$ apt-get update\n$ apt-get install iputils-ping\n$ ping 10.1.97.2\n# pingé€šå³é…ç½®æˆåŠŸï¼\n```\n\n## C. åŸç†\n\n1. [æµ…æflannelä¸dockerç»“åˆçš„æœºåˆ¶å’ŒåŸç†](https://xuxinkun.github.io/2016/07/18/flannel-docker/)\n2. [DockOneæŠ€æœ¯åˆ†äº«ï¼ˆåå…«ï¼‰ï¼šä¸€ç¯‡æ–‡ç« å¸¦ä½ äº†è§£Flannel\n](http://dockone.io/article/618)\n\n## D. æ€§èƒ½\n\n* ![](images/0002/F7429465-2334-48C6-B84E-4C7FC735F5F9.png)\nï¼ˆæ¥è‡ªæ–‡ç« [å¹²è´§|ä½ æƒ³è¦çš„ç™¾åˆ†ç‚¹å¤§è§„æ¨¡Kubernetesé›†ç¾¤çš„åº”ç”¨å®è·µæ¥äº†](http://mp.weixin.qq.com/s?__biz=MjM5MzI5NjY2MA==&mid=2653782073&idx=1&sn=6db70559acabae67e35e13af7883e1d5&chksm=bd4018428a37915415ffda36c4f9f5e31088063ef3ad83e325d3e4ecd4eccf8d202709ac9629&mpshare=1&scene=1&srcid=0203g7cy4y9XpVhqA9fr5PGp#rd)ï¼‰\n\n* ![](images/0002/0BF283C9-C26C-46C1-9BDA-604EAD67B2E2.png)\nï¼ˆæ¥è‡ªæ–‡ç« [Weave is kinda slow](http://www.generictestdomain.net/docker/weave/networking/stupidity/2015/04/05/weave-is-kinda-slow/ï¼‰\n\n* [Dockeræˆ–Kubernetsçš„ç½‘ç»œæ¨¡å‹](http://www.do1618.com/archives/869)\n\n* [Kubernets,Flannel,Dockerç½‘ç»œæ€§èƒ½æ·±åº¦æµ‹è¯•](http://pangxiekr.com/kubernetsflannel-wang-luo-xing-neng-ce-shi-ji-diao-you/)\n\næ€»ç»“çš„è¯ï¼šhost-gw > vxlan > udpã€‚\nkubernetesåœ¨é˜¿é‡Œäº‘å·²ç»æœ‰host-gw + vpcçš„æ”¯æŒã€‚\n\n## E. ç¢°åˆ°çš„é—®é¢˜\n1. Flannelåˆšå®‰è£…å¥½ï¼Œé…ç½®å®ŒDockeråï¼Œå¯åŠ¨çš„Containeræ— æ³•è¢«pingé€šï¼Œè€ŒDocker0çš„IPå¯ä»¥è¢«pingé€šã€‚\n    TODO: å·²è§£å†³ï¼Œä½†æ˜¯åŸå› æœªçŸ¥ã€‚ç›®å‰çŒœæµ‹Kuberneteså¯èƒ½å¯¹Flannelç¬¬ä¸€æ¬¡åˆå§‹åŒ–æœ‰äº›å½±å“ã€‚\n    * æ–°å¼€ä¸€å°æœåŠ¡å™¨ï¼Œé‡æ–°å®‰è£…å¹¶è¿›è¡Œé…ç½®(yumå®‰è£…docker1.12ç‰ˆæœ¬ï¼‰ï¼Œæœªé‡ç°è¯¥æƒ…å†µã€‚å‡ºé—®é¢˜çš„æœºå­éƒ½å®‰è£…è¿‡Kubernetesã€‚\n    * åœ¨å‡ºé—®é¢˜çš„æœºå­ä¸Šä½¿ç”¨`tcpdump -i flannel0`ï¼Œå‘½ä»¤è¡Œè¾“å‡ºäº†`01:57:55.680586 IP 10.1.77.0 > 10.1.11.2: ICMP echo request, id 12091, seq 514, length 64`ã€‚å¯ä»¥å¾—å‡ºç½‘ç»œæœ¬èº«åº”è¯¥æ˜¯é€šçš„ï¼Œä½†æ˜¯æœªè¿›è¡Œå“åº”ã€‚è¿›å…¥Containerï¼Œ`tcpdump -i eth0`ï¼Œæœªè¾“å‡ºä»»ä½•ä¸œè¥¿ã€‚å¾—å‡ºç»“è®ºï¼š`flannel0`æœªå°†pingè½¬åˆ°Containerã€‚\n    * å…³é—­æœ‰é—®é¢˜æœºå­çš„Kubernetesç›¸å…³çš„æœåŠ¡ã€‚é‡å¯å¯åŠ¨Containerï¼Œç»“æœå¯ä»¥pingé€šäº†ã€‚æ­¤æ—¶é‡å¯æœåŠ¡å™¨ï¼Œç»“æœè¿™ä¸ªæ—¶å€™ï¼Œå³ä½¿Kuberneteså¯åŠ¨ç€ï¼Œä¾ç„¶å¯ä»¥pingé€šã€‚å¥½æ€ªT Tã€‚\n    \n\n\n## F. å‚è€ƒæ–‡ç« åˆ—è¡¨\n\n1. [Dokcer ä½¿ç”¨ Flannel è·¨ä¸»æœºé€šè®¯](https://mritd.me/2016/09/03/Dokcer-%E4%BD%BF%E7%94%A8-Flannel-%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%AE%AF/)\n2. [kuberneteså…¥é—¨1ï¼škubernetes+flannel+etcdç¯å¢ƒæ­å»º(é€šç”¨å®‰è£…)](http://zdevops.blog.51cto.com/2579684/1735492)\n3. [ç”¨ Flannel é…ç½® Kubernetes ç½‘ç»œ](http://dockone.io/article/1186)\n\n\n","source":"_posts/Docker/2017_02_04_Dockerç½‘ç»œâ€”â€”Flannelé…ç½®.md","raw":"title: Docker ç½‘ç»œ â€”â€” Flannel é…ç½®\ndate: 2017-02-04\ntags:\ncategories: Docker\npermalink: Docker/docker-network-flannel\n\n---\n\ntodo flannelç®€ä»‹\n\n## A. å®‰è£…Etcd\n\nğŸ˜‰ç½‘ç»œä¸Šä¸€å¤§æŠ„ï¼Œæˆ‘ç›¸ä¿¡ä½ èƒ½æ‰¾åˆ°ã€‚\n\n##B. å®‰è£…Flannel\n\nåŸºäºCentOS 7.2\n\n### 1. ä¸‹è½½Flannel\n\n\n```\n$ mkdir /root/work/flannel -p\n$ cd /root/work/flannel\n$ wget https://github.com/coreos/flannel/releases/download/v0.7.0/flannel-v0.7.0-linux-amd64.tar.gz\n$ tar -zxvf flannel-v0.7.0-linux-amd64.tar.gz\n$ ls -ls\n```\n    \nç»“æœï¼š![](images/0002/00AD067C-53F7-43EF-A8CA-F77CD72471BA.png)    \n    \n### 2. å¯åŠ¨Flannel\n\n\n```\n$ nohup ./flanneld -etcd-endpoints=http://10.29.76.96:2379 &  \n# è¯´æ˜ï¼šhttp://10.29.76.96:2379 ä¸ºetcdè¯·æ±‚åœ°å€ï¼Œéœ€è¦æ”¹æˆä½ è‡ªå·±çš„å™¢\n$ cat /run/flannel/subnet.env\n```\n\nç»“æœï¼š![](images/0002/D7087C8C-E6D7-408E-A088-3517E454A592.png)    \n\npsï¼šé‡è¦ï¼é‡è¦ï¼é‡è¦ï¼ç›®å‰è¯¥æ–¹å¼ä»…ä»…ç”¨äºæµ‹è¯•ï¼Œå¦‚æœæ­£å¼ä½¿ç”¨ï¼Œè¯·å°†Flannelé…ç½®åˆ°Systemdã€‚\n\n### 3. é…ç½®Docker\n\n* Dockerç‰ˆæœ¬ï¼šDocker version 1.12.5, build 047e51b/1.12.5\n* Dockerå®‰è£…æ–¹å¼ï¼šyum\n\n**è¯¥æ­¥éª¤å¯èƒ½Dockerå®‰è£…æ–¹å¼ä¸åŒï¼Œé…ç½®æ–¹å¼ä¸åŒã€‚ç›®çš„æ˜¯ä¿®æ”¹Dockerçš„bipã€mtuã€‚**\n\n```\n$ vi /etc/sysconfig/docker-network \n# è¯´æ˜ï¼šDOCKER_NETWORK_OPTIONS=' --bip=10.1.77.1/24 --mtu=1472 ' \n# è¯´æ˜ï¼šbipä¸ºsubnet.envé‡Œçš„FLANNEL_SUBNETï¼Œmtuä¸ºsubnet.envé‡Œçš„FLANNEL_MTU\n$ systemctl daemon-reload\n$ systemctl restart docker\n$ ifconfig docker0\n$ ifconfig flannel0\n```\n\nç»“æœï¼š![](images/0002/3B5B0FEC-E65D-4D02-87FD-70C443952845.png)\n\n### 4. éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•… \n\n* èŠ‚ç‚¹1ï¼šip=10.1.97.1/24\n* èŠ‚ç‚¹2ï¼šip=10.1.77.1/24\n\nèŠ‚ç‚¹1ï¼š\n\n```\n$ docker run -it --rm ubuntu\n# å‡è®¾ipä¸º10.1.97.2\n```\n\nèŠ‚ç‚¹2:\n\n```\n$ docker run -it --rm ubuntu\n# å‡è®¾ipä¸º10.1.77.2\n$ apt-get update\n$ apt-get install iputils-ping\n$ ping 10.1.97.2\n# pingé€šå³é…ç½®æˆåŠŸï¼\n```\n\n## C. åŸç†\n\n1. [æµ…æflannelä¸dockerç»“åˆçš„æœºåˆ¶å’ŒåŸç†](https://xuxinkun.github.io/2016/07/18/flannel-docker/)\n2. [DockOneæŠ€æœ¯åˆ†äº«ï¼ˆåå…«ï¼‰ï¼šä¸€ç¯‡æ–‡ç« å¸¦ä½ äº†è§£Flannel\n](http://dockone.io/article/618)\n\n## D. æ€§èƒ½\n\n* ![](images/0002/F7429465-2334-48C6-B84E-4C7FC735F5F9.png)\nï¼ˆæ¥è‡ªæ–‡ç« [å¹²è´§|ä½ æƒ³è¦çš„ç™¾åˆ†ç‚¹å¤§è§„æ¨¡Kubernetesé›†ç¾¤çš„åº”ç”¨å®è·µæ¥äº†](http://mp.weixin.qq.com/s?__biz=MjM5MzI5NjY2MA==&mid=2653782073&idx=1&sn=6db70559acabae67e35e13af7883e1d5&chksm=bd4018428a37915415ffda36c4f9f5e31088063ef3ad83e325d3e4ecd4eccf8d202709ac9629&mpshare=1&scene=1&srcid=0203g7cy4y9XpVhqA9fr5PGp#rd)ï¼‰\n\n* ![](images/0002/0BF283C9-C26C-46C1-9BDA-604EAD67B2E2.png)\nï¼ˆæ¥è‡ªæ–‡ç« [Weave is kinda slow](http://www.generictestdomain.net/docker/weave/networking/stupidity/2015/04/05/weave-is-kinda-slow/ï¼‰\n\n* [Dockeræˆ–Kubernetsçš„ç½‘ç»œæ¨¡å‹](http://www.do1618.com/archives/869)\n\n* [Kubernets,Flannel,Dockerç½‘ç»œæ€§èƒ½æ·±åº¦æµ‹è¯•](http://pangxiekr.com/kubernetsflannel-wang-luo-xing-neng-ce-shi-ji-diao-you/)\n\næ€»ç»“çš„è¯ï¼šhost-gw > vxlan > udpã€‚\nkubernetesåœ¨é˜¿é‡Œäº‘å·²ç»æœ‰host-gw + vpcçš„æ”¯æŒã€‚\n\n## E. ç¢°åˆ°çš„é—®é¢˜\n1. Flannelåˆšå®‰è£…å¥½ï¼Œé…ç½®å®ŒDockeråï¼Œå¯åŠ¨çš„Containeræ— æ³•è¢«pingé€šï¼Œè€ŒDocker0çš„IPå¯ä»¥è¢«pingé€šã€‚\n    TODO: å·²è§£å†³ï¼Œä½†æ˜¯åŸå› æœªçŸ¥ã€‚ç›®å‰çŒœæµ‹Kuberneteså¯èƒ½å¯¹Flannelç¬¬ä¸€æ¬¡åˆå§‹åŒ–æœ‰äº›å½±å“ã€‚\n    * æ–°å¼€ä¸€å°æœåŠ¡å™¨ï¼Œé‡æ–°å®‰è£…å¹¶è¿›è¡Œé…ç½®(yumå®‰è£…docker1.12ç‰ˆæœ¬ï¼‰ï¼Œæœªé‡ç°è¯¥æƒ…å†µã€‚å‡ºé—®é¢˜çš„æœºå­éƒ½å®‰è£…è¿‡Kubernetesã€‚\n    * åœ¨å‡ºé—®é¢˜çš„æœºå­ä¸Šä½¿ç”¨`tcpdump -i flannel0`ï¼Œå‘½ä»¤è¡Œè¾“å‡ºäº†`01:57:55.680586 IP 10.1.77.0 > 10.1.11.2: ICMP echo request, id 12091, seq 514, length 64`ã€‚å¯ä»¥å¾—å‡ºç½‘ç»œæœ¬èº«åº”è¯¥æ˜¯é€šçš„ï¼Œä½†æ˜¯æœªè¿›è¡Œå“åº”ã€‚è¿›å…¥Containerï¼Œ`tcpdump -i eth0`ï¼Œæœªè¾“å‡ºä»»ä½•ä¸œè¥¿ã€‚å¾—å‡ºç»“è®ºï¼š`flannel0`æœªå°†pingè½¬åˆ°Containerã€‚\n    * å…³é—­æœ‰é—®é¢˜æœºå­çš„Kubernetesç›¸å…³çš„æœåŠ¡ã€‚é‡å¯å¯åŠ¨Containerï¼Œç»“æœå¯ä»¥pingé€šäº†ã€‚æ­¤æ—¶é‡å¯æœåŠ¡å™¨ï¼Œç»“æœè¿™ä¸ªæ—¶å€™ï¼Œå³ä½¿Kuberneteså¯åŠ¨ç€ï¼Œä¾ç„¶å¯ä»¥pingé€šã€‚å¥½æ€ªT Tã€‚\n    \n\n\n## F. å‚è€ƒæ–‡ç« åˆ—è¡¨\n\n1. [Dokcer ä½¿ç”¨ Flannel è·¨ä¸»æœºé€šè®¯](https://mritd.me/2016/09/03/Dokcer-%E4%BD%BF%E7%94%A8-Flannel-%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%AE%AF/)\n2. [kuberneteså…¥é—¨1ï¼škubernetes+flannel+etcdç¯å¢ƒæ­å»º(é€šç”¨å®‰è£…)](http://zdevops.blog.51cto.com/2579684/1735492)\n3. [ç”¨ Flannel é…ç½® Kubernetes ç½‘ç»œ](http://dockone.io/article/1186)\n\n\n","slug":"Docker/docker-network-flannel","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswy70003ak5dqar5ogs2","content":"<p>todo flannelç®€ä»‹</p>\n<h2 id=\"A-å®‰è£…Etcd\"><a href=\"#A-å®‰è£…Etcd\" class=\"headerlink\" title=\"A. å®‰è£…Etcd\"></a>A. å®‰è£…Etcd</h2><p>ğŸ˜‰ç½‘ç»œä¸Šä¸€å¤§æŠ„ï¼Œæˆ‘ç›¸ä¿¡ä½ èƒ½æ‰¾åˆ°ã€‚</p>\n<p>##B. å®‰è£…Flannel</p>\n<p>åŸºäºCentOS 7.2</p>\n<h3 id=\"1-ä¸‹è½½Flannel\"><a href=\"#1-ä¸‹è½½Flannel\" class=\"headerlink\" title=\"1. ä¸‹è½½Flannel\"></a>1. ä¸‹è½½Flannel</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ mkdir /root/work/flannel -p</div><div class=\"line\">$ cd /root/work/flannel</div><div class=\"line\">$ wget https://github.com/coreos/flannel/releases/download/v0.7.0/flannel-v0.7.0-linux-amd64.tar.gz</div><div class=\"line\">$ tar -zxvf flannel-v0.7.0-linux-amd64.tar.gz</div><div class=\"line\">$ ls -ls</div></pre></td></tr></table></figure>\n<p>ç»“æœï¼š<img src=\"images/0002/00AD067C-53F7-43EF-A8CA-F77CD72471BA.png\" alt=\"\">    </p>\n<h3 id=\"2-å¯åŠ¨Flannel\"><a href=\"#2-å¯åŠ¨Flannel\" class=\"headerlink\" title=\"2. å¯åŠ¨Flannel\"></a>2. å¯åŠ¨Flannel</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ nohup ./flanneld -etcd-endpoints=http://10.29.76.96:2379 &amp;  </div><div class=\"line\"># è¯´æ˜ï¼šhttp://10.29.76.96:2379 ä¸ºetcdè¯·æ±‚åœ°å€ï¼Œéœ€è¦æ”¹æˆä½ è‡ªå·±çš„å™¢</div><div class=\"line\">$ cat /run/flannel/subnet.env</div></pre></td></tr></table></figure>\n<p>ç»“æœï¼š<img src=\"images/0002/D7087C8C-E6D7-408E-A088-3517E454A592.png\" alt=\"\">    </p>\n<p>psï¼šé‡è¦ï¼é‡è¦ï¼é‡è¦ï¼ç›®å‰è¯¥æ–¹å¼ä»…ä»…ç”¨äºæµ‹è¯•ï¼Œå¦‚æœæ­£å¼ä½¿ç”¨ï¼Œè¯·å°†Flannelé…ç½®åˆ°Systemdã€‚</p>\n<h3 id=\"3-é…ç½®Docker\"><a href=\"#3-é…ç½®Docker\" class=\"headerlink\" title=\"3. é…ç½®Docker\"></a>3. é…ç½®Docker</h3><ul>\n<li>Dockerç‰ˆæœ¬ï¼šDocker version 1.12.5, build 047e51b/1.12.5</li>\n<li>Dockerå®‰è£…æ–¹å¼ï¼šyum</li>\n</ul>\n<p><strong>è¯¥æ­¥éª¤å¯èƒ½Dockerå®‰è£…æ–¹å¼ä¸åŒï¼Œé…ç½®æ–¹å¼ä¸åŒã€‚ç›®çš„æ˜¯ä¿®æ”¹Dockerçš„bipã€mtuã€‚</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ vi /etc/sysconfig/docker-network </div><div class=\"line\"># è¯´æ˜ï¼šDOCKER_NETWORK_OPTIONS=&apos; --bip=10.1.77.1/24 --mtu=1472 &apos; </div><div class=\"line\"># è¯´æ˜ï¼šbipä¸ºsubnet.envé‡Œçš„FLANNEL_SUBNETï¼Œmtuä¸ºsubnet.envé‡Œçš„FLANNEL_MTU</div><div class=\"line\">$ systemctl daemon-reload</div><div class=\"line\">$ systemctl restart docker</div><div class=\"line\">$ ifconfig docker0</div><div class=\"line\">$ ifconfig flannel0</div></pre></td></tr></table></figure>\n<p>ç»“æœï¼š<img src=\"images/0002/3B5B0FEC-E65D-4D02-87FD-70C443952845.png\" alt=\"\"></p>\n<h3 id=\"4-éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•…\"><a href=\"#4-éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•…\" class=\"headerlink\" title=\"4. éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•…\"></a>4. éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•…</h3><ul>\n<li>èŠ‚ç‚¹1ï¼šip=10.1.97.1/24</li>\n<li>èŠ‚ç‚¹2ï¼šip=10.1.77.1/24</li>\n</ul>\n<p>èŠ‚ç‚¹1ï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ docker run -it --rm ubuntu</div><div class=\"line\"># å‡è®¾ipä¸º10.1.97.2</div></pre></td></tr></table></figure>\n<p>èŠ‚ç‚¹2:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ docker run -it --rm ubuntu</div><div class=\"line\"># å‡è®¾ipä¸º10.1.77.2</div><div class=\"line\">$ apt-get update</div><div class=\"line\">$ apt-get install iputils-ping</div><div class=\"line\">$ ping 10.1.97.2</div><div class=\"line\"># pingé€šå³é…ç½®æˆåŠŸï¼</div></pre></td></tr></table></figure>\n<h2 id=\"C-åŸç†\"><a href=\"#C-åŸç†\" class=\"headerlink\" title=\"C. åŸç†\"></a>C. åŸç†</h2><ol>\n<li><a href=\"https://xuxinkun.github.io/2016/07/18/flannel-docker/\" target=\"_blank\" rel=\"external\">æµ…æflannelä¸dockerç»“åˆçš„æœºåˆ¶å’ŒåŸç†</a></li>\n<li><a href=\"http://dockone.io/article/618\" target=\"_blank\" rel=\"external\">DockOneæŠ€æœ¯åˆ†äº«ï¼ˆåå…«ï¼‰ï¼šä¸€ç¯‡æ–‡ç« å¸¦ä½ äº†è§£Flannel\n</a></li>\n</ol>\n<h2 id=\"D-æ€§èƒ½\"><a href=\"#D-æ€§èƒ½\" class=\"headerlink\" title=\"D. æ€§èƒ½\"></a>D. æ€§èƒ½</h2><ul>\n<li><p><img src=\"images/0002/F7429465-2334-48C6-B84E-4C7FC735F5F9.png\" alt=\"\"><br>ï¼ˆæ¥è‡ªæ–‡ç« <a href=\"http://mp.weixin.qq.com/s?__biz=MjM5MzI5NjY2MA==&amp;mid=2653782073&amp;idx=1&amp;sn=6db70559acabae67e35e13af7883e1d5&amp;chksm=bd4018428a37915415ffda36c4f9f5e31088063ef3ad83e325d3e4ecd4eccf8d202709ac9629&amp;mpshare=1&amp;scene=1&amp;srcid=0203g7cy4y9XpVhqA9fr5PGp#rd\" target=\"_blank\" rel=\"external\">å¹²è´§|ä½ æƒ³è¦çš„ç™¾åˆ†ç‚¹å¤§è§„æ¨¡Kubernetesé›†ç¾¤çš„åº”ç”¨å®è·µæ¥äº†</a>ï¼‰</p>\n</li>\n<li><p><img src=\"images/0002/0BF283C9-C26C-46C1-9BDA-604EAD67B2E2.png\" alt=\"\"><br>ï¼ˆæ¥è‡ªæ–‡ç« [Weave is kinda slow](<a href=\"http://www.generictestdomain.net/docker/weave/networking/stupidity/2015/04/05/weave-is-kinda-slow/ï¼‰\" target=\"_blank\" rel=\"external\">http://www.generictestdomain.net/docker/weave/networking/stupidity/2015/04/05/weave-is-kinda-slow/ï¼‰</a></p>\n</li>\n<li><p><a href=\"http://www.do1618.com/archives/869\" target=\"_blank\" rel=\"external\">Dockeræˆ–Kubernetsçš„ç½‘ç»œæ¨¡å‹</a></p>\n</li>\n<li><p><a href=\"http://pangxiekr.com/kubernetsflannel-wang-luo-xing-neng-ce-shi-ji-diao-you/\" target=\"_blank\" rel=\"external\">Kubernets,Flannel,Dockerç½‘ç»œæ€§èƒ½æ·±åº¦æµ‹è¯•</a></p>\n</li>\n</ul>\n<p>æ€»ç»“çš„è¯ï¼šhost-gw &gt; vxlan &gt; udpã€‚<br>kubernetesåœ¨é˜¿é‡Œäº‘å·²ç»æœ‰host-gw + vpcçš„æ”¯æŒã€‚</p>\n<h2 id=\"E-ç¢°åˆ°çš„é—®é¢˜\"><a href=\"#E-ç¢°åˆ°çš„é—®é¢˜\" class=\"headerlink\" title=\"E. ç¢°åˆ°çš„é—®é¢˜\"></a>E. ç¢°åˆ°çš„é—®é¢˜</h2><ol>\n<li>Flannelåˆšå®‰è£…å¥½ï¼Œé…ç½®å®ŒDockeråï¼Œå¯åŠ¨çš„Containeræ— æ³•è¢«pingé€šï¼Œè€ŒDocker0çš„IPå¯ä»¥è¢«pingé€šã€‚<br> TODO: å·²è§£å†³ï¼Œä½†æ˜¯åŸå› æœªçŸ¥ã€‚ç›®å‰çŒœæµ‹Kuberneteså¯èƒ½å¯¹Flannelç¬¬ä¸€æ¬¡åˆå§‹åŒ–æœ‰äº›å½±å“ã€‚<ul>\n<li>æ–°å¼€ä¸€å°æœåŠ¡å™¨ï¼Œé‡æ–°å®‰è£…å¹¶è¿›è¡Œé…ç½®(yumå®‰è£…docker1.12ç‰ˆæœ¬ï¼‰ï¼Œæœªé‡ç°è¯¥æƒ…å†µã€‚å‡ºé—®é¢˜çš„æœºå­éƒ½å®‰è£…è¿‡Kubernetesã€‚</li>\n<li>åœ¨å‡ºé—®é¢˜çš„æœºå­ä¸Šä½¿ç”¨<code>tcpdump -i flannel0</code>ï¼Œå‘½ä»¤è¡Œè¾“å‡ºäº†<code>01:57:55.680586 IP 10.1.77.0 &gt; 10.1.11.2: ICMP echo request, id 12091, seq 514, length 64</code>ã€‚å¯ä»¥å¾—å‡ºç½‘ç»œæœ¬èº«åº”è¯¥æ˜¯é€šçš„ï¼Œä½†æ˜¯æœªè¿›è¡Œå“åº”ã€‚è¿›å…¥Containerï¼Œ<code>tcpdump -i eth0</code>ï¼Œæœªè¾“å‡ºä»»ä½•ä¸œè¥¿ã€‚å¾—å‡ºç»“è®ºï¼š<code>flannel0</code>æœªå°†pingè½¬åˆ°Containerã€‚</li>\n<li>å…³é—­æœ‰é—®é¢˜æœºå­çš„Kubernetesç›¸å…³çš„æœåŠ¡ã€‚é‡å¯å¯åŠ¨Containerï¼Œç»“æœå¯ä»¥pingé€šäº†ã€‚æ­¤æ—¶é‡å¯æœåŠ¡å™¨ï¼Œç»“æœè¿™ä¸ªæ—¶å€™ï¼Œå³ä½¿Kuberneteså¯åŠ¨ç€ï¼Œä¾ç„¶å¯ä»¥pingé€šã€‚å¥½æ€ªT Tã€‚</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"F-å‚è€ƒæ–‡ç« åˆ—è¡¨\"><a href=\"#F-å‚è€ƒæ–‡ç« åˆ—è¡¨\" class=\"headerlink\" title=\"F. å‚è€ƒæ–‡ç« åˆ—è¡¨\"></a>F. å‚è€ƒæ–‡ç« åˆ—è¡¨</h2><ol>\n<li><a href=\"https://mritd.me/2016/09/03/Dokcer-%E4%BD%BF%E7%94%A8-Flannel-%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%AE%AF/\" target=\"_blank\" rel=\"external\">Dokcer ä½¿ç”¨ Flannel è·¨ä¸»æœºé€šè®¯</a></li>\n<li><a href=\"http://zdevops.blog.51cto.com/2579684/1735492\" target=\"_blank\" rel=\"external\">kuberneteså…¥é—¨1ï¼škubernetes+flannel+etcdç¯å¢ƒæ­å»º(é€šç”¨å®‰è£…)</a></li>\n<li><a href=\"http://dockone.io/article/1186\" target=\"_blank\" rel=\"external\">ç”¨ Flannel é…ç½® Kubernetes ç½‘ç»œ</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>todo flannelç®€ä»‹</p>\n<h2 id=\"A-å®‰è£…Etcd\"><a href=\"#A-å®‰è£…Etcd\" class=\"headerlink\" title=\"A. å®‰è£…Etcd\"></a>A. å®‰è£…Etcd</h2><p>ğŸ˜‰ç½‘ç»œä¸Šä¸€å¤§æŠ„ï¼Œæˆ‘ç›¸ä¿¡ä½ èƒ½æ‰¾åˆ°ã€‚</p>\n<p>##B. å®‰è£…Flannel</p>\n<p>åŸºäºCentOS 7.2</p>\n<h3 id=\"1-ä¸‹è½½Flannel\"><a href=\"#1-ä¸‹è½½Flannel\" class=\"headerlink\" title=\"1. ä¸‹è½½Flannel\"></a>1. ä¸‹è½½Flannel</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ mkdir /root/work/flannel -p</div><div class=\"line\">$ cd /root/work/flannel</div><div class=\"line\">$ wget https://github.com/coreos/flannel/releases/download/v0.7.0/flannel-v0.7.0-linux-amd64.tar.gz</div><div class=\"line\">$ tar -zxvf flannel-v0.7.0-linux-amd64.tar.gz</div><div class=\"line\">$ ls -ls</div></pre></td></tr></table></figure>\n<p>ç»“æœï¼š<img src=\"images/0002/00AD067C-53F7-43EF-A8CA-F77CD72471BA.png\" alt=\"\">    </p>\n<h3 id=\"2-å¯åŠ¨Flannel\"><a href=\"#2-å¯åŠ¨Flannel\" class=\"headerlink\" title=\"2. å¯åŠ¨Flannel\"></a>2. å¯åŠ¨Flannel</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ nohup ./flanneld -etcd-endpoints=http://10.29.76.96:2379 &amp;  </div><div class=\"line\"># è¯´æ˜ï¼šhttp://10.29.76.96:2379 ä¸ºetcdè¯·æ±‚åœ°å€ï¼Œéœ€è¦æ”¹æˆä½ è‡ªå·±çš„å™¢</div><div class=\"line\">$ cat /run/flannel/subnet.env</div></pre></td></tr></table></figure>\n<p>ç»“æœï¼š<img src=\"images/0002/D7087C8C-E6D7-408E-A088-3517E454A592.png\" alt=\"\">    </p>\n<p>psï¼šé‡è¦ï¼é‡è¦ï¼é‡è¦ï¼ç›®å‰è¯¥æ–¹å¼ä»…ä»…ç”¨äºæµ‹è¯•ï¼Œå¦‚æœæ­£å¼ä½¿ç”¨ï¼Œè¯·å°†Flannelé…ç½®åˆ°Systemdã€‚</p>\n<h3 id=\"3-é…ç½®Docker\"><a href=\"#3-é…ç½®Docker\" class=\"headerlink\" title=\"3. é…ç½®Docker\"></a>3. é…ç½®Docker</h3><ul>\n<li>Dockerç‰ˆæœ¬ï¼šDocker version 1.12.5, build 047e51b/1.12.5</li>\n<li>Dockerå®‰è£…æ–¹å¼ï¼šyum</li>\n</ul>\n<p><strong>è¯¥æ­¥éª¤å¯èƒ½Dockerå®‰è£…æ–¹å¼ä¸åŒï¼Œé…ç½®æ–¹å¼ä¸åŒã€‚ç›®çš„æ˜¯ä¿®æ”¹Dockerçš„bipã€mtuã€‚</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ vi /etc/sysconfig/docker-network </div><div class=\"line\"># è¯´æ˜ï¼šDOCKER_NETWORK_OPTIONS=&apos; --bip=10.1.77.1/24 --mtu=1472 &apos; </div><div class=\"line\"># è¯´æ˜ï¼šbipä¸ºsubnet.envé‡Œçš„FLANNEL_SUBNETï¼Œmtuä¸ºsubnet.envé‡Œçš„FLANNEL_MTU</div><div class=\"line\">$ systemctl daemon-reload</div><div class=\"line\">$ systemctl restart docker</div><div class=\"line\">$ ifconfig docker0</div><div class=\"line\">$ ifconfig flannel0</div></pre></td></tr></table></figure>\n<p>ç»“æœï¼š<img src=\"images/0002/3B5B0FEC-E65D-4D02-87FD-70C443952845.png\" alt=\"\"></p>\n<h3 id=\"4-éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•…\"><a href=\"#4-éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•…\" class=\"headerlink\" title=\"4. éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•…\"></a>4. éªŒè¯ç½‘ç»œæ˜¯å¦é€šç•…</h3><ul>\n<li>èŠ‚ç‚¹1ï¼šip=10.1.97.1/24</li>\n<li>èŠ‚ç‚¹2ï¼šip=10.1.77.1/24</li>\n</ul>\n<p>èŠ‚ç‚¹1ï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ docker run -it --rm ubuntu</div><div class=\"line\"># å‡è®¾ipä¸º10.1.97.2</div></pre></td></tr></table></figure>\n<p>èŠ‚ç‚¹2:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">$ docker run -it --rm ubuntu</div><div class=\"line\"># å‡è®¾ipä¸º10.1.77.2</div><div class=\"line\">$ apt-get update</div><div class=\"line\">$ apt-get install iputils-ping</div><div class=\"line\">$ ping 10.1.97.2</div><div class=\"line\"># pingé€šå³é…ç½®æˆåŠŸï¼</div></pre></td></tr></table></figure>\n<h2 id=\"C-åŸç†\"><a href=\"#C-åŸç†\" class=\"headerlink\" title=\"C. åŸç†\"></a>C. åŸç†</h2><ol>\n<li><a href=\"https://xuxinkun.github.io/2016/07/18/flannel-docker/\" target=\"_blank\" rel=\"external\">æµ…æflannelä¸dockerç»“åˆçš„æœºåˆ¶å’ŒåŸç†</a></li>\n<li><a href=\"http://dockone.io/article/618\" target=\"_blank\" rel=\"external\">DockOneæŠ€æœ¯åˆ†äº«ï¼ˆåå…«ï¼‰ï¼šä¸€ç¯‡æ–‡ç« å¸¦ä½ äº†è§£Flannel\n</a></li>\n</ol>\n<h2 id=\"D-æ€§èƒ½\"><a href=\"#D-æ€§èƒ½\" class=\"headerlink\" title=\"D. æ€§èƒ½\"></a>D. æ€§èƒ½</h2><ul>\n<li><p><img src=\"images/0002/F7429465-2334-48C6-B84E-4C7FC735F5F9.png\" alt=\"\"><br>ï¼ˆæ¥è‡ªæ–‡ç« <a href=\"http://mp.weixin.qq.com/s?__biz=MjM5MzI5NjY2MA==&amp;mid=2653782073&amp;idx=1&amp;sn=6db70559acabae67e35e13af7883e1d5&amp;chksm=bd4018428a37915415ffda36c4f9f5e31088063ef3ad83e325d3e4ecd4eccf8d202709ac9629&amp;mpshare=1&amp;scene=1&amp;srcid=0203g7cy4y9XpVhqA9fr5PGp#rd\" target=\"_blank\" rel=\"external\">å¹²è´§|ä½ æƒ³è¦çš„ç™¾åˆ†ç‚¹å¤§è§„æ¨¡Kubernetesé›†ç¾¤çš„åº”ç”¨å®è·µæ¥äº†</a>ï¼‰</p>\n</li>\n<li><p><img src=\"images/0002/0BF283C9-C26C-46C1-9BDA-604EAD67B2E2.png\" alt=\"\"><br>ï¼ˆæ¥è‡ªæ–‡ç« [Weave is kinda slow](<a href=\"http://www.generictestdomain.net/docker/weave/networking/stupidity/2015/04/05/weave-is-kinda-slow/ï¼‰\" target=\"_blank\" rel=\"external\">http://www.generictestdomain.net/docker/weave/networking/stupidity/2015/04/05/weave-is-kinda-slow/ï¼‰</a></p>\n</li>\n<li><p><a href=\"http://www.do1618.com/archives/869\" target=\"_blank\" rel=\"external\">Dockeræˆ–Kubernetsçš„ç½‘ç»œæ¨¡å‹</a></p>\n</li>\n<li><p><a href=\"http://pangxiekr.com/kubernetsflannel-wang-luo-xing-neng-ce-shi-ji-diao-you/\" target=\"_blank\" rel=\"external\">Kubernets,Flannel,Dockerç½‘ç»œæ€§èƒ½æ·±åº¦æµ‹è¯•</a></p>\n</li>\n</ul>\n<p>æ€»ç»“çš„è¯ï¼šhost-gw &gt; vxlan &gt; udpã€‚<br>kubernetesåœ¨é˜¿é‡Œäº‘å·²ç»æœ‰host-gw + vpcçš„æ”¯æŒã€‚</p>\n<h2 id=\"E-ç¢°åˆ°çš„é—®é¢˜\"><a href=\"#E-ç¢°åˆ°çš„é—®é¢˜\" class=\"headerlink\" title=\"E. ç¢°åˆ°çš„é—®é¢˜\"></a>E. ç¢°åˆ°çš„é—®é¢˜</h2><ol>\n<li>Flannelåˆšå®‰è£…å¥½ï¼Œé…ç½®å®ŒDockeråï¼Œå¯åŠ¨çš„Containeræ— æ³•è¢«pingé€šï¼Œè€ŒDocker0çš„IPå¯ä»¥è¢«pingé€šã€‚<br> TODO: å·²è§£å†³ï¼Œä½†æ˜¯åŸå› æœªçŸ¥ã€‚ç›®å‰çŒœæµ‹Kuberneteså¯èƒ½å¯¹Flannelç¬¬ä¸€æ¬¡åˆå§‹åŒ–æœ‰äº›å½±å“ã€‚<ul>\n<li>æ–°å¼€ä¸€å°æœåŠ¡å™¨ï¼Œé‡æ–°å®‰è£…å¹¶è¿›è¡Œé…ç½®(yumå®‰è£…docker1.12ç‰ˆæœ¬ï¼‰ï¼Œæœªé‡ç°è¯¥æƒ…å†µã€‚å‡ºé—®é¢˜çš„æœºå­éƒ½å®‰è£…è¿‡Kubernetesã€‚</li>\n<li>åœ¨å‡ºé—®é¢˜çš„æœºå­ä¸Šä½¿ç”¨<code>tcpdump -i flannel0</code>ï¼Œå‘½ä»¤è¡Œè¾“å‡ºäº†<code>01:57:55.680586 IP 10.1.77.0 &gt; 10.1.11.2: ICMP echo request, id 12091, seq 514, length 64</code>ã€‚å¯ä»¥å¾—å‡ºç½‘ç»œæœ¬èº«åº”è¯¥æ˜¯é€šçš„ï¼Œä½†æ˜¯æœªè¿›è¡Œå“åº”ã€‚è¿›å…¥Containerï¼Œ<code>tcpdump -i eth0</code>ï¼Œæœªè¾“å‡ºä»»ä½•ä¸œè¥¿ã€‚å¾—å‡ºç»“è®ºï¼š<code>flannel0</code>æœªå°†pingè½¬åˆ°Containerã€‚</li>\n<li>å…³é—­æœ‰é—®é¢˜æœºå­çš„Kubernetesç›¸å…³çš„æœåŠ¡ã€‚é‡å¯å¯åŠ¨Containerï¼Œç»“æœå¯ä»¥pingé€šäº†ã€‚æ­¤æ—¶é‡å¯æœåŠ¡å™¨ï¼Œç»“æœè¿™ä¸ªæ—¶å€™ï¼Œå³ä½¿Kuberneteså¯åŠ¨ç€ï¼Œä¾ç„¶å¯ä»¥pingé€šã€‚å¥½æ€ªT Tã€‚</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"F-å‚è€ƒæ–‡ç« åˆ—è¡¨\"><a href=\"#F-å‚è€ƒæ–‡ç« åˆ—è¡¨\" class=\"headerlink\" title=\"F. å‚è€ƒæ–‡ç« åˆ—è¡¨\"></a>F. å‚è€ƒæ–‡ç« åˆ—è¡¨</h2><ol>\n<li><a href=\"https://mritd.me/2016/09/03/Dokcer-%E4%BD%BF%E7%94%A8-Flannel-%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%AE%AF/\" target=\"_blank\" rel=\"external\">Dokcer ä½¿ç”¨ Flannel è·¨ä¸»æœºé€šè®¯</a></li>\n<li><a href=\"http://zdevops.blog.51cto.com/2579684/1735492\" target=\"_blank\" rel=\"external\">kuberneteså…¥é—¨1ï¼škubernetes+flannel+etcdç¯å¢ƒæ­å»º(é€šç”¨å®‰è£…)</a></li>\n<li><a href=\"http://dockone.io/article/1186\" target=\"_blank\" rel=\"external\">ç”¨ Flannel é…ç½® Kubernetes ç½‘ç»œ</a></li>\n</ol>\n"},{"title":"ä¸ºä»€ä¹ˆé˜…è¯» RocketMQ æºç ï¼Ÿ","date":"2017-05-21T16:00:00.000Z","_content":"\n## ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿ\n\n* æ·±å…¥äº†è§£**æ•°æ®åº“ä¸­é—´ä»¶** ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚\n* NIO çš„å®ç° ä¸ Netty æœ‰ä»€ä¹ˆç‰¹æ®Šçš„åœ°æ–¹ï¼Ÿ\n* åˆ†å¸ƒå¼äº‹åŠ¡å¦‚ä½•å®ç°çš„ï¼Ÿ\n* ç­‰ç­‰\n\n## æ­¥éª¤\n\n* [ ] NIO\n* [ ] åˆ†å¸ƒå¼äº‹åŠ¡\n* [ ] åˆ†è¡¨\n* [ ] åˆ†åº“\n* [ ] è‡ªå¢åºåˆ—\n* [ ] å•åº“ä»»æ„ Join\n* [ ] è·¨åº“2è¡¨ Join\n* [ ] è·¨åº“å¤šè¡¨ Join\n* [ ] SQL è§£æ\n* [ ] è¯»å†™åˆ†ç¦»\n* [ ] MySQL ä¸»ä»\n* [ ] è‡ªåŠ¨æ•…éšœåˆ‡æ¢\n* [ ] Galera Cluster é›†ç¾¤\n* [ ] MHA é›†ç¾¤\n* [ ] Percona é›†ç¾¤\n* [ ] æœåŠ¡é™çº§\n* [ ] å¤šç§Ÿæˆ·\n* [ ] è·¯ç”±\n* [ ] MyCAT é›†ç¾¤\n* [ ] æ³¨è§£\n* [ ] å†…å­˜ç®¡ç†\n* [ ] ç¼“å­˜\n* [ ] ç›‘æ§\n* [ ] Mongodb\n* [ ] æ•°æ®æ±‡èš\n* [ ] æ•°æ®æ’åº\n* [ ] PreparedStatement\n\n","source":"_posts/MyCAT/2017_05_22_ä¸ºä»€ä¹ˆé˜…è¯»MyCATæºç ï¼Ÿ.md","raw":"title: ä¸ºä»€ä¹ˆé˜…è¯» RocketMQ æºç ï¼Ÿ\ndate: 2017-05-22\ntags:\ncategories: MyCAT\npermalink: RocketMQ/why-read-MyCAT-source-code\n\n---\n\n## ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿ\n\n* æ·±å…¥äº†è§£**æ•°æ®åº“ä¸­é—´ä»¶** ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚\n* NIO çš„å®ç° ä¸ Netty æœ‰ä»€ä¹ˆç‰¹æ®Šçš„åœ°æ–¹ï¼Ÿ\n* åˆ†å¸ƒå¼äº‹åŠ¡å¦‚ä½•å®ç°çš„ï¼Ÿ\n* ç­‰ç­‰\n\n## æ­¥éª¤\n\n* [ ] NIO\n* [ ] åˆ†å¸ƒå¼äº‹åŠ¡\n* [ ] åˆ†è¡¨\n* [ ] åˆ†åº“\n* [ ] è‡ªå¢åºåˆ—\n* [ ] å•åº“ä»»æ„ Join\n* [ ] è·¨åº“2è¡¨ Join\n* [ ] è·¨åº“å¤šè¡¨ Join\n* [ ] SQL è§£æ\n* [ ] è¯»å†™åˆ†ç¦»\n* [ ] MySQL ä¸»ä»\n* [ ] è‡ªåŠ¨æ•…éšœåˆ‡æ¢\n* [ ] Galera Cluster é›†ç¾¤\n* [ ] MHA é›†ç¾¤\n* [ ] Percona é›†ç¾¤\n* [ ] æœåŠ¡é™çº§\n* [ ] å¤šç§Ÿæˆ·\n* [ ] è·¯ç”±\n* [ ] MyCAT é›†ç¾¤\n* [ ] æ³¨è§£\n* [ ] å†…å­˜ç®¡ç†\n* [ ] ç¼“å­˜\n* [ ] ç›‘æ§\n* [ ] Mongodb\n* [ ] æ•°æ®æ±‡èš\n* [ ] æ•°æ®æ’åº\n* [ ] PreparedStatement\n\n","slug":"RocketMQ/why-read-MyCAT-source-code","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswy80004ak5dvdnx5nx1","content":"<h2 id=\"ä¸ºä»€ä¹ˆé˜…è¯»-MyCAT-æºç ï¼Ÿ\"><a href=\"#ä¸ºä»€ä¹ˆé˜…è¯»-MyCAT-æºç ï¼Ÿ\" class=\"headerlink\" title=\"ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿ\"></a>ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿ</h2><ul>\n<li>æ·±å…¥äº†è§£<strong>æ•°æ®åº“ä¸­é—´ä»¶</strong> ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</li>\n<li>NIO çš„å®ç° ä¸ Netty æœ‰ä»€ä¹ˆç‰¹æ®Šçš„åœ°æ–¹ï¼Ÿ</li>\n<li>åˆ†å¸ƒå¼äº‹åŠ¡å¦‚ä½•å®ç°çš„ï¼Ÿ</li>\n<li>ç­‰ç­‰</li>\n</ul>\n<h2 id=\"æ­¥éª¤\"><a href=\"#æ­¥éª¤\" class=\"headerlink\" title=\"æ­¥éª¤\"></a>æ­¥éª¤</h2><ul>\n<li>[ ] NIO</li>\n<li>[ ] åˆ†å¸ƒå¼äº‹åŠ¡</li>\n<li>[ ] åˆ†è¡¨</li>\n<li>[ ] åˆ†åº“</li>\n<li>[ ] è‡ªå¢åºåˆ—</li>\n<li>[ ] å•åº“ä»»æ„ Join</li>\n<li>[ ] è·¨åº“2è¡¨ Join</li>\n<li>[ ] è·¨åº“å¤šè¡¨ Join</li>\n<li>[ ] SQL è§£æ</li>\n<li>[ ] è¯»å†™åˆ†ç¦»</li>\n<li>[ ] MySQL ä¸»ä»</li>\n<li>[ ] è‡ªåŠ¨æ•…éšœåˆ‡æ¢</li>\n<li>[ ] Galera Cluster é›†ç¾¤</li>\n<li>[ ] MHA é›†ç¾¤</li>\n<li>[ ] Percona é›†ç¾¤</li>\n<li>[ ] æœåŠ¡é™çº§</li>\n<li>[ ] å¤šç§Ÿæˆ·</li>\n<li>[ ] è·¯ç”±</li>\n<li>[ ] MyCAT é›†ç¾¤</li>\n<li>[ ] æ³¨è§£</li>\n<li>[ ] å†…å­˜ç®¡ç†</li>\n<li>[ ] ç¼“å­˜</li>\n<li>[ ] ç›‘æ§</li>\n<li>[ ] Mongodb</li>\n<li>[ ] æ•°æ®æ±‡èš</li>\n<li>[ ] æ•°æ®æ’åº</li>\n<li>[ ] PreparedStatement</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"ä¸ºä»€ä¹ˆé˜…è¯»-MyCAT-æºç ï¼Ÿ\"><a href=\"#ä¸ºä»€ä¹ˆé˜…è¯»-MyCAT-æºç ï¼Ÿ\" class=\"headerlink\" title=\"ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿ\"></a>ä¸ºä»€ä¹ˆé˜…è¯» MyCAT æºç ï¼Ÿ</h2><ul>\n<li>æ·±å…¥äº†è§£<strong>æ•°æ®åº“ä¸­é—´ä»¶</strong> ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</li>\n<li>NIO çš„å®ç° ä¸ Netty æœ‰ä»€ä¹ˆç‰¹æ®Šçš„åœ°æ–¹ï¼Ÿ</li>\n<li>åˆ†å¸ƒå¼äº‹åŠ¡å¦‚ä½•å®ç°çš„ï¼Ÿ</li>\n<li>ç­‰ç­‰</li>\n</ul>\n<h2 id=\"æ­¥éª¤\"><a href=\"#æ­¥éª¤\" class=\"headerlink\" title=\"æ­¥éª¤\"></a>æ­¥éª¤</h2><ul>\n<li>[ ] NIO</li>\n<li>[ ] åˆ†å¸ƒå¼äº‹åŠ¡</li>\n<li>[ ] åˆ†è¡¨</li>\n<li>[ ] åˆ†åº“</li>\n<li>[ ] è‡ªå¢åºåˆ—</li>\n<li>[ ] å•åº“ä»»æ„ Join</li>\n<li>[ ] è·¨åº“2è¡¨ Join</li>\n<li>[ ] è·¨åº“å¤šè¡¨ Join</li>\n<li>[ ] SQL è§£æ</li>\n<li>[ ] è¯»å†™åˆ†ç¦»</li>\n<li>[ ] MySQL ä¸»ä»</li>\n<li>[ ] è‡ªåŠ¨æ•…éšœåˆ‡æ¢</li>\n<li>[ ] Galera Cluster é›†ç¾¤</li>\n<li>[ ] MHA é›†ç¾¤</li>\n<li>[ ] Percona é›†ç¾¤</li>\n<li>[ ] æœåŠ¡é™çº§</li>\n<li>[ ] å¤šç§Ÿæˆ·</li>\n<li>[ ] è·¯ç”±</li>\n<li>[ ] MyCAT é›†ç¾¤</li>\n<li>[ ] æ³¨è§£</li>\n<li>[ ] å†…å­˜ç®¡ç†</li>\n<li>[ ] ç¼“å­˜</li>\n<li>[ ] ç›‘æ§</li>\n<li>[ ] Mongodb</li>\n<li>[ ] æ•°æ®æ±‡èš</li>\n<li>[ ] æ•°æ®æ’åº</li>\n<li>[ ] PreparedStatement</li>\n</ul>\n"},{"title":"MyCAT æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º","date":"2017-05-22T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[MyCATæºç åˆ†æï¼šè°ƒè¯•ç¯å¢ƒæ­å»º](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1001-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md)  \n> `MyCat-Server` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[https://github.com/YunaiV/Mycat-Server)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. ä¾èµ–å·¥å…·](#)\n- [2. æºç æ‹‰å–](#)\n- [3. æ•°æ®åº“é…ç½®](#)\n- [4. MyCat é…ç½®](#)\n- [5. MyCAT å¯åŠ¨](#)\n- [6. MyCAT æµ‹è¯•](#)\n- [7. äº¤æµ](#)\n\n# 1. ä¾èµ–å·¥å…·\n\n* Maven\n* Git\n* JDK\n* MySQL\n* IntelliJ IDEA\n\n# 2. æºç æ‹‰å–\n\nä»å®˜æ–¹ä»“åº“ https://github.com/MyCATApache/Mycat-Server `Fork` å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ `Fork` ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ\n\nä½¿ç”¨ `IntelliJ IDEA` ä» `Fork` å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ`Maven` ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚\n\n# 3. æ•°æ®åº“é…ç½®\n\næˆ‘ä»¬è¦æ­å»ºçš„æ˜¯**éåˆ†ç‰‡è¡¨**çš„è°ƒè¯•ç¯å¢ƒï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å’Œè¡¨ï¼š\n\n1. åˆ›å»ºæ•°æ®åº“ï¼š`db01` ã€‚\n2. åˆ›å»ºæ•°æ®åº“è¡¨ï¼š`travelrecord` ã€‚\n\n```SQL\nCREATE TABLE `travelrecord` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `name` varchar(255) CHARACTER SET latin1 DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_bin\n```\n\n# 4. MyCAT é…ç½®\n\nä¸ºäº†é¿å…å¯¹å®ç°æºç äº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬é€‰æ‹©å¯¹ `test` ç›®å½•åšå˜æ›´ã€‚\n\n1ã€åœ¨ `resources` ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ `backups` ï¼Œå°†åŸ `resources` ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ç§»åˆ° `backups` ä¸‹ï¼Œè¿™æ ·æˆ‘ä»¬çš„ç¯å¢ƒå°±å¹²å¹²å‡€äº†ã€‚  \n2ã€åœ¨ `resources` ç›®å½•ä¸‹æ–°å»º `schema.xml` æ–‡ä»¶ï¼Œé…ç½® `MyCAT` çš„é€»è¾‘åº“ã€è¡¨ã€æ•°æ®èŠ‚ç‚¹ã€æ•°æ®æºã€‚\n\n```xml\n<?xml version=\"1.0\"?>\n<!DOCTYPE mycat:schema SYSTEM \"schema.dtd\">\n<mycat:schema xmlns:mycat=\"http://io.mycat/\">\n\n    <schema name=\"dbtest\" checkSQLschema=\"true\" sqlMaxLimit=\"100\">\n        <table name=\"travelrecord\" dataNode=\"dn1\" autoIncrement=\"true\" primaryKey=\"id\" />\n    </schema>\n\n\t<dataNode name=\"dn1\" dataHost=\"localhost1\" database=\"db1\" />\n\n\t<dataHost name=\"localhost1\" maxCon=\"1000\" minCon=\"10\" balance=\"0\"\n\t\t\t  writeType=\"0\" dbType=\"mysql\" dbDriver=\"native\" switchType=\"1\" slaveThreshold=\"100\">\n\t\t<heartbeat>select user()</heartbeat>\n\t\t<writeHost host=\"hostM1\" url=\"127.0.0.1:33061\" user=\"root\" password=\"123456\"> <!-- â€¼ï¸â€¼ï¸â€¼ï¸ urlã€userã€password è®¾ç½®æˆä½ çš„æ•°æ®åº“ -->\n\t\t</writeHost>\n\t</dataHost>\n\n</mycat:schema>\n```\n\n3ã€åœ¨ `resources` ç›®å½•ä¸‹æ–°å»º `server.xml` æ–‡ä»¶ï¼Œé…ç½® `MyCAT` ç³»ç»Ÿé…ç½®ã€‚\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE mycat:server SYSTEM \"server.dtd\">\n<mycat:server xmlns:mycat=\"http://io.mycat/\">\n\t<system>\n        <property name=\"nonePasswordLogin\">0</property> <!-- 0ä¸ºéœ€è¦å¯†ç ç™»é™†ã€1ä¸ºä¸éœ€è¦å¯†ç ç™»é™† ,é»˜è®¤ä¸º0ï¼Œè®¾ç½®ä¸º1åˆ™éœ€è¦æŒ‡å®šé»˜è®¤è´¦æˆ·-->\n        <property name=\"useHandshakeV10\">1</property>\n        <property name=\"useSqlStat\">0</property>  <!-- 1ä¸ºå¼€å¯å®æ—¶ç»Ÿè®¡ã€0ä¸ºå…³é—­ -->\n        <property name=\"useGlobleTableCheck\">0</property>  <!-- 1ä¸ºå¼€å¯å…¨åŠ ç­ä¸€è‡´æ€§æ£€æµ‹ã€0ä¸ºå…³é—­ -->\n\t\t<property name=\"sequnceHandlerType\">2</property>\n\t\t<property name=\"processorBufferPoolType\">0</property>\n\t\t<property name=\"handleDistributedTransactions\">0</property>\n\t\t<property name=\"useOffHeapForMerge\">1</property>\n        <property name=\"memoryPageSize\">64k</property>\n\t\t<property name=\"spillsFileBufferSize\">1k</property>\n\t\t<property name=\"useStreamOutput\">0</property>\n\t\t<property name=\"systemReserveMemorySize\">384m</property>\n\t\t<property name=\"useZKSwitch\">false</property>\n\t</system>\n\n\t<user name=\"root\" defaultAccount=\"true\">\n\t\t<property name=\"password\">123456</property>\n\t\t<property name=\"schemas\">dbtest</property>\n\t</user>\n\n</mycat:server>\n```\n\n# 5. MyCAT å¯åŠ¨\n\n1ã€åœ¨ `java` ç›®å½•ä¸‹æ–°å»º `debugger` åŒ…ï¼Œå’ŒåŸå…ˆå·²å­˜åœ¨çš„åŒ…åšåŒºåˆ†ã€‚  \n2ã€åœ¨ `debbuger` åŒ…ä¸‹æ–°å»º `MycatStartupTest.java` ï¼š\n\n```Java\npackage debugger;\n\nimport io.mycat.MycatStartup;\n\n/**\n * {@link io.mycat.MycatStartup}æµ‹è¯•\n *\n * Created by yunai on 2017/5/22.\n */\npublic class MycatStartupTest {\n\n    public static void main(String[] args) {\n        MycatStartup.main(args);\n    }\n\n}\n```\n\n3ã€è¿è¡Œ `MycatStartupTest.java` ï¼Œå½“çœ‹åˆ°è¾“å‡ºæ—¥å¿— `MyCAT Server startup successfully. see logs in logs/mycat.log` å³ä¸ºå¯åŠ¨æˆåŠŸã€‚\n\næˆªæ­¢ç›®å‰ï¼Œ`test` ç›®å½•å¦‚ä¸‹ï¼š\n\n![testç›®å½•.png](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1001/testç›®å½•.png)\n\n# 6. MyCAT æµ‹è¯•\n\nè°ƒè¯•ç¯å¢ƒå·²ç»æ­å»ºå®Œæˆï¼Œæˆ‘ä»¬çœ‹çœ‹æ˜¯å¦æ­£ç¡®ã€‚\n\nä½¿ç”¨ `MySQL` å®¢æˆ·ç«¯è¿æ¥ `MyCAT` ï¼š\n\n* HOST ï¼š127.0.0.1\n* PORT ï¼š8066\n* USERNAME ï¼šroot\n* PASSWORD ï¼š123456\n\n```SQL\nmysql> insert into travelrecord(name) values ('haha');\nQuery OK, 1 rows affected (0.01 sec)\n\nmysql> select * from travelrecord;\n+--------------------+------+\n| id                 | name |\n+--------------------+------+\n| 866707181398003712 | haha |\n+--------------------+------+\n1 rows in set (0.05 sec)\n```\n\næˆåŠŸã€‚ğŸ˜ˆğŸ˜ˆğŸ˜ˆ\n\n# 7. äº¤æµ\n\næ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€å…³æ³¨ã€‚  \n**çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚å­¦ä¹  MyCAT ä¼šæ˜¯ä¸€æ®µå¾ˆæ„‰å¿«çš„æ—…ç¨‹ã€‚å¦‚æœæœ‰ä½ çš„äº¤æµï¼Œç›¸ä¿¡ä¼šæ›´åŠ æ„‰å¿«ã€‚æ¬¢è¿æ·»åŠ å¾®ä¿¡ï¼š`wangwenbin-server` è¿›è¡Œæ¢è®¨ã€‚**\n\n\n","source":"_posts/MyCAT/2017_05_23_MyCATæºç åˆ†æâ€”â€”è°ƒè¯•ç¯å¢ƒæ­å»º.md","raw":"title: MyCAT æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º\ndate: 2017-05-23\ntags:\ncategories: MyCAT\npermalink: Mycat/build-debugging-environment\n\n---\n\n>  åŸæ–‡åœ°å€ï¼š[MyCATæºç åˆ†æï¼šè°ƒè¯•ç¯å¢ƒæ­å»º](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1001-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md)  \n> `MyCat-Server` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[https://github.com/YunaiV/Mycat-Server)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. ä¾èµ–å·¥å…·](#)\n- [2. æºç æ‹‰å–](#)\n- [3. æ•°æ®åº“é…ç½®](#)\n- [4. MyCat é…ç½®](#)\n- [5. MyCAT å¯åŠ¨](#)\n- [6. MyCAT æµ‹è¯•](#)\n- [7. äº¤æµ](#)\n\n# 1. ä¾èµ–å·¥å…·\n\n* Maven\n* Git\n* JDK\n* MySQL\n* IntelliJ IDEA\n\n# 2. æºç æ‹‰å–\n\nä»å®˜æ–¹ä»“åº“ https://github.com/MyCATApache/Mycat-Server `Fork` å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ `Fork` ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ\n\nä½¿ç”¨ `IntelliJ IDEA` ä» `Fork` å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ`Maven` ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚\n\n# 3. æ•°æ®åº“é…ç½®\n\næˆ‘ä»¬è¦æ­å»ºçš„æ˜¯**éåˆ†ç‰‡è¡¨**çš„è°ƒè¯•ç¯å¢ƒï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å’Œè¡¨ï¼š\n\n1. åˆ›å»ºæ•°æ®åº“ï¼š`db01` ã€‚\n2. åˆ›å»ºæ•°æ®åº“è¡¨ï¼š`travelrecord` ã€‚\n\n```SQL\nCREATE TABLE `travelrecord` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `name` varchar(255) CHARACTER SET latin1 DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_bin\n```\n\n# 4. MyCAT é…ç½®\n\nä¸ºäº†é¿å…å¯¹å®ç°æºç äº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬é€‰æ‹©å¯¹ `test` ç›®å½•åšå˜æ›´ã€‚\n\n1ã€åœ¨ `resources` ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ `backups` ï¼Œå°†åŸ `resources` ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ç§»åˆ° `backups` ä¸‹ï¼Œè¿™æ ·æˆ‘ä»¬çš„ç¯å¢ƒå°±å¹²å¹²å‡€äº†ã€‚  \n2ã€åœ¨ `resources` ç›®å½•ä¸‹æ–°å»º `schema.xml` æ–‡ä»¶ï¼Œé…ç½® `MyCAT` çš„é€»è¾‘åº“ã€è¡¨ã€æ•°æ®èŠ‚ç‚¹ã€æ•°æ®æºã€‚\n\n```xml\n<?xml version=\"1.0\"?>\n<!DOCTYPE mycat:schema SYSTEM \"schema.dtd\">\n<mycat:schema xmlns:mycat=\"http://io.mycat/\">\n\n    <schema name=\"dbtest\" checkSQLschema=\"true\" sqlMaxLimit=\"100\">\n        <table name=\"travelrecord\" dataNode=\"dn1\" autoIncrement=\"true\" primaryKey=\"id\" />\n    </schema>\n\n\t<dataNode name=\"dn1\" dataHost=\"localhost1\" database=\"db1\" />\n\n\t<dataHost name=\"localhost1\" maxCon=\"1000\" minCon=\"10\" balance=\"0\"\n\t\t\t  writeType=\"0\" dbType=\"mysql\" dbDriver=\"native\" switchType=\"1\" slaveThreshold=\"100\">\n\t\t<heartbeat>select user()</heartbeat>\n\t\t<writeHost host=\"hostM1\" url=\"127.0.0.1:33061\" user=\"root\" password=\"123456\"> <!-- â€¼ï¸â€¼ï¸â€¼ï¸ urlã€userã€password è®¾ç½®æˆä½ çš„æ•°æ®åº“ -->\n\t\t</writeHost>\n\t</dataHost>\n\n</mycat:schema>\n```\n\n3ã€åœ¨ `resources` ç›®å½•ä¸‹æ–°å»º `server.xml` æ–‡ä»¶ï¼Œé…ç½® `MyCAT` ç³»ç»Ÿé…ç½®ã€‚\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE mycat:server SYSTEM \"server.dtd\">\n<mycat:server xmlns:mycat=\"http://io.mycat/\">\n\t<system>\n        <property name=\"nonePasswordLogin\">0</property> <!-- 0ä¸ºéœ€è¦å¯†ç ç™»é™†ã€1ä¸ºä¸éœ€è¦å¯†ç ç™»é™† ,é»˜è®¤ä¸º0ï¼Œè®¾ç½®ä¸º1åˆ™éœ€è¦æŒ‡å®šé»˜è®¤è´¦æˆ·-->\n        <property name=\"useHandshakeV10\">1</property>\n        <property name=\"useSqlStat\">0</property>  <!-- 1ä¸ºå¼€å¯å®æ—¶ç»Ÿè®¡ã€0ä¸ºå…³é—­ -->\n        <property name=\"useGlobleTableCheck\">0</property>  <!-- 1ä¸ºå¼€å¯å…¨åŠ ç­ä¸€è‡´æ€§æ£€æµ‹ã€0ä¸ºå…³é—­ -->\n\t\t<property name=\"sequnceHandlerType\">2</property>\n\t\t<property name=\"processorBufferPoolType\">0</property>\n\t\t<property name=\"handleDistributedTransactions\">0</property>\n\t\t<property name=\"useOffHeapForMerge\">1</property>\n        <property name=\"memoryPageSize\">64k</property>\n\t\t<property name=\"spillsFileBufferSize\">1k</property>\n\t\t<property name=\"useStreamOutput\">0</property>\n\t\t<property name=\"systemReserveMemorySize\">384m</property>\n\t\t<property name=\"useZKSwitch\">false</property>\n\t</system>\n\n\t<user name=\"root\" defaultAccount=\"true\">\n\t\t<property name=\"password\">123456</property>\n\t\t<property name=\"schemas\">dbtest</property>\n\t</user>\n\n</mycat:server>\n```\n\n# 5. MyCAT å¯åŠ¨\n\n1ã€åœ¨ `java` ç›®å½•ä¸‹æ–°å»º `debugger` åŒ…ï¼Œå’ŒåŸå…ˆå·²å­˜åœ¨çš„åŒ…åšåŒºåˆ†ã€‚  \n2ã€åœ¨ `debbuger` åŒ…ä¸‹æ–°å»º `MycatStartupTest.java` ï¼š\n\n```Java\npackage debugger;\n\nimport io.mycat.MycatStartup;\n\n/**\n * {@link io.mycat.MycatStartup}æµ‹è¯•\n *\n * Created by yunai on 2017/5/22.\n */\npublic class MycatStartupTest {\n\n    public static void main(String[] args) {\n        MycatStartup.main(args);\n    }\n\n}\n```\n\n3ã€è¿è¡Œ `MycatStartupTest.java` ï¼Œå½“çœ‹åˆ°è¾“å‡ºæ—¥å¿— `MyCAT Server startup successfully. see logs in logs/mycat.log` å³ä¸ºå¯åŠ¨æˆåŠŸã€‚\n\næˆªæ­¢ç›®å‰ï¼Œ`test` ç›®å½•å¦‚ä¸‹ï¼š\n\n![testç›®å½•.png](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1001/testç›®å½•.png)\n\n# 6. MyCAT æµ‹è¯•\n\nè°ƒè¯•ç¯å¢ƒå·²ç»æ­å»ºå®Œæˆï¼Œæˆ‘ä»¬çœ‹çœ‹æ˜¯å¦æ­£ç¡®ã€‚\n\nä½¿ç”¨ `MySQL` å®¢æˆ·ç«¯è¿æ¥ `MyCAT` ï¼š\n\n* HOST ï¼š127.0.0.1\n* PORT ï¼š8066\n* USERNAME ï¼šroot\n* PASSWORD ï¼š123456\n\n```SQL\nmysql> insert into travelrecord(name) values ('haha');\nQuery OK, 1 rows affected (0.01 sec)\n\nmysql> select * from travelrecord;\n+--------------------+------+\n| id                 | name |\n+--------------------+------+\n| 866707181398003712 | haha |\n+--------------------+------+\n1 rows in set (0.05 sec)\n```\n\næˆåŠŸã€‚ğŸ˜ˆğŸ˜ˆğŸ˜ˆ\n\n# 7. äº¤æµ\n\næ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€å…³æ³¨ã€‚  \n**çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚å­¦ä¹  MyCAT ä¼šæ˜¯ä¸€æ®µå¾ˆæ„‰å¿«çš„æ—…ç¨‹ã€‚å¦‚æœæœ‰ä½ çš„äº¤æµï¼Œç›¸ä¿¡ä¼šæ›´åŠ æ„‰å¿«ã€‚æ¬¢è¿æ·»åŠ å¾®ä¿¡ï¼š`wangwenbin-server` è¿›è¡Œæ¢è®¨ã€‚**\n\n\n","slug":"Mycat/build-debugging-environment","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswyy000cak5dqlledbkt","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1001-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md\" target=\"_blank\" rel=\"external\">MyCATæºç åˆ†æï¼šè°ƒè¯•ç¯å¢ƒæ­å»º</a><br><code>MyCat-Server</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š[<a href=\"https://github.com/YunaiV/Mycat-Server\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Mycat-Server</a>)<br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. ä¾èµ–å·¥å…·</a></li>\n<li><a href=\"#\">2. æºç æ‹‰å–</a></li>\n<li><a href=\"#\">3. æ•°æ®åº“é…ç½®</a></li>\n<li><a href=\"#\">4. MyCat é…ç½®</a></li>\n<li><a href=\"#\">5. MyCAT å¯åŠ¨</a></li>\n<li><a href=\"#\">6. MyCAT æµ‹è¯•</a></li>\n<li><a href=\"#\">7. äº¤æµ</a></li>\n</ul>\n<h1 id=\"1-ä¾èµ–å·¥å…·\"><a href=\"#1-ä¾èµ–å·¥å…·\" class=\"headerlink\" title=\"1. ä¾èµ–å·¥å…·\"></a>1. ä¾èµ–å·¥å…·</h1><ul>\n<li>Maven</li>\n<li>Git</li>\n<li>JDK</li>\n<li>MySQL</li>\n<li>IntelliJ IDEA</li>\n</ul>\n<h1 id=\"2-æºç æ‹‰å–\"><a href=\"#2-æºç æ‹‰å–\" class=\"headerlink\" title=\"2. æºç æ‹‰å–\"></a>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href=\"https://github.com/MyCATApache/Mycat-Server\" target=\"_blank\" rel=\"external\">https://github.com/MyCATApache/Mycat-Server</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p>\n<p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ<code>Maven</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p>\n<h1 id=\"3-æ•°æ®åº“é…ç½®\"><a href=\"#3-æ•°æ®åº“é…ç½®\" class=\"headerlink\" title=\"3. æ•°æ®åº“é…ç½®\"></a>3. æ•°æ®åº“é…ç½®</h1><p>æˆ‘ä»¬è¦æ­å»ºçš„æ˜¯<strong>éåˆ†ç‰‡è¡¨</strong>çš„è°ƒè¯•ç¯å¢ƒï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å’Œè¡¨ï¼š</p>\n<ol>\n<li>åˆ›å»ºæ•°æ®åº“ï¼š<code>db01</code> ã€‚</li>\n<li>åˆ›å»ºæ•°æ®åº“è¡¨ï¼š<code>travelrecord</code> ã€‚</li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> <span class=\"string\">`travelrecord`</span> (</div><div class=\"line\">  <span class=\"string\">`id`</span> <span class=\"built_in\">bigint</span>(<span class=\"number\">20</span>) <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span> AUTO_INCREMENT,</div><div class=\"line\">  <span class=\"string\">`name`</span> <span class=\"built_in\">varchar</span>(<span class=\"number\">255</span>) <span class=\"built_in\">CHARACTER</span> <span class=\"keyword\">SET</span> latin1 <span class=\"keyword\">DEFAULT</span> <span class=\"literal\">NULL</span>,</div><div class=\"line\">  PRIMARY <span class=\"keyword\">KEY</span> (<span class=\"string\">`id`</span>)</div><div class=\"line\">) <span class=\"keyword\">ENGINE</span>=<span class=\"keyword\">InnoDB</span> AUTO_INCREMENT=<span class=\"number\">1</span> <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">CHARSET</span>=utf8 <span class=\"keyword\">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure>\n<h1 id=\"4-MyCAT-é…ç½®\"><a href=\"#4-MyCAT-é…ç½®\" class=\"headerlink\" title=\"4. MyCAT é…ç½®\"></a>4. MyCAT é…ç½®</h1><p>ä¸ºäº†é¿å…å¯¹å®ç°æºç äº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬é€‰æ‹©å¯¹ <code>test</code> ç›®å½•åšå˜æ›´ã€‚</p>\n<p>1ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ <code>backups</code> ï¼Œå°†åŸ <code>resources</code> ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ç§»åˆ° <code>backups</code> ä¸‹ï¼Œè¿™æ ·æˆ‘ä»¬çš„ç¯å¢ƒå°±å¹²å¹²å‡€äº†ã€‚<br>2ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»º <code>schema.xml</code> æ–‡ä»¶ï¼Œé…ç½® <code>MyCAT</code> çš„é€»è¾‘åº“ã€è¡¨ã€æ•°æ®èŠ‚ç‚¹ã€æ•°æ®æºã€‚</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><div class=\"line\">&lt;?xml version=\"1.0\"?&gt;</div><div class=\"line\"><span class=\"meta\">&lt;!DOCTYPE mycat:schema SYSTEM \"schema.dtd\"&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mycat:schema</span> <span class=\"attr\">xmlns:mycat</span>=<span class=\"string\">\"http://io.mycat/\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">schema</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dbtest\"</span> <span class=\"attr\">checkSQLschema</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">sqlMaxLimit</span>=<span class=\"string\">\"100\"</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">name</span>=<span class=\"string\">\"travelrecord\"</span> <span class=\"attr\">dataNode</span>=<span class=\"string\">\"dn1\"</span> <span class=\"attr\">autoIncrement</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">primaryKey</span>=<span class=\"string\">\"id\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">schema</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">dataNode</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dn1\"</span> <span class=\"attr\">dataHost</span>=<span class=\"string\">\"localhost1\"</span> <span class=\"attr\">database</span>=<span class=\"string\">\"db1\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">dataHost</span> <span class=\"attr\">name</span>=<span class=\"string\">\"localhost1\"</span> <span class=\"attr\">maxCon</span>=<span class=\"string\">\"1000\"</span> <span class=\"attr\">minCon</span>=<span class=\"string\">\"10\"</span> <span class=\"attr\">balance</span>=<span class=\"string\">\"0\"</span></span></div><div class=\"line\">\t\t\t  <span class=\"attr\">writeType</span>=<span class=\"string\">\"0\"</span> <span class=\"attr\">dbType</span>=<span class=\"string\">\"mysql\"</span> <span class=\"attr\">dbDriver</span>=<span class=\"string\">\"native\"</span> <span class=\"attr\">switchType</span>=<span class=\"string\">\"1\"</span> <span class=\"attr\">slaveThreshold</span>=<span class=\"string\">\"100\"</span>&gt;</div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">heartbeat</span>&gt;</span>select user()<span class=\"tag\">&lt;/<span class=\"name\">heartbeat</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">writeHost</span> <span class=\"attr\">host</span>=<span class=\"string\">\"hostM1\"</span> <span class=\"attr\">url</span>=<span class=\"string\">\"127.0.0.1:33061\"</span> <span class=\"attr\">user</span>=<span class=\"string\">\"root\"</span> <span class=\"attr\">password</span>=<span class=\"string\">\"123456\"</span>&gt;</span> <span class=\"comment\">&lt;!-- â€¼ï¸â€¼ï¸â€¼ï¸ urlã€userã€password è®¾ç½®æˆä½ çš„æ•°æ®åº“ --&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;/<span class=\"name\">writeHost</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;/<span class=\"name\">dataHost</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mycat:schema</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>3ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»º <code>server.xml</code> æ–‡ä»¶ï¼Œé…ç½® <code>MyCAT</code> ç³»ç»Ÿé…ç½®ã€‚</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><div class=\"line\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</div><div class=\"line\"><span class=\"meta\">&lt;!DOCTYPE mycat:server SYSTEM \"server.dtd\"&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mycat:server</span> <span class=\"attr\">xmlns:mycat</span>=<span class=\"string\">\"http://io.mycat/\"</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">system</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"nonePasswordLogin\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span> <span class=\"comment\">&lt;!-- 0ä¸ºéœ€è¦å¯†ç ç™»é™†ã€1ä¸ºä¸éœ€è¦å¯†ç ç™»é™† ,é»˜è®¤ä¸º0ï¼Œè®¾ç½®ä¸º1åˆ™éœ€è¦æŒ‡å®šé»˜è®¤è´¦æˆ·--&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useHandshakeV10\"</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useSqlStat\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span>  <span class=\"comment\">&lt;!-- 1ä¸ºå¼€å¯å®æ—¶ç»Ÿè®¡ã€0ä¸ºå…³é—­ --&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useGlobleTableCheck\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span>  <span class=\"comment\">&lt;!-- 1ä¸ºå¼€å¯å…¨åŠ ç­ä¸€è‡´æ€§æ£€æµ‹ã€0ä¸ºå…³é—­ --&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sequnceHandlerType\"</span>&gt;</span>2<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"processorBufferPoolType\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"handleDistributedTransactions\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useOffHeapForMerge\"</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"memoryPageSize\"</span>&gt;</span>64k<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"spillsFileBufferSize\"</span>&gt;</span>1k<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useStreamOutput\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"systemReserveMemorySize\"</span>&gt;</span>384m<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useZKSwitch\"</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;/<span class=\"name\">system</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">user</span> <span class=\"attr\">name</span>=<span class=\"string\">\"root\"</span> <span class=\"attr\">defaultAccount</span>=<span class=\"string\">\"true\"</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"password\"</span>&gt;</span>123456<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"schemas\"</span>&gt;</span>dbtest<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;/<span class=\"name\">user</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mycat:server</span>&gt;</span></div></pre></td></tr></table></figure>\n<h1 id=\"5-MyCAT-å¯åŠ¨\"><a href=\"#5-MyCAT-å¯åŠ¨\" class=\"headerlink\" title=\"5. MyCAT å¯åŠ¨\"></a>5. MyCAT å¯åŠ¨</h1><p>1ã€åœ¨ <code>java</code> ç›®å½•ä¸‹æ–°å»º <code>debugger</code> åŒ…ï¼Œå’ŒåŸå…ˆå·²å­˜åœ¨çš„åŒ…åšåŒºåˆ†ã€‚<br>2ã€åœ¨ <code>debbuger</code> åŒ…ä¸‹æ–°å»º <code>MycatStartupTest.java</code> ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> debugger;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> io.mycat.MycatStartup;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * &#123;<span class=\"doctag\">@link</span> io.mycat.MycatStartup&#125;æµ‹è¯•</div><div class=\"line\"> *</div><div class=\"line\"> * Created by yunai on 2017/5/22.</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MycatStartupTest</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</div><div class=\"line\">        MycatStartup.main(args);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>3ã€è¿è¡Œ <code>MycatStartupTest.java</code> ï¼Œå½“çœ‹åˆ°è¾“å‡ºæ—¥å¿— <code>MyCAT Server startup successfully. see logs in logs/mycat.log</code> å³ä¸ºå¯åŠ¨æˆåŠŸã€‚</p>\n<p>æˆªæ­¢ç›®å‰ï¼Œ<code>test</code> ç›®å½•å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1001/testç›®å½•.png\" alt=\"testç›®å½•.png\"></p>\n<h1 id=\"6-MyCAT-æµ‹è¯•\"><a href=\"#6-MyCAT-æµ‹è¯•\" class=\"headerlink\" title=\"6. MyCAT æµ‹è¯•\"></a>6. MyCAT æµ‹è¯•</h1><p>è°ƒè¯•ç¯å¢ƒå·²ç»æ­å»ºå®Œæˆï¼Œæˆ‘ä»¬çœ‹çœ‹æ˜¯å¦æ­£ç¡®ã€‚</p>\n<p>ä½¿ç”¨ <code>MySQL</code> å®¢æˆ·ç«¯è¿æ¥ <code>MyCAT</code> ï¼š</p>\n<ul>\n<li>HOST ï¼š127.0.0.1</li>\n<li>PORT ï¼š8066</li>\n<li>USERNAME ï¼šroot</li>\n<li>PASSWORD ï¼š123456</li>\n</ul>\n<figure class=\"highlight\"><table><tr><td class=\"code\"><pre><div class=\"line\">mysql&gt; insert into travelrecord(name) values ('haha');</div><div class=\"line\">Query OK, 1 rows affected (0.01 sec)</div><div class=\"line\"></div><div class=\"line\">mysql&gt; select * from travelrecord;</div><div class=\"line\">+--------------------+------+</div><div class=\"line\">| id                 | name |</div><div class=\"line\">+--------------------+------+</div><div class=\"line\">| 866707181398003712 | haha |</div><div class=\"line\">+--------------------+------+</div><div class=\"line\">1 rows in set (0.05 sec)</div></pre></td></tr></table></figure>\n<p>æˆåŠŸã€‚ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</p>\n<h1 id=\"7-äº¤æµ\"><a href=\"#7-äº¤æµ\" class=\"headerlink\" title=\"7. äº¤æµ\"></a>7. äº¤æµ</h1><p>æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€å…³æ³¨ã€‚<br><strong>çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚å­¦ä¹  MyCAT ä¼šæ˜¯ä¸€æ®µå¾ˆæ„‰å¿«çš„æ—…ç¨‹ã€‚å¦‚æœæœ‰ä½ çš„äº¤æµï¼Œç›¸ä¿¡ä¼šæ›´åŠ æ„‰å¿«ã€‚æ¬¢è¿æ·»åŠ å¾®ä¿¡ï¼š<code>wangwenbin-server</code> è¿›è¡Œæ¢è®¨ã€‚</strong></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1001-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md\" target=\"_blank\" rel=\"external\">MyCATæºç åˆ†æï¼šè°ƒè¯•ç¯å¢ƒæ­å»º</a><br><code>MyCat-Server</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š[<a href=\"https://github.com/YunaiV/Mycat-Server\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Mycat-Server</a>)<br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. ä¾èµ–å·¥å…·</a></li>\n<li><a href=\"#\">2. æºç æ‹‰å–</a></li>\n<li><a href=\"#\">3. æ•°æ®åº“é…ç½®</a></li>\n<li><a href=\"#\">4. MyCat é…ç½®</a></li>\n<li><a href=\"#\">5. MyCAT å¯åŠ¨</a></li>\n<li><a href=\"#\">6. MyCAT æµ‹è¯•</a></li>\n<li><a href=\"#\">7. äº¤æµ</a></li>\n</ul>\n<h1 id=\"1-ä¾èµ–å·¥å…·\"><a href=\"#1-ä¾èµ–å·¥å…·\" class=\"headerlink\" title=\"1. ä¾èµ–å·¥å…·\"></a>1. ä¾èµ–å·¥å…·</h1><ul>\n<li>Maven</li>\n<li>Git</li>\n<li>JDK</li>\n<li>MySQL</li>\n<li>IntelliJ IDEA</li>\n</ul>\n<h1 id=\"2-æºç æ‹‰å–\"><a href=\"#2-æºç æ‹‰å–\" class=\"headerlink\" title=\"2. æºç æ‹‰å–\"></a>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href=\"https://github.com/MyCATApache/Mycat-Server\" target=\"_blank\" rel=\"external\">https://github.com/MyCATApache/Mycat-Server</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p>\n<p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ<code>Maven</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p>\n<h1 id=\"3-æ•°æ®åº“é…ç½®\"><a href=\"#3-æ•°æ®åº“é…ç½®\" class=\"headerlink\" title=\"3. æ•°æ®åº“é…ç½®\"></a>3. æ•°æ®åº“é…ç½®</h1><p>æˆ‘ä»¬è¦æ­å»ºçš„æ˜¯<strong>éåˆ†ç‰‡è¡¨</strong>çš„è°ƒè¯•ç¯å¢ƒï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å’Œè¡¨ï¼š</p>\n<ol>\n<li>åˆ›å»ºæ•°æ®åº“ï¼š<code>db01</code> ã€‚</li>\n<li>åˆ›å»ºæ•°æ®åº“è¡¨ï¼š<code>travelrecord</code> ã€‚</li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> <span class=\"string\">`travelrecord`</span> (</div><div class=\"line\">  <span class=\"string\">`id`</span> <span class=\"built_in\">bigint</span>(<span class=\"number\">20</span>) <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span> AUTO_INCREMENT,</div><div class=\"line\">  <span class=\"string\">`name`</span> <span class=\"built_in\">varchar</span>(<span class=\"number\">255</span>) <span class=\"built_in\">CHARACTER</span> <span class=\"keyword\">SET</span> latin1 <span class=\"keyword\">DEFAULT</span> <span class=\"literal\">NULL</span>,</div><div class=\"line\">  PRIMARY <span class=\"keyword\">KEY</span> (<span class=\"string\">`id`</span>)</div><div class=\"line\">) <span class=\"keyword\">ENGINE</span>=<span class=\"keyword\">InnoDB</span> AUTO_INCREMENT=<span class=\"number\">1</span> <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">CHARSET</span>=utf8 <span class=\"keyword\">COLLATE</span>=utf8_bin</div></pre></td></tr></table></figure>\n<h1 id=\"4-MyCAT-é…ç½®\"><a href=\"#4-MyCAT-é…ç½®\" class=\"headerlink\" title=\"4. MyCAT é…ç½®\"></a>4. MyCAT é…ç½®</h1><p>ä¸ºäº†é¿å…å¯¹å®ç°æºç äº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬é€‰æ‹©å¯¹ <code>test</code> ç›®å½•åšå˜æ›´ã€‚</p>\n<p>1ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ <code>backups</code> ï¼Œå°†åŸ <code>resources</code> ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ç§»åˆ° <code>backups</code> ä¸‹ï¼Œè¿™æ ·æˆ‘ä»¬çš„ç¯å¢ƒå°±å¹²å¹²å‡€äº†ã€‚<br>2ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»º <code>schema.xml</code> æ–‡ä»¶ï¼Œé…ç½® <code>MyCAT</code> çš„é€»è¾‘åº“ã€è¡¨ã€æ•°æ®èŠ‚ç‚¹ã€æ•°æ®æºã€‚</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><div class=\"line\">&lt;?xml version=\"1.0\"?&gt;</div><div class=\"line\"><span class=\"meta\">&lt;!DOCTYPE mycat:schema SYSTEM \"schema.dtd\"&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mycat:schema</span> <span class=\"attr\">xmlns:mycat</span>=<span class=\"string\">\"http://io.mycat/\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">schema</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dbtest\"</span> <span class=\"attr\">checkSQLschema</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">sqlMaxLimit</span>=<span class=\"string\">\"100\"</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">name</span>=<span class=\"string\">\"travelrecord\"</span> <span class=\"attr\">dataNode</span>=<span class=\"string\">\"dn1\"</span> <span class=\"attr\">autoIncrement</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">primaryKey</span>=<span class=\"string\">\"id\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">schema</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">dataNode</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dn1\"</span> <span class=\"attr\">dataHost</span>=<span class=\"string\">\"localhost1\"</span> <span class=\"attr\">database</span>=<span class=\"string\">\"db1\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">dataHost</span> <span class=\"attr\">name</span>=<span class=\"string\">\"localhost1\"</span> <span class=\"attr\">maxCon</span>=<span class=\"string\">\"1000\"</span> <span class=\"attr\">minCon</span>=<span class=\"string\">\"10\"</span> <span class=\"attr\">balance</span>=<span class=\"string\">\"0\"</span></span></div><div class=\"line\">\t\t\t  <span class=\"attr\">writeType</span>=<span class=\"string\">\"0\"</span> <span class=\"attr\">dbType</span>=<span class=\"string\">\"mysql\"</span> <span class=\"attr\">dbDriver</span>=<span class=\"string\">\"native\"</span> <span class=\"attr\">switchType</span>=<span class=\"string\">\"1\"</span> <span class=\"attr\">slaveThreshold</span>=<span class=\"string\">\"100\"</span>&gt;</div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">heartbeat</span>&gt;</span>select user()<span class=\"tag\">&lt;/<span class=\"name\">heartbeat</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">writeHost</span> <span class=\"attr\">host</span>=<span class=\"string\">\"hostM1\"</span> <span class=\"attr\">url</span>=<span class=\"string\">\"127.0.0.1:33061\"</span> <span class=\"attr\">user</span>=<span class=\"string\">\"root\"</span> <span class=\"attr\">password</span>=<span class=\"string\">\"123456\"</span>&gt;</span> <span class=\"comment\">&lt;!-- â€¼ï¸â€¼ï¸â€¼ï¸ urlã€userã€password è®¾ç½®æˆä½ çš„æ•°æ®åº“ --&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;/<span class=\"name\">writeHost</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;/<span class=\"name\">dataHost</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mycat:schema</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>3ã€åœ¨ <code>resources</code> ç›®å½•ä¸‹æ–°å»º <code>server.xml</code> æ–‡ä»¶ï¼Œé…ç½® <code>MyCAT</code> ç³»ç»Ÿé…ç½®ã€‚</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><div class=\"line\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</div><div class=\"line\"><span class=\"meta\">&lt;!DOCTYPE mycat:server SYSTEM \"server.dtd\"&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mycat:server</span> <span class=\"attr\">xmlns:mycat</span>=<span class=\"string\">\"http://io.mycat/\"</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">system</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"nonePasswordLogin\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span> <span class=\"comment\">&lt;!-- 0ä¸ºéœ€è¦å¯†ç ç™»é™†ã€1ä¸ºä¸éœ€è¦å¯†ç ç™»é™† ,é»˜è®¤ä¸º0ï¼Œè®¾ç½®ä¸º1åˆ™éœ€è¦æŒ‡å®šé»˜è®¤è´¦æˆ·--&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useHandshakeV10\"</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useSqlStat\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span>  <span class=\"comment\">&lt;!-- 1ä¸ºå¼€å¯å®æ—¶ç»Ÿè®¡ã€0ä¸ºå…³é—­ --&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useGlobleTableCheck\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span>  <span class=\"comment\">&lt;!-- 1ä¸ºå¼€å¯å…¨åŠ ç­ä¸€è‡´æ€§æ£€æµ‹ã€0ä¸ºå…³é—­ --&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sequnceHandlerType\"</span>&gt;</span>2<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"processorBufferPoolType\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"handleDistributedTransactions\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useOffHeapForMerge\"</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"memoryPageSize\"</span>&gt;</span>64k<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"spillsFileBufferSize\"</span>&gt;</span>1k<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useStreamOutput\"</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"systemReserveMemorySize\"</span>&gt;</span>384m<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"useZKSwitch\"</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;/<span class=\"name\">system</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">user</span> <span class=\"attr\">name</span>=<span class=\"string\">\"root\"</span> <span class=\"attr\">defaultAccount</span>=<span class=\"string\">\"true\"</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"password\"</span>&gt;</span>123456<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"schemas\"</span>&gt;</span>dbtest<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;/<span class=\"name\">user</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mycat:server</span>&gt;</span></div></pre></td></tr></table></figure>\n<h1 id=\"5-MyCAT-å¯åŠ¨\"><a href=\"#5-MyCAT-å¯åŠ¨\" class=\"headerlink\" title=\"5. MyCAT å¯åŠ¨\"></a>5. MyCAT å¯åŠ¨</h1><p>1ã€åœ¨ <code>java</code> ç›®å½•ä¸‹æ–°å»º <code>debugger</code> åŒ…ï¼Œå’ŒåŸå…ˆå·²å­˜åœ¨çš„åŒ…åšåŒºåˆ†ã€‚<br>2ã€åœ¨ <code>debbuger</code> åŒ…ä¸‹æ–°å»º <code>MycatStartupTest.java</code> ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> debugger;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> io.mycat.MycatStartup;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * &#123;<span class=\"doctag\">@link</span> io.mycat.MycatStartup&#125;æµ‹è¯•</div><div class=\"line\"> *</div><div class=\"line\"> * Created by yunai on 2017/5/22.</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MycatStartupTest</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</div><div class=\"line\">        MycatStartup.main(args);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>3ã€è¿è¡Œ <code>MycatStartupTest.java</code> ï¼Œå½“çœ‹åˆ°è¾“å‡ºæ—¥å¿— <code>MyCAT Server startup successfully. see logs in logs/mycat.log</code> å³ä¸ºå¯åŠ¨æˆåŠŸã€‚</p>\n<p>æˆªæ­¢ç›®å‰ï¼Œ<code>test</code> ç›®å½•å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1001/testç›®å½•.png\" alt=\"testç›®å½•.png\"></p>\n<h1 id=\"6-MyCAT-æµ‹è¯•\"><a href=\"#6-MyCAT-æµ‹è¯•\" class=\"headerlink\" title=\"6. MyCAT æµ‹è¯•\"></a>6. MyCAT æµ‹è¯•</h1><p>è°ƒè¯•ç¯å¢ƒå·²ç»æ­å»ºå®Œæˆï¼Œæˆ‘ä»¬çœ‹çœ‹æ˜¯å¦æ­£ç¡®ã€‚</p>\n<p>ä½¿ç”¨ <code>MySQL</code> å®¢æˆ·ç«¯è¿æ¥ <code>MyCAT</code> ï¼š</p>\n<ul>\n<li>HOST ï¼š127.0.0.1</li>\n<li>PORT ï¼š8066</li>\n<li>USERNAME ï¼šroot</li>\n<li>PASSWORD ï¼š123456</li>\n</ul>\n<figure class=\"highlight\"><table><tr><td class=\"code\"><pre><div class=\"line\">mysql&gt; insert into travelrecord(name) values ('haha');</div><div class=\"line\">Query OK, 1 rows affected (0.01 sec)</div><div class=\"line\"></div><div class=\"line\">mysql&gt; select * from travelrecord;</div><div class=\"line\">+--------------------+------+</div><div class=\"line\">| id                 | name |</div><div class=\"line\">+--------------------+------+</div><div class=\"line\">| 866707181398003712 | haha |</div><div class=\"line\">+--------------------+------+</div><div class=\"line\">1 rows in set (0.05 sec)</div></pre></td></tr></table></figure>\n<p>æˆåŠŸã€‚ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</p>\n<h1 id=\"7-äº¤æµ\"><a href=\"#7-äº¤æµ\" class=\"headerlink\" title=\"7. äº¤æµ\"></a>7. äº¤æµ</h1><p>æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€å…³æ³¨ã€‚<br><strong>çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚å­¦ä¹  MyCAT ä¼šæ˜¯ä¸€æ®µå¾ˆæ„‰å¿«çš„æ—…ç¨‹ã€‚å¦‚æœæœ‰ä½ çš„äº¤æµï¼Œç›¸ä¿¡ä¼šæ›´åŠ æ„‰å¿«ã€‚æ¬¢è¿æ·»åŠ å¾®ä¿¡ï¼š<code>wangwenbin-server</code> è¿›è¡Œæ¢è®¨ã€‚</strong></p>\n"},{"title":"MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥","date":"2017-05-28T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md)  \n> `MyCat-Server` **å¸¦æ³¨é‡Š**åœ°å€ ï¼šhttps://github.com/YunaiV/Mycat-Server  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blog**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL](#)\n- [3. è·å¾—è·¯ç”±ç»“æœ](#)\n- [4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL](#)\n- [5. å“åº”æ‰§è¡Œ SQL ç»“æœ](#)\n\n# 1. æ¦‚è¿°\n\n> å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚  \n> å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚  \n> å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚  \n> å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚\n\næœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æ’å…¥ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚äº¤äº’å¦‚ä¸‹å›¾ï¼š\n\n![å•åº“å•è¡¨æ’å…¥ç®€å›¾](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/å•åº“å•è¡¨æ’å…¥ç®€å›¾.png)\n\næ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š\n\n1. æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚\n2. è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚\n3. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚\n4. å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚\n\næˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚\n\n# 2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰.png)\n\n## ã€ 1 - 2 ã€‘\n\næ¥æ”¶**ä¸€æ¡** MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚\n\n## ã€ 3 ã€‘\n\nä¸åŒ MySQL å‘½ä»¤ï¼Œåˆ†å‘åˆ°ä¸åŒçš„æ–¹æ³•æ‰§è¡Œã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘\n  2: public class FrontendCommandHandler implements NIOHandler {\n  3: \n  4:     @Override\n  5:     public void handle(byte[] data) {\n  6:     \n  7:         // .... çœç•¥éƒ¨åˆ†ä»£ç \n  8:         switch (data[4]) // \n  9:         {\n 10:             case MySQLPacket.COM_INIT_DB:\n 11:                 commands.doInitDB();\n 12:                 source.initDB(data);\n 13:                 break;\n 14:             case MySQLPacket.COM_QUERY: // æŸ¥è¯¢å‘½ä»¤\n 15:                 // è®¡æ•°æŸ¥è¯¢å‘½ä»¤\n 16:                 commands.doQuery();\n 17:                 // æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤\n 18:                 source.query(data);\n 19:                 break;\n 20:             case MySQLPacket.COM_PING:\n 21:                 commands.doPing();\n 22:                 source.ping();\n 23:                 break;\n 24:             // .... çœç•¥éƒ¨åˆ†case\n 25:         }\n 26:     }\n 27: \n 28: }\n```\n\n`INSERT`/`SELECT`/`UPDATE`/`DELETE` ç­‰ SQL å½’å±äº `MySQLPacket.COM_QUERY`ï¼Œè¯¦ç»†å¯è§ï¼š[ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -> æœåŠ¡å™¨ï¼‰ã€‹](http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-)ã€‚\n\n##ã€ 4 ã€‘\n\nå°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘\n  2: public void query(byte[] data) {\n  3: \t// å–å¾—è¯­å¥\n  4: \tString sql = null;\t\t\n  5: \ttry {\n  6: \t\tMySQLMessage mm = new MySQLMessage(data);\n  7: \t\tmm.position(5);\n  8: \t\tsql = mm.readString(charset);\n  9: \t} catch (UnsupportedEncodingException e) {\n 10: \t\twriteErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, \"Unknown charset '\" + charset + \"'\");\n 11: \t\treturn;\n 12: \t}\t\t\n 13: \t// æ‰§è¡Œè¯­å¥\n 14: \tthis.query( sql );\n 15: }\n```\n\n##ã€ 5 ã€‘\n\nè§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘\n  2: @Override\n  3: public void query(String sql) {\n  4: \t// è§£æ SQL ç±»å‹\n  5: \tint rs = ServerParse.parse(sql);\n  6: \tint sqlType = rs & 0xff;\n  7: \t\n  8: \tswitch (sqlType) {\n  9: \t//explain sql\n 10: \tcase ServerParse.EXPLAIN:\n 11: \t\tExplainHandler.handle(sql, c, rs >>> 8);\n 12: \t\tbreak;\n 13: \t// .... çœç•¥éƒ¨åˆ†case\n 14: \t\tbreak;\n 15: \tcase ServerParse.SELECT:\n 16: \t\tSelectHandler.handle(sql, c, rs >>> 8);\n 17: \t\tbreak;\n 18: \t// .... çœç•¥éƒ¨åˆ†case\n 19: \tdefault:\n 20: \t\tif(readOnly){\n 21: \t\t\tLOGGER.warn(new StringBuilder().append(\"User readonly:\").append(sql).toString());\n 22: \t\t\tc.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, \"User readonly\");\n 23: \t\t\tbreak;\n 24: \t\t}\n 25: \t\tc.execute(sql, rs & 0xff);\n 26: \t}\n 27: }\n 28: \n 29:\n 30: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘\n 31: public static int parse(String stmt) {\n 32: \tint length = stmt.length();\n 33: \t//FIX BUG FOR SQL SUCH AS /XXXX/SQL\n 34: \tint rt = -1;\n 35: \tfor (int i = 0; i < length; ++i) {\n 36: \t\tswitch (stmt.charAt(i)) {\n 37: \t\t// .... çœç•¥éƒ¨åˆ†case\t\t\tcase 'I':\n 38: \t\tcase 'i':\n 39: \t\t\trt = insertCheck(stmt, i);\n 40: \t\t\tif (rt != OTHER) {\n 41: \t\t\t\treturn rt;\n 42: \t\t\t}\n 43: \t\t\tcontinue;\n 44: \t\t\t// .... çœç•¥éƒ¨åˆ†case\n 45: \t\tcase 'S':\n 46: \t\tcase 's':\n 47: \t\t\trt = sCheck(stmt, i);\n 48: \t\t\tif (rt != OTHER) {\n 49: \t\t\t\treturn rt;\n 50: \t\t\t}\n 51: \t\t\tcontinue;\n 52: \t\t\t// .... çœç•¥éƒ¨åˆ†case\n 53: \t\tdefault:\n 54: \t\t\tcontinue;\n 55: \t\t}\n 56: \t}\n 57: \treturn OTHER;\n 58: }\n```\n\n##ã€ 6 ã€‘\n\næ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘\n  2: public class ServerConnection extends FrontendConnection {\n  3: \tpublic void execute(String sql, int type) {\n  4: \t\t// .... çœç•¥ä»£ç \n  5: \t\tSchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);\n  6: \t\tif (schema == null) {\n  7: \t\t\twriteErrMessage(ErrorCode.ERR_BAD_LOGICDB,\n  8: \t\t\t\t\t\"Unknown MyCAT Database '\" + db + \"'\");\n  9: \t\t\treturn;\n 10: \t\t}\n 11: \n 12: \t\t// .... çœç•¥ä»£ç \n 13: \n 14: \t\t// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL\n 15: \t\trouteEndExecuteSQL(sql, type, schema);\n 16: \t}\n 17: \t\n 18:     public void routeEndExecuteSQL(String sql, final int type, final SchemaConfig schema) {\n 19: \t\t// è·¯ç”±è®¡ç®—\n 20: \t\tRouteResultset rrs = null;\n 21: \t\ttry {\n 22: \t\t\trrs = MycatServer\n 23: \t\t\t\t\t.getInstance()\n 24: \t\t\t\t\t.getRouterservice()\n 25: \t\t\t\t\t.route(MycatServer.getInstance().getConfig().getSystem(),\n 26: \t\t\t\t\t\t\tschema, type, sql, this.charset, this);\n 27: \n 28: \t\t} catch (Exception e) {\n 29: \t\t\tStringBuilder s = new StringBuilder();\n 30: \t\t\tLOGGER.warn(s.append(this).append(sql).toString() + \" err:\" + e.toString(),e);\n 31: \t\t\tString msg = e.getMessage();\n 32: \t\t\twriteErrMessage(ErrorCode.ER_PARSE_ERROR, msg == null ? e.getClass().getSimpleName() : msg);\n 33: \t\t\treturn;\n 34: \t\t}\n 35: \n 36: \t\t// æ‰§è¡Œ SQL\n 37: \t\tif (rrs != null) {\n 38: \t\t\t// sessionæ‰§è¡Œ\n 39: \t\t\tsession.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);\n 40: \t\t}\n 41: \t\t\n 42:  \t}\n 43: \n 44: }\n```\n\n# 3. è·å¾—è·¯ç”±ç»“æœ\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰.png)\n\n## ã€ 1 - 2 ã€‘ã€ 12 ã€‘\n\nè·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouteService.javaã€‘\n  2: public RouteResultset route(SystemConfig sysconf, SchemaConfig schema,\n  3: \t\tint sqlType, String stmt, String charset, ServerConnection sc)\n  4: \t\tthrows SQLNonTransientException {\n  5: \tRouteResultset rrs = null;\n  6: \t// .... çœç•¥ä»£ç \n  7: \tint hintLength = RouteService.isHintSql(stmt);\n  8: \tif(hintLength != -1){ // TODO å¾…è¯»ï¼šhint\n  9: \t\t// .... çœç•¥ä»£ç \n 10: \t\t}\n 11: \t} else {\n 12: \t\tstmt = stmt.trim();\n 13: \t\trrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,\n 14: \t\t\t\tcharset, sc, tableId2DataNodeCache);\n 15: \t}\n 16: \n 17: \t// .... çœç•¥ä»£ç \t\treturn rrs;\n 18: }\n 19: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘\n 20: @Override\n 21: public RouteResultset route(SystemConfig sysConfig, SchemaConfig schema, int sqlType, String origSQL,\n 22: \t\tString charset, ServerConnection sc, LayerCachePool cachePool) throws SQLNonTransientException {\n 23: \n 24: \t// .... çœç•¥ä»£ç \n 25: \n 26: \t// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥\n 27: \tif (beforeRouteProcess(schema, sqlType, origSQL, sc) ) {\n 28: \t\treturn null;\n 29: \t}\n 30: \n 31: \t// .... çœç•¥ä»£ç \n 32: \n 33: \t// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡\n 34: \tif (schema.isNoSharding() && ServerParse.SHOW != sqlType) {\n 35: \t\trrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);\n 36: \t} else {\n 37: \t\tRouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);\n 38: \t\tif (returnedSet == null) {\n 39: \t\t\trrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);\n 40: \t\t}\n 41: \t}\n 42: \n 43: \treturn rrs;\n 44: }\n```\n\n_**è·¯ç”±** è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚_\n\n## ã€ 3 - 6 ã€‘\n\nè·¯ç”±**å‰ç½®**å¤„ç†ã€‚å½“ç¬¦åˆå¦‚ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè¿›è¡Œå¤„ç†ï¼š  \n\n{ 1 } ä½¿ç”¨**å…¨å±€åºåˆ—å·**ï¼š\n\n```SQL\ninsert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')\n```\n \n{ 2 } ER å­è¡¨æ’å…¥  \n{ 3 } ä¸»é”®ä½¿ç”¨è‡ªå¢ ID æ’å…¥ï¼š\n\n```SQL\ninsert into table (name) values ('name')\n===>\ninsert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')\n```  \n\næƒ…å†µ { 1 } { 3 } æƒ…å†µç±»ä¼¼ï¼Œä½¿ç”¨å…¨å±€åºåˆ—å·ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘\n  2: private boolean beforeRouteProcess(SchemaConfig schema, int sqlType, String origSQL, ServerConnection sc)\n  3: \t\tthrows SQLNonTransientException {\n  4: \treturn  // å¤„ç† id ä½¿ç”¨ å…¨å±€åºåˆ—å·\n  5:             RouterUtil.processWithMycatSeq(schema, sqlType, origSQL, sc)\n  6:             // å¤„ç† ER å­è¡¨\n  7: \t\t\t|| (sqlType == ServerParse.INSERT && RouterUtil.processERChildTable(schema, origSQL, sc))\n  8:             // å¤„ç† id è‡ªå¢é•¿\n  9: \t\t\t|| (sqlType == ServerParse.INSERT && RouterUtil.processInsert(schema, sqlType, origSQL, sc));\n 10: }\n```\n\n`RouterUtil.java` å¤„ç† SQL è€ƒè™‘æ€§èƒ½ï¼Œå®ç°ä¼šæ¯”è¾ƒ C-styleï¼Œä»£ç å’±å°±ä¸è´´äº†ï¼Œä¼ é€é—¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚ ï¼ˆğŸ˜ˆè¯¥ä»“åº“ä»å®˜æ–¹ Forkï¼Œé€æ­¥å®Œå–„ä¸­æ–‡æ³¨é‡Šï¼Œæ¬¢è¿ Starï¼‰\n\n## ã€ 7 - 11 ã€‘\n\nå½“**å‰ç½®**è·¯ç”±å¤„ç†**å…¨å±€åºåˆ—å·**æ—¶ï¼Œæ·»åŠ åˆ°å…¨å±€åºåˆ—å¤„ç†å™¨ï¼ˆ`MyCATSequnceProcessor`ï¼‰ã€‚è¯¥å¤„ç†å™¨ä¼šå¼‚æ­¥ç”Ÿæˆ IDï¼Œæ›¿æ¢ SQL å†…çš„ `NEXT VALUE FOR MYCATSEQ_` æ­£åˆ™ã€‚ä¾‹å¦‚ï¼š\n\n```SQL\ninsert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')\n===>\ninsert into table (id, name) values (868348974560579584, 'name')\n```\n\nå¼‚æ­¥å¤„ç†å®Œåï¼Œè°ƒç”¨ `ServerConnection#routeEndExecuteSQL(sql, type, schema)` æ–¹æ³•é‡æ–°æ‰§è¡Œ SQLã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouterUtil.javaã€‘\n  2: public static void processSQL(ServerConnection sc,SchemaConfig schema,String sql,int sqlType){\n  3: \tSessionSQLPair sessionSQLPair = new SessionSQLPair(sc.getSession2(), schema, sql, sqlType);\n  4: \tMycatServer.getInstance().getSequnceProcessor().addNewSql(sessionSQLPair);\n  5: }\n  6: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MyCATSequnceProcessor.javaã€‘\n  7: public class MyCATSequnceProcessor {\n  8: \tprivate LinkedBlockingQueue<SessionSQLPair> seqSQLQueue = new LinkedBlockingQueue<SessionSQLPair>();\n  9: \tprivate volatile boolean running=true;\n 10: \t\n 11: \tpublic void addNewSql(SessionSQLPair pair) {\n 12: \t\tseqSQLQueue.add(pair);\n 13: \t}\n 14: \n 15: \tprivate void executeSeq(SessionSQLPair pair) {\n 16: \t\ttry {\n 17: \t\t\t\n 18: \t\t\t// ä½¿ç”¨Druidè§£æå™¨å®ç°sequenceå¤„ç†  @å…µä¸´åŸä¸‹\n 19: \t\t\tDruidSequenceHandler sequenceHandler = new DruidSequenceHandler(MycatServer\n 20: \t\t\t\t\t.getInstance().getConfig().getSystem().getSequnceHandlerType());\n 21: \n 22: \t\t\t// ç”Ÿæˆå¯æ‰§è¡Œ SQL ï¼šç›®å‰ä¸»è¦æ˜¯ç”Ÿæˆ id\n 23: \t\t\tString charset = pair.session.getSource().getCharset();\n 24: \t\t\tString executeSql = sequenceHandler.getExecuteSql(pair.sql,charset == null ? \"utf-8\":charset);\n 25: \n 26: \t\t\t// æ‰§è¡Œ SQL\n 27: \t\t\tpair.session.getSource().routeEndExecuteSQL(executeSql, pair.type,pair.schema);\n 28: \t\t} catch (Exception e) {\n 29: \t\t\tLOGGER.error(\"MyCATSequenceProcessor.executeSeq(SesionSQLPair)\",e);\n 30: \t\t\tpair.session.getSource().writeErrMessage(ErrorCode.ER_YES,\"mycat sequnce err.\" + e);\n 31: \t\t\treturn;\n 32: \t\t}\n 33: \t}\n 34: \t\n 35: \tclass ExecuteThread extends Thread {\n 36: \t\t\n 37: \t\tpublic ExecuteThread() {\n 38: \t\t\tsetDaemon(true); // è®¾ç½®ä¸ºåå°çº¿ç¨‹,é˜²æ­¢throw RuntimeExecptionè¿›ç¨‹ä»ç„¶å­˜åœ¨çš„é—®é¢˜\n 39: \t\t}\n 40: \t\t\n 41: \t\tpublic void run() {\n 42: \t\t\twhile (running) {\n 43: \t\t\t\ttry {\n 44: \t\t\t\t\tSessionSQLPair pair=seqSQLQueue.poll(100,TimeUnit.MILLISECONDS);\n 45: \t\t\t\t\tif(pair!=null){\n 46:                         executeSeq(pair);\n 47: \t\t\t\t\t}\n 48: \t\t\t\t} catch (Exception e) {\n 49: \t\t\t\t\tLOGGER.warn(\"MyCATSequenceProcessor$ExecutorThread\",e);\n 50: \t\t\t\t}\n 51: \t\t\t}\n 52: \t\t}\n 53: \t}\n 54: }\n```\n\nâ“æ­¤å¤„æœ‰ä¸ªç–‘é—®ï¼š`MyCATSequnceProcessor` æ˜¯å•çº¿ç¨‹ï¼Œä¼šä¸ä¼šæ’å…¥æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Ÿåç»­å’±åšä¸‹æ€§èƒ½æµ‹è¯•ã€‚\n\n# 4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ%20SQLï¼‰.png)\n\n## ã€ 1 - 8 ã€‘\n\nè·å¾— MySQL è¿æ¥ã€‚\n\n* PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚\n* PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚\n\n## ã€ 9 - 13 ã€‘\n\nå‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚\n\n# 5. å“åº”æ‰§è¡Œ SQL ç»“æœ\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰.png)\n\n## ã€ 1 - 4 ã€‘\n\nå¤„ç† MySQL Server å“åº”æ•°æ®åŒ…ã€‚\n\n## ã€ 5 - 8 ã€‘\n\nå‘é€æ’å…¥æˆåŠŸç»“æœç»™ MySQL Clientã€‚\n\n\n","source":"_posts/MyCAT/2017_05_29_MyCATæºç åˆ†æâ€”â€”ã€å•åº“å•è¡¨ã€‘æ’å…¥.md","raw":"title: MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥\ndate: 2017-05-29\ntags:\ncategories: MyCAT\npermalink: Mycat/single-db-single-table-insert\n\n---\n\n>  åŸæ–‡åœ°å€ï¼š[MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md)  \n> `MyCat-Server` **å¸¦æ³¨é‡Š**åœ°å€ ï¼šhttps://github.com/YunaiV/Mycat-Server  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blog**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL](#)\n- [3. è·å¾—è·¯ç”±ç»“æœ](#)\n- [4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL](#)\n- [5. å“åº”æ‰§è¡Œ SQL ç»“æœ](#)\n\n# 1. æ¦‚è¿°\n\n> å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚  \n> å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚  \n> å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚  \n> å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚\n\næœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æ’å…¥ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚äº¤äº’å¦‚ä¸‹å›¾ï¼š\n\n![å•åº“å•è¡¨æ’å…¥ç®€å›¾](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/å•åº“å•è¡¨æ’å…¥ç®€å›¾.png)\n\næ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š\n\n1. æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚\n2. è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚\n3. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚\n4. å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚\n\næˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚\n\n# 2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰.png)\n\n## ã€ 1 - 2 ã€‘\n\næ¥æ”¶**ä¸€æ¡** MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚\n\n## ã€ 3 ã€‘\n\nä¸åŒ MySQL å‘½ä»¤ï¼Œåˆ†å‘åˆ°ä¸åŒçš„æ–¹æ³•æ‰§è¡Œã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘\n  2: public class FrontendCommandHandler implements NIOHandler {\n  3: \n  4:     @Override\n  5:     public void handle(byte[] data) {\n  6:     \n  7:         // .... çœç•¥éƒ¨åˆ†ä»£ç \n  8:         switch (data[4]) // \n  9:         {\n 10:             case MySQLPacket.COM_INIT_DB:\n 11:                 commands.doInitDB();\n 12:                 source.initDB(data);\n 13:                 break;\n 14:             case MySQLPacket.COM_QUERY: // æŸ¥è¯¢å‘½ä»¤\n 15:                 // è®¡æ•°æŸ¥è¯¢å‘½ä»¤\n 16:                 commands.doQuery();\n 17:                 // æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤\n 18:                 source.query(data);\n 19:                 break;\n 20:             case MySQLPacket.COM_PING:\n 21:                 commands.doPing();\n 22:                 source.ping();\n 23:                 break;\n 24:             // .... çœç•¥éƒ¨åˆ†case\n 25:         }\n 26:     }\n 27: \n 28: }\n```\n\n`INSERT`/`SELECT`/`UPDATE`/`DELETE` ç­‰ SQL å½’å±äº `MySQLPacket.COM_QUERY`ï¼Œè¯¦ç»†å¯è§ï¼š[ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -> æœåŠ¡å™¨ï¼‰ã€‹](http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-)ã€‚\n\n##ã€ 4 ã€‘\n\nå°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘\n  2: public void query(byte[] data) {\n  3: \t// å–å¾—è¯­å¥\n  4: \tString sql = null;\t\t\n  5: \ttry {\n  6: \t\tMySQLMessage mm = new MySQLMessage(data);\n  7: \t\tmm.position(5);\n  8: \t\tsql = mm.readString(charset);\n  9: \t} catch (UnsupportedEncodingException e) {\n 10: \t\twriteErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, \"Unknown charset '\" + charset + \"'\");\n 11: \t\treturn;\n 12: \t}\t\t\n 13: \t// æ‰§è¡Œè¯­å¥\n 14: \tthis.query( sql );\n 15: }\n```\n\n##ã€ 5 ã€‘\n\nè§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘\n  2: @Override\n  3: public void query(String sql) {\n  4: \t// è§£æ SQL ç±»å‹\n  5: \tint rs = ServerParse.parse(sql);\n  6: \tint sqlType = rs & 0xff;\n  7: \t\n  8: \tswitch (sqlType) {\n  9: \t//explain sql\n 10: \tcase ServerParse.EXPLAIN:\n 11: \t\tExplainHandler.handle(sql, c, rs >>> 8);\n 12: \t\tbreak;\n 13: \t// .... çœç•¥éƒ¨åˆ†case\n 14: \t\tbreak;\n 15: \tcase ServerParse.SELECT:\n 16: \t\tSelectHandler.handle(sql, c, rs >>> 8);\n 17: \t\tbreak;\n 18: \t// .... çœç•¥éƒ¨åˆ†case\n 19: \tdefault:\n 20: \t\tif(readOnly){\n 21: \t\t\tLOGGER.warn(new StringBuilder().append(\"User readonly:\").append(sql).toString());\n 22: \t\t\tc.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, \"User readonly\");\n 23: \t\t\tbreak;\n 24: \t\t}\n 25: \t\tc.execute(sql, rs & 0xff);\n 26: \t}\n 27: }\n 28: \n 29:\n 30: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘\n 31: public static int parse(String stmt) {\n 32: \tint length = stmt.length();\n 33: \t//FIX BUG FOR SQL SUCH AS /XXXX/SQL\n 34: \tint rt = -1;\n 35: \tfor (int i = 0; i < length; ++i) {\n 36: \t\tswitch (stmt.charAt(i)) {\n 37: \t\t// .... çœç•¥éƒ¨åˆ†case\t\t\tcase 'I':\n 38: \t\tcase 'i':\n 39: \t\t\trt = insertCheck(stmt, i);\n 40: \t\t\tif (rt != OTHER) {\n 41: \t\t\t\treturn rt;\n 42: \t\t\t}\n 43: \t\t\tcontinue;\n 44: \t\t\t// .... çœç•¥éƒ¨åˆ†case\n 45: \t\tcase 'S':\n 46: \t\tcase 's':\n 47: \t\t\trt = sCheck(stmt, i);\n 48: \t\t\tif (rt != OTHER) {\n 49: \t\t\t\treturn rt;\n 50: \t\t\t}\n 51: \t\t\tcontinue;\n 52: \t\t\t// .... çœç•¥éƒ¨åˆ†case\n 53: \t\tdefault:\n 54: \t\t\tcontinue;\n 55: \t\t}\n 56: \t}\n 57: \treturn OTHER;\n 58: }\n```\n\n##ã€ 6 ã€‘\n\næ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘\n  2: public class ServerConnection extends FrontendConnection {\n  3: \tpublic void execute(String sql, int type) {\n  4: \t\t// .... çœç•¥ä»£ç \n  5: \t\tSchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);\n  6: \t\tif (schema == null) {\n  7: \t\t\twriteErrMessage(ErrorCode.ERR_BAD_LOGICDB,\n  8: \t\t\t\t\t\"Unknown MyCAT Database '\" + db + \"'\");\n  9: \t\t\treturn;\n 10: \t\t}\n 11: \n 12: \t\t// .... çœç•¥ä»£ç \n 13: \n 14: \t\t// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL\n 15: \t\trouteEndExecuteSQL(sql, type, schema);\n 16: \t}\n 17: \t\n 18:     public void routeEndExecuteSQL(String sql, final int type, final SchemaConfig schema) {\n 19: \t\t// è·¯ç”±è®¡ç®—\n 20: \t\tRouteResultset rrs = null;\n 21: \t\ttry {\n 22: \t\t\trrs = MycatServer\n 23: \t\t\t\t\t.getInstance()\n 24: \t\t\t\t\t.getRouterservice()\n 25: \t\t\t\t\t.route(MycatServer.getInstance().getConfig().getSystem(),\n 26: \t\t\t\t\t\t\tschema, type, sql, this.charset, this);\n 27: \n 28: \t\t} catch (Exception e) {\n 29: \t\t\tStringBuilder s = new StringBuilder();\n 30: \t\t\tLOGGER.warn(s.append(this).append(sql).toString() + \" err:\" + e.toString(),e);\n 31: \t\t\tString msg = e.getMessage();\n 32: \t\t\twriteErrMessage(ErrorCode.ER_PARSE_ERROR, msg == null ? e.getClass().getSimpleName() : msg);\n 33: \t\t\treturn;\n 34: \t\t}\n 35: \n 36: \t\t// æ‰§è¡Œ SQL\n 37: \t\tif (rrs != null) {\n 38: \t\t\t// sessionæ‰§è¡Œ\n 39: \t\t\tsession.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);\n 40: \t\t}\n 41: \t\t\n 42:  \t}\n 43: \n 44: }\n```\n\n# 3. è·å¾—è·¯ç”±ç»“æœ\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰.png)\n\n## ã€ 1 - 2 ã€‘ã€ 12 ã€‘\n\nè·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouteService.javaã€‘\n  2: public RouteResultset route(SystemConfig sysconf, SchemaConfig schema,\n  3: \t\tint sqlType, String stmt, String charset, ServerConnection sc)\n  4: \t\tthrows SQLNonTransientException {\n  5: \tRouteResultset rrs = null;\n  6: \t// .... çœç•¥ä»£ç \n  7: \tint hintLength = RouteService.isHintSql(stmt);\n  8: \tif(hintLength != -1){ // TODO å¾…è¯»ï¼šhint\n  9: \t\t// .... çœç•¥ä»£ç \n 10: \t\t}\n 11: \t} else {\n 12: \t\tstmt = stmt.trim();\n 13: \t\trrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,\n 14: \t\t\t\tcharset, sc, tableId2DataNodeCache);\n 15: \t}\n 16: \n 17: \t// .... çœç•¥ä»£ç \t\treturn rrs;\n 18: }\n 19: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘\n 20: @Override\n 21: public RouteResultset route(SystemConfig sysConfig, SchemaConfig schema, int sqlType, String origSQL,\n 22: \t\tString charset, ServerConnection sc, LayerCachePool cachePool) throws SQLNonTransientException {\n 23: \n 24: \t// .... çœç•¥ä»£ç \n 25: \n 26: \t// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥\n 27: \tif (beforeRouteProcess(schema, sqlType, origSQL, sc) ) {\n 28: \t\treturn null;\n 29: \t}\n 30: \n 31: \t// .... çœç•¥ä»£ç \n 32: \n 33: \t// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡\n 34: \tif (schema.isNoSharding() && ServerParse.SHOW != sqlType) {\n 35: \t\trrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);\n 36: \t} else {\n 37: \t\tRouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);\n 38: \t\tif (returnedSet == null) {\n 39: \t\t\trrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);\n 40: \t\t}\n 41: \t}\n 42: \n 43: \treturn rrs;\n 44: }\n```\n\n_**è·¯ç”±** è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚_\n\n## ã€ 3 - 6 ã€‘\n\nè·¯ç”±**å‰ç½®**å¤„ç†ã€‚å½“ç¬¦åˆå¦‚ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè¿›è¡Œå¤„ç†ï¼š  \n\n{ 1 } ä½¿ç”¨**å…¨å±€åºåˆ—å·**ï¼š\n\n```SQL\ninsert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')\n```\n \n{ 2 } ER å­è¡¨æ’å…¥  \n{ 3 } ä¸»é”®ä½¿ç”¨è‡ªå¢ ID æ’å…¥ï¼š\n\n```SQL\ninsert into table (name) values ('name')\n===>\ninsert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')\n```  \n\næƒ…å†µ { 1 } { 3 } æƒ…å†µç±»ä¼¼ï¼Œä½¿ç”¨å…¨å±€åºåˆ—å·ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘\n  2: private boolean beforeRouteProcess(SchemaConfig schema, int sqlType, String origSQL, ServerConnection sc)\n  3: \t\tthrows SQLNonTransientException {\n  4: \treturn  // å¤„ç† id ä½¿ç”¨ å…¨å±€åºåˆ—å·\n  5:             RouterUtil.processWithMycatSeq(schema, sqlType, origSQL, sc)\n  6:             // å¤„ç† ER å­è¡¨\n  7: \t\t\t|| (sqlType == ServerParse.INSERT && RouterUtil.processERChildTable(schema, origSQL, sc))\n  8:             // å¤„ç† id è‡ªå¢é•¿\n  9: \t\t\t|| (sqlType == ServerParse.INSERT && RouterUtil.processInsert(schema, sqlType, origSQL, sc));\n 10: }\n```\n\n`RouterUtil.java` å¤„ç† SQL è€ƒè™‘æ€§èƒ½ï¼Œå®ç°ä¼šæ¯”è¾ƒ C-styleï¼Œä»£ç å’±å°±ä¸è´´äº†ï¼Œä¼ é€é—¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚ ï¼ˆğŸ˜ˆè¯¥ä»“åº“ä»å®˜æ–¹ Forkï¼Œé€æ­¥å®Œå–„ä¸­æ–‡æ³¨é‡Šï¼Œæ¬¢è¿ Starï¼‰\n\n## ã€ 7 - 11 ã€‘\n\nå½“**å‰ç½®**è·¯ç”±å¤„ç†**å…¨å±€åºåˆ—å·**æ—¶ï¼Œæ·»åŠ åˆ°å…¨å±€åºåˆ—å¤„ç†å™¨ï¼ˆ`MyCATSequnceProcessor`ï¼‰ã€‚è¯¥å¤„ç†å™¨ä¼šå¼‚æ­¥ç”Ÿæˆ IDï¼Œæ›¿æ¢ SQL å†…çš„ `NEXT VALUE FOR MYCATSEQ_` æ­£åˆ™ã€‚ä¾‹å¦‚ï¼š\n\n```SQL\ninsert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')\n===>\ninsert into table (id, name) values (868348974560579584, 'name')\n```\n\nå¼‚æ­¥å¤„ç†å®Œåï¼Œè°ƒç”¨ `ServerConnection#routeEndExecuteSQL(sql, type, schema)` æ–¹æ³•é‡æ–°æ‰§è¡Œ SQLã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouterUtil.javaã€‘\n  2: public static void processSQL(ServerConnection sc,SchemaConfig schema,String sql,int sqlType){\n  3: \tSessionSQLPair sessionSQLPair = new SessionSQLPair(sc.getSession2(), schema, sql, sqlType);\n  4: \tMycatServer.getInstance().getSequnceProcessor().addNewSql(sessionSQLPair);\n  5: }\n  6: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MyCATSequnceProcessor.javaã€‘\n  7: public class MyCATSequnceProcessor {\n  8: \tprivate LinkedBlockingQueue<SessionSQLPair> seqSQLQueue = new LinkedBlockingQueue<SessionSQLPair>();\n  9: \tprivate volatile boolean running=true;\n 10: \t\n 11: \tpublic void addNewSql(SessionSQLPair pair) {\n 12: \t\tseqSQLQueue.add(pair);\n 13: \t}\n 14: \n 15: \tprivate void executeSeq(SessionSQLPair pair) {\n 16: \t\ttry {\n 17: \t\t\t\n 18: \t\t\t// ä½¿ç”¨Druidè§£æå™¨å®ç°sequenceå¤„ç†  @å…µä¸´åŸä¸‹\n 19: \t\t\tDruidSequenceHandler sequenceHandler = new DruidSequenceHandler(MycatServer\n 20: \t\t\t\t\t.getInstance().getConfig().getSystem().getSequnceHandlerType());\n 21: \n 22: \t\t\t// ç”Ÿæˆå¯æ‰§è¡Œ SQL ï¼šç›®å‰ä¸»è¦æ˜¯ç”Ÿæˆ id\n 23: \t\t\tString charset = pair.session.getSource().getCharset();\n 24: \t\t\tString executeSql = sequenceHandler.getExecuteSql(pair.sql,charset == null ? \"utf-8\":charset);\n 25: \n 26: \t\t\t// æ‰§è¡Œ SQL\n 27: \t\t\tpair.session.getSource().routeEndExecuteSQL(executeSql, pair.type,pair.schema);\n 28: \t\t} catch (Exception e) {\n 29: \t\t\tLOGGER.error(\"MyCATSequenceProcessor.executeSeq(SesionSQLPair)\",e);\n 30: \t\t\tpair.session.getSource().writeErrMessage(ErrorCode.ER_YES,\"mycat sequnce err.\" + e);\n 31: \t\t\treturn;\n 32: \t\t}\n 33: \t}\n 34: \t\n 35: \tclass ExecuteThread extends Thread {\n 36: \t\t\n 37: \t\tpublic ExecuteThread() {\n 38: \t\t\tsetDaemon(true); // è®¾ç½®ä¸ºåå°çº¿ç¨‹,é˜²æ­¢throw RuntimeExecptionè¿›ç¨‹ä»ç„¶å­˜åœ¨çš„é—®é¢˜\n 39: \t\t}\n 40: \t\t\n 41: \t\tpublic void run() {\n 42: \t\t\twhile (running) {\n 43: \t\t\t\ttry {\n 44: \t\t\t\t\tSessionSQLPair pair=seqSQLQueue.poll(100,TimeUnit.MILLISECONDS);\n 45: \t\t\t\t\tif(pair!=null){\n 46:                         executeSeq(pair);\n 47: \t\t\t\t\t}\n 48: \t\t\t\t} catch (Exception e) {\n 49: \t\t\t\t\tLOGGER.warn(\"MyCATSequenceProcessor$ExecutorThread\",e);\n 50: \t\t\t\t}\n 51: \t\t\t}\n 52: \t\t}\n 53: \t}\n 54: }\n```\n\nâ“æ­¤å¤„æœ‰ä¸ªç–‘é—®ï¼š`MyCATSequnceProcessor` æ˜¯å•çº¿ç¨‹ï¼Œä¼šä¸ä¼šæ’å…¥æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Ÿåç»­å’±åšä¸‹æ€§èƒ½æµ‹è¯•ã€‚\n\n# 4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ%20SQLï¼‰.png)\n\n## ã€ 1 - 8 ã€‘\n\nè·å¾— MySQL è¿æ¥ã€‚\n\n* PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚\n* PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚\n\n## ã€ 9 - 13 ã€‘\n\nå‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚\n\n# 5. å“åº”æ‰§è¡Œ SQL ç»“æœ\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰.png)\n\n## ã€ 1 - 4 ã€‘\n\nå¤„ç† MySQL Server å“åº”æ•°æ®åŒ…ã€‚\n\n## ã€ 5 - 8 ã€‘\n\nå‘é€æ’å…¥æˆåŠŸç»“æœç»™ MySQL Clientã€‚\n\n\n","slug":"Mycat/single-db-single-table-insert","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswyz000dak5dznt95eyt","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md\" target=\"_blank\" rel=\"external\">MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥</a><br><code>MyCat-Server</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/Mycat-Server\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Mycat-Server</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blog\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blog</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</a></li>\n<li><a href=\"#\">3. è·å¾—è·¯ç”±ç»“æœ</a></li>\n<li><a href=\"#\">4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</a></li>\n<li><a href=\"#\">5. å“åº”æ‰§è¡Œ SQL ç»“æœ</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><blockquote>\n<p>å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚<br>å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚<br>å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚<br>å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚</p>\n</blockquote>\n<p>æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æ’å…¥ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚äº¤äº’å¦‚ä¸‹å›¾ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/å•åº“å•è¡¨æ’å…¥ç®€å›¾.png\" alt=\"å•åº“å•è¡¨æ’å…¥ç®€å›¾\"></p>\n<p>æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚</li>\n<li>è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚</li>\n<li>è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚</li>\n<li>å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚</li>\n</ol>\n<p>æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚</p>\n<h1 id=\"2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL\"><a href=\"#2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL\" class=\"headerlink\" title=\"2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL\"></a>2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰\"></p>\n<h2 id=\"ã€-1-2-ã€‘\"><a href=\"#ã€-1-2-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 2 ã€‘\"></a>ã€ 1 - 2 ã€‘</h2><p>æ¥æ”¶<strong>ä¸€æ¡</strong> MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚</p>\n<h2 id=\"ã€-3-ã€‘\"><a href=\"#ã€-3-ã€‘\" class=\"headerlink\" title=\"ã€ 3 ã€‘\"></a>ã€ 3 ã€‘</h2><p>ä¸åŒ MySQL å‘½ä»¤ï¼Œåˆ†å‘åˆ°ä¸åŒçš„æ–¹æ³•æ‰§è¡Œã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FrontendCommandHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">NIOHandler</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handle</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:     </div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) <span class=\"comment\">// </span></div><div class=\"line\"> <span class=\"number\">9</span>:         &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_INIT_DB:</div><div class=\"line\"><span class=\"number\">11</span>:                 commands.doInitDB();</div><div class=\"line\"><span class=\"number\">12</span>:                 source.initDB(data);</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_QUERY: <span class=\"comment\">// æŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"comment\">// è®¡æ•°æŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">16</span>:                 commands.doQuery();</div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">18</span>:                 source.query(data);</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_PING:</div><div class=\"line\"><span class=\"number\">21</span>:                 commands.doPing();</div><div class=\"line\"><span class=\"number\">22</span>:                 source.ping();</div><div class=\"line\"><span class=\"number\">23</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>: &#125;</div></pre></td></tr></table></figure>\n<p><code>INSERT</code>/<code>SELECT</code>/<code>UPDATE</code>/<code>DELETE</code> ç­‰ SQL å½’å±äº <code>MySQLPacket.COM_QUERY</code>ï¼Œè¯¦ç»†å¯è§ï¼š<a href=\"http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-\" target=\"_blank\" rel=\"external\">ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨ï¼‰ã€‹</a>ã€‚</p>\n<p>##ã€ 4 ã€‘</p>\n<p>å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">query</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"comment\">// å–å¾—è¯­å¥</span></div><div class=\"line\"> <span class=\"number\">4</span>: \tString sql = <span class=\"keyword\">null</span>;\t\t</div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">6</span>: \t\tMySQLMessage mm = <span class=\"keyword\">new</span> MySQLMessage(data);</div><div class=\"line\"> <span class=\"number\">7</span>: \t\tmm.position(<span class=\"number\">5</span>);</div><div class=\"line\"> <span class=\"number\">8</span>: \t\tsql = mm.readString(charset);</div><div class=\"line\"> <span class=\"number\">9</span>: \t&#125; <span class=\"keyword\">catch</span> (UnsupportedEncodingException e) &#123;</div><div class=\"line\"><span class=\"number\">10</span>: \t\twriteErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, <span class=\"string\">\"Unknown charset '\"</span> + charset + <span class=\"string\">\"'\"</span>);</div><div class=\"line\"><span class=\"number\">11</span>: \t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">12</span>: \t&#125;\t\t</div><div class=\"line\"><span class=\"number\">13</span>: \t<span class=\"comment\">// æ‰§è¡Œè¯­å¥</span></div><div class=\"line\"><span class=\"number\">14</span>: \t<span class=\"keyword\">this</span>.query( sql );</div><div class=\"line\"><span class=\"number\">15</span>: &#125;</div></pre></td></tr></table></figure>\n<p>##ã€ 5 ã€‘</p>\n<p>è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">query</span><span class=\"params\">(String sql)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t<span class=\"comment\">// è§£æ SQL ç±»å‹</span></div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">int</span> rs = ServerParse.parse(sql);</div><div class=\"line\"> <span class=\"number\">6</span>: \t<span class=\"keyword\">int</span> sqlType = rs &amp; <span class=\"number\">0xff</span>;</div><div class=\"line\"> <span class=\"number\">7</span>: \t</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">switch</span> (sqlType) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>: \t<span class=\"comment\">//explain sql</span></div><div class=\"line\"><span class=\"number\">10</span>: \t<span class=\"keyword\">case</span> ServerParse.EXPLAIN:</div><div class=\"line\"><span class=\"number\">11</span>: \t\tExplainHandler.handle(sql, c, rs &gt;&gt;&gt; <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">12</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">13</span>: \t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">14</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">15</span>: \t<span class=\"keyword\">case</span> ServerParse.SELECT:</div><div class=\"line\"><span class=\"number\">16</span>: \t\tSelectHandler.handle(sql, c, rs &gt;&gt;&gt; <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">17</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">18</span>: \t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">19</span>: \t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">20</span>: \t\t<span class=\"keyword\">if</span>(readOnly)&#123;</div><div class=\"line\"><span class=\"number\">21</span>: \t\t\tLOGGER.warn(<span class=\"keyword\">new</span> StringBuilder().append(<span class=\"string\">\"User readonly:\"</span>).append(sql).toString());</div><div class=\"line\"><span class=\"number\">22</span>: \t\t\tc.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, <span class=\"string\">\"User readonly\"</span>);</div><div class=\"line\"><span class=\"number\">23</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">25</span>: \t\tc.execute(sql, rs &amp; <span class=\"number\">0xff</span>);</div><div class=\"line\"><span class=\"number\">26</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">27</span>: &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:</div><div class=\"line\"><span class=\"number\">30</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘</span></div><div class=\"line\"><span class=\"number\">31</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">parse</span><span class=\"params\">(String stmt)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">32</span>: \t<span class=\"keyword\">int</span> length = stmt.length();</div><div class=\"line\"><span class=\"number\">33</span>: \t<span class=\"comment\">//FIX BUG FOR SQL SUCH AS /XXXX/SQL</span></div><div class=\"line\"><span class=\"number\">34</span>: \t<span class=\"keyword\">int</span> rt = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">35</span>: \t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; length; ++i) &#123;</div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"keyword\">switch</span> (stmt.charAt(i)) &#123;</div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case\t\t\tcase 'I':</span></div><div class=\"line\"><span class=\"number\">38</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'i'</span>:</div><div class=\"line\"><span class=\"number\">39</span>: \t\t\trt = insertCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t\t<span class=\"keyword\">if</span> (rt != OTHER) &#123;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t\t\t<span class=\"keyword\">return</span> rt;</div><div class=\"line\"><span class=\"number\">42</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">45</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'S'</span>:</div><div class=\"line\"><span class=\"number\">46</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'s'</span>:</div><div class=\"line\"><span class=\"number\">47</span>: \t\t\trt = sCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">48</span>: \t\t\t<span class=\"keyword\">if</span> (rt != OTHER) &#123;</div><div class=\"line\"><span class=\"number\">49</span>: \t\t\t\t<span class=\"keyword\">return</span> rt;</div><div class=\"line\"><span class=\"number\">50</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">51</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">52</span>: \t\t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">53</span>: \t\t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">54</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">55</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">56</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">57</span>: \t<span class=\"keyword\">return</span> OTHER;</div><div class=\"line\"><span class=\"number\">58</span>: &#125;</div></pre></td></tr></table></figure>\n<p>##ã€ 6 ã€‘</p>\n<p>æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ServerConnection</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrontendConnection</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(String sql, <span class=\"keyword\">int</span> type)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">5</span>: \t\tSchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);</div><div class=\"line\"> <span class=\"number\">6</span>: \t\t<span class=\"keyword\">if</span> (schema == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>: \t\t\twriteErrMessage(ErrorCode.ERR_BAD_LOGICDB,</div><div class=\"line\"> <span class=\"number\">8</span>: \t\t\t\t\t<span class=\"string\">\"Unknown MyCAT Database '\"</span> + db + <span class=\"string\">\"'\"</span>);</div><div class=\"line\"> <span class=\"number\">9</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">10</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>: \t\t<span class=\"comment\">// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">15</span>: \t\trouteEndExecuteSQL(sql, type, schema);</div><div class=\"line\"><span class=\"number\">16</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">17</span>: \t</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">routeEndExecuteSQL</span><span class=\"params\">(String sql, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> type, <span class=\"keyword\">final</span> SchemaConfig schema)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">19</span>: \t\t<span class=\"comment\">// è·¯ç”±è®¡ç®—</span></div><div class=\"line\"><span class=\"number\">20</span>: \t\tRouteResultset rrs = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">21</span>: \t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>: \t\t\trrs = MycatServer</div><div class=\"line\"><span class=\"number\">23</span>: \t\t\t\t\t.getInstance()</div><div class=\"line\"><span class=\"number\">24</span>: \t\t\t\t\t.getRouterservice()</div><div class=\"line\"><span class=\"number\">25</span>: \t\t\t\t\t.route(MycatServer.getInstance().getConfig().getSystem(),</div><div class=\"line\"><span class=\"number\">26</span>: \t\t\t\t\t\t\tschema, type, sql, <span class=\"keyword\">this</span>.charset, <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>: \t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">29</span>: \t\t\tStringBuilder s = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\"><span class=\"number\">30</span>: \t\t\tLOGGER.warn(s.append(<span class=\"keyword\">this</span>).append(sql).toString() + <span class=\"string\">\" err:\"</span> + e.toString(),e);</div><div class=\"line\"><span class=\"number\">31</span>: \t\t\tString msg = e.getMessage();</div><div class=\"line\"><span class=\"number\">32</span>: \t\t\twriteErrMessage(ErrorCode.ER_PARSE_ERROR, msg == <span class=\"keyword\">null</span> ? e.getClass().getSimpleName() : msg);</div><div class=\"line\"><span class=\"number\">33</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">34</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"comment\">// æ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"keyword\">if</span> (rrs != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">38</span>: \t\t\t<span class=\"comment\">// sessionæ‰§è¡Œ</span></div><div class=\"line\"><span class=\"number\">39</span>: \t\t\tsession.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t</div><div class=\"line\"><span class=\"number\">42</span>:  \t&#125;</div><div class=\"line\"><span class=\"number\">43</span>: </div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-è·å¾—è·¯ç”±ç»“æœ\"><a href=\"#3-è·å¾—è·¯ç”±ç»“æœ\" class=\"headerlink\" title=\"3. è·å¾—è·¯ç”±ç»“æœ\"></a>3. è·å¾—è·¯ç”±ç»“æœ</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰\"></p>\n<h2 id=\"ã€-1-2-ã€‘ã€-12-ã€‘\"><a href=\"#ã€-1-2-ã€‘ã€-12-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 2 ã€‘ã€ 12 ã€‘\"></a>ã€ 1 - 2 ã€‘ã€ 12 ã€‘</h2><p>è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouteService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RouteResultset <span class=\"title\">route</span><span class=\"params\">(SystemConfig sysconf, SchemaConfig schema,</span></span></div><div class=\"line\"> <span class=\"number\">3</span>: \t\t<span class=\"keyword\">int</span> sqlType, String stmt, String charset, ServerConnection sc)</div><div class=\"line\"> 4: \t\t<span class=\"keyword\">throws</span> SQLNonTransientException &#123;</div><div class=\"line\"> <span class=\"number\">5</span>: \tRouteResultset rrs = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">6</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">7</span>: \t<span class=\"keyword\">int</span> hintLength = RouteService.isHintSql(stmt);</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">if</span>(hintLength != -<span class=\"number\">1</span>)&#123; <span class=\"comment\">// TODO å¾…è¯»ï¼šhint</span></div><div class=\"line\"> <span class=\"number\">9</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">10</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">11</span>: \t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">12</span>: \t\tstmt = stmt.trim();</div><div class=\"line\"><span class=\"number\">13</span>: \t\trrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,</div><div class=\"line\"><span class=\"number\">14</span>: \t\t\t\tcharset, sc, tableId2DataNodeCache);</div><div class=\"line\"><span class=\"number\">15</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç \t\treturn rrs;</span></div><div class=\"line\"><span class=\"number\">18</span>: &#125;</div><div class=\"line\"><span class=\"number\">19</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</span></div><div class=\"line\"><span class=\"number\">20</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">21</span>: <span class=\"function\"><span class=\"keyword\">public</span> RouteResultset <span class=\"title\">route</span><span class=\"params\">(SystemConfig sysConfig, SchemaConfig schema, <span class=\"keyword\">int</span> sqlType, String origSQL,</span></span></div><div class=\"line\"><span class=\"number\">22</span>: \t\tString charset, ServerConnection sc, LayerCachePool cachePool) <span class=\"keyword\">throws</span> SQLNonTransientException &#123;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>: \t<span class=\"comment\">// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥</span></div><div class=\"line\"><span class=\"number\">27</span>: \t<span class=\"keyword\">if</span> (beforeRouteProcess(schema, sqlType, origSQL, sc) ) &#123;</div><div class=\"line\"><span class=\"number\">28</span>: \t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">29</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>: \t<span class=\"comment\">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡</span></div><div class=\"line\"><span class=\"number\">34</span>: \t<span class=\"keyword\">if</span> (schema.isNoSharding() &amp;&amp; ServerParse.SHOW != sqlType) &#123;</div><div class=\"line\"><span class=\"number\">35</span>: \t\trrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);</div><div class=\"line\"><span class=\"number\">36</span>: \t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">37</span>: \t\tRouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);</div><div class=\"line\"><span class=\"number\">38</span>: \t\t<span class=\"keyword\">if</span> (returnedSet == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">39</span>: \t\t\trrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">41</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">42</span>: </div><div class=\"line\"><span class=\"number\">43</span>: \t<span class=\"keyword\">return</span> rrs;</div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<p><em><strong>è·¯ç”±</strong> è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>\n<h2 id=\"ã€-3-6-ã€‘\"><a href=\"#ã€-3-6-ã€‘\" class=\"headerlink\" title=\"ã€ 3 - 6 ã€‘\"></a>ã€ 3 - 6 ã€‘</h2><p>è·¯ç”±<strong>å‰ç½®</strong>å¤„ç†ã€‚å½“ç¬¦åˆå¦‚ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè¿›è¡Œå¤„ç†ï¼š  </p>\n<p>{ 1 } ä½¿ç”¨<strong>å…¨å±€åºåˆ—å·</strong>ï¼š</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> <span class=\"keyword\">table</span> (<span class=\"keyword\">id</span>, <span class=\"keyword\">name</span>) <span class=\"keyword\">values</span> (<span class=\"keyword\">NEXT</span> <span class=\"keyword\">VALUE</span> <span class=\"keyword\">FOR</span> MYCATSEQ_ID, <span class=\"string\">'name'</span>)</div></pre></td></tr></table></figure>\n<p>{ 2 } ER å­è¡¨æ’å…¥<br>{ 3 } ä¸»é”®ä½¿ç”¨è‡ªå¢ ID æ’å…¥ï¼š</p>\n<figure class=\"highlight\"><table><tr><td class=\"code\"><pre><div class=\"line\">insert into table (name) values ('name')</div><div class=\"line\">===&gt;</div><div class=\"line\">insert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')</div><div class=\"line\">```  </div><div class=\"line\"></div><div class=\"line\">æƒ…å†µ &#123; 1 &#125; &#123; 3 &#125; æƒ…å†µç±»ä¼¼ï¼Œä½¿ç”¨å…¨å±€åºåˆ—å·ã€‚</div><div class=\"line\"></div><div class=\"line\">æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</div><div class=\"line\"></div><div class=\"line\">```Java</div><div class=\"line\">  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</div><div class=\"line\">  2: private boolean beforeRouteProcess(SchemaConfig schema, int sqlType, String origSQL, ServerConnection sc)</div><div class=\"line\">  3: \t\tthrows SQLNonTransientException &#123;</div><div class=\"line\">  4: \treturn  // å¤„ç† id ä½¿ç”¨ å…¨å±€åºåˆ—å·</div><div class=\"line\">  5:             RouterUtil.processWithMycatSeq(schema, sqlType, origSQL, sc)</div><div class=\"line\">  6:             // å¤„ç† ER å­è¡¨</div><div class=\"line\">  7: \t\t\t|| (sqlType == ServerParse.INSERT &amp;&amp; RouterUtil.processERChildTable(schema, origSQL, sc))</div><div class=\"line\">  8:             // å¤„ç† id è‡ªå¢é•¿</div><div class=\"line\">  9: \t\t\t|| (sqlType == ServerParse.INSERT &amp;&amp; RouterUtil.processInsert(schema, sqlType, origSQL, sc));</div><div class=\"line\"> 10: &#125;</div></pre></td></tr></table></figure>\n<p><code>RouterUtil.java</code> å¤„ç† SQL è€ƒè™‘æ€§èƒ½ï¼Œå®ç°ä¼šæ¯”è¾ƒ C-styleï¼Œä»£ç å’±å°±ä¸è´´äº†ï¼Œä¼ é€é—¨ï¼š<a href=\"https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚</a> ï¼ˆğŸ˜ˆè¯¥ä»“åº“ä»å®˜æ–¹ Forkï¼Œé€æ­¥å®Œå–„ä¸­æ–‡æ³¨é‡Šï¼Œæ¬¢è¿ Starï¼‰</p>\n<h2 id=\"ã€-7-11-ã€‘\"><a href=\"#ã€-7-11-ã€‘\" class=\"headerlink\" title=\"ã€ 7 - 11 ã€‘\"></a>ã€ 7 - 11 ã€‘</h2><p>å½“<strong>å‰ç½®</strong>è·¯ç”±å¤„ç†<strong>å…¨å±€åºåˆ—å·</strong>æ—¶ï¼Œæ·»åŠ åˆ°å…¨å±€åºåˆ—å¤„ç†å™¨ï¼ˆ<code>MyCATSequnceProcessor</code>ï¼‰ã€‚è¯¥å¤„ç†å™¨ä¼šå¼‚æ­¥ç”Ÿæˆ IDï¼Œæ›¿æ¢ SQL å†…çš„ <code>NEXT VALUE FOR MYCATSEQ_</code> æ­£åˆ™ã€‚ä¾‹å¦‚ï¼š</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> <span class=\"keyword\">table</span> (<span class=\"keyword\">id</span>, <span class=\"keyword\">name</span>) <span class=\"keyword\">values</span> (<span class=\"keyword\">NEXT</span> <span class=\"keyword\">VALUE</span> <span class=\"keyword\">FOR</span> MYCATSEQ_ID, <span class=\"string\">'name'</span>)</div><div class=\"line\">===&gt;</div><div class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> <span class=\"keyword\">table</span> (<span class=\"keyword\">id</span>, <span class=\"keyword\">name</span>) <span class=\"keyword\">values</span> (<span class=\"number\">868348974560579584</span>, <span class=\"string\">'name'</span>)</div></pre></td></tr></table></figure>\n<p>å¼‚æ­¥å¤„ç†å®Œåï¼Œè°ƒç”¨ <code>ServerConnection#routeEndExecuteSQL(sql, type, schema)</code> æ–¹æ³•é‡æ–°æ‰§è¡Œ SQLã€‚</p>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouterUtil.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">processSQL</span><span class=\"params\">(ServerConnection sc,SchemaConfig schema,String sql,<span class=\"keyword\">int</span> sqlType)</span></span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \tSessionSQLPair sessionSQLPair = <span class=\"keyword\">new</span> SessionSQLPair(sc.getSession2(), schema, sql, sqlType);</div><div class=\"line\"> <span class=\"number\">4</span>: \tMycatServer.getInstance().getSequnceProcessor().addNewSql(sessionSQLPair);</div><div class=\"line\"> <span class=\"number\">5</span>: &#125;</div><div class=\"line\"> <span class=\"number\">6</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MyCATSequnceProcessor.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyCATSequnceProcessor</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">private</span> LinkedBlockingQueue&lt;SessionSQLPair&gt; seqSQLQueue = <span class=\"keyword\">new</span> LinkedBlockingQueue&lt;SessionSQLPair&gt;();</div><div class=\"line\"> <span class=\"number\">9</span>: \t<span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">boolean</span> running=<span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">10</span>: \t</div><div class=\"line\"><span class=\"number\">11</span>: \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addNewSql</span><span class=\"params\">(SessionSQLPair pair)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">12</span>: \t\tseqSQLQueue.add(pair);</div><div class=\"line\"><span class=\"number\">13</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>: \t<span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">executeSeq</span><span class=\"params\">(SessionSQLPair pair)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>: \t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">17</span>: \t\t\t</div><div class=\"line\"><span class=\"number\">18</span>: \t\t\t<span class=\"comment\">// ä½¿ç”¨Druidè§£æå™¨å®ç°sequenceå¤„ç†  @å…µä¸´åŸä¸‹</span></div><div class=\"line\"><span class=\"number\">19</span>: \t\t\tDruidSequenceHandler sequenceHandler = <span class=\"keyword\">new</span> DruidSequenceHandler(MycatServer</div><div class=\"line\"><span class=\"number\">20</span>: \t\t\t\t\t.getInstance().getConfig().getSystem().getSequnceHandlerType());</div><div class=\"line\"><span class=\"number\">21</span>: </div><div class=\"line\"><span class=\"number\">22</span>: \t\t\t<span class=\"comment\">// ç”Ÿæˆå¯æ‰§è¡Œ SQL ï¼šç›®å‰ä¸»è¦æ˜¯ç”Ÿæˆ id</span></div><div class=\"line\"><span class=\"number\">23</span>: \t\t\tString charset = pair.session.getSource().getCharset();</div><div class=\"line\"><span class=\"number\">24</span>: \t\t\tString executeSql = sequenceHandler.getExecuteSql(pair.sql,charset == <span class=\"keyword\">null</span> ? <span class=\"string\">\"utf-8\"</span>:charset);</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>: \t\t\t<span class=\"comment\">// æ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">27</span>: \t\t\tpair.session.getSource().routeEndExecuteSQL(executeSql, pair.type,pair.schema);</div><div class=\"line\"><span class=\"number\">28</span>: \t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">29</span>: \t\t\tLOGGER.error(<span class=\"string\">\"MyCATSequenceProcessor.executeSeq(SesionSQLPair)\"</span>,e);</div><div class=\"line\"><span class=\"number\">30</span>: \t\t\tpair.session.getSource().writeErrMessage(ErrorCode.ER_YES,<span class=\"string\">\"mycat sequnce err.\"</span> + e);</div><div class=\"line\"><span class=\"number\">31</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">32</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">33</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">34</span>: \t</div><div class=\"line\"><span class=\"number\">35</span>: \t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExecuteThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">Thread</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">36</span>: \t\t</div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ExecuteThread</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">38</span>: \t\t\tsetDaemon(<span class=\"keyword\">true</span>); <span class=\"comment\">// è®¾ç½®ä¸ºåå°çº¿ç¨‹,é˜²æ­¢throw RuntimeExecptionè¿›ç¨‹ä»ç„¶å­˜åœ¨çš„é—®é¢˜</span></div><div class=\"line\"><span class=\"number\">39</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">40</span>: \t\t</div><div class=\"line\"><span class=\"number\">41</span>: \t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">42</span>: \t\t\t<span class=\"keyword\">while</span> (running) &#123;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t\t\t\tSessionSQLPair pair=seqSQLQueue.poll(<span class=\"number\">100</span>,TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">45</span>: \t\t\t\t\t<span class=\"keyword\">if</span>(pair!=<span class=\"keyword\">null</span>)&#123;</div><div class=\"line\"><span class=\"number\">46</span>:                         executeSeq(pair);</div><div class=\"line\"><span class=\"number\">47</span>: \t\t\t\t\t&#125;</div><div class=\"line\"><span class=\"number\">48</span>: \t\t\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">49</span>: \t\t\t\t\tLOGGER.warn(<span class=\"string\">\"MyCATSequenceProcessor$ExecutorThread\"</span>,e);</div><div class=\"line\"><span class=\"number\">50</span>: \t\t\t\t&#125;</div><div class=\"line\"><span class=\"number\">51</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">52</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">53</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">54</span>: &#125;</div></pre></td></tr></table></figure>\n<p>â“æ­¤å¤„æœ‰ä¸ªç–‘é—®ï¼š<code>MyCATSequnceProcessor</code> æ˜¯å•çº¿ç¨‹ï¼Œä¼šä¸ä¼šæ’å…¥æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Ÿåç»­å’±åšä¸‹æ€§èƒ½æµ‹è¯•ã€‚</p>\n<h1 id=\"4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL\"><a href=\"#4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL\" class=\"headerlink\" title=\"4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL\"></a>4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ%20SQLï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰\"></p>\n<h2 id=\"ã€-1-8-ã€‘\"><a href=\"#ã€-1-8-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 8 ã€‘\"></a>ã€ 1 - 8 ã€‘</h2><p>è·å¾— MySQL è¿æ¥ã€‚</p>\n<ul>\n<li>PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚</li>\n<li>PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚</li>\n</ul>\n<h2 id=\"ã€-9-13-ã€‘\"><a href=\"#ã€-9-13-ã€‘\" class=\"headerlink\" title=\"ã€ 9 - 13 ã€‘\"></a>ã€ 9 - 13 ã€‘</h2><p>å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚</p>\n<h1 id=\"5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ\"><a href=\"#5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ\" class=\"headerlink\" title=\"5. å“åº”æ‰§è¡Œ SQL ç»“æœ\"></a>5. å“åº”æ‰§è¡Œ SQL ç»“æœ</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰\"></p>\n<h2 id=\"ã€-1-4-ã€‘\"><a href=\"#ã€-1-4-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 4 ã€‘\"></a>ã€ 1 - 4 ã€‘</h2><p>å¤„ç† MySQL Server å“åº”æ•°æ®åŒ…ã€‚</p>\n<h2 id=\"ã€-5-8-ã€‘\"><a href=\"#ã€-5-8-ã€‘\" class=\"headerlink\" title=\"ã€ 5 - 8 ã€‘\"></a>ã€ 5 - 8 ã€‘</h2><p>å‘é€æ’å…¥æˆåŠŸç»“æœç»™ MySQL Clientã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md\" target=\"_blank\" rel=\"external\">MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥</a><br><code>MyCat-Server</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/Mycat-Server\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Mycat-Server</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blog\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blog</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</a></li>\n<li><a href=\"#\">3. è·å¾—è·¯ç”±ç»“æœ</a></li>\n<li><a href=\"#\">4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</a></li>\n<li><a href=\"#\">5. å“åº”æ‰§è¡Œ SQL ç»“æœ</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><blockquote>\n<p>å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚<br>å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚<br>å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚<br>å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚</p>\n</blockquote>\n<p>æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æ’å…¥ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚äº¤äº’å¦‚ä¸‹å›¾ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/å•åº“å•è¡¨æ’å…¥ç®€å›¾.png\" alt=\"å•åº“å•è¡¨æ’å…¥ç®€å›¾\"></p>\n<p>æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚</li>\n<li>è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚</li>\n<li>è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚</li>\n<li>å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚</li>\n</ol>\n<p>æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚</p>\n<h1 id=\"2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL\"><a href=\"#2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL\" class=\"headerlink\" title=\"2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL\"></a>2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰\"></p>\n<h2 id=\"ã€-1-2-ã€‘\"><a href=\"#ã€-1-2-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 2 ã€‘\"></a>ã€ 1 - 2 ã€‘</h2><p>æ¥æ”¶<strong>ä¸€æ¡</strong> MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚</p>\n<h2 id=\"ã€-3-ã€‘\"><a href=\"#ã€-3-ã€‘\" class=\"headerlink\" title=\"ã€ 3 ã€‘\"></a>ã€ 3 ã€‘</h2><p>ä¸åŒ MySQL å‘½ä»¤ï¼Œåˆ†å‘åˆ°ä¸åŒçš„æ–¹æ³•æ‰§è¡Œã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FrontendCommandHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">NIOHandler</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handle</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:     </div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) <span class=\"comment\">// </span></div><div class=\"line\"> <span class=\"number\">9</span>:         &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_INIT_DB:</div><div class=\"line\"><span class=\"number\">11</span>:                 commands.doInitDB();</div><div class=\"line\"><span class=\"number\">12</span>:                 source.initDB(data);</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_QUERY: <span class=\"comment\">// æŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"comment\">// è®¡æ•°æŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">16</span>:                 commands.doQuery();</div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">18</span>:                 source.query(data);</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_PING:</div><div class=\"line\"><span class=\"number\">21</span>:                 commands.doPing();</div><div class=\"line\"><span class=\"number\">22</span>:                 source.ping();</div><div class=\"line\"><span class=\"number\">23</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>: &#125;</div></pre></td></tr></table></figure>\n<p><code>INSERT</code>/<code>SELECT</code>/<code>UPDATE</code>/<code>DELETE</code> ç­‰ SQL å½’å±äº <code>MySQLPacket.COM_QUERY</code>ï¼Œè¯¦ç»†å¯è§ï¼š<a href=\"http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-\" target=\"_blank\" rel=\"external\">ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨ï¼‰ã€‹</a>ã€‚</p>\n<p>##ã€ 4 ã€‘</p>\n<p>å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">query</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"comment\">// å–å¾—è¯­å¥</span></div><div class=\"line\"> <span class=\"number\">4</span>: \tString sql = <span class=\"keyword\">null</span>;\t\t</div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">6</span>: \t\tMySQLMessage mm = <span class=\"keyword\">new</span> MySQLMessage(data);</div><div class=\"line\"> <span class=\"number\">7</span>: \t\tmm.position(<span class=\"number\">5</span>);</div><div class=\"line\"> <span class=\"number\">8</span>: \t\tsql = mm.readString(charset);</div><div class=\"line\"> <span class=\"number\">9</span>: \t&#125; <span class=\"keyword\">catch</span> (UnsupportedEncodingException e) &#123;</div><div class=\"line\"><span class=\"number\">10</span>: \t\twriteErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, <span class=\"string\">\"Unknown charset '\"</span> + charset + <span class=\"string\">\"'\"</span>);</div><div class=\"line\"><span class=\"number\">11</span>: \t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">12</span>: \t&#125;\t\t</div><div class=\"line\"><span class=\"number\">13</span>: \t<span class=\"comment\">// æ‰§è¡Œè¯­å¥</span></div><div class=\"line\"><span class=\"number\">14</span>: \t<span class=\"keyword\">this</span>.query( sql );</div><div class=\"line\"><span class=\"number\">15</span>: &#125;</div></pre></td></tr></table></figure>\n<p>##ã€ 5 ã€‘</p>\n<p>è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">query</span><span class=\"params\">(String sql)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t<span class=\"comment\">// è§£æ SQL ç±»å‹</span></div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">int</span> rs = ServerParse.parse(sql);</div><div class=\"line\"> <span class=\"number\">6</span>: \t<span class=\"keyword\">int</span> sqlType = rs &amp; <span class=\"number\">0xff</span>;</div><div class=\"line\"> <span class=\"number\">7</span>: \t</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">switch</span> (sqlType) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>: \t<span class=\"comment\">//explain sql</span></div><div class=\"line\"><span class=\"number\">10</span>: \t<span class=\"keyword\">case</span> ServerParse.EXPLAIN:</div><div class=\"line\"><span class=\"number\">11</span>: \t\tExplainHandler.handle(sql, c, rs &gt;&gt;&gt; <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">12</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">13</span>: \t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">14</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">15</span>: \t<span class=\"keyword\">case</span> ServerParse.SELECT:</div><div class=\"line\"><span class=\"number\">16</span>: \t\tSelectHandler.handle(sql, c, rs &gt;&gt;&gt; <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">17</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">18</span>: \t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">19</span>: \t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">20</span>: \t\t<span class=\"keyword\">if</span>(readOnly)&#123;</div><div class=\"line\"><span class=\"number\">21</span>: \t\t\tLOGGER.warn(<span class=\"keyword\">new</span> StringBuilder().append(<span class=\"string\">\"User readonly:\"</span>).append(sql).toString());</div><div class=\"line\"><span class=\"number\">22</span>: \t\t\tc.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, <span class=\"string\">\"User readonly\"</span>);</div><div class=\"line\"><span class=\"number\">23</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">25</span>: \t\tc.execute(sql, rs &amp; <span class=\"number\">0xff</span>);</div><div class=\"line\"><span class=\"number\">26</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">27</span>: &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:</div><div class=\"line\"><span class=\"number\">30</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘</span></div><div class=\"line\"><span class=\"number\">31</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">parse</span><span class=\"params\">(String stmt)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">32</span>: \t<span class=\"keyword\">int</span> length = stmt.length();</div><div class=\"line\"><span class=\"number\">33</span>: \t<span class=\"comment\">//FIX BUG FOR SQL SUCH AS /XXXX/SQL</span></div><div class=\"line\"><span class=\"number\">34</span>: \t<span class=\"keyword\">int</span> rt = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">35</span>: \t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; length; ++i) &#123;</div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"keyword\">switch</span> (stmt.charAt(i)) &#123;</div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case\t\t\tcase 'I':</span></div><div class=\"line\"><span class=\"number\">38</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'i'</span>:</div><div class=\"line\"><span class=\"number\">39</span>: \t\t\trt = insertCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t\t<span class=\"keyword\">if</span> (rt != OTHER) &#123;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t\t\t<span class=\"keyword\">return</span> rt;</div><div class=\"line\"><span class=\"number\">42</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">45</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'S'</span>:</div><div class=\"line\"><span class=\"number\">46</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'s'</span>:</div><div class=\"line\"><span class=\"number\">47</span>: \t\t\trt = sCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">48</span>: \t\t\t<span class=\"keyword\">if</span> (rt != OTHER) &#123;</div><div class=\"line\"><span class=\"number\">49</span>: \t\t\t\t<span class=\"keyword\">return</span> rt;</div><div class=\"line\"><span class=\"number\">50</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">51</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">52</span>: \t\t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">53</span>: \t\t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">54</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">55</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">56</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">57</span>: \t<span class=\"keyword\">return</span> OTHER;</div><div class=\"line\"><span class=\"number\">58</span>: &#125;</div></pre></td></tr></table></figure>\n<p>##ã€ 6 ã€‘</p>\n<p>æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ServerConnection</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrontendConnection</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(String sql, <span class=\"keyword\">int</span> type)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">5</span>: \t\tSchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);</div><div class=\"line\"> <span class=\"number\">6</span>: \t\t<span class=\"keyword\">if</span> (schema == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>: \t\t\twriteErrMessage(ErrorCode.ERR_BAD_LOGICDB,</div><div class=\"line\"> <span class=\"number\">8</span>: \t\t\t\t\t<span class=\"string\">\"Unknown MyCAT Database '\"</span> + db + <span class=\"string\">\"'\"</span>);</div><div class=\"line\"> <span class=\"number\">9</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">10</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>: \t\t<span class=\"comment\">// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">15</span>: \t\trouteEndExecuteSQL(sql, type, schema);</div><div class=\"line\"><span class=\"number\">16</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">17</span>: \t</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">routeEndExecuteSQL</span><span class=\"params\">(String sql, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> type, <span class=\"keyword\">final</span> SchemaConfig schema)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">19</span>: \t\t<span class=\"comment\">// è·¯ç”±è®¡ç®—</span></div><div class=\"line\"><span class=\"number\">20</span>: \t\tRouteResultset rrs = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">21</span>: \t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>: \t\t\trrs = MycatServer</div><div class=\"line\"><span class=\"number\">23</span>: \t\t\t\t\t.getInstance()</div><div class=\"line\"><span class=\"number\">24</span>: \t\t\t\t\t.getRouterservice()</div><div class=\"line\"><span class=\"number\">25</span>: \t\t\t\t\t.route(MycatServer.getInstance().getConfig().getSystem(),</div><div class=\"line\"><span class=\"number\">26</span>: \t\t\t\t\t\t\tschema, type, sql, <span class=\"keyword\">this</span>.charset, <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>: \t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">29</span>: \t\t\tStringBuilder s = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\"><span class=\"number\">30</span>: \t\t\tLOGGER.warn(s.append(<span class=\"keyword\">this</span>).append(sql).toString() + <span class=\"string\">\" err:\"</span> + e.toString(),e);</div><div class=\"line\"><span class=\"number\">31</span>: \t\t\tString msg = e.getMessage();</div><div class=\"line\"><span class=\"number\">32</span>: \t\t\twriteErrMessage(ErrorCode.ER_PARSE_ERROR, msg == <span class=\"keyword\">null</span> ? e.getClass().getSimpleName() : msg);</div><div class=\"line\"><span class=\"number\">33</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">34</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"comment\">// æ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"keyword\">if</span> (rrs != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">38</span>: \t\t\t<span class=\"comment\">// sessionæ‰§è¡Œ</span></div><div class=\"line\"><span class=\"number\">39</span>: \t\t\tsession.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t</div><div class=\"line\"><span class=\"number\">42</span>:  \t&#125;</div><div class=\"line\"><span class=\"number\">43</span>: </div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-è·å¾—è·¯ç”±ç»“æœ\"><a href=\"#3-è·å¾—è·¯ç”±ç»“æœ\" class=\"headerlink\" title=\"3. è·å¾—è·¯ç”±ç»“æœ\"></a>3. è·å¾—è·¯ç”±ç»“æœ</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰\"></p>\n<h2 id=\"ã€-1-2-ã€‘ã€-12-ã€‘\"><a href=\"#ã€-1-2-ã€‘ã€-12-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 2 ã€‘ã€ 12 ã€‘\"></a>ã€ 1 - 2 ã€‘ã€ 12 ã€‘</h2><p>è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouteService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RouteResultset <span class=\"title\">route</span><span class=\"params\">(SystemConfig sysconf, SchemaConfig schema,</span></span></div><div class=\"line\"> <span class=\"number\">3</span>: \t\t<span class=\"keyword\">int</span> sqlType, String stmt, String charset, ServerConnection sc)</div><div class=\"line\"> 4: \t\t<span class=\"keyword\">throws</span> SQLNonTransientException &#123;</div><div class=\"line\"> <span class=\"number\">5</span>: \tRouteResultset rrs = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">6</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">7</span>: \t<span class=\"keyword\">int</span> hintLength = RouteService.isHintSql(stmt);</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">if</span>(hintLength != -<span class=\"number\">1</span>)&#123; <span class=\"comment\">// TODO å¾…è¯»ï¼šhint</span></div><div class=\"line\"> <span class=\"number\">9</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">10</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">11</span>: \t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">12</span>: \t\tstmt = stmt.trim();</div><div class=\"line\"><span class=\"number\">13</span>: \t\trrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,</div><div class=\"line\"><span class=\"number\">14</span>: \t\t\t\tcharset, sc, tableId2DataNodeCache);</div><div class=\"line\"><span class=\"number\">15</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç \t\treturn rrs;</span></div><div class=\"line\"><span class=\"number\">18</span>: &#125;</div><div class=\"line\"><span class=\"number\">19</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</span></div><div class=\"line\"><span class=\"number\">20</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">21</span>: <span class=\"function\"><span class=\"keyword\">public</span> RouteResultset <span class=\"title\">route</span><span class=\"params\">(SystemConfig sysConfig, SchemaConfig schema, <span class=\"keyword\">int</span> sqlType, String origSQL,</span></span></div><div class=\"line\"><span class=\"number\">22</span>: \t\tString charset, ServerConnection sc, LayerCachePool cachePool) <span class=\"keyword\">throws</span> SQLNonTransientException &#123;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>: \t<span class=\"comment\">// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥</span></div><div class=\"line\"><span class=\"number\">27</span>: \t<span class=\"keyword\">if</span> (beforeRouteProcess(schema, sqlType, origSQL, sc) ) &#123;</div><div class=\"line\"><span class=\"number\">28</span>: \t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">29</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>: \t<span class=\"comment\">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡</span></div><div class=\"line\"><span class=\"number\">34</span>: \t<span class=\"keyword\">if</span> (schema.isNoSharding() &amp;&amp; ServerParse.SHOW != sqlType) &#123;</div><div class=\"line\"><span class=\"number\">35</span>: \t\trrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);</div><div class=\"line\"><span class=\"number\">36</span>: \t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">37</span>: \t\tRouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);</div><div class=\"line\"><span class=\"number\">38</span>: \t\t<span class=\"keyword\">if</span> (returnedSet == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">39</span>: \t\t\trrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">41</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">42</span>: </div><div class=\"line\"><span class=\"number\">43</span>: \t<span class=\"keyword\">return</span> rrs;</div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<p><em><strong>è·¯ç”±</strong> è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>\n<h2 id=\"ã€-3-6-ã€‘\"><a href=\"#ã€-3-6-ã€‘\" class=\"headerlink\" title=\"ã€ 3 - 6 ã€‘\"></a>ã€ 3 - 6 ã€‘</h2><p>è·¯ç”±<strong>å‰ç½®</strong>å¤„ç†ã€‚å½“ç¬¦åˆå¦‚ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè¿›è¡Œå¤„ç†ï¼š  </p>\n<p>{ 1 } ä½¿ç”¨<strong>å…¨å±€åºåˆ—å·</strong>ï¼š</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> <span class=\"keyword\">table</span> (<span class=\"keyword\">id</span>, <span class=\"keyword\">name</span>) <span class=\"keyword\">values</span> (<span class=\"keyword\">NEXT</span> <span class=\"keyword\">VALUE</span> <span class=\"keyword\">FOR</span> MYCATSEQ_ID, <span class=\"string\">'name'</span>)</div></pre></td></tr></table></figure>\n<p>{ 2 } ER å­è¡¨æ’å…¥<br>{ 3 } ä¸»é”®ä½¿ç”¨è‡ªå¢ ID æ’å…¥ï¼š</p>\n<figure class=\"highlight\"><table><tr><td class=\"code\"><pre><div class=\"line\">insert into table (name) values ('name')</div><div class=\"line\">===&gt;</div><div class=\"line\">insert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')</div><div class=\"line\">```  </div><div class=\"line\"></div><div class=\"line\">æƒ…å†µ &#123; 1 &#125; &#123; 3 &#125; æƒ…å†µç±»ä¼¼ï¼Œä½¿ç”¨å…¨å±€åºåˆ—å·ã€‚</div><div class=\"line\"></div><div class=\"line\">æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</div><div class=\"line\"></div><div class=\"line\">```Java</div><div class=\"line\">  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</div><div class=\"line\">  2: private boolean beforeRouteProcess(SchemaConfig schema, int sqlType, String origSQL, ServerConnection sc)</div><div class=\"line\">  3: \t\tthrows SQLNonTransientException &#123;</div><div class=\"line\">  4: \treturn  // å¤„ç† id ä½¿ç”¨ å…¨å±€åºåˆ—å·</div><div class=\"line\">  5:             RouterUtil.processWithMycatSeq(schema, sqlType, origSQL, sc)</div><div class=\"line\">  6:             // å¤„ç† ER å­è¡¨</div><div class=\"line\">  7: \t\t\t|| (sqlType == ServerParse.INSERT &amp;&amp; RouterUtil.processERChildTable(schema, origSQL, sc))</div><div class=\"line\">  8:             // å¤„ç† id è‡ªå¢é•¿</div><div class=\"line\">  9: \t\t\t|| (sqlType == ServerParse.INSERT &amp;&amp; RouterUtil.processInsert(schema, sqlType, origSQL, sc));</div><div class=\"line\"> 10: &#125;</div></pre></td></tr></table></figure>\n<p><code>RouterUtil.java</code> å¤„ç† SQL è€ƒè™‘æ€§èƒ½ï¼Œå®ç°ä¼šæ¯”è¾ƒ C-styleï¼Œä»£ç å’±å°±ä¸è´´äº†ï¼Œä¼ é€é—¨ï¼š<a href=\"https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚</a> ï¼ˆğŸ˜ˆè¯¥ä»“åº“ä»å®˜æ–¹ Forkï¼Œé€æ­¥å®Œå–„ä¸­æ–‡æ³¨é‡Šï¼Œæ¬¢è¿ Starï¼‰</p>\n<h2 id=\"ã€-7-11-ã€‘\"><a href=\"#ã€-7-11-ã€‘\" class=\"headerlink\" title=\"ã€ 7 - 11 ã€‘\"></a>ã€ 7 - 11 ã€‘</h2><p>å½“<strong>å‰ç½®</strong>è·¯ç”±å¤„ç†<strong>å…¨å±€åºåˆ—å·</strong>æ—¶ï¼Œæ·»åŠ åˆ°å…¨å±€åºåˆ—å¤„ç†å™¨ï¼ˆ<code>MyCATSequnceProcessor</code>ï¼‰ã€‚è¯¥å¤„ç†å™¨ä¼šå¼‚æ­¥ç”Ÿæˆ IDï¼Œæ›¿æ¢ SQL å†…çš„ <code>NEXT VALUE FOR MYCATSEQ_</code> æ­£åˆ™ã€‚ä¾‹å¦‚ï¼š</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> <span class=\"keyword\">table</span> (<span class=\"keyword\">id</span>, <span class=\"keyword\">name</span>) <span class=\"keyword\">values</span> (<span class=\"keyword\">NEXT</span> <span class=\"keyword\">VALUE</span> <span class=\"keyword\">FOR</span> MYCATSEQ_ID, <span class=\"string\">'name'</span>)</div><div class=\"line\">===&gt;</div><div class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> <span class=\"keyword\">table</span> (<span class=\"keyword\">id</span>, <span class=\"keyword\">name</span>) <span class=\"keyword\">values</span> (<span class=\"number\">868348974560579584</span>, <span class=\"string\">'name'</span>)</div></pre></td></tr></table></figure>\n<p>å¼‚æ­¥å¤„ç†å®Œåï¼Œè°ƒç”¨ <code>ServerConnection#routeEndExecuteSQL(sql, type, schema)</code> æ–¹æ³•é‡æ–°æ‰§è¡Œ SQLã€‚</p>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouterUtil.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">processSQL</span><span class=\"params\">(ServerConnection sc,SchemaConfig schema,String sql,<span class=\"keyword\">int</span> sqlType)</span></span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \tSessionSQLPair sessionSQLPair = <span class=\"keyword\">new</span> SessionSQLPair(sc.getSession2(), schema, sql, sqlType);</div><div class=\"line\"> <span class=\"number\">4</span>: \tMycatServer.getInstance().getSequnceProcessor().addNewSql(sessionSQLPair);</div><div class=\"line\"> <span class=\"number\">5</span>: &#125;</div><div class=\"line\"> <span class=\"number\">6</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MyCATSequnceProcessor.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyCATSequnceProcessor</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">private</span> LinkedBlockingQueue&lt;SessionSQLPair&gt; seqSQLQueue = <span class=\"keyword\">new</span> LinkedBlockingQueue&lt;SessionSQLPair&gt;();</div><div class=\"line\"> <span class=\"number\">9</span>: \t<span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">boolean</span> running=<span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">10</span>: \t</div><div class=\"line\"><span class=\"number\">11</span>: \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addNewSql</span><span class=\"params\">(SessionSQLPair pair)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">12</span>: \t\tseqSQLQueue.add(pair);</div><div class=\"line\"><span class=\"number\">13</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>: \t<span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">executeSeq</span><span class=\"params\">(SessionSQLPair pair)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>: \t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">17</span>: \t\t\t</div><div class=\"line\"><span class=\"number\">18</span>: \t\t\t<span class=\"comment\">// ä½¿ç”¨Druidè§£æå™¨å®ç°sequenceå¤„ç†  @å…µä¸´åŸä¸‹</span></div><div class=\"line\"><span class=\"number\">19</span>: \t\t\tDruidSequenceHandler sequenceHandler = <span class=\"keyword\">new</span> DruidSequenceHandler(MycatServer</div><div class=\"line\"><span class=\"number\">20</span>: \t\t\t\t\t.getInstance().getConfig().getSystem().getSequnceHandlerType());</div><div class=\"line\"><span class=\"number\">21</span>: </div><div class=\"line\"><span class=\"number\">22</span>: \t\t\t<span class=\"comment\">// ç”Ÿæˆå¯æ‰§è¡Œ SQL ï¼šç›®å‰ä¸»è¦æ˜¯ç”Ÿæˆ id</span></div><div class=\"line\"><span class=\"number\">23</span>: \t\t\tString charset = pair.session.getSource().getCharset();</div><div class=\"line\"><span class=\"number\">24</span>: \t\t\tString executeSql = sequenceHandler.getExecuteSql(pair.sql,charset == <span class=\"keyword\">null</span> ? <span class=\"string\">\"utf-8\"</span>:charset);</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>: \t\t\t<span class=\"comment\">// æ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">27</span>: \t\t\tpair.session.getSource().routeEndExecuteSQL(executeSql, pair.type,pair.schema);</div><div class=\"line\"><span class=\"number\">28</span>: \t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">29</span>: \t\t\tLOGGER.error(<span class=\"string\">\"MyCATSequenceProcessor.executeSeq(SesionSQLPair)\"</span>,e);</div><div class=\"line\"><span class=\"number\">30</span>: \t\t\tpair.session.getSource().writeErrMessage(ErrorCode.ER_YES,<span class=\"string\">\"mycat sequnce err.\"</span> + e);</div><div class=\"line\"><span class=\"number\">31</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">32</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">33</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">34</span>: \t</div><div class=\"line\"><span class=\"number\">35</span>: \t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExecuteThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">Thread</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">36</span>: \t\t</div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ExecuteThread</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">38</span>: \t\t\tsetDaemon(<span class=\"keyword\">true</span>); <span class=\"comment\">// è®¾ç½®ä¸ºåå°çº¿ç¨‹,é˜²æ­¢throw RuntimeExecptionè¿›ç¨‹ä»ç„¶å­˜åœ¨çš„é—®é¢˜</span></div><div class=\"line\"><span class=\"number\">39</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">40</span>: \t\t</div><div class=\"line\"><span class=\"number\">41</span>: \t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">42</span>: \t\t\t<span class=\"keyword\">while</span> (running) &#123;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t\t\t\tSessionSQLPair pair=seqSQLQueue.poll(<span class=\"number\">100</span>,TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">45</span>: \t\t\t\t\t<span class=\"keyword\">if</span>(pair!=<span class=\"keyword\">null</span>)&#123;</div><div class=\"line\"><span class=\"number\">46</span>:                         executeSeq(pair);</div><div class=\"line\"><span class=\"number\">47</span>: \t\t\t\t\t&#125;</div><div class=\"line\"><span class=\"number\">48</span>: \t\t\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">49</span>: \t\t\t\t\tLOGGER.warn(<span class=\"string\">\"MyCATSequenceProcessor$ExecutorThread\"</span>,e);</div><div class=\"line\"><span class=\"number\">50</span>: \t\t\t\t&#125;</div><div class=\"line\"><span class=\"number\">51</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">52</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">53</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">54</span>: &#125;</div></pre></td></tr></table></figure>\n<p>â“æ­¤å¤„æœ‰ä¸ªç–‘é—®ï¼š<code>MyCATSequnceProcessor</code> æ˜¯å•çº¿ç¨‹ï¼Œä¼šä¸ä¼šæ’å…¥æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Ÿåç»­å’±åšä¸‹æ€§èƒ½æµ‹è¯•ã€‚</p>\n<h1 id=\"4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL\"><a href=\"#4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL\" class=\"headerlink\" title=\"4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL\"></a>4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ%20SQLï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰\"></p>\n<h2 id=\"ã€-1-8-ã€‘\"><a href=\"#ã€-1-8-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 8 ã€‘\"></a>ã€ 1 - 8 ã€‘</h2><p>è·å¾— MySQL è¿æ¥ã€‚</p>\n<ul>\n<li>PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚</li>\n<li>PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚</li>\n</ul>\n<h2 id=\"ã€-9-13-ã€‘\"><a href=\"#ã€-9-13-ã€‘\" class=\"headerlink\" title=\"ã€ 9 - 13 ã€‘\"></a>ã€ 9 - 13 ã€‘</h2><p>å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚</p>\n<h1 id=\"5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ\"><a href=\"#5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ\" class=\"headerlink\" title=\"5. å“åº”æ‰§è¡Œ SQL ç»“æœ\"></a>5. å“åº”æ‰§è¡Œ SQL ç»“æœ</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰\"></p>\n<h2 id=\"ã€-1-4-ã€‘\"><a href=\"#ã€-1-4-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 4 ã€‘\"></a>ã€ 1 - 4 ã€‘</h2><p>å¤„ç† MySQL Server å“åº”æ•°æ®åŒ…ã€‚</p>\n<h2 id=\"ã€-5-8-ã€‘\"><a href=\"#ã€-5-8-ã€‘\" class=\"headerlink\" title=\"ã€ 5 - 8 ã€‘\"></a>ã€ 5 - 8 ã€‘</h2><p>å‘é€æ’å…¥æˆåŠŸç»“æœç»™ MySQL Clientã€‚</p>\n"},{"title":"Nginx åŠ¨æ€é…ç½® upstream","date":"2017-01-06T16:00:00.000Z","_content":"\néšç€SOAã€å¾®æœåŠ¡è¶Šæ¥è¶Šæµè¡Œï¼Œæ³¨å†Œå‘ç°æœåŠ¡å·²ç»æˆä¸ºæ¶æ„é‡Œçš„æ ‡é…ã€‚æ— è®ºæ˜¯åœ¨é€‰æ‹©Dubboã€Dubboxã€Spring Cloudéƒ½æä¾›äº†å¯¹åº”çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä¸éœ€è¦æ¯æ¬¡æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±å»ä¿®æ”¹å¯¹åº”é…ç½®ã€‚é‚£ä¹ˆåœ¨ä½¿ç”¨Nginxçš„æ—¶å€™æˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ\nå‚è€ƒç±»ä¼¼æœåŠ¡å‘ç°çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬é€‰æ‹©äº†å¾®åšå¼€æºçš„nginxæ’ä»¶ï¼šhttps://github.com/weibocom/nginx-upsync-module ã€‚\n\n## åŸºäºtengineå®‰è£… ##\n* tengineï¼š2.2.0ï¼ˆåŸºäºnginx1.8.1+ï¼‰\n* nginx-upsync-moduleï¼šv1.0.0ï¼ˆåŸºäºnginx1.8.1+ï¼‰\n* æ³¨å†Œå‘ç°æœåŠ¡ï¼šetcd 3.0.15\n\né—®é¢˜ï¼š\n\n* nginxçš„error.logä¸æ–­æŠ¥é”™`recv() failed (104: Connection reset by peer)` ã€‚\n    \n    åŸå› ï¼šè¯¥é—®é¢˜ä½¿ç”¨etcdä¼šå­˜åœ¨ã€‚ä½œè€…åœ¨commit#89bf40fb60268062aaeac3780ad8d56f0834c400å·²ç»ä¿®å¤ã€‚ç”±äºè¯¥ä¿®å¤çš„æäº¤æ˜¯åŸºäºnginx 1.9.1+ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨tegine2.2.0ä¸Šä½¿ç”¨ã€‚ç­‰å¾…ä½œè€…å›å¤å¦‚ä½•è§£å†³ä¸­ã€‚\n    è¡¥å……è¯´æ˜ï¼šå³ä½¿æŠ¥è¯¥é”™è¯¯ï¼Œå®é™…ä¸å½±å“æ’ä»¶çš„åŠŸèƒ½ã€‚\n    \n    \n## åŸºäºnginxå®‰è£… ##\n\n*ç”±äºåŸºäºtegine2.2.0ä¼šæŠ¥é”™ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•ä½¿ç”¨nginxå®˜æ–¹ç‰ˆæœ¬å®‰è£…*\n\n* nginxï¼š1.10.1\n* nginx-upsync-moduleï¼šcommit#6e1a9fe9117361539837efc81ac45303d7494dbeï¼ˆåŸºäºnginx1.9.1+ï¼‰\n* æ³¨å†Œå‘ç°æœåŠ¡ï¼šetcd 3.0.15   \n\né—®é¢˜ï¼š\n\n* å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨`nginx_upstream_check_module` æ’ä»¶ï¼Œéœ€è¦ä½¿ç”¨https://github.com/yaoweibin/nginx_upstream_check_module ä¸‹çš„ï¼Œä¸ç„¶`make`æ—¶ä¼šæŠ¥é”™ã€‚å¦å¤–åœ¨`patch -p1 < check.patch`æ—¶ï¼Œè¯·cd nginxçš„ç›®å½•ä¸‹ï¼Œè¾“å…¥`patch -p1 < /path/to/nginx_http_upstream_check_module/check.patch`ã€‚è¿™ç‚¹README.mdä¹Ÿè¯´äº†ï¼Œå½“æ—¶å¤ªç€æ€¥ï¼Œæ²¡å»çœ‹ï¼Œå¡äº†åŠå°æ—¶ã€‚\n\n    >  \n        $ wget 'http://nginx.org/download/nginx-1.0.14.tar.gz'\n        $ tar -xzvf nginx-1.0.14.tar.gz\n        $ cd nginx-1.0.14/\n        $ patch -p1 < /path/to/nginx_http_upstream_check_module/check.patch\n        $ ./configure --add-module=/path/to/nginx_http_upstream_check_module\n        $ make\n        $ make install\n\n## åŸºäºdockerå®‰è£… ##\n\nTODO\n\n## åŸç† ##\n\n1. å®æ—¶æ€§ï¼šupstreamæ›´æ–°ä¾èµ–æ³¨å†Œä¸­å¿ƒæä¾›çš„æŸ¥è¯¢çš„httpæ¥å£ã€‚è¿™ç‚¹å’ŒDubboã€Spring Cloudçš„æ³¨å†Œå‘ç°çš„å®æ—¶æ€§æœ‰äº›ä¸åŒã€‚å¦‚æœå¯¹å®æ—¶æ€§è¦æ±‚ç‰¹åˆ«é«˜ï¼Œå¯ä»¥è°ƒæ•´`upsync_interval`å‚æ•°ã€‚\n2. Zookeeperçš„æ”¯æŒï¼šç›®å‰å®˜æ–¹æš‚æ—¶æœªæä¾›ç›¸åº”çš„æ”¯æŒã€‚è€ƒè™‘åˆ°å¾ˆå¤šå›¢é˜Ÿæ˜¯ä½¿ç”¨Zookeeperä½œä¸ºæœåŠ¡å‘ç°ï¼Œå¦å¤–ç»´æŠ¤ä¸€ä¸ªetcdã€consulé›†ç¾¤æ˜¯æœ‰ç›¸åº”å­¦ä¹ æˆæœ¬å’Œè¿ç»´æˆæœ¬çš„ã€‚é‚£ä¹ˆæ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥å°è£…Zookeeperæä¾›httpæ¥å£ç»™`nginx-upsync-module`ä½¿ç”¨ï¼Œå½“ç„¶æ¥å£å½¢å¼å¾—æ»¡è¶³consualæˆ–è€…etcdæä¾›çš„httpæ¥å£ã€‚\n\n## å‚è€ƒæ–‡ç«  ##\n\n1. nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹ï¼šhttp://xiaorui.cc/2016/10/16/nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹/\n\n","source":"_posts/Nginx/2017_01_07_NginxåŠ¨æ€é…ç½®upstream.md","raw":"title: Nginx åŠ¨æ€é…ç½® upstream\ndate: 2017-01-07\ntags:\ncategories: Nginx\npermalink: Nginx/nginx-dynamic-upstream\n\n---\n\néšç€SOAã€å¾®æœåŠ¡è¶Šæ¥è¶Šæµè¡Œï¼Œæ³¨å†Œå‘ç°æœåŠ¡å·²ç»æˆä¸ºæ¶æ„é‡Œçš„æ ‡é…ã€‚æ— è®ºæ˜¯åœ¨é€‰æ‹©Dubboã€Dubboxã€Spring Cloudéƒ½æä¾›äº†å¯¹åº”çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä¸éœ€è¦æ¯æ¬¡æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±å»ä¿®æ”¹å¯¹åº”é…ç½®ã€‚é‚£ä¹ˆåœ¨ä½¿ç”¨Nginxçš„æ—¶å€™æˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ\nå‚è€ƒç±»ä¼¼æœåŠ¡å‘ç°çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬é€‰æ‹©äº†å¾®åšå¼€æºçš„nginxæ’ä»¶ï¼šhttps://github.com/weibocom/nginx-upsync-module ã€‚\n\n## åŸºäºtengineå®‰è£… ##\n* tengineï¼š2.2.0ï¼ˆåŸºäºnginx1.8.1+ï¼‰\n* nginx-upsync-moduleï¼šv1.0.0ï¼ˆåŸºäºnginx1.8.1+ï¼‰\n* æ³¨å†Œå‘ç°æœåŠ¡ï¼šetcd 3.0.15\n\né—®é¢˜ï¼š\n\n* nginxçš„error.logä¸æ–­æŠ¥é”™`recv() failed (104: Connection reset by peer)` ã€‚\n    \n    åŸå› ï¼šè¯¥é—®é¢˜ä½¿ç”¨etcdä¼šå­˜åœ¨ã€‚ä½œè€…åœ¨commit#89bf40fb60268062aaeac3780ad8d56f0834c400å·²ç»ä¿®å¤ã€‚ç”±äºè¯¥ä¿®å¤çš„æäº¤æ˜¯åŸºäºnginx 1.9.1+ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨tegine2.2.0ä¸Šä½¿ç”¨ã€‚ç­‰å¾…ä½œè€…å›å¤å¦‚ä½•è§£å†³ä¸­ã€‚\n    è¡¥å……è¯´æ˜ï¼šå³ä½¿æŠ¥è¯¥é”™è¯¯ï¼Œå®é™…ä¸å½±å“æ’ä»¶çš„åŠŸèƒ½ã€‚\n    \n    \n## åŸºäºnginxå®‰è£… ##\n\n*ç”±äºåŸºäºtegine2.2.0ä¼šæŠ¥é”™ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•ä½¿ç”¨nginxå®˜æ–¹ç‰ˆæœ¬å®‰è£…*\n\n* nginxï¼š1.10.1\n* nginx-upsync-moduleï¼šcommit#6e1a9fe9117361539837efc81ac45303d7494dbeï¼ˆåŸºäºnginx1.9.1+ï¼‰\n* æ³¨å†Œå‘ç°æœåŠ¡ï¼šetcd 3.0.15   \n\né—®é¢˜ï¼š\n\n* å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨`nginx_upstream_check_module` æ’ä»¶ï¼Œéœ€è¦ä½¿ç”¨https://github.com/yaoweibin/nginx_upstream_check_module ä¸‹çš„ï¼Œä¸ç„¶`make`æ—¶ä¼šæŠ¥é”™ã€‚å¦å¤–åœ¨`patch -p1 < check.patch`æ—¶ï¼Œè¯·cd nginxçš„ç›®å½•ä¸‹ï¼Œè¾“å…¥`patch -p1 < /path/to/nginx_http_upstream_check_module/check.patch`ã€‚è¿™ç‚¹README.mdä¹Ÿè¯´äº†ï¼Œå½“æ—¶å¤ªç€æ€¥ï¼Œæ²¡å»çœ‹ï¼Œå¡äº†åŠå°æ—¶ã€‚\n\n    >  \n        $ wget 'http://nginx.org/download/nginx-1.0.14.tar.gz'\n        $ tar -xzvf nginx-1.0.14.tar.gz\n        $ cd nginx-1.0.14/\n        $ patch -p1 < /path/to/nginx_http_upstream_check_module/check.patch\n        $ ./configure --add-module=/path/to/nginx_http_upstream_check_module\n        $ make\n        $ make install\n\n## åŸºäºdockerå®‰è£… ##\n\nTODO\n\n## åŸç† ##\n\n1. å®æ—¶æ€§ï¼šupstreamæ›´æ–°ä¾èµ–æ³¨å†Œä¸­å¿ƒæä¾›çš„æŸ¥è¯¢çš„httpæ¥å£ã€‚è¿™ç‚¹å’ŒDubboã€Spring Cloudçš„æ³¨å†Œå‘ç°çš„å®æ—¶æ€§æœ‰äº›ä¸åŒã€‚å¦‚æœå¯¹å®æ—¶æ€§è¦æ±‚ç‰¹åˆ«é«˜ï¼Œå¯ä»¥è°ƒæ•´`upsync_interval`å‚æ•°ã€‚\n2. Zookeeperçš„æ”¯æŒï¼šç›®å‰å®˜æ–¹æš‚æ—¶æœªæä¾›ç›¸åº”çš„æ”¯æŒã€‚è€ƒè™‘åˆ°å¾ˆå¤šå›¢é˜Ÿæ˜¯ä½¿ç”¨Zookeeperä½œä¸ºæœåŠ¡å‘ç°ï¼Œå¦å¤–ç»´æŠ¤ä¸€ä¸ªetcdã€consulé›†ç¾¤æ˜¯æœ‰ç›¸åº”å­¦ä¹ æˆæœ¬å’Œè¿ç»´æˆæœ¬çš„ã€‚é‚£ä¹ˆæ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥å°è£…Zookeeperæä¾›httpæ¥å£ç»™`nginx-upsync-module`ä½¿ç”¨ï¼Œå½“ç„¶æ¥å£å½¢å¼å¾—æ»¡è¶³consualæˆ–è€…etcdæä¾›çš„httpæ¥å£ã€‚\n\n## å‚è€ƒæ–‡ç«  ##\n\n1. nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹ï¼šhttp://xiaorui.cc/2016/10/16/nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹/\n\n","slug":"Nginx/nginx-dynamic-upstream","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswz3000eak5d6n0gq9x6","content":"<p>éšç€SOAã€å¾®æœåŠ¡è¶Šæ¥è¶Šæµè¡Œï¼Œæ³¨å†Œå‘ç°æœåŠ¡å·²ç»æˆä¸ºæ¶æ„é‡Œçš„æ ‡é…ã€‚æ— è®ºæ˜¯åœ¨é€‰æ‹©Dubboã€Dubboxã€Spring Cloudéƒ½æä¾›äº†å¯¹åº”çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä¸éœ€è¦æ¯æ¬¡æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±å»ä¿®æ”¹å¯¹åº”é…ç½®ã€‚é‚£ä¹ˆåœ¨ä½¿ç”¨Nginxçš„æ—¶å€™æˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ<br>å‚è€ƒç±»ä¼¼æœåŠ¡å‘ç°çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬é€‰æ‹©äº†å¾®åšå¼€æºçš„nginxæ’ä»¶ï¼š<a href=\"https://github.com/weibocom/nginx-upsync-module\" target=\"_blank\" rel=\"external\">https://github.com/weibocom/nginx-upsync-module</a> ã€‚</p>\n<h2 id=\"åŸºäºtengineå®‰è£…\"><a href=\"#åŸºäºtengineå®‰è£…\" class=\"headerlink\" title=\"åŸºäºtengineå®‰è£…\"></a>åŸºäºtengineå®‰è£…</h2><ul>\n<li>tengineï¼š2.2.0ï¼ˆåŸºäºnginx1.8.1+ï¼‰</li>\n<li>nginx-upsync-moduleï¼šv1.0.0ï¼ˆåŸºäºnginx1.8.1+ï¼‰</li>\n<li>æ³¨å†Œå‘ç°æœåŠ¡ï¼šetcd 3.0.15</li>\n</ul>\n<p>é—®é¢˜ï¼š</p>\n<ul>\n<li><p>nginxçš„error.logä¸æ–­æŠ¥é”™<code>recv() failed (104: Connection reset by peer)</code> ã€‚</p>\n<p>  åŸå› ï¼šè¯¥é—®é¢˜ä½¿ç”¨etcdä¼šå­˜åœ¨ã€‚ä½œè€…åœ¨commit#89bf40fb60268062aaeac3780ad8d56f0834c400å·²ç»ä¿®å¤ã€‚ç”±äºè¯¥ä¿®å¤çš„æäº¤æ˜¯åŸºäºnginx 1.9.1+ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨tegine2.2.0ä¸Šä½¿ç”¨ã€‚ç­‰å¾…ä½œè€…å›å¤å¦‚ä½•è§£å†³ä¸­ã€‚<br>  è¡¥å……è¯´æ˜ï¼šå³ä½¿æŠ¥è¯¥é”™è¯¯ï¼Œå®é™…ä¸å½±å“æ’ä»¶çš„åŠŸèƒ½ã€‚</p>\n</li>\n</ul>\n<h2 id=\"åŸºäºnginxå®‰è£…\"><a href=\"#åŸºäºnginxå®‰è£…\" class=\"headerlink\" title=\"åŸºäºnginxå®‰è£…\"></a>åŸºäºnginxå®‰è£…</h2><p><em>ç”±äºåŸºäºtegine2.2.0ä¼šæŠ¥é”™ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•ä½¿ç”¨nginxå®˜æ–¹ç‰ˆæœ¬å®‰è£…</em></p>\n<ul>\n<li>nginxï¼š1.10.1</li>\n<li>nginx-upsync-moduleï¼šcommit#6e1a9fe9117361539837efc81ac45303d7494dbeï¼ˆåŸºäºnginx1.9.1+ï¼‰</li>\n<li>æ³¨å†Œå‘ç°æœåŠ¡ï¼šetcd 3.0.15   </li>\n</ul>\n<p>é—®é¢˜ï¼š</p>\n<ul>\n<li><p>å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>nginx_upstream_check_module</code> æ’ä»¶ï¼Œéœ€è¦ä½¿ç”¨<a href=\"https://github.com/yaoweibin/nginx_upstream_check_module\" target=\"_blank\" rel=\"external\">https://github.com/yaoweibin/nginx_upstream_check_module</a> ä¸‹çš„ï¼Œä¸ç„¶<code>make</code>æ—¶ä¼šæŠ¥é”™ã€‚å¦å¤–åœ¨<code>patch -p1 &lt; check.patch</code>æ—¶ï¼Œè¯·cd nginxçš„ç›®å½•ä¸‹ï¼Œè¾“å…¥<code>patch -p1 &lt; /path/to/nginx_http_upstream_check_module/check.patch</code>ã€‚è¿™ç‚¹README.mdä¹Ÿè¯´äº†ï¼Œå½“æ—¶å¤ªç€æ€¥ï¼Œæ²¡å»çœ‹ï¼Œå¡äº†åŠå°æ—¶ã€‚</p>\n<blockquote>\n<pre><code>$ wget &apos;http://nginx.org/download/nginx-1.0.14.tar.gz&apos;\n$ tar -xzvf nginx-1.0.14.tar.gz\n$ cd nginx-1.0.14/\n$ patch -p1 &lt; /path/to/nginx_http_upstream_check_module/check.patch\n$ ./configure --add-module=/path/to/nginx_http_upstream_check_module\n$ make\n$ make install\n</code></pre></blockquote>\n</li>\n</ul>\n<h2 id=\"åŸºäºdockerå®‰è£…\"><a href=\"#åŸºäºdockerå®‰è£…\" class=\"headerlink\" title=\"åŸºäºdockerå®‰è£…\"></a>åŸºäºdockerå®‰è£…</h2><p>TODO</p>\n<h2 id=\"åŸç†\"><a href=\"#åŸç†\" class=\"headerlink\" title=\"åŸç†\"></a>åŸç†</h2><ol>\n<li>å®æ—¶æ€§ï¼šupstreamæ›´æ–°ä¾èµ–æ³¨å†Œä¸­å¿ƒæä¾›çš„æŸ¥è¯¢çš„httpæ¥å£ã€‚è¿™ç‚¹å’ŒDubboã€Spring Cloudçš„æ³¨å†Œå‘ç°çš„å®æ—¶æ€§æœ‰äº›ä¸åŒã€‚å¦‚æœå¯¹å®æ—¶æ€§è¦æ±‚ç‰¹åˆ«é«˜ï¼Œå¯ä»¥è°ƒæ•´<code>upsync_interval</code>å‚æ•°ã€‚</li>\n<li>Zookeeperçš„æ”¯æŒï¼šç›®å‰å®˜æ–¹æš‚æ—¶æœªæä¾›ç›¸åº”çš„æ”¯æŒã€‚è€ƒè™‘åˆ°å¾ˆå¤šå›¢é˜Ÿæ˜¯ä½¿ç”¨Zookeeperä½œä¸ºæœåŠ¡å‘ç°ï¼Œå¦å¤–ç»´æŠ¤ä¸€ä¸ªetcdã€consulé›†ç¾¤æ˜¯æœ‰ç›¸åº”å­¦ä¹ æˆæœ¬å’Œè¿ç»´æˆæœ¬çš„ã€‚é‚£ä¹ˆæ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥å°è£…Zookeeperæä¾›httpæ¥å£ç»™<code>nginx-upsync-module</code>ä½¿ç”¨ï¼Œå½“ç„¶æ¥å£å½¢å¼å¾—æ»¡è¶³consualæˆ–è€…etcdæä¾›çš„httpæ¥å£ã€‚</li>\n</ol>\n<h2 id=\"å‚è€ƒæ–‡ç« \"><a href=\"#å‚è€ƒæ–‡ç« \" class=\"headerlink\" title=\"å‚è€ƒæ–‡ç« \"></a>å‚è€ƒæ–‡ç« </h2><ol>\n<li>nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹ï¼š<a href=\"http://xiaorui.cc/2016/10/16/nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹/\" target=\"_blank\" rel=\"external\">http://xiaorui.cc/2016/10/16/nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹/</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>éšç€SOAã€å¾®æœåŠ¡è¶Šæ¥è¶Šæµè¡Œï¼Œæ³¨å†Œå‘ç°æœåŠ¡å·²ç»æˆä¸ºæ¶æ„é‡Œçš„æ ‡é…ã€‚æ— è®ºæ˜¯åœ¨é€‰æ‹©Dubboã€Dubboxã€Spring Cloudéƒ½æä¾›äº†å¯¹åº”çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä¸éœ€è¦æ¯æ¬¡æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±å»ä¿®æ”¹å¯¹åº”é…ç½®ã€‚é‚£ä¹ˆåœ¨ä½¿ç”¨Nginxçš„æ—¶å€™æˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ<br>å‚è€ƒç±»ä¼¼æœåŠ¡å‘ç°çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬é€‰æ‹©äº†å¾®åšå¼€æºçš„nginxæ’ä»¶ï¼š<a href=\"https://github.com/weibocom/nginx-upsync-module\" target=\"_blank\" rel=\"external\">https://github.com/weibocom/nginx-upsync-module</a> ã€‚</p>\n<h2 id=\"åŸºäºtengineå®‰è£…\"><a href=\"#åŸºäºtengineå®‰è£…\" class=\"headerlink\" title=\"åŸºäºtengineå®‰è£…\"></a>åŸºäºtengineå®‰è£…</h2><ul>\n<li>tengineï¼š2.2.0ï¼ˆåŸºäºnginx1.8.1+ï¼‰</li>\n<li>nginx-upsync-moduleï¼šv1.0.0ï¼ˆåŸºäºnginx1.8.1+ï¼‰</li>\n<li>æ³¨å†Œå‘ç°æœåŠ¡ï¼šetcd 3.0.15</li>\n</ul>\n<p>é—®é¢˜ï¼š</p>\n<ul>\n<li><p>nginxçš„error.logä¸æ–­æŠ¥é”™<code>recv() failed (104: Connection reset by peer)</code> ã€‚</p>\n<p>  åŸå› ï¼šè¯¥é—®é¢˜ä½¿ç”¨etcdä¼šå­˜åœ¨ã€‚ä½œè€…åœ¨commit#89bf40fb60268062aaeac3780ad8d56f0834c400å·²ç»ä¿®å¤ã€‚ç”±äºè¯¥ä¿®å¤çš„æäº¤æ˜¯åŸºäºnginx 1.9.1+ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨tegine2.2.0ä¸Šä½¿ç”¨ã€‚ç­‰å¾…ä½œè€…å›å¤å¦‚ä½•è§£å†³ä¸­ã€‚<br>  è¡¥å……è¯´æ˜ï¼šå³ä½¿æŠ¥è¯¥é”™è¯¯ï¼Œå®é™…ä¸å½±å“æ’ä»¶çš„åŠŸèƒ½ã€‚</p>\n</li>\n</ul>\n<h2 id=\"åŸºäºnginxå®‰è£…\"><a href=\"#åŸºäºnginxå®‰è£…\" class=\"headerlink\" title=\"åŸºäºnginxå®‰è£…\"></a>åŸºäºnginxå®‰è£…</h2><p><em>ç”±äºåŸºäºtegine2.2.0ä¼šæŠ¥é”™ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•ä½¿ç”¨nginxå®˜æ–¹ç‰ˆæœ¬å®‰è£…</em></p>\n<ul>\n<li>nginxï¼š1.10.1</li>\n<li>nginx-upsync-moduleï¼šcommit#6e1a9fe9117361539837efc81ac45303d7494dbeï¼ˆåŸºäºnginx1.9.1+ï¼‰</li>\n<li>æ³¨å†Œå‘ç°æœåŠ¡ï¼šetcd 3.0.15   </li>\n</ul>\n<p>é—®é¢˜ï¼š</p>\n<ul>\n<li><p>å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>nginx_upstream_check_module</code> æ’ä»¶ï¼Œéœ€è¦ä½¿ç”¨<a href=\"https://github.com/yaoweibin/nginx_upstream_check_module\" target=\"_blank\" rel=\"external\">https://github.com/yaoweibin/nginx_upstream_check_module</a> ä¸‹çš„ï¼Œä¸ç„¶<code>make</code>æ—¶ä¼šæŠ¥é”™ã€‚å¦å¤–åœ¨<code>patch -p1 &lt; check.patch</code>æ—¶ï¼Œè¯·cd nginxçš„ç›®å½•ä¸‹ï¼Œè¾“å…¥<code>patch -p1 &lt; /path/to/nginx_http_upstream_check_module/check.patch</code>ã€‚è¿™ç‚¹README.mdä¹Ÿè¯´äº†ï¼Œå½“æ—¶å¤ªç€æ€¥ï¼Œæ²¡å»çœ‹ï¼Œå¡äº†åŠå°æ—¶ã€‚</p>\n<blockquote>\n<pre><code>$ wget &apos;http://nginx.org/download/nginx-1.0.14.tar.gz&apos;\n$ tar -xzvf nginx-1.0.14.tar.gz\n$ cd nginx-1.0.14/\n$ patch -p1 &lt; /path/to/nginx_http_upstream_check_module/check.patch\n$ ./configure --add-module=/path/to/nginx_http_upstream_check_module\n$ make\n$ make install\n</code></pre></blockquote>\n</li>\n</ul>\n<h2 id=\"åŸºäºdockerå®‰è£…\"><a href=\"#åŸºäºdockerå®‰è£…\" class=\"headerlink\" title=\"åŸºäºdockerå®‰è£…\"></a>åŸºäºdockerå®‰è£…</h2><p>TODO</p>\n<h2 id=\"åŸç†\"><a href=\"#åŸç†\" class=\"headerlink\" title=\"åŸç†\"></a>åŸç†</h2><ol>\n<li>å®æ—¶æ€§ï¼šupstreamæ›´æ–°ä¾èµ–æ³¨å†Œä¸­å¿ƒæä¾›çš„æŸ¥è¯¢çš„httpæ¥å£ã€‚è¿™ç‚¹å’ŒDubboã€Spring Cloudçš„æ³¨å†Œå‘ç°çš„å®æ—¶æ€§æœ‰äº›ä¸åŒã€‚å¦‚æœå¯¹å®æ—¶æ€§è¦æ±‚ç‰¹åˆ«é«˜ï¼Œå¯ä»¥è°ƒæ•´<code>upsync_interval</code>å‚æ•°ã€‚</li>\n<li>Zookeeperçš„æ”¯æŒï¼šç›®å‰å®˜æ–¹æš‚æ—¶æœªæä¾›ç›¸åº”çš„æ”¯æŒã€‚è€ƒè™‘åˆ°å¾ˆå¤šå›¢é˜Ÿæ˜¯ä½¿ç”¨Zookeeperä½œä¸ºæœåŠ¡å‘ç°ï¼Œå¦å¤–ç»´æŠ¤ä¸€ä¸ªetcdã€consulé›†ç¾¤æ˜¯æœ‰ç›¸åº”å­¦ä¹ æˆæœ¬å’Œè¿ç»´æˆæœ¬çš„ã€‚é‚£ä¹ˆæ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥å°è£…Zookeeperæä¾›httpæ¥å£ç»™<code>nginx-upsync-module</code>ä½¿ç”¨ï¼Œå½“ç„¶æ¥å£å½¢å¼å¾—æ»¡è¶³consualæˆ–è€…etcdæä¾›çš„httpæ¥å£ã€‚</li>\n</ol>\n<h2 id=\"å‚è€ƒæ–‡ç« \"><a href=\"#å‚è€ƒæ–‡ç« \" class=\"headerlink\" title=\"å‚è€ƒæ–‡ç« \"></a>å‚è€ƒæ–‡ç« </h2><ol>\n<li>nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹ï¼š<a href=\"http://xiaorui.cc/2016/10/16/nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹/\" target=\"_blank\" rel=\"external\">http://xiaorui.cc/2016/10/16/nginxåŠ¨æ€é…ç½®åŠæœåŠ¡å‘ç°é‚£äº›äº‹/</a></li>\n</ol>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” Topic","date":"2017-04-06T16:00:00.000Z","_content":"","source":"_posts/RocketMQ/2017_04_07_RocketMQæºç åˆ†æâ€”â€”Topic.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Topic\ndate: 2017-04-07\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/topic\n\n---","slug":"RocketMQ/topic","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswz6000gak5d0cr5vqer","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢","date":"2017-05-29T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1004-MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢.md)  \n> `MyCat-Server` **å¸¦æ³¨é‡Š**åœ°å€ ï¼šhttps://github.com/YunaiV/Mycat-Server  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blog**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL](#)\n- [3. è·å¾—è·¯ç”±ç»“æœ](#)\n- [4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL](#)\n- [5. å“åº”æ‰§è¡Œ SQL ç»“æœ](#)\n- [6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤](#)\n\n# 1. æ¦‚è¿°\n\n> å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚  \n> å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚  \n> å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚  \n> å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚\n\næœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚\n  \nğŸ˜‚å†…å®¹å’Œ [ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md) è¶…çº§ç›¸ä¼¼ï¼Œä¸€æ–¹é¢æœ¬èº«æµç¨‹åŸºæœ¬ç›¸åŒï¼Œå¦å¤–ä¸€æ–¹é¢æ–‡ç« ç»“æ„æ²¡æ‹†åˆ†å¥½ã€‚æˆ‘ä»¬ä½¿ç”¨ ğŸš€ æ ‡è®°å·®å¼‚çš„é€»è¾‘ã€‚\n\näº¤äº’å¦‚ä¸‹å›¾ï¼š\n\n![å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾.png)\n\næ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š\n\n1. æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚\n2. è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚\n3. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚\n4. å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚\n\næˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚\n\n# 2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL\n\n![ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰.png)\n\n## ã€1 - 2ã€‘\n\næ¥æ”¶**ä¸€æ¡** MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚\n\n## ã€3ã€‘\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘\n  2: public class FrontendCommandHandler implements NIOHandler {\n  3: \n  4:     @Override\n  5:     public void handle(byte[] data) {\n  6:     \n  7:         // .... çœç•¥éƒ¨åˆ†ä»£ç \n  8:         switch (data[4]) // \n  9:         {\n 10:             case MySQLPacket.COM_INIT_DB:\n 11:                 commands.doInitDB();\n 12:                 source.initDB(data);\n 13:                 break;\n 14:             case MySQLPacket.COM_QUERY: // æŸ¥è¯¢å‘½ä»¤\n 15:                 // è®¡æ•°æŸ¥è¯¢å‘½ä»¤\n 16:                 commands.doQuery();\n 17:                 // æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤\n 18:                 source.query(data);\n 19:                 break;\n 20:             case MySQLPacket.COM_PING:\n 21:                 commands.doPing();\n 22:                 source.ping();\n 23:                 break;\n 24:             // .... çœç•¥éƒ¨åˆ†case\n 25:         }\n 26:     }\n 27: \n 28: }\n```\n\n`INSERT`/`SELECT`/`UPDATE`/`DELETE` ç­‰ SQL å½’å±äº `MySQLPacket.COM_QUERY`ï¼Œè¯¦ç»†å¯è§ï¼š[ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -> æœåŠ¡å™¨ï¼‰ã€‹](http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-)ã€‚\n\n## ã€4ã€‘\n\nå°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘\n  2: public void query(byte[] data) {\n  3: \t// å–å¾—è¯­å¥\n  4: \tString sql = null;\t\t\n  5: \ttry {\n  6: \t\tMySQLMessage mm = new MySQLMessage(data);\n  7: \t\tmm.position(5);\n  8: \t\tsql = mm.readString(charset);\n  9: \t} catch (UnsupportedEncodingException e) {\n 10: \t\twriteErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, \"Unknown charset '\" + charset + \"'\");\n 11: \t\treturn;\n 12: \t}\t\t\n 13: \t// æ‰§è¡Œè¯­å¥\n 14: \tthis.query( sql );\n 15: }\n```\n\n## ã€5ã€‘\n\nè§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘\n  2: @Override\n  3: public void query(String sql) {\n  4: \t// è§£æ SQL ç±»å‹\n  5: \tint rs = ServerParse.parse(sql);\n  6: \tint sqlType = rs & 0xff;\n  7: \t\n  8: \tswitch (sqlType) {\n  9: \t//explain sql\n 10: \tcase ServerParse.EXPLAIN:\n 11: \t\tExplainHandler.handle(sql, c, rs >>> 8);\n 12: \t\tbreak;\n 13: \t// .... çœç•¥éƒ¨åˆ†case\n 14: \t\tbreak;\n 15: \tcase ServerParse.SELECT:\n 16: \t\tSelectHandler.handle(sql, c, rs >>> 8);\n 17: \t\tbreak;\n 18: \t// .... çœç•¥éƒ¨åˆ†case\n 19: \tdefault:\n 20: \t\tif(readOnly){\n 21: \t\t\tLOGGER.warn(new StringBuilder().append(\"User readonly:\").append(sql).toString());\n 22: \t\t\tc.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, \"User readonly\");\n 23: \t\t\tbreak;\n 24: \t\t}\n 25: \t\tc.execute(sql, rs & 0xff);\n 26: \t}\n 27: }\n 28: \n 29:\n 30: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘\n 31: public static int parse(String stmt) {\n 32: \tint length = stmt.length();\n 33: \t//FIX BUG FOR SQL SUCH AS /XXXX/SQL\n 34: \tint rt = -1;\n 35: \tfor (int i = 0; i < length; ++i) {\n 36: \t\tswitch (stmt.charAt(i)) {\n 37: \t\t// .... çœç•¥éƒ¨åˆ†case\t\t\tcase 'I':\n 38: \t\tcase 'i':\n 39: \t\t\trt = insertCheck(stmt, i);\n 40: \t\t\tif (rt != OTHER) {\n 41: \t\t\t\treturn rt;\n 42: \t\t\t}\n 43: \t\t\tcontinue;\n 44: \t\t\t// .... çœç•¥éƒ¨åˆ†case\n 45: \t\tcase 'S':\n 46: \t\tcase 's':\n 47: \t\t\trt = sCheck(stmt, i);\n 48: \t\t\tif (rt != OTHER) {\n 49: \t\t\t\treturn rt;\n 50: \t\t\t}\n 51: \t\t\tcontinue;\n 52: \t\t\t// .... çœç•¥éƒ¨åˆ†case\n 53: \t\tdefault:\n 54: \t\t\tcontinue;\n 55: \t\t}\n 56: \t}\n 57: \treturn OTHER;\n 58: }\n```\n\n## ğŸš€ã€6ã€‘ã€7ã€‘\n\nè§£æ Select SQL ç±»å‹ï¼Œåˆ†å‘åˆ°å¯¹åº”çš„é€»è¾‘ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘\n  2: public static void handle(String stmt, ServerConnection c, int offs) {\n  3: \tint offset = offs;\n  4: \tswitch (ServerParseSelect.parse(stmt, offs)) { // è§£æ Select SQL ç±»å‹\n  5: \tcase ServerParseSelect.VERSION_COMMENT: // select @@VERSION_COMMENT;\n  6: \t\tSelectVersionComment.response(c);\n  7: \t\tbreak;\n  8: \tcase ServerParseSelect.DATABASE: // select DATABASE();\n  9: \t\tSelectDatabase.response(c);\n 10: \t\tbreak;\n 11: \tcase ServerParseSelect.USER: // select CURRENT_USER();\n 12:         SelectUser.response(c);\n 13: \t\tbreak;\n 14: \tcase ServerParseSelect.VERSION: // select VERSION();\n 15: \t\tSelectVersion.response(c);\n 16: \t\tbreak;\n 17: \tcase ServerParseSelect.SESSION_INCREMENT: // select @@session.auto_increment_increment;\n 18: \t\tSessionIncrement.response(c);\n 19: \t\tbreak;\n 20: \tcase ServerParseSelect.SESSION_ISOLATION: // select @@session.tx_isolation;\n 21: \t\tSessionIsolation.response(c);\n 22: \t\tbreak;\n 23: \tcase ServerParseSelect.LAST_INSERT_ID: // select LAST_INSERT_ID();\n 24: \t\t// ....çœç•¥ä»£ç \n 25: \t\tbreak;\n 26: \tcase ServerParseSelect.IDENTITY: // select @@identity\n 27: \t\t// ....çœç•¥ä»£ç \n 28: \t\tbreak;\n 29:     case ServerParseSelect.SELECT_VAR_ALL: //\n 30:         SelectVariables.execute(c,stmt);\n 31:             break;\n 32:     case ServerParseSelect.SESSION_TX_READ_ONLY: //\n 33:         SelectTxReadOnly.response(c);\n 34: \t\t\tbreak;\n 35: \tdefault: // å…¶ä»–ï¼Œä¾‹å¦‚ select * from table\n 36: \t\tc.execute(stmt, ServerParse.SELECT);\n 37: \t}\n 38: }\n 39: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParseSelect.javaã€‘\n 40: public static int parse(String stmt, int offset) {\n 41: \tint i = offset;\n 42: \tfor (; i < stmt.length(); ++i) {\n 43: \t\tswitch (stmt.charAt(i)) {\n 44: \t\tcase ' ':\n 45: \t\t\tcontinue;\n 46: \t\tcase '/':\n 47: \t\tcase '#':\n 48: \t\t\ti = ParseUtil.comment(stmt, i);\n 49: \t\t\tcontinue;\n 50: \t\tcase '@':\n 51: \t\t\treturn select2Check(stmt, i);\n 52: \t\tcase 'D':\n 53: \t\tcase 'd':\n 54: \t\t\treturn databaseCheck(stmt, i);\n 55: \t\tcase 'L':\n 56: \t\tcase 'l':\n 57: \t\t\treturn lastInsertCheck(stmt, i);\n 58: \t\tcase 'U':\n 59: \t\tcase 'u':\n 60: \t\t\treturn userCheck(stmt, i);\n 61: \t\tcase 'C':\n 62: \t\tcase 'c':\n 63: \t\t\treturn currentUserCheck(stmt, i);\n 64: \t\tcase 'V':\n 65: \t\tcase 'v':\n 66: \t\t\treturn versionCheck(stmt, i);\n 67: \t\tdefault:\n 68: \t\t\treturn OTHER;\n 69: \t\t}\n 70: \t}\n 71: \treturn OTHER;\n 72: }\n```\n\n## ã€8ã€‘\n\næ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘\n  2: public class ServerConnection extends FrontendConnection {\n  3: \tpublic void execute(String sql, int type) {\n  4: \t\t// .... çœç•¥ä»£ç \n  5: \t\tSchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);\n  6: \t\tif (schema == null) {\n  7: \t\t\twriteErrMessage(ErrorCode.ERR_BAD_LOGICDB,\n  8: \t\t\t\t\t\"Unknown MyCAT Database '\" + db + \"'\");\n  9: \t\t\treturn;\n 10: \t\t}\n 11: \n 12: \t\t// .... çœç•¥ä»£ç \n 13: \n 14: \t\t// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL\n 15: \t\trouteEndExecuteSQL(sql, type, schema);\n 16: \t}\n 17: \t\n 18:     public void routeEndExecuteSQL(String sql, final int type, final SchemaConfig schema) {\n 19: \t\t// è·¯ç”±è®¡ç®—\n 20: \t\tRouteResultset rrs = null;\n 21: \t\ttry {\n 22: \t\t\trrs = MycatServer\n 23: \t\t\t\t\t.getInstance()\n 24: \t\t\t\t\t.getRouterservice()\n 25: \t\t\t\t\t.route(MycatServer.getInstance().getConfig().getSystem(),\n 26: \t\t\t\t\t\t\tschema, type, sql, this.charset, this);\n 27: \n 28: \t\t} catch (Exception e) {\n 29: \t\t\tStringBuilder s = new StringBuilder();\n 30: \t\t\tLOGGER.warn(s.append(this).append(sql).toString() + \" err:\" + e.toString(),e);\n 31: \t\t\tString msg = e.getMessage();\n 32: \t\t\twriteErrMessage(ErrorCode.ER_PARSE_ERROR, msg == null ? e.getClass().getSimpleName() : msg);\n 33: \t\t\treturn;\n 34: \t\t}\n 35: \n 36: \t\t// æ‰§è¡Œ SQL\n 37: \t\tif (rrs != null) {\n 38: \t\t\t// sessionæ‰§è¡Œ\n 39: \t\t\tsession.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);\n 40: \t\t}\n 41: \t\t\n 42:  \t}\n 43: \n 44: }\n```\n\n# 3. è·å¾—è·¯ç”±ç»“æœ\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ02è·å–è·¯ç”±ï¼‰.png)\n\n## ã€ 1 -  5 ã€‘\n\nè·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘\n  2: public RouteResultset route(SystemConfig sysconf, SchemaConfig schema,\n  3: \t\tint sqlType, String stmt, String charset, ServerConnection sc)\n  4: \t\tthrows SQLNonTransientException {\n  5: \tRouteResultset rrs = null;\n  6: \n  7: \t// SELECT ç±»å‹çš„SQL, æ£€æµ‹ç¼“å­˜æ˜¯å¦å­˜åœ¨\n  8: \tif (sqlType == ServerParse.SELECT) {\n  9: \t\tcacheKey = schema.getName() + stmt;\t\t\t\n 10: \t\trrs = (RouteResultset) sqlRouteCache.get(cacheKey);\n 11: \t\tif (rrs != null) {\n 12: \t\t\tcheckMigrateRule(schema.getName(),rrs,sqlType);\n 13: \t\t\treturn rrs;\n 14: \t\t\t}\n 15: \t\t}\n 16: \t}\n 17: \n 18: \t// .... çœç•¥ä»£ç \n 19: \tint hintLength = RouteService.isHintSql(stmt);\n 20: \tif(hintLength != -1){ // TODO å¾…è¯»ï¼šhint\n 21: \t\t// .... çœç•¥ä»£ç \n 22: \t\t}\n 23: \t} else {\n 24: \t\tstmt = stmt.trim();\n 25: \t\trrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,\n 26: \t\t\t\tcharset, sc, tableId2DataNodeCache);\n 27: \t}\n 28: \n 29: \t// è®°å½•æŸ¥è¯¢å‘½ä»¤è·¯ç”±ç»“æœç¼“å­˜\n 30: \tif (rrs != null && sqlType == ServerParse.SELECT && rrs.isCacheAble()) {\n 31: \t\tsqlRouteCache.putIfAbsent(cacheKey, rrs);\n 32: \t}\n 33: \t// .... çœç•¥ä»£ç \t\treturn rrs;\n 34: }\n 35: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘\n 36: @Override\n 37: public RouteResultset route(SystemConfig sysConfig, SchemaConfig schema, int sqlType, String origSQL,\n 38: \t\tString charset, ServerConnection sc, LayerCachePool cachePool) throws SQLNonTransientException {\n 39: \n 40: \t// .... çœç•¥ä»£ç \n 41: \n 42: \t// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥\n 43: \tif (beforeRouteProcess(schema, sqlType, origSQL, sc) ) {\n 44: \t\treturn null;\n 45: \t}\n 46: \n 47: \t// .... çœç•¥ä»£ç \n 48: \n 49: \t// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡\n 50: \tif (schema.isNoSharding() && ServerParse.SHOW != sqlType) {\n 51: \t\trrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);\n 52: \t} else {\n 53: \t\tRouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);\n 54: \t\tif (returnedSet == null) {\n 55: \t\t\trrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);\n 56: \t\t}\n 57: \t}\n 58: \n 59: \treturn rrs;\n 60: }\n```\n\nğŸš€ã€3ã€‘ç¬¬ 7 è‡³ 16 è¡Œ ï¼šå½“ Select SQL å­˜åœ¨è·¯ç”±ç»“æœç¼“å­˜æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜ã€‚\nğŸš€ã€6ã€‘ç¬¬ 29 è‡³ 32 è¡Œ ï¼šè®°å½• Select SQL è·¯ç”±ç»“æœåˆ°ç¼“å­˜ã€‚\n\n_**è·¯ç”±** è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚_\n\n# 4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ%20SQLï¼‰.png)\n\n## ã€ 1 - 8 ã€‘\n\nè·å¾— MySQL è¿æ¥ã€‚\n\n* PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚\n* PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚\n\n## ã€ 9 - 13 ã€‘\n\nå‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚\n\n# ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ\n\n![ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰.png)\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MySQLConnectionHandler.javaã€‘\n  2: @Override\n  3: protected void handleData(byte[] data) {\n  4: \tswitch (resultStatus) {\n  5: \tcase RESULT_STATUS_INIT:\n  6: \t\tswitch (data[4]) {\n  7: \t\tcase OkPacket.FIELD_COUNT:\n  8: \t\t\thandleOkPacket(data);\n  9: \t\t\tbreak;\n 10: \t\tcase ErrorPacket.FIELD_COUNT:\n 11: \t\t\thandleErrorPacket(data);\n 12: \t\t\tbreak;\n 13: \t\tcase RequestFilePacket.FIELD_COUNT:\n 14: \t\t\thandleRequestPacket(data);\n 15: \t\t\tbreak;\n 16: \t\tdefault: // åˆå§‹åŒ– header fields\n 17: \t\t\tresultStatus = RESULT_STATUS_HEADER;\n 18: \t\t\theader = data;\n 19: \t\t\tfields = new ArrayList<byte[]>((int) ByteUtil.readLength(data,\n 20: \t\t\t\t\t4));\n 21: \t\t}\n 22: \t\tbreak;\n 23: \tcase RESULT_STATUS_HEADER:\n 24: \t\tswitch (data[4]) {\n 25: \t\tcase ErrorPacket.FIELD_COUNT:\n 26: \t\t\tresultStatus = RESULT_STATUS_INIT;\n 27: \t\t\thandleErrorPacket(data);\n 28: \t\t\tbreak;\n 29: \t\tcase EOFPacket.FIELD_COUNT: // è§£æ fields ç»“æŸ\n 30: \t\t\tresultStatus = RESULT_STATUS_FIELD_EOF;\n 31: \t\t\thandleFieldEofPacket(data);\n 32: \t\t\tbreak;\n 33: \t\tdefault: // è§£æ fields\n 34: \t\t\tfields.add(data);\n 35: \t\t}\n 36: \t\tbreak;\n 37: \tcase RESULT_STATUS_FIELD_EOF:\n 38: \t\tswitch (data[4]) {\n 39: \t\tcase ErrorPacket.FIELD_COUNT:\n 40: \t\t\tresultStatus = RESULT_STATUS_INIT;\n 41: \t\t\thandleErrorPacket(data);\n 42: \t\t\tbreak;\n 43: \t\tcase EOFPacket.FIELD_COUNT: // è§£æ æ¯è¡Œè®°å½• ç»“æŸ\n 44: \t\t\tresultStatus = RESULT_STATUS_INIT;\n 45: \t\t\thandleRowEofPacket(data);\n 46: \t\t\tbreak;\n 47: \t\tdefault: // æ¯è¡Œè®°å½•\n 48: \t\t\thandleRowPacket(data);\n 49: \t\t}\n 50: \t\tbreak;\n 51: \tdefault:\n 52: \t\tthrow new RuntimeException(\"unknown status!\");\n 53: \t}\n 54: }\n```\n\n# 6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤\n\næµç¨‹åŸºæœ¬å’Œ [ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md) ç›¸åŒã€‚æˆ‘ä»¬å°±ä¸å¦å¤–æ–‡ç« è§£æã€‚\n\n\n","source":"_posts/MyCAT/2017_05_30_MyCATæºç åˆ†æâ€”â€”ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢.md","raw":"title: MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢\ndate: 2017-05-30\ntags:\ncategories: MyCAT\npermalink: Mycat/single-db-single-table-insert\n\n---\n\n>  åŸæ–‡åœ°å€ï¼š[MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1004-MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢.md)  \n> `MyCat-Server` **å¸¦æ³¨é‡Š**åœ°å€ ï¼šhttps://github.com/YunaiV/Mycat-Server  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blog**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL](#)\n- [3. è·å¾—è·¯ç”±ç»“æœ](#)\n- [4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL](#)\n- [5. å“åº”æ‰§è¡Œ SQL ç»“æœ](#)\n- [6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤](#)\n\n# 1. æ¦‚è¿°\n\n> å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚  \n> å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚  \n> å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚  \n> å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚\n\næœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚\n  \nğŸ˜‚å†…å®¹å’Œ [ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md) è¶…çº§ç›¸ä¼¼ï¼Œä¸€æ–¹é¢æœ¬èº«æµç¨‹åŸºæœ¬ç›¸åŒï¼Œå¦å¤–ä¸€æ–¹é¢æ–‡ç« ç»“æ„æ²¡æ‹†åˆ†å¥½ã€‚æˆ‘ä»¬ä½¿ç”¨ ğŸš€ æ ‡è®°å·®å¼‚çš„é€»è¾‘ã€‚\n\näº¤äº’å¦‚ä¸‹å›¾ï¼š\n\n![å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾.png)\n\næ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š\n\n1. æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚\n2. è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚\n3. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚\n4. å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚\n\næˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚\n\n# 2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL\n\n![ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰.png)\n\n## ã€1 - 2ã€‘\n\næ¥æ”¶**ä¸€æ¡** MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚\n\n## ã€3ã€‘\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘\n  2: public class FrontendCommandHandler implements NIOHandler {\n  3: \n  4:     @Override\n  5:     public void handle(byte[] data) {\n  6:     \n  7:         // .... çœç•¥éƒ¨åˆ†ä»£ç \n  8:         switch (data[4]) // \n  9:         {\n 10:             case MySQLPacket.COM_INIT_DB:\n 11:                 commands.doInitDB();\n 12:                 source.initDB(data);\n 13:                 break;\n 14:             case MySQLPacket.COM_QUERY: // æŸ¥è¯¢å‘½ä»¤\n 15:                 // è®¡æ•°æŸ¥è¯¢å‘½ä»¤\n 16:                 commands.doQuery();\n 17:                 // æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤\n 18:                 source.query(data);\n 19:                 break;\n 20:             case MySQLPacket.COM_PING:\n 21:                 commands.doPing();\n 22:                 source.ping();\n 23:                 break;\n 24:             // .... çœç•¥éƒ¨åˆ†case\n 25:         }\n 26:     }\n 27: \n 28: }\n```\n\n`INSERT`/`SELECT`/`UPDATE`/`DELETE` ç­‰ SQL å½’å±äº `MySQLPacket.COM_QUERY`ï¼Œè¯¦ç»†å¯è§ï¼š[ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -> æœåŠ¡å™¨ï¼‰ã€‹](http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-)ã€‚\n\n## ã€4ã€‘\n\nå°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘\n  2: public void query(byte[] data) {\n  3: \t// å–å¾—è¯­å¥\n  4: \tString sql = null;\t\t\n  5: \ttry {\n  6: \t\tMySQLMessage mm = new MySQLMessage(data);\n  7: \t\tmm.position(5);\n  8: \t\tsql = mm.readString(charset);\n  9: \t} catch (UnsupportedEncodingException e) {\n 10: \t\twriteErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, \"Unknown charset '\" + charset + \"'\");\n 11: \t\treturn;\n 12: \t}\t\t\n 13: \t// æ‰§è¡Œè¯­å¥\n 14: \tthis.query( sql );\n 15: }\n```\n\n## ã€5ã€‘\n\nè§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘\n  2: @Override\n  3: public void query(String sql) {\n  4: \t// è§£æ SQL ç±»å‹\n  5: \tint rs = ServerParse.parse(sql);\n  6: \tint sqlType = rs & 0xff;\n  7: \t\n  8: \tswitch (sqlType) {\n  9: \t//explain sql\n 10: \tcase ServerParse.EXPLAIN:\n 11: \t\tExplainHandler.handle(sql, c, rs >>> 8);\n 12: \t\tbreak;\n 13: \t// .... çœç•¥éƒ¨åˆ†case\n 14: \t\tbreak;\n 15: \tcase ServerParse.SELECT:\n 16: \t\tSelectHandler.handle(sql, c, rs >>> 8);\n 17: \t\tbreak;\n 18: \t// .... çœç•¥éƒ¨åˆ†case\n 19: \tdefault:\n 20: \t\tif(readOnly){\n 21: \t\t\tLOGGER.warn(new StringBuilder().append(\"User readonly:\").append(sql).toString());\n 22: \t\t\tc.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, \"User readonly\");\n 23: \t\t\tbreak;\n 24: \t\t}\n 25: \t\tc.execute(sql, rs & 0xff);\n 26: \t}\n 27: }\n 28: \n 29:\n 30: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘\n 31: public static int parse(String stmt) {\n 32: \tint length = stmt.length();\n 33: \t//FIX BUG FOR SQL SUCH AS /XXXX/SQL\n 34: \tint rt = -1;\n 35: \tfor (int i = 0; i < length; ++i) {\n 36: \t\tswitch (stmt.charAt(i)) {\n 37: \t\t// .... çœç•¥éƒ¨åˆ†case\t\t\tcase 'I':\n 38: \t\tcase 'i':\n 39: \t\t\trt = insertCheck(stmt, i);\n 40: \t\t\tif (rt != OTHER) {\n 41: \t\t\t\treturn rt;\n 42: \t\t\t}\n 43: \t\t\tcontinue;\n 44: \t\t\t// .... çœç•¥éƒ¨åˆ†case\n 45: \t\tcase 'S':\n 46: \t\tcase 's':\n 47: \t\t\trt = sCheck(stmt, i);\n 48: \t\t\tif (rt != OTHER) {\n 49: \t\t\t\treturn rt;\n 50: \t\t\t}\n 51: \t\t\tcontinue;\n 52: \t\t\t// .... çœç•¥éƒ¨åˆ†case\n 53: \t\tdefault:\n 54: \t\t\tcontinue;\n 55: \t\t}\n 56: \t}\n 57: \treturn OTHER;\n 58: }\n```\n\n## ğŸš€ã€6ã€‘ã€7ã€‘\n\nè§£æ Select SQL ç±»å‹ï¼Œåˆ†å‘åˆ°å¯¹åº”çš„é€»è¾‘ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘\n  2: public static void handle(String stmt, ServerConnection c, int offs) {\n  3: \tint offset = offs;\n  4: \tswitch (ServerParseSelect.parse(stmt, offs)) { // è§£æ Select SQL ç±»å‹\n  5: \tcase ServerParseSelect.VERSION_COMMENT: // select @@VERSION_COMMENT;\n  6: \t\tSelectVersionComment.response(c);\n  7: \t\tbreak;\n  8: \tcase ServerParseSelect.DATABASE: // select DATABASE();\n  9: \t\tSelectDatabase.response(c);\n 10: \t\tbreak;\n 11: \tcase ServerParseSelect.USER: // select CURRENT_USER();\n 12:         SelectUser.response(c);\n 13: \t\tbreak;\n 14: \tcase ServerParseSelect.VERSION: // select VERSION();\n 15: \t\tSelectVersion.response(c);\n 16: \t\tbreak;\n 17: \tcase ServerParseSelect.SESSION_INCREMENT: // select @@session.auto_increment_increment;\n 18: \t\tSessionIncrement.response(c);\n 19: \t\tbreak;\n 20: \tcase ServerParseSelect.SESSION_ISOLATION: // select @@session.tx_isolation;\n 21: \t\tSessionIsolation.response(c);\n 22: \t\tbreak;\n 23: \tcase ServerParseSelect.LAST_INSERT_ID: // select LAST_INSERT_ID();\n 24: \t\t// ....çœç•¥ä»£ç \n 25: \t\tbreak;\n 26: \tcase ServerParseSelect.IDENTITY: // select @@identity\n 27: \t\t// ....çœç•¥ä»£ç \n 28: \t\tbreak;\n 29:     case ServerParseSelect.SELECT_VAR_ALL: //\n 30:         SelectVariables.execute(c,stmt);\n 31:             break;\n 32:     case ServerParseSelect.SESSION_TX_READ_ONLY: //\n 33:         SelectTxReadOnly.response(c);\n 34: \t\t\tbreak;\n 35: \tdefault: // å…¶ä»–ï¼Œä¾‹å¦‚ select * from table\n 36: \t\tc.execute(stmt, ServerParse.SELECT);\n 37: \t}\n 38: }\n 39: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParseSelect.javaã€‘\n 40: public static int parse(String stmt, int offset) {\n 41: \tint i = offset;\n 42: \tfor (; i < stmt.length(); ++i) {\n 43: \t\tswitch (stmt.charAt(i)) {\n 44: \t\tcase ' ':\n 45: \t\t\tcontinue;\n 46: \t\tcase '/':\n 47: \t\tcase '#':\n 48: \t\t\ti = ParseUtil.comment(stmt, i);\n 49: \t\t\tcontinue;\n 50: \t\tcase '@':\n 51: \t\t\treturn select2Check(stmt, i);\n 52: \t\tcase 'D':\n 53: \t\tcase 'd':\n 54: \t\t\treturn databaseCheck(stmt, i);\n 55: \t\tcase 'L':\n 56: \t\tcase 'l':\n 57: \t\t\treturn lastInsertCheck(stmt, i);\n 58: \t\tcase 'U':\n 59: \t\tcase 'u':\n 60: \t\t\treturn userCheck(stmt, i);\n 61: \t\tcase 'C':\n 62: \t\tcase 'c':\n 63: \t\t\treturn currentUserCheck(stmt, i);\n 64: \t\tcase 'V':\n 65: \t\tcase 'v':\n 66: \t\t\treturn versionCheck(stmt, i);\n 67: \t\tdefault:\n 68: \t\t\treturn OTHER;\n 69: \t\t}\n 70: \t}\n 71: \treturn OTHER;\n 72: }\n```\n\n## ã€8ã€‘\n\næ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘\n  2: public class ServerConnection extends FrontendConnection {\n  3: \tpublic void execute(String sql, int type) {\n  4: \t\t// .... çœç•¥ä»£ç \n  5: \t\tSchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);\n  6: \t\tif (schema == null) {\n  7: \t\t\twriteErrMessage(ErrorCode.ERR_BAD_LOGICDB,\n  8: \t\t\t\t\t\"Unknown MyCAT Database '\" + db + \"'\");\n  9: \t\t\treturn;\n 10: \t\t}\n 11: \n 12: \t\t// .... çœç•¥ä»£ç \n 13: \n 14: \t\t// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL\n 15: \t\trouteEndExecuteSQL(sql, type, schema);\n 16: \t}\n 17: \t\n 18:     public void routeEndExecuteSQL(String sql, final int type, final SchemaConfig schema) {\n 19: \t\t// è·¯ç”±è®¡ç®—\n 20: \t\tRouteResultset rrs = null;\n 21: \t\ttry {\n 22: \t\t\trrs = MycatServer\n 23: \t\t\t\t\t.getInstance()\n 24: \t\t\t\t\t.getRouterservice()\n 25: \t\t\t\t\t.route(MycatServer.getInstance().getConfig().getSystem(),\n 26: \t\t\t\t\t\t\tschema, type, sql, this.charset, this);\n 27: \n 28: \t\t} catch (Exception e) {\n 29: \t\t\tStringBuilder s = new StringBuilder();\n 30: \t\t\tLOGGER.warn(s.append(this).append(sql).toString() + \" err:\" + e.toString(),e);\n 31: \t\t\tString msg = e.getMessage();\n 32: \t\t\twriteErrMessage(ErrorCode.ER_PARSE_ERROR, msg == null ? e.getClass().getSimpleName() : msg);\n 33: \t\t\treturn;\n 34: \t\t}\n 35: \n 36: \t\t// æ‰§è¡Œ SQL\n 37: \t\tif (rrs != null) {\n 38: \t\t\t// sessionæ‰§è¡Œ\n 39: \t\t\tsession.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);\n 40: \t\t}\n 41: \t\t\n 42:  \t}\n 43: \n 44: }\n```\n\n# 3. è·å¾—è·¯ç”±ç»“æœ\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ02è·å–è·¯ç”±ï¼‰.png)\n\n## ã€ 1 -  5 ã€‘\n\nè·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘\n  2: public RouteResultset route(SystemConfig sysconf, SchemaConfig schema,\n  3: \t\tint sqlType, String stmt, String charset, ServerConnection sc)\n  4: \t\tthrows SQLNonTransientException {\n  5: \tRouteResultset rrs = null;\n  6: \n  7: \t// SELECT ç±»å‹çš„SQL, æ£€æµ‹ç¼“å­˜æ˜¯å¦å­˜åœ¨\n  8: \tif (sqlType == ServerParse.SELECT) {\n  9: \t\tcacheKey = schema.getName() + stmt;\t\t\t\n 10: \t\trrs = (RouteResultset) sqlRouteCache.get(cacheKey);\n 11: \t\tif (rrs != null) {\n 12: \t\t\tcheckMigrateRule(schema.getName(),rrs,sqlType);\n 13: \t\t\treturn rrs;\n 14: \t\t\t}\n 15: \t\t}\n 16: \t}\n 17: \n 18: \t// .... çœç•¥ä»£ç \n 19: \tint hintLength = RouteService.isHintSql(stmt);\n 20: \tif(hintLength != -1){ // TODO å¾…è¯»ï¼šhint\n 21: \t\t// .... çœç•¥ä»£ç \n 22: \t\t}\n 23: \t} else {\n 24: \t\tstmt = stmt.trim();\n 25: \t\trrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,\n 26: \t\t\t\tcharset, sc, tableId2DataNodeCache);\n 27: \t}\n 28: \n 29: \t// è®°å½•æŸ¥è¯¢å‘½ä»¤è·¯ç”±ç»“æœç¼“å­˜\n 30: \tif (rrs != null && sqlType == ServerParse.SELECT && rrs.isCacheAble()) {\n 31: \t\tsqlRouteCache.putIfAbsent(cacheKey, rrs);\n 32: \t}\n 33: \t// .... çœç•¥ä»£ç \t\treturn rrs;\n 34: }\n 35: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘\n 36: @Override\n 37: public RouteResultset route(SystemConfig sysConfig, SchemaConfig schema, int sqlType, String origSQL,\n 38: \t\tString charset, ServerConnection sc, LayerCachePool cachePool) throws SQLNonTransientException {\n 39: \n 40: \t// .... çœç•¥ä»£ç \n 41: \n 42: \t// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥\n 43: \tif (beforeRouteProcess(schema, sqlType, origSQL, sc) ) {\n 44: \t\treturn null;\n 45: \t}\n 46: \n 47: \t// .... çœç•¥ä»£ç \n 48: \n 49: \t// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡\n 50: \tif (schema.isNoSharding() && ServerParse.SHOW != sqlType) {\n 51: \t\trrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);\n 52: \t} else {\n 53: \t\tRouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);\n 54: \t\tif (returnedSet == null) {\n 55: \t\t\trrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);\n 56: \t\t}\n 57: \t}\n 58: \n 59: \treturn rrs;\n 60: }\n```\n\nğŸš€ã€3ã€‘ç¬¬ 7 è‡³ 16 è¡Œ ï¼šå½“ Select SQL å­˜åœ¨è·¯ç”±ç»“æœç¼“å­˜æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜ã€‚\nğŸš€ã€6ã€‘ç¬¬ 29 è‡³ 32 è¡Œ ï¼šè®°å½• Select SQL è·¯ç”±ç»“æœåˆ°ç¼“å­˜ã€‚\n\n_**è·¯ç”±** è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚_\n\n# 4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL\n\n![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ%20SQLï¼‰.png)\n\n## ã€ 1 - 8 ã€‘\n\nè·å¾— MySQL è¿æ¥ã€‚\n\n* PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚\n* PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚\n\n## ã€ 9 - 13 ã€‘\n\nå‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚\n\n# ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ\n\n![ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰](https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰.png)\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MySQLConnectionHandler.javaã€‘\n  2: @Override\n  3: protected void handleData(byte[] data) {\n  4: \tswitch (resultStatus) {\n  5: \tcase RESULT_STATUS_INIT:\n  6: \t\tswitch (data[4]) {\n  7: \t\tcase OkPacket.FIELD_COUNT:\n  8: \t\t\thandleOkPacket(data);\n  9: \t\t\tbreak;\n 10: \t\tcase ErrorPacket.FIELD_COUNT:\n 11: \t\t\thandleErrorPacket(data);\n 12: \t\t\tbreak;\n 13: \t\tcase RequestFilePacket.FIELD_COUNT:\n 14: \t\t\thandleRequestPacket(data);\n 15: \t\t\tbreak;\n 16: \t\tdefault: // åˆå§‹åŒ– header fields\n 17: \t\t\tresultStatus = RESULT_STATUS_HEADER;\n 18: \t\t\theader = data;\n 19: \t\t\tfields = new ArrayList<byte[]>((int) ByteUtil.readLength(data,\n 20: \t\t\t\t\t4));\n 21: \t\t}\n 22: \t\tbreak;\n 23: \tcase RESULT_STATUS_HEADER:\n 24: \t\tswitch (data[4]) {\n 25: \t\tcase ErrorPacket.FIELD_COUNT:\n 26: \t\t\tresultStatus = RESULT_STATUS_INIT;\n 27: \t\t\thandleErrorPacket(data);\n 28: \t\t\tbreak;\n 29: \t\tcase EOFPacket.FIELD_COUNT: // è§£æ fields ç»“æŸ\n 30: \t\t\tresultStatus = RESULT_STATUS_FIELD_EOF;\n 31: \t\t\thandleFieldEofPacket(data);\n 32: \t\t\tbreak;\n 33: \t\tdefault: // è§£æ fields\n 34: \t\t\tfields.add(data);\n 35: \t\t}\n 36: \t\tbreak;\n 37: \tcase RESULT_STATUS_FIELD_EOF:\n 38: \t\tswitch (data[4]) {\n 39: \t\tcase ErrorPacket.FIELD_COUNT:\n 40: \t\t\tresultStatus = RESULT_STATUS_INIT;\n 41: \t\t\thandleErrorPacket(data);\n 42: \t\t\tbreak;\n 43: \t\tcase EOFPacket.FIELD_COUNT: // è§£æ æ¯è¡Œè®°å½• ç»“æŸ\n 44: \t\t\tresultStatus = RESULT_STATUS_INIT;\n 45: \t\t\thandleRowEofPacket(data);\n 46: \t\t\tbreak;\n 47: \t\tdefault: // æ¯è¡Œè®°å½•\n 48: \t\t\thandleRowPacket(data);\n 49: \t\t}\n 50: \t\tbreak;\n 51: \tdefault:\n 52: \t\tthrow new RuntimeException(\"unknown status!\");\n 53: \t}\n 54: }\n```\n\n# 6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤\n\næµç¨‹åŸºæœ¬å’Œ [ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹](https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md) ç›¸åŒã€‚æˆ‘ä»¬å°±ä¸å¦å¤–æ–‡ç« è§£æã€‚\n\n\n","slug":"Mycat/single-db-single-table-insert","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswz7000jak5d4ye8mk4a","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1004-MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢.md\" target=\"_blank\" rel=\"external\">MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢</a><br><code>MyCat-Server</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/Mycat-Server\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Mycat-Server</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blog\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blog</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</a></li>\n<li><a href=\"#\">3. è·å¾—è·¯ç”±ç»“æœ</a></li>\n<li><a href=\"#\">4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</a></li>\n<li><a href=\"#\">5. å“åº”æ‰§è¡Œ SQL ç»“æœ</a></li>\n<li><a href=\"#\">6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><blockquote>\n<p>å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚<br>å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚<br>å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚<br>å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚</p>\n</blockquote>\n<p>æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚</p>\n<p>ğŸ˜‚å†…å®¹å’Œ <a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md\" target=\"_blank\" rel=\"external\">ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a> è¶…çº§ç›¸ä¼¼ï¼Œä¸€æ–¹é¢æœ¬èº«æµç¨‹åŸºæœ¬ç›¸åŒï¼Œå¦å¤–ä¸€æ–¹é¢æ–‡ç« ç»“æ„æ²¡æ‹†åˆ†å¥½ã€‚æˆ‘ä»¬ä½¿ç”¨ ğŸš€ æ ‡è®°å·®å¼‚çš„é€»è¾‘ã€‚</p>\n<p>äº¤äº’å¦‚ä¸‹å›¾ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾.png\" alt=\"å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾\"></p>\n<p>æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚</li>\n<li>è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚</li>\n<li>è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚</li>\n<li>å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚</li>\n</ol>\n<p>æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚</p>\n<h1 id=\"2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL\"><a href=\"#2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL\" class=\"headerlink\" title=\"2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL\"></a>2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰\"></p>\n<h2 id=\"ã€1-2ã€‘\"><a href=\"#ã€1-2ã€‘\" class=\"headerlink\" title=\"ã€1 - 2ã€‘\"></a>ã€1 - 2ã€‘</h2><p>æ¥æ”¶<strong>ä¸€æ¡</strong> MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚</p>\n<h2 id=\"ã€3ã€‘\"><a href=\"#ã€3ã€‘\" class=\"headerlink\" title=\"ã€3ã€‘\"></a>ã€3ã€‘</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FrontendCommandHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">NIOHandler</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handle</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:     </div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) <span class=\"comment\">// </span></div><div class=\"line\"> <span class=\"number\">9</span>:         &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_INIT_DB:</div><div class=\"line\"><span class=\"number\">11</span>:                 commands.doInitDB();</div><div class=\"line\"><span class=\"number\">12</span>:                 source.initDB(data);</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_QUERY: <span class=\"comment\">// æŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"comment\">// è®¡æ•°æŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">16</span>:                 commands.doQuery();</div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">18</span>:                 source.query(data);</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_PING:</div><div class=\"line\"><span class=\"number\">21</span>:                 commands.doPing();</div><div class=\"line\"><span class=\"number\">22</span>:                 source.ping();</div><div class=\"line\"><span class=\"number\">23</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>: &#125;</div></pre></td></tr></table></figure>\n<p><code>INSERT</code>/<code>SELECT</code>/<code>UPDATE</code>/<code>DELETE</code> ç­‰ SQL å½’å±äº <code>MySQLPacket.COM_QUERY</code>ï¼Œè¯¦ç»†å¯è§ï¼š<a href=\"http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-\" target=\"_blank\" rel=\"external\">ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨ï¼‰ã€‹</a>ã€‚</p>\n<h2 id=\"ã€4ã€‘\"><a href=\"#ã€4ã€‘\" class=\"headerlink\" title=\"ã€4ã€‘\"></a>ã€4ã€‘</h2><p>å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">query</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"comment\">// å–å¾—è¯­å¥</span></div><div class=\"line\"> <span class=\"number\">4</span>: \tString sql = <span class=\"keyword\">null</span>;\t\t</div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">6</span>: \t\tMySQLMessage mm = <span class=\"keyword\">new</span> MySQLMessage(data);</div><div class=\"line\"> <span class=\"number\">7</span>: \t\tmm.position(<span class=\"number\">5</span>);</div><div class=\"line\"> <span class=\"number\">8</span>: \t\tsql = mm.readString(charset);</div><div class=\"line\"> <span class=\"number\">9</span>: \t&#125; <span class=\"keyword\">catch</span> (UnsupportedEncodingException e) &#123;</div><div class=\"line\"><span class=\"number\">10</span>: \t\twriteErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, <span class=\"string\">\"Unknown charset '\"</span> + charset + <span class=\"string\">\"'\"</span>);</div><div class=\"line\"><span class=\"number\">11</span>: \t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">12</span>: \t&#125;\t\t</div><div class=\"line\"><span class=\"number\">13</span>: \t<span class=\"comment\">// æ‰§è¡Œè¯­å¥</span></div><div class=\"line\"><span class=\"number\">14</span>: \t<span class=\"keyword\">this</span>.query( sql );</div><div class=\"line\"><span class=\"number\">15</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"ã€5ã€‘\"><a href=\"#ã€5ã€‘\" class=\"headerlink\" title=\"ã€5ã€‘\"></a>ã€5ã€‘</h2><p>è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">query</span><span class=\"params\">(String sql)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t<span class=\"comment\">// è§£æ SQL ç±»å‹</span></div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">int</span> rs = ServerParse.parse(sql);</div><div class=\"line\"> <span class=\"number\">6</span>: \t<span class=\"keyword\">int</span> sqlType = rs &amp; <span class=\"number\">0xff</span>;</div><div class=\"line\"> <span class=\"number\">7</span>: \t</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">switch</span> (sqlType) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>: \t<span class=\"comment\">//explain sql</span></div><div class=\"line\"><span class=\"number\">10</span>: \t<span class=\"keyword\">case</span> ServerParse.EXPLAIN:</div><div class=\"line\"><span class=\"number\">11</span>: \t\tExplainHandler.handle(sql, c, rs &gt;&gt;&gt; <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">12</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">13</span>: \t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">14</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">15</span>: \t<span class=\"keyword\">case</span> ServerParse.SELECT:</div><div class=\"line\"><span class=\"number\">16</span>: \t\tSelectHandler.handle(sql, c, rs &gt;&gt;&gt; <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">17</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">18</span>: \t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">19</span>: \t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">20</span>: \t\t<span class=\"keyword\">if</span>(readOnly)&#123;</div><div class=\"line\"><span class=\"number\">21</span>: \t\t\tLOGGER.warn(<span class=\"keyword\">new</span> StringBuilder().append(<span class=\"string\">\"User readonly:\"</span>).append(sql).toString());</div><div class=\"line\"><span class=\"number\">22</span>: \t\t\tc.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, <span class=\"string\">\"User readonly\"</span>);</div><div class=\"line\"><span class=\"number\">23</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">25</span>: \t\tc.execute(sql, rs &amp; <span class=\"number\">0xff</span>);</div><div class=\"line\"><span class=\"number\">26</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">27</span>: &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:</div><div class=\"line\"><span class=\"number\">30</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘</span></div><div class=\"line\"><span class=\"number\">31</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">parse</span><span class=\"params\">(String stmt)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">32</span>: \t<span class=\"keyword\">int</span> length = stmt.length();</div><div class=\"line\"><span class=\"number\">33</span>: \t<span class=\"comment\">//FIX BUG FOR SQL SUCH AS /XXXX/SQL</span></div><div class=\"line\"><span class=\"number\">34</span>: \t<span class=\"keyword\">int</span> rt = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">35</span>: \t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; length; ++i) &#123;</div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"keyword\">switch</span> (stmt.charAt(i)) &#123;</div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case\t\t\tcase 'I':</span></div><div class=\"line\"><span class=\"number\">38</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'i'</span>:</div><div class=\"line\"><span class=\"number\">39</span>: \t\t\trt = insertCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t\t<span class=\"keyword\">if</span> (rt != OTHER) &#123;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t\t\t<span class=\"keyword\">return</span> rt;</div><div class=\"line\"><span class=\"number\">42</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">45</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'S'</span>:</div><div class=\"line\"><span class=\"number\">46</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'s'</span>:</div><div class=\"line\"><span class=\"number\">47</span>: \t\t\trt = sCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">48</span>: \t\t\t<span class=\"keyword\">if</span> (rt != OTHER) &#123;</div><div class=\"line\"><span class=\"number\">49</span>: \t\t\t\t<span class=\"keyword\">return</span> rt;</div><div class=\"line\"><span class=\"number\">50</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">51</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">52</span>: \t\t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">53</span>: \t\t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">54</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">55</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">56</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">57</span>: \t<span class=\"keyword\">return</span> OTHER;</div><div class=\"line\"><span class=\"number\">58</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"ğŸš€ã€6ã€‘ã€7ã€‘\"><a href=\"#ğŸš€ã€6ã€‘ã€7ã€‘\" class=\"headerlink\" title=\"ğŸš€ã€6ã€‘ã€7ã€‘\"></a>ğŸš€ã€6ã€‘ã€7ã€‘</h2><p>è§£æ Select SQL ç±»å‹ï¼Œåˆ†å‘åˆ°å¯¹åº”çš„é€»è¾‘ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">handle</span><span class=\"params\">(String stmt, ServerConnection c, <span class=\"keyword\">int</span> offs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"keyword\">int</span> offset = offs;</div><div class=\"line\"> <span class=\"number\">4</span>: \t<span class=\"keyword\">switch</span> (ServerParseSelect.parse(stmt, offs)) &#123; <span class=\"comment\">// è§£æ Select SQL ç±»å‹</span></div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.VERSION_COMMENT: <span class=\"comment\">// select @@VERSION_COMMENT;</span></div><div class=\"line\"> <span class=\"number\">6</span>: \t\tSelectVersionComment.response(c);</div><div class=\"line\"> <span class=\"number\">7</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.DATABASE: <span class=\"comment\">// select DATABASE();</span></div><div class=\"line\"> <span class=\"number\">9</span>: \t\tSelectDatabase.response(c);</div><div class=\"line\"><span class=\"number\">10</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">11</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.USER: <span class=\"comment\">// select CURRENT_USER();</span></div><div class=\"line\"><span class=\"number\">12</span>:         SelectUser.response(c);</div><div class=\"line\"><span class=\"number\">13</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">14</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.VERSION: <span class=\"comment\">// select VERSION();</span></div><div class=\"line\"><span class=\"number\">15</span>: \t\tSelectVersion.response(c);</div><div class=\"line\"><span class=\"number\">16</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">17</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.SESSION_INCREMENT: <span class=\"comment\">// select @@session.auto_increment_increment;</span></div><div class=\"line\"><span class=\"number\">18</span>: \t\tSessionIncrement.response(c);</div><div class=\"line\"><span class=\"number\">19</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">20</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.SESSION_ISOLATION: <span class=\"comment\">// select @@session.tx_isolation;</span></div><div class=\"line\"><span class=\"number\">21</span>: \t\tSessionIsolation.response(c);</div><div class=\"line\"><span class=\"number\">22</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">23</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.LAST_INSERT_ID: <span class=\"comment\">// select LAST_INSERT_ID();</span></div><div class=\"line\"><span class=\"number\">24</span>: \t\t<span class=\"comment\">// ....çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">25</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">26</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.IDENTITY: <span class=\"comment\">// select @@identity</span></div><div class=\"line\"><span class=\"number\">27</span>: \t\t<span class=\"comment\">// ....çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">28</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"keyword\">case</span> ServerParseSelect.SELECT_VAR_ALL: <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">30</span>:         SelectVariables.execute(c,stmt);</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"keyword\">case</span> ServerParseSelect.SESSION_TX_READ_ONLY: <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">33</span>:         SelectTxReadOnly.response(c);</div><div class=\"line\"><span class=\"number\">34</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">35</span>: \t<span class=\"keyword\">default</span>: <span class=\"comment\">// å…¶ä»–ï¼Œä¾‹å¦‚ select * from table</span></div><div class=\"line\"><span class=\"number\">36</span>: \t\tc.execute(stmt, ServerParse.SELECT);</div><div class=\"line\"><span class=\"number\">37</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">38</span>: &#125;</div><div class=\"line\"><span class=\"number\">39</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParseSelect.javaã€‘</span></div><div class=\"line\"><span class=\"number\">40</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">parse</span><span class=\"params\">(String stmt, <span class=\"keyword\">int</span> offset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">41</span>: \t<span class=\"keyword\">int</span> i = offset;</div><div class=\"line\"><span class=\"number\">42</span>: \t<span class=\"keyword\">for</span> (; i &lt; stmt.length(); ++i) &#123;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t<span class=\"keyword\">switch</span> (stmt.charAt(i)) &#123;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">' '</span>:</div><div class=\"line\"><span class=\"number\">45</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">46</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'/'</span>:</div><div class=\"line\"><span class=\"number\">47</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'#'</span>:</div><div class=\"line\"><span class=\"number\">48</span>: \t\t\ti = ParseUtil.comment(stmt, i);</div><div class=\"line\"><span class=\"number\">49</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">50</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'@'</span>:</div><div class=\"line\"><span class=\"number\">51</span>: \t\t\t<span class=\"keyword\">return</span> select2Check(stmt, i);</div><div class=\"line\"><span class=\"number\">52</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'D'</span>:</div><div class=\"line\"><span class=\"number\">53</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'d'</span>:</div><div class=\"line\"><span class=\"number\">54</span>: \t\t\t<span class=\"keyword\">return</span> databaseCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">55</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'L'</span>:</div><div class=\"line\"><span class=\"number\">56</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'l'</span>:</div><div class=\"line\"><span class=\"number\">57</span>: \t\t\t<span class=\"keyword\">return</span> lastInsertCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">58</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'U'</span>:</div><div class=\"line\"><span class=\"number\">59</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'u'</span>:</div><div class=\"line\"><span class=\"number\">60</span>: \t\t\t<span class=\"keyword\">return</span> userCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">61</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'C'</span>:</div><div class=\"line\"><span class=\"number\">62</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'c'</span>:</div><div class=\"line\"><span class=\"number\">63</span>: \t\t\t<span class=\"keyword\">return</span> currentUserCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">64</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'V'</span>:</div><div class=\"line\"><span class=\"number\">65</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'v'</span>:</div><div class=\"line\"><span class=\"number\">66</span>: \t\t\t<span class=\"keyword\">return</span> versionCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">67</span>: \t\t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">68</span>: \t\t\t<span class=\"keyword\">return</span> OTHER;</div><div class=\"line\"><span class=\"number\">69</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">70</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">71</span>: \t<span class=\"keyword\">return</span> OTHER;</div><div class=\"line\"><span class=\"number\">72</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"ã€8ã€‘\"><a href=\"#ã€8ã€‘\" class=\"headerlink\" title=\"ã€8ã€‘\"></a>ã€8ã€‘</h2><p>æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ServerConnection</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrontendConnection</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(String sql, <span class=\"keyword\">int</span> type)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">5</span>: \t\tSchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);</div><div class=\"line\"> <span class=\"number\">6</span>: \t\t<span class=\"keyword\">if</span> (schema == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>: \t\t\twriteErrMessage(ErrorCode.ERR_BAD_LOGICDB,</div><div class=\"line\"> <span class=\"number\">8</span>: \t\t\t\t\t<span class=\"string\">\"Unknown MyCAT Database '\"</span> + db + <span class=\"string\">\"'\"</span>);</div><div class=\"line\"> <span class=\"number\">9</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">10</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>: \t\t<span class=\"comment\">// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">15</span>: \t\trouteEndExecuteSQL(sql, type, schema);</div><div class=\"line\"><span class=\"number\">16</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">17</span>: \t</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">routeEndExecuteSQL</span><span class=\"params\">(String sql, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> type, <span class=\"keyword\">final</span> SchemaConfig schema)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">19</span>: \t\t<span class=\"comment\">// è·¯ç”±è®¡ç®—</span></div><div class=\"line\"><span class=\"number\">20</span>: \t\tRouteResultset rrs = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">21</span>: \t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>: \t\t\trrs = MycatServer</div><div class=\"line\"><span class=\"number\">23</span>: \t\t\t\t\t.getInstance()</div><div class=\"line\"><span class=\"number\">24</span>: \t\t\t\t\t.getRouterservice()</div><div class=\"line\"><span class=\"number\">25</span>: \t\t\t\t\t.route(MycatServer.getInstance().getConfig().getSystem(),</div><div class=\"line\"><span class=\"number\">26</span>: \t\t\t\t\t\t\tschema, type, sql, <span class=\"keyword\">this</span>.charset, <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>: \t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">29</span>: \t\t\tStringBuilder s = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\"><span class=\"number\">30</span>: \t\t\tLOGGER.warn(s.append(<span class=\"keyword\">this</span>).append(sql).toString() + <span class=\"string\">\" err:\"</span> + e.toString(),e);</div><div class=\"line\"><span class=\"number\">31</span>: \t\t\tString msg = e.getMessage();</div><div class=\"line\"><span class=\"number\">32</span>: \t\t\twriteErrMessage(ErrorCode.ER_PARSE_ERROR, msg == <span class=\"keyword\">null</span> ? e.getClass().getSimpleName() : msg);</div><div class=\"line\"><span class=\"number\">33</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">34</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"comment\">// æ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"keyword\">if</span> (rrs != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">38</span>: \t\t\t<span class=\"comment\">// sessionæ‰§è¡Œ</span></div><div class=\"line\"><span class=\"number\">39</span>: \t\t\tsession.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t</div><div class=\"line\"><span class=\"number\">42</span>:  \t&#125;</div><div class=\"line\"><span class=\"number\">43</span>: </div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-è·å¾—è·¯ç”±ç»“æœ\"><a href=\"#3-è·å¾—è·¯ç”±ç»“æœ\" class=\"headerlink\" title=\"3. è·å¾—è·¯ç”±ç»“æœ\"></a>3. è·å¾—è·¯ç”±ç»“æœ</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ02è·å–è·¯ç”±ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰\"></p>\n<h2 id=\"ã€-1-5-ã€‘\"><a href=\"#ã€-1-5-ã€‘\" class=\"headerlink\" title=\"ã€ 1 -  5 ã€‘\"></a>ã€ 1 -  5 ã€‘</h2><p>è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RouteResultset <span class=\"title\">route</span><span class=\"params\">(SystemConfig sysconf, SchemaConfig schema,</span></span></div><div class=\"line\"> <span class=\"number\">3</span>: \t\t<span class=\"keyword\">int</span> sqlType, String stmt, String charset, ServerConnection sc)</div><div class=\"line\"> 4: \t\t<span class=\"keyword\">throws</span> SQLNonTransientException &#123;</div><div class=\"line\"> <span class=\"number\">5</span>: \tRouteResultset rrs = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>: \t<span class=\"comment\">// SELECT ç±»å‹çš„SQL, æ£€æµ‹ç¼“å­˜æ˜¯å¦å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">if</span> (sqlType == ServerParse.SELECT) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>: \t\tcacheKey = schema.getName() + stmt;\t\t\t</div><div class=\"line\"><span class=\"number\">10</span>: \t\trrs = (RouteResultset) sqlRouteCache.get(cacheKey);</div><div class=\"line\"><span class=\"number\">11</span>: \t\t<span class=\"keyword\">if</span> (rrs != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">12</span>: \t\t\tcheckMigrateRule(schema.getName(),rrs,sqlType);</div><div class=\"line\"><span class=\"number\">13</span>: \t\t\t<span class=\"keyword\">return</span> rrs;</div><div class=\"line\"><span class=\"number\">14</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">15</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">16</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">19</span>: \t<span class=\"keyword\">int</span> hintLength = RouteService.isHintSql(stmt);</div><div class=\"line\"><span class=\"number\">20</span>: \t<span class=\"keyword\">if</span>(hintLength != -<span class=\"number\">1</span>)&#123; <span class=\"comment\">// TODO å¾…è¯»ï¼šhint</span></div><div class=\"line\"><span class=\"number\">21</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">22</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">23</span>: \t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">24</span>: \t\tstmt = stmt.trim();</div><div class=\"line\"><span class=\"number\">25</span>: \t\trrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,</div><div class=\"line\"><span class=\"number\">26</span>: \t\t\t\tcharset, sc, tableId2DataNodeCache);</div><div class=\"line\"><span class=\"number\">27</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>: \t<span class=\"comment\">// è®°å½•æŸ¥è¯¢å‘½ä»¤è·¯ç”±ç»“æœç¼“å­˜</span></div><div class=\"line\"><span class=\"number\">30</span>: \t<span class=\"keyword\">if</span> (rrs != <span class=\"keyword\">null</span> &amp;&amp; sqlType == ServerParse.SELECT &amp;&amp; rrs.isCacheAble()) &#123;</div><div class=\"line\"><span class=\"number\">31</span>: \t\tsqlRouteCache.putIfAbsent(cacheKey, rrs);</div><div class=\"line\"><span class=\"number\">32</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">33</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç \t\treturn rrs;</span></div><div class=\"line\"><span class=\"number\">34</span>: &#125;</div><div class=\"line\"><span class=\"number\">35</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</span></div><div class=\"line\"><span class=\"number\">36</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">37</span>: <span class=\"function\"><span class=\"keyword\">public</span> RouteResultset <span class=\"title\">route</span><span class=\"params\">(SystemConfig sysConfig, SchemaConfig schema, <span class=\"keyword\">int</span> sqlType, String origSQL,</span></span></div><div class=\"line\"><span class=\"number\">38</span>: \t\tString charset, ServerConnection sc, LayerCachePool cachePool) <span class=\"keyword\">throws</span> SQLNonTransientException &#123;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>: \t<span class=\"comment\">// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥</span></div><div class=\"line\"><span class=\"number\">43</span>: \t<span class=\"keyword\">if</span> (beforeRouteProcess(schema, sqlType, origSQL, sc) ) &#123;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">45</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">46</span>: </div><div class=\"line\"><span class=\"number\">47</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">48</span>: </div><div class=\"line\"><span class=\"number\">49</span>: \t<span class=\"comment\">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡</span></div><div class=\"line\"><span class=\"number\">50</span>: \t<span class=\"keyword\">if</span> (schema.isNoSharding() &amp;&amp; ServerParse.SHOW != sqlType) &#123;</div><div class=\"line\"><span class=\"number\">51</span>: \t\trrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);</div><div class=\"line\"><span class=\"number\">52</span>: \t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">53</span>: \t\tRouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);</div><div class=\"line\"><span class=\"number\">54</span>: \t\t<span class=\"keyword\">if</span> (returnedSet == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">55</span>: \t\t\trrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);</div><div class=\"line\"><span class=\"number\">56</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">57</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>: \t<span class=\"keyword\">return</span> rrs;</div><div class=\"line\"><span class=\"number\">60</span>: &#125;</div></pre></td></tr></table></figure>\n<p>ğŸš€ã€3ã€‘ç¬¬ 7 è‡³ 16 è¡Œ ï¼šå½“ Select SQL å­˜åœ¨è·¯ç”±ç»“æœç¼“å­˜æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜ã€‚<br>ğŸš€ã€6ã€‘ç¬¬ 29 è‡³ 32 è¡Œ ï¼šè®°å½• Select SQL è·¯ç”±ç»“æœåˆ°ç¼“å­˜ã€‚</p>\n<p><em><strong>è·¯ç”±</strong> è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>\n<h1 id=\"4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL\"><a href=\"#4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL\" class=\"headerlink\" title=\"4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL\"></a>4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ%20SQLï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰\"></p>\n<h2 id=\"ã€-1-8-ã€‘\"><a href=\"#ã€-1-8-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 8 ã€‘\"></a>ã€ 1 - 8 ã€‘</h2><p>è·å¾— MySQL è¿æ¥ã€‚</p>\n<ul>\n<li>PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚</li>\n<li>PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚</li>\n</ul>\n<h2 id=\"ã€-9-13-ã€‘\"><a href=\"#ã€-9-13-ã€‘\" class=\"headerlink\" title=\"ã€ 9 - 13 ã€‘\"></a>ã€ 9 - 13 ã€‘</h2><p>å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚</p>\n<h1 id=\"ğŸš€-5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ\"><a href=\"#ğŸš€-5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ\" class=\"headerlink\" title=\"ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ\"></a>ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰\"></p>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MySQLConnectionHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">handleData</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t<span class=\"keyword\">switch</span> (resultStatus) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">case</span> RESULT_STATUS_INIT:</div><div class=\"line\"> <span class=\"number\">6</span>: \t\t<span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>: \t\t<span class=\"keyword\">case</span> OkPacket.FIELD_COUNT:</div><div class=\"line\"> <span class=\"number\">8</span>: \t\t\thandleOkPacket(data);</div><div class=\"line\"> <span class=\"number\">9</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">10</span>: \t\t<span class=\"keyword\">case</span> ErrorPacket.FIELD_COUNT:</div><div class=\"line\"><span class=\"number\">11</span>: \t\t\thandleErrorPacket(data);</div><div class=\"line\"><span class=\"number\">12</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">13</span>: \t\t<span class=\"keyword\">case</span> RequestFilePacket.FIELD_COUNT:</div><div class=\"line\"><span class=\"number\">14</span>: \t\t\thandleRequestPacket(data);</div><div class=\"line\"><span class=\"number\">15</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">16</span>: \t\t<span class=\"keyword\">default</span>: <span class=\"comment\">// åˆå§‹åŒ– header fields</span></div><div class=\"line\"><span class=\"number\">17</span>: \t\t\tresultStatus = RESULT_STATUS_HEADER;</div><div class=\"line\"><span class=\"number\">18</span>: \t\t\theader = data;</div><div class=\"line\"><span class=\"number\">19</span>: \t\t\tfields = <span class=\"keyword\">new</span> ArrayList&lt;<span class=\"keyword\">byte</span>[]&gt;((<span class=\"keyword\">int</span>) ByteUtil.readLength(data,</div><div class=\"line\"><span class=\"number\">20</span>: \t\t\t\t\t<span class=\"number\">4</span>));</div><div class=\"line\"><span class=\"number\">21</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">22</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">23</span>: \t<span class=\"keyword\">case</span> RESULT_STATUS_HEADER:</div><div class=\"line\"><span class=\"number\">24</span>: \t\t<span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) &#123;</div><div class=\"line\"><span class=\"number\">25</span>: \t\t<span class=\"keyword\">case</span> ErrorPacket.FIELD_COUNT:</div><div class=\"line\"><span class=\"number\">26</span>: \t\t\tresultStatus = RESULT_STATUS_INIT;</div><div class=\"line\"><span class=\"number\">27</span>: \t\t\thandleErrorPacket(data);</div><div class=\"line\"><span class=\"number\">28</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">29</span>: \t\t<span class=\"keyword\">case</span> EOFPacket.FIELD_COUNT: <span class=\"comment\">// è§£æ fields ç»“æŸ</span></div><div class=\"line\"><span class=\"number\">30</span>: \t\t\tresultStatus = RESULT_STATUS_FIELD_EOF;</div><div class=\"line\"><span class=\"number\">31</span>: \t\t\thandleFieldEofPacket(data);</div><div class=\"line\"><span class=\"number\">32</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">33</span>: \t\t<span class=\"keyword\">default</span>: <span class=\"comment\">// è§£æ fields</span></div><div class=\"line\"><span class=\"number\">34</span>: \t\t\tfields.add(data);</div><div class=\"line\"><span class=\"number\">35</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">37</span>: \t<span class=\"keyword\">case</span> RESULT_STATUS_FIELD_EOF:</div><div class=\"line\"><span class=\"number\">38</span>: \t\t<span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) &#123;</div><div class=\"line\"><span class=\"number\">39</span>: \t\t<span class=\"keyword\">case</span> ErrorPacket.FIELD_COUNT:</div><div class=\"line\"><span class=\"number\">40</span>: \t\t\tresultStatus = RESULT_STATUS_INIT;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t\thandleErrorPacket(data);</div><div class=\"line\"><span class=\"number\">42</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t<span class=\"keyword\">case</span> EOFPacket.FIELD_COUNT: <span class=\"comment\">// è§£æ æ¯è¡Œè®°å½• ç»“æŸ</span></div><div class=\"line\"><span class=\"number\">44</span>: \t\t\tresultStatus = RESULT_STATUS_INIT;</div><div class=\"line\"><span class=\"number\">45</span>: \t\t\thandleRowEofPacket(data);</div><div class=\"line\"><span class=\"number\">46</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">47</span>: \t\t<span class=\"keyword\">default</span>: <span class=\"comment\">// æ¯è¡Œè®°å½•</span></div><div class=\"line\"><span class=\"number\">48</span>: \t\t\thandleRowPacket(data);</div><div class=\"line\"><span class=\"number\">49</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">50</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">51</span>: \t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">52</span>: \t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">\"unknown status!\"</span>);</div><div class=\"line\"><span class=\"number\">53</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">54</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"6-å…¶ä»–-ï¼šæ›´æ–°-åˆ é™¤\"><a href=\"#6-å…¶ä»–-ï¼šæ›´æ–°-åˆ é™¤\" class=\"headerlink\" title=\"6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤\"></a>6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤</h1><p>æµç¨‹åŸºæœ¬å’Œ <a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md\" target=\"_blank\" rel=\"external\">ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a> ç›¸åŒã€‚æˆ‘ä»¬å°±ä¸å¦å¤–æ–‡ç« è§£æã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1004-MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢.md\" target=\"_blank\" rel=\"external\">MyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢</a><br><code>MyCat-Server</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/Mycat-Server\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Mycat-Server</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blog\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blog</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</a></li>\n<li><a href=\"#\">3. è·å¾—è·¯ç”±ç»“æœ</a></li>\n<li><a href=\"#\">4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</a></li>\n<li><a href=\"#\">5. å“åº”æ‰§è¡Œ SQL ç»“æœ</a></li>\n<li><a href=\"#\">6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><blockquote>\n<p>å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚<br>å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚<br>å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚<br>å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚</p>\n</blockquote>\n<p>æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚</p>\n<p>ğŸ˜‚å†…å®¹å’Œ <a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md\" target=\"_blank\" rel=\"external\">ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a> è¶…çº§ç›¸ä¼¼ï¼Œä¸€æ–¹é¢æœ¬èº«æµç¨‹åŸºæœ¬ç›¸åŒï¼Œå¦å¤–ä¸€æ–¹é¢æ–‡ç« ç»“æ„æ²¡æ‹†åˆ†å¥½ã€‚æˆ‘ä»¬ä½¿ç”¨ ğŸš€ æ ‡è®°å·®å¼‚çš„é€»è¾‘ã€‚</p>\n<p>äº¤äº’å¦‚ä¸‹å›¾ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾.png\" alt=\"å•åº“å•è¡¨æŸ¥è¯¢ç®€å›¾\"></p>\n<p>æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚</li>\n<li>è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚</li>\n<li>è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚</li>\n<li>å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚</li>\n</ol>\n<p>æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚</p>\n<h1 id=\"2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL\"><a href=\"#2-æ¥æ”¶è¯·æ±‚ï¼Œè§£æ-SQL\" class=\"headerlink\" title=\"2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL\"></a>2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ01ä¸»æµç¨‹ï¼‰\"></p>\n<h2 id=\"ã€1-2ã€‘\"><a href=\"#ã€1-2ã€‘\" class=\"headerlink\" title=\"ã€1 - 2ã€‘\"></a>ã€1 - 2ã€‘</h2><p>æ¥æ”¶<strong>ä¸€æ¡</strong> MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚</p>\n<h2 id=\"ã€3ã€‘\"><a href=\"#ã€3ã€‘\" class=\"headerlink\" title=\"ã€3ã€‘\"></a>ã€3ã€‘</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FrontendCommandHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">NIOHandler</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handle</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:     </div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// .... çœç•¥éƒ¨åˆ†ä»£ç </span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) <span class=\"comment\">// </span></div><div class=\"line\"> <span class=\"number\">9</span>:         &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_INIT_DB:</div><div class=\"line\"><span class=\"number\">11</span>:                 commands.doInitDB();</div><div class=\"line\"><span class=\"number\">12</span>:                 source.initDB(data);</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_QUERY: <span class=\"comment\">// æŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"comment\">// è®¡æ•°æŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">16</span>:                 commands.doQuery();</div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤</span></div><div class=\"line\"><span class=\"number\">18</span>:                 source.query(data);</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">case</span> MySQLPacket.COM_PING:</div><div class=\"line\"><span class=\"number\">21</span>:                 commands.doPing();</div><div class=\"line\"><span class=\"number\">22</span>:                 source.ping();</div><div class=\"line\"><span class=\"number\">23</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>: &#125;</div></pre></td></tr></table></figure>\n<p><code>INSERT</code>/<code>SELECT</code>/<code>UPDATE</code>/<code>DELETE</code> ç­‰ SQL å½’å±äº <code>MySQLPacket.COM_QUERY</code>ï¼Œè¯¦ç»†å¯è§ï¼š<a href=\"http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-\" target=\"_blank\" rel=\"external\">ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨ï¼‰ã€‹</a>ã€‚</p>\n<h2 id=\"ã€4ã€‘\"><a href=\"#ã€4ã€‘\" class=\"headerlink\" title=\"ã€4ã€‘\"></a>ã€4ã€‘</h2><p>å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">query</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"comment\">// å–å¾—è¯­å¥</span></div><div class=\"line\"> <span class=\"number\">4</span>: \tString sql = <span class=\"keyword\">null</span>;\t\t</div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">6</span>: \t\tMySQLMessage mm = <span class=\"keyword\">new</span> MySQLMessage(data);</div><div class=\"line\"> <span class=\"number\">7</span>: \t\tmm.position(<span class=\"number\">5</span>);</div><div class=\"line\"> <span class=\"number\">8</span>: \t\tsql = mm.readString(charset);</div><div class=\"line\"> <span class=\"number\">9</span>: \t&#125; <span class=\"keyword\">catch</span> (UnsupportedEncodingException e) &#123;</div><div class=\"line\"><span class=\"number\">10</span>: \t\twriteErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, <span class=\"string\">\"Unknown charset '\"</span> + charset + <span class=\"string\">\"'\"</span>);</div><div class=\"line\"><span class=\"number\">11</span>: \t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">12</span>: \t&#125;\t\t</div><div class=\"line\"><span class=\"number\">13</span>: \t<span class=\"comment\">// æ‰§è¡Œè¯­å¥</span></div><div class=\"line\"><span class=\"number\">14</span>: \t<span class=\"keyword\">this</span>.query( sql );</div><div class=\"line\"><span class=\"number\">15</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"ã€5ã€‘\"><a href=\"#ã€5ã€‘\" class=\"headerlink\" title=\"ã€5ã€‘\"></a>ã€5ã€‘</h2><p>è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">query</span><span class=\"params\">(String sql)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t<span class=\"comment\">// è§£æ SQL ç±»å‹</span></div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">int</span> rs = ServerParse.parse(sql);</div><div class=\"line\"> <span class=\"number\">6</span>: \t<span class=\"keyword\">int</span> sqlType = rs &amp; <span class=\"number\">0xff</span>;</div><div class=\"line\"> <span class=\"number\">7</span>: \t</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">switch</span> (sqlType) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>: \t<span class=\"comment\">//explain sql</span></div><div class=\"line\"><span class=\"number\">10</span>: \t<span class=\"keyword\">case</span> ServerParse.EXPLAIN:</div><div class=\"line\"><span class=\"number\">11</span>: \t\tExplainHandler.handle(sql, c, rs &gt;&gt;&gt; <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">12</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">13</span>: \t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">14</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">15</span>: \t<span class=\"keyword\">case</span> ServerParse.SELECT:</div><div class=\"line\"><span class=\"number\">16</span>: \t\tSelectHandler.handle(sql, c, rs &gt;&gt;&gt; <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">17</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">18</span>: \t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">19</span>: \t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">20</span>: \t\t<span class=\"keyword\">if</span>(readOnly)&#123;</div><div class=\"line\"><span class=\"number\">21</span>: \t\t\tLOGGER.warn(<span class=\"keyword\">new</span> StringBuilder().append(<span class=\"string\">\"User readonly:\"</span>).append(sql).toString());</div><div class=\"line\"><span class=\"number\">22</span>: \t\t\tc.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, <span class=\"string\">\"User readonly\"</span>);</div><div class=\"line\"><span class=\"number\">23</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">25</span>: \t\tc.execute(sql, rs &amp; <span class=\"number\">0xff</span>);</div><div class=\"line\"><span class=\"number\">26</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">27</span>: &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:</div><div class=\"line\"><span class=\"number\">30</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘</span></div><div class=\"line\"><span class=\"number\">31</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">parse</span><span class=\"params\">(String stmt)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">32</span>: \t<span class=\"keyword\">int</span> length = stmt.length();</div><div class=\"line\"><span class=\"number\">33</span>: \t<span class=\"comment\">//FIX BUG FOR SQL SUCH AS /XXXX/SQL</span></div><div class=\"line\"><span class=\"number\">34</span>: \t<span class=\"keyword\">int</span> rt = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">35</span>: \t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; length; ++i) &#123;</div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"keyword\">switch</span> (stmt.charAt(i)) &#123;</div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case\t\t\tcase 'I':</span></div><div class=\"line\"><span class=\"number\">38</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'i'</span>:</div><div class=\"line\"><span class=\"number\">39</span>: \t\t\trt = insertCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t\t<span class=\"keyword\">if</span> (rt != OTHER) &#123;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t\t\t<span class=\"keyword\">return</span> rt;</div><div class=\"line\"><span class=\"number\">42</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">45</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'S'</span>:</div><div class=\"line\"><span class=\"number\">46</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'s'</span>:</div><div class=\"line\"><span class=\"number\">47</span>: \t\t\trt = sCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">48</span>: \t\t\t<span class=\"keyword\">if</span> (rt != OTHER) &#123;</div><div class=\"line\"><span class=\"number\">49</span>: \t\t\t\t<span class=\"keyword\">return</span> rt;</div><div class=\"line\"><span class=\"number\">50</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">51</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">52</span>: \t\t\t<span class=\"comment\">// .... çœç•¥éƒ¨åˆ†case</span></div><div class=\"line\"><span class=\"number\">53</span>: \t\t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">54</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">55</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">56</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">57</span>: \t<span class=\"keyword\">return</span> OTHER;</div><div class=\"line\"><span class=\"number\">58</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"ğŸš€ã€6ã€‘ã€7ã€‘\"><a href=\"#ğŸš€ã€6ã€‘ã€7ã€‘\" class=\"headerlink\" title=\"ğŸš€ã€6ã€‘ã€7ã€‘\"></a>ğŸš€ã€6ã€‘ã€7ã€‘</h2><p>è§£æ Select SQL ç±»å‹ï¼Œåˆ†å‘åˆ°å¯¹åº”çš„é€»è¾‘ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">handle</span><span class=\"params\">(String stmt, ServerConnection c, <span class=\"keyword\">int</span> offs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"keyword\">int</span> offset = offs;</div><div class=\"line\"> <span class=\"number\">4</span>: \t<span class=\"keyword\">switch</span> (ServerParseSelect.parse(stmt, offs)) &#123; <span class=\"comment\">// è§£æ Select SQL ç±»å‹</span></div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.VERSION_COMMENT: <span class=\"comment\">// select @@VERSION_COMMENT;</span></div><div class=\"line\"> <span class=\"number\">6</span>: \t\tSelectVersionComment.response(c);</div><div class=\"line\"> <span class=\"number\">7</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.DATABASE: <span class=\"comment\">// select DATABASE();</span></div><div class=\"line\"> <span class=\"number\">9</span>: \t\tSelectDatabase.response(c);</div><div class=\"line\"><span class=\"number\">10</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">11</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.USER: <span class=\"comment\">// select CURRENT_USER();</span></div><div class=\"line\"><span class=\"number\">12</span>:         SelectUser.response(c);</div><div class=\"line\"><span class=\"number\">13</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">14</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.VERSION: <span class=\"comment\">// select VERSION();</span></div><div class=\"line\"><span class=\"number\">15</span>: \t\tSelectVersion.response(c);</div><div class=\"line\"><span class=\"number\">16</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">17</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.SESSION_INCREMENT: <span class=\"comment\">// select @@session.auto_increment_increment;</span></div><div class=\"line\"><span class=\"number\">18</span>: \t\tSessionIncrement.response(c);</div><div class=\"line\"><span class=\"number\">19</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">20</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.SESSION_ISOLATION: <span class=\"comment\">// select @@session.tx_isolation;</span></div><div class=\"line\"><span class=\"number\">21</span>: \t\tSessionIsolation.response(c);</div><div class=\"line\"><span class=\"number\">22</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">23</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.LAST_INSERT_ID: <span class=\"comment\">// select LAST_INSERT_ID();</span></div><div class=\"line\"><span class=\"number\">24</span>: \t\t<span class=\"comment\">// ....çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">25</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">26</span>: \t<span class=\"keyword\">case</span> ServerParseSelect.IDENTITY: <span class=\"comment\">// select @@identity</span></div><div class=\"line\"><span class=\"number\">27</span>: \t\t<span class=\"comment\">// ....çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">28</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"keyword\">case</span> ServerParseSelect.SELECT_VAR_ALL: <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">30</span>:         SelectVariables.execute(c,stmt);</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"keyword\">case</span> ServerParseSelect.SESSION_TX_READ_ONLY: <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">33</span>:         SelectTxReadOnly.response(c);</div><div class=\"line\"><span class=\"number\">34</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">35</span>: \t<span class=\"keyword\">default</span>: <span class=\"comment\">// å…¶ä»–ï¼Œä¾‹å¦‚ select * from table</span></div><div class=\"line\"><span class=\"number\">36</span>: \t\tc.execute(stmt, ServerParse.SELECT);</div><div class=\"line\"><span class=\"number\">37</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">38</span>: &#125;</div><div class=\"line\"><span class=\"number\">39</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParseSelect.javaã€‘</span></div><div class=\"line\"><span class=\"number\">40</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">parse</span><span class=\"params\">(String stmt, <span class=\"keyword\">int</span> offset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">41</span>: \t<span class=\"keyword\">int</span> i = offset;</div><div class=\"line\"><span class=\"number\">42</span>: \t<span class=\"keyword\">for</span> (; i &lt; stmt.length(); ++i) &#123;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t<span class=\"keyword\">switch</span> (stmt.charAt(i)) &#123;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">' '</span>:</div><div class=\"line\"><span class=\"number\">45</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">46</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'/'</span>:</div><div class=\"line\"><span class=\"number\">47</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'#'</span>:</div><div class=\"line\"><span class=\"number\">48</span>: \t\t\ti = ParseUtil.comment(stmt, i);</div><div class=\"line\"><span class=\"number\">49</span>: \t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">50</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'@'</span>:</div><div class=\"line\"><span class=\"number\">51</span>: \t\t\t<span class=\"keyword\">return</span> select2Check(stmt, i);</div><div class=\"line\"><span class=\"number\">52</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'D'</span>:</div><div class=\"line\"><span class=\"number\">53</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'d'</span>:</div><div class=\"line\"><span class=\"number\">54</span>: \t\t\t<span class=\"keyword\">return</span> databaseCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">55</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'L'</span>:</div><div class=\"line\"><span class=\"number\">56</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'l'</span>:</div><div class=\"line\"><span class=\"number\">57</span>: \t\t\t<span class=\"keyword\">return</span> lastInsertCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">58</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'U'</span>:</div><div class=\"line\"><span class=\"number\">59</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'u'</span>:</div><div class=\"line\"><span class=\"number\">60</span>: \t\t\t<span class=\"keyword\">return</span> userCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">61</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'C'</span>:</div><div class=\"line\"><span class=\"number\">62</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'c'</span>:</div><div class=\"line\"><span class=\"number\">63</span>: \t\t\t<span class=\"keyword\">return</span> currentUserCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">64</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'V'</span>:</div><div class=\"line\"><span class=\"number\">65</span>: \t\t<span class=\"keyword\">case</span> <span class=\"string\">'v'</span>:</div><div class=\"line\"><span class=\"number\">66</span>: \t\t\t<span class=\"keyword\">return</span> versionCheck(stmt, i);</div><div class=\"line\"><span class=\"number\">67</span>: \t\t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">68</span>: \t\t\t<span class=\"keyword\">return</span> OTHER;</div><div class=\"line\"><span class=\"number\">69</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">70</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">71</span>: \t<span class=\"keyword\">return</span> OTHER;</div><div class=\"line\"><span class=\"number\">72</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"ã€8ã€‘\"><a href=\"#ã€8ã€‘\" class=\"headerlink\" title=\"ã€8ã€‘\"></a>ã€8ã€‘</h2><p>æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ServerConnection</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrontendConnection</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(String sql, <span class=\"keyword\">int</span> type)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">5</span>: \t\tSchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);</div><div class=\"line\"> <span class=\"number\">6</span>: \t\t<span class=\"keyword\">if</span> (schema == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>: \t\t\twriteErrMessage(ErrorCode.ERR_BAD_LOGICDB,</div><div class=\"line\"> <span class=\"number\">8</span>: \t\t\t\t\t<span class=\"string\">\"Unknown MyCAT Database '\"</span> + db + <span class=\"string\">\"'\"</span>);</div><div class=\"line\"> <span class=\"number\">9</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">10</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>: \t\t<span class=\"comment\">// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">15</span>: \t\trouteEndExecuteSQL(sql, type, schema);</div><div class=\"line\"><span class=\"number\">16</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">17</span>: \t</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">routeEndExecuteSQL</span><span class=\"params\">(String sql, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> type, <span class=\"keyword\">final</span> SchemaConfig schema)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">19</span>: \t\t<span class=\"comment\">// è·¯ç”±è®¡ç®—</span></div><div class=\"line\"><span class=\"number\">20</span>: \t\tRouteResultset rrs = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">21</span>: \t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>: \t\t\trrs = MycatServer</div><div class=\"line\"><span class=\"number\">23</span>: \t\t\t\t\t.getInstance()</div><div class=\"line\"><span class=\"number\">24</span>: \t\t\t\t\t.getRouterservice()</div><div class=\"line\"><span class=\"number\">25</span>: \t\t\t\t\t.route(MycatServer.getInstance().getConfig().getSystem(),</div><div class=\"line\"><span class=\"number\">26</span>: \t\t\t\t\t\t\tschema, type, sql, <span class=\"keyword\">this</span>.charset, <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>: \t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">29</span>: \t\t\tStringBuilder s = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\"><span class=\"number\">30</span>: \t\t\tLOGGER.warn(s.append(<span class=\"keyword\">this</span>).append(sql).toString() + <span class=\"string\">\" err:\"</span> + e.toString(),e);</div><div class=\"line\"><span class=\"number\">31</span>: \t\t\tString msg = e.getMessage();</div><div class=\"line\"><span class=\"number\">32</span>: \t\t\twriteErrMessage(ErrorCode.ER_PARSE_ERROR, msg == <span class=\"keyword\">null</span> ? e.getClass().getSimpleName() : msg);</div><div class=\"line\"><span class=\"number\">33</span>: \t\t\t<span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">34</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"comment\">// æ‰§è¡Œ SQL</span></div><div class=\"line\"><span class=\"number\">37</span>: \t\t<span class=\"keyword\">if</span> (rrs != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">38</span>: \t\t\t<span class=\"comment\">// sessionæ‰§è¡Œ</span></div><div class=\"line\"><span class=\"number\">39</span>: \t\t\tsession.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);</div><div class=\"line\"><span class=\"number\">40</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t</div><div class=\"line\"><span class=\"number\">42</span>:  \t&#125;</div><div class=\"line\"><span class=\"number\">43</span>: </div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-è·å¾—è·¯ç”±ç»“æœ\"><a href=\"#3-è·å¾—è·¯ç”±ç»“æœ\" class=\"headerlink\" title=\"3. è·å¾—è·¯ç”±ç»“æœ\"></a>3. è·å¾—è·¯ç”±ç»“æœ</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ02è·å–è·¯ç”±ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰\"></p>\n<h2 id=\"ã€-1-5-ã€‘\"><a href=\"#ã€-1-5-ã€‘\" class=\"headerlink\" title=\"ã€ 1 -  5 ã€‘\"></a>ã€ 1 -  5 ã€‘</h2><p>è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SelectHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RouteResultset <span class=\"title\">route</span><span class=\"params\">(SystemConfig sysconf, SchemaConfig schema,</span></span></div><div class=\"line\"> <span class=\"number\">3</span>: \t\t<span class=\"keyword\">int</span> sqlType, String stmt, String charset, ServerConnection sc)</div><div class=\"line\"> 4: \t\t<span class=\"keyword\">throws</span> SQLNonTransientException &#123;</div><div class=\"line\"> <span class=\"number\">5</span>: \tRouteResultset rrs = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>: \t<span class=\"comment\">// SELECT ç±»å‹çš„SQL, æ£€æµ‹ç¼“å­˜æ˜¯å¦å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">8</span>: \t<span class=\"keyword\">if</span> (sqlType == ServerParse.SELECT) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>: \t\tcacheKey = schema.getName() + stmt;\t\t\t</div><div class=\"line\"><span class=\"number\">10</span>: \t\trrs = (RouteResultset) sqlRouteCache.get(cacheKey);</div><div class=\"line\"><span class=\"number\">11</span>: \t\t<span class=\"keyword\">if</span> (rrs != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">12</span>: \t\t\tcheckMigrateRule(schema.getName(),rrs,sqlType);</div><div class=\"line\"><span class=\"number\">13</span>: \t\t\t<span class=\"keyword\">return</span> rrs;</div><div class=\"line\"><span class=\"number\">14</span>: \t\t\t&#125;</div><div class=\"line\"><span class=\"number\">15</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">16</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">19</span>: \t<span class=\"keyword\">int</span> hintLength = RouteService.isHintSql(stmt);</div><div class=\"line\"><span class=\"number\">20</span>: \t<span class=\"keyword\">if</span>(hintLength != -<span class=\"number\">1</span>)&#123; <span class=\"comment\">// TODO å¾…è¯»ï¼šhint</span></div><div class=\"line\"><span class=\"number\">21</span>: \t\t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">22</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">23</span>: \t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">24</span>: \t\tstmt = stmt.trim();</div><div class=\"line\"><span class=\"number\">25</span>: \t\trrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,</div><div class=\"line\"><span class=\"number\">26</span>: \t\t\t\tcharset, sc, tableId2DataNodeCache);</div><div class=\"line\"><span class=\"number\">27</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>: \t<span class=\"comment\">// è®°å½•æŸ¥è¯¢å‘½ä»¤è·¯ç”±ç»“æœç¼“å­˜</span></div><div class=\"line\"><span class=\"number\">30</span>: \t<span class=\"keyword\">if</span> (rrs != <span class=\"keyword\">null</span> &amp;&amp; sqlType == ServerParse.SELECT &amp;&amp; rrs.isCacheAble()) &#123;</div><div class=\"line\"><span class=\"number\">31</span>: \t\tsqlRouteCache.putIfAbsent(cacheKey, rrs);</div><div class=\"line\"><span class=\"number\">32</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">33</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç \t\treturn rrs;</span></div><div class=\"line\"><span class=\"number\">34</span>: &#125;</div><div class=\"line\"><span class=\"number\">35</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘</span></div><div class=\"line\"><span class=\"number\">36</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">37</span>: <span class=\"function\"><span class=\"keyword\">public</span> RouteResultset <span class=\"title\">route</span><span class=\"params\">(SystemConfig sysConfig, SchemaConfig schema, <span class=\"keyword\">int</span> sqlType, String origSQL,</span></span></div><div class=\"line\"><span class=\"number\">38</span>: \t\tString charset, ServerConnection sc, LayerCachePool cachePool) <span class=\"keyword\">throws</span> SQLNonTransientException &#123;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>: \t<span class=\"comment\">// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥</span></div><div class=\"line\"><span class=\"number\">43</span>: \t<span class=\"keyword\">if</span> (beforeRouteProcess(schema, sqlType, origSQL, sc) ) &#123;</div><div class=\"line\"><span class=\"number\">44</span>: \t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">45</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">46</span>: </div><div class=\"line\"><span class=\"number\">47</span>: \t<span class=\"comment\">// .... çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">48</span>: </div><div class=\"line\"><span class=\"number\">49</span>: \t<span class=\"comment\">// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡</span></div><div class=\"line\"><span class=\"number\">50</span>: \t<span class=\"keyword\">if</span> (schema.isNoSharding() &amp;&amp; ServerParse.SHOW != sqlType) &#123;</div><div class=\"line\"><span class=\"number\">51</span>: \t\trrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);</div><div class=\"line\"><span class=\"number\">52</span>: \t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">53</span>: \t\tRouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);</div><div class=\"line\"><span class=\"number\">54</span>: \t\t<span class=\"keyword\">if</span> (returnedSet == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">55</span>: \t\t\trrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);</div><div class=\"line\"><span class=\"number\">56</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">57</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>: \t<span class=\"keyword\">return</span> rrs;</div><div class=\"line\"><span class=\"number\">60</span>: &#125;</div></pre></td></tr></table></figure>\n<p>ğŸš€ã€3ã€‘ç¬¬ 7 è‡³ 16 è¡Œ ï¼šå½“ Select SQL å­˜åœ¨è·¯ç”±ç»“æœç¼“å­˜æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜ã€‚<br>ğŸš€ã€6ã€‘ç¬¬ 29 è‡³ 32 è¡Œ ï¼šè®°å½• Select SQL è·¯ç”±ç»“æœåˆ°ç¼“å­˜ã€‚</p>\n<p><em><strong>è·¯ç”±</strong> è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚</em></p>\n<h1 id=\"4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL\"><a href=\"#4-è·å¾—-MySQL-è¿æ¥ï¼Œæ‰§è¡Œ-SQL\" class=\"headerlink\" title=\"4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL\"></a>4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1003/ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ%20SQLï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰\"></p>\n<h2 id=\"ã€-1-8-ã€‘\"><a href=\"#ã€-1-8-ã€‘\" class=\"headerlink\" title=\"ã€ 1 - 8 ã€‘\"></a>ã€ 1 - 8 ã€‘</h2><p>è·å¾— MySQL è¿æ¥ã€‚</p>\n<ul>\n<li>PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚</li>\n<li>PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚</li>\n</ul>\n<h2 id=\"ã€-9-13-ã€‘\"><a href=\"#ã€-9-13-ã€‘\" class=\"headerlink\" title=\"ã€ 9 - 13 ã€‘\"></a>ã€ 9 - 13 ã€‘</h2><p>å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚</p>\n<h1 id=\"ğŸš€-5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ\"><a href=\"#ğŸš€-5-å“åº”æ‰§è¡Œ-SQL-ç»“æœ\" class=\"headerlink\" title=\"ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ\"></a>ğŸš€ 5. å“åº”æ‰§è¡Œ SQL ç»“æœ</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/Database/MyCAT/images/1004/ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰.png\" alt=\"ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰\"></p>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MySQLConnectionHandler.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">handleData</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] data)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>: \t<span class=\"keyword\">switch</span> (resultStatus) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>: \t<span class=\"keyword\">case</span> RESULT_STATUS_INIT:</div><div class=\"line\"> <span class=\"number\">6</span>: \t\t<span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>: \t\t<span class=\"keyword\">case</span> OkPacket.FIELD_COUNT:</div><div class=\"line\"> <span class=\"number\">8</span>: \t\t\thandleOkPacket(data);</div><div class=\"line\"> <span class=\"number\">9</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">10</span>: \t\t<span class=\"keyword\">case</span> ErrorPacket.FIELD_COUNT:</div><div class=\"line\"><span class=\"number\">11</span>: \t\t\thandleErrorPacket(data);</div><div class=\"line\"><span class=\"number\">12</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">13</span>: \t\t<span class=\"keyword\">case</span> RequestFilePacket.FIELD_COUNT:</div><div class=\"line\"><span class=\"number\">14</span>: \t\t\thandleRequestPacket(data);</div><div class=\"line\"><span class=\"number\">15</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">16</span>: \t\t<span class=\"keyword\">default</span>: <span class=\"comment\">// åˆå§‹åŒ– header fields</span></div><div class=\"line\"><span class=\"number\">17</span>: \t\t\tresultStatus = RESULT_STATUS_HEADER;</div><div class=\"line\"><span class=\"number\">18</span>: \t\t\theader = data;</div><div class=\"line\"><span class=\"number\">19</span>: \t\t\tfields = <span class=\"keyword\">new</span> ArrayList&lt;<span class=\"keyword\">byte</span>[]&gt;((<span class=\"keyword\">int</span>) ByteUtil.readLength(data,</div><div class=\"line\"><span class=\"number\">20</span>: \t\t\t\t\t<span class=\"number\">4</span>));</div><div class=\"line\"><span class=\"number\">21</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">22</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">23</span>: \t<span class=\"keyword\">case</span> RESULT_STATUS_HEADER:</div><div class=\"line\"><span class=\"number\">24</span>: \t\t<span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) &#123;</div><div class=\"line\"><span class=\"number\">25</span>: \t\t<span class=\"keyword\">case</span> ErrorPacket.FIELD_COUNT:</div><div class=\"line\"><span class=\"number\">26</span>: \t\t\tresultStatus = RESULT_STATUS_INIT;</div><div class=\"line\"><span class=\"number\">27</span>: \t\t\thandleErrorPacket(data);</div><div class=\"line\"><span class=\"number\">28</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">29</span>: \t\t<span class=\"keyword\">case</span> EOFPacket.FIELD_COUNT: <span class=\"comment\">// è§£æ fields ç»“æŸ</span></div><div class=\"line\"><span class=\"number\">30</span>: \t\t\tresultStatus = RESULT_STATUS_FIELD_EOF;</div><div class=\"line\"><span class=\"number\">31</span>: \t\t\thandleFieldEofPacket(data);</div><div class=\"line\"><span class=\"number\">32</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">33</span>: \t\t<span class=\"keyword\">default</span>: <span class=\"comment\">// è§£æ fields</span></div><div class=\"line\"><span class=\"number\">34</span>: \t\t\tfields.add(data);</div><div class=\"line\"><span class=\"number\">35</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">36</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">37</span>: \t<span class=\"keyword\">case</span> RESULT_STATUS_FIELD_EOF:</div><div class=\"line\"><span class=\"number\">38</span>: \t\t<span class=\"keyword\">switch</span> (data[<span class=\"number\">4</span>]) &#123;</div><div class=\"line\"><span class=\"number\">39</span>: \t\t<span class=\"keyword\">case</span> ErrorPacket.FIELD_COUNT:</div><div class=\"line\"><span class=\"number\">40</span>: \t\t\tresultStatus = RESULT_STATUS_INIT;</div><div class=\"line\"><span class=\"number\">41</span>: \t\t\thandleErrorPacket(data);</div><div class=\"line\"><span class=\"number\">42</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">43</span>: \t\t<span class=\"keyword\">case</span> EOFPacket.FIELD_COUNT: <span class=\"comment\">// è§£æ æ¯è¡Œè®°å½• ç»“æŸ</span></div><div class=\"line\"><span class=\"number\">44</span>: \t\t\tresultStatus = RESULT_STATUS_INIT;</div><div class=\"line\"><span class=\"number\">45</span>: \t\t\thandleRowEofPacket(data);</div><div class=\"line\"><span class=\"number\">46</span>: \t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">47</span>: \t\t<span class=\"keyword\">default</span>: <span class=\"comment\">// æ¯è¡Œè®°å½•</span></div><div class=\"line\"><span class=\"number\">48</span>: \t\t\thandleRowPacket(data);</div><div class=\"line\"><span class=\"number\">49</span>: \t\t&#125;</div><div class=\"line\"><span class=\"number\">50</span>: \t\t<span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">51</span>: \t<span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">52</span>: \t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">\"unknown status!\"</span>);</div><div class=\"line\"><span class=\"number\">53</span>: \t&#125;</div><div class=\"line\"><span class=\"number\">54</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"6-å…¶ä»–-ï¼šæ›´æ–°-åˆ é™¤\"><a href=\"#6-å…¶ä»–-ï¼šæ›´æ–°-åˆ é™¤\" class=\"headerlink\" title=\"6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤\"></a>6. å…¶ä»– ï¼šæ›´æ–° / åˆ é™¤</h1><p>æµç¨‹åŸºæœ¬å’Œ <a href=\"https://github.com/YunaiV/Blog/blob/master/Database/MyCAT/1003-MyCAT%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A%E3%80%90%E5%8D%95%E5%BA%93%E5%8D%95%E8%A1%A8%E3%80%91%E6%8F%92%E5%85%A5.md\" target=\"_blank\" rel=\"external\">ã€ŠMyCATæºç åˆ†æï¼šã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a> ç›¸åŒã€‚æˆ‘ä»¬å°±ä¸å¦å¤–æ–‡ç« è§£æã€‚</p>\n"},{"title":"RocketMQ ä¹‹ Namesrv å°ç»“","date":"2017-04-04T16:00:00.000Z","_content":"\n## Namesrvç»„ä»¶\n\n* KVConfigManagerï¼šKVé…ç½®ç®¡ç†\n   * key-valueé…ç½®ç®¡ç†ï¼Œå¢åˆ æ”¹æŸ¥\n* RouteInfoManagerï¼šè·¯ç”±ä¿¡æ¯ç®¡ç†\n   * æ³¨å†ŒBrokerï¼Œæä¾›Brokerä¿¡æ¯ï¼ˆåå­—ã€è§’è‰²ç¼–å·ã€åœ°å€ã€é›†ç¾¤åï¼‰\n   * æ³¨å†ŒTopicï¼Œæä¾›Topicä¿¡æ¯ï¼ˆTopicåã€è¯»å†™æƒé™ã€é˜Ÿåˆ—æƒ…å†µï¼‰\n\n","source":"_posts/RocketMQ/2017_04_05_RocketMQä¹‹Namesrvå°ç»“.md","raw":"title: RocketMQ ä¹‹ Namesrv å°ç»“\ndate: 2017-04-05\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/namesrv-intro\n\n---\n\n## Namesrvç»„ä»¶\n\n* KVConfigManagerï¼šKVé…ç½®ç®¡ç†\n   * key-valueé…ç½®ç®¡ç†ï¼Œå¢åˆ æ”¹æŸ¥\n* RouteInfoManagerï¼šè·¯ç”±ä¿¡æ¯ç®¡ç†\n   * æ³¨å†ŒBrokerï¼Œæä¾›Brokerä¿¡æ¯ï¼ˆåå­—ã€è§’è‰²ç¼–å·ã€åœ°å€ã€é›†ç¾¤åï¼‰\n   * æ³¨å†ŒTopicï¼Œæä¾›Topicä¿¡æ¯ï¼ˆTopicåã€è¯»å†™æƒé™ã€é˜Ÿåˆ—æƒ…å†µï¼‰\n\n","slug":"RocketMQ/namesrv-intro","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswz9000kak5dpc1b2yxg","content":"<h2 id=\"Namesrvç»„ä»¶\"><a href=\"#Namesrvç»„ä»¶\" class=\"headerlink\" title=\"Namesrvç»„ä»¶\"></a>Namesrvç»„ä»¶</h2><ul>\n<li>KVConfigManagerï¼šKVé…ç½®ç®¡ç†<ul>\n<li>key-valueé…ç½®ç®¡ç†ï¼Œå¢åˆ æ”¹æŸ¥</li>\n</ul>\n</li>\n<li>RouteInfoManagerï¼šè·¯ç”±ä¿¡æ¯ç®¡ç†<ul>\n<li>æ³¨å†ŒBrokerï¼Œæä¾›Brokerä¿¡æ¯ï¼ˆåå­—ã€è§’è‰²ç¼–å·ã€åœ°å€ã€é›†ç¾¤åï¼‰</li>\n<li>æ³¨å†ŒTopicï¼Œæä¾›Topicä¿¡æ¯ï¼ˆTopicåã€è¯»å†™æƒé™ã€é˜Ÿåˆ—æƒ…å†µï¼‰</li>\n</ul>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Namesrvç»„ä»¶\"><a href=\"#Namesrvç»„ä»¶\" class=\"headerlink\" title=\"Namesrvç»„ä»¶\"></a>Namesrvç»„ä»¶</h2><ul>\n<li>KVConfigManagerï¼šKVé…ç½®ç®¡ç†<ul>\n<li>key-valueé…ç½®ç®¡ç†ï¼Œå¢åˆ æ”¹æŸ¥</li>\n</ul>\n</li>\n<li>RouteInfoManagerï¼šè·¯ç”±ä¿¡æ¯ç®¡ç†<ul>\n<li>æ³¨å†ŒBrokerï¼Œæä¾›Brokerä¿¡æ¯ï¼ˆåå­—ã€è§’è‰²ç¼–å·ã€åœ°å€ã€é›†ç¾¤åï¼‰</li>\n<li>æ³¨å†ŒTopicï¼Œæä¾›Topicä¿¡æ¯ï¼ˆTopicåã€è¯»å†™æƒé™ã€é˜Ÿåˆ—æƒ…å†µï¼‰</li>\n</ul>\n</li>\n</ul>\n"},{"title":"ä¸ºä»€ä¹ˆé˜…è¯» RocketMQ æºç ï¼Ÿ","date":"2017-03-22T16:00:00.000Z","_content":"\n## ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ\n\n* æ·±å…¥äº†è§£ MQ ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¦‚ä½•å®ç°é«˜æ€§èƒ½ã€é«˜å¯ç”¨\n* æœ€ç»ˆä¸€è‡´è¡Œï¼Œæ˜¯å¦‚ä½•é€šè¿‡ MQ è¿›è¡Œå®ç°\n* äº†è§£ Netty åœ¨åˆ†å¸ƒå¼ä¸­é—´ä»¶å¦‚ä½•å®ç°ç½‘ç»œé€šä¿¡ä»¥åŠå„ç§å¼‚å¸¸åœºæ™¯çš„å¤„ç†\n* äº†è§£ MQ æ¶ˆæ¯å­˜å‚¨ï¼Œç‰¹åˆ«æ˜¯ç£ç›˜ IO éƒ¨åˆ†\n* **æœ€é‡è¦çš„**ï¼Œå¸Œæœ›é€šè¿‡é˜…è¯»æºç ï¼Œåœ¨æŠ€æœ¯ä¸Šçš„è®¤çŸ¥å’Œèƒ½åŠ›ä¸Šï¼Œæœ‰æ–°çš„çªç ´\n\n## æ­¥éª¤\n\n- [ ] namesrv å¯åŠ¨\n- [ ] broker å¯åŠ¨\n- [ ] producer å¯åŠ¨\n- [ ] consumer å¯åŠ¨\n- [ ] æ¶ˆæ¯æ¨¡å‹\n    - [ ] æ¶ˆæ¯å”¯ä¸€ç¼–å·\n- [x] producer å‘æ¶ˆæ¯\n- [x] broker æ”¶æ¶ˆæ¯\n- [x] broker å‘æ¶ˆæ¯\n- [x] consumer æ”¶æ¶ˆæ¯\n    - [x] å¤šæ¶ˆè´¹è€…\n    - [x] é‡è¯•æ¶ˆæ¯\n- [x] consumer æ¶ˆæ¯ç¡®è®¤\n- [x] consumer è´Ÿè½½å‡è¡¡\n- [x] broker é˜Ÿåˆ—æ¨¡å‹\n- [x] broker store æ¶ˆæ¯å­˜å‚¨\n- [x] é¡ºåºæ¶ˆæ¯\n- [ ] äº‹åŠ¡æ¶ˆæ¯\n- [x] å®šæ—¶(å»¶è¿Ÿ)æ¶ˆæ¯\n- [x] pub/subæ¨¡å‹\n- [x] namesrv é›†ç¾¤\n- [x] broker ä¸»ä» \n- [x] filtersrv è¿‡æ»¤æ¶ˆæ¯\n- [ ] remoting è°ƒç”¨ï¼ˆserverã€clientï¼‰\n- [ ] è·¨æœºæˆ¿\n- [ ] Hook æœºåˆ¶\n- [ ] Tool-Admin\n- [ ] Tool-Command\n- [ ] Tool-Monitor\n- [ ] broker ä¸»å¤‡åˆ‡æ¢\n","source":"_posts/RocketMQ/2017_03_23_ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ.md","raw":"title: ä¸ºä»€ä¹ˆé˜…è¯» RocketMQ æºç ï¼Ÿ\ndate: 2017-03-23\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/why-read-RocketMQ-source-code\n\n---\n\n## ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ\n\n* æ·±å…¥äº†è§£ MQ ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¦‚ä½•å®ç°é«˜æ€§èƒ½ã€é«˜å¯ç”¨\n* æœ€ç»ˆä¸€è‡´è¡Œï¼Œæ˜¯å¦‚ä½•é€šè¿‡ MQ è¿›è¡Œå®ç°\n* äº†è§£ Netty åœ¨åˆ†å¸ƒå¼ä¸­é—´ä»¶å¦‚ä½•å®ç°ç½‘ç»œé€šä¿¡ä»¥åŠå„ç§å¼‚å¸¸åœºæ™¯çš„å¤„ç†\n* äº†è§£ MQ æ¶ˆæ¯å­˜å‚¨ï¼Œç‰¹åˆ«æ˜¯ç£ç›˜ IO éƒ¨åˆ†\n* **æœ€é‡è¦çš„**ï¼Œå¸Œæœ›é€šè¿‡é˜…è¯»æºç ï¼Œåœ¨æŠ€æœ¯ä¸Šçš„è®¤çŸ¥å’Œèƒ½åŠ›ä¸Šï¼Œæœ‰æ–°çš„çªç ´\n\n## æ­¥éª¤\n\n- [ ] namesrv å¯åŠ¨\n- [ ] broker å¯åŠ¨\n- [ ] producer å¯åŠ¨\n- [ ] consumer å¯åŠ¨\n- [ ] æ¶ˆæ¯æ¨¡å‹\n    - [ ] æ¶ˆæ¯å”¯ä¸€ç¼–å·\n- [x] producer å‘æ¶ˆæ¯\n- [x] broker æ”¶æ¶ˆæ¯\n- [x] broker å‘æ¶ˆæ¯\n- [x] consumer æ”¶æ¶ˆæ¯\n    - [x] å¤šæ¶ˆè´¹è€…\n    - [x] é‡è¯•æ¶ˆæ¯\n- [x] consumer æ¶ˆæ¯ç¡®è®¤\n- [x] consumer è´Ÿè½½å‡è¡¡\n- [x] broker é˜Ÿåˆ—æ¨¡å‹\n- [x] broker store æ¶ˆæ¯å­˜å‚¨\n- [x] é¡ºåºæ¶ˆæ¯\n- [ ] äº‹åŠ¡æ¶ˆæ¯\n- [x] å®šæ—¶(å»¶è¿Ÿ)æ¶ˆæ¯\n- [x] pub/subæ¨¡å‹\n- [x] namesrv é›†ç¾¤\n- [x] broker ä¸»ä» \n- [x] filtersrv è¿‡æ»¤æ¶ˆæ¯\n- [ ] remoting è°ƒç”¨ï¼ˆserverã€clientï¼‰\n- [ ] è·¨æœºæˆ¿\n- [ ] Hook æœºåˆ¶\n- [ ] Tool-Admin\n- [ ] Tool-Command\n- [ ] Tool-Monitor\n- [ ] broker ä¸»å¤‡åˆ‡æ¢\n","slug":"RocketMQ/why-read-RocketMQ-source-code","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswzb000lak5dyr1721jo","content":"<h2 id=\"ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ\"><a href=\"#ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ\" class=\"headerlink\" title=\"ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ\"></a>ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ</h2><ul>\n<li>æ·±å…¥äº†è§£ MQ ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¦‚ä½•å®ç°é«˜æ€§èƒ½ã€é«˜å¯ç”¨</li>\n<li>æœ€ç»ˆä¸€è‡´è¡Œï¼Œæ˜¯å¦‚ä½•é€šè¿‡ MQ è¿›è¡Œå®ç°</li>\n<li>äº†è§£ Netty åœ¨åˆ†å¸ƒå¼ä¸­é—´ä»¶å¦‚ä½•å®ç°ç½‘ç»œé€šä¿¡ä»¥åŠå„ç§å¼‚å¸¸åœºæ™¯çš„å¤„ç†</li>\n<li>äº†è§£ MQ æ¶ˆæ¯å­˜å‚¨ï¼Œç‰¹åˆ«æ˜¯ç£ç›˜ IO éƒ¨åˆ†</li>\n<li><strong>æœ€é‡è¦çš„</strong>ï¼Œå¸Œæœ›é€šè¿‡é˜…è¯»æºç ï¼Œåœ¨æŠ€æœ¯ä¸Šçš„è®¤çŸ¥å’Œèƒ½åŠ›ä¸Šï¼Œæœ‰æ–°çš„çªç ´</li>\n</ul>\n<h2 id=\"æ­¥éª¤\"><a href=\"#æ­¥éª¤\" class=\"headerlink\" title=\"æ­¥éª¤\"></a>æ­¥éª¤</h2><ul>\n<li>[ ] namesrv å¯åŠ¨</li>\n<li>[ ] broker å¯åŠ¨</li>\n<li>[ ] producer å¯åŠ¨</li>\n<li>[ ] consumer å¯åŠ¨</li>\n<li>[ ] æ¶ˆæ¯æ¨¡å‹<ul>\n<li>[ ] æ¶ˆæ¯å”¯ä¸€ç¼–å·</li>\n</ul>\n</li>\n<li>[x] producer å‘æ¶ˆæ¯</li>\n<li>[x] broker æ”¶æ¶ˆæ¯</li>\n<li>[x] broker å‘æ¶ˆæ¯</li>\n<li>[x] consumer æ”¶æ¶ˆæ¯<ul>\n<li>[x] å¤šæ¶ˆè´¹è€…</li>\n<li>[x] é‡è¯•æ¶ˆæ¯</li>\n</ul>\n</li>\n<li>[x] consumer æ¶ˆæ¯ç¡®è®¤</li>\n<li>[x] consumer è´Ÿè½½å‡è¡¡</li>\n<li>[x] broker é˜Ÿåˆ—æ¨¡å‹</li>\n<li>[x] broker store æ¶ˆæ¯å­˜å‚¨</li>\n<li>[x] é¡ºåºæ¶ˆæ¯</li>\n<li>[ ] äº‹åŠ¡æ¶ˆæ¯</li>\n<li>[x] å®šæ—¶(å»¶è¿Ÿ)æ¶ˆæ¯</li>\n<li>[x] pub/subæ¨¡å‹</li>\n<li>[x] namesrv é›†ç¾¤</li>\n<li>[x] broker ä¸»ä» </li>\n<li>[x] filtersrv è¿‡æ»¤æ¶ˆæ¯</li>\n<li>[ ] remoting è°ƒç”¨ï¼ˆserverã€clientï¼‰</li>\n<li>[ ] è·¨æœºæˆ¿</li>\n<li>[ ] Hook æœºåˆ¶</li>\n<li>[ ] Tool-Admin</li>\n<li>[ ] Tool-Command</li>\n<li>[ ] Tool-Monitor</li>\n<li>[ ] broker ä¸»å¤‡åˆ‡æ¢</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ\"><a href=\"#ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ\" class=\"headerlink\" title=\"ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ\"></a>ä¸ºä»€ä¹ˆé˜…è¯»RocketMQæºç ï¼Ÿ</h2><ul>\n<li>æ·±å…¥äº†è§£ MQ ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¦‚ä½•å®ç°é«˜æ€§èƒ½ã€é«˜å¯ç”¨</li>\n<li>æœ€ç»ˆä¸€è‡´è¡Œï¼Œæ˜¯å¦‚ä½•é€šè¿‡ MQ è¿›è¡Œå®ç°</li>\n<li>äº†è§£ Netty åœ¨åˆ†å¸ƒå¼ä¸­é—´ä»¶å¦‚ä½•å®ç°ç½‘ç»œé€šä¿¡ä»¥åŠå„ç§å¼‚å¸¸åœºæ™¯çš„å¤„ç†</li>\n<li>äº†è§£ MQ æ¶ˆæ¯å­˜å‚¨ï¼Œç‰¹åˆ«æ˜¯ç£ç›˜ IO éƒ¨åˆ†</li>\n<li><strong>æœ€é‡è¦çš„</strong>ï¼Œå¸Œæœ›é€šè¿‡é˜…è¯»æºç ï¼Œåœ¨æŠ€æœ¯ä¸Šçš„è®¤çŸ¥å’Œèƒ½åŠ›ä¸Šï¼Œæœ‰æ–°çš„çªç ´</li>\n</ul>\n<h2 id=\"æ­¥éª¤\"><a href=\"#æ­¥éª¤\" class=\"headerlink\" title=\"æ­¥éª¤\"></a>æ­¥éª¤</h2><ul>\n<li>[ ] namesrv å¯åŠ¨</li>\n<li>[ ] broker å¯åŠ¨</li>\n<li>[ ] producer å¯åŠ¨</li>\n<li>[ ] consumer å¯åŠ¨</li>\n<li>[ ] æ¶ˆæ¯æ¨¡å‹<ul>\n<li>[ ] æ¶ˆæ¯å”¯ä¸€ç¼–å·</li>\n</ul>\n</li>\n<li>[x] producer å‘æ¶ˆæ¯</li>\n<li>[x] broker æ”¶æ¶ˆæ¯</li>\n<li>[x] broker å‘æ¶ˆæ¯</li>\n<li>[x] consumer æ”¶æ¶ˆæ¯<ul>\n<li>[x] å¤šæ¶ˆè´¹è€…</li>\n<li>[x] é‡è¯•æ¶ˆæ¯</li>\n</ul>\n</li>\n<li>[x] consumer æ¶ˆæ¯ç¡®è®¤</li>\n<li>[x] consumer è´Ÿè½½å‡è¡¡</li>\n<li>[x] broker é˜Ÿåˆ—æ¨¡å‹</li>\n<li>[x] broker store æ¶ˆæ¯å­˜å‚¨</li>\n<li>[x] é¡ºåºæ¶ˆæ¯</li>\n<li>[ ] äº‹åŠ¡æ¶ˆæ¯</li>\n<li>[x] å®šæ—¶(å»¶è¿Ÿ)æ¶ˆæ¯</li>\n<li>[x] pub/subæ¨¡å‹</li>\n<li>[x] namesrv é›†ç¾¤</li>\n<li>[x] broker ä¸»ä» </li>\n<li>[x] filtersrv è¿‡æ»¤æ¶ˆæ¯</li>\n<li>[ ] remoting è°ƒç”¨ï¼ˆserverã€clientï¼‰</li>\n<li>[ ] è·¨æœºæˆ¿</li>\n<li>[ ] Hook æœºåˆ¶</li>\n<li>[ ] Tool-Admin</li>\n<li>[ ] Tool-Command</li>\n<li>[ ] Tool-Monitor</li>\n<li>[ ] broker ä¸»å¤‡åˆ‡æ¢</li>\n</ul>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” Message","date":"2017-04-07T16:00:00.000Z","_content":"","source":"_posts/RocketMQ/2017_04_08_RocketMQæºç åˆ†æâ€”â€”MessageåŸºç¡€.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Message\ndate: 2017-04-08\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/message\n\n---","slug":"RocketMQ/message","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswze000oak5do25uq5u2","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"RocketMQ æºç åˆ†æ â€”â€” Store åˆå§‹åŒ–ä¸å…³é—­","date":"2017-05-11T16:00:00.000Z","_content":"","source":"_posts/RocketMQ/2017_05_12_RocketMQæºç åˆ†æâ€”â€”Storeåˆå§‹åŒ–ä¸å…³é—­.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Store åˆå§‹åŒ–ä¸å…³é—­\ndate: 2017-05-12\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/store-init-and-shutdown\n\n-------","slug":"RocketMQ/store-init-and-shutdown","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswzf000qak5dc6vlm9fr","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"RocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶","date":"2017-04-17T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[http://www.yunai.me/RocketMQ/message-send-and-receive/](http://www.yunai.me/RocketMQ/message-send-and-receive/)  \n> `RocketMQ` **å¸¦æ³¨é‡Šæºç **åœ°å€ ï¼š[https://github.com/YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **  \n\n![wechat_mp](http://www.yunai.me/images/common/wechat_mp.jpeg)\n\n-------\n\n- [1ã€æ¦‚è¿°](#)\n- [2ã€Producer å‘é€æ¶ˆæ¯](#)\n\t- [DefaultMQProducer#send(Message)](#)\n\t- [DefaultMQProducerImpl#sendDefaultImpl()](#)\n\t\t- [DefaultMQProducerImpl#tryToFindTopicPublishInfo()](#)\n\t\t- [MQFaultStrategy](#)\n\t\t\t- [MQFaultStrategy](#)\n\t\t\t- [LatencyFaultTolerance](#)\n\t\t\t- [LatencyFaultToleranceImpl](#)\n\t\t\t- [FaultItem](#)\n\t\t- [DefaultMQProducerImpl#sendKernelImpl()](#)\n- [3ã€Broker æ¥æ”¶æ¶ˆæ¯](#)\n\t- [SendMessageProcessor#sendMessage](#)\n\t\t- [AbstractSendMessageProcessor#msgCheck](#)\n\t- [DefaultMessageStore#putMessage](#)\n- [4ã€æŸç§ç»“å°¾](#)\n\n# 1ã€æ¦‚è¿°\n\n1. `Producer` å‘é€æ¶ˆæ¯ã€‚ä¸»è¦æ˜¯**åŒæ­¥**å‘é€æ¶ˆæ¯æºç ï¼Œæ¶‰åŠåˆ° å¼‚æ­¥/Onewayå‘é€æ¶ˆæ¯ï¼Œäº‹åŠ¡æ¶ˆæ¯ä¼šè·³è¿‡ã€‚\n2. `Broker` æ¥æ”¶æ¶ˆæ¯ã€‚(*å­˜å‚¨æ¶ˆæ¯åœ¨[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨ã€‹](http://www.yunai.me/RocketMQ/message-store/)è§£æ*)\n\n> ![Producerå‘é€æ¶ˆæ¯å…¨å±€é¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_04_18/01.png)\n\n# 2ã€Producer å‘é€æ¶ˆæ¯\n\n > ![Producerå‘é€æ¶ˆæ¯é¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_04_18/02.png)\n\n## DefaultMQProducer#send(Message)\n\n```Java\n  1: @Override\n  2: public SendResult send(Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  3:     return this.defaultMQProducerImpl.send(msg);\n  4: }\n```\n\n* è¯´æ˜ï¼šå‘é€åŒæ­¥æ¶ˆæ¯ï¼Œ`DefaultMQProducer#send(Message)` å¯¹ `DefaultMQProducerImpl#send(Message)` è¿›è¡Œå°è£…ã€‚  \n\n## DefaultMQProducerImpl#sendDefaultImpl()\n\n```Java\n  1: public SendResult send(Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  2:     return send(msg, this.defaultMQProducer.getSendMsgTimeout());\n  3: }\n  4: \n  5: public SendResult send(Message msg, long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  6:     return this.sendDefaultImpl(msg, CommunicationMode.SYNC, null, timeout);\n  7: }\n  8: \n  9: private SendResult sendDefaultImpl(//\n 10:     Message msg, //\n 11:     final CommunicationMode communicationMode, //\n 12:     final SendCallback sendCallback, //\n 13:     final long timeout//\n 14: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n 15:     // æ ¡éªŒ Producer å¤„äºè¿è¡ŒçŠ¶æ€\n 16:     this.makeSureStateOK();\n 17:     // æ ¡éªŒæ¶ˆæ¯æ ¼å¼\n 18:     Validators.checkMessage(msg, this.defaultMQProducer);\n 19:     //\n 20:     final long invokeID = random.nextLong(); // è°ƒç”¨ç¼–å·ï¼›ç”¨äºä¸‹é¢æ‰“å°æ—¥å¿—ï¼Œæ ‡è®°ä¸ºåŒä¸€æ¬¡å‘é€æ¶ˆæ¯\n 21:     long beginTimestampFirst = System.currentTimeMillis();\n 22:     long beginTimestampPrev = beginTimestampFirst;\n 23:     long endTimestamp = beginTimestampFirst;\n 24:     // è·å– Topicè·¯ç”±ä¿¡æ¯\n 25:     TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());\n 26:     if (topicPublishInfo != null && topicPublishInfo.ok()) {\n 27:         MessageQueue mq = null; // æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—\n 28:         Exception exception = null;\n 29:         SendResult sendResult = null; // æœ€åä¸€æ¬¡å‘é€ç»“æœ\n 30:         int timesTotal = communicationMode == CommunicationMode.SYNC ? 1 + this.defaultMQProducer.getRetryTimesWhenSendFailed() : 1; // åŒæ­¥å¤šæ¬¡è°ƒç”¨\n 31:         int times = 0; // ç¬¬å‡ æ¬¡å‘é€\n 32:         String[] brokersSent = new String[timesTotal]; // å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå\n 33:         // å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ\n 34:         for (; times < timesTotal; times++) {\n 35:             String lastBrokerName = null == mq ? null : mq.getBrokerName();\n 36:             MessageQueue tmpmq = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName); // é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—\n 37:             if (tmpmq != null) {\n 38:                 mq = tmpmq;\n 39:                 brokersSent[times] = mq.getBrokerName();\n 40:                 try {\n 41:                     beginTimestampPrev = System.currentTimeMillis();\n 42:                     // è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•\n 43:                     sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);\n 44:                     endTimestamp = System.currentTimeMillis();\n 45:                     // æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯\n 46:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);\n 47:                     switch (communicationMode) {\n 48:                         case ASYNC:\n 49:                             return null;\n 50:                         case ONEWAY:\n 51:                             return null;\n 52:                         case SYNC:\n 53:                             if (sendResult.getSendStatus() != SendStatus.SEND_OK) {\n 54:                                 if (this.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) { // åŒæ­¥å‘é€æˆåŠŸä½†å­˜å‚¨æœ‰é—®é¢˜æ—¶ && é…ç½®å­˜å‚¨å¼‚å¸¸æ—¶é‡æ–°å‘é€å¼€å…³ æ—¶ï¼Œè¿›è¡Œé‡è¯•\n 55:                                     continue;\n 56:                                 }\n 57:                             }\n 58:                             return sendResult;\n 59:                         default:\n 60:                             break;\n 61:                     }\n 62:                 } catch (RemotingException e) { // æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œæ›´æ–°ç»§ç»­å¾ªç¯\n 63:                     endTimestamp = System.currentTimeMillis();\n 64:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);\n 65:                     log.warn(String.format(\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\", invokeID, endTimestamp - beginTimestampPrev, mq), e);\n 66:                     log.warn(msg.toString());\n 67:                     exception = e;\n 68:                     continue;\n 69:                 } catch (MQClientException e) { // æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œç»§ç»­å¾ªç¯\n 70:                     endTimestamp = System.currentTimeMillis();\n 71:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);\n 72:                     log.warn(String.format(\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\", invokeID, endTimestamp - beginTimestampPrev, mq), e);\n 73:                     log.warn(msg.toString());\n 74:                     exception = e;\n 75:                     continue;\n 76:                 } catch (MQBrokerException e) { // æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ï¼Œç»“æŸå¾ªç¯\n 77:                     endTimestamp = System.currentTimeMillis();\n 78:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);\n 79:                     log.warn(String.format(\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\", invokeID, endTimestamp - beginTimestampPrev, mq), e);\n 80:                     log.warn(msg.toString());\n 81:                     exception = e;\n 82:                     switch (e.getResponseCode()) {\n 83:                         // å¦‚ä¸‹å¼‚å¸¸continueï¼Œè¿›è¡Œå‘é€æ¶ˆæ¯é‡è¯•\n 84:                         case ResponseCode.TOPIC_NOT_EXIST:\n 85:                         case ResponseCode.SERVICE_NOT_AVAILABLE:\n 86:                         case ResponseCode.SYSTEM_ERROR:\n 87:                         case ResponseCode.NO_PERMISSION:\n 88:                         case ResponseCode.NO_BUYER_ID:\n 89:                         case ResponseCode.NOT_IN_CURRENT_UNIT:\n 90:                             continue;\n 91:                         // å¦‚æœæœ‰å‘é€ç»“æœï¼Œè¿›è¡Œè¿”å›ï¼Œå¦åˆ™ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›\n 92:                         default:\n 93:                             if (sendResult != null) {\n 94:                                 return sendResult;\n 95:                             }\n 96:                             throw e;\n 97:                     }\n 98:                 } catch (InterruptedException e) {\n 99:                     endTimestamp = System.currentTimeMillis();\n100:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);\n101:                     log.warn(String.format(\"sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s\", invokeID, endTimestamp - beginTimestampPrev, mq), e);\n102:                     log.warn(msg.toString());\n103:                     throw e;\n104:                 }\n105:             } else {\n106:                 break;\n107:             }\n108:         }\n109:         // è¿”å›å‘é€ç»“æœ\n110:         if (sendResult != null) {\n111:             return sendResult;\n112:         }\n113:         // æ ¹æ®ä¸åŒæƒ…å†µï¼ŒæŠ›å‡ºä¸åŒçš„å¼‚å¸¸\n114:         String info = String.format(\"Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s\", times, System.currentTimeMillis() - beginTimestampFirst,\n115:                 msg.getTopic(), Arrays.toString(brokersSent)) + FAQUrl.suggestTodo(FAQUrl.SEND_MSG_FAILED);\n116:         MQClientException mqClientException = new MQClientException(info, exception);\n117:         if (exception instanceof MQBrokerException) {\n118:             mqClientException.setResponseCode(((MQBrokerException) exception).getResponseCode());\n119:         } else if (exception instanceof RemotingConnectException) {\n120:             mqClientException.setResponseCode(ClientErrorCode.CONNECT_BROKER_EXCEPTION);\n121:         } else if (exception instanceof RemotingTimeoutException) {\n122:             mqClientException.setResponseCode(ClientErrorCode.ACCESS_BROKER_TIMEOUT);\n123:         } else if (exception instanceof MQClientException) {\n124:             mqClientException.setResponseCode(ClientErrorCode.BROKER_NOT_EXIST_EXCEPTION);\n125:         }\n126:         throw mqClientException;\n127:     }\n128:     // Namesrvæ‰¾ä¸åˆ°å¼‚å¸¸\n129:     List<String> nsList = this.getmQClientFactory().getMQClientAPIImpl().getNameServerAddressList();\n130:     if (null == nsList || nsList.isEmpty()) {\n131:         throw new MQClientException(\n132:             \"No name server address, please set it.\" + FAQUrl.suggestTodo(FAQUrl.NAME_SERVER_ADDR_NOT_EXIST_URL), null).setResponseCode(ClientErrorCode.NO_NAME_SERVER_EXCEPTION);\n133:     }\n134:     // æ¶ˆæ¯è·¯ç”±æ‰¾ä¸åˆ°å¼‚å¸¸\n135:     throw new MQClientException(\"No route info of this topic, \" + msg.getTopic() + FAQUrl.suggestTodo(FAQUrl.NO_TOPIC_ROUTE_INFO),\n136:         null).setResponseCode(ClientErrorCode.NOT_FOUND_TOPIC_EXCEPTION);\n137: }\n```\n* è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯ã€‚æ­¥éª¤ï¼šè·å–æ¶ˆæ¯è·¯ç”±ä¿¡æ¯ï¼Œé€‰æ‹©è¦å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ‰§è¡Œæ¶ˆæ¯å‘é€æ ¸å¿ƒæ–¹æ³•ï¼Œå¹¶å¯¹å‘é€ç»“æœè¿›è¡Œå°è£…è¿”å›ã€‚\n* ç¬¬ 1  è‡³ 7 è¡Œï¼šå¯¹`sendsendDefaultImpl(...)`è¿›è¡Œå°è£…ã€‚\n* ç¬¬ 20 è¡Œ ï¼š`invokeID`ä»…ä»…ç”¨äºæ‰“å°æ—¥å¿—ï¼Œæ— å®é™…çš„ä¸šåŠ¡ç”¨é€”ã€‚\n* ç¬¬ 25 è¡Œ ï¼šè·å– Topicè·¯ç”±ä¿¡æ¯ï¼Œ è¯¦ç»†è§£æè§ï¼š[DefaultMQProducerImpl#tryToFindTopicPublishInfo()](#defaultmqproducerimpltrytofindtopicpublishinfo)\n* ç¬¬ 30 & 34 è¡Œ ï¼šè®¡ç®—è°ƒç”¨å‘é€æ¶ˆæ¯åˆ°æˆåŠŸä¸ºæ­¢çš„æœ€å¤§æ¬¡æ•°ï¼Œå¹¶è¿›è¡Œå¾ªç¯ã€‚åŒæ­¥æˆ–å¼‚æ­¥å‘é€æ¶ˆæ¯ä¼šè°ƒç”¨å¤šæ¬¡ï¼Œé»˜è®¤é…ç½®ä¸º3æ¬¡ã€‚\n* ç¬¬ 36 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—ï¼Œè¯¦ç»†è§£æè§ï¼š[MQFaultStrategy](#mqfaultstrategy)\n* ç¬¬ 43 è¡Œ ï¼šè°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š[DefaultMQProducerImpl#sendKernelImpl()](#defaultmqproducerimplsendkernelimpl)\n* ç¬¬ 46 è¡Œ ï¼šæ›´æ–°`Broker`å¯ç”¨æ€§ä¿¡æ¯ã€‚åœ¨é€‰æ‹©å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‚è€ƒ`Broker`å‘é€æ¶ˆæ¯çš„å»¶è¿Ÿï¼Œè¯¦ç»†è§£æè§ï¼š[MQFaultStrategy](#mqfaultstrategy)\n* ç¬¬ 62 è‡³ 68 è¡Œï¼šå½“æŠ›å‡º`RemotingException`æ—¶ï¼Œå¦‚æœè¿›è¡Œæ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•ï¼Œåˆ™**å¯èƒ½å¯¼è‡´æ¶ˆæ¯å‘é€é‡å¤**ã€‚ä¾‹å¦‚ï¼Œå‘é€æ¶ˆæ¯è¶…æ—¶(`RemotingTimeoutException`)ï¼Œå®é™…`Broker`æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯å¹¶å¤„ç†æˆåŠŸã€‚å› æ­¤ï¼Œ`Consumer`åœ¨æ¶ˆè´¹æ—¶ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚\n\n### DefaultMQProducerImpl#tryToFindTopicPublishInfo()\n\n```Java\n  1: private TopicPublishInfo tryToFindTopicPublishInfo(final String topic) {\n  2:     // ç¼“å­˜ä¸­è·å– Topicå‘å¸ƒä¿¡æ¯\n  3:     TopicPublishInfo topicPublishInfo = this.topicPublishInfoTable.get(topic);\n  4:     // å½“æ— å¯ç”¨çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶ï¼Œä»Namesrvè·å–ä¸€æ¬¡\n  5:     if (null == topicPublishInfo || !topicPublishInfo.ok()) {\n  6:         this.topicPublishInfoTable.putIfAbsent(topic, new TopicPublishInfo());\n  7:         this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);\n  8:         topicPublishInfo = this.topicPublishInfoTable.get(topic);\n  9:     }\n 10:     // è‹¥è·å–çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶å€™å¯ç”¨ï¼Œåˆ™è¿”å›\n 11:     if (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) {\n 12:         return topicPublishInfo;\n 13:     } else { // ä½¿ç”¨ {@link DefaultMQProducer#createTopicKey} å¯¹åº”çš„ Topicå‘å¸ƒä¿¡æ¯ã€‚ç”¨äº Topicå‘å¸ƒä¿¡æ¯ä¸å­˜åœ¨ && Brokeræ”¯æŒè‡ªåŠ¨åˆ›å»ºTopic\n 14:         this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, true, this.defaultMQProducer);\n 15:         topicPublishInfo = this.topicPublishInfoTable.get(topic);\n 16:         return topicPublishInfo;\n 17:     }\n 18: }\n```\n* è¯´æ˜ ï¼šè·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚ä¼˜å…ˆä»ç¼“å­˜`topicPublishInfoTable`ï¼Œå…¶æ¬¡ä»`Namesrv`ä¸­è·å¾—ã€‚\n* ç¬¬ 3 è¡Œ ï¼šä»ç¼“å­˜`topicPublishInfoTable`ä¸­è·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚\n* ç¬¬ 5 è‡³ 9 è¡Œ ï¼šä» `Namesrv` ä¸­è·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚\n* ç¬¬ 13 è‡³ 17 è¡Œ ï¼šå½“ä» `Namesrv` æ— æ³•è·å–æ—¶ï¼Œä½¿ç”¨ `{@link DefaultMQProducer#createTopicKey}` å¯¹åº”çš„ Topicå‘å¸ƒä¿¡æ¯ã€‚ç›®çš„æ˜¯å½“ `Broker` å¼€å¯è‡ªåŠ¨åˆ›å»º Topicå¼€å…³æ—¶ï¼Œ`Broker` æ¥æ”¶åˆ°æ¶ˆæ¯åè‡ªåŠ¨åˆ›å»ºTopicï¼Œè¯¦ç»†è§£æè§[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹](http://www.yunai.me/RocketMQ/topic/)ã€‚\n\n### MQFaultStrategy\n\n> ![Latencyç±»å›¾](http://www.yunai.me/images/RocketMQ/2017_04_18/03.png)\n\n#### MQFaultStrategy\n\n```Java\n  1: public class MQFaultStrategy {\n  2:     private final static Logger log = ClientLogger.getLog();\n  3: \n  4:     /**\n  5:      * å»¶è¿Ÿæ•…éšœå®¹é”™ï¼Œç»´æŠ¤æ¯ä¸ªBrokerçš„å‘é€æ¶ˆæ¯çš„å»¶è¿Ÿ\n  6:      * keyï¼šbrokerName\n  7:      */\n  8:     private final LatencyFaultTolerance<String> latencyFaultTolerance = new LatencyFaultToleranceImpl();\n  9:     /**\n 10:      * å‘é€æ¶ˆæ¯å»¶è¿Ÿå®¹é”™å¼€å…³\n 11:      */\n 12:     private boolean sendLatencyFaultEnable = false;\n 13:     /**\n 14:      * å»¶è¿Ÿçº§åˆ«æ•°ç»„\n 15:      */\n 16:     private long[] latencyMax = {50L, 100L, 550L, 1000L, 2000L, 3000L, 15000L};\n 17:     /**\n 18:      * ä¸å¯ç”¨æ—¶é•¿æ•°ç»„\n 19:      */\n 20:     private long[] notAvailableDuration = {0L, 0L, 30000L, 60000L, 120000L, 180000L, 600000L};\n 21: \n 22:     /**\n 23:      * æ ¹æ® Topicå‘å¸ƒä¿¡æ¯ é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—\n 24:      *\n 25:      * @param tpInfo Topicå‘å¸ƒä¿¡æ¯\n 26:      * @param lastBrokerName brokerName\n 27:      * @return æ¶ˆæ¯é˜Ÿåˆ—\n 28:      */\n 29:     public MessageQueue selectOneMessageQueue(final TopicPublishInfo tpInfo, final String lastBrokerName) {\n 30:         if (this.sendLatencyFaultEnable) {\n 31:             try {\n 32:                 // è·å– brokerName=lastBrokerName && å¯ç”¨çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—\n 33:                 int index = tpInfo.getSendWhichQueue().getAndIncrement();\n 34:                 for (int i = 0; i < tpInfo.getMessageQueueList().size(); i++) {\n 35:                     int pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();\n 36:                     if (pos < 0)\n 37:                         pos = 0;\n 38:                     MessageQueue mq = tpInfo.getMessageQueueList().get(pos);\n 39:                     if (latencyFaultTolerance.isAvailable(mq.getBrokerName())) {\n 40:                         if (null == lastBrokerName || mq.getBrokerName().equals(lastBrokerName))\n 41:                             return mq;\n 42:                     }\n 43:                 }\n 44:                 // é€‰æ‹©ä¸€ä¸ªç›¸å¯¹å¥½çš„brokerï¼Œå¹¶è·å¾—å…¶å¯¹åº”çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘è¯¥é˜Ÿåˆ—çš„å¯ç”¨æ€§\n 45:                 final String notBestBroker = latencyFaultTolerance.pickOneAtLeast();\n 46:                 int writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);\n 47:                 if (writeQueueNums > 0) {\n 48:                     final MessageQueue mq = tpInfo.selectOneMessageQueue();\n 49:                     if (notBestBroker != null) {\n 50:                         mq.setBrokerName(notBestBroker);\n 51:                         mq.setQueueId(tpInfo.getSendWhichQueue().getAndIncrement() % writeQueueNums);\n 52:                     }\n 53:                     return mq;\n 54:                 } else {\n 55:                     latencyFaultTolerance.remove(notBestBroker);\n 56:                 }\n 57:             } catch (Exception e) {\n 58:                 log.error(\"Error occurred when selecting message queue\", e);\n 59:             }\n 60:             // é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘é˜Ÿåˆ—çš„å¯ç”¨æ€§\n 61:             return tpInfo.selectOneMessageQueue();\n 62:         }\n 63:         // è·å¾— lastBrokerName å¯¹åº”çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘è¯¥é˜Ÿåˆ—çš„å¯ç”¨æ€§\n 64:         return tpInfo.selectOneMessageQueue(lastBrokerName);\n 65:     }\n 66: \n 67:     /**\n 68:      * æ›´æ–°å»¶è¿Ÿå®¹é”™ä¿¡æ¯\n 69:      *\n 70:      * @param brokerName brokerName\n 71:      * @param currentLatency å»¶è¿Ÿ\n 72:      * @param isolation æ˜¯å¦éš”ç¦»ã€‚å½“å¼€å¯éš”ç¦»æ—¶ï¼Œé»˜è®¤å»¶è¿Ÿä¸º30000ã€‚ç›®å‰ä¸»è¦ç”¨äºå‘é€æ¶ˆæ¯å¼‚å¸¸æ—¶\n 73:      */\n 74:     public void updateFaultItem(final String brokerName, final long currentLatency, boolean isolation) {\n 75:         if (this.sendLatencyFaultEnable) {\n 76:             long duration = computeNotAvailableDuration(isolation ? 30000 : currentLatency);\n 77:             this.latencyFaultTolerance.updateFaultItem(brokerName, currentLatency, duration);\n 78:         }\n 79:     }\n 80: \n 81:     /**\n 82:      * è®¡ç®—å»¶è¿Ÿå¯¹åº”çš„ä¸å¯ç”¨æ—¶é—´\n 83:      *\n 84:      * @param currentLatency å»¶è¿Ÿ\n 85:      * @return ä¸å¯ç”¨æ—¶é—´\n 86:      */\n 87:     private long computeNotAvailableDuration(final long currentLatency) {\n 88:         for (int i = latencyMax.length - 1; i >= 0; i--) {\n 89:             if (currentLatency >= latencyMax[i])\n 90:                 return this.notAvailableDuration[i];\n 91:         }\n 92:         return 0;\n 93:     }\n```\n* è¯´æ˜ ï¼š`Producer`æ¶ˆæ¯å‘é€å®¹é”™ç­–ç•¥ã€‚é»˜è®¤æƒ…å†µä¸‹å®¹é”™ç­–ç•¥å…³é—­ï¼Œå³`sendLatencyFaultEnable=false`ã€‚\n* ç¬¬ 30 è‡³ 62 è¡Œ ï¼šå®¹é”™ç­–ç•¥é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ã€‚ä¼˜å…ˆè·å–å¯ç”¨é˜Ÿåˆ—ï¼Œå…¶æ¬¡é€‰æ‹©ä¸€ä¸ªbrokerè·å–é˜Ÿåˆ—ï¼Œæœ€å·®è¿”å›ä»»æ„brokerçš„ä¸€ä¸ªé˜Ÿåˆ—ã€‚\n* ç¬¬ 64 è¡Œ ï¼šæœªå¼€å¯å®¹é”™ç­–ç•¥é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ã€‚\n* ç¬¬ 74 è‡³ 79 è¡Œ ï¼šæ›´æ–°å»¶è¿Ÿå®¹é”™ä¿¡æ¯ã€‚å½“ `Producer` å‘é€æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œåˆ™é€»è¾‘è®¤ä¸ºNç§’å†…ä¸å¯ç”¨ã€‚æŒ‰ç…§`latencyMax`ï¼Œ`notAvailableDuration`çš„é…ç½®ï¼Œå¯¹åº”å¦‚ä¸‹ï¼š\n\n    | Producerå‘é€æ¶ˆæ¯æ¶ˆè€—æ—¶é•¿ | Brokerä¸å¯ç”¨æ—¶é•¿ |\n    | --- | --- |\n    | >= 15000 ms | 600 * 1000 ms  |\n    | >= 3000 ms | 180 * 1000 ms  |\n    | >= 2000 ms | 120 * 1000 ms  |\n    | >= 1000 ms | 60 * 1000 ms  |\n    | >= 550 ms | 30 * 1000 ms |\n    | >= 100 ms | 0 ms |\n    | >= 50 ms | 0 ms |\n\n#### LatencyFaultTolerance\n\n```Java\n  1: public interface LatencyFaultTolerance<T> {\n  2: \n  3:     /**\n  4:      * æ›´æ–°å¯¹åº”çš„å»¶è¿Ÿå’Œä¸å¯ç”¨æ—¶é•¿\n  5:      *\n  6:      * @param name å¯¹è±¡\n  7:      * @param currentLatency å»¶è¿Ÿ\n  8:      * @param notAvailableDuration ä¸å¯ç”¨æ—¶é•¿\n  9:      */\n 10:     void updateFaultItem(final T name, final long currentLatency, final long notAvailableDuration);\n 11: \n 12:     /**\n 13:      * å¯¹è±¡æ˜¯å¦å¯ç”¨\n 14:      *\n 15:      * @param name å¯¹è±¡\n 16:      * @return æ˜¯å¦å¯ç”¨\n 17:      */\n 18:     boolean isAvailable(final T name);\n 19: \n 20:     /**\n 21:      * ç§»é™¤å¯¹è±¡\n 22:      *\n 23:      * @param name å¯¹è±¡\n 24:      */\n 25:     void remove(final T name);\n 26: \n 27:     /**\n 28:      * è·å–ä¸€ä¸ªå¯¹è±¡\n 29:      *\n 30:      * @return å¯¹è±¡\n 31:      */\n 32:     T pickOneAtLeast();\n 33: }\n```\n* è¯´æ˜ ï¼šå»¶è¿Ÿæ•…éšœå®¹é”™æ¥å£\n\n#### LatencyFaultToleranceImpl\n\n```Java\n  1: public class LatencyFaultToleranceImpl implements LatencyFaultTolerance<String> {\n  2: \n  3:     /**\n  4:      * å¯¹è±¡æ•…éšœä¿¡æ¯Table\n  5:      */\n  6:     private final ConcurrentHashMap<String, FaultItem> faultItemTable = new ConcurrentHashMap<>(16);\n  7:     /**\n  8:      * å¯¹è±¡é€‰æ‹©Index\n  9:      * @see #pickOneAtLeast()\n 10:      */\n 11:     private final ThreadLocalIndex whichItemWorst = new ThreadLocalIndex();\n 12: \n 13:     @Override\n 14:     public void updateFaultItem(final String name, final long currentLatency, final long notAvailableDuration) {\n 15:         FaultItem old = this.faultItemTable.get(name);\n 16:         if (null == old) {\n 17:             // åˆ›å»ºå¯¹è±¡\n 18:             final FaultItem faultItem = new FaultItem(name);\n 19:             faultItem.setCurrentLatency(currentLatency);\n 20:             faultItem.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);\n 21:             // æ›´æ–°å¯¹è±¡\n 22:             old = this.faultItemTable.putIfAbsent(name, faultItem);\n 23:             if (old != null) {\n 24:                 old.setCurrentLatency(currentLatency);\n 25:                 old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);\n 26:             }\n 27:         } else { // æ›´æ–°å¯¹è±¡\n 28:             old.setCurrentLatency(currentLatency);\n 29:             old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);\n 30:         }\n 31:     }\n 32: \n 33:     @Override\n 34:     public boolean isAvailable(final String name) {\n 35:         final FaultItem faultItem = this.faultItemTable.get(name);\n 36:         if (faultItem != null) {\n 37:             return faultItem.isAvailable();\n 38:         }\n 39:         return true;\n 40:     }\n 41: \n 42:     @Override\n 43:     public void remove(final String name) {\n 44:         this.faultItemTable.remove(name);\n 45:     }\n 46: \n 47:     /**\n 48:      * é€‰æ‹©ä¸€ä¸ªç›¸å¯¹ä¼˜ç§€çš„å¯¹è±¡\n 49:      *\n 50:      * @return å¯¹è±¡\n 51:      */\n 52:     @Override\n 53:     public String pickOneAtLeast() {\n 54:         // åˆ›å»ºæ•°ç»„\n 55:         final Enumeration<FaultItem> elements = this.faultItemTable.elements();\n 56:         List<FaultItem> tmpList = new LinkedList<>();\n 57:         while (elements.hasMoreElements()) {\n 58:             final FaultItem faultItem = elements.nextElement();\n 59:             tmpList.add(faultItem);\n 60:         }\n 61:         //\n 62:         if (!tmpList.isEmpty()) {\n 63:             // æ‰“ä¹± + æ’åºã€‚TODO ç–‘é—®ï¼šåº”è¯¥åªèƒ½äºŒé€‰ä¸€ã€‚çŒœæµ‹Collections.shuffle(tmpList)å»æ‰ã€‚\n 64:             Collections.shuffle(tmpList);\n 65:             Collections.sort(tmpList);\n 66:             // é€‰æ‹©é¡ºåºåœ¨å‰ä¸€åŠçš„å¯¹è±¡\n 67:             final int half = tmpList.size() / 2;\n 68:             if (half <= 0) {\n 69:                 return tmpList.get(0).getName();\n 70:             } else {\n 71:                 final int i = this.whichItemWorst.getAndIncrement() % half;\n 72:                 return tmpList.get(i).getName();\n 73:             }\n 74:         }\n 75:         return null;\n 76:     }\n 77: }\n```\n\n* è¯´æ˜ ï¼šå»¶è¿Ÿæ•…éšœå®¹é”™å®ç°ã€‚ç»´æŠ¤æ¯ä¸ªå¯¹è±¡çš„ä¿¡æ¯ã€‚\n\n#### FaultItem\n\n```Java\n  1: class FaultItem implements Comparable<FaultItem> {\n  2:     /**\n  3:      * å¯¹è±¡å\n  4:      */\n  5:     private final String name;\n  6:     /**\n  7:      * å»¶è¿Ÿ\n  8:      */\n  9:     private volatile long currentLatency;\n 10:     /**\n 11:      * å¼€å§‹å¯ç”¨æ—¶é—´\n 12:      */\n 13:     private volatile long startTimestamp;\n 14: \n 15:     public FaultItem(final String name) {\n 16:         this.name = name;\n 17:     }\n 18: \n 19:     /**\n 20:      * æ¯”è¾ƒå¯¹è±¡\n 21:      * å¯ç”¨æ€§ > å»¶è¿Ÿ > å¼€å§‹å¯ç”¨æ—¶é—´\n 22:      *\n 23:      * @param other other\n 24:      * @return å‡åº\n 25:      */\n 26:     @Override\n 27:     public int compareTo(final FaultItem other) {\n 28:         if (this.isAvailable() != other.isAvailable()) {\n 29:             if (this.isAvailable())\n 30:                 return -1;\n 31: \n 32:             if (other.isAvailable())\n 33:                 return 1;\n 34:         }\n 35: \n 36:         if (this.currentLatency < other.currentLatency)\n 37:             return -1;\n 38:         else if (this.currentLatency > other.currentLatency) {\n 39:             return 1;\n 40:         }\n 41: \n 42:         if (this.startTimestamp < other.startTimestamp)\n 43:             return -1;\n 44:         else if (this.startTimestamp > other.startTimestamp) {\n 45:             return 1;\n 46:         }\n 47: \n 48:         return 0;\n 49:     }\n 50: \n 51:     /**\n 52:      * æ˜¯å¦å¯ç”¨ï¼šå½“å¼€å§‹å¯ç”¨æ—¶é—´å¤§äºå½“å‰æ—¶é—´\n 53:      *\n 54:      * @return æ˜¯å¦å¯ç”¨\n 55:      */\n 56:     public boolean isAvailable() {\n 57:         return (System.currentTimeMillis() - startTimestamp) >= 0;\n 58:     }\n 59: \n 60:     @Override\n 61:     public int hashCode() {\n 62:         int result = getName() != null ? getName().hashCode() : 0;\n 63:         result = 31 * result + (int) (getCurrentLatency() ^ (getCurrentLatency() >>> 32));\n 64:         result = 31 * result + (int) (getStartTimestamp() ^ (getStartTimestamp() >>> 32));\n 65:         return result;\n 66:     }\n 67: \n 68:     @Override\n 69:     public boolean equals(final Object o) {\n 70:         if (this == o)\n 71:             return true;\n 72:         if (!(o instanceof FaultItem))\n 73:             return false;\n 74: \n 75:         final FaultItem faultItem = (FaultItem) o;\n 76: \n 77:         if (getCurrentLatency() != faultItem.getCurrentLatency())\n 78:             return false;\n 79:         if (getStartTimestamp() != faultItem.getStartTimestamp())\n 80:             return false;\n 81:         return getName() != null ? getName().equals(faultItem.getName()) : faultItem.getName() == null;\n 82: \n 83:     }\n 84: }\n```\n* è¯´æ˜ ï¼šå¯¹è±¡æ•…éšœä¿¡æ¯ã€‚ç»´æŠ¤å¯¹è±¡çš„åå­—ã€å»¶è¿Ÿã€å¼€å§‹å¯ç”¨çš„æ—¶é—´ã€‚\n\n### DefaultMQProducerImpl#sendKernelImpl()\n\n```Java\n  1: private SendResult sendKernelImpl(final Message msg, //\n  2:     final MessageQueue mq, //\n  3:     final CommunicationMode communicationMode, //\n  4:     final SendCallback sendCallback, //\n  5:     final TopicPublishInfo topicPublishInfo, //\n  6:     final long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  7:     // è·å– brokeråœ°å€\n  8:     String brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());\n  9:     if (null == brokerAddr) {\n 10:         tryToFindTopicPublishInfo(mq.getTopic());\n 11:         brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());\n 12:     }\n 13:     //\n 14:     SendMessageContext context = null;\n 15:     if (brokerAddr != null) {\n 16:         // æ˜¯å¦ä½¿ç”¨broker vipé€šé“ã€‚brokerä¼šå¼€å¯ä¸¤ä¸ªç«¯å£å¯¹å¤–æœåŠ¡ã€‚\n 17:         brokerAddr = MixAll.brokerVIPChannel(this.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr);\n 18:         byte[] prevBody = msg.getBody(); // è®°å½•æ¶ˆæ¯å†…å®¹ã€‚ä¸‹é¢é€»è¾‘å¯èƒ½æ”¹å˜æ¶ˆæ¯å†…å®¹ï¼Œä¾‹å¦‚æ¶ˆæ¯å‹ç¼©ã€‚\n 19:         try {\n 20:             // è®¾ç½®å”¯ä¸€ç¼–å·\n 21:             MessageClientIDSetter.setUniqID(msg);\n 22:             // æ¶ˆæ¯å‹ç¼©\n 23:             int sysFlag = 0;\n 24:             if (this.tryToCompressMessage(msg)) {\n 25:                 sysFlag |= MessageSysFlag.COMPRESSED_FLAG;\n 26:             }\n 27:             // äº‹åŠ¡\n 28:             final String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);\n 29:             if (tranMsg != null && Boolean.parseBoolean(tranMsg)) {\n 30:                 sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;\n 31:             }\n 32:             // hookï¼šå‘é€æ¶ˆæ¯æ ¡éªŒ\n 33:             if (hasCheckForbiddenHook()) {\n 34:                 CheckForbiddenContext checkForbiddenContext = new CheckForbiddenContext();\n 35:                 checkForbiddenContext.setNameSrvAddr(this.defaultMQProducer.getNamesrvAddr());\n 36:                 checkForbiddenContext.setGroup(this.defaultMQProducer.getProducerGroup());\n 37:                 checkForbiddenContext.setCommunicationMode(communicationMode);\n 38:                 checkForbiddenContext.setBrokerAddr(brokerAddr);\n 39:                 checkForbiddenContext.setMessage(msg);\n 40:                 checkForbiddenContext.setMq(mq);\n 41:                 checkForbiddenContext.setUnitMode(this.isUnitMode());\n 42:                 this.executeCheckForbiddenHook(checkForbiddenContext);\n 43:             }\n 44:             // hookï¼šå‘é€æ¶ˆæ¯å‰é€»è¾‘\n 45:             if (this.hasSendMessageHook()) {\n 46:                 context = new SendMessageContext();\n 47:                 context.setProducer(this);\n 48:                 context.setProducerGroup(this.defaultMQProducer.getProducerGroup());\n 49:                 context.setCommunicationMode(communicationMode);\n 50:                 context.setBornHost(this.defaultMQProducer.getClientIP());\n 51:                 context.setBrokerAddr(brokerAddr);\n 52:                 context.setMessage(msg);\n 53:                 context.setMq(mq);\n 54:                 String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);\n 55:                 if (isTrans != null && isTrans.equals(\"true\")) {\n 56:                     context.setMsgType(MessageType.Trans_Msg_Half);\n 57:                 }\n 58:                 if (msg.getProperty(\"__STARTDELIVERTIME\") != null || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != null) {\n 59:                     context.setMsgType(MessageType.Delay_Msg);\n 60:                 }\n 61:                 this.executeSendMessageHookBefore(context);\n 62:             }\n 63:             // æ„å»ºå‘é€æ¶ˆæ¯è¯·æ±‚\n 64:             SendMessageRequestHeader requestHeader = new SendMessageRequestHeader();\n 65:             requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());\n 66:             requestHeader.setTopic(msg.getTopic());\n 67:             requestHeader.setDefaultTopic(this.defaultMQProducer.getCreateTopicKey());\n 68:             requestHeader.setDefaultTopicQueueNums(this.defaultMQProducer.getDefaultTopicQueueNums());\n 69:             requestHeader.setQueueId(mq.getQueueId());\n 70:             requestHeader.setSysFlag(sysFlag);\n 71:             requestHeader.setBornTimestamp(System.currentTimeMillis());\n 72:             requestHeader.setFlag(msg.getFlag());\n 73:             requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));\n 74:             requestHeader.setReconsumeTimes(0);\n 75:             requestHeader.setUnitMode(this.isUnitMode());\n 76:             if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) { // æ¶ˆæ¯é‡å‘Topic\n 77:                 String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);\n 78:                 if (reconsumeTimes != null) {\n 79:                     requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));\n 80:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);\n 81:                 }\n 82:                 String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);\n 83:                 if (maxReconsumeTimes != null) {\n 84:                     requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));\n 85:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);\n 86:                 }\n 87:             }\n 88:             // å‘é€æ¶ˆæ¯\n 89:             SendResult sendResult = null;\n 90:             switch (communicationMode) {\n 91:                 case ASYNC:\n 92:                     sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(//\n 93:                         brokerAddr, // 1\n 94:                         mq.getBrokerName(), // 2\n 95:                         msg, // 3\n 96:                         requestHeader, // 4\n 97:                         timeout, // 5\n 98:                         communicationMode, // 6\n 99:                         sendCallback, // 7\n100:                         topicPublishInfo, // 8\n101:                         this.mQClientFactory, // 9\n102:                         this.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(), // 10\n103:                         context, //\n104:                         this);\n105:                     break;\n106:                 case ONEWAY:\n107:                 case SYNC:\n108:                     sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(\n109:                         brokerAddr,\n110:                         mq.getBrokerName(),\n111:                         msg,\n112:                         requestHeader,\n113:                         timeout,\n114:                         communicationMode,\n115:                         context,\n116:                         this);\n117:                     break;\n118:                 default:\n119:                     assert false;\n120:                     break;\n121:             }\n122:             // hookï¼šå‘é€æ¶ˆæ¯åé€»è¾‘\n123:             if (this.hasSendMessageHook()) {\n124:                 context.setSendResult(sendResult);\n125:                 this.executeSendMessageHookAfter(context);\n126:             }\n127:             // è¿”å›å‘é€ç»“æœ\n128:             return sendResult;\n129:         } catch (RemotingException e) {\n130:             if (this.hasSendMessageHook()) {\n131:                 context.setException(e);\n132:                 this.executeSendMessageHookAfter(context);\n133:             }\n134:             throw e;\n135:         } catch (MQBrokerException e) {\n136:             if (this.hasSendMessageHook()) {\n137:                 context.setException(e);\n138:                 this.executeSendMessageHookAfter(context);\n139:             }\n140:             throw e;\n141:         } catch (InterruptedException e) {\n142:             if (this.hasSendMessageHook()) {\n143:                 context.setException(e);\n144:                 this.executeSendMessageHookAfter(context);\n145:             }\n146:             throw e;\n147:         } finally {\n148:             msg.setBody(prevBody);\n149:         }\n150:     }\n151:     // brokerä¸ºç©ºæŠ›å‡ºå¼‚å¸¸\n152:     throw new MQClientException(\"The broker[\" + mq.getBrokerName() + \"] not exist\", null);\n153: }\n```\n* è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚è¯¥æ–¹æ³•çœŸæ­£å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå‘é€æ¶ˆæ¯ç»™ `Broker`ã€‚\n* ç¬¬ 21 è¡Œ ï¼šç”Ÿäº§æ¶ˆæ¯ç¼–å·ï¼Œè¯¦ç»†è§£æè§[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message åŸºç¡€ã€‹](http://www.yunai.me/RocketMQ/message/)ã€‚\n* ç¬¬ 64 è‡³ 121 è¡Œ ï¼šæ„å»ºå‘é€æ¶ˆæ¯è¯·æ±‚`SendMessageRequestHeader`ã€‚\n* ç¬¬ 107 è‡³ 117 è¡Œ ï¼šæ‰§è¡Œ `MQClientInstance#sendMessage(...)` å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚\n\n# 3ã€Broker æ¥æ”¶æ¶ˆæ¯\n\n> ![æ¥æ”¶å‘é€æ¶ˆæ¯APIé¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_04_18/04.png)\n\n## SendMessageProcessor#sendMessage\n\n```Java\n  1: @Override\n  2: public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request) throws RemotingCommandException {\n  3:     SendMessageContext mqtraceContext;\n  4:     switch (request.getCode()) {\n  5:         case RequestCode.CONSUMER_SEND_MSG_BACK:\n  6:             return this.consumerSendMsgBack(ctx, request);\n  7:         default:\n  8:             // è§£æè¯·æ±‚\n  9:             SendMessageRequestHeader requestHeader = parseRequestHeader(request);\n 10:             if (requestHeader == null) {\n 11:                 return null;\n 12:             }\n 13:             // å‘é€è¯·æ±‚Contextã€‚åœ¨ hook åœºæ™¯ä¸‹ä½¿ç”¨\n 14:             mqtraceContext = buildMsgContext(ctx, requestHeader);\n 15:             // hookï¼šå¤„ç†å‘é€æ¶ˆæ¯å‰é€»è¾‘\n 16:             this.executeSendMessageHookBefore(ctx, request, mqtraceContext);\n 17:             // å¤„ç†å‘é€æ¶ˆæ¯é€»è¾‘\n 18:             final RemotingCommand response = this.sendMessage(ctx, request, mqtraceContext, requestHeader);\n 19:             // hookï¼šå¤„ç†å‘é€æ¶ˆæ¯åé€»è¾‘\n 20:             this.executeSendMessageHookAfter(response, mqtraceContext);\n 21:             return response;\n 22:     }\n 23: }\n 24: \n 25: private RemotingCommand sendMessage(final ChannelHandlerContext ctx, //\n 26:     final RemotingCommand request, //\n 27:     final SendMessageContext sendMessageContext, //\n 28:     final SendMessageRequestHeader requestHeader) throws RemotingCommandException {\n 29: \n 30:     // åˆå§‹åŒ–å“åº”\n 31:     final RemotingCommand response = RemotingCommand.createResponseCommand(SendMessageResponseHeader.class);\n 32:     final SendMessageResponseHeader responseHeader = (SendMessageResponseHeader) response.readCustomHeader();\n 33:     response.setOpaque(request.getOpaque());\n 34:     response.addExtField(MessageConst.PROPERTY_MSG_REGION, this.brokerController.getBrokerConfig().getRegionId());\n 35:     response.addExtField(MessageConst.PROPERTY_TRACE_SWITCH, String.valueOf(this.brokerController.getBrokerConfig().isTraceOn()));\n 36: \n 37:     if (log.isDebugEnabled()) {\n 38:         log.debug(\"receive SendMessage request command, {}\", request);\n 39:     }\n 40: \n 41:     // å¦‚æœæœªå¼€å§‹æ¥æ”¶æ¶ˆæ¯ï¼ŒæŠ›å‡ºç³»ç»Ÿå¼‚å¸¸\n 42:     @SuppressWarnings(\"SpellCheckingInspection\")\n 43:     final long startTimstamp = this.brokerController.getBrokerConfig().getStartAcceptSendRequestTimeStamp();\n 44:     if (this.brokerController.getMessageStore().now() < startTimstamp) {\n 45:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 46:         response.setRemark(String.format(\"broker unable to service, until %s\", UtilAll.timeMillisToHumanString2(startTimstamp)));\n 47:         return response;\n 48:     }\n 49: \n 50:     // æ¶ˆæ¯é…ç½®(Topicé…ç½®ï¼‰æ ¡éªŒ\n 51:     response.setCode(-1);\n 52:     super.msgCheck(ctx, requestHeader, response);\n 53:     if (response.getCode() != -1) {\n 54:         return response;\n 55:     }\n 56: \n 57:     final byte[] body = request.getBody();\n 58: \n 59:     // å¦‚æœé˜Ÿåˆ—å°äº0ï¼Œä»å¯ç”¨é˜Ÿåˆ—éšæœºé€‰æ‹©\n 60:     int queueIdInt = requestHeader.getQueueId();\n 61:     TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());\n 62:     if (queueIdInt < 0) {\n 63:         queueIdInt = Math.abs(this.random.nextInt() % 99999999) % topicConfig.getWriteQueueNums();\n 64:     }\n 65: \n 66:     //\n 67:     int sysFlag = requestHeader.getSysFlag();\n 68:     if (TopicFilterType.MULTI_TAG == topicConfig.getTopicFilterType()) {\n 69:         sysFlag |= MessageSysFlag.MULTI_TAGS_FLAG;\n 70:     }\n 71: \n 72:     // å¯¹RETRYç±»å‹çš„æ¶ˆæ¯å¤„ç†ã€‚å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)\n 73:     String newTopic = requestHeader.getTopic();\n 74:     if (null != newTopic && newTopic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 75:         // è·å–è®¢é˜…åˆ†ç»„é…ç½®\n 76:         String groupName = newTopic.substring(MixAll.RETRY_GROUP_TOPIC_PREFIX.length());\n 77:         SubscriptionGroupConfig subscriptionGroupConfig =\n 78:             this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(groupName);\n 79:         if (null == subscriptionGroupConfig) {\n 80:             response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);\n 81:             response.setRemark(\"subscription group not exist, \" + groupName + \" \" + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));\n 82:             return response;\n 83:         }\n 84:         // è®¡ç®—æœ€å¤§å¯æ¶ˆè´¹æ¬¡æ•°\n 85:         int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();\n 86:         if (request.getVersion() >= MQVersion.Version.V3_4_9.ordinal()) {\n 87:             maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();\n 88:         }\n 89:         int reconsumeTimes = requestHeader.getReconsumeTimes() == null ? 0 : requestHeader.getReconsumeTimes();\n 90:         if (reconsumeTimes >= maxReconsumeTimes) { // è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°\n 91:             newTopic = MixAll.getDLQTopic(groupName);\n 92:             queueIdInt = Math.abs(this.random.nextInt() % 99999999) % DLQ_NUMS_PER_GROUP;\n 93:             topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, //\n 94:                 DLQ_NUMS_PER_GROUP, //\n 95:                 PermName.PERM_WRITE, 0\n 96:             );\n 97:             if (null == topicConfig) {\n 98:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n 99:                 response.setRemark(\"topic[\" + newTopic + \"] not exist\");\n100:                 return response;\n101:             }\n102:         }\n103:     }\n104: \n105:     // åˆ›å»ºMessageExtBrokerInner\n106:     MessageExtBrokerInner msgInner = new MessageExtBrokerInner();\n107:     msgInner.setTopic(newTopic);\n108:     msgInner.setBody(body);\n109:     msgInner.setFlag(requestHeader.getFlag());\n110:     MessageAccessor.setProperties(msgInner, MessageDecoder.string2messageProperties(requestHeader.getProperties()));\n111:     msgInner.setPropertiesString(requestHeader.getProperties());\n112:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(topicConfig.getTopicFilterType(), msgInner.getTags()));\n113:     msgInner.setQueueId(queueIdInt);\n114:     msgInner.setSysFlag(sysFlag);\n115:     msgInner.setBornTimestamp(requestHeader.getBornTimestamp());\n116:     msgInner.setBornHost(ctx.channel().remoteAddress());\n117:     msgInner.setStoreHost(this.getStoreHost());\n118:     msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == null ? 0 : requestHeader.getReconsumeTimes());\n119: \n120:     // æ ¡éªŒæ˜¯å¦ä¸å…è®¸å‘é€äº‹åŠ¡æ¶ˆæ¯\n121:     if (this.brokerController.getBrokerConfig().isRejectTransactionMessage()) {\n122:         String traFlag = msgInner.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);\n123:         if (traFlag != null) {\n124:             response.setCode(ResponseCode.NO_PERMISSION);\n125:             response.setRemark(\n126:                 \"the broker[\" + this.brokerController.getBrokerConfig().getBrokerIP1() + \"] sending transaction message is forbidden\");\n127:             return response;\n128:         }\n129:     }\n130: \n131:     // æ·»åŠ æ¶ˆæ¯\n132:     PutMessageResult putMessageResult = this.brokerController.getMessageStore().putMessage(msgInner);\n133:     if (putMessageResult != null) {\n134:         boolean sendOK = false;\n135: \n136:         switch (putMessageResult.getPutMessageStatus()) {\n137:             // Success\n138:             case PUT_OK:\n139:                 sendOK = true;\n140:                 response.setCode(ResponseCode.SUCCESS);\n141:                 break;\n142:             case FLUSH_DISK_TIMEOUT:\n143:                 response.setCode(ResponseCode.FLUSH_DISK_TIMEOUT);\n144:                 sendOK = true;\n145:                 break;\n146:             case FLUSH_SLAVE_TIMEOUT:\n147:                 response.setCode(ResponseCode.FLUSH_SLAVE_TIMEOUT);\n148:                 sendOK = true;\n149:                 break;\n150:             case SLAVE_NOT_AVAILABLE:\n151:                 response.setCode(ResponseCode.SLAVE_NOT_AVAILABLE);\n152:                 sendOK = true;\n153:                 break;\n154: \n155:             // Failed\n156:             case CREATE_MAPEDFILE_FAILED:\n157:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n158:                 response.setRemark(\"create mapped file failed, server is busy or broken.\");\n159:                 break;\n160:             case MESSAGE_ILLEGAL:\n161:             case PROPERTIES_SIZE_EXCEEDED:\n162:                 response.setCode(ResponseCode.MESSAGE_ILLEGAL);\n163:                 response.setRemark(\n164:                     \"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.\");\n165:                 break;\n166:             case SERVICE_NOT_AVAILABLE:\n167:                 response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);\n168:                 response.setRemark(\n169:                     \"service not available now, maybe disk full, \" + diskUtil() + \", maybe your broker machine memory too small.\");\n170:                 break;\n171:             case OS_PAGECACHE_BUSY:\n172:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n173:                 response.setRemark(\"[PC_SYNCHRONIZED]broker busy, start flow control for a while\");\n174:                 break;\n175:             case UNKNOWN_ERROR:\n176:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n177:                 response.setRemark(\"UNKNOWN_ERROR\");\n178:                 break;\n179:             default:\n180:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n181:                 response.setRemark(\"UNKNOWN_ERROR DEFAULT\");\n182:                 break;\n183:         }\n184: \n185:         String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);\n186:         if (sendOK) {\n187:             // ç»Ÿè®¡\n188:             this.brokerController.getBrokerStatsManager().incTopicPutNums(msgInner.getTopic());\n189:             this.brokerController.getBrokerStatsManager().incTopicPutSize(msgInner.getTopic(), putMessageResult.getAppendMessageResult().getWroteBytes());\n190:             this.brokerController.getBrokerStatsManager().incBrokerPutNums();\n191: \n192:             // å“åº”\n193:             response.setRemark(null);\n194:             responseHeader.setMsgId(putMessageResult.getAppendMessageResult().getMsgId());\n195:             responseHeader.setQueueId(queueIdInt);\n196:             responseHeader.setQueueOffset(putMessageResult.getAppendMessageResult().getLogicsOffset());\n197:             doResponse(ctx, request, response);\n198: \n199:             // hookï¼šè®¾ç½®å‘é€æˆåŠŸåˆ°context\n200:             if (hasSendMessageHook()) {\n201:                 sendMessageContext.setMsgId(responseHeader.getMsgId());\n202:                 sendMessageContext.setQueueId(responseHeader.getQueueId());\n203:                 sendMessageContext.setQueueOffset(responseHeader.getQueueOffset());\n204: \n205:                 int commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();\n206:                 int wroteSize = putMessageResult.getAppendMessageResult().getWroteBytes();\n207:                 int incValue = (int) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT) * commercialBaseCount;\n208: \n209:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_SUCCESS);\n210:                 sendMessageContext.setCommercialSendTimes(incValue);\n211:                 sendMessageContext.setCommercialSendSize(wroteSize);\n212:                 sendMessageContext.setCommercialOwner(owner);\n213:             }\n214:             return null;\n215:         } else {\n216:             // hookï¼šè®¾ç½®å‘é€å¤±è´¥åˆ°context\n217:             if (hasSendMessageHook()) {\n218:                 int wroteSize = request.getBody().length;\n219:                 int incValue = (int) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT);\n220: \n221:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_FAILURE);\n222:                 sendMessageContext.setCommercialSendTimes(incValue);\n223:                 sendMessageContext.setCommercialSendSize(wroteSize);\n224:                 sendMessageContext.setCommercialOwner(owner);\n225:             }\n226:         }\n227:     } else {\n228:         response.setCode(ResponseCode.SYSTEM_ERROR);\n229:         response.setRemark(\"store putMessage return null\");\n230:     }\n231: \n232:     return response;\n233: }\n```\n* `#processRequest()` è¯´æ˜ ï¼šå¤„ç†æ¶ˆæ¯è¯·æ±‚ã€‚\n* `#sendMessage()` è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯ï¼Œå¹¶è¿”å›å‘é€æ¶ˆæ¯ç»“æœã€‚\n* ç¬¬ 51 è‡³ 55 è¡Œ ï¼šæ¶ˆæ¯é…ç½®(Topicé…ç½®ï¼‰æ ¡éªŒï¼Œè¯¦ç»†è§£æè§ï¼š[AbstractSendMessageProcessor#msgCheck()](#abstractsendmessageprocessormsgcheck)ã€‚\n* ç¬¬ 60 è‡³ 64 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼–å·å°äº0æ—¶ï¼Œ`Broker` å¯ä»¥è®¾ç½®éšæœºé€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 72 è‡³ 103 è¡Œ ï¼šå¯¹RETRYç±»å‹çš„æ¶ˆæ¯å¤„ç†ã€‚å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œ å³åŠ   æ­»ä¿¡é˜Ÿ (Dead Letter Queue)ï¼Œè¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹](http://www.yunai.me/RocketMQ/topic/)ã€‚\n* ç¬¬ 105 è‡³ 118 è¡Œ ï¼šåˆ›å»º`MessageExtBrokerInner`ã€‚\n* ç¬¬ 132 ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œè¯¦ç»†è§£æè§ï¼š[DefaultMessageStore#putMessage()](defaultmessagestoreputmessage)ã€‚\n* ç¬¬ 133 è‡³ 183 è¡Œ ï¼šå¤„ç†æ¶ˆæ¯å‘é€ç»“æœï¼Œè®¾ç½®å“åº”ç»“æœå’Œæç¤ºã€‚\n* ç¬¬ 186 è‡³ 214 è¡Œ ï¼šå‘é€æˆåŠŸï¼Œå“åº”ã€‚è¿™é‡Œ`doResponse(ctx, request, response)`è¿›è¡Œå“åº”ï¼Œæœ€å`return null`ï¼ŒåŸå› æ˜¯ï¼šå“åº”ç»™ `Producer` å¯èƒ½å‘ç”Ÿå¼‚å¸¸ï¼Œ`#doResponse(ctx, request, response)`æ•æ‰äº†è¯¥å¼‚å¸¸å¹¶è¾“å‡ºæ—¥å¿—ã€‚è¿™æ ·åšçš„è¯ï¼Œæˆ‘ä»¬è¿›è¡Œæ’æŸ¥ `Broker` æ¥æ”¶æ¶ˆæ¯æˆåŠŸåå“åº”æ˜¯å¦å­˜åœ¨å¼‚å¸¸ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚\n\n### AbstractSendMessageProcessor#msgCheck\n\n```Java\n  1: protected RemotingCommand msgCheck(final ChannelHandlerContext ctx,\n  2:                                    final SendMessageRequestHeader requestHeader, final RemotingCommand response) {\n  3:     // æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™\n  4:     if (!PermName.isWriteable(this.brokerController.getBrokerConfig().getBrokerPermission())\n  5:         && this.brokerController.getTopicConfigManager().isOrderTopic(requestHeader.getTopic())) {\n  6:         response.setCode(ResponseCode.NO_PERMISSION);\n  7:         response.setRemark(\"the broker[\" + this.brokerController.getBrokerConfig().getBrokerIP1()\n  8:             + \"] sending message is forbidden\");\n  9:         return response;\n 10:     }\n 11:     // æ£€æŸ¥topicæ˜¯å¦å¯ä»¥è¢«å‘é€ã€‚ç›®å‰æ˜¯{@link MixAll.DEFAULT_TOPIC}ä¸è¢«å…è®¸å‘é€\n 12:     if (!this.brokerController.getTopicConfigManager().isTopicCanSendMessage(requestHeader.getTopic())) {\n 13:         String errorMsg = \"the topic[\" + requestHeader.getTopic() + \"] is conflict with system reserved words.\";\n 14:         log.warn(errorMsg);\n 15:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 16:         response.setRemark(errorMsg);\n 17:         return response;\n 18:     }\n 19:     TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());\n 20:     if (null == topicConfig) { // ä¸èƒ½å­˜åœ¨topicConfigï¼Œåˆ™è¿›è¡Œåˆ›å»º\n 21:         int topicSysFlag = 0;\n 22:         if (requestHeader.isUnitMode()) {\n 23:             if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 24:                 topicSysFlag = TopicSysFlag.buildSysFlag(false, true);\n 25:             } else {\n 26:                 topicSysFlag = TopicSysFlag.buildSysFlag(true, false);\n 27:             }\n 28:         }\n 29:         // åˆ›å»ºtopicé…ç½®\n 30:         log.warn(\"the topic {} not exist, producer: {}\", requestHeader.getTopic(), ctx.channel().remoteAddress());\n 31:         topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageMethod(//\n 32:             requestHeader.getTopic(), //\n 33:             requestHeader.getDefaultTopic(), //\n 34:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()), //\n 35:             requestHeader.getDefaultTopicQueueNums(), topicSysFlag);\n 36:         if (null == topicConfig) {\n 37:             if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 38:                 topicConfig =\n 39:                     this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(\n 40:                         requestHeader.getTopic(), 1, PermName.PERM_WRITE | PermName.PERM_READ,\n 41:                         topicSysFlag);\n 42:             }\n 43:         }\n 44:         // å¦‚æœæ²¡é…ç½®\n 45:         if (null == topicConfig) {\n 46:             response.setCode(ResponseCode.TOPIC_NOT_EXIST);\n 47:             response.setRemark(\"topic[\" + requestHeader.getTopic() + \"] not exist, apply first please!\"\n 48:                 + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));\n 49:             return response;\n 50:         }\n 51:     }\n 52:     // é˜Ÿåˆ—ç¼–å·æ˜¯å¦æ­£ç¡®\n 53:     int queueIdInt = requestHeader.getQueueId();\n 54:     int idValid = Math.max(topicConfig.getWriteQueueNums(), topicConfig.getReadQueueNums());\n 55:     if (queueIdInt >= idValid) {\n 56:         String errorInfo = String.format(\"request queueId[%d] is illegal, %s Producer: %s\",\n 57:             queueIdInt,\n 58:             topicConfig.toString(),\n 59:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()));\n 60:         log.warn(errorInfo);\n 61:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 62:         response.setRemark(errorInfo);\n 63:         return response;\n 64:     }\n 65:     return response;\n 66: }\n```\n* è¯´æ˜ï¼šæ ¡éªŒæ¶ˆæ¯æ˜¯å¦æ­£ç¡®ï¼Œä¸»è¦æ˜¯Topicé…ç½®æ–¹é¢ï¼Œä¾‹å¦‚ï¼š`Broker` æ˜¯å¦æœ‰å†™å…¥æƒé™ï¼Œtopicé…ç½®æ˜¯å¦å­˜åœ¨ï¼Œé˜Ÿåˆ—ç¼–å·æ˜¯å¦æ­£ç¡®ã€‚\n* ç¬¬ 11 è‡³ 18 è¡Œ ï¼šæ£€æŸ¥Topicæ˜¯å¦å¯ä»¥è¢«å‘é€ã€‚ç›®å‰æ˜¯ `{@link MixAll.DEFAULT_TOPIC}` ä¸è¢«å…è®¸å‘é€ã€‚\n* ç¬¬ 20 è‡³ 51 è¡Œ ï¼šå½“æ‰¾ä¸åˆ°Topicé…ç½®ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚å½“ç„¶ï¼Œåˆ›å»ºä¼šå­˜åœ¨ä¸æˆåŠŸçš„æƒ…å†µï¼Œä¾‹å¦‚è¯´ï¼š`defaultTopic` çš„Topicé…ç½®ä¸å­˜åœ¨ï¼Œåˆæˆ–è€…æ˜¯ å­˜åœ¨ä½†æ˜¯ä¸å…è®¸ç»§æ‰¿ï¼Œè¯¦ç»†è§£æè§[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹](http://www.yunai.me/RocketMQ/topic/)ã€‚\n\n## DefaultMessageStore#putMessage\n\n```Java\n  1: public PutMessageResult putMessage(MessageExtBrokerInner msg) {\n  2:     if (this.shutdown) {\n  3:         log.warn(\"message store has shutdown, so putMessage is forbidden\");\n  4:         return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);\n  5:     }\n  6: \n  7:     // ä»èŠ‚ç‚¹ä¸å…è®¸å†™å…¥\n  8:     if (BrokerRole.SLAVE == this.messageStoreConfig.getBrokerRole()) {\n  9:         long value = this.printTimes.getAndIncrement();\n 10:         if ((value % 50000) == 0) {\n 11:             log.warn(\"message store is slave mode, so putMessage is forbidden \");\n 12:         }\n 13: \n 14:         return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);\n 15:     }\n 16: \n 17:     // storeæ˜¯å¦å…è®¸å†™å…¥\n 18:     if (!this.runningFlags.isWriteable()) {\n 19:         long value = this.printTimes.getAndIncrement();\n 20:         if ((value % 50000) == 0) {\n 21:             log.warn(\"message store is not writeable, so putMessage is forbidden \" + this.runningFlags.getFlagBits());\n 22:         }\n 23: \n 24:         return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);\n 25:     } else {\n 26:         this.printTimes.set(0);\n 27:     }\n 28: \n 29:     // æ¶ˆæ¯è¿‡é•¿\n 30:     if (msg.getTopic().length() > Byte.MAX_VALUE) {\n 31:         log.warn(\"putMessage message topic length too long \" + msg.getTopic().length());\n 32:         return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, null);\n 33:     }\n 34: \n 35:     // æ¶ˆæ¯é™„åŠ å±æ€§è¿‡é•¿\n 36:     if (msg.getPropertiesString() != null && msg.getPropertiesString().length() > Short.MAX_VALUE) {\n 37:         log.warn(\"putMessage message properties length too long \" + msg.getPropertiesString().length());\n 38:         return new PutMessageResult(PutMessageStatus.PROPERTIES_SIZE_EXCEEDED, null);\n 39:     }\n 40: \n 41:     if (this.isOSPageCacheBusy()) {\n 42:         return new PutMessageResult(PutMessageStatus.OS_PAGECACHE_BUSY, null);\n 43:     }\n 44: \n 45:     long beginTime = this.getSystemClock().now();\n 46:     // æ·»åŠ æ¶ˆæ¯åˆ°commitLog\n 47:     PutMessageResult result = this.commitLog.putMessage(msg);\n 48: \n 49:     long eclipseTime = this.getSystemClock().now() - beginTime;\n 50:     if (eclipseTime > 500) {\n 51:         log.warn(\"putMessage not in lock eclipse time(ms)={}, bodyLength={}\", eclipseTime, msg.getBody().length);\n 52:     }\n 53:     this.storeStatsService.setPutMessageEntireTimeMax(eclipseTime);\n 54: \n 55:     if (null == result || !result.isOk()) {\n 56:         this.storeStatsService.getPutMessageFailedTimes().incrementAndGet();\n 57:     }\n 58: \n 59:     return result;\n 60: }\n```\n* è¯´æ˜ï¼šå­˜å‚¨æ¶ˆæ¯å°è£…ï¼Œæœ€ç»ˆå­˜å‚¨éœ€è¦ `CommitLog` å®ç°ã€‚\n* ç¬¬ 7 è‡³ 27 è¡Œ ï¼šæ ¡éªŒ `Broker` æ˜¯å¦å¯ä»¥å†™å…¥ã€‚\n* ç¬¬ 29 è‡³ 39 è¡Œ ï¼šæ¶ˆæ¯æ ¼å¼ä¸å¤§å°æ ¡éªŒã€‚\n* ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ `CommitLong` è¿›è¡Œå­˜å‚¨ï¼Œè¯¦ç»†é€»è¾‘è§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨ã€‹](http://www.yunai.me/RocketMQ/message-store/)\n\n# 4ã€æŸç§ç»“å°¾\n\næ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€ç‚¹èµæœ¬æ–‡çš„å·¥ç¨‹å¸ˆåŒå­¦ã€‚\n\né˜…è¯»æºç æ˜¯ä»¶ä»¤è‡ªå·±å¾ˆæ„‰æ‚¦çš„äº‹æƒ…ï¼Œç¼–å†™æºç è§£ææ˜¯è®©è‡ªå·±è„‘ç»†èƒæ­»ä¼¤æ— æ•°çš„è¿‡ç¨‹ï¼Œç—›å¹¶å¿«ä¹ç€ã€‚\n\nå¦‚æœæœ‰å†…å®¹å†™çš„å­˜åœ¨é”™è¯¯ï¼Œæˆ–æ˜¯ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œè§ç¬‘äº†ï¼ŒğŸ™‚ã€‚æ¬¢è¿åŠ  QQï¼š7685413 æˆ‘ä»¬ä¸€èµ·æ¢è®¨ï¼Œå…±è¿›æ­¥ã€‚\n\nå†æ¬¡æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€ç‚¹èµæœ¬æ–‡çš„å·¥ç¨‹å¸ˆåŒå­¦ã€‚\n\n\n\n\n\n\n\n\n\n","source":"_posts/RocketMQ/2017_04_18_RocketMQæºç åˆ†æâ€”â€”Messageå‘é€ä¸æ¥æ”¶.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶\ndate: 2017-04-18\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/message-send-and-receive\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[http://www.yunai.me/RocketMQ/message-send-and-receive/](http://www.yunai.me/RocketMQ/message-send-and-receive/)  \n> `RocketMQ` **å¸¦æ³¨é‡Šæºç **åœ°å€ ï¼š[https://github.com/YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **  \n\n![wechat_mp](http://www.yunai.me/images/common/wechat_mp.jpeg)\n\n-------\n\n- [1ã€æ¦‚è¿°](#)\n- [2ã€Producer å‘é€æ¶ˆæ¯](#)\n\t- [DefaultMQProducer#send(Message)](#)\n\t- [DefaultMQProducerImpl#sendDefaultImpl()](#)\n\t\t- [DefaultMQProducerImpl#tryToFindTopicPublishInfo()](#)\n\t\t- [MQFaultStrategy](#)\n\t\t\t- [MQFaultStrategy](#)\n\t\t\t- [LatencyFaultTolerance](#)\n\t\t\t- [LatencyFaultToleranceImpl](#)\n\t\t\t- [FaultItem](#)\n\t\t- [DefaultMQProducerImpl#sendKernelImpl()](#)\n- [3ã€Broker æ¥æ”¶æ¶ˆæ¯](#)\n\t- [SendMessageProcessor#sendMessage](#)\n\t\t- [AbstractSendMessageProcessor#msgCheck](#)\n\t- [DefaultMessageStore#putMessage](#)\n- [4ã€æŸç§ç»“å°¾](#)\n\n# 1ã€æ¦‚è¿°\n\n1. `Producer` å‘é€æ¶ˆæ¯ã€‚ä¸»è¦æ˜¯**åŒæ­¥**å‘é€æ¶ˆæ¯æºç ï¼Œæ¶‰åŠåˆ° å¼‚æ­¥/Onewayå‘é€æ¶ˆæ¯ï¼Œäº‹åŠ¡æ¶ˆæ¯ä¼šè·³è¿‡ã€‚\n2. `Broker` æ¥æ”¶æ¶ˆæ¯ã€‚(*å­˜å‚¨æ¶ˆæ¯åœ¨[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨ã€‹](http://www.yunai.me/RocketMQ/message-store/)è§£æ*)\n\n> ![Producerå‘é€æ¶ˆæ¯å…¨å±€é¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_04_18/01.png)\n\n# 2ã€Producer å‘é€æ¶ˆæ¯\n\n > ![Producerå‘é€æ¶ˆæ¯é¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_04_18/02.png)\n\n## DefaultMQProducer#send(Message)\n\n```Java\n  1: @Override\n  2: public SendResult send(Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  3:     return this.defaultMQProducerImpl.send(msg);\n  4: }\n```\n\n* è¯´æ˜ï¼šå‘é€åŒæ­¥æ¶ˆæ¯ï¼Œ`DefaultMQProducer#send(Message)` å¯¹ `DefaultMQProducerImpl#send(Message)` è¿›è¡Œå°è£…ã€‚  \n\n## DefaultMQProducerImpl#sendDefaultImpl()\n\n```Java\n  1: public SendResult send(Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  2:     return send(msg, this.defaultMQProducer.getSendMsgTimeout());\n  3: }\n  4: \n  5: public SendResult send(Message msg, long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  6:     return this.sendDefaultImpl(msg, CommunicationMode.SYNC, null, timeout);\n  7: }\n  8: \n  9: private SendResult sendDefaultImpl(//\n 10:     Message msg, //\n 11:     final CommunicationMode communicationMode, //\n 12:     final SendCallback sendCallback, //\n 13:     final long timeout//\n 14: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n 15:     // æ ¡éªŒ Producer å¤„äºè¿è¡ŒçŠ¶æ€\n 16:     this.makeSureStateOK();\n 17:     // æ ¡éªŒæ¶ˆæ¯æ ¼å¼\n 18:     Validators.checkMessage(msg, this.defaultMQProducer);\n 19:     //\n 20:     final long invokeID = random.nextLong(); // è°ƒç”¨ç¼–å·ï¼›ç”¨äºä¸‹é¢æ‰“å°æ—¥å¿—ï¼Œæ ‡è®°ä¸ºåŒä¸€æ¬¡å‘é€æ¶ˆæ¯\n 21:     long beginTimestampFirst = System.currentTimeMillis();\n 22:     long beginTimestampPrev = beginTimestampFirst;\n 23:     long endTimestamp = beginTimestampFirst;\n 24:     // è·å– Topicè·¯ç”±ä¿¡æ¯\n 25:     TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());\n 26:     if (topicPublishInfo != null && topicPublishInfo.ok()) {\n 27:         MessageQueue mq = null; // æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—\n 28:         Exception exception = null;\n 29:         SendResult sendResult = null; // æœ€åä¸€æ¬¡å‘é€ç»“æœ\n 30:         int timesTotal = communicationMode == CommunicationMode.SYNC ? 1 + this.defaultMQProducer.getRetryTimesWhenSendFailed() : 1; // åŒæ­¥å¤šæ¬¡è°ƒç”¨\n 31:         int times = 0; // ç¬¬å‡ æ¬¡å‘é€\n 32:         String[] brokersSent = new String[timesTotal]; // å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå\n 33:         // å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ\n 34:         for (; times < timesTotal; times++) {\n 35:             String lastBrokerName = null == mq ? null : mq.getBrokerName();\n 36:             MessageQueue tmpmq = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName); // é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—\n 37:             if (tmpmq != null) {\n 38:                 mq = tmpmq;\n 39:                 brokersSent[times] = mq.getBrokerName();\n 40:                 try {\n 41:                     beginTimestampPrev = System.currentTimeMillis();\n 42:                     // è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•\n 43:                     sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);\n 44:                     endTimestamp = System.currentTimeMillis();\n 45:                     // æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯\n 46:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);\n 47:                     switch (communicationMode) {\n 48:                         case ASYNC:\n 49:                             return null;\n 50:                         case ONEWAY:\n 51:                             return null;\n 52:                         case SYNC:\n 53:                             if (sendResult.getSendStatus() != SendStatus.SEND_OK) {\n 54:                                 if (this.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) { // åŒæ­¥å‘é€æˆåŠŸä½†å­˜å‚¨æœ‰é—®é¢˜æ—¶ && é…ç½®å­˜å‚¨å¼‚å¸¸æ—¶é‡æ–°å‘é€å¼€å…³ æ—¶ï¼Œè¿›è¡Œé‡è¯•\n 55:                                     continue;\n 56:                                 }\n 57:                             }\n 58:                             return sendResult;\n 59:                         default:\n 60:                             break;\n 61:                     }\n 62:                 } catch (RemotingException e) { // æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œæ›´æ–°ç»§ç»­å¾ªç¯\n 63:                     endTimestamp = System.currentTimeMillis();\n 64:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);\n 65:                     log.warn(String.format(\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\", invokeID, endTimestamp - beginTimestampPrev, mq), e);\n 66:                     log.warn(msg.toString());\n 67:                     exception = e;\n 68:                     continue;\n 69:                 } catch (MQClientException e) { // æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œç»§ç»­å¾ªç¯\n 70:                     endTimestamp = System.currentTimeMillis();\n 71:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);\n 72:                     log.warn(String.format(\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\", invokeID, endTimestamp - beginTimestampPrev, mq), e);\n 73:                     log.warn(msg.toString());\n 74:                     exception = e;\n 75:                     continue;\n 76:                 } catch (MQBrokerException e) { // æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ï¼Œç»“æŸå¾ªç¯\n 77:                     endTimestamp = System.currentTimeMillis();\n 78:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);\n 79:                     log.warn(String.format(\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\", invokeID, endTimestamp - beginTimestampPrev, mq), e);\n 80:                     log.warn(msg.toString());\n 81:                     exception = e;\n 82:                     switch (e.getResponseCode()) {\n 83:                         // å¦‚ä¸‹å¼‚å¸¸continueï¼Œè¿›è¡Œå‘é€æ¶ˆæ¯é‡è¯•\n 84:                         case ResponseCode.TOPIC_NOT_EXIST:\n 85:                         case ResponseCode.SERVICE_NOT_AVAILABLE:\n 86:                         case ResponseCode.SYSTEM_ERROR:\n 87:                         case ResponseCode.NO_PERMISSION:\n 88:                         case ResponseCode.NO_BUYER_ID:\n 89:                         case ResponseCode.NOT_IN_CURRENT_UNIT:\n 90:                             continue;\n 91:                         // å¦‚æœæœ‰å‘é€ç»“æœï¼Œè¿›è¡Œè¿”å›ï¼Œå¦åˆ™ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›\n 92:                         default:\n 93:                             if (sendResult != null) {\n 94:                                 return sendResult;\n 95:                             }\n 96:                             throw e;\n 97:                     }\n 98:                 } catch (InterruptedException e) {\n 99:                     endTimestamp = System.currentTimeMillis();\n100:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);\n101:                     log.warn(String.format(\"sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s\", invokeID, endTimestamp - beginTimestampPrev, mq), e);\n102:                     log.warn(msg.toString());\n103:                     throw e;\n104:                 }\n105:             } else {\n106:                 break;\n107:             }\n108:         }\n109:         // è¿”å›å‘é€ç»“æœ\n110:         if (sendResult != null) {\n111:             return sendResult;\n112:         }\n113:         // æ ¹æ®ä¸åŒæƒ…å†µï¼ŒæŠ›å‡ºä¸åŒçš„å¼‚å¸¸\n114:         String info = String.format(\"Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s\", times, System.currentTimeMillis() - beginTimestampFirst,\n115:                 msg.getTopic(), Arrays.toString(brokersSent)) + FAQUrl.suggestTodo(FAQUrl.SEND_MSG_FAILED);\n116:         MQClientException mqClientException = new MQClientException(info, exception);\n117:         if (exception instanceof MQBrokerException) {\n118:             mqClientException.setResponseCode(((MQBrokerException) exception).getResponseCode());\n119:         } else if (exception instanceof RemotingConnectException) {\n120:             mqClientException.setResponseCode(ClientErrorCode.CONNECT_BROKER_EXCEPTION);\n121:         } else if (exception instanceof RemotingTimeoutException) {\n122:             mqClientException.setResponseCode(ClientErrorCode.ACCESS_BROKER_TIMEOUT);\n123:         } else if (exception instanceof MQClientException) {\n124:             mqClientException.setResponseCode(ClientErrorCode.BROKER_NOT_EXIST_EXCEPTION);\n125:         }\n126:         throw mqClientException;\n127:     }\n128:     // Namesrvæ‰¾ä¸åˆ°å¼‚å¸¸\n129:     List<String> nsList = this.getmQClientFactory().getMQClientAPIImpl().getNameServerAddressList();\n130:     if (null == nsList || nsList.isEmpty()) {\n131:         throw new MQClientException(\n132:             \"No name server address, please set it.\" + FAQUrl.suggestTodo(FAQUrl.NAME_SERVER_ADDR_NOT_EXIST_URL), null).setResponseCode(ClientErrorCode.NO_NAME_SERVER_EXCEPTION);\n133:     }\n134:     // æ¶ˆæ¯è·¯ç”±æ‰¾ä¸åˆ°å¼‚å¸¸\n135:     throw new MQClientException(\"No route info of this topic, \" + msg.getTopic() + FAQUrl.suggestTodo(FAQUrl.NO_TOPIC_ROUTE_INFO),\n136:         null).setResponseCode(ClientErrorCode.NOT_FOUND_TOPIC_EXCEPTION);\n137: }\n```\n* è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯ã€‚æ­¥éª¤ï¼šè·å–æ¶ˆæ¯è·¯ç”±ä¿¡æ¯ï¼Œé€‰æ‹©è¦å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ‰§è¡Œæ¶ˆæ¯å‘é€æ ¸å¿ƒæ–¹æ³•ï¼Œå¹¶å¯¹å‘é€ç»“æœè¿›è¡Œå°è£…è¿”å›ã€‚\n* ç¬¬ 1  è‡³ 7 è¡Œï¼šå¯¹`sendsendDefaultImpl(...)`è¿›è¡Œå°è£…ã€‚\n* ç¬¬ 20 è¡Œ ï¼š`invokeID`ä»…ä»…ç”¨äºæ‰“å°æ—¥å¿—ï¼Œæ— å®é™…çš„ä¸šåŠ¡ç”¨é€”ã€‚\n* ç¬¬ 25 è¡Œ ï¼šè·å– Topicè·¯ç”±ä¿¡æ¯ï¼Œ è¯¦ç»†è§£æè§ï¼š[DefaultMQProducerImpl#tryToFindTopicPublishInfo()](#defaultmqproducerimpltrytofindtopicpublishinfo)\n* ç¬¬ 30 & 34 è¡Œ ï¼šè®¡ç®—è°ƒç”¨å‘é€æ¶ˆæ¯åˆ°æˆåŠŸä¸ºæ­¢çš„æœ€å¤§æ¬¡æ•°ï¼Œå¹¶è¿›è¡Œå¾ªç¯ã€‚åŒæ­¥æˆ–å¼‚æ­¥å‘é€æ¶ˆæ¯ä¼šè°ƒç”¨å¤šæ¬¡ï¼Œé»˜è®¤é…ç½®ä¸º3æ¬¡ã€‚\n* ç¬¬ 36 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—ï¼Œè¯¦ç»†è§£æè§ï¼š[MQFaultStrategy](#mqfaultstrategy)\n* ç¬¬ 43 è¡Œ ï¼šè°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š[DefaultMQProducerImpl#sendKernelImpl()](#defaultmqproducerimplsendkernelimpl)\n* ç¬¬ 46 è¡Œ ï¼šæ›´æ–°`Broker`å¯ç”¨æ€§ä¿¡æ¯ã€‚åœ¨é€‰æ‹©å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‚è€ƒ`Broker`å‘é€æ¶ˆæ¯çš„å»¶è¿Ÿï¼Œè¯¦ç»†è§£æè§ï¼š[MQFaultStrategy](#mqfaultstrategy)\n* ç¬¬ 62 è‡³ 68 è¡Œï¼šå½“æŠ›å‡º`RemotingException`æ—¶ï¼Œå¦‚æœè¿›è¡Œæ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•ï¼Œåˆ™**å¯èƒ½å¯¼è‡´æ¶ˆæ¯å‘é€é‡å¤**ã€‚ä¾‹å¦‚ï¼Œå‘é€æ¶ˆæ¯è¶…æ—¶(`RemotingTimeoutException`)ï¼Œå®é™…`Broker`æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯å¹¶å¤„ç†æˆåŠŸã€‚å› æ­¤ï¼Œ`Consumer`åœ¨æ¶ˆè´¹æ—¶ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚\n\n### DefaultMQProducerImpl#tryToFindTopicPublishInfo()\n\n```Java\n  1: private TopicPublishInfo tryToFindTopicPublishInfo(final String topic) {\n  2:     // ç¼“å­˜ä¸­è·å– Topicå‘å¸ƒä¿¡æ¯\n  3:     TopicPublishInfo topicPublishInfo = this.topicPublishInfoTable.get(topic);\n  4:     // å½“æ— å¯ç”¨çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶ï¼Œä»Namesrvè·å–ä¸€æ¬¡\n  5:     if (null == topicPublishInfo || !topicPublishInfo.ok()) {\n  6:         this.topicPublishInfoTable.putIfAbsent(topic, new TopicPublishInfo());\n  7:         this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);\n  8:         topicPublishInfo = this.topicPublishInfoTable.get(topic);\n  9:     }\n 10:     // è‹¥è·å–çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶å€™å¯ç”¨ï¼Œåˆ™è¿”å›\n 11:     if (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) {\n 12:         return topicPublishInfo;\n 13:     } else { // ä½¿ç”¨ {@link DefaultMQProducer#createTopicKey} å¯¹åº”çš„ Topicå‘å¸ƒä¿¡æ¯ã€‚ç”¨äº Topicå‘å¸ƒä¿¡æ¯ä¸å­˜åœ¨ && Brokeræ”¯æŒè‡ªåŠ¨åˆ›å»ºTopic\n 14:         this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, true, this.defaultMQProducer);\n 15:         topicPublishInfo = this.topicPublishInfoTable.get(topic);\n 16:         return topicPublishInfo;\n 17:     }\n 18: }\n```\n* è¯´æ˜ ï¼šè·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚ä¼˜å…ˆä»ç¼“å­˜`topicPublishInfoTable`ï¼Œå…¶æ¬¡ä»`Namesrv`ä¸­è·å¾—ã€‚\n* ç¬¬ 3 è¡Œ ï¼šä»ç¼“å­˜`topicPublishInfoTable`ä¸­è·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚\n* ç¬¬ 5 è‡³ 9 è¡Œ ï¼šä» `Namesrv` ä¸­è·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚\n* ç¬¬ 13 è‡³ 17 è¡Œ ï¼šå½“ä» `Namesrv` æ— æ³•è·å–æ—¶ï¼Œä½¿ç”¨ `{@link DefaultMQProducer#createTopicKey}` å¯¹åº”çš„ Topicå‘å¸ƒä¿¡æ¯ã€‚ç›®çš„æ˜¯å½“ `Broker` å¼€å¯è‡ªåŠ¨åˆ›å»º Topicå¼€å…³æ—¶ï¼Œ`Broker` æ¥æ”¶åˆ°æ¶ˆæ¯åè‡ªåŠ¨åˆ›å»ºTopicï¼Œè¯¦ç»†è§£æè§[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹](http://www.yunai.me/RocketMQ/topic/)ã€‚\n\n### MQFaultStrategy\n\n> ![Latencyç±»å›¾](http://www.yunai.me/images/RocketMQ/2017_04_18/03.png)\n\n#### MQFaultStrategy\n\n```Java\n  1: public class MQFaultStrategy {\n  2:     private final static Logger log = ClientLogger.getLog();\n  3: \n  4:     /**\n  5:      * å»¶è¿Ÿæ•…éšœå®¹é”™ï¼Œç»´æŠ¤æ¯ä¸ªBrokerçš„å‘é€æ¶ˆæ¯çš„å»¶è¿Ÿ\n  6:      * keyï¼šbrokerName\n  7:      */\n  8:     private final LatencyFaultTolerance<String> latencyFaultTolerance = new LatencyFaultToleranceImpl();\n  9:     /**\n 10:      * å‘é€æ¶ˆæ¯å»¶è¿Ÿå®¹é”™å¼€å…³\n 11:      */\n 12:     private boolean sendLatencyFaultEnable = false;\n 13:     /**\n 14:      * å»¶è¿Ÿçº§åˆ«æ•°ç»„\n 15:      */\n 16:     private long[] latencyMax = {50L, 100L, 550L, 1000L, 2000L, 3000L, 15000L};\n 17:     /**\n 18:      * ä¸å¯ç”¨æ—¶é•¿æ•°ç»„\n 19:      */\n 20:     private long[] notAvailableDuration = {0L, 0L, 30000L, 60000L, 120000L, 180000L, 600000L};\n 21: \n 22:     /**\n 23:      * æ ¹æ® Topicå‘å¸ƒä¿¡æ¯ é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—\n 24:      *\n 25:      * @param tpInfo Topicå‘å¸ƒä¿¡æ¯\n 26:      * @param lastBrokerName brokerName\n 27:      * @return æ¶ˆæ¯é˜Ÿåˆ—\n 28:      */\n 29:     public MessageQueue selectOneMessageQueue(final TopicPublishInfo tpInfo, final String lastBrokerName) {\n 30:         if (this.sendLatencyFaultEnable) {\n 31:             try {\n 32:                 // è·å– brokerName=lastBrokerName && å¯ç”¨çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—\n 33:                 int index = tpInfo.getSendWhichQueue().getAndIncrement();\n 34:                 for (int i = 0; i < tpInfo.getMessageQueueList().size(); i++) {\n 35:                     int pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();\n 36:                     if (pos < 0)\n 37:                         pos = 0;\n 38:                     MessageQueue mq = tpInfo.getMessageQueueList().get(pos);\n 39:                     if (latencyFaultTolerance.isAvailable(mq.getBrokerName())) {\n 40:                         if (null == lastBrokerName || mq.getBrokerName().equals(lastBrokerName))\n 41:                             return mq;\n 42:                     }\n 43:                 }\n 44:                 // é€‰æ‹©ä¸€ä¸ªç›¸å¯¹å¥½çš„brokerï¼Œå¹¶è·å¾—å…¶å¯¹åº”çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘è¯¥é˜Ÿåˆ—çš„å¯ç”¨æ€§\n 45:                 final String notBestBroker = latencyFaultTolerance.pickOneAtLeast();\n 46:                 int writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);\n 47:                 if (writeQueueNums > 0) {\n 48:                     final MessageQueue mq = tpInfo.selectOneMessageQueue();\n 49:                     if (notBestBroker != null) {\n 50:                         mq.setBrokerName(notBestBroker);\n 51:                         mq.setQueueId(tpInfo.getSendWhichQueue().getAndIncrement() % writeQueueNums);\n 52:                     }\n 53:                     return mq;\n 54:                 } else {\n 55:                     latencyFaultTolerance.remove(notBestBroker);\n 56:                 }\n 57:             } catch (Exception e) {\n 58:                 log.error(\"Error occurred when selecting message queue\", e);\n 59:             }\n 60:             // é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘é˜Ÿåˆ—çš„å¯ç”¨æ€§\n 61:             return tpInfo.selectOneMessageQueue();\n 62:         }\n 63:         // è·å¾— lastBrokerName å¯¹åº”çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘è¯¥é˜Ÿåˆ—çš„å¯ç”¨æ€§\n 64:         return tpInfo.selectOneMessageQueue(lastBrokerName);\n 65:     }\n 66: \n 67:     /**\n 68:      * æ›´æ–°å»¶è¿Ÿå®¹é”™ä¿¡æ¯\n 69:      *\n 70:      * @param brokerName brokerName\n 71:      * @param currentLatency å»¶è¿Ÿ\n 72:      * @param isolation æ˜¯å¦éš”ç¦»ã€‚å½“å¼€å¯éš”ç¦»æ—¶ï¼Œé»˜è®¤å»¶è¿Ÿä¸º30000ã€‚ç›®å‰ä¸»è¦ç”¨äºå‘é€æ¶ˆæ¯å¼‚å¸¸æ—¶\n 73:      */\n 74:     public void updateFaultItem(final String brokerName, final long currentLatency, boolean isolation) {\n 75:         if (this.sendLatencyFaultEnable) {\n 76:             long duration = computeNotAvailableDuration(isolation ? 30000 : currentLatency);\n 77:             this.latencyFaultTolerance.updateFaultItem(brokerName, currentLatency, duration);\n 78:         }\n 79:     }\n 80: \n 81:     /**\n 82:      * è®¡ç®—å»¶è¿Ÿå¯¹åº”çš„ä¸å¯ç”¨æ—¶é—´\n 83:      *\n 84:      * @param currentLatency å»¶è¿Ÿ\n 85:      * @return ä¸å¯ç”¨æ—¶é—´\n 86:      */\n 87:     private long computeNotAvailableDuration(final long currentLatency) {\n 88:         for (int i = latencyMax.length - 1; i >= 0; i--) {\n 89:             if (currentLatency >= latencyMax[i])\n 90:                 return this.notAvailableDuration[i];\n 91:         }\n 92:         return 0;\n 93:     }\n```\n* è¯´æ˜ ï¼š`Producer`æ¶ˆæ¯å‘é€å®¹é”™ç­–ç•¥ã€‚é»˜è®¤æƒ…å†µä¸‹å®¹é”™ç­–ç•¥å…³é—­ï¼Œå³`sendLatencyFaultEnable=false`ã€‚\n* ç¬¬ 30 è‡³ 62 è¡Œ ï¼šå®¹é”™ç­–ç•¥é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ã€‚ä¼˜å…ˆè·å–å¯ç”¨é˜Ÿåˆ—ï¼Œå…¶æ¬¡é€‰æ‹©ä¸€ä¸ªbrokerè·å–é˜Ÿåˆ—ï¼Œæœ€å·®è¿”å›ä»»æ„brokerçš„ä¸€ä¸ªé˜Ÿåˆ—ã€‚\n* ç¬¬ 64 è¡Œ ï¼šæœªå¼€å¯å®¹é”™ç­–ç•¥é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ã€‚\n* ç¬¬ 74 è‡³ 79 è¡Œ ï¼šæ›´æ–°å»¶è¿Ÿå®¹é”™ä¿¡æ¯ã€‚å½“ `Producer` å‘é€æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œåˆ™é€»è¾‘è®¤ä¸ºNç§’å†…ä¸å¯ç”¨ã€‚æŒ‰ç…§`latencyMax`ï¼Œ`notAvailableDuration`çš„é…ç½®ï¼Œå¯¹åº”å¦‚ä¸‹ï¼š\n\n    | Producerå‘é€æ¶ˆæ¯æ¶ˆè€—æ—¶é•¿ | Brokerä¸å¯ç”¨æ—¶é•¿ |\n    | --- | --- |\n    | >= 15000 ms | 600 * 1000 ms  |\n    | >= 3000 ms | 180 * 1000 ms  |\n    | >= 2000 ms | 120 * 1000 ms  |\n    | >= 1000 ms | 60 * 1000 ms  |\n    | >= 550 ms | 30 * 1000 ms |\n    | >= 100 ms | 0 ms |\n    | >= 50 ms | 0 ms |\n\n#### LatencyFaultTolerance\n\n```Java\n  1: public interface LatencyFaultTolerance<T> {\n  2: \n  3:     /**\n  4:      * æ›´æ–°å¯¹åº”çš„å»¶è¿Ÿå’Œä¸å¯ç”¨æ—¶é•¿\n  5:      *\n  6:      * @param name å¯¹è±¡\n  7:      * @param currentLatency å»¶è¿Ÿ\n  8:      * @param notAvailableDuration ä¸å¯ç”¨æ—¶é•¿\n  9:      */\n 10:     void updateFaultItem(final T name, final long currentLatency, final long notAvailableDuration);\n 11: \n 12:     /**\n 13:      * å¯¹è±¡æ˜¯å¦å¯ç”¨\n 14:      *\n 15:      * @param name å¯¹è±¡\n 16:      * @return æ˜¯å¦å¯ç”¨\n 17:      */\n 18:     boolean isAvailable(final T name);\n 19: \n 20:     /**\n 21:      * ç§»é™¤å¯¹è±¡\n 22:      *\n 23:      * @param name å¯¹è±¡\n 24:      */\n 25:     void remove(final T name);\n 26: \n 27:     /**\n 28:      * è·å–ä¸€ä¸ªå¯¹è±¡\n 29:      *\n 30:      * @return å¯¹è±¡\n 31:      */\n 32:     T pickOneAtLeast();\n 33: }\n```\n* è¯´æ˜ ï¼šå»¶è¿Ÿæ•…éšœå®¹é”™æ¥å£\n\n#### LatencyFaultToleranceImpl\n\n```Java\n  1: public class LatencyFaultToleranceImpl implements LatencyFaultTolerance<String> {\n  2: \n  3:     /**\n  4:      * å¯¹è±¡æ•…éšœä¿¡æ¯Table\n  5:      */\n  6:     private final ConcurrentHashMap<String, FaultItem> faultItemTable = new ConcurrentHashMap<>(16);\n  7:     /**\n  8:      * å¯¹è±¡é€‰æ‹©Index\n  9:      * @see #pickOneAtLeast()\n 10:      */\n 11:     private final ThreadLocalIndex whichItemWorst = new ThreadLocalIndex();\n 12: \n 13:     @Override\n 14:     public void updateFaultItem(final String name, final long currentLatency, final long notAvailableDuration) {\n 15:         FaultItem old = this.faultItemTable.get(name);\n 16:         if (null == old) {\n 17:             // åˆ›å»ºå¯¹è±¡\n 18:             final FaultItem faultItem = new FaultItem(name);\n 19:             faultItem.setCurrentLatency(currentLatency);\n 20:             faultItem.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);\n 21:             // æ›´æ–°å¯¹è±¡\n 22:             old = this.faultItemTable.putIfAbsent(name, faultItem);\n 23:             if (old != null) {\n 24:                 old.setCurrentLatency(currentLatency);\n 25:                 old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);\n 26:             }\n 27:         } else { // æ›´æ–°å¯¹è±¡\n 28:             old.setCurrentLatency(currentLatency);\n 29:             old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);\n 30:         }\n 31:     }\n 32: \n 33:     @Override\n 34:     public boolean isAvailable(final String name) {\n 35:         final FaultItem faultItem = this.faultItemTable.get(name);\n 36:         if (faultItem != null) {\n 37:             return faultItem.isAvailable();\n 38:         }\n 39:         return true;\n 40:     }\n 41: \n 42:     @Override\n 43:     public void remove(final String name) {\n 44:         this.faultItemTable.remove(name);\n 45:     }\n 46: \n 47:     /**\n 48:      * é€‰æ‹©ä¸€ä¸ªç›¸å¯¹ä¼˜ç§€çš„å¯¹è±¡\n 49:      *\n 50:      * @return å¯¹è±¡\n 51:      */\n 52:     @Override\n 53:     public String pickOneAtLeast() {\n 54:         // åˆ›å»ºæ•°ç»„\n 55:         final Enumeration<FaultItem> elements = this.faultItemTable.elements();\n 56:         List<FaultItem> tmpList = new LinkedList<>();\n 57:         while (elements.hasMoreElements()) {\n 58:             final FaultItem faultItem = elements.nextElement();\n 59:             tmpList.add(faultItem);\n 60:         }\n 61:         //\n 62:         if (!tmpList.isEmpty()) {\n 63:             // æ‰“ä¹± + æ’åºã€‚TODO ç–‘é—®ï¼šåº”è¯¥åªèƒ½äºŒé€‰ä¸€ã€‚çŒœæµ‹Collections.shuffle(tmpList)å»æ‰ã€‚\n 64:             Collections.shuffle(tmpList);\n 65:             Collections.sort(tmpList);\n 66:             // é€‰æ‹©é¡ºåºåœ¨å‰ä¸€åŠçš„å¯¹è±¡\n 67:             final int half = tmpList.size() / 2;\n 68:             if (half <= 0) {\n 69:                 return tmpList.get(0).getName();\n 70:             } else {\n 71:                 final int i = this.whichItemWorst.getAndIncrement() % half;\n 72:                 return tmpList.get(i).getName();\n 73:             }\n 74:         }\n 75:         return null;\n 76:     }\n 77: }\n```\n\n* è¯´æ˜ ï¼šå»¶è¿Ÿæ•…éšœå®¹é”™å®ç°ã€‚ç»´æŠ¤æ¯ä¸ªå¯¹è±¡çš„ä¿¡æ¯ã€‚\n\n#### FaultItem\n\n```Java\n  1: class FaultItem implements Comparable<FaultItem> {\n  2:     /**\n  3:      * å¯¹è±¡å\n  4:      */\n  5:     private final String name;\n  6:     /**\n  7:      * å»¶è¿Ÿ\n  8:      */\n  9:     private volatile long currentLatency;\n 10:     /**\n 11:      * å¼€å§‹å¯ç”¨æ—¶é—´\n 12:      */\n 13:     private volatile long startTimestamp;\n 14: \n 15:     public FaultItem(final String name) {\n 16:         this.name = name;\n 17:     }\n 18: \n 19:     /**\n 20:      * æ¯”è¾ƒå¯¹è±¡\n 21:      * å¯ç”¨æ€§ > å»¶è¿Ÿ > å¼€å§‹å¯ç”¨æ—¶é—´\n 22:      *\n 23:      * @param other other\n 24:      * @return å‡åº\n 25:      */\n 26:     @Override\n 27:     public int compareTo(final FaultItem other) {\n 28:         if (this.isAvailable() != other.isAvailable()) {\n 29:             if (this.isAvailable())\n 30:                 return -1;\n 31: \n 32:             if (other.isAvailable())\n 33:                 return 1;\n 34:         }\n 35: \n 36:         if (this.currentLatency < other.currentLatency)\n 37:             return -1;\n 38:         else if (this.currentLatency > other.currentLatency) {\n 39:             return 1;\n 40:         }\n 41: \n 42:         if (this.startTimestamp < other.startTimestamp)\n 43:             return -1;\n 44:         else if (this.startTimestamp > other.startTimestamp) {\n 45:             return 1;\n 46:         }\n 47: \n 48:         return 0;\n 49:     }\n 50: \n 51:     /**\n 52:      * æ˜¯å¦å¯ç”¨ï¼šå½“å¼€å§‹å¯ç”¨æ—¶é—´å¤§äºå½“å‰æ—¶é—´\n 53:      *\n 54:      * @return æ˜¯å¦å¯ç”¨\n 55:      */\n 56:     public boolean isAvailable() {\n 57:         return (System.currentTimeMillis() - startTimestamp) >= 0;\n 58:     }\n 59: \n 60:     @Override\n 61:     public int hashCode() {\n 62:         int result = getName() != null ? getName().hashCode() : 0;\n 63:         result = 31 * result + (int) (getCurrentLatency() ^ (getCurrentLatency() >>> 32));\n 64:         result = 31 * result + (int) (getStartTimestamp() ^ (getStartTimestamp() >>> 32));\n 65:         return result;\n 66:     }\n 67: \n 68:     @Override\n 69:     public boolean equals(final Object o) {\n 70:         if (this == o)\n 71:             return true;\n 72:         if (!(o instanceof FaultItem))\n 73:             return false;\n 74: \n 75:         final FaultItem faultItem = (FaultItem) o;\n 76: \n 77:         if (getCurrentLatency() != faultItem.getCurrentLatency())\n 78:             return false;\n 79:         if (getStartTimestamp() != faultItem.getStartTimestamp())\n 80:             return false;\n 81:         return getName() != null ? getName().equals(faultItem.getName()) : faultItem.getName() == null;\n 82: \n 83:     }\n 84: }\n```\n* è¯´æ˜ ï¼šå¯¹è±¡æ•…éšœä¿¡æ¯ã€‚ç»´æŠ¤å¯¹è±¡çš„åå­—ã€å»¶è¿Ÿã€å¼€å§‹å¯ç”¨çš„æ—¶é—´ã€‚\n\n### DefaultMQProducerImpl#sendKernelImpl()\n\n```Java\n  1: private SendResult sendKernelImpl(final Message msg, //\n  2:     final MessageQueue mq, //\n  3:     final CommunicationMode communicationMode, //\n  4:     final SendCallback sendCallback, //\n  5:     final TopicPublishInfo topicPublishInfo, //\n  6:     final long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  7:     // è·å– brokeråœ°å€\n  8:     String brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());\n  9:     if (null == brokerAddr) {\n 10:         tryToFindTopicPublishInfo(mq.getTopic());\n 11:         brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());\n 12:     }\n 13:     //\n 14:     SendMessageContext context = null;\n 15:     if (brokerAddr != null) {\n 16:         // æ˜¯å¦ä½¿ç”¨broker vipé€šé“ã€‚brokerä¼šå¼€å¯ä¸¤ä¸ªç«¯å£å¯¹å¤–æœåŠ¡ã€‚\n 17:         brokerAddr = MixAll.brokerVIPChannel(this.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr);\n 18:         byte[] prevBody = msg.getBody(); // è®°å½•æ¶ˆæ¯å†…å®¹ã€‚ä¸‹é¢é€»è¾‘å¯èƒ½æ”¹å˜æ¶ˆæ¯å†…å®¹ï¼Œä¾‹å¦‚æ¶ˆæ¯å‹ç¼©ã€‚\n 19:         try {\n 20:             // è®¾ç½®å”¯ä¸€ç¼–å·\n 21:             MessageClientIDSetter.setUniqID(msg);\n 22:             // æ¶ˆæ¯å‹ç¼©\n 23:             int sysFlag = 0;\n 24:             if (this.tryToCompressMessage(msg)) {\n 25:                 sysFlag |= MessageSysFlag.COMPRESSED_FLAG;\n 26:             }\n 27:             // äº‹åŠ¡\n 28:             final String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);\n 29:             if (tranMsg != null && Boolean.parseBoolean(tranMsg)) {\n 30:                 sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;\n 31:             }\n 32:             // hookï¼šå‘é€æ¶ˆæ¯æ ¡éªŒ\n 33:             if (hasCheckForbiddenHook()) {\n 34:                 CheckForbiddenContext checkForbiddenContext = new CheckForbiddenContext();\n 35:                 checkForbiddenContext.setNameSrvAddr(this.defaultMQProducer.getNamesrvAddr());\n 36:                 checkForbiddenContext.setGroup(this.defaultMQProducer.getProducerGroup());\n 37:                 checkForbiddenContext.setCommunicationMode(communicationMode);\n 38:                 checkForbiddenContext.setBrokerAddr(brokerAddr);\n 39:                 checkForbiddenContext.setMessage(msg);\n 40:                 checkForbiddenContext.setMq(mq);\n 41:                 checkForbiddenContext.setUnitMode(this.isUnitMode());\n 42:                 this.executeCheckForbiddenHook(checkForbiddenContext);\n 43:             }\n 44:             // hookï¼šå‘é€æ¶ˆæ¯å‰é€»è¾‘\n 45:             if (this.hasSendMessageHook()) {\n 46:                 context = new SendMessageContext();\n 47:                 context.setProducer(this);\n 48:                 context.setProducerGroup(this.defaultMQProducer.getProducerGroup());\n 49:                 context.setCommunicationMode(communicationMode);\n 50:                 context.setBornHost(this.defaultMQProducer.getClientIP());\n 51:                 context.setBrokerAddr(brokerAddr);\n 52:                 context.setMessage(msg);\n 53:                 context.setMq(mq);\n 54:                 String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);\n 55:                 if (isTrans != null && isTrans.equals(\"true\")) {\n 56:                     context.setMsgType(MessageType.Trans_Msg_Half);\n 57:                 }\n 58:                 if (msg.getProperty(\"__STARTDELIVERTIME\") != null || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != null) {\n 59:                     context.setMsgType(MessageType.Delay_Msg);\n 60:                 }\n 61:                 this.executeSendMessageHookBefore(context);\n 62:             }\n 63:             // æ„å»ºå‘é€æ¶ˆæ¯è¯·æ±‚\n 64:             SendMessageRequestHeader requestHeader = new SendMessageRequestHeader();\n 65:             requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());\n 66:             requestHeader.setTopic(msg.getTopic());\n 67:             requestHeader.setDefaultTopic(this.defaultMQProducer.getCreateTopicKey());\n 68:             requestHeader.setDefaultTopicQueueNums(this.defaultMQProducer.getDefaultTopicQueueNums());\n 69:             requestHeader.setQueueId(mq.getQueueId());\n 70:             requestHeader.setSysFlag(sysFlag);\n 71:             requestHeader.setBornTimestamp(System.currentTimeMillis());\n 72:             requestHeader.setFlag(msg.getFlag());\n 73:             requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));\n 74:             requestHeader.setReconsumeTimes(0);\n 75:             requestHeader.setUnitMode(this.isUnitMode());\n 76:             if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) { // æ¶ˆæ¯é‡å‘Topic\n 77:                 String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);\n 78:                 if (reconsumeTimes != null) {\n 79:                     requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));\n 80:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);\n 81:                 }\n 82:                 String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);\n 83:                 if (maxReconsumeTimes != null) {\n 84:                     requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));\n 85:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);\n 86:                 }\n 87:             }\n 88:             // å‘é€æ¶ˆæ¯\n 89:             SendResult sendResult = null;\n 90:             switch (communicationMode) {\n 91:                 case ASYNC:\n 92:                     sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(//\n 93:                         brokerAddr, // 1\n 94:                         mq.getBrokerName(), // 2\n 95:                         msg, // 3\n 96:                         requestHeader, // 4\n 97:                         timeout, // 5\n 98:                         communicationMode, // 6\n 99:                         sendCallback, // 7\n100:                         topicPublishInfo, // 8\n101:                         this.mQClientFactory, // 9\n102:                         this.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(), // 10\n103:                         context, //\n104:                         this);\n105:                     break;\n106:                 case ONEWAY:\n107:                 case SYNC:\n108:                     sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(\n109:                         brokerAddr,\n110:                         mq.getBrokerName(),\n111:                         msg,\n112:                         requestHeader,\n113:                         timeout,\n114:                         communicationMode,\n115:                         context,\n116:                         this);\n117:                     break;\n118:                 default:\n119:                     assert false;\n120:                     break;\n121:             }\n122:             // hookï¼šå‘é€æ¶ˆæ¯åé€»è¾‘\n123:             if (this.hasSendMessageHook()) {\n124:                 context.setSendResult(sendResult);\n125:                 this.executeSendMessageHookAfter(context);\n126:             }\n127:             // è¿”å›å‘é€ç»“æœ\n128:             return sendResult;\n129:         } catch (RemotingException e) {\n130:             if (this.hasSendMessageHook()) {\n131:                 context.setException(e);\n132:                 this.executeSendMessageHookAfter(context);\n133:             }\n134:             throw e;\n135:         } catch (MQBrokerException e) {\n136:             if (this.hasSendMessageHook()) {\n137:                 context.setException(e);\n138:                 this.executeSendMessageHookAfter(context);\n139:             }\n140:             throw e;\n141:         } catch (InterruptedException e) {\n142:             if (this.hasSendMessageHook()) {\n143:                 context.setException(e);\n144:                 this.executeSendMessageHookAfter(context);\n145:             }\n146:             throw e;\n147:         } finally {\n148:             msg.setBody(prevBody);\n149:         }\n150:     }\n151:     // brokerä¸ºç©ºæŠ›å‡ºå¼‚å¸¸\n152:     throw new MQClientException(\"The broker[\" + mq.getBrokerName() + \"] not exist\", null);\n153: }\n```\n* è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚è¯¥æ–¹æ³•çœŸæ­£å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå‘é€æ¶ˆæ¯ç»™ `Broker`ã€‚\n* ç¬¬ 21 è¡Œ ï¼šç”Ÿäº§æ¶ˆæ¯ç¼–å·ï¼Œè¯¦ç»†è§£æè§[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message åŸºç¡€ã€‹](http://www.yunai.me/RocketMQ/message/)ã€‚\n* ç¬¬ 64 è‡³ 121 è¡Œ ï¼šæ„å»ºå‘é€æ¶ˆæ¯è¯·æ±‚`SendMessageRequestHeader`ã€‚\n* ç¬¬ 107 è‡³ 117 è¡Œ ï¼šæ‰§è¡Œ `MQClientInstance#sendMessage(...)` å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚\n\n# 3ã€Broker æ¥æ”¶æ¶ˆæ¯\n\n> ![æ¥æ”¶å‘é€æ¶ˆæ¯APIé¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_04_18/04.png)\n\n## SendMessageProcessor#sendMessage\n\n```Java\n  1: @Override\n  2: public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request) throws RemotingCommandException {\n  3:     SendMessageContext mqtraceContext;\n  4:     switch (request.getCode()) {\n  5:         case RequestCode.CONSUMER_SEND_MSG_BACK:\n  6:             return this.consumerSendMsgBack(ctx, request);\n  7:         default:\n  8:             // è§£æè¯·æ±‚\n  9:             SendMessageRequestHeader requestHeader = parseRequestHeader(request);\n 10:             if (requestHeader == null) {\n 11:                 return null;\n 12:             }\n 13:             // å‘é€è¯·æ±‚Contextã€‚åœ¨ hook åœºæ™¯ä¸‹ä½¿ç”¨\n 14:             mqtraceContext = buildMsgContext(ctx, requestHeader);\n 15:             // hookï¼šå¤„ç†å‘é€æ¶ˆæ¯å‰é€»è¾‘\n 16:             this.executeSendMessageHookBefore(ctx, request, mqtraceContext);\n 17:             // å¤„ç†å‘é€æ¶ˆæ¯é€»è¾‘\n 18:             final RemotingCommand response = this.sendMessage(ctx, request, mqtraceContext, requestHeader);\n 19:             // hookï¼šå¤„ç†å‘é€æ¶ˆæ¯åé€»è¾‘\n 20:             this.executeSendMessageHookAfter(response, mqtraceContext);\n 21:             return response;\n 22:     }\n 23: }\n 24: \n 25: private RemotingCommand sendMessage(final ChannelHandlerContext ctx, //\n 26:     final RemotingCommand request, //\n 27:     final SendMessageContext sendMessageContext, //\n 28:     final SendMessageRequestHeader requestHeader) throws RemotingCommandException {\n 29: \n 30:     // åˆå§‹åŒ–å“åº”\n 31:     final RemotingCommand response = RemotingCommand.createResponseCommand(SendMessageResponseHeader.class);\n 32:     final SendMessageResponseHeader responseHeader = (SendMessageResponseHeader) response.readCustomHeader();\n 33:     response.setOpaque(request.getOpaque());\n 34:     response.addExtField(MessageConst.PROPERTY_MSG_REGION, this.brokerController.getBrokerConfig().getRegionId());\n 35:     response.addExtField(MessageConst.PROPERTY_TRACE_SWITCH, String.valueOf(this.brokerController.getBrokerConfig().isTraceOn()));\n 36: \n 37:     if (log.isDebugEnabled()) {\n 38:         log.debug(\"receive SendMessage request command, {}\", request);\n 39:     }\n 40: \n 41:     // å¦‚æœæœªå¼€å§‹æ¥æ”¶æ¶ˆæ¯ï¼ŒæŠ›å‡ºç³»ç»Ÿå¼‚å¸¸\n 42:     @SuppressWarnings(\"SpellCheckingInspection\")\n 43:     final long startTimstamp = this.brokerController.getBrokerConfig().getStartAcceptSendRequestTimeStamp();\n 44:     if (this.brokerController.getMessageStore().now() < startTimstamp) {\n 45:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 46:         response.setRemark(String.format(\"broker unable to service, until %s\", UtilAll.timeMillisToHumanString2(startTimstamp)));\n 47:         return response;\n 48:     }\n 49: \n 50:     // æ¶ˆæ¯é…ç½®(Topicé…ç½®ï¼‰æ ¡éªŒ\n 51:     response.setCode(-1);\n 52:     super.msgCheck(ctx, requestHeader, response);\n 53:     if (response.getCode() != -1) {\n 54:         return response;\n 55:     }\n 56: \n 57:     final byte[] body = request.getBody();\n 58: \n 59:     // å¦‚æœé˜Ÿåˆ—å°äº0ï¼Œä»å¯ç”¨é˜Ÿåˆ—éšæœºé€‰æ‹©\n 60:     int queueIdInt = requestHeader.getQueueId();\n 61:     TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());\n 62:     if (queueIdInt < 0) {\n 63:         queueIdInt = Math.abs(this.random.nextInt() % 99999999) % topicConfig.getWriteQueueNums();\n 64:     }\n 65: \n 66:     //\n 67:     int sysFlag = requestHeader.getSysFlag();\n 68:     if (TopicFilterType.MULTI_TAG == topicConfig.getTopicFilterType()) {\n 69:         sysFlag |= MessageSysFlag.MULTI_TAGS_FLAG;\n 70:     }\n 71: \n 72:     // å¯¹RETRYç±»å‹çš„æ¶ˆæ¯å¤„ç†ã€‚å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)\n 73:     String newTopic = requestHeader.getTopic();\n 74:     if (null != newTopic && newTopic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 75:         // è·å–è®¢é˜…åˆ†ç»„é…ç½®\n 76:         String groupName = newTopic.substring(MixAll.RETRY_GROUP_TOPIC_PREFIX.length());\n 77:         SubscriptionGroupConfig subscriptionGroupConfig =\n 78:             this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(groupName);\n 79:         if (null == subscriptionGroupConfig) {\n 80:             response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);\n 81:             response.setRemark(\"subscription group not exist, \" + groupName + \" \" + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));\n 82:             return response;\n 83:         }\n 84:         // è®¡ç®—æœ€å¤§å¯æ¶ˆè´¹æ¬¡æ•°\n 85:         int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();\n 86:         if (request.getVersion() >= MQVersion.Version.V3_4_9.ordinal()) {\n 87:             maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();\n 88:         }\n 89:         int reconsumeTimes = requestHeader.getReconsumeTimes() == null ? 0 : requestHeader.getReconsumeTimes();\n 90:         if (reconsumeTimes >= maxReconsumeTimes) { // è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°\n 91:             newTopic = MixAll.getDLQTopic(groupName);\n 92:             queueIdInt = Math.abs(this.random.nextInt() % 99999999) % DLQ_NUMS_PER_GROUP;\n 93:             topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, //\n 94:                 DLQ_NUMS_PER_GROUP, //\n 95:                 PermName.PERM_WRITE, 0\n 96:             );\n 97:             if (null == topicConfig) {\n 98:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n 99:                 response.setRemark(\"topic[\" + newTopic + \"] not exist\");\n100:                 return response;\n101:             }\n102:         }\n103:     }\n104: \n105:     // åˆ›å»ºMessageExtBrokerInner\n106:     MessageExtBrokerInner msgInner = new MessageExtBrokerInner();\n107:     msgInner.setTopic(newTopic);\n108:     msgInner.setBody(body);\n109:     msgInner.setFlag(requestHeader.getFlag());\n110:     MessageAccessor.setProperties(msgInner, MessageDecoder.string2messageProperties(requestHeader.getProperties()));\n111:     msgInner.setPropertiesString(requestHeader.getProperties());\n112:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(topicConfig.getTopicFilterType(), msgInner.getTags()));\n113:     msgInner.setQueueId(queueIdInt);\n114:     msgInner.setSysFlag(sysFlag);\n115:     msgInner.setBornTimestamp(requestHeader.getBornTimestamp());\n116:     msgInner.setBornHost(ctx.channel().remoteAddress());\n117:     msgInner.setStoreHost(this.getStoreHost());\n118:     msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == null ? 0 : requestHeader.getReconsumeTimes());\n119: \n120:     // æ ¡éªŒæ˜¯å¦ä¸å…è®¸å‘é€äº‹åŠ¡æ¶ˆæ¯\n121:     if (this.brokerController.getBrokerConfig().isRejectTransactionMessage()) {\n122:         String traFlag = msgInner.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);\n123:         if (traFlag != null) {\n124:             response.setCode(ResponseCode.NO_PERMISSION);\n125:             response.setRemark(\n126:                 \"the broker[\" + this.brokerController.getBrokerConfig().getBrokerIP1() + \"] sending transaction message is forbidden\");\n127:             return response;\n128:         }\n129:     }\n130: \n131:     // æ·»åŠ æ¶ˆæ¯\n132:     PutMessageResult putMessageResult = this.brokerController.getMessageStore().putMessage(msgInner);\n133:     if (putMessageResult != null) {\n134:         boolean sendOK = false;\n135: \n136:         switch (putMessageResult.getPutMessageStatus()) {\n137:             // Success\n138:             case PUT_OK:\n139:                 sendOK = true;\n140:                 response.setCode(ResponseCode.SUCCESS);\n141:                 break;\n142:             case FLUSH_DISK_TIMEOUT:\n143:                 response.setCode(ResponseCode.FLUSH_DISK_TIMEOUT);\n144:                 sendOK = true;\n145:                 break;\n146:             case FLUSH_SLAVE_TIMEOUT:\n147:                 response.setCode(ResponseCode.FLUSH_SLAVE_TIMEOUT);\n148:                 sendOK = true;\n149:                 break;\n150:             case SLAVE_NOT_AVAILABLE:\n151:                 response.setCode(ResponseCode.SLAVE_NOT_AVAILABLE);\n152:                 sendOK = true;\n153:                 break;\n154: \n155:             // Failed\n156:             case CREATE_MAPEDFILE_FAILED:\n157:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n158:                 response.setRemark(\"create mapped file failed, server is busy or broken.\");\n159:                 break;\n160:             case MESSAGE_ILLEGAL:\n161:             case PROPERTIES_SIZE_EXCEEDED:\n162:                 response.setCode(ResponseCode.MESSAGE_ILLEGAL);\n163:                 response.setRemark(\n164:                     \"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.\");\n165:                 break;\n166:             case SERVICE_NOT_AVAILABLE:\n167:                 response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);\n168:                 response.setRemark(\n169:                     \"service not available now, maybe disk full, \" + diskUtil() + \", maybe your broker machine memory too small.\");\n170:                 break;\n171:             case OS_PAGECACHE_BUSY:\n172:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n173:                 response.setRemark(\"[PC_SYNCHRONIZED]broker busy, start flow control for a while\");\n174:                 break;\n175:             case UNKNOWN_ERROR:\n176:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n177:                 response.setRemark(\"UNKNOWN_ERROR\");\n178:                 break;\n179:             default:\n180:                 response.setCode(ResponseCode.SYSTEM_ERROR);\n181:                 response.setRemark(\"UNKNOWN_ERROR DEFAULT\");\n182:                 break;\n183:         }\n184: \n185:         String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);\n186:         if (sendOK) {\n187:             // ç»Ÿè®¡\n188:             this.brokerController.getBrokerStatsManager().incTopicPutNums(msgInner.getTopic());\n189:             this.brokerController.getBrokerStatsManager().incTopicPutSize(msgInner.getTopic(), putMessageResult.getAppendMessageResult().getWroteBytes());\n190:             this.brokerController.getBrokerStatsManager().incBrokerPutNums();\n191: \n192:             // å“åº”\n193:             response.setRemark(null);\n194:             responseHeader.setMsgId(putMessageResult.getAppendMessageResult().getMsgId());\n195:             responseHeader.setQueueId(queueIdInt);\n196:             responseHeader.setQueueOffset(putMessageResult.getAppendMessageResult().getLogicsOffset());\n197:             doResponse(ctx, request, response);\n198: \n199:             // hookï¼šè®¾ç½®å‘é€æˆåŠŸåˆ°context\n200:             if (hasSendMessageHook()) {\n201:                 sendMessageContext.setMsgId(responseHeader.getMsgId());\n202:                 sendMessageContext.setQueueId(responseHeader.getQueueId());\n203:                 sendMessageContext.setQueueOffset(responseHeader.getQueueOffset());\n204: \n205:                 int commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();\n206:                 int wroteSize = putMessageResult.getAppendMessageResult().getWroteBytes();\n207:                 int incValue = (int) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT) * commercialBaseCount;\n208: \n209:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_SUCCESS);\n210:                 sendMessageContext.setCommercialSendTimes(incValue);\n211:                 sendMessageContext.setCommercialSendSize(wroteSize);\n212:                 sendMessageContext.setCommercialOwner(owner);\n213:             }\n214:             return null;\n215:         } else {\n216:             // hookï¼šè®¾ç½®å‘é€å¤±è´¥åˆ°context\n217:             if (hasSendMessageHook()) {\n218:                 int wroteSize = request.getBody().length;\n219:                 int incValue = (int) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT);\n220: \n221:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_FAILURE);\n222:                 sendMessageContext.setCommercialSendTimes(incValue);\n223:                 sendMessageContext.setCommercialSendSize(wroteSize);\n224:                 sendMessageContext.setCommercialOwner(owner);\n225:             }\n226:         }\n227:     } else {\n228:         response.setCode(ResponseCode.SYSTEM_ERROR);\n229:         response.setRemark(\"store putMessage return null\");\n230:     }\n231: \n232:     return response;\n233: }\n```\n* `#processRequest()` è¯´æ˜ ï¼šå¤„ç†æ¶ˆæ¯è¯·æ±‚ã€‚\n* `#sendMessage()` è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯ï¼Œå¹¶è¿”å›å‘é€æ¶ˆæ¯ç»“æœã€‚\n* ç¬¬ 51 è‡³ 55 è¡Œ ï¼šæ¶ˆæ¯é…ç½®(Topicé…ç½®ï¼‰æ ¡éªŒï¼Œè¯¦ç»†è§£æè§ï¼š[AbstractSendMessageProcessor#msgCheck()](#abstractsendmessageprocessormsgcheck)ã€‚\n* ç¬¬ 60 è‡³ 64 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼–å·å°äº0æ—¶ï¼Œ`Broker` å¯ä»¥è®¾ç½®éšæœºé€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 72 è‡³ 103 è¡Œ ï¼šå¯¹RETRYç±»å‹çš„æ¶ˆæ¯å¤„ç†ã€‚å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œ å³åŠ   æ­»ä¿¡é˜Ÿ (Dead Letter Queue)ï¼Œè¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹](http://www.yunai.me/RocketMQ/topic/)ã€‚\n* ç¬¬ 105 è‡³ 118 è¡Œ ï¼šåˆ›å»º`MessageExtBrokerInner`ã€‚\n* ç¬¬ 132 ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œè¯¦ç»†è§£æè§ï¼š[DefaultMessageStore#putMessage()](defaultmessagestoreputmessage)ã€‚\n* ç¬¬ 133 è‡³ 183 è¡Œ ï¼šå¤„ç†æ¶ˆæ¯å‘é€ç»“æœï¼Œè®¾ç½®å“åº”ç»“æœå’Œæç¤ºã€‚\n* ç¬¬ 186 è‡³ 214 è¡Œ ï¼šå‘é€æˆåŠŸï¼Œå“åº”ã€‚è¿™é‡Œ`doResponse(ctx, request, response)`è¿›è¡Œå“åº”ï¼Œæœ€å`return null`ï¼ŒåŸå› æ˜¯ï¼šå“åº”ç»™ `Producer` å¯èƒ½å‘ç”Ÿå¼‚å¸¸ï¼Œ`#doResponse(ctx, request, response)`æ•æ‰äº†è¯¥å¼‚å¸¸å¹¶è¾“å‡ºæ—¥å¿—ã€‚è¿™æ ·åšçš„è¯ï¼Œæˆ‘ä»¬è¿›è¡Œæ’æŸ¥ `Broker` æ¥æ”¶æ¶ˆæ¯æˆåŠŸåå“åº”æ˜¯å¦å­˜åœ¨å¼‚å¸¸ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚\n\n### AbstractSendMessageProcessor#msgCheck\n\n```Java\n  1: protected RemotingCommand msgCheck(final ChannelHandlerContext ctx,\n  2:                                    final SendMessageRequestHeader requestHeader, final RemotingCommand response) {\n  3:     // æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™\n  4:     if (!PermName.isWriteable(this.brokerController.getBrokerConfig().getBrokerPermission())\n  5:         && this.brokerController.getTopicConfigManager().isOrderTopic(requestHeader.getTopic())) {\n  6:         response.setCode(ResponseCode.NO_PERMISSION);\n  7:         response.setRemark(\"the broker[\" + this.brokerController.getBrokerConfig().getBrokerIP1()\n  8:             + \"] sending message is forbidden\");\n  9:         return response;\n 10:     }\n 11:     // æ£€æŸ¥topicæ˜¯å¦å¯ä»¥è¢«å‘é€ã€‚ç›®å‰æ˜¯{@link MixAll.DEFAULT_TOPIC}ä¸è¢«å…è®¸å‘é€\n 12:     if (!this.brokerController.getTopicConfigManager().isTopicCanSendMessage(requestHeader.getTopic())) {\n 13:         String errorMsg = \"the topic[\" + requestHeader.getTopic() + \"] is conflict with system reserved words.\";\n 14:         log.warn(errorMsg);\n 15:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 16:         response.setRemark(errorMsg);\n 17:         return response;\n 18:     }\n 19:     TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());\n 20:     if (null == topicConfig) { // ä¸èƒ½å­˜åœ¨topicConfigï¼Œåˆ™è¿›è¡Œåˆ›å»º\n 21:         int topicSysFlag = 0;\n 22:         if (requestHeader.isUnitMode()) {\n 23:             if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 24:                 topicSysFlag = TopicSysFlag.buildSysFlag(false, true);\n 25:             } else {\n 26:                 topicSysFlag = TopicSysFlag.buildSysFlag(true, false);\n 27:             }\n 28:         }\n 29:         // åˆ›å»ºtopicé…ç½®\n 30:         log.warn(\"the topic {} not exist, producer: {}\", requestHeader.getTopic(), ctx.channel().remoteAddress());\n 31:         topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageMethod(//\n 32:             requestHeader.getTopic(), //\n 33:             requestHeader.getDefaultTopic(), //\n 34:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()), //\n 35:             requestHeader.getDefaultTopicQueueNums(), topicSysFlag);\n 36:         if (null == topicConfig) {\n 37:             if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 38:                 topicConfig =\n 39:                     this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(\n 40:                         requestHeader.getTopic(), 1, PermName.PERM_WRITE | PermName.PERM_READ,\n 41:                         topicSysFlag);\n 42:             }\n 43:         }\n 44:         // å¦‚æœæ²¡é…ç½®\n 45:         if (null == topicConfig) {\n 46:             response.setCode(ResponseCode.TOPIC_NOT_EXIST);\n 47:             response.setRemark(\"topic[\" + requestHeader.getTopic() + \"] not exist, apply first please!\"\n 48:                 + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));\n 49:             return response;\n 50:         }\n 51:     }\n 52:     // é˜Ÿåˆ—ç¼–å·æ˜¯å¦æ­£ç¡®\n 53:     int queueIdInt = requestHeader.getQueueId();\n 54:     int idValid = Math.max(topicConfig.getWriteQueueNums(), topicConfig.getReadQueueNums());\n 55:     if (queueIdInt >= idValid) {\n 56:         String errorInfo = String.format(\"request queueId[%d] is illegal, %s Producer: %s\",\n 57:             queueIdInt,\n 58:             topicConfig.toString(),\n 59:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()));\n 60:         log.warn(errorInfo);\n 61:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 62:         response.setRemark(errorInfo);\n 63:         return response;\n 64:     }\n 65:     return response;\n 66: }\n```\n* è¯´æ˜ï¼šæ ¡éªŒæ¶ˆæ¯æ˜¯å¦æ­£ç¡®ï¼Œä¸»è¦æ˜¯Topicé…ç½®æ–¹é¢ï¼Œä¾‹å¦‚ï¼š`Broker` æ˜¯å¦æœ‰å†™å…¥æƒé™ï¼Œtopicé…ç½®æ˜¯å¦å­˜åœ¨ï¼Œé˜Ÿåˆ—ç¼–å·æ˜¯å¦æ­£ç¡®ã€‚\n* ç¬¬ 11 è‡³ 18 è¡Œ ï¼šæ£€æŸ¥Topicæ˜¯å¦å¯ä»¥è¢«å‘é€ã€‚ç›®å‰æ˜¯ `{@link MixAll.DEFAULT_TOPIC}` ä¸è¢«å…è®¸å‘é€ã€‚\n* ç¬¬ 20 è‡³ 51 è¡Œ ï¼šå½“æ‰¾ä¸åˆ°Topicé…ç½®ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚å½“ç„¶ï¼Œåˆ›å»ºä¼šå­˜åœ¨ä¸æˆåŠŸçš„æƒ…å†µï¼Œä¾‹å¦‚è¯´ï¼š`defaultTopic` çš„Topicé…ç½®ä¸å­˜åœ¨ï¼Œåˆæˆ–è€…æ˜¯ å­˜åœ¨ä½†æ˜¯ä¸å…è®¸ç»§æ‰¿ï¼Œè¯¦ç»†è§£æè§[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹](http://www.yunai.me/RocketMQ/topic/)ã€‚\n\n## DefaultMessageStore#putMessage\n\n```Java\n  1: public PutMessageResult putMessage(MessageExtBrokerInner msg) {\n  2:     if (this.shutdown) {\n  3:         log.warn(\"message store has shutdown, so putMessage is forbidden\");\n  4:         return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);\n  5:     }\n  6: \n  7:     // ä»èŠ‚ç‚¹ä¸å…è®¸å†™å…¥\n  8:     if (BrokerRole.SLAVE == this.messageStoreConfig.getBrokerRole()) {\n  9:         long value = this.printTimes.getAndIncrement();\n 10:         if ((value % 50000) == 0) {\n 11:             log.warn(\"message store is slave mode, so putMessage is forbidden \");\n 12:         }\n 13: \n 14:         return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);\n 15:     }\n 16: \n 17:     // storeæ˜¯å¦å…è®¸å†™å…¥\n 18:     if (!this.runningFlags.isWriteable()) {\n 19:         long value = this.printTimes.getAndIncrement();\n 20:         if ((value % 50000) == 0) {\n 21:             log.warn(\"message store is not writeable, so putMessage is forbidden \" + this.runningFlags.getFlagBits());\n 22:         }\n 23: \n 24:         return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);\n 25:     } else {\n 26:         this.printTimes.set(0);\n 27:     }\n 28: \n 29:     // æ¶ˆæ¯è¿‡é•¿\n 30:     if (msg.getTopic().length() > Byte.MAX_VALUE) {\n 31:         log.warn(\"putMessage message topic length too long \" + msg.getTopic().length());\n 32:         return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, null);\n 33:     }\n 34: \n 35:     // æ¶ˆæ¯é™„åŠ å±æ€§è¿‡é•¿\n 36:     if (msg.getPropertiesString() != null && msg.getPropertiesString().length() > Short.MAX_VALUE) {\n 37:         log.warn(\"putMessage message properties length too long \" + msg.getPropertiesString().length());\n 38:         return new PutMessageResult(PutMessageStatus.PROPERTIES_SIZE_EXCEEDED, null);\n 39:     }\n 40: \n 41:     if (this.isOSPageCacheBusy()) {\n 42:         return new PutMessageResult(PutMessageStatus.OS_PAGECACHE_BUSY, null);\n 43:     }\n 44: \n 45:     long beginTime = this.getSystemClock().now();\n 46:     // æ·»åŠ æ¶ˆæ¯åˆ°commitLog\n 47:     PutMessageResult result = this.commitLog.putMessage(msg);\n 48: \n 49:     long eclipseTime = this.getSystemClock().now() - beginTime;\n 50:     if (eclipseTime > 500) {\n 51:         log.warn(\"putMessage not in lock eclipse time(ms)={}, bodyLength={}\", eclipseTime, msg.getBody().length);\n 52:     }\n 53:     this.storeStatsService.setPutMessageEntireTimeMax(eclipseTime);\n 54: \n 55:     if (null == result || !result.isOk()) {\n 56:         this.storeStatsService.getPutMessageFailedTimes().incrementAndGet();\n 57:     }\n 58: \n 59:     return result;\n 60: }\n```\n* è¯´æ˜ï¼šå­˜å‚¨æ¶ˆæ¯å°è£…ï¼Œæœ€ç»ˆå­˜å‚¨éœ€è¦ `CommitLog` å®ç°ã€‚\n* ç¬¬ 7 è‡³ 27 è¡Œ ï¼šæ ¡éªŒ `Broker` æ˜¯å¦å¯ä»¥å†™å…¥ã€‚\n* ç¬¬ 29 è‡³ 39 è¡Œ ï¼šæ¶ˆæ¯æ ¼å¼ä¸å¤§å°æ ¡éªŒã€‚\n* ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ `CommitLong` è¿›è¡Œå­˜å‚¨ï¼Œè¯¦ç»†é€»è¾‘è§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨ã€‹](http://www.yunai.me/RocketMQ/message-store/)\n\n# 4ã€æŸç§ç»“å°¾\n\næ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€ç‚¹èµæœ¬æ–‡çš„å·¥ç¨‹å¸ˆåŒå­¦ã€‚\n\né˜…è¯»æºç æ˜¯ä»¶ä»¤è‡ªå·±å¾ˆæ„‰æ‚¦çš„äº‹æƒ…ï¼Œç¼–å†™æºç è§£ææ˜¯è®©è‡ªå·±è„‘ç»†èƒæ­»ä¼¤æ— æ•°çš„è¿‡ç¨‹ï¼Œç—›å¹¶å¿«ä¹ç€ã€‚\n\nå¦‚æœæœ‰å†…å®¹å†™çš„å­˜åœ¨é”™è¯¯ï¼Œæˆ–æ˜¯ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œè§ç¬‘äº†ï¼ŒğŸ™‚ã€‚æ¬¢è¿åŠ  QQï¼š7685413 æˆ‘ä»¬ä¸€èµ·æ¢è®¨ï¼Œå…±è¿›æ­¥ã€‚\n\nå†æ¬¡æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€ç‚¹èµæœ¬æ–‡çš„å·¥ç¨‹å¸ˆåŒå­¦ã€‚\n\n\n\n\n\n\n\n\n\n","slug":"RocketMQ/message-send-and-receive","published":1,"updated":"2017-06-08T10:21:07.000Z","_id":"cj3ndswzi000sak5d6egdlx0e","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-send-and-receive/\">http://www.yunai.me/RocketMQ/message-send-and-receive/</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· </strong>  </p>\n</blockquote>\n<p><img src=\"http://www.yunai.me/images/common/wechat_mp.jpeg\" alt=\"wechat_mp\"></p>\n<hr>\n<ul>\n<li><a href=\"#\">1ã€æ¦‚è¿°</a></li>\n<li><a href=\"#\">2ã€Producer å‘é€æ¶ˆæ¯</a><ul>\n<li><a href=\"#\">DefaultMQProducer#send(Message)</a></li>\n<li><a href=\"#\">DefaultMQProducerImpl#sendDefaultImpl()</a><ul>\n<li><a href=\"#\">DefaultMQProducerImpl#tryToFindTopicPublishInfo()</a></li>\n<li><a href=\"#\">MQFaultStrategy</a><ul>\n<li><a href=\"#\">MQFaultStrategy</a></li>\n<li><a href=\"#\">LatencyFaultTolerance</a></li>\n<li><a href=\"#\">LatencyFaultToleranceImpl</a></li>\n<li><a href=\"#\">FaultItem</a></li>\n</ul>\n</li>\n<li><a href=\"#\">DefaultMQProducerImpl#sendKernelImpl()</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">3ã€Broker æ¥æ”¶æ¶ˆæ¯</a><ul>\n<li><a href=\"#\">SendMessageProcessor#sendMessage</a><ul>\n<li><a href=\"#\">AbstractSendMessageProcessor#msgCheck</a></li>\n</ul>\n</li>\n<li><a href=\"#\">DefaultMessageStore#putMessage</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4ã€æŸç§ç»“å°¾</a></li>\n</ul>\n<h1 id=\"1ã€æ¦‚è¿°\"><a href=\"#1ã€æ¦‚è¿°\" class=\"headerlink\" title=\"1ã€æ¦‚è¿°\"></a>1ã€æ¦‚è¿°</h1><ol>\n<li><code>Producer</code> å‘é€æ¶ˆæ¯ã€‚ä¸»è¦æ˜¯<strong>åŒæ­¥</strong>å‘é€æ¶ˆæ¯æºç ï¼Œæ¶‰åŠåˆ° å¼‚æ­¥/Onewayå‘é€æ¶ˆæ¯ï¼Œäº‹åŠ¡æ¶ˆæ¯ä¼šè·³è¿‡ã€‚</li>\n<li><code>Broker</code> æ¥æ”¶æ¶ˆæ¯ã€‚(<em>å­˜å‚¨æ¶ˆæ¯åœ¨<a href=\"http://www.yunai.me/RocketMQ/message-store/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨ã€‹</a>è§£æ</em>)</li>\n</ol>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_18/01.png\" alt=\"Producerå‘é€æ¶ˆæ¯å…¨å±€é¡ºåºå›¾\"></p>\n</blockquote>\n<h1 id=\"2ã€Producer-å‘é€æ¶ˆæ¯\"><a href=\"#2ã€Producer-å‘é€æ¶ˆæ¯\" class=\"headerlink\" title=\"2ã€Producer å‘é€æ¶ˆæ¯\"></a>2ã€Producer å‘é€æ¶ˆæ¯</h1><blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_18/02.png\" alt=\"Producerå‘é€æ¶ˆæ¯é¡ºåºå›¾\"></p>\n</blockquote>\n<h2 id=\"DefaultMQProducer-send-Message\"><a href=\"#DefaultMQProducer-send-Message\" class=\"headerlink\" title=\"DefaultMQProducer#send(Message)\"></a>DefaultMQProducer#send(Message)</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> SendResult <span class=\"title\">send</span><span class=\"params\">(Message msg)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</div><div class=\"line\"><span class=\"number\">3</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.defaultMQProducerImpl.send(msg);</div><div class=\"line\"><span class=\"number\">4</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ï¼šå‘é€åŒæ­¥æ¶ˆæ¯ï¼Œ<code>DefaultMQProducer#send(Message)</code> å¯¹ <code>DefaultMQProducerImpl#send(Message)</code> è¿›è¡Œå°è£…ã€‚  </li>\n</ul>\n<h2 id=\"DefaultMQProducerImpl-sendDefaultImpl\"><a href=\"#DefaultMQProducerImpl-sendDefaultImpl\" class=\"headerlink\" title=\"DefaultMQProducerImpl#sendDefaultImpl()\"></a>DefaultMQProducerImpl#sendDefaultImpl()</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> SendResult <span class=\"title\">send</span><span class=\"params\">(Message msg)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">return</span> send(msg, <span class=\"keyword\">this</span>.defaultMQProducer.getSendMsgTimeout());</div><div class=\"line\">  <span class=\"number\">3</span>: &#125;</div><div class=\"line\">  <span class=\"number\">4</span>: </div><div class=\"line\">  <span class=\"number\">5</span>: <span class=\"function\"><span class=\"keyword\">public</span> SendResult <span class=\"title\">send</span><span class=\"params\">(Message msg, <span class=\"keyword\">long</span> timeout)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.sendDefaultImpl(msg, CommunicationMode.SYNC, <span class=\"keyword\">null</span>, timeout);</div><div class=\"line\">  <span class=\"number\">7</span>: &#125;</div><div class=\"line\">  <span class=\"number\">8</span>: </div><div class=\"line\">  <span class=\"number\">9</span>: <span class=\"function\"><span class=\"keyword\">private</span> SendResult <span class=\"title\">sendDefaultImpl</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">10</span>:     Message msg, //</div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode, //</div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">final</span> SendCallback sendCallback, //</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeout//</div><div class=\"line\"> <span class=\"number\">14</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"comment\">// æ ¡éªŒ Producer å¤„äºè¿è¡ŒçŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"keyword\">this</span>.makeSureStateOK();</div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"comment\">// æ ¡éªŒæ¶ˆæ¯æ ¼å¼</span></div><div class=\"line\"> <span class=\"number\">18</span>:     Validators.checkMessage(msg, <span class=\"keyword\">this</span>.defaultMQProducer);</div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> invokeID = random.nextLong(); <span class=\"comment\">// è°ƒç”¨ç¼–å·ï¼›ç”¨äºä¸‹é¢æ‰“å°æ—¥å¿—ï¼Œæ ‡è®°ä¸ºåŒä¸€æ¬¡å‘é€æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">21</span>:     <span class=\"keyword\">long</span> beginTimestampFirst = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"keyword\">long</span> beginTimestampPrev = beginTimestampFirst;</div><div class=\"line\"> <span class=\"number\">23</span>:     <span class=\"keyword\">long</span> endTimestamp = beginTimestampFirst;</div><div class=\"line\"> <span class=\"number\">24</span>:     <span class=\"comment\">// è·å– Topicè·¯ç”±ä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">25</span>:     TopicPublishInfo topicPublishInfo = <span class=\"keyword\">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class=\"line\"> <span class=\"number\">26</span>:     <span class=\"keyword\">if</span> (topicPublishInfo != <span class=\"keyword\">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class=\"line\"> <span class=\"number\">27</span>:         MessageQueue mq = <span class=\"keyword\">null</span>; <span class=\"comment\">// æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">28</span>:         Exception exception = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">29</span>:         SendResult sendResult = <span class=\"keyword\">null</span>; <span class=\"comment\">// æœ€åä¸€æ¬¡å‘é€ç»“æœ</span></div><div class=\"line\"> <span class=\"number\">30</span>:         <span class=\"keyword\">int</span> timesTotal = communicationMode == CommunicationMode.SYNC ? <span class=\"number\">1</span> + <span class=\"keyword\">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class=\"number\">1</span>; <span class=\"comment\">// åŒæ­¥å¤šæ¬¡è°ƒç”¨</span></div><div class=\"line\"> <span class=\"number\">31</span>:         <span class=\"keyword\">int</span> times = <span class=\"number\">0</span>; <span class=\"comment\">// ç¬¬å‡ æ¬¡å‘é€</span></div><div class=\"line\"> <span class=\"number\">32</span>:         String[] brokersSent = <span class=\"keyword\">new</span> String[timesTotal]; <span class=\"comment\">// å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå</span></div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"comment\">// å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">34</span>:         <span class=\"keyword\">for</span> (; times &lt; timesTotal; times++) &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:             String lastBrokerName = <span class=\"keyword\">null</span> == mq ? <span class=\"keyword\">null</span> : mq.getBrokerName();</div><div class=\"line\"> <span class=\"number\">36</span>:             MessageQueue tmpmq = <span class=\"keyword\">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName); <span class=\"comment\">// é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">37</span>:             <span class=\"keyword\">if</span> (tmpmq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:                 mq = tmpmq;</div><div class=\"line\"> <span class=\"number\">39</span>:                 brokersSent[times] = mq.getBrokerName();</div><div class=\"line\"> <span class=\"number\">40</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">41</span>:                     beginTimestampPrev = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"comment\">// è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</span></div><div class=\"line\"> <span class=\"number\">43</span>:                     sendResult = <span class=\"keyword\">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);</div><div class=\"line\"> <span class=\"number\">44</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">45</span>:                     <span class=\"comment\">// æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">46</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">47</span>:                     <span class=\"keyword\">switch</span> (communicationMode) &#123;</div><div class=\"line\"> <span class=\"number\">48</span>:                         <span class=\"keyword\">case</span> ASYNC:</div><div class=\"line\"> <span class=\"number\">49</span>:                             <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">50</span>:                         <span class=\"keyword\">case</span> ONEWAY:</div><div class=\"line\"> <span class=\"number\">51</span>:                             <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">52</span>:                         <span class=\"keyword\">case</span> SYNC:</div><div class=\"line\"> <span class=\"number\">53</span>:                             <span class=\"keyword\">if</span> (sendResult.getSendStatus() != SendStatus.SEND_OK) &#123;</div><div class=\"line\"> <span class=\"number\">54</span>:                                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) &#123; <span class=\"comment\">// åŒæ­¥å‘é€æˆåŠŸä½†å­˜å‚¨æœ‰é—®é¢˜æ—¶ &amp;&amp; é…ç½®å­˜å‚¨å¼‚å¸¸æ—¶é‡æ–°å‘é€å¼€å…³ æ—¶ï¼Œè¿›è¡Œé‡è¯•</span></div><div class=\"line\"> <span class=\"number\">55</span>:                                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">56</span>:                                 &#125;</div><div class=\"line\"> <span class=\"number\">57</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">58</span>:                             <span class=\"keyword\">return</span> sendResult;</div><div class=\"line\"> <span class=\"number\">59</span>:                         <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">60</span>:                             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">61</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">62</span>:                 &#125; <span class=\"keyword\">catch</span> (RemotingException e) &#123; <span class=\"comment\">// æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œæ›´æ–°ç»§ç»­å¾ªç¯</span></div><div class=\"line\"> <span class=\"number\">63</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">64</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">65</span>:                     log.warn(String.format(<span class=\"string\">\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\"</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class=\"line\"> <span class=\"number\">66</span>:                     log.warn(msg.toString());</div><div class=\"line\"> <span class=\"number\">67</span>:                     exception = e;</div><div class=\"line\"> <span class=\"number\">68</span>:                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:                 &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123; <span class=\"comment\">// æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œç»§ç»­å¾ªç¯</span></div><div class=\"line\"> <span class=\"number\">70</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">71</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">72</span>:                     log.warn(String.format(<span class=\"string\">\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\"</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class=\"line\"> <span class=\"number\">73</span>:                     log.warn(msg.toString());</div><div class=\"line\"> <span class=\"number\">74</span>:                     exception = e;</div><div class=\"line\"> <span class=\"number\">75</span>:                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">76</span>:                 &#125; <span class=\"keyword\">catch</span> (MQBrokerException e) &#123; <span class=\"comment\">// æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ï¼Œç»“æŸå¾ªç¯</span></div><div class=\"line\"> <span class=\"number\">77</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">78</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">79</span>:                     log.warn(String.format(<span class=\"string\">\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\"</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class=\"line\"> <span class=\"number\">80</span>:                     log.warn(msg.toString());</div><div class=\"line\"> <span class=\"number\">81</span>:                     exception = e;</div><div class=\"line\"> <span class=\"number\">82</span>:                     <span class=\"keyword\">switch</span> (e.getResponseCode()) &#123;</div><div class=\"line\"> <span class=\"number\">83</span>:                         <span class=\"comment\">// å¦‚ä¸‹å¼‚å¸¸continueï¼Œè¿›è¡Œå‘é€æ¶ˆæ¯é‡è¯•</span></div><div class=\"line\"> <span class=\"number\">84</span>:                         <span class=\"keyword\">case</span> ResponseCode.TOPIC_NOT_EXIST:</div><div class=\"line\"> <span class=\"number\">85</span>:                         <span class=\"keyword\">case</span> ResponseCode.SERVICE_NOT_AVAILABLE:</div><div class=\"line\"> <span class=\"number\">86</span>:                         <span class=\"keyword\">case</span> ResponseCode.SYSTEM_ERROR:</div><div class=\"line\"> <span class=\"number\">87</span>:                         <span class=\"keyword\">case</span> ResponseCode.NO_PERMISSION:</div><div class=\"line\"> <span class=\"number\">88</span>:                         <span class=\"keyword\">case</span> ResponseCode.NO_BUYER_ID:</div><div class=\"line\"> <span class=\"number\">89</span>:                         <span class=\"keyword\">case</span> ResponseCode.NOT_IN_CURRENT_UNIT:</div><div class=\"line\"> <span class=\"number\">90</span>:                             <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">91</span>:                         <span class=\"comment\">// å¦‚æœæœ‰å‘é€ç»“æœï¼Œè¿›è¡Œè¿”å›ï¼Œå¦åˆ™ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›</span></div><div class=\"line\"> <span class=\"number\">92</span>:                         <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">93</span>:                             <span class=\"keyword\">if</span> (sendResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">94</span>:                                 <span class=\"keyword\">return</span> sendResult;</div><div class=\"line\"> <span class=\"number\">95</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">96</span>:                             <span class=\"keyword\">throw</span> e;</div><div class=\"line\"> <span class=\"number\">97</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">98</span>:                 &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">99</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">100</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">101</span>:                     log.warn(String.format(<span class=\"string\">\"sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s\"</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class=\"line\"><span class=\"number\">102</span>:                     log.warn(msg.toString());</div><div class=\"line\"><span class=\"number\">103</span>:                     <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">104</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">105</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">106</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">107</span>:             &#125;</div><div class=\"line\"><span class=\"number\">108</span>:         &#125;</div><div class=\"line\"><span class=\"number\">109</span>:         <span class=\"comment\">// è¿”å›å‘é€ç»“æœ</span></div><div class=\"line\"><span class=\"number\">110</span>:         <span class=\"keyword\">if</span> (sendResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">111</span>:             <span class=\"keyword\">return</span> sendResult;</div><div class=\"line\"><span class=\"number\">112</span>:         &#125;</div><div class=\"line\"><span class=\"number\">113</span>:         <span class=\"comment\">// æ ¹æ®ä¸åŒæƒ…å†µï¼ŒæŠ›å‡ºä¸åŒçš„å¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">114</span>:         String info = String.format(<span class=\"string\">\"Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s\"</span>, times, System.currentTimeMillis() - beginTimestampFirst,</div><div class=\"line\"><span class=\"number\">115</span>:                 msg.getTopic(), Arrays.toString(brokersSent)) + FAQUrl.suggestTodo(FAQUrl.SEND_MSG_FAILED);</div><div class=\"line\"><span class=\"number\">116</span>:         MQClientException mqClientException = <span class=\"keyword\">new</span> MQClientException(info, exception);</div><div class=\"line\"><span class=\"number\">117</span>:         <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> MQBrokerException) &#123;</div><div class=\"line\"><span class=\"number\">118</span>:             mqClientException.setResponseCode(((MQBrokerException) exception).getResponseCode());</div><div class=\"line\"><span class=\"number\">119</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> RemotingConnectException) &#123;</div><div class=\"line\"><span class=\"number\">120</span>:             mqClientException.setResponseCode(ClientErrorCode.CONNECT_BROKER_EXCEPTION);</div><div class=\"line\"><span class=\"number\">121</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> RemotingTimeoutException) &#123;</div><div class=\"line\"><span class=\"number\">122</span>:             mqClientException.setResponseCode(ClientErrorCode.ACCESS_BROKER_TIMEOUT);</div><div class=\"line\"><span class=\"number\">123</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> MQClientException) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:             mqClientException.setResponseCode(ClientErrorCode.BROKER_NOT_EXIST_EXCEPTION);</div><div class=\"line\"><span class=\"number\">125</span>:         &#125;</div><div class=\"line\"><span class=\"number\">126</span>:         <span class=\"keyword\">throw</span> mqClientException;</div><div class=\"line\"><span class=\"number\">127</span>:     &#125;</div><div class=\"line\"><span class=\"number\">128</span>:     <span class=\"comment\">// Namesrvæ‰¾ä¸åˆ°å¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">129</span>:     List&lt;String&gt; nsList = <span class=\"keyword\">this</span>.getmQClientFactory().getMQClientAPIImpl().getNameServerAddressList();</div><div class=\"line\"><span class=\"number\">130</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == nsList || nsList.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">131</span>:         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(</div><div class=\"line\"><span class=\"number\">132</span>:             <span class=\"string\">\"No name server address, please set it.\"</span> + FAQUrl.suggestTodo(FAQUrl.NAME_SERVER_ADDR_NOT_EXIST_URL), <span class=\"keyword\">null</span>).setResponseCode(ClientErrorCode.NO_NAME_SERVER_EXCEPTION);</div><div class=\"line\"><span class=\"number\">133</span>:     &#125;</div><div class=\"line\"><span class=\"number\">134</span>:     <span class=\"comment\">// æ¶ˆæ¯è·¯ç”±æ‰¾ä¸åˆ°å¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">135</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"No route info of this topic, \"</span> + msg.getTopic() + FAQUrl.suggestTodo(FAQUrl.NO_TOPIC_ROUTE_INFO),</div><div class=\"line\"><span class=\"number\">136</span>:         <span class=\"keyword\">null</span>).setResponseCode(ClientErrorCode.NOT_FOUND_TOPIC_EXCEPTION);</div><div class=\"line\"><span class=\"number\">137</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯ã€‚æ­¥éª¤ï¼šè·å–æ¶ˆæ¯è·¯ç”±ä¿¡æ¯ï¼Œé€‰æ‹©è¦å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ‰§è¡Œæ¶ˆæ¯å‘é€æ ¸å¿ƒæ–¹æ³•ï¼Œå¹¶å¯¹å‘é€ç»“æœè¿›è¡Œå°è£…è¿”å›ã€‚</li>\n<li>ç¬¬ 1  è‡³ 7 è¡Œï¼šå¯¹<code>sendsendDefaultImpl(...)</code>è¿›è¡Œå°è£…ã€‚</li>\n<li>ç¬¬ 20 è¡Œ ï¼š<code>invokeID</code>ä»…ä»…ç”¨äºæ‰“å°æ—¥å¿—ï¼Œæ— å®é™…çš„ä¸šåŠ¡ç”¨é€”ã€‚</li>\n<li>ç¬¬ 25 è¡Œ ï¼šè·å– Topicè·¯ç”±ä¿¡æ¯ï¼Œ è¯¦ç»†è§£æè§ï¼š<a href=\"#defaultmqproducerimpltrytofindtopicpublishinfo\">DefaultMQProducerImpl#tryToFindTopicPublishInfo()</a></li>\n<li>ç¬¬ 30 &amp; 34 è¡Œ ï¼šè®¡ç®—è°ƒç”¨å‘é€æ¶ˆæ¯åˆ°æˆåŠŸä¸ºæ­¢çš„æœ€å¤§æ¬¡æ•°ï¼Œå¹¶è¿›è¡Œå¾ªç¯ã€‚åŒæ­¥æˆ–å¼‚æ­¥å‘é€æ¶ˆæ¯ä¼šè°ƒç”¨å¤šæ¬¡ï¼Œé»˜è®¤é…ç½®ä¸º3æ¬¡ã€‚</li>\n<li>ç¬¬ 36 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#mqfaultstrategy\">MQFaultStrategy</a></li>\n<li>ç¬¬ 43 è¡Œ ï¼šè°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#defaultmqproducerimplsendkernelimpl\">DefaultMQProducerImpl#sendKernelImpl()</a></li>\n<li>ç¬¬ 46 è¡Œ ï¼šæ›´æ–°<code>Broker</code>å¯ç”¨æ€§ä¿¡æ¯ã€‚åœ¨é€‰æ‹©å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‚è€ƒ<code>Broker</code>å‘é€æ¶ˆæ¯çš„å»¶è¿Ÿï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#mqfaultstrategy\">MQFaultStrategy</a></li>\n<li>ç¬¬ 62 è‡³ 68 è¡Œï¼šå½“æŠ›å‡º<code>RemotingException</code>æ—¶ï¼Œå¦‚æœè¿›è¡Œæ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•ï¼Œåˆ™<strong>å¯èƒ½å¯¼è‡´æ¶ˆæ¯å‘é€é‡å¤</strong>ã€‚ä¾‹å¦‚ï¼Œå‘é€æ¶ˆæ¯è¶…æ—¶(<code>RemotingTimeoutException</code>)ï¼Œå®é™…<code>Broker</code>æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯å¹¶å¤„ç†æˆåŠŸã€‚å› æ­¤ï¼Œ<code>Consumer</code>åœ¨æ¶ˆè´¹æ—¶ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚</li>\n</ul>\n<h3 id=\"DefaultMQProducerImpl-tryToFindTopicPublishInfo\"><a href=\"#DefaultMQProducerImpl-tryToFindTopicPublishInfo\" class=\"headerlink\" title=\"DefaultMQProducerImpl#tryToFindTopicPublishInfo()\"></a>DefaultMQProducerImpl#tryToFindTopicPublishInfo()</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> TopicPublishInfo <span class=\"title\">tryToFindTopicPublishInfo</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">// ç¼“å­˜ä¸­è·å– Topicå‘å¸ƒä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">3</span>:     TopicPublishInfo topicPublishInfo = <span class=\"keyword\">this</span>.topicPublishInfoTable.get(topic);</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"comment\">// å½“æ— å¯ç”¨çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶ï¼Œä»Namesrvè·å–ä¸€æ¬¡</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicPublishInfo || !topicPublishInfo.ok()) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">this</span>.topicPublishInfoTable.putIfAbsent(topic, <span class=\"keyword\">new</span> TopicPublishInfo());</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);</div><div class=\"line\"> <span class=\"number\">8</span>:         topicPublishInfo = <span class=\"keyword\">this</span>.topicPublishInfoTable.get(topic);</div><div class=\"line\"> <span class=\"number\">9</span>:     &#125;</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"comment\">// è‹¥è·å–çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶å€™å¯ç”¨ï¼Œåˆ™è¿”å›</span></div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">if</span> (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">return</span> topicPublishInfo;</div><div class=\"line\"><span class=\"number\">13</span>:     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// ä½¿ç”¨ &#123;@link DefaultMQProducer#createTopicKey&#125; å¯¹åº”çš„ Topicå‘å¸ƒä¿¡æ¯ã€‚ç”¨äº Topicå‘å¸ƒä¿¡æ¯ä¸å­˜åœ¨ &amp;&amp; Brokeræ”¯æŒè‡ªåŠ¨åˆ›å»ºTopic</span></div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, <span class=\"keyword\">true</span>, <span class=\"keyword\">this</span>.defaultMQProducer);</div><div class=\"line\"><span class=\"number\">15</span>:         topicPublishInfo = <span class=\"keyword\">this</span>.topicPublishInfoTable.get(topic);</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">return</span> topicPublishInfo;</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šè·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚ä¼˜å…ˆä»ç¼“å­˜<code>topicPublishInfoTable</code>ï¼Œå…¶æ¬¡ä»<code>Namesrv</code>ä¸­è·å¾—ã€‚</li>\n<li>ç¬¬ 3 è¡Œ ï¼šä»ç¼“å­˜<code>topicPublishInfoTable</code>ä¸­è·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚</li>\n<li>ç¬¬ 5 è‡³ 9 è¡Œ ï¼šä» <code>Namesrv</code> ä¸­è·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚</li>\n<li>ç¬¬ 13 è‡³ 17 è¡Œ ï¼šå½“ä» <code>Namesrv</code> æ— æ³•è·å–æ—¶ï¼Œä½¿ç”¨ <code>{@link DefaultMQProducer#createTopicKey}</code> å¯¹åº”çš„ Topicå‘å¸ƒä¿¡æ¯ã€‚ç›®çš„æ˜¯å½“ <code>Broker</code> å¼€å¯è‡ªåŠ¨åˆ›å»º Topicå¼€å…³æ—¶ï¼Œ<code>Broker</code> æ¥æ”¶åˆ°æ¶ˆæ¯åè‡ªåŠ¨åˆ›å»ºTopicï¼Œè¯¦ç»†è§£æè§<a href=\"http://www.yunai.me/RocketMQ/topic/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹</a>ã€‚</li>\n</ul>\n<h3 id=\"MQFaultStrategy\"><a href=\"#MQFaultStrategy\" class=\"headerlink\" title=\"MQFaultStrategy\"></a>MQFaultStrategy</h3><blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_18/03.png\" alt=\"Latencyç±»å›¾\"></p>\n</blockquote>\n<h4 id=\"MQFaultStrategy-1\"><a href=\"#MQFaultStrategy-1\" class=\"headerlink\" title=\"MQFaultStrategy\"></a>MQFaultStrategy</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MQFaultStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> Logger log = ClientLogger.getLog();</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 5:      * å»¶è¿Ÿæ•…éšœå®¹é”™ï¼Œç»´æŠ¤æ¯ä¸ªBrokerçš„å‘é€æ¶ˆæ¯çš„å»¶è¿Ÿ</div><div class=\"line\"> 6:      * keyï¼šbrokerName</div><div class=\"line\"> 7:      */</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LatencyFaultTolerance&lt;String&gt; latencyFaultTolerance = <span class=\"keyword\">new</span> LatencyFaultToleranceImpl();</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">10:      * å‘é€æ¶ˆæ¯å»¶è¿Ÿå®¹é”™å¼€å…³</div><div class=\"line\">11:      */</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> sendLatencyFaultEnable = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">14:      * å»¶è¿Ÿçº§åˆ«æ•°ç»„</div><div class=\"line\">15:      */</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span>[] latencyMax = &#123;<span class=\"number\">50L</span>, <span class=\"number\">100L</span>, <span class=\"number\">550L</span>, <span class=\"number\">1000L</span>, <span class=\"number\">2000L</span>, <span class=\"number\">3000L</span>, <span class=\"number\">15000L</span>&#125;;</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">18:      * ä¸å¯ç”¨æ—¶é•¿æ•°ç»„</div><div class=\"line\">19:      */</div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span>[] notAvailableDuration = &#123;<span class=\"number\">0L</span>, <span class=\"number\">0L</span>, <span class=\"number\">30000L</span>, <span class=\"number\">60000L</span>, <span class=\"number\">120000L</span>, <span class=\"number\">180000L</span>, <span class=\"number\">600000L</span>&#125;;</div><div class=\"line\"><span class=\"number\">21</span>: </div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">23:      * æ ¹æ® Topicå‘å¸ƒä¿¡æ¯ é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">24:      *</div><div class=\"line\">25:      * <span class=\"doctag\">@param</span> tpInfo Topicå‘å¸ƒä¿¡æ¯</div><div class=\"line\">26:      * <span class=\"doctag\">@param</span> lastBrokerName brokerName</div><div class=\"line\">27:      * <span class=\"doctag\">@return</span> æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">28:      */</div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"function\"><span class=\"keyword\">public</span> MessageQueue <span class=\"title\">selectOneMessageQueue</span><span class=\"params\">(<span class=\"keyword\">final</span> TopicPublishInfo tpInfo, <span class=\"keyword\">final</span> String lastBrokerName)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.sendLatencyFaultEnable) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"comment\">// è·å– brokerName=lastBrokerName &amp;&amp; å¯ç”¨çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"keyword\">int</span> index = tpInfo.getSendWhichQueue().getAndIncrement();</div><div class=\"line\"><span class=\"number\">34</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; tpInfo.getMessageQueueList().size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:                     <span class=\"keyword\">int</span> pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();</div><div class=\"line\"><span class=\"number\">36</span>:                     <span class=\"keyword\">if</span> (pos &lt; <span class=\"number\">0</span>)</div><div class=\"line\"><span class=\"number\">37</span>:                         pos = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">38</span>:                     MessageQueue mq = tpInfo.getMessageQueueList().get(pos);</div><div class=\"line\"><span class=\"number\">39</span>:                     <span class=\"keyword\">if</span> (latencyFaultTolerance.isAvailable(mq.getBrokerName())) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == lastBrokerName || mq.getBrokerName().equals(lastBrokerName))</div><div class=\"line\"><span class=\"number\">41</span>:                             <span class=\"keyword\">return</span> mq;</div><div class=\"line\"><span class=\"number\">42</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">43</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"comment\">// é€‰æ‹©ä¸€ä¸ªç›¸å¯¹å¥½çš„brokerï¼Œå¹¶è·å¾—å…¶å¯¹åº”çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘è¯¥é˜Ÿåˆ—çš„å¯ç”¨æ€§</span></div><div class=\"line\"><span class=\"number\">45</span>:                 <span class=\"keyword\">final</span> String notBestBroker = latencyFaultTolerance.pickOneAtLeast();</div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">int</span> writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);</div><div class=\"line\"><span class=\"number\">47</span>:                 <span class=\"keyword\">if</span> (writeQueueNums &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">48</span>:                     <span class=\"keyword\">final</span> MessageQueue mq = tpInfo.selectOneMessageQueue();</div><div class=\"line\"><span class=\"number\">49</span>:                     <span class=\"keyword\">if</span> (notBestBroker != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">50</span>:                         mq.setBrokerName(notBestBroker);</div><div class=\"line\"><span class=\"number\">51</span>:                         mq.setQueueId(tpInfo.getSendWhichQueue().getAndIncrement() % writeQueueNums);</div><div class=\"line\"><span class=\"number\">52</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">53</span>:                     <span class=\"keyword\">return</span> mq;</div><div class=\"line\"><span class=\"number\">54</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">55</span>:                     latencyFaultTolerance.remove(notBestBroker);</div><div class=\"line\"><span class=\"number\">56</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">57</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">58</span>:                 log.error(<span class=\"string\">\"Error occurred when selecting message queue\"</span>, e);</div><div class=\"line\"><span class=\"number\">59</span>:             &#125;</div><div class=\"line\"><span class=\"number\">60</span>:             <span class=\"comment\">// é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘é˜Ÿåˆ—çš„å¯ç”¨æ€§</span></div><div class=\"line\"><span class=\"number\">61</span>:             <span class=\"keyword\">return</span> tpInfo.selectOneMessageQueue();</div><div class=\"line\"><span class=\"number\">62</span>:         &#125;</div><div class=\"line\"><span class=\"number\">63</span>:         <span class=\"comment\">// è·å¾— lastBrokerName å¯¹åº”çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘è¯¥é˜Ÿåˆ—çš„å¯ç”¨æ€§</span></div><div class=\"line\"><span class=\"number\">64</span>:         <span class=\"keyword\">return</span> tpInfo.selectOneMessageQueue(lastBrokerName);</div><div class=\"line\"><span class=\"number\">65</span>:     &#125;</div><div class=\"line\"><span class=\"number\">66</span>: </div><div class=\"line\"><span class=\"number\">67</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">68:      * æ›´æ–°å»¶è¿Ÿå®¹é”™ä¿¡æ¯</div><div class=\"line\">69:      *</div><div class=\"line\">70:      * <span class=\"doctag\">@param</span> brokerName brokerName</div><div class=\"line\">71:      * <span class=\"doctag\">@param</span> currentLatency å»¶è¿Ÿ</div><div class=\"line\">72:      * <span class=\"doctag\">@param</span> isolation æ˜¯å¦éš”ç¦»ã€‚å½“å¼€å¯éš”ç¦»æ—¶ï¼Œé»˜è®¤å»¶è¿Ÿä¸º30000ã€‚ç›®å‰ä¸»è¦ç”¨äºå‘é€æ¶ˆæ¯å¼‚å¸¸æ—¶</div><div class=\"line\">73:      */</div><div class=\"line\"><span class=\"number\">74</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updateFaultItem</span><span class=\"params\">(<span class=\"keyword\">final</span> String brokerName, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentLatency, <span class=\"keyword\">boolean</span> isolation)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">75</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.sendLatencyFaultEnable) &#123;</div><div class=\"line\"><span class=\"number\">76</span>:             <span class=\"keyword\">long</span> duration = computeNotAvailableDuration(isolation ? <span class=\"number\">30000</span> : currentLatency);</div><div class=\"line\"><span class=\"number\">77</span>:             <span class=\"keyword\">this</span>.latencyFaultTolerance.updateFaultItem(brokerName, currentLatency, duration);</div><div class=\"line\"><span class=\"number\">78</span>:         &#125;</div><div class=\"line\"><span class=\"number\">79</span>:     &#125;</div><div class=\"line\"><span class=\"number\">80</span>: </div><div class=\"line\"><span class=\"number\">81</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">82:      * è®¡ç®—å»¶è¿Ÿå¯¹åº”çš„ä¸å¯ç”¨æ—¶é—´</div><div class=\"line\">83:      *</div><div class=\"line\">84:      * <span class=\"doctag\">@param</span> currentLatency å»¶è¿Ÿ</div><div class=\"line\">85:      * <span class=\"doctag\">@return</span> ä¸å¯ç”¨æ—¶é—´</div><div class=\"line\">86:      */</div><div class=\"line\"><span class=\"number\">87</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">computeNotAvailableDuration</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentLatency)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">88</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = latencyMax.length - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</div><div class=\"line\"><span class=\"number\">89</span>:             <span class=\"keyword\">if</span> (currentLatency &gt;= latencyMax[i])</div><div class=\"line\"><span class=\"number\">90</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.notAvailableDuration[i];</div><div class=\"line\"><span class=\"number\">91</span>:         &#125;</div><div class=\"line\"><span class=\"number\">92</span>:         <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">93</span>:     &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼š<code>Producer</code>æ¶ˆæ¯å‘é€å®¹é”™ç­–ç•¥ã€‚é»˜è®¤æƒ…å†µä¸‹å®¹é”™ç­–ç•¥å…³é—­ï¼Œå³<code>sendLatencyFaultEnable=false</code>ã€‚</li>\n<li>ç¬¬ 30 è‡³ 62 è¡Œ ï¼šå®¹é”™ç­–ç•¥é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ã€‚ä¼˜å…ˆè·å–å¯ç”¨é˜Ÿåˆ—ï¼Œå…¶æ¬¡é€‰æ‹©ä¸€ä¸ªbrokerè·å–é˜Ÿåˆ—ï¼Œæœ€å·®è¿”å›ä»»æ„brokerçš„ä¸€ä¸ªé˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 64 è¡Œ ï¼šæœªå¼€å¯å®¹é”™ç­–ç•¥é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ã€‚</li>\n<li><p>ç¬¬ 74 è‡³ 79 è¡Œ ï¼šæ›´æ–°å»¶è¿Ÿå®¹é”™ä¿¡æ¯ã€‚å½“ <code>Producer</code> å‘é€æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œåˆ™é€»è¾‘è®¤ä¸ºNç§’å†…ä¸å¯ç”¨ã€‚æŒ‰ç…§<code>latencyMax</code>ï¼Œ<code>notAvailableDuration</code>çš„é…ç½®ï¼Œå¯¹åº”å¦‚ä¸‹ï¼š</p>\n<p>  | Producerå‘é€æ¶ˆæ¯æ¶ˆè€—æ—¶é•¿ | Brokerä¸å¯ç”¨æ—¶é•¿ |<br>  | â€” | â€” |<br>  | &gt;= 15000 ms | 600 <em> 1000 ms  |<br>  | &gt;= 3000 ms | 180 </em> 1000 ms  |<br>  | &gt;= 2000 ms | 120 <em> 1000 ms  |<br>  | &gt;= 1000 ms | 60 </em> 1000 ms  |<br>  | &gt;= 550 ms | 30 * 1000 ms |<br>  | &gt;= 100 ms | 0 ms |<br>  | &gt;= 50 ms | 0 ms |</p>\n</li>\n</ul>\n<h4 id=\"LatencyFaultTolerance\"><a href=\"#LatencyFaultTolerance\" class=\"headerlink\" title=\"LatencyFaultTolerance\"></a>LatencyFaultTolerance</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">LatencyFaultTolerance</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * æ›´æ–°å¯¹åº”çš„å»¶è¿Ÿå’Œä¸å¯ç”¨æ—¶é•¿</div><div class=\"line\"> 5:      *</div><div class=\"line\"> 6:      * <span class=\"doctag\">@param</span> name å¯¹è±¡</div><div class=\"line\"> 7:      * <span class=\"doctag\">@param</span> currentLatency å»¶è¿Ÿ</div><div class=\"line\"> 8:      * <span class=\"doctag\">@param</span> notAvailableDuration ä¸å¯ç”¨æ—¶é•¿</div><div class=\"line\"> 9:      */</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">updateFaultItem</span><span class=\"params\">(<span class=\"keyword\">final</span> T name, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentLatency, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> notAvailableDuration)</span></span>;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">13:      * å¯¹è±¡æ˜¯å¦å¯ç”¨</div><div class=\"line\">14:      *</div><div class=\"line\">15:      * <span class=\"doctag\">@param</span> name å¯¹è±¡</div><div class=\"line\">16:      * <span class=\"doctag\">@return</span> æ˜¯å¦å¯ç”¨</div><div class=\"line\">17:      */</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isAvailable</span><span class=\"params\">(<span class=\"keyword\">final</span> T name)</span></span>;</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">21:      * ç§»é™¤å¯¹è±¡</div><div class=\"line\">22:      *</div><div class=\"line\">23:      * <span class=\"doctag\">@param</span> name å¯¹è±¡</div><div class=\"line\">24:      */</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">remove</span><span class=\"params\">(<span class=\"keyword\">final</span> T name)</span></span>;</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">28:      * è·å–ä¸€ä¸ªå¯¹è±¡</div><div class=\"line\">29:      *</div><div class=\"line\">30:      * <span class=\"doctag\">@return</span> å¯¹è±¡</div><div class=\"line\">31:      */</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"function\">T <span class=\"title\">pickOneAtLeast</span><span class=\"params\">()</span></span>;</div><div class=\"line\"><span class=\"number\">33</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå»¶è¿Ÿæ•…éšœå®¹é”™æ¥å£</li>\n</ul>\n<h4 id=\"LatencyFaultToleranceImpl\"><a href=\"#LatencyFaultToleranceImpl\" class=\"headerlink\" title=\"LatencyFaultToleranceImpl\"></a>LatencyFaultToleranceImpl</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LatencyFaultToleranceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title\">LatencyFaultTolerance</span>&lt;<span class=\"title\">String</span>&gt; </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * å¯¹è±¡æ•…éšœä¿¡æ¯Table</div><div class=\"line\"> 5:      */</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConcurrentHashMap&lt;String, FaultItem&gt; faultItemTable = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">16</span>);</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 8:      * å¯¹è±¡é€‰æ‹©Index</div><div class=\"line\"> 9:      * <span class=\"doctag\">@see</span> #pickOneAtLeast()</div><div class=\"line\">10:      */</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadLocalIndex whichItemWorst = <span class=\"keyword\">new</span> ThreadLocalIndex();</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updateFaultItem</span><span class=\"params\">(<span class=\"keyword\">final</span> String name, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentLatency, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> notAvailableDuration)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">15</span>:         FaultItem old = <span class=\"keyword\">this</span>.faultItemTable.get(name);</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == old) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"comment\">// åˆ›å»ºå¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">final</span> FaultItem faultItem = <span class=\"keyword\">new</span> FaultItem(name);</div><div class=\"line\"><span class=\"number\">19</span>:             faultItem.setCurrentLatency(currentLatency);</div><div class=\"line\"><span class=\"number\">20</span>:             faultItem.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"comment\">// æ›´æ–°å¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">22</span>:             old = <span class=\"keyword\">this</span>.faultItemTable.putIfAbsent(name, faultItem);</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">if</span> (old != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 old.setCurrentLatency(currentLatency);</div><div class=\"line\"><span class=\"number\">25</span>:                 old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class=\"line\"><span class=\"number\">26</span>:             &#125;</div><div class=\"line\"><span class=\"number\">27</span>:         &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æ›´æ–°å¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">28</span>:             old.setCurrentLatency(currentLatency);</div><div class=\"line\"><span class=\"number\">29</span>:             old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class=\"line\"><span class=\"number\">30</span>:         &#125;</div><div class=\"line\"><span class=\"number\">31</span>:     &#125;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAvailable</span><span class=\"params\">(<span class=\"keyword\">final</span> String name)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">final</span> FaultItem faultItem = <span class=\"keyword\">this</span>.faultItemTable.get(name);</div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">if</span> (faultItem != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">return</span> faultItem.isAvailable();</div><div class=\"line\"><span class=\"number\">38</span>:         &#125;</div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">remove</span><span class=\"params\">(<span class=\"keyword\">final</span> String name)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"keyword\">this</span>.faultItemTable.remove(name);</div><div class=\"line\"><span class=\"number\">45</span>:     &#125;</div><div class=\"line\"><span class=\"number\">46</span>: </div><div class=\"line\"><span class=\"number\">47</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">48:      * é€‰æ‹©ä¸€ä¸ªç›¸å¯¹ä¼˜ç§€çš„å¯¹è±¡</div><div class=\"line\">49:      *</div><div class=\"line\">50:      * <span class=\"doctag\">@return</span> å¯¹è±¡</div><div class=\"line\">51:      */</div><div class=\"line\"><span class=\"number\">52</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">53</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">pickOneAtLeast</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">54</span>:         <span class=\"comment\">// åˆ›å»ºæ•°ç»„</span></div><div class=\"line\"><span class=\"number\">55</span>:         <span class=\"keyword\">final</span> Enumeration&lt;FaultItem&gt; elements = <span class=\"keyword\">this</span>.faultItemTable.elements();</div><div class=\"line\"><span class=\"number\">56</span>:         List&lt;FaultItem&gt; tmpList = <span class=\"keyword\">new</span> LinkedList&lt;&gt;();</div><div class=\"line\"><span class=\"number\">57</span>:         <span class=\"keyword\">while</span> (elements.hasMoreElements()) &#123;</div><div class=\"line\"><span class=\"number\">58</span>:             <span class=\"keyword\">final</span> FaultItem faultItem = elements.nextElement();</div><div class=\"line\"><span class=\"number\">59</span>:             tmpList.add(faultItem);</div><div class=\"line\"><span class=\"number\">60</span>:         &#125;</div><div class=\"line\"><span class=\"number\">61</span>:         <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">if</span> (!tmpList.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">63</span>:             <span class=\"comment\">// æ‰“ä¹± + æ’åºã€‚TODO ç–‘é—®ï¼šåº”è¯¥åªèƒ½äºŒé€‰ä¸€ã€‚çŒœæµ‹Collections.shuffle(tmpList)å»æ‰ã€‚</span></div><div class=\"line\"><span class=\"number\">64</span>:             Collections.shuffle(tmpList);</div><div class=\"line\"><span class=\"number\">65</span>:             Collections.sort(tmpList);</div><div class=\"line\"><span class=\"number\">66</span>:             <span class=\"comment\">// é€‰æ‹©é¡ºåºåœ¨å‰ä¸€åŠçš„å¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">67</span>:             <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> half = tmpList.size() / <span class=\"number\">2</span>;</div><div class=\"line\"><span class=\"number\">68</span>:             <span class=\"keyword\">if</span> (half &lt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">69</span>:                 <span class=\"keyword\">return</span> tmpList.get(<span class=\"number\">0</span>).getName();</div><div class=\"line\"><span class=\"number\">70</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">71</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> i = <span class=\"keyword\">this</span>.whichItemWorst.getAndIncrement() % half;</div><div class=\"line\"><span class=\"number\">72</span>:                 <span class=\"keyword\">return</span> tmpList.get(i).getName();</div><div class=\"line\"><span class=\"number\">73</span>:             &#125;</div><div class=\"line\"><span class=\"number\">74</span>:         &#125;</div><div class=\"line\"><span class=\"number\">75</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">76</span>:     &#125;</div><div class=\"line\"><span class=\"number\">77</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå»¶è¿Ÿæ•…éšœå®¹é”™å®ç°ã€‚ç»´æŠ¤æ¯ä¸ªå¯¹è±¡çš„ä¿¡æ¯ã€‚</li>\n</ul>\n<h4 id=\"FaultItem\"><a href=\"#FaultItem\" class=\"headerlink\" title=\"FaultItem\"></a>FaultItem</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FaultItem</span> <span class=\"keyword\">implements</span> <span class=\"title\">Comparable</span>&lt;<span class=\"title\">FaultItem</span>&gt; </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 3:      * å¯¹è±¡å</div><div class=\"line\"> 4:      */</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String name;</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 7:      * å»¶è¿Ÿ</div><div class=\"line\"> 8:      */</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> currentLatency;</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">11:      * å¼€å§‹å¯ç”¨æ—¶é—´</div><div class=\"line\">12:      */</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> startTimestamp;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">FaultItem</span><span class=\"params\">(<span class=\"keyword\">final</span> String name)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">this</span>.name = name;</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: </div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">20:      * æ¯”è¾ƒå¯¹è±¡</div><div class=\"line\">21:      * å¯ç”¨æ€§ &gt; å»¶è¿Ÿ &gt; å¼€å§‹å¯ç”¨æ—¶é—´</div><div class=\"line\">22:      *</div><div class=\"line\">23:      * <span class=\"doctag\">@param</span> other other</div><div class=\"line\">24:      * <span class=\"doctag\">@return</span> å‡åº</div><div class=\"line\">25:      */</div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">compareTo</span><span class=\"params\">(<span class=\"keyword\">final</span> FaultItem other)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isAvailable() != other.isAvailable()) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isAvailable())</div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">if</span> (other.isAvailable())</div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">34</span>:         &#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.currentLatency &lt; other.currentLatency)</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.currentLatency &gt; other.currentLatency) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:             <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">40</span>:         &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.startTimestamp &lt; other.startTimestamp)</div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.startTimestamp &gt; other.startTimestamp) &#123;</div><div class=\"line\"><span class=\"number\">45</span>:             <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">46</span>:         &#125;</div><div class=\"line\"><span class=\"number\">47</span>: </div><div class=\"line\"><span class=\"number\">48</span>:         <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">49</span>:     &#125;</div><div class=\"line\"><span class=\"number\">50</span>: </div><div class=\"line\"><span class=\"number\">51</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">52:      * æ˜¯å¦å¯ç”¨ï¼šå½“å¼€å§‹å¯ç”¨æ—¶é—´å¤§äºå½“å‰æ—¶é—´</div><div class=\"line\">53:      *</div><div class=\"line\">54:      * <span class=\"doctag\">@return</span> æ˜¯å¦å¯ç”¨</div><div class=\"line\">55:      */</div><div class=\"line\"><span class=\"number\">56</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAvailable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">57</span>:         <span class=\"keyword\">return</span> (System.currentTimeMillis() - startTimestamp) &gt;= <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">58</span>:     &#125;</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">61</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">int</span> result = getName() != <span class=\"keyword\">null</span> ? getName().hashCode() : <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">63</span>:         result = <span class=\"number\">31</span> * result + (<span class=\"keyword\">int</span>) (getCurrentLatency() ^ (getCurrentLatency() &gt;&gt;&gt; <span class=\"number\">32</span>));</div><div class=\"line\"><span class=\"number\">64</span>:         result = <span class=\"number\">31</span> * result + (<span class=\"keyword\">int</span>) (getStartTimestamp() ^ (getStartTimestamp() &gt;&gt;&gt; <span class=\"number\">32</span>));</div><div class=\"line\"><span class=\"number\">65</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">66</span>:     &#125;</div><div class=\"line\"><span class=\"number\">67</span>: </div><div class=\"line\"><span class=\"number\">68</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">69</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(<span class=\"keyword\">final</span> Object o)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">70</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span> == o)</div><div class=\"line\"><span class=\"number\">71</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">72</span>:         <span class=\"keyword\">if</span> (!(o <span class=\"keyword\">instanceof</span> FaultItem))</div><div class=\"line\"><span class=\"number\">73</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">74</span>: </div><div class=\"line\"><span class=\"number\">75</span>:         <span class=\"keyword\">final</span> FaultItem faultItem = (FaultItem) o;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:         <span class=\"keyword\">if</span> (getCurrentLatency() != faultItem.getCurrentLatency())</div><div class=\"line\"><span class=\"number\">78</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">79</span>:         <span class=\"keyword\">if</span> (getStartTimestamp() != faultItem.getStartTimestamp())</div><div class=\"line\"><span class=\"number\">80</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">81</span>:         <span class=\"keyword\">return</span> getName() != <span class=\"keyword\">null</span> ? getName().equals(faultItem.getName()) : faultItem.getName() == <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">82</span>: </div><div class=\"line\"><span class=\"number\">83</span>:     &#125;</div><div class=\"line\"><span class=\"number\">84</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå¯¹è±¡æ•…éšœä¿¡æ¯ã€‚ç»´æŠ¤å¯¹è±¡çš„åå­—ã€å»¶è¿Ÿã€å¼€å§‹å¯ç”¨çš„æ—¶é—´ã€‚</li>\n</ul>\n<h3 id=\"DefaultMQProducerImpl-sendKernelImpl\"><a href=\"#DefaultMQProducerImpl-sendKernelImpl\" class=\"headerlink\" title=\"DefaultMQProducerImpl#sendKernelImpl()\"></a>DefaultMQProducerImpl#sendKernelImpl()</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> SendResult <span class=\"title\">sendKernelImpl</span><span class=\"params\">(<span class=\"keyword\">final</span> Message msg, //</span></span></div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">final</span> MessageQueue mq, //</div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode, //</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> SendCallback sendCallback, //</div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> TopicPublishInfo topicPublishInfo, //</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeout) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"comment\">// è·å– brokeråœ°å€</span></div><div class=\"line\">  <span class=\"number\">8</span>:     String brokerAddr = <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == brokerAddr) &#123;</div><div class=\"line\"> <span class=\"number\">10</span>:         tryToFindTopicPublishInfo(mq.getTopic());</div><div class=\"line\"> <span class=\"number\">11</span>:         brokerAddr = <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</div><div class=\"line\"> <span class=\"number\">12</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">14</span>:     SendMessageContext context = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (brokerAddr != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:         <span class=\"comment\">// æ˜¯å¦ä½¿ç”¨broker vipé€šé“ã€‚brokerä¼šå¼€å¯ä¸¤ä¸ªç«¯å£å¯¹å¤–æœåŠ¡ã€‚</span></div><div class=\"line\"> <span class=\"number\">17</span>:         brokerAddr = MixAll.brokerVIPChannel(<span class=\"keyword\">this</span>.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr);</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">byte</span>[] prevBody = msg.getBody(); <span class=\"comment\">// è®°å½•æ¶ˆæ¯å†…å®¹ã€‚ä¸‹é¢é€»è¾‘å¯èƒ½æ”¹å˜æ¶ˆæ¯å†…å®¹ï¼Œä¾‹å¦‚æ¶ˆæ¯å‹ç¼©ã€‚</span></div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"comment\">// è®¾ç½®å”¯ä¸€ç¼–å·</span></div><div class=\"line\"> <span class=\"number\">21</span>:             MessageClientIDSetter.setUniqID(msg);</div><div class=\"line\"> <span class=\"number\">22</span>:             <span class=\"comment\">// æ¶ˆæ¯å‹ç¼©</span></div><div class=\"line\"> <span class=\"number\">23</span>:             <span class=\"keyword\">int</span> sysFlag = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.tryToCompressMessage(msg)) &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:                 sysFlag |= MessageSysFlag.COMPRESSED_FLAG;</div><div class=\"line\"> <span class=\"number\">26</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"comment\">// äº‹åŠ¡</span></div><div class=\"line\"> <span class=\"number\">28</span>:             <span class=\"keyword\">final</span> String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class=\"line\"> <span class=\"number\">29</span>:             <span class=\"keyword\">if</span> (tranMsg != <span class=\"keyword\">null</span> &amp;&amp; Boolean.parseBoolean(tranMsg)) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:                 sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;</div><div class=\"line\"> <span class=\"number\">31</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">32</span>:             <span class=\"comment\">// hookï¼šå‘é€æ¶ˆæ¯æ ¡éªŒ</span></div><div class=\"line\"> <span class=\"number\">33</span>:             <span class=\"keyword\">if</span> (hasCheckForbiddenHook()) &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:                 CheckForbiddenContext checkForbiddenContext = <span class=\"keyword\">new</span> CheckForbiddenContext();</div><div class=\"line\"> <span class=\"number\">35</span>:                 checkForbiddenContext.setNameSrvAddr(<span class=\"keyword\">this</span>.defaultMQProducer.getNamesrvAddr());</div><div class=\"line\"> <span class=\"number\">36</span>:                 checkForbiddenContext.setGroup(<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"> <span class=\"number\">37</span>:                 checkForbiddenContext.setCommunicationMode(communicationMode);</div><div class=\"line\"> <span class=\"number\">38</span>:                 checkForbiddenContext.setBrokerAddr(brokerAddr);</div><div class=\"line\"> <span class=\"number\">39</span>:                 checkForbiddenContext.setMessage(msg);</div><div class=\"line\"> <span class=\"number\">40</span>:                 checkForbiddenContext.setMq(mq);</div><div class=\"line\"> <span class=\"number\">41</span>:                 checkForbiddenContext.setUnitMode(<span class=\"keyword\">this</span>.isUnitMode());</div><div class=\"line\"> <span class=\"number\">42</span>:                 <span class=\"keyword\">this</span>.executeCheckForbiddenHook(checkForbiddenContext);</div><div class=\"line\"> <span class=\"number\">43</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">44</span>:             <span class=\"comment\">// hookï¼šå‘é€æ¶ˆæ¯å‰é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">45</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"> <span class=\"number\">46</span>:                 context = <span class=\"keyword\">new</span> SendMessageContext();</div><div class=\"line\"> <span class=\"number\">47</span>:                 context.setProducer(<span class=\"keyword\">this</span>);</div><div class=\"line\"> <span class=\"number\">48</span>:                 context.setProducerGroup(<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"> <span class=\"number\">49</span>:                 context.setCommunicationMode(communicationMode);</div><div class=\"line\"> <span class=\"number\">50</span>:                 context.setBornHost(<span class=\"keyword\">this</span>.defaultMQProducer.getClientIP());</div><div class=\"line\"> <span class=\"number\">51</span>:                 context.setBrokerAddr(brokerAddr);</div><div class=\"line\"> <span class=\"number\">52</span>:                 context.setMessage(msg);</div><div class=\"line\"> <span class=\"number\">53</span>:                 context.setMq(mq);</div><div class=\"line\"> <span class=\"number\">54</span>:                 String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class=\"line\"> <span class=\"number\">55</span>:                 <span class=\"keyword\">if</span> (isTrans != <span class=\"keyword\">null</span> &amp;&amp; isTrans.equals(<span class=\"string\">\"true\"</span>)) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:                     context.setMsgType(MessageType.Trans_Msg_Half);</div><div class=\"line\"> <span class=\"number\">57</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">58</span>:                 <span class=\"keyword\">if</span> (msg.getProperty(<span class=\"string\">\"__STARTDELIVERTIME\"</span>) != <span class=\"keyword\">null</span> || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:                     context.setMsgType(MessageType.Delay_Msg);</div><div class=\"line\"> <span class=\"number\">60</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">61</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookBefore(context);</div><div class=\"line\"> <span class=\"number\">62</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">63</span>:             <span class=\"comment\">// æ„å»ºå‘é€æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">64</span>:             SendMessageRequestHeader requestHeader = <span class=\"keyword\">new</span> SendMessageRequestHeader();</div><div class=\"line\"> <span class=\"number\">65</span>:             requestHeader.setProducerGroup(<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"> <span class=\"number\">66</span>:             requestHeader.setTopic(msg.getTopic());</div><div class=\"line\"> <span class=\"number\">67</span>:             requestHeader.setDefaultTopic(<span class=\"keyword\">this</span>.defaultMQProducer.getCreateTopicKey());</div><div class=\"line\"> <span class=\"number\">68</span>:             requestHeader.setDefaultTopicQueueNums(<span class=\"keyword\">this</span>.defaultMQProducer.getDefaultTopicQueueNums());</div><div class=\"line\"> <span class=\"number\">69</span>:             requestHeader.setQueueId(mq.getQueueId());</div><div class=\"line\"> <span class=\"number\">70</span>:             requestHeader.setSysFlag(sysFlag);</div><div class=\"line\"> <span class=\"number\">71</span>:             requestHeader.setBornTimestamp(System.currentTimeMillis());</div><div class=\"line\"> <span class=\"number\">72</span>:             requestHeader.setFlag(msg.getFlag());</div><div class=\"line\"> <span class=\"number\">73</span>:             requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));</div><div class=\"line\"> <span class=\"number\">74</span>:             requestHeader.setReconsumeTimes(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">75</span>:             requestHeader.setUnitMode(<span class=\"keyword\">this</span>.isUnitMode());</div><div class=\"line\"> <span class=\"number\">76</span>:             <span class=\"keyword\">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123; <span class=\"comment\">// æ¶ˆæ¯é‡å‘Topic</span></div><div class=\"line\"> <span class=\"number\">77</span>:                 String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);</div><div class=\"line\"> <span class=\"number\">78</span>:                 <span class=\"keyword\">if</span> (reconsumeTimes != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">79</span>:                     requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));</div><div class=\"line\"> <span class=\"number\">80</span>:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);</div><div class=\"line\"> <span class=\"number\">81</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">82</span>:                 String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);</div><div class=\"line\"> <span class=\"number\">83</span>:                 <span class=\"keyword\">if</span> (maxReconsumeTimes != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">84</span>:                     requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));</div><div class=\"line\"> <span class=\"number\">85</span>:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);</div><div class=\"line\"> <span class=\"number\">86</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">87</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">88</span>:             <span class=\"comment\">// å‘é€æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">89</span>:             SendResult sendResult = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">90</span>:             <span class=\"keyword\">switch</span> (communicationMode) &#123;</div><div class=\"line\"> <span class=\"number\">91</span>:                 <span class=\"keyword\">case</span> ASYNC:</div><div class=\"line\"> <span class=\"number\">92</span>:                     sendResult = <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">93</span>:                         brokerAddr, <span class=\"comment\">// 1</span></div><div class=\"line\"> <span class=\"number\">94</span>:                         mq.getBrokerName(), <span class=\"comment\">// 2</span></div><div class=\"line\"> <span class=\"number\">95</span>:                         msg, <span class=\"comment\">// 3</span></div><div class=\"line\"> <span class=\"number\">96</span>:                         requestHeader, <span class=\"comment\">// 4</span></div><div class=\"line\"> <span class=\"number\">97</span>:                         timeout, <span class=\"comment\">// 5</span></div><div class=\"line\"> <span class=\"number\">98</span>:                         communicationMode, <span class=\"comment\">// 6</span></div><div class=\"line\"> <span class=\"number\">99</span>:                         sendCallback, <span class=\"comment\">// 7</span></div><div class=\"line\"><span class=\"number\">100</span>:                         topicPublishInfo, <span class=\"comment\">// 8</span></div><div class=\"line\"><span class=\"number\">101</span>:                         <span class=\"keyword\">this</span>.mQClientFactory, <span class=\"comment\">// 9</span></div><div class=\"line\"><span class=\"number\">102</span>:                         <span class=\"keyword\">this</span>.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(), <span class=\"comment\">// 10</span></div><div class=\"line\"><span class=\"number\">103</span>:                         context, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">104</span>:                         <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">105</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">106</span>:                 <span class=\"keyword\">case</span> ONEWAY:</div><div class=\"line\"><span class=\"number\">107</span>:                 <span class=\"keyword\">case</span> SYNC:</div><div class=\"line\"><span class=\"number\">108</span>:                     sendResult = <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</div><div class=\"line\"><span class=\"number\">109</span>:                         brokerAddr,</div><div class=\"line\"><span class=\"number\">110</span>:                         mq.getBrokerName(),</div><div class=\"line\"><span class=\"number\">111</span>:                         msg,</div><div class=\"line\"><span class=\"number\">112</span>:                         requestHeader,</div><div class=\"line\"><span class=\"number\">113</span>:                         timeout,</div><div class=\"line\"><span class=\"number\">114</span>:                         communicationMode,</div><div class=\"line\"><span class=\"number\">115</span>:                         context,</div><div class=\"line\"><span class=\"number\">116</span>:                         <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">117</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">118</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">119</span>:                     <span class=\"keyword\">assert</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">120</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">121</span>:             &#125;</div><div class=\"line\"><span class=\"number\">122</span>:             <span class=\"comment\">// hookï¼šå‘é€æ¶ˆæ¯åé€»è¾‘</span></div><div class=\"line\"><span class=\"number\">123</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:                 context.setSendResult(sendResult);</div><div class=\"line\"><span class=\"number\">125</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookAfter(context);</div><div class=\"line\"><span class=\"number\">126</span>:             &#125;</div><div class=\"line\"><span class=\"number\">127</span>:             <span class=\"comment\">// è¿”å›å‘é€ç»“æœ</span></div><div class=\"line\"><span class=\"number\">128</span>:             <span class=\"keyword\">return</span> sendResult;</div><div class=\"line\"><span class=\"number\">129</span>:         &#125; <span class=\"keyword\">catch</span> (RemotingException e) &#123;</div><div class=\"line\"><span class=\"number\">130</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">131</span>:                 context.setException(e);</div><div class=\"line\"><span class=\"number\">132</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookAfter(context);</div><div class=\"line\"><span class=\"number\">133</span>:             &#125;</div><div class=\"line\"><span class=\"number\">134</span>:             <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">135</span>:         &#125; <span class=\"keyword\">catch</span> (MQBrokerException e) &#123;</div><div class=\"line\"><span class=\"number\">136</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">137</span>:                 context.setException(e);</div><div class=\"line\"><span class=\"number\">138</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookAfter(context);</div><div class=\"line\"><span class=\"number\">139</span>:             &#125;</div><div class=\"line\"><span class=\"number\">140</span>:             <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">141</span>:         &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">142</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">143</span>:                 context.setException(e);</div><div class=\"line\"><span class=\"number\">144</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookAfter(context);</div><div class=\"line\"><span class=\"number\">145</span>:             &#125;</div><div class=\"line\"><span class=\"number\">146</span>:             <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">147</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">148</span>:             msg.setBody(prevBody);</div><div class=\"line\"><span class=\"number\">149</span>:         &#125;</div><div class=\"line\"><span class=\"number\">150</span>:     &#125;</div><div class=\"line\"><span class=\"number\">151</span>:     <span class=\"comment\">// brokerä¸ºç©ºæŠ›å‡ºå¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">152</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"The broker[\"</span> + mq.getBrokerName() + <span class=\"string\">\"] not exist\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">153</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚è¯¥æ–¹æ³•çœŸæ­£å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå‘é€æ¶ˆæ¯ç»™ <code>Broker</code>ã€‚</li>\n<li>ç¬¬ 21 è¡Œ ï¼šç”Ÿäº§æ¶ˆæ¯ç¼–å·ï¼Œè¯¦ç»†è§£æè§<a href=\"http://www.yunai.me/RocketMQ/message/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message åŸºç¡€ã€‹</a>ã€‚</li>\n<li>ç¬¬ 64 è‡³ 121 è¡Œ ï¼šæ„å»ºå‘é€æ¶ˆæ¯è¯·æ±‚<code>SendMessageRequestHeader</code>ã€‚</li>\n<li>ç¬¬ 107 è‡³ 117 è¡Œ ï¼šæ‰§è¡Œ <code>MQClientInstance#sendMessage(...)</code> å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚</li>\n</ul>\n<h1 id=\"3ã€Broker-æ¥æ”¶æ¶ˆæ¯\"><a href=\"#3ã€Broker-æ¥æ”¶æ¶ˆæ¯\" class=\"headerlink\" title=\"3ã€Broker æ¥æ”¶æ¶ˆæ¯\"></a>3ã€Broker æ¥æ”¶æ¶ˆæ¯</h1><blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_18/04.png\" alt=\"æ¥æ”¶å‘é€æ¶ˆæ¯APIé¡ºåºå›¾\"></p>\n</blockquote>\n<h2 id=\"SendMessageProcessor-sendMessage\"><a href=\"#SendMessageProcessor-sendMessage\" class=\"headerlink\" title=\"SendMessageProcessor#sendMessage\"></a>SendMessageProcessor#sendMessage</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RemotingCommand <span class=\"title\">processRequest</span><span class=\"params\">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class=\"keyword\">throws</span> RemotingCommandException </span>&#123;</div><div class=\"line\">  <span class=\"number\">3</span>:     SendMessageContext mqtraceContext;</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"keyword\">switch</span> (request.getCode()) &#123;</div><div class=\"line\">  <span class=\"number\">5</span>:         <span class=\"keyword\">case</span> RequestCode.CONSUMER_SEND_MSG_BACK:</div><div class=\"line\">  <span class=\"number\">6</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.consumerSendMsgBack(ctx, request);</div><div class=\"line\">  <span class=\"number\">7</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\">  <span class=\"number\">8</span>:             <span class=\"comment\">// è§£æè¯·æ±‚</span></div><div class=\"line\">  <span class=\"number\">9</span>:             SendMessageRequestHeader requestHeader = parseRequestHeader(request);</div><div class=\"line\"> <span class=\"number\">10</span>:             <span class=\"keyword\">if</span> (requestHeader == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">11</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">12</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">13</span>:             <span class=\"comment\">// å‘é€è¯·æ±‚Contextã€‚åœ¨ hook åœºæ™¯ä¸‹ä½¿ç”¨</span></div><div class=\"line\"> <span class=\"number\">14</span>:             mqtraceContext = buildMsgContext(ctx, requestHeader);</div><div class=\"line\"> <span class=\"number\">15</span>:             <span class=\"comment\">// hookï¼šå¤„ç†å‘é€æ¶ˆæ¯å‰é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">16</span>:             <span class=\"keyword\">this</span>.executeSendMessageHookBefore(ctx, request, mqtraceContext);</div><div class=\"line\"> <span class=\"number\">17</span>:             <span class=\"comment\">// å¤„ç†å‘é€æ¶ˆæ¯é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">18</span>:             <span class=\"keyword\">final</span> RemotingCommand response = <span class=\"keyword\">this</span>.sendMessage(ctx, request, mqtraceContext, requestHeader);</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"comment\">// hookï¼šå¤„ç†å‘é€æ¶ˆæ¯åé€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"keyword\">this</span>.executeSendMessageHookAfter(response, mqtraceContext);</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">22</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">23</span>: &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">sendMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx, //</span></span></div><div class=\"line\"> <span class=\"number\">26</span>:     <span class=\"keyword\">final</span> RemotingCommand request, //</div><div class=\"line\"> <span class=\"number\">27</span>:     <span class=\"keyword\">final</span> SendMessageContext sendMessageContext, //</div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"keyword\">final</span> SendMessageRequestHeader requestHeader) <span class=\"keyword\">throws</span> RemotingCommandException &#123;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:     <span class=\"comment\">// åˆå§‹åŒ–å“åº”</span></div><div class=\"line\"> <span class=\"number\">31</span>:     <span class=\"keyword\">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(SendMessageResponseHeader.class);</div><div class=\"line\"> <span class=\"number\">32</span>:     <span class=\"keyword\">final</span> SendMessageResponseHeader responseHeader = (SendMessageResponseHeader) response.readCustomHeader();</div><div class=\"line\"> <span class=\"number\">33</span>:     response.setOpaque(request.getOpaque());</div><div class=\"line\"> <span class=\"number\">34</span>:     response.addExtField(MessageConst.PROPERTY_MSG_REGION, <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getRegionId());</div><div class=\"line\"> <span class=\"number\">35</span>:     response.addExtField(MessageConst.PROPERTY_TRACE_SWITCH, String.valueOf(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isTraceOn()));</div><div class=\"line\"> <span class=\"number\">36</span>: </div><div class=\"line\"> <span class=\"number\">37</span>:     <span class=\"keyword\">if</span> (log.isDebugEnabled()) &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:         log.debug(<span class=\"string\">\"receive SendMessage request command, &#123;&#125;\"</span>, request);</div><div class=\"line\"> <span class=\"number\">39</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">40</span>: </div><div class=\"line\"> <span class=\"number\">41</span>:     <span class=\"comment\">// å¦‚æœæœªå¼€å§‹æ¥æ”¶æ¶ˆæ¯ï¼ŒæŠ›å‡ºç³»ç»Ÿå¼‚å¸¸</span></div><div class=\"line\"> <span class=\"number\">42</span>:     <span class=\"meta\">@SuppressWarnings</span>(<span class=\"string\">\"SpellCheckingInspection\"</span>)</div><div class=\"line\"> <span class=\"number\">43</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> startTimstamp = <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getStartAcceptSendRequestTimeStamp();</div><div class=\"line\"> <span class=\"number\">44</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getMessageStore().now() &lt; startTimstamp) &#123;</div><div class=\"line\"> <span class=\"number\">45</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">46</span>:         response.setRemark(String.format(<span class=\"string\">\"broker unable to service, until %s\"</span>, UtilAll.timeMillisToHumanString2(startTimstamp)));</div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">48</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">49</span>: </div><div class=\"line\"> <span class=\"number\">50</span>:     <span class=\"comment\">// æ¶ˆæ¯é…ç½®(Topicé…ç½®ï¼‰æ ¡éªŒ</span></div><div class=\"line\"> <span class=\"number\">51</span>:     response.setCode(-<span class=\"number\">1</span>);</div><div class=\"line\"> <span class=\"number\">52</span>:     <span class=\"keyword\">super</span>.msgCheck(ctx, requestHeader, response);</div><div class=\"line\"> <span class=\"number\">53</span>:     <span class=\"keyword\">if</span> (response.getCode() != -<span class=\"number\">1</span>) &#123;</div><div class=\"line\"> <span class=\"number\">54</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">55</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">56</span>: </div><div class=\"line\"> <span class=\"number\">57</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] body = request.getBody();</div><div class=\"line\"> <span class=\"number\">58</span>: </div><div class=\"line\"> <span class=\"number\">59</span>:     <span class=\"comment\">// å¦‚æœé˜Ÿåˆ—å°äº0ï¼Œä»å¯ç”¨é˜Ÿåˆ—éšæœºé€‰æ‹©</span></div><div class=\"line\"> <span class=\"number\">60</span>:     <span class=\"keyword\">int</span> queueIdInt = requestHeader.getQueueId();</div><div class=\"line\"> <span class=\"number\">61</span>:     TopicConfig topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class=\"line\"> <span class=\"number\">62</span>:     <span class=\"keyword\">if</span> (queueIdInt &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:         queueIdInt = Math.abs(<span class=\"keyword\">this</span>.random.nextInt() % <span class=\"number\">99999999</span>) % topicConfig.getWriteQueueNums();</div><div class=\"line\"> <span class=\"number\">64</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:     <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">67</span>:     <span class=\"keyword\">int</span> sysFlag = requestHeader.getSysFlag();</div><div class=\"line\"> <span class=\"number\">68</span>:     <span class=\"keyword\">if</span> (TopicFilterType.MULTI_TAG == topicConfig.getTopicFilterType()) &#123;</div><div class=\"line\"> <span class=\"number\">69</span>:         sysFlag |= MessageSysFlag.MULTI_TAGS_FLAG;</div><div class=\"line\"> <span class=\"number\">70</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">71</span>: </div><div class=\"line\"> <span class=\"number\">72</span>:     <span class=\"comment\">// å¯¹RETRYç±»å‹çš„æ¶ˆæ¯å¤„ç†ã€‚å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)</span></div><div class=\"line\"> <span class=\"number\">73</span>:     String newTopic = requestHeader.getTopic();</div><div class=\"line\"> <span class=\"number\">74</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != newTopic &amp;&amp; newTopic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"comment\">// è·å–è®¢é˜…åˆ†ç»„é…ç½®</span></div><div class=\"line\"> <span class=\"number\">76</span>:         String groupName = newTopic.substring(MixAll.RETRY_GROUP_TOPIC_PREFIX.length());</div><div class=\"line\"> <span class=\"number\">77</span>:         SubscriptionGroupConfig subscriptionGroupConfig =</div><div class=\"line\"> <span class=\"number\">78</span>:             <span class=\"keyword\">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(groupName);</div><div class=\"line\"> <span class=\"number\">79</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionGroupConfig) &#123;</div><div class=\"line\"> <span class=\"number\">80</span>:             response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">81</span>:             response.setRemark(<span class=\"string\">\"subscription group not exist, \"</span> + groupName + <span class=\"string\">\" \"</span> + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</div><div class=\"line\"> <span class=\"number\">82</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">83</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">84</span>:         <span class=\"comment\">// è®¡ç®—æœ€å¤§å¯æ¶ˆè´¹æ¬¡æ•°</span></div><div class=\"line\"> <span class=\"number\">85</span>:         <span class=\"keyword\">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class=\"line\"> <span class=\"number\">86</span>:         <span class=\"keyword\">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:             maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class=\"line\"> <span class=\"number\">88</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">89</span>:         <span class=\"keyword\">int</span> reconsumeTimes = requestHeader.getReconsumeTimes() == <span class=\"keyword\">null</span> ? <span class=\"number\">0</span> : requestHeader.getReconsumeTimes();</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"keyword\">if</span> (reconsumeTimes &gt;= maxReconsumeTimes) &#123; <span class=\"comment\">// è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°</span></div><div class=\"line\"> <span class=\"number\">91</span>:             newTopic = MixAll.getDLQTopic(groupName);</div><div class=\"line\"> <span class=\"number\">92</span>:             queueIdInt = Math.abs(<span class=\"keyword\">this</span>.random.nextInt() % <span class=\"number\">99999999</span>) % DLQ_NUMS_PER_GROUP;</div><div class=\"line\"> <span class=\"number\">93</span>:             topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">94</span>:                 DLQ_NUMS_PER_GROUP, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">95</span>:                 PermName.PERM_WRITE, <span class=\"number\">0</span></div><div class=\"line\"> <span class=\"number\">96</span>:             );</div><div class=\"line\"> <span class=\"number\">97</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">99</span>:                 response.setRemark(<span class=\"string\">\"topic[\"</span> + newTopic + <span class=\"string\">\"] not exist\"</span>);</div><div class=\"line\"><span class=\"number\">100</span>:                 <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">101</span>:             &#125;</div><div class=\"line\"><span class=\"number\">102</span>:         &#125;</div><div class=\"line\"><span class=\"number\">103</span>:     &#125;</div><div class=\"line\"><span class=\"number\">104</span>: </div><div class=\"line\"><span class=\"number\">105</span>:     <span class=\"comment\">// åˆ›å»ºMessageExtBrokerInner</span></div><div class=\"line\"><span class=\"number\">106</span>:     MessageExtBrokerInner msgInner = <span class=\"keyword\">new</span> MessageExtBrokerInner();</div><div class=\"line\"><span class=\"number\">107</span>:     msgInner.setTopic(newTopic);</div><div class=\"line\"><span class=\"number\">108</span>:     msgInner.setBody(body);</div><div class=\"line\"><span class=\"number\">109</span>:     msgInner.setFlag(requestHeader.getFlag());</div><div class=\"line\"><span class=\"number\">110</span>:     MessageAccessor.setProperties(msgInner, MessageDecoder.string2messageProperties(requestHeader.getProperties()));</div><div class=\"line\"><span class=\"number\">111</span>:     msgInner.setPropertiesString(requestHeader.getProperties());</div><div class=\"line\"><span class=\"number\">112</span>:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(topicConfig.getTopicFilterType(), msgInner.getTags()));</div><div class=\"line\"><span class=\"number\">113</span>:     msgInner.setQueueId(queueIdInt);</div><div class=\"line\"><span class=\"number\">114</span>:     msgInner.setSysFlag(sysFlag);</div><div class=\"line\"><span class=\"number\">115</span>:     msgInner.setBornTimestamp(requestHeader.getBornTimestamp());</div><div class=\"line\"><span class=\"number\">116</span>:     msgInner.setBornHost(ctx.channel().remoteAddress());</div><div class=\"line\"><span class=\"number\">117</span>:     msgInner.setStoreHost(<span class=\"keyword\">this</span>.getStoreHost());</div><div class=\"line\"><span class=\"number\">118</span>:     msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == <span class=\"keyword\">null</span> ? <span class=\"number\">0</span> : requestHeader.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">119</span>: </div><div class=\"line\"><span class=\"number\">120</span>:     <span class=\"comment\">// æ ¡éªŒæ˜¯å¦ä¸å…è®¸å‘é€äº‹åŠ¡æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">121</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isRejectTransactionMessage()) &#123;</div><div class=\"line\"><span class=\"number\">122</span>:         String traFlag = msgInner.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class=\"line\"><span class=\"number\">123</span>:         <span class=\"keyword\">if</span> (traFlag != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:             response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"><span class=\"number\">125</span>:             response.setRemark(</div><div class=\"line\"><span class=\"number\">126</span>:                 <span class=\"string\">\"the broker[\"</span> + <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerIP1() + <span class=\"string\">\"] sending transaction message is forbidden\"</span>);</div><div class=\"line\"><span class=\"number\">127</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">128</span>:         &#125;</div><div class=\"line\"><span class=\"number\">129</span>:     &#125;</div><div class=\"line\"><span class=\"number\">130</span>: </div><div class=\"line\"><span class=\"number\">131</span>:     <span class=\"comment\">// æ·»åŠ æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">132</span>:     PutMessageResult putMessageResult = <span class=\"keyword\">this</span>.brokerController.getMessageStore().putMessage(msgInner);</div><div class=\"line\"><span class=\"number\">133</span>:     <span class=\"keyword\">if</span> (putMessageResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">134</span>:         <span class=\"keyword\">boolean</span> sendOK = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">135</span>: </div><div class=\"line\"><span class=\"number\">136</span>:         <span class=\"keyword\">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class=\"line\"><span class=\"number\">137</span>:             <span class=\"comment\">// Success</span></div><div class=\"line\"><span class=\"number\">138</span>:             <span class=\"keyword\">case</span> PUT_OK:</div><div class=\"line\"><span class=\"number\">139</span>:                 sendOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">140</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"><span class=\"number\">141</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">142</span>:             <span class=\"keyword\">case</span> FLUSH_DISK_TIMEOUT:</div><div class=\"line\"><span class=\"number\">143</span>:                 response.setCode(ResponseCode.FLUSH_DISK_TIMEOUT);</div><div class=\"line\"><span class=\"number\">144</span>:                 sendOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">145</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">146</span>:             <span class=\"keyword\">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class=\"line\"><span class=\"number\">147</span>:                 response.setCode(ResponseCode.FLUSH_SLAVE_TIMEOUT);</div><div class=\"line\"><span class=\"number\">148</span>:                 sendOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">149</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">150</span>:             <span class=\"keyword\">case</span> SLAVE_NOT_AVAILABLE:</div><div class=\"line\"><span class=\"number\">151</span>:                 response.setCode(ResponseCode.SLAVE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">152</span>:                 sendOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">153</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">154</span>: </div><div class=\"line\"><span class=\"number\">155</span>:             <span class=\"comment\">// Failed</span></div><div class=\"line\"><span class=\"number\">156</span>:             <span class=\"keyword\">case</span> CREATE_MAPEDFILE_FAILED:</div><div class=\"line\"><span class=\"number\">157</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">158</span>:                 response.setRemark(<span class=\"string\">\"create mapped file failed, server is busy or broken.\"</span>);</div><div class=\"line\"><span class=\"number\">159</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">160</span>:             <span class=\"keyword\">case</span> MESSAGE_ILLEGAL:</div><div class=\"line\"><span class=\"number\">161</span>:             <span class=\"keyword\">case</span> PROPERTIES_SIZE_EXCEEDED:</div><div class=\"line\"><span class=\"number\">162</span>:                 response.setCode(ResponseCode.MESSAGE_ILLEGAL);</div><div class=\"line\"><span class=\"number\">163</span>:                 response.setRemark(</div><div class=\"line\"><span class=\"number\">164</span>:                     <span class=\"string\">\"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.\"</span>);</div><div class=\"line\"><span class=\"number\">165</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">166</span>:             <span class=\"keyword\">case</span> SERVICE_NOT_AVAILABLE:</div><div class=\"line\"><span class=\"number\">167</span>:                 response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">168</span>:                 response.setRemark(</div><div class=\"line\"><span class=\"number\">169</span>:                     <span class=\"string\">\"service not available now, maybe disk full, \"</span> + diskUtil() + <span class=\"string\">\", maybe your broker machine memory too small.\"</span>);</div><div class=\"line\"><span class=\"number\">170</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">171</span>:             <span class=\"keyword\">case</span> OS_PAGECACHE_BUSY:</div><div class=\"line\"><span class=\"number\">172</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">173</span>:                 response.setRemark(<span class=\"string\">\"[PC_SYNCHRONIZED]broker busy, start flow control for a while\"</span>);</div><div class=\"line\"><span class=\"number\">174</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">175</span>:             <span class=\"keyword\">case</span> UNKNOWN_ERROR:</div><div class=\"line\"><span class=\"number\">176</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">177</span>:                 response.setRemark(<span class=\"string\">\"UNKNOWN_ERROR\"</span>);</div><div class=\"line\"><span class=\"number\">178</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">179</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">180</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">181</span>:                 response.setRemark(<span class=\"string\">\"UNKNOWN_ERROR DEFAULT\"</span>);</div><div class=\"line\"><span class=\"number\">182</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">183</span>:         &#125;</div><div class=\"line\"><span class=\"number\">184</span>: </div><div class=\"line\"><span class=\"number\">185</span>:         String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</div><div class=\"line\"><span class=\"number\">186</span>:         <span class=\"keyword\">if</span> (sendOK) &#123;</div><div class=\"line\"><span class=\"number\">187</span>:             <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"><span class=\"number\">188</span>:             <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incTopicPutNums(msgInner.getTopic());</div><div class=\"line\"><span class=\"number\">189</span>:             <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incTopicPutSize(msgInner.getTopic(), putMessageResult.getAppendMessageResult().getWroteBytes());</div><div class=\"line\"><span class=\"number\">190</span>:             <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incBrokerPutNums();</div><div class=\"line\"><span class=\"number\">191</span>: </div><div class=\"line\"><span class=\"number\">192</span>:             <span class=\"comment\">// å“åº”</span></div><div class=\"line\"><span class=\"number\">193</span>:             response.setRemark(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">194</span>:             responseHeader.setMsgId(putMessageResult.getAppendMessageResult().getMsgId());</div><div class=\"line\"><span class=\"number\">195</span>:             responseHeader.setQueueId(queueIdInt);</div><div class=\"line\"><span class=\"number\">196</span>:             responseHeader.setQueueOffset(putMessageResult.getAppendMessageResult().getLogicsOffset());</div><div class=\"line\"><span class=\"number\">197</span>:             doResponse(ctx, request, response);</div><div class=\"line\"><span class=\"number\">198</span>: </div><div class=\"line\"><span class=\"number\">199</span>:             <span class=\"comment\">// hookï¼šè®¾ç½®å‘é€æˆåŠŸåˆ°context</span></div><div class=\"line\"><span class=\"number\">200</span>:             <span class=\"keyword\">if</span> (hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">201</span>:                 sendMessageContext.setMsgId(responseHeader.getMsgId());</div><div class=\"line\"><span class=\"number\">202</span>:                 sendMessageContext.setQueueId(responseHeader.getQueueId());</div><div class=\"line\"><span class=\"number\">203</span>:                 sendMessageContext.setQueueOffset(responseHeader.getQueueOffset());</div><div class=\"line\"><span class=\"number\">204</span>: </div><div class=\"line\"><span class=\"number\">205</span>:                 <span class=\"keyword\">int</span> commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</div><div class=\"line\"><span class=\"number\">206</span>:                 <span class=\"keyword\">int</span> wroteSize = putMessageResult.getAppendMessageResult().getWroteBytes();</div><div class=\"line\"><span class=\"number\">207</span>:                 <span class=\"keyword\">int</span> incValue = (<span class=\"keyword\">int</span>) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT) * commercialBaseCount;</div><div class=\"line\"><span class=\"number\">208</span>: </div><div class=\"line\"><span class=\"number\">209</span>:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_SUCCESS);</div><div class=\"line\"><span class=\"number\">210</span>:                 sendMessageContext.setCommercialSendTimes(incValue);</div><div class=\"line\"><span class=\"number\">211</span>:                 sendMessageContext.setCommercialSendSize(wroteSize);</div><div class=\"line\"><span class=\"number\">212</span>:                 sendMessageContext.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">213</span>:             &#125;</div><div class=\"line\"><span class=\"number\">214</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">215</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">216</span>:             <span class=\"comment\">// hookï¼šè®¾ç½®å‘é€å¤±è´¥åˆ°context</span></div><div class=\"line\"><span class=\"number\">217</span>:             <span class=\"keyword\">if</span> (hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">218</span>:                 <span class=\"keyword\">int</span> wroteSize = request.getBody().length;</div><div class=\"line\"><span class=\"number\">219</span>:                 <span class=\"keyword\">int</span> incValue = (<span class=\"keyword\">int</span>) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT);</div><div class=\"line\"><span class=\"number\">220</span>: </div><div class=\"line\"><span class=\"number\">221</span>:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_FAILURE);</div><div class=\"line\"><span class=\"number\">222</span>:                 sendMessageContext.setCommercialSendTimes(incValue);</div><div class=\"line\"><span class=\"number\">223</span>:                 sendMessageContext.setCommercialSendSize(wroteSize);</div><div class=\"line\"><span class=\"number\">224</span>:                 sendMessageContext.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">225</span>:             &#125;</div><div class=\"line\"><span class=\"number\">226</span>:         &#125;</div><div class=\"line\"><span class=\"number\">227</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">228</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">229</span>:         response.setRemark(<span class=\"string\">\"store putMessage return null\"</span>);</div><div class=\"line\"><span class=\"number\">230</span>:     &#125;</div><div class=\"line\"><span class=\"number\">231</span>: </div><div class=\"line\"><span class=\"number\">232</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">233</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li><code>#processRequest()</code> è¯´æ˜ ï¼šå¤„ç†æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li><code>#sendMessage()</code> è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯ï¼Œå¹¶è¿”å›å‘é€æ¶ˆæ¯ç»“æœã€‚</li>\n<li>ç¬¬ 51 è‡³ 55 è¡Œ ï¼šæ¶ˆæ¯é…ç½®(Topicé…ç½®ï¼‰æ ¡éªŒï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#abstractsendmessageprocessormsgcheck\">AbstractSendMessageProcessor#msgCheck()</a>ã€‚</li>\n<li>ç¬¬ 60 è‡³ 64 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼–å·å°äº0æ—¶ï¼Œ<code>Broker</code> å¯ä»¥è®¾ç½®éšæœºé€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 72 è‡³ 103 è¡Œ ï¼šå¯¹RETRYç±»å‹çš„æ¶ˆæ¯å¤„ç†ã€‚å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆâ€%DLQ%â€ + åˆ†ç»„åï¼Œ å³åŠ   æ­»ä¿¡é˜Ÿ (Dead Letter Queue)ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/topic/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹</a>ã€‚</li>\n<li>ç¬¬ 105 è‡³ 118 è¡Œ ï¼šåˆ›å»º<code>MessageExtBrokerInner</code>ã€‚</li>\n<li>ç¬¬ 132 ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"defaultmessagestoreputmessage\">DefaultMessageStore#putMessage()</a>ã€‚</li>\n<li>ç¬¬ 133 è‡³ 183 è¡Œ ï¼šå¤„ç†æ¶ˆæ¯å‘é€ç»“æœï¼Œè®¾ç½®å“åº”ç»“æœå’Œæç¤ºã€‚</li>\n<li>ç¬¬ 186 è‡³ 214 è¡Œ ï¼šå‘é€æˆåŠŸï¼Œå“åº”ã€‚è¿™é‡Œ<code>doResponse(ctx, request, response)</code>è¿›è¡Œå“åº”ï¼Œæœ€å<code>return null</code>ï¼ŒåŸå› æ˜¯ï¼šå“åº”ç»™ <code>Producer</code> å¯èƒ½å‘ç”Ÿå¼‚å¸¸ï¼Œ<code>#doResponse(ctx, request, response)</code>æ•æ‰äº†è¯¥å¼‚å¸¸å¹¶è¾“å‡ºæ—¥å¿—ã€‚è¿™æ ·åšçš„è¯ï¼Œæˆ‘ä»¬è¿›è¡Œæ’æŸ¥ <code>Broker</code> æ¥æ”¶æ¶ˆæ¯æˆåŠŸåå“åº”æ˜¯å¦å­˜åœ¨å¼‚å¸¸ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚</li>\n</ul>\n<h3 id=\"AbstractSendMessageProcessor-msgCheck\"><a href=\"#AbstractSendMessageProcessor-msgCheck\" class=\"headerlink\" title=\"AbstractSendMessageProcessor#msgCheck\"></a>AbstractSendMessageProcessor#msgCheck</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">protected</span> RemotingCommand <span class=\"title\">msgCheck</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx,</span></span></div><div class=\"line\"> <span class=\"number\">2</span>:                                    <span class=\"keyword\">final</span> SendMessageRequestHeader requestHeader, <span class=\"keyword\">final</span> RemotingCommand response) &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™</span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">if</span> (!PermName.isWriteable(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerPermission())</div><div class=\"line\"> <span class=\"number\">5</span>:         &amp;&amp; <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().isOrderTopic(requestHeader.getTopic())) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">7</span>:         response.setRemark(<span class=\"string\">\"the broker[\"</span> + <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerIP1()</div><div class=\"line\"> <span class=\"number\">8</span>:             + <span class=\"string\">\"] sending message is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">10</span>:     &#125;</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"comment\">// æ£€æŸ¥topicæ˜¯å¦å¯ä»¥è¢«å‘é€ã€‚ç›®å‰æ˜¯&#123;@link MixAll.DEFAULT_TOPIC&#125;ä¸è¢«å…è®¸å‘é€</span></div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().isTopicCanSendMessage(requestHeader.getTopic())) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:         String errorMsg = <span class=\"string\">\"the topic[\"</span> + requestHeader.getTopic() + <span class=\"string\">\"] is conflict with system reserved words.\"</span>;</div><div class=\"line\"><span class=\"number\">14</span>:         log.warn(errorMsg);</div><div class=\"line\"><span class=\"number\">15</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">16</span>:         response.setRemark(errorMsg);</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">18</span>:     &#125;</div><div class=\"line\"><span class=\"number\">19</span>:     TopicConfig topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123; <span class=\"comment\">// ä¸èƒ½å­˜åœ¨topicConfigï¼Œåˆ™è¿›è¡Œåˆ›å»º</span></div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"keyword\">int</span> topicSysFlag = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">22</span>:         <span class=\"keyword\">if</span> (requestHeader.isUnitMode()) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 topicSysFlag = TopicSysFlag.buildSysFlag(<span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">25</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 topicSysFlag = TopicSysFlag.buildSysFlag(<span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"comment\">// åˆ›å»ºtopicé…ç½®</span></div><div class=\"line\"><span class=\"number\">30</span>:         log.warn(<span class=\"string\">\"the topic &#123;&#125; not exist, producer: &#123;&#125;\"</span>, requestHeader.getTopic(), ctx.channel().remoteAddress());</div><div class=\"line\"><span class=\"number\">31</span>:         topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageMethod(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">32</span>:             requestHeader.getTopic(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">33</span>:             requestHeader.getDefaultTopic(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">34</span>:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">35</span>:             requestHeader.getDefaultTopicQueueNums(), topicSysFlag);</div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                 topicConfig =</div><div class=\"line\"><span class=\"number\">39</span>:                     <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(</div><div class=\"line\"><span class=\"number\">40</span>:                         requestHeader.getTopic(), <span class=\"number\">1</span>, PermName.PERM_WRITE | PermName.PERM_READ,</div><div class=\"line\"><span class=\"number\">41</span>:                         topicSysFlag);</div><div class=\"line\"><span class=\"number\">42</span>:             &#125;</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"comment\">// å¦‚æœæ²¡é…ç½®</span></div><div class=\"line\"><span class=\"number\">45</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"><span class=\"number\">46</span>:             response.setCode(ResponseCode.TOPIC_NOT_EXIST);</div><div class=\"line\"><span class=\"number\">47</span>:             response.setRemark(<span class=\"string\">\"topic[\"</span> + requestHeader.getTopic() + <span class=\"string\">\"] not exist, apply first please!\"</span></div><div class=\"line\"><span class=\"number\">48</span>:                 + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));</div><div class=\"line\"><span class=\"number\">49</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">50</span>:         &#125;</div><div class=\"line\"><span class=\"number\">51</span>:     &#125;</div><div class=\"line\"><span class=\"number\">52</span>:     <span class=\"comment\">// é˜Ÿåˆ—ç¼–å·æ˜¯å¦æ­£ç¡®</span></div><div class=\"line\"><span class=\"number\">53</span>:     <span class=\"keyword\">int</span> queueIdInt = requestHeader.getQueueId();</div><div class=\"line\"><span class=\"number\">54</span>:     <span class=\"keyword\">int</span> idValid = Math.max(topicConfig.getWriteQueueNums(), topicConfig.getReadQueueNums());</div><div class=\"line\"><span class=\"number\">55</span>:     <span class=\"keyword\">if</span> (queueIdInt &gt;= idValid) &#123;</div><div class=\"line\"><span class=\"number\">56</span>:         String errorInfo = String.format(<span class=\"string\">\"request queueId[%d] is illegal, %s Producer: %s\"</span>,</div><div class=\"line\"><span class=\"number\">57</span>:             queueIdInt,</div><div class=\"line\"><span class=\"number\">58</span>:             topicConfig.toString(),</div><div class=\"line\"><span class=\"number\">59</span>:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()));</div><div class=\"line\"><span class=\"number\">60</span>:         log.warn(errorInfo);</div><div class=\"line\"><span class=\"number\">61</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">62</span>:         response.setRemark(errorInfo);</div><div class=\"line\"><span class=\"number\">63</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">64</span>:     &#125;</div><div class=\"line\"><span class=\"number\">65</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">66</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ï¼šæ ¡éªŒæ¶ˆæ¯æ˜¯å¦æ­£ç¡®ï¼Œä¸»è¦æ˜¯Topicé…ç½®æ–¹é¢ï¼Œä¾‹å¦‚ï¼š<code>Broker</code> æ˜¯å¦æœ‰å†™å…¥æƒé™ï¼Œtopicé…ç½®æ˜¯å¦å­˜åœ¨ï¼Œé˜Ÿåˆ—ç¼–å·æ˜¯å¦æ­£ç¡®ã€‚</li>\n<li>ç¬¬ 11 è‡³ 18 è¡Œ ï¼šæ£€æŸ¥Topicæ˜¯å¦å¯ä»¥è¢«å‘é€ã€‚ç›®å‰æ˜¯ <code>{@link MixAll.DEFAULT_TOPIC}</code> ä¸è¢«å…è®¸å‘é€ã€‚</li>\n<li>ç¬¬ 20 è‡³ 51 è¡Œ ï¼šå½“æ‰¾ä¸åˆ°Topicé…ç½®ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚å½“ç„¶ï¼Œåˆ›å»ºä¼šå­˜åœ¨ä¸æˆåŠŸçš„æƒ…å†µï¼Œä¾‹å¦‚è¯´ï¼š<code>defaultTopic</code> çš„Topicé…ç½®ä¸å­˜åœ¨ï¼Œåˆæˆ–è€…æ˜¯ å­˜åœ¨ä½†æ˜¯ä¸å…è®¸ç»§æ‰¿ï¼Œè¯¦ç»†è§£æè§<a href=\"http://www.yunai.me/RocketMQ/topic/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹</a>ã€‚</li>\n</ul>\n<h2 id=\"DefaultMessageStore-putMessage\"><a href=\"#DefaultMessageStore-putMessage\" class=\"headerlink\" title=\"DefaultMessageStore#putMessage\"></a>DefaultMessageStore#putMessage</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> PutMessageResult <span class=\"title\">putMessage</span><span class=\"params\">(MessageExtBrokerInner msg)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.shutdown) &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:         log.warn(<span class=\"string\">\"message store has shutdown, so putMessage is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">5</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">// ä»èŠ‚ç‚¹ä¸å…è®¸å†™å…¥</span></div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">if</span> (BrokerRole.SLAVE == <span class=\"keyword\">this</span>.messageStoreConfig.getBrokerRole()) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">long</span> value = <span class=\"keyword\">this</span>.printTimes.getAndIncrement();</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">if</span> ((value % <span class=\"number\">50000</span>) == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:             log.warn(<span class=\"string\">\"message store is slave mode, so putMessage is forbidden \"</span>);</div><div class=\"line\"><span class=\"number\">12</span>:         &#125;</div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">15</span>:     &#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"comment\">// storeæ˜¯å¦å…è®¸å†™å…¥</span></div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.runningFlags.isWriteable()) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">long</span> value = <span class=\"keyword\">this</span>.printTimes.getAndIncrement();</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"keyword\">if</span> ((value % <span class=\"number\">50000</span>) == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:             log.warn(<span class=\"string\">\"message store is not writeable, so putMessage is forbidden \"</span> + <span class=\"keyword\">this</span>.runningFlags.getFlagBits());</div><div class=\"line\"><span class=\"number\">22</span>:         &#125;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">25</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">this</span>.printTimes.set(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">27</span>:     &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"comment\">// æ¶ˆæ¯è¿‡é•¿</span></div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">if</span> (msg.getTopic().length() &gt; Byte.MAX_VALUE) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:         log.warn(<span class=\"string\">\"putMessage message topic length too long \"</span> + msg.getTopic().length());</div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">33</span>:     &#125;</div><div class=\"line\"><span class=\"number\">34</span>: </div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"comment\">// æ¶ˆæ¯é™„åŠ å±æ€§è¿‡é•¿</span></div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"keyword\">if</span> (msg.getPropertiesString() != <span class=\"keyword\">null</span> &amp;&amp; msg.getPropertiesString().length() &gt; Short.MAX_VALUE) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:         log.warn(<span class=\"string\">\"putMessage message properties length too long \"</span> + msg.getPropertiesString().length());</div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.PROPERTIES_SIZE_EXCEEDED, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">39</span>:     &#125;</div><div class=\"line\"><span class=\"number\">40</span>: </div><div class=\"line\"><span class=\"number\">41</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isOSPageCacheBusy()) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.OS_PAGECACHE_BUSY, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"keyword\">long</span> beginTime = <span class=\"keyword\">this</span>.getSystemClock().now();</div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"comment\">// æ·»åŠ æ¶ˆæ¯åˆ°commitLog</span></div><div class=\"line\"><span class=\"number\">47</span>:     PutMessageResult result = <span class=\"keyword\">this</span>.commitLog.putMessage(msg);</div><div class=\"line\"><span class=\"number\">48</span>: </div><div class=\"line\"><span class=\"number\">49</span>:     <span class=\"keyword\">long</span> eclipseTime = <span class=\"keyword\">this</span>.getSystemClock().now() - beginTime;</div><div class=\"line\"><span class=\"number\">50</span>:     <span class=\"keyword\">if</span> (eclipseTime &gt; <span class=\"number\">500</span>) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:         log.warn(<span class=\"string\">\"putMessage not in lock eclipse time(ms)=&#123;&#125;, bodyLength=&#123;&#125;\"</span>, eclipseTime, msg.getBody().length);</div><div class=\"line\"><span class=\"number\">52</span>:     &#125;</div><div class=\"line\"><span class=\"number\">53</span>:     <span class=\"keyword\">this</span>.storeStatsService.setPutMessageEntireTimeMax(eclipseTime);</div><div class=\"line\"><span class=\"number\">54</span>: </div><div class=\"line\"><span class=\"number\">55</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == result || !result.isOk()) &#123;</div><div class=\"line\"><span class=\"number\">56</span>:         <span class=\"keyword\">this</span>.storeStatsService.getPutMessageFailedTimes().incrementAndGet();</div><div class=\"line\"><span class=\"number\">57</span>:     &#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">60</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ï¼šå­˜å‚¨æ¶ˆæ¯å°è£…ï¼Œæœ€ç»ˆå­˜å‚¨éœ€è¦ <code>CommitLog</code> å®ç°ã€‚</li>\n<li>ç¬¬ 7 è‡³ 27 è¡Œ ï¼šæ ¡éªŒ <code>Broker</code> æ˜¯å¦å¯ä»¥å†™å…¥ã€‚</li>\n<li>ç¬¬ 29 è‡³ 39 è¡Œ ï¼šæ¶ˆæ¯æ ¼å¼ä¸å¤§å°æ ¡éªŒã€‚</li>\n<li>ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ <code>CommitLong</code> è¿›è¡Œå­˜å‚¨ï¼Œè¯¦ç»†é€»è¾‘è§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-store/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨ã€‹</a></li>\n</ul>\n<h1 id=\"4ã€æŸç§ç»“å°¾\"><a href=\"#4ã€æŸç§ç»“å°¾\" class=\"headerlink\" title=\"4ã€æŸç§ç»“å°¾\"></a>4ã€æŸç§ç»“å°¾</h1><p>æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€ç‚¹èµæœ¬æ–‡çš„å·¥ç¨‹å¸ˆåŒå­¦ã€‚</p>\n<p>é˜…è¯»æºç æ˜¯ä»¶ä»¤è‡ªå·±å¾ˆæ„‰æ‚¦çš„äº‹æƒ…ï¼Œç¼–å†™æºç è§£ææ˜¯è®©è‡ªå·±è„‘ç»†èƒæ­»ä¼¤æ— æ•°çš„è¿‡ç¨‹ï¼Œç—›å¹¶å¿«ä¹ç€ã€‚</p>\n<p>å¦‚æœæœ‰å†…å®¹å†™çš„å­˜åœ¨é”™è¯¯ï¼Œæˆ–æ˜¯ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œè§ç¬‘äº†ï¼ŒğŸ™‚ã€‚æ¬¢è¿åŠ  QQï¼š7685413 æˆ‘ä»¬ä¸€èµ·æ¢è®¨ï¼Œå…±è¿›æ­¥ã€‚</p>\n<p>å†æ¬¡æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€ç‚¹èµæœ¬æ–‡çš„å·¥ç¨‹å¸ˆåŒå­¦ã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-send-and-receive/\">http://www.yunai.me/RocketMQ/message-send-and-receive/</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· </strong>  </p>\n</blockquote>\n<p><img src=\"http://www.yunai.me/images/common/wechat_mp.jpeg\" alt=\"wechat_mp\"></p>\n<hr>\n<ul>\n<li><a href=\"#\">1ã€æ¦‚è¿°</a></li>\n<li><a href=\"#\">2ã€Producer å‘é€æ¶ˆæ¯</a><ul>\n<li><a href=\"#\">DefaultMQProducer#send(Message)</a></li>\n<li><a href=\"#\">DefaultMQProducerImpl#sendDefaultImpl()</a><ul>\n<li><a href=\"#\">DefaultMQProducerImpl#tryToFindTopicPublishInfo()</a></li>\n<li><a href=\"#\">MQFaultStrategy</a><ul>\n<li><a href=\"#\">MQFaultStrategy</a></li>\n<li><a href=\"#\">LatencyFaultTolerance</a></li>\n<li><a href=\"#\">LatencyFaultToleranceImpl</a></li>\n<li><a href=\"#\">FaultItem</a></li>\n</ul>\n</li>\n<li><a href=\"#\">DefaultMQProducerImpl#sendKernelImpl()</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">3ã€Broker æ¥æ”¶æ¶ˆæ¯</a><ul>\n<li><a href=\"#\">SendMessageProcessor#sendMessage</a><ul>\n<li><a href=\"#\">AbstractSendMessageProcessor#msgCheck</a></li>\n</ul>\n</li>\n<li><a href=\"#\">DefaultMessageStore#putMessage</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4ã€æŸç§ç»“å°¾</a></li>\n</ul>\n<h1 id=\"1ã€æ¦‚è¿°\"><a href=\"#1ã€æ¦‚è¿°\" class=\"headerlink\" title=\"1ã€æ¦‚è¿°\"></a>1ã€æ¦‚è¿°</h1><ol>\n<li><code>Producer</code> å‘é€æ¶ˆæ¯ã€‚ä¸»è¦æ˜¯<strong>åŒæ­¥</strong>å‘é€æ¶ˆæ¯æºç ï¼Œæ¶‰åŠåˆ° å¼‚æ­¥/Onewayå‘é€æ¶ˆæ¯ï¼Œäº‹åŠ¡æ¶ˆæ¯ä¼šè·³è¿‡ã€‚</li>\n<li><code>Broker</code> æ¥æ”¶æ¶ˆæ¯ã€‚(<em>å­˜å‚¨æ¶ˆæ¯åœ¨<a href=\"http://www.yunai.me/RocketMQ/message-store/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨ã€‹</a>è§£æ</em>)</li>\n</ol>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_18/01.png\" alt=\"Producerå‘é€æ¶ˆæ¯å…¨å±€é¡ºåºå›¾\"></p>\n</blockquote>\n<h1 id=\"2ã€Producer-å‘é€æ¶ˆæ¯\"><a href=\"#2ã€Producer-å‘é€æ¶ˆæ¯\" class=\"headerlink\" title=\"2ã€Producer å‘é€æ¶ˆæ¯\"></a>2ã€Producer å‘é€æ¶ˆæ¯</h1><blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_18/02.png\" alt=\"Producerå‘é€æ¶ˆæ¯é¡ºåºå›¾\"></p>\n</blockquote>\n<h2 id=\"DefaultMQProducer-send-Message\"><a href=\"#DefaultMQProducer-send-Message\" class=\"headerlink\" title=\"DefaultMQProducer#send(Message)\"></a>DefaultMQProducer#send(Message)</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> SendResult <span class=\"title\">send</span><span class=\"params\">(Message msg)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</div><div class=\"line\"><span class=\"number\">3</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.defaultMQProducerImpl.send(msg);</div><div class=\"line\"><span class=\"number\">4</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ï¼šå‘é€åŒæ­¥æ¶ˆæ¯ï¼Œ<code>DefaultMQProducer#send(Message)</code> å¯¹ <code>DefaultMQProducerImpl#send(Message)</code> è¿›è¡Œå°è£…ã€‚  </li>\n</ul>\n<h2 id=\"DefaultMQProducerImpl-sendDefaultImpl\"><a href=\"#DefaultMQProducerImpl-sendDefaultImpl\" class=\"headerlink\" title=\"DefaultMQProducerImpl#sendDefaultImpl()\"></a>DefaultMQProducerImpl#sendDefaultImpl()</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> SendResult <span class=\"title\">send</span><span class=\"params\">(Message msg)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">return</span> send(msg, <span class=\"keyword\">this</span>.defaultMQProducer.getSendMsgTimeout());</div><div class=\"line\">  <span class=\"number\">3</span>: &#125;</div><div class=\"line\">  <span class=\"number\">4</span>: </div><div class=\"line\">  <span class=\"number\">5</span>: <span class=\"function\"><span class=\"keyword\">public</span> SendResult <span class=\"title\">send</span><span class=\"params\">(Message msg, <span class=\"keyword\">long</span> timeout)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.sendDefaultImpl(msg, CommunicationMode.SYNC, <span class=\"keyword\">null</span>, timeout);</div><div class=\"line\">  <span class=\"number\">7</span>: &#125;</div><div class=\"line\">  <span class=\"number\">8</span>: </div><div class=\"line\">  <span class=\"number\">9</span>: <span class=\"function\"><span class=\"keyword\">private</span> SendResult <span class=\"title\">sendDefaultImpl</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">10</span>:     Message msg, //</div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode, //</div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">final</span> SendCallback sendCallback, //</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeout//</div><div class=\"line\"> <span class=\"number\">14</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"comment\">// æ ¡éªŒ Producer å¤„äºè¿è¡ŒçŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"keyword\">this</span>.makeSureStateOK();</div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"comment\">// æ ¡éªŒæ¶ˆæ¯æ ¼å¼</span></div><div class=\"line\"> <span class=\"number\">18</span>:     Validators.checkMessage(msg, <span class=\"keyword\">this</span>.defaultMQProducer);</div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> invokeID = random.nextLong(); <span class=\"comment\">// è°ƒç”¨ç¼–å·ï¼›ç”¨äºä¸‹é¢æ‰“å°æ—¥å¿—ï¼Œæ ‡è®°ä¸ºåŒä¸€æ¬¡å‘é€æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">21</span>:     <span class=\"keyword\">long</span> beginTimestampFirst = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"keyword\">long</span> beginTimestampPrev = beginTimestampFirst;</div><div class=\"line\"> <span class=\"number\">23</span>:     <span class=\"keyword\">long</span> endTimestamp = beginTimestampFirst;</div><div class=\"line\"> <span class=\"number\">24</span>:     <span class=\"comment\">// è·å– Topicè·¯ç”±ä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">25</span>:     TopicPublishInfo topicPublishInfo = <span class=\"keyword\">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class=\"line\"> <span class=\"number\">26</span>:     <span class=\"keyword\">if</span> (topicPublishInfo != <span class=\"keyword\">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class=\"line\"> <span class=\"number\">27</span>:         MessageQueue mq = <span class=\"keyword\">null</span>; <span class=\"comment\">// æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">28</span>:         Exception exception = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">29</span>:         SendResult sendResult = <span class=\"keyword\">null</span>; <span class=\"comment\">// æœ€åä¸€æ¬¡å‘é€ç»“æœ</span></div><div class=\"line\"> <span class=\"number\">30</span>:         <span class=\"keyword\">int</span> timesTotal = communicationMode == CommunicationMode.SYNC ? <span class=\"number\">1</span> + <span class=\"keyword\">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class=\"number\">1</span>; <span class=\"comment\">// åŒæ­¥å¤šæ¬¡è°ƒç”¨</span></div><div class=\"line\"> <span class=\"number\">31</span>:         <span class=\"keyword\">int</span> times = <span class=\"number\">0</span>; <span class=\"comment\">// ç¬¬å‡ æ¬¡å‘é€</span></div><div class=\"line\"> <span class=\"number\">32</span>:         String[] brokersSent = <span class=\"keyword\">new</span> String[timesTotal]; <span class=\"comment\">// å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå</span></div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"comment\">// å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">34</span>:         <span class=\"keyword\">for</span> (; times &lt; timesTotal; times++) &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:             String lastBrokerName = <span class=\"keyword\">null</span> == mq ? <span class=\"keyword\">null</span> : mq.getBrokerName();</div><div class=\"line\"> <span class=\"number\">36</span>:             MessageQueue tmpmq = <span class=\"keyword\">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName); <span class=\"comment\">// é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">37</span>:             <span class=\"keyword\">if</span> (tmpmq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:                 mq = tmpmq;</div><div class=\"line\"> <span class=\"number\">39</span>:                 brokersSent[times] = mq.getBrokerName();</div><div class=\"line\"> <span class=\"number\">40</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">41</span>:                     beginTimestampPrev = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"comment\">// è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</span></div><div class=\"line\"> <span class=\"number\">43</span>:                     sendResult = <span class=\"keyword\">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);</div><div class=\"line\"> <span class=\"number\">44</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">45</span>:                     <span class=\"comment\">// æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">46</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">47</span>:                     <span class=\"keyword\">switch</span> (communicationMode) &#123;</div><div class=\"line\"> <span class=\"number\">48</span>:                         <span class=\"keyword\">case</span> ASYNC:</div><div class=\"line\"> <span class=\"number\">49</span>:                             <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">50</span>:                         <span class=\"keyword\">case</span> ONEWAY:</div><div class=\"line\"> <span class=\"number\">51</span>:                             <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">52</span>:                         <span class=\"keyword\">case</span> SYNC:</div><div class=\"line\"> <span class=\"number\">53</span>:                             <span class=\"keyword\">if</span> (sendResult.getSendStatus() != SendStatus.SEND_OK) &#123;</div><div class=\"line\"> <span class=\"number\">54</span>:                                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) &#123; <span class=\"comment\">// åŒæ­¥å‘é€æˆåŠŸä½†å­˜å‚¨æœ‰é—®é¢˜æ—¶ &amp;&amp; é…ç½®å­˜å‚¨å¼‚å¸¸æ—¶é‡æ–°å‘é€å¼€å…³ æ—¶ï¼Œè¿›è¡Œé‡è¯•</span></div><div class=\"line\"> <span class=\"number\">55</span>:                                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">56</span>:                                 &#125;</div><div class=\"line\"> <span class=\"number\">57</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">58</span>:                             <span class=\"keyword\">return</span> sendResult;</div><div class=\"line\"> <span class=\"number\">59</span>:                         <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">60</span>:                             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">61</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">62</span>:                 &#125; <span class=\"keyword\">catch</span> (RemotingException e) &#123; <span class=\"comment\">// æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œæ›´æ–°ç»§ç»­å¾ªç¯</span></div><div class=\"line\"> <span class=\"number\">63</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">64</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">65</span>:                     log.warn(String.format(<span class=\"string\">\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\"</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class=\"line\"> <span class=\"number\">66</span>:                     log.warn(msg.toString());</div><div class=\"line\"> <span class=\"number\">67</span>:                     exception = e;</div><div class=\"line\"> <span class=\"number\">68</span>:                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:                 &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123; <span class=\"comment\">// æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œç»§ç»­å¾ªç¯</span></div><div class=\"line\"> <span class=\"number\">70</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">71</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">72</span>:                     log.warn(String.format(<span class=\"string\">\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\"</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class=\"line\"> <span class=\"number\">73</span>:                     log.warn(msg.toString());</div><div class=\"line\"> <span class=\"number\">74</span>:                     exception = e;</div><div class=\"line\"> <span class=\"number\">75</span>:                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">76</span>:                 &#125; <span class=\"keyword\">catch</span> (MQBrokerException e) &#123; <span class=\"comment\">// æ‰“å°å¼‚å¸¸ï¼Œæ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ï¼Œç»“æŸå¾ªç¯</span></div><div class=\"line\"> <span class=\"number\">77</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">78</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">79</span>:                     log.warn(String.format(<span class=\"string\">\"sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s\"</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class=\"line\"> <span class=\"number\">80</span>:                     log.warn(msg.toString());</div><div class=\"line\"> <span class=\"number\">81</span>:                     exception = e;</div><div class=\"line\"> <span class=\"number\">82</span>:                     <span class=\"keyword\">switch</span> (e.getResponseCode()) &#123;</div><div class=\"line\"> <span class=\"number\">83</span>:                         <span class=\"comment\">// å¦‚ä¸‹å¼‚å¸¸continueï¼Œè¿›è¡Œå‘é€æ¶ˆæ¯é‡è¯•</span></div><div class=\"line\"> <span class=\"number\">84</span>:                         <span class=\"keyword\">case</span> ResponseCode.TOPIC_NOT_EXIST:</div><div class=\"line\"> <span class=\"number\">85</span>:                         <span class=\"keyword\">case</span> ResponseCode.SERVICE_NOT_AVAILABLE:</div><div class=\"line\"> <span class=\"number\">86</span>:                         <span class=\"keyword\">case</span> ResponseCode.SYSTEM_ERROR:</div><div class=\"line\"> <span class=\"number\">87</span>:                         <span class=\"keyword\">case</span> ResponseCode.NO_PERMISSION:</div><div class=\"line\"> <span class=\"number\">88</span>:                         <span class=\"keyword\">case</span> ResponseCode.NO_BUYER_ID:</div><div class=\"line\"> <span class=\"number\">89</span>:                         <span class=\"keyword\">case</span> ResponseCode.NOT_IN_CURRENT_UNIT:</div><div class=\"line\"> <span class=\"number\">90</span>:                             <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">91</span>:                         <span class=\"comment\">// å¦‚æœæœ‰å‘é€ç»“æœï¼Œè¿›è¡Œè¿”å›ï¼Œå¦åˆ™ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›</span></div><div class=\"line\"> <span class=\"number\">92</span>:                         <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">93</span>:                             <span class=\"keyword\">if</span> (sendResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">94</span>:                                 <span class=\"keyword\">return</span> sendResult;</div><div class=\"line\"> <span class=\"number\">95</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">96</span>:                             <span class=\"keyword\">throw</span> e;</div><div class=\"line\"> <span class=\"number\">97</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">98</span>:                 &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">99</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">100</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">101</span>:                     log.warn(String.format(<span class=\"string\">\"sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s\"</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class=\"line\"><span class=\"number\">102</span>:                     log.warn(msg.toString());</div><div class=\"line\"><span class=\"number\">103</span>:                     <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">104</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">105</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">106</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">107</span>:             &#125;</div><div class=\"line\"><span class=\"number\">108</span>:         &#125;</div><div class=\"line\"><span class=\"number\">109</span>:         <span class=\"comment\">// è¿”å›å‘é€ç»“æœ</span></div><div class=\"line\"><span class=\"number\">110</span>:         <span class=\"keyword\">if</span> (sendResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">111</span>:             <span class=\"keyword\">return</span> sendResult;</div><div class=\"line\"><span class=\"number\">112</span>:         &#125;</div><div class=\"line\"><span class=\"number\">113</span>:         <span class=\"comment\">// æ ¹æ®ä¸åŒæƒ…å†µï¼ŒæŠ›å‡ºä¸åŒçš„å¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">114</span>:         String info = String.format(<span class=\"string\">\"Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s\"</span>, times, System.currentTimeMillis() - beginTimestampFirst,</div><div class=\"line\"><span class=\"number\">115</span>:                 msg.getTopic(), Arrays.toString(brokersSent)) + FAQUrl.suggestTodo(FAQUrl.SEND_MSG_FAILED);</div><div class=\"line\"><span class=\"number\">116</span>:         MQClientException mqClientException = <span class=\"keyword\">new</span> MQClientException(info, exception);</div><div class=\"line\"><span class=\"number\">117</span>:         <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> MQBrokerException) &#123;</div><div class=\"line\"><span class=\"number\">118</span>:             mqClientException.setResponseCode(((MQBrokerException) exception).getResponseCode());</div><div class=\"line\"><span class=\"number\">119</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> RemotingConnectException) &#123;</div><div class=\"line\"><span class=\"number\">120</span>:             mqClientException.setResponseCode(ClientErrorCode.CONNECT_BROKER_EXCEPTION);</div><div class=\"line\"><span class=\"number\">121</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> RemotingTimeoutException) &#123;</div><div class=\"line\"><span class=\"number\">122</span>:             mqClientException.setResponseCode(ClientErrorCode.ACCESS_BROKER_TIMEOUT);</div><div class=\"line\"><span class=\"number\">123</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> MQClientException) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:             mqClientException.setResponseCode(ClientErrorCode.BROKER_NOT_EXIST_EXCEPTION);</div><div class=\"line\"><span class=\"number\">125</span>:         &#125;</div><div class=\"line\"><span class=\"number\">126</span>:         <span class=\"keyword\">throw</span> mqClientException;</div><div class=\"line\"><span class=\"number\">127</span>:     &#125;</div><div class=\"line\"><span class=\"number\">128</span>:     <span class=\"comment\">// Namesrvæ‰¾ä¸åˆ°å¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">129</span>:     List&lt;String&gt; nsList = <span class=\"keyword\">this</span>.getmQClientFactory().getMQClientAPIImpl().getNameServerAddressList();</div><div class=\"line\"><span class=\"number\">130</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == nsList || nsList.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">131</span>:         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(</div><div class=\"line\"><span class=\"number\">132</span>:             <span class=\"string\">\"No name server address, please set it.\"</span> + FAQUrl.suggestTodo(FAQUrl.NAME_SERVER_ADDR_NOT_EXIST_URL), <span class=\"keyword\">null</span>).setResponseCode(ClientErrorCode.NO_NAME_SERVER_EXCEPTION);</div><div class=\"line\"><span class=\"number\">133</span>:     &#125;</div><div class=\"line\"><span class=\"number\">134</span>:     <span class=\"comment\">// æ¶ˆæ¯è·¯ç”±æ‰¾ä¸åˆ°å¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">135</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"No route info of this topic, \"</span> + msg.getTopic() + FAQUrl.suggestTodo(FAQUrl.NO_TOPIC_ROUTE_INFO),</div><div class=\"line\"><span class=\"number\">136</span>:         <span class=\"keyword\">null</span>).setResponseCode(ClientErrorCode.NOT_FOUND_TOPIC_EXCEPTION);</div><div class=\"line\"><span class=\"number\">137</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯ã€‚æ­¥éª¤ï¼šè·å–æ¶ˆæ¯è·¯ç”±ä¿¡æ¯ï¼Œé€‰æ‹©è¦å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ‰§è¡Œæ¶ˆæ¯å‘é€æ ¸å¿ƒæ–¹æ³•ï¼Œå¹¶å¯¹å‘é€ç»“æœè¿›è¡Œå°è£…è¿”å›ã€‚</li>\n<li>ç¬¬ 1  è‡³ 7 è¡Œï¼šå¯¹<code>sendsendDefaultImpl(...)</code>è¿›è¡Œå°è£…ã€‚</li>\n<li>ç¬¬ 20 è¡Œ ï¼š<code>invokeID</code>ä»…ä»…ç”¨äºæ‰“å°æ—¥å¿—ï¼Œæ— å®é™…çš„ä¸šåŠ¡ç”¨é€”ã€‚</li>\n<li>ç¬¬ 25 è¡Œ ï¼šè·å– Topicè·¯ç”±ä¿¡æ¯ï¼Œ è¯¦ç»†è§£æè§ï¼š<a href=\"#defaultmqproducerimpltrytofindtopicpublishinfo\">DefaultMQProducerImpl#tryToFindTopicPublishInfo()</a></li>\n<li>ç¬¬ 30 &amp; 34 è¡Œ ï¼šè®¡ç®—è°ƒç”¨å‘é€æ¶ˆæ¯åˆ°æˆåŠŸä¸ºæ­¢çš„æœ€å¤§æ¬¡æ•°ï¼Œå¹¶è¿›è¡Œå¾ªç¯ã€‚åŒæ­¥æˆ–å¼‚æ­¥å‘é€æ¶ˆæ¯ä¼šè°ƒç”¨å¤šæ¬¡ï¼Œé»˜è®¤é…ç½®ä¸º3æ¬¡ã€‚</li>\n<li>ç¬¬ 36 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#mqfaultstrategy\">MQFaultStrategy</a></li>\n<li>ç¬¬ 43 è¡Œ ï¼šè°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#defaultmqproducerimplsendkernelimpl\">DefaultMQProducerImpl#sendKernelImpl()</a></li>\n<li>ç¬¬ 46 è¡Œ ï¼šæ›´æ–°<code>Broker</code>å¯ç”¨æ€§ä¿¡æ¯ã€‚åœ¨é€‰æ‹©å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‚è€ƒ<code>Broker</code>å‘é€æ¶ˆæ¯çš„å»¶è¿Ÿï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#mqfaultstrategy\">MQFaultStrategy</a></li>\n<li>ç¬¬ 62 è‡³ 68 è¡Œï¼šå½“æŠ›å‡º<code>RemotingException</code>æ—¶ï¼Œå¦‚æœè¿›è¡Œæ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•ï¼Œåˆ™<strong>å¯èƒ½å¯¼è‡´æ¶ˆæ¯å‘é€é‡å¤</strong>ã€‚ä¾‹å¦‚ï¼Œå‘é€æ¶ˆæ¯è¶…æ—¶(<code>RemotingTimeoutException</code>)ï¼Œå®é™…<code>Broker</code>æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯å¹¶å¤„ç†æˆåŠŸã€‚å› æ­¤ï¼Œ<code>Consumer</code>åœ¨æ¶ˆè´¹æ—¶ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§ã€‚</li>\n</ul>\n<h3 id=\"DefaultMQProducerImpl-tryToFindTopicPublishInfo\"><a href=\"#DefaultMQProducerImpl-tryToFindTopicPublishInfo\" class=\"headerlink\" title=\"DefaultMQProducerImpl#tryToFindTopicPublishInfo()\"></a>DefaultMQProducerImpl#tryToFindTopicPublishInfo()</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> TopicPublishInfo <span class=\"title\">tryToFindTopicPublishInfo</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">// ç¼“å­˜ä¸­è·å– Topicå‘å¸ƒä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">3</span>:     TopicPublishInfo topicPublishInfo = <span class=\"keyword\">this</span>.topicPublishInfoTable.get(topic);</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"comment\">// å½“æ— å¯ç”¨çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶ï¼Œä»Namesrvè·å–ä¸€æ¬¡</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicPublishInfo || !topicPublishInfo.ok()) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">this</span>.topicPublishInfoTable.putIfAbsent(topic, <span class=\"keyword\">new</span> TopicPublishInfo());</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);</div><div class=\"line\"> <span class=\"number\">8</span>:         topicPublishInfo = <span class=\"keyword\">this</span>.topicPublishInfoTable.get(topic);</div><div class=\"line\"> <span class=\"number\">9</span>:     &#125;</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"comment\">// è‹¥è·å–çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶å€™å¯ç”¨ï¼Œåˆ™è¿”å›</span></div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">if</span> (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">return</span> topicPublishInfo;</div><div class=\"line\"><span class=\"number\">13</span>:     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// ä½¿ç”¨ &#123;@link DefaultMQProducer#createTopicKey&#125; å¯¹åº”çš„ Topicå‘å¸ƒä¿¡æ¯ã€‚ç”¨äº Topicå‘å¸ƒä¿¡æ¯ä¸å­˜åœ¨ &amp;&amp; Brokeræ”¯æŒè‡ªåŠ¨åˆ›å»ºTopic</span></div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, <span class=\"keyword\">true</span>, <span class=\"keyword\">this</span>.defaultMQProducer);</div><div class=\"line\"><span class=\"number\">15</span>:         topicPublishInfo = <span class=\"keyword\">this</span>.topicPublishInfoTable.get(topic);</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">return</span> topicPublishInfo;</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šè·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚ä¼˜å…ˆä»ç¼“å­˜<code>topicPublishInfoTable</code>ï¼Œå…¶æ¬¡ä»<code>Namesrv</code>ä¸­è·å¾—ã€‚</li>\n<li>ç¬¬ 3 è¡Œ ï¼šä»ç¼“å­˜<code>topicPublishInfoTable</code>ä¸­è·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚</li>\n<li>ç¬¬ 5 è‡³ 9 è¡Œ ï¼šä» <code>Namesrv</code> ä¸­è·å¾— Topicå‘å¸ƒä¿¡æ¯ã€‚</li>\n<li>ç¬¬ 13 è‡³ 17 è¡Œ ï¼šå½“ä» <code>Namesrv</code> æ— æ³•è·å–æ—¶ï¼Œä½¿ç”¨ <code>{@link DefaultMQProducer#createTopicKey}</code> å¯¹åº”çš„ Topicå‘å¸ƒä¿¡æ¯ã€‚ç›®çš„æ˜¯å½“ <code>Broker</code> å¼€å¯è‡ªåŠ¨åˆ›å»º Topicå¼€å…³æ—¶ï¼Œ<code>Broker</code> æ¥æ”¶åˆ°æ¶ˆæ¯åè‡ªåŠ¨åˆ›å»ºTopicï¼Œè¯¦ç»†è§£æè§<a href=\"http://www.yunai.me/RocketMQ/topic/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹</a>ã€‚</li>\n</ul>\n<h3 id=\"MQFaultStrategy\"><a href=\"#MQFaultStrategy\" class=\"headerlink\" title=\"MQFaultStrategy\"></a>MQFaultStrategy</h3><blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_18/03.png\" alt=\"Latencyç±»å›¾\"></p>\n</blockquote>\n<h4 id=\"MQFaultStrategy-1\"><a href=\"#MQFaultStrategy-1\" class=\"headerlink\" title=\"MQFaultStrategy\"></a>MQFaultStrategy</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MQFaultStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> Logger log = ClientLogger.getLog();</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 5:      * å»¶è¿Ÿæ•…éšœå®¹é”™ï¼Œç»´æŠ¤æ¯ä¸ªBrokerçš„å‘é€æ¶ˆæ¯çš„å»¶è¿Ÿ</div><div class=\"line\"> 6:      * keyï¼šbrokerName</div><div class=\"line\"> 7:      */</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LatencyFaultTolerance&lt;String&gt; latencyFaultTolerance = <span class=\"keyword\">new</span> LatencyFaultToleranceImpl();</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">10:      * å‘é€æ¶ˆæ¯å»¶è¿Ÿå®¹é”™å¼€å…³</div><div class=\"line\">11:      */</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> sendLatencyFaultEnable = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">14:      * å»¶è¿Ÿçº§åˆ«æ•°ç»„</div><div class=\"line\">15:      */</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span>[] latencyMax = &#123;<span class=\"number\">50L</span>, <span class=\"number\">100L</span>, <span class=\"number\">550L</span>, <span class=\"number\">1000L</span>, <span class=\"number\">2000L</span>, <span class=\"number\">3000L</span>, <span class=\"number\">15000L</span>&#125;;</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">18:      * ä¸å¯ç”¨æ—¶é•¿æ•°ç»„</div><div class=\"line\">19:      */</div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span>[] notAvailableDuration = &#123;<span class=\"number\">0L</span>, <span class=\"number\">0L</span>, <span class=\"number\">30000L</span>, <span class=\"number\">60000L</span>, <span class=\"number\">120000L</span>, <span class=\"number\">180000L</span>, <span class=\"number\">600000L</span>&#125;;</div><div class=\"line\"><span class=\"number\">21</span>: </div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">23:      * æ ¹æ® Topicå‘å¸ƒä¿¡æ¯ é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">24:      *</div><div class=\"line\">25:      * <span class=\"doctag\">@param</span> tpInfo Topicå‘å¸ƒä¿¡æ¯</div><div class=\"line\">26:      * <span class=\"doctag\">@param</span> lastBrokerName brokerName</div><div class=\"line\">27:      * <span class=\"doctag\">@return</span> æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">28:      */</div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"function\"><span class=\"keyword\">public</span> MessageQueue <span class=\"title\">selectOneMessageQueue</span><span class=\"params\">(<span class=\"keyword\">final</span> TopicPublishInfo tpInfo, <span class=\"keyword\">final</span> String lastBrokerName)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.sendLatencyFaultEnable) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"comment\">// è·å– brokerName=lastBrokerName &amp;&amp; å¯ç”¨çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"keyword\">int</span> index = tpInfo.getSendWhichQueue().getAndIncrement();</div><div class=\"line\"><span class=\"number\">34</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; tpInfo.getMessageQueueList().size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:                     <span class=\"keyword\">int</span> pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();</div><div class=\"line\"><span class=\"number\">36</span>:                     <span class=\"keyword\">if</span> (pos &lt; <span class=\"number\">0</span>)</div><div class=\"line\"><span class=\"number\">37</span>:                         pos = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">38</span>:                     MessageQueue mq = tpInfo.getMessageQueueList().get(pos);</div><div class=\"line\"><span class=\"number\">39</span>:                     <span class=\"keyword\">if</span> (latencyFaultTolerance.isAvailable(mq.getBrokerName())) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == lastBrokerName || mq.getBrokerName().equals(lastBrokerName))</div><div class=\"line\"><span class=\"number\">41</span>:                             <span class=\"keyword\">return</span> mq;</div><div class=\"line\"><span class=\"number\">42</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">43</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"comment\">// é€‰æ‹©ä¸€ä¸ªç›¸å¯¹å¥½çš„brokerï¼Œå¹¶è·å¾—å…¶å¯¹åº”çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘è¯¥é˜Ÿåˆ—çš„å¯ç”¨æ€§</span></div><div class=\"line\"><span class=\"number\">45</span>:                 <span class=\"keyword\">final</span> String notBestBroker = latencyFaultTolerance.pickOneAtLeast();</div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">int</span> writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);</div><div class=\"line\"><span class=\"number\">47</span>:                 <span class=\"keyword\">if</span> (writeQueueNums &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">48</span>:                     <span class=\"keyword\">final</span> MessageQueue mq = tpInfo.selectOneMessageQueue();</div><div class=\"line\"><span class=\"number\">49</span>:                     <span class=\"keyword\">if</span> (notBestBroker != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">50</span>:                         mq.setBrokerName(notBestBroker);</div><div class=\"line\"><span class=\"number\">51</span>:                         mq.setQueueId(tpInfo.getSendWhichQueue().getAndIncrement() % writeQueueNums);</div><div class=\"line\"><span class=\"number\">52</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">53</span>:                     <span class=\"keyword\">return</span> mq;</div><div class=\"line\"><span class=\"number\">54</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">55</span>:                     latencyFaultTolerance.remove(notBestBroker);</div><div class=\"line\"><span class=\"number\">56</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">57</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">58</span>:                 log.error(<span class=\"string\">\"Error occurred when selecting message queue\"</span>, e);</div><div class=\"line\"><span class=\"number\">59</span>:             &#125;</div><div class=\"line\"><span class=\"number\">60</span>:             <span class=\"comment\">// é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘é˜Ÿåˆ—çš„å¯ç”¨æ€§</span></div><div class=\"line\"><span class=\"number\">61</span>:             <span class=\"keyword\">return</span> tpInfo.selectOneMessageQueue();</div><div class=\"line\"><span class=\"number\">62</span>:         &#125;</div><div class=\"line\"><span class=\"number\">63</span>:         <span class=\"comment\">// è·å¾— lastBrokerName å¯¹åº”çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è€ƒè™‘è¯¥é˜Ÿåˆ—çš„å¯ç”¨æ€§</span></div><div class=\"line\"><span class=\"number\">64</span>:         <span class=\"keyword\">return</span> tpInfo.selectOneMessageQueue(lastBrokerName);</div><div class=\"line\"><span class=\"number\">65</span>:     &#125;</div><div class=\"line\"><span class=\"number\">66</span>: </div><div class=\"line\"><span class=\"number\">67</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">68:      * æ›´æ–°å»¶è¿Ÿå®¹é”™ä¿¡æ¯</div><div class=\"line\">69:      *</div><div class=\"line\">70:      * <span class=\"doctag\">@param</span> brokerName brokerName</div><div class=\"line\">71:      * <span class=\"doctag\">@param</span> currentLatency å»¶è¿Ÿ</div><div class=\"line\">72:      * <span class=\"doctag\">@param</span> isolation æ˜¯å¦éš”ç¦»ã€‚å½“å¼€å¯éš”ç¦»æ—¶ï¼Œé»˜è®¤å»¶è¿Ÿä¸º30000ã€‚ç›®å‰ä¸»è¦ç”¨äºå‘é€æ¶ˆæ¯å¼‚å¸¸æ—¶</div><div class=\"line\">73:      */</div><div class=\"line\"><span class=\"number\">74</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updateFaultItem</span><span class=\"params\">(<span class=\"keyword\">final</span> String brokerName, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentLatency, <span class=\"keyword\">boolean</span> isolation)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">75</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.sendLatencyFaultEnable) &#123;</div><div class=\"line\"><span class=\"number\">76</span>:             <span class=\"keyword\">long</span> duration = computeNotAvailableDuration(isolation ? <span class=\"number\">30000</span> : currentLatency);</div><div class=\"line\"><span class=\"number\">77</span>:             <span class=\"keyword\">this</span>.latencyFaultTolerance.updateFaultItem(brokerName, currentLatency, duration);</div><div class=\"line\"><span class=\"number\">78</span>:         &#125;</div><div class=\"line\"><span class=\"number\">79</span>:     &#125;</div><div class=\"line\"><span class=\"number\">80</span>: </div><div class=\"line\"><span class=\"number\">81</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">82:      * è®¡ç®—å»¶è¿Ÿå¯¹åº”çš„ä¸å¯ç”¨æ—¶é—´</div><div class=\"line\">83:      *</div><div class=\"line\">84:      * <span class=\"doctag\">@param</span> currentLatency å»¶è¿Ÿ</div><div class=\"line\">85:      * <span class=\"doctag\">@return</span> ä¸å¯ç”¨æ—¶é—´</div><div class=\"line\">86:      */</div><div class=\"line\"><span class=\"number\">87</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">computeNotAvailableDuration</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentLatency)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">88</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = latencyMax.length - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</div><div class=\"line\"><span class=\"number\">89</span>:             <span class=\"keyword\">if</span> (currentLatency &gt;= latencyMax[i])</div><div class=\"line\"><span class=\"number\">90</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.notAvailableDuration[i];</div><div class=\"line\"><span class=\"number\">91</span>:         &#125;</div><div class=\"line\"><span class=\"number\">92</span>:         <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">93</span>:     &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼š<code>Producer</code>æ¶ˆæ¯å‘é€å®¹é”™ç­–ç•¥ã€‚é»˜è®¤æƒ…å†µä¸‹å®¹é”™ç­–ç•¥å…³é—­ï¼Œå³<code>sendLatencyFaultEnable=false</code>ã€‚</li>\n<li>ç¬¬ 30 è‡³ 62 è¡Œ ï¼šå®¹é”™ç­–ç•¥é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ã€‚ä¼˜å…ˆè·å–å¯ç”¨é˜Ÿåˆ—ï¼Œå…¶æ¬¡é€‰æ‹©ä¸€ä¸ªbrokerè·å–é˜Ÿåˆ—ï¼Œæœ€å·®è¿”å›ä»»æ„brokerçš„ä¸€ä¸ªé˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 64 è¡Œ ï¼šæœªå¼€å¯å®¹é”™ç­–ç•¥é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ã€‚</li>\n<li><p>ç¬¬ 74 è‡³ 79 è¡Œ ï¼šæ›´æ–°å»¶è¿Ÿå®¹é”™ä¿¡æ¯ã€‚å½“ <code>Producer</code> å‘é€æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œåˆ™é€»è¾‘è®¤ä¸ºNç§’å†…ä¸å¯ç”¨ã€‚æŒ‰ç…§<code>latencyMax</code>ï¼Œ<code>notAvailableDuration</code>çš„é…ç½®ï¼Œå¯¹åº”å¦‚ä¸‹ï¼š</p>\n<p>  | Producerå‘é€æ¶ˆæ¯æ¶ˆè€—æ—¶é•¿ | Brokerä¸å¯ç”¨æ—¶é•¿ |<br>  | â€” | â€” |<br>  | &gt;= 15000 ms | 600 <em> 1000 ms  |<br>  | &gt;= 3000 ms | 180 </em> 1000 ms  |<br>  | &gt;= 2000 ms | 120 <em> 1000 ms  |<br>  | &gt;= 1000 ms | 60 </em> 1000 ms  |<br>  | &gt;= 550 ms | 30 * 1000 ms |<br>  | &gt;= 100 ms | 0 ms |<br>  | &gt;= 50 ms | 0 ms |</p>\n</li>\n</ul>\n<h4 id=\"LatencyFaultTolerance\"><a href=\"#LatencyFaultTolerance\" class=\"headerlink\" title=\"LatencyFaultTolerance\"></a>LatencyFaultTolerance</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">LatencyFaultTolerance</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * æ›´æ–°å¯¹åº”çš„å»¶è¿Ÿå’Œä¸å¯ç”¨æ—¶é•¿</div><div class=\"line\"> 5:      *</div><div class=\"line\"> 6:      * <span class=\"doctag\">@param</span> name å¯¹è±¡</div><div class=\"line\"> 7:      * <span class=\"doctag\">@param</span> currentLatency å»¶è¿Ÿ</div><div class=\"line\"> 8:      * <span class=\"doctag\">@param</span> notAvailableDuration ä¸å¯ç”¨æ—¶é•¿</div><div class=\"line\"> 9:      */</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">updateFaultItem</span><span class=\"params\">(<span class=\"keyword\">final</span> T name, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentLatency, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> notAvailableDuration)</span></span>;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">13:      * å¯¹è±¡æ˜¯å¦å¯ç”¨</div><div class=\"line\">14:      *</div><div class=\"line\">15:      * <span class=\"doctag\">@param</span> name å¯¹è±¡</div><div class=\"line\">16:      * <span class=\"doctag\">@return</span> æ˜¯å¦å¯ç”¨</div><div class=\"line\">17:      */</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isAvailable</span><span class=\"params\">(<span class=\"keyword\">final</span> T name)</span></span>;</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">21:      * ç§»é™¤å¯¹è±¡</div><div class=\"line\">22:      *</div><div class=\"line\">23:      * <span class=\"doctag\">@param</span> name å¯¹è±¡</div><div class=\"line\">24:      */</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">remove</span><span class=\"params\">(<span class=\"keyword\">final</span> T name)</span></span>;</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">28:      * è·å–ä¸€ä¸ªå¯¹è±¡</div><div class=\"line\">29:      *</div><div class=\"line\">30:      * <span class=\"doctag\">@return</span> å¯¹è±¡</div><div class=\"line\">31:      */</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"function\">T <span class=\"title\">pickOneAtLeast</span><span class=\"params\">()</span></span>;</div><div class=\"line\"><span class=\"number\">33</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå»¶è¿Ÿæ•…éšœå®¹é”™æ¥å£</li>\n</ul>\n<h4 id=\"LatencyFaultToleranceImpl\"><a href=\"#LatencyFaultToleranceImpl\" class=\"headerlink\" title=\"LatencyFaultToleranceImpl\"></a>LatencyFaultToleranceImpl</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LatencyFaultToleranceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title\">LatencyFaultTolerance</span>&lt;<span class=\"title\">String</span>&gt; </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * å¯¹è±¡æ•…éšœä¿¡æ¯Table</div><div class=\"line\"> 5:      */</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConcurrentHashMap&lt;String, FaultItem&gt; faultItemTable = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">16</span>);</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 8:      * å¯¹è±¡é€‰æ‹©Index</div><div class=\"line\"> 9:      * <span class=\"doctag\">@see</span> #pickOneAtLeast()</div><div class=\"line\">10:      */</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadLocalIndex whichItemWorst = <span class=\"keyword\">new</span> ThreadLocalIndex();</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updateFaultItem</span><span class=\"params\">(<span class=\"keyword\">final</span> String name, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentLatency, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> notAvailableDuration)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">15</span>:         FaultItem old = <span class=\"keyword\">this</span>.faultItemTable.get(name);</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == old) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"comment\">// åˆ›å»ºå¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">final</span> FaultItem faultItem = <span class=\"keyword\">new</span> FaultItem(name);</div><div class=\"line\"><span class=\"number\">19</span>:             faultItem.setCurrentLatency(currentLatency);</div><div class=\"line\"><span class=\"number\">20</span>:             faultItem.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"comment\">// æ›´æ–°å¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">22</span>:             old = <span class=\"keyword\">this</span>.faultItemTable.putIfAbsent(name, faultItem);</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">if</span> (old != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 old.setCurrentLatency(currentLatency);</div><div class=\"line\"><span class=\"number\">25</span>:                 old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class=\"line\"><span class=\"number\">26</span>:             &#125;</div><div class=\"line\"><span class=\"number\">27</span>:         &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æ›´æ–°å¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">28</span>:             old.setCurrentLatency(currentLatency);</div><div class=\"line\"><span class=\"number\">29</span>:             old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class=\"line\"><span class=\"number\">30</span>:         &#125;</div><div class=\"line\"><span class=\"number\">31</span>:     &#125;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAvailable</span><span class=\"params\">(<span class=\"keyword\">final</span> String name)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">final</span> FaultItem faultItem = <span class=\"keyword\">this</span>.faultItemTable.get(name);</div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">if</span> (faultItem != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">return</span> faultItem.isAvailable();</div><div class=\"line\"><span class=\"number\">38</span>:         &#125;</div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">remove</span><span class=\"params\">(<span class=\"keyword\">final</span> String name)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"keyword\">this</span>.faultItemTable.remove(name);</div><div class=\"line\"><span class=\"number\">45</span>:     &#125;</div><div class=\"line\"><span class=\"number\">46</span>: </div><div class=\"line\"><span class=\"number\">47</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">48:      * é€‰æ‹©ä¸€ä¸ªç›¸å¯¹ä¼˜ç§€çš„å¯¹è±¡</div><div class=\"line\">49:      *</div><div class=\"line\">50:      * <span class=\"doctag\">@return</span> å¯¹è±¡</div><div class=\"line\">51:      */</div><div class=\"line\"><span class=\"number\">52</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">53</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">pickOneAtLeast</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">54</span>:         <span class=\"comment\">// åˆ›å»ºæ•°ç»„</span></div><div class=\"line\"><span class=\"number\">55</span>:         <span class=\"keyword\">final</span> Enumeration&lt;FaultItem&gt; elements = <span class=\"keyword\">this</span>.faultItemTable.elements();</div><div class=\"line\"><span class=\"number\">56</span>:         List&lt;FaultItem&gt; tmpList = <span class=\"keyword\">new</span> LinkedList&lt;&gt;();</div><div class=\"line\"><span class=\"number\">57</span>:         <span class=\"keyword\">while</span> (elements.hasMoreElements()) &#123;</div><div class=\"line\"><span class=\"number\">58</span>:             <span class=\"keyword\">final</span> FaultItem faultItem = elements.nextElement();</div><div class=\"line\"><span class=\"number\">59</span>:             tmpList.add(faultItem);</div><div class=\"line\"><span class=\"number\">60</span>:         &#125;</div><div class=\"line\"><span class=\"number\">61</span>:         <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">if</span> (!tmpList.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">63</span>:             <span class=\"comment\">// æ‰“ä¹± + æ’åºã€‚TODO ç–‘é—®ï¼šåº”è¯¥åªèƒ½äºŒé€‰ä¸€ã€‚çŒœæµ‹Collections.shuffle(tmpList)å»æ‰ã€‚</span></div><div class=\"line\"><span class=\"number\">64</span>:             Collections.shuffle(tmpList);</div><div class=\"line\"><span class=\"number\">65</span>:             Collections.sort(tmpList);</div><div class=\"line\"><span class=\"number\">66</span>:             <span class=\"comment\">// é€‰æ‹©é¡ºåºåœ¨å‰ä¸€åŠçš„å¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">67</span>:             <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> half = tmpList.size() / <span class=\"number\">2</span>;</div><div class=\"line\"><span class=\"number\">68</span>:             <span class=\"keyword\">if</span> (half &lt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">69</span>:                 <span class=\"keyword\">return</span> tmpList.get(<span class=\"number\">0</span>).getName();</div><div class=\"line\"><span class=\"number\">70</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">71</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> i = <span class=\"keyword\">this</span>.whichItemWorst.getAndIncrement() % half;</div><div class=\"line\"><span class=\"number\">72</span>:                 <span class=\"keyword\">return</span> tmpList.get(i).getName();</div><div class=\"line\"><span class=\"number\">73</span>:             &#125;</div><div class=\"line\"><span class=\"number\">74</span>:         &#125;</div><div class=\"line\"><span class=\"number\">75</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">76</span>:     &#125;</div><div class=\"line\"><span class=\"number\">77</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå»¶è¿Ÿæ•…éšœå®¹é”™å®ç°ã€‚ç»´æŠ¤æ¯ä¸ªå¯¹è±¡çš„ä¿¡æ¯ã€‚</li>\n</ul>\n<h4 id=\"FaultItem\"><a href=\"#FaultItem\" class=\"headerlink\" title=\"FaultItem\"></a>FaultItem</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FaultItem</span> <span class=\"keyword\">implements</span> <span class=\"title\">Comparable</span>&lt;<span class=\"title\">FaultItem</span>&gt; </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 3:      * å¯¹è±¡å</div><div class=\"line\"> 4:      */</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String name;</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 7:      * å»¶è¿Ÿ</div><div class=\"line\"> 8:      */</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> currentLatency;</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">11:      * å¼€å§‹å¯ç”¨æ—¶é—´</div><div class=\"line\">12:      */</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> startTimestamp;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">FaultItem</span><span class=\"params\">(<span class=\"keyword\">final</span> String name)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">this</span>.name = name;</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: </div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">20:      * æ¯”è¾ƒå¯¹è±¡</div><div class=\"line\">21:      * å¯ç”¨æ€§ &gt; å»¶è¿Ÿ &gt; å¼€å§‹å¯ç”¨æ—¶é—´</div><div class=\"line\">22:      *</div><div class=\"line\">23:      * <span class=\"doctag\">@param</span> other other</div><div class=\"line\">24:      * <span class=\"doctag\">@return</span> å‡åº</div><div class=\"line\">25:      */</div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">compareTo</span><span class=\"params\">(<span class=\"keyword\">final</span> FaultItem other)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isAvailable() != other.isAvailable()) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isAvailable())</div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">if</span> (other.isAvailable())</div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">34</span>:         &#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.currentLatency &lt; other.currentLatency)</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.currentLatency &gt; other.currentLatency) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:             <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">40</span>:         &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.startTimestamp &lt; other.startTimestamp)</div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.startTimestamp &gt; other.startTimestamp) &#123;</div><div class=\"line\"><span class=\"number\">45</span>:             <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">46</span>:         &#125;</div><div class=\"line\"><span class=\"number\">47</span>: </div><div class=\"line\"><span class=\"number\">48</span>:         <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">49</span>:     &#125;</div><div class=\"line\"><span class=\"number\">50</span>: </div><div class=\"line\"><span class=\"number\">51</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">52:      * æ˜¯å¦å¯ç”¨ï¼šå½“å¼€å§‹å¯ç”¨æ—¶é—´å¤§äºå½“å‰æ—¶é—´</div><div class=\"line\">53:      *</div><div class=\"line\">54:      * <span class=\"doctag\">@return</span> æ˜¯å¦å¯ç”¨</div><div class=\"line\">55:      */</div><div class=\"line\"><span class=\"number\">56</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAvailable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">57</span>:         <span class=\"keyword\">return</span> (System.currentTimeMillis() - startTimestamp) &gt;= <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">58</span>:     &#125;</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">61</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">int</span> result = getName() != <span class=\"keyword\">null</span> ? getName().hashCode() : <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">63</span>:         result = <span class=\"number\">31</span> * result + (<span class=\"keyword\">int</span>) (getCurrentLatency() ^ (getCurrentLatency() &gt;&gt;&gt; <span class=\"number\">32</span>));</div><div class=\"line\"><span class=\"number\">64</span>:         result = <span class=\"number\">31</span> * result + (<span class=\"keyword\">int</span>) (getStartTimestamp() ^ (getStartTimestamp() &gt;&gt;&gt; <span class=\"number\">32</span>));</div><div class=\"line\"><span class=\"number\">65</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">66</span>:     &#125;</div><div class=\"line\"><span class=\"number\">67</span>: </div><div class=\"line\"><span class=\"number\">68</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">69</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(<span class=\"keyword\">final</span> Object o)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">70</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span> == o)</div><div class=\"line\"><span class=\"number\">71</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">72</span>:         <span class=\"keyword\">if</span> (!(o <span class=\"keyword\">instanceof</span> FaultItem))</div><div class=\"line\"><span class=\"number\">73</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">74</span>: </div><div class=\"line\"><span class=\"number\">75</span>:         <span class=\"keyword\">final</span> FaultItem faultItem = (FaultItem) o;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:         <span class=\"keyword\">if</span> (getCurrentLatency() != faultItem.getCurrentLatency())</div><div class=\"line\"><span class=\"number\">78</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">79</span>:         <span class=\"keyword\">if</span> (getStartTimestamp() != faultItem.getStartTimestamp())</div><div class=\"line\"><span class=\"number\">80</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">81</span>:         <span class=\"keyword\">return</span> getName() != <span class=\"keyword\">null</span> ? getName().equals(faultItem.getName()) : faultItem.getName() == <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">82</span>: </div><div class=\"line\"><span class=\"number\">83</span>:     &#125;</div><div class=\"line\"><span class=\"number\">84</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå¯¹è±¡æ•…éšœä¿¡æ¯ã€‚ç»´æŠ¤å¯¹è±¡çš„åå­—ã€å»¶è¿Ÿã€å¼€å§‹å¯ç”¨çš„æ—¶é—´ã€‚</li>\n</ul>\n<h3 id=\"DefaultMQProducerImpl-sendKernelImpl\"><a href=\"#DefaultMQProducerImpl-sendKernelImpl\" class=\"headerlink\" title=\"DefaultMQProducerImpl#sendKernelImpl()\"></a>DefaultMQProducerImpl#sendKernelImpl()</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> SendResult <span class=\"title\">sendKernelImpl</span><span class=\"params\">(<span class=\"keyword\">final</span> Message msg, //</span></span></div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">final</span> MessageQueue mq, //</div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode, //</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> SendCallback sendCallback, //</div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> TopicPublishInfo topicPublishInfo, //</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeout) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"comment\">// è·å– brokeråœ°å€</span></div><div class=\"line\">  <span class=\"number\">8</span>:     String brokerAddr = <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == brokerAddr) &#123;</div><div class=\"line\"> <span class=\"number\">10</span>:         tryToFindTopicPublishInfo(mq.getTopic());</div><div class=\"line\"> <span class=\"number\">11</span>:         brokerAddr = <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</div><div class=\"line\"> <span class=\"number\">12</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">14</span>:     SendMessageContext context = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (brokerAddr != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:         <span class=\"comment\">// æ˜¯å¦ä½¿ç”¨broker vipé€šé“ã€‚brokerä¼šå¼€å¯ä¸¤ä¸ªç«¯å£å¯¹å¤–æœåŠ¡ã€‚</span></div><div class=\"line\"> <span class=\"number\">17</span>:         brokerAddr = MixAll.brokerVIPChannel(<span class=\"keyword\">this</span>.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr);</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">byte</span>[] prevBody = msg.getBody(); <span class=\"comment\">// è®°å½•æ¶ˆæ¯å†…å®¹ã€‚ä¸‹é¢é€»è¾‘å¯èƒ½æ”¹å˜æ¶ˆæ¯å†…å®¹ï¼Œä¾‹å¦‚æ¶ˆæ¯å‹ç¼©ã€‚</span></div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"comment\">// è®¾ç½®å”¯ä¸€ç¼–å·</span></div><div class=\"line\"> <span class=\"number\">21</span>:             MessageClientIDSetter.setUniqID(msg);</div><div class=\"line\"> <span class=\"number\">22</span>:             <span class=\"comment\">// æ¶ˆæ¯å‹ç¼©</span></div><div class=\"line\"> <span class=\"number\">23</span>:             <span class=\"keyword\">int</span> sysFlag = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.tryToCompressMessage(msg)) &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:                 sysFlag |= MessageSysFlag.COMPRESSED_FLAG;</div><div class=\"line\"> <span class=\"number\">26</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"comment\">// äº‹åŠ¡</span></div><div class=\"line\"> <span class=\"number\">28</span>:             <span class=\"keyword\">final</span> String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class=\"line\"> <span class=\"number\">29</span>:             <span class=\"keyword\">if</span> (tranMsg != <span class=\"keyword\">null</span> &amp;&amp; Boolean.parseBoolean(tranMsg)) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:                 sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;</div><div class=\"line\"> <span class=\"number\">31</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">32</span>:             <span class=\"comment\">// hookï¼šå‘é€æ¶ˆæ¯æ ¡éªŒ</span></div><div class=\"line\"> <span class=\"number\">33</span>:             <span class=\"keyword\">if</span> (hasCheckForbiddenHook()) &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:                 CheckForbiddenContext checkForbiddenContext = <span class=\"keyword\">new</span> CheckForbiddenContext();</div><div class=\"line\"> <span class=\"number\">35</span>:                 checkForbiddenContext.setNameSrvAddr(<span class=\"keyword\">this</span>.defaultMQProducer.getNamesrvAddr());</div><div class=\"line\"> <span class=\"number\">36</span>:                 checkForbiddenContext.setGroup(<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"> <span class=\"number\">37</span>:                 checkForbiddenContext.setCommunicationMode(communicationMode);</div><div class=\"line\"> <span class=\"number\">38</span>:                 checkForbiddenContext.setBrokerAddr(brokerAddr);</div><div class=\"line\"> <span class=\"number\">39</span>:                 checkForbiddenContext.setMessage(msg);</div><div class=\"line\"> <span class=\"number\">40</span>:                 checkForbiddenContext.setMq(mq);</div><div class=\"line\"> <span class=\"number\">41</span>:                 checkForbiddenContext.setUnitMode(<span class=\"keyword\">this</span>.isUnitMode());</div><div class=\"line\"> <span class=\"number\">42</span>:                 <span class=\"keyword\">this</span>.executeCheckForbiddenHook(checkForbiddenContext);</div><div class=\"line\"> <span class=\"number\">43</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">44</span>:             <span class=\"comment\">// hookï¼šå‘é€æ¶ˆæ¯å‰é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">45</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"> <span class=\"number\">46</span>:                 context = <span class=\"keyword\">new</span> SendMessageContext();</div><div class=\"line\"> <span class=\"number\">47</span>:                 context.setProducer(<span class=\"keyword\">this</span>);</div><div class=\"line\"> <span class=\"number\">48</span>:                 context.setProducerGroup(<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"> <span class=\"number\">49</span>:                 context.setCommunicationMode(communicationMode);</div><div class=\"line\"> <span class=\"number\">50</span>:                 context.setBornHost(<span class=\"keyword\">this</span>.defaultMQProducer.getClientIP());</div><div class=\"line\"> <span class=\"number\">51</span>:                 context.setBrokerAddr(brokerAddr);</div><div class=\"line\"> <span class=\"number\">52</span>:                 context.setMessage(msg);</div><div class=\"line\"> <span class=\"number\">53</span>:                 context.setMq(mq);</div><div class=\"line\"> <span class=\"number\">54</span>:                 String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class=\"line\"> <span class=\"number\">55</span>:                 <span class=\"keyword\">if</span> (isTrans != <span class=\"keyword\">null</span> &amp;&amp; isTrans.equals(<span class=\"string\">\"true\"</span>)) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:                     context.setMsgType(MessageType.Trans_Msg_Half);</div><div class=\"line\"> <span class=\"number\">57</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">58</span>:                 <span class=\"keyword\">if</span> (msg.getProperty(<span class=\"string\">\"__STARTDELIVERTIME\"</span>) != <span class=\"keyword\">null</span> || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:                     context.setMsgType(MessageType.Delay_Msg);</div><div class=\"line\"> <span class=\"number\">60</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">61</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookBefore(context);</div><div class=\"line\"> <span class=\"number\">62</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">63</span>:             <span class=\"comment\">// æ„å»ºå‘é€æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">64</span>:             SendMessageRequestHeader requestHeader = <span class=\"keyword\">new</span> SendMessageRequestHeader();</div><div class=\"line\"> <span class=\"number\">65</span>:             requestHeader.setProducerGroup(<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"> <span class=\"number\">66</span>:             requestHeader.setTopic(msg.getTopic());</div><div class=\"line\"> <span class=\"number\">67</span>:             requestHeader.setDefaultTopic(<span class=\"keyword\">this</span>.defaultMQProducer.getCreateTopicKey());</div><div class=\"line\"> <span class=\"number\">68</span>:             requestHeader.setDefaultTopicQueueNums(<span class=\"keyword\">this</span>.defaultMQProducer.getDefaultTopicQueueNums());</div><div class=\"line\"> <span class=\"number\">69</span>:             requestHeader.setQueueId(mq.getQueueId());</div><div class=\"line\"> <span class=\"number\">70</span>:             requestHeader.setSysFlag(sysFlag);</div><div class=\"line\"> <span class=\"number\">71</span>:             requestHeader.setBornTimestamp(System.currentTimeMillis());</div><div class=\"line\"> <span class=\"number\">72</span>:             requestHeader.setFlag(msg.getFlag());</div><div class=\"line\"> <span class=\"number\">73</span>:             requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));</div><div class=\"line\"> <span class=\"number\">74</span>:             requestHeader.setReconsumeTimes(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">75</span>:             requestHeader.setUnitMode(<span class=\"keyword\">this</span>.isUnitMode());</div><div class=\"line\"> <span class=\"number\">76</span>:             <span class=\"keyword\">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123; <span class=\"comment\">// æ¶ˆæ¯é‡å‘Topic</span></div><div class=\"line\"> <span class=\"number\">77</span>:                 String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);</div><div class=\"line\"> <span class=\"number\">78</span>:                 <span class=\"keyword\">if</span> (reconsumeTimes != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">79</span>:                     requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));</div><div class=\"line\"> <span class=\"number\">80</span>:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);</div><div class=\"line\"> <span class=\"number\">81</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">82</span>:                 String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);</div><div class=\"line\"> <span class=\"number\">83</span>:                 <span class=\"keyword\">if</span> (maxReconsumeTimes != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">84</span>:                     requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));</div><div class=\"line\"> <span class=\"number\">85</span>:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);</div><div class=\"line\"> <span class=\"number\">86</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">87</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">88</span>:             <span class=\"comment\">// å‘é€æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">89</span>:             SendResult sendResult = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">90</span>:             <span class=\"keyword\">switch</span> (communicationMode) &#123;</div><div class=\"line\"> <span class=\"number\">91</span>:                 <span class=\"keyword\">case</span> ASYNC:</div><div class=\"line\"> <span class=\"number\">92</span>:                     sendResult = <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">93</span>:                         brokerAddr, <span class=\"comment\">// 1</span></div><div class=\"line\"> <span class=\"number\">94</span>:                         mq.getBrokerName(), <span class=\"comment\">// 2</span></div><div class=\"line\"> <span class=\"number\">95</span>:                         msg, <span class=\"comment\">// 3</span></div><div class=\"line\"> <span class=\"number\">96</span>:                         requestHeader, <span class=\"comment\">// 4</span></div><div class=\"line\"> <span class=\"number\">97</span>:                         timeout, <span class=\"comment\">// 5</span></div><div class=\"line\"> <span class=\"number\">98</span>:                         communicationMode, <span class=\"comment\">// 6</span></div><div class=\"line\"> <span class=\"number\">99</span>:                         sendCallback, <span class=\"comment\">// 7</span></div><div class=\"line\"><span class=\"number\">100</span>:                         topicPublishInfo, <span class=\"comment\">// 8</span></div><div class=\"line\"><span class=\"number\">101</span>:                         <span class=\"keyword\">this</span>.mQClientFactory, <span class=\"comment\">// 9</span></div><div class=\"line\"><span class=\"number\">102</span>:                         <span class=\"keyword\">this</span>.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(), <span class=\"comment\">// 10</span></div><div class=\"line\"><span class=\"number\">103</span>:                         context, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">104</span>:                         <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">105</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">106</span>:                 <span class=\"keyword\">case</span> ONEWAY:</div><div class=\"line\"><span class=\"number\">107</span>:                 <span class=\"keyword\">case</span> SYNC:</div><div class=\"line\"><span class=\"number\">108</span>:                     sendResult = <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</div><div class=\"line\"><span class=\"number\">109</span>:                         brokerAddr,</div><div class=\"line\"><span class=\"number\">110</span>:                         mq.getBrokerName(),</div><div class=\"line\"><span class=\"number\">111</span>:                         msg,</div><div class=\"line\"><span class=\"number\">112</span>:                         requestHeader,</div><div class=\"line\"><span class=\"number\">113</span>:                         timeout,</div><div class=\"line\"><span class=\"number\">114</span>:                         communicationMode,</div><div class=\"line\"><span class=\"number\">115</span>:                         context,</div><div class=\"line\"><span class=\"number\">116</span>:                         <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">117</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">118</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">119</span>:                     <span class=\"keyword\">assert</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">120</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">121</span>:             &#125;</div><div class=\"line\"><span class=\"number\">122</span>:             <span class=\"comment\">// hookï¼šå‘é€æ¶ˆæ¯åé€»è¾‘</span></div><div class=\"line\"><span class=\"number\">123</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:                 context.setSendResult(sendResult);</div><div class=\"line\"><span class=\"number\">125</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookAfter(context);</div><div class=\"line\"><span class=\"number\">126</span>:             &#125;</div><div class=\"line\"><span class=\"number\">127</span>:             <span class=\"comment\">// è¿”å›å‘é€ç»“æœ</span></div><div class=\"line\"><span class=\"number\">128</span>:             <span class=\"keyword\">return</span> sendResult;</div><div class=\"line\"><span class=\"number\">129</span>:         &#125; <span class=\"keyword\">catch</span> (RemotingException e) &#123;</div><div class=\"line\"><span class=\"number\">130</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">131</span>:                 context.setException(e);</div><div class=\"line\"><span class=\"number\">132</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookAfter(context);</div><div class=\"line\"><span class=\"number\">133</span>:             &#125;</div><div class=\"line\"><span class=\"number\">134</span>:             <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">135</span>:         &#125; <span class=\"keyword\">catch</span> (MQBrokerException e) &#123;</div><div class=\"line\"><span class=\"number\">136</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">137</span>:                 context.setException(e);</div><div class=\"line\"><span class=\"number\">138</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookAfter(context);</div><div class=\"line\"><span class=\"number\">139</span>:             &#125;</div><div class=\"line\"><span class=\"number\">140</span>:             <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">141</span>:         &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">142</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">143</span>:                 context.setException(e);</div><div class=\"line\"><span class=\"number\">144</span>:                 <span class=\"keyword\">this</span>.executeSendMessageHookAfter(context);</div><div class=\"line\"><span class=\"number\">145</span>:             &#125;</div><div class=\"line\"><span class=\"number\">146</span>:             <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">147</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">148</span>:             msg.setBody(prevBody);</div><div class=\"line\"><span class=\"number\">149</span>:         &#125;</div><div class=\"line\"><span class=\"number\">150</span>:     &#125;</div><div class=\"line\"><span class=\"number\">151</span>:     <span class=\"comment\">// brokerä¸ºç©ºæŠ›å‡ºå¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">152</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"The broker[\"</span> + mq.getBrokerName() + <span class=\"string\">\"] not exist\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">153</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚è¯¥æ–¹æ³•çœŸæ­£å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå‘é€æ¶ˆæ¯ç»™ <code>Broker</code>ã€‚</li>\n<li>ç¬¬ 21 è¡Œ ï¼šç”Ÿäº§æ¶ˆæ¯ç¼–å·ï¼Œè¯¦ç»†è§£æè§<a href=\"http://www.yunai.me/RocketMQ/message/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message åŸºç¡€ã€‹</a>ã€‚</li>\n<li>ç¬¬ 64 è‡³ 121 è¡Œ ï¼šæ„å»ºå‘é€æ¶ˆæ¯è¯·æ±‚<code>SendMessageRequestHeader</code>ã€‚</li>\n<li>ç¬¬ 107 è‡³ 117 è¡Œ ï¼šæ‰§è¡Œ <code>MQClientInstance#sendMessage(...)</code> å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚</li>\n</ul>\n<h1 id=\"3ã€Broker-æ¥æ”¶æ¶ˆæ¯\"><a href=\"#3ã€Broker-æ¥æ”¶æ¶ˆæ¯\" class=\"headerlink\" title=\"3ã€Broker æ¥æ”¶æ¶ˆæ¯\"></a>3ã€Broker æ¥æ”¶æ¶ˆæ¯</h1><blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_18/04.png\" alt=\"æ¥æ”¶å‘é€æ¶ˆæ¯APIé¡ºåºå›¾\"></p>\n</blockquote>\n<h2 id=\"SendMessageProcessor-sendMessage\"><a href=\"#SendMessageProcessor-sendMessage\" class=\"headerlink\" title=\"SendMessageProcessor#sendMessage\"></a>SendMessageProcessor#sendMessage</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RemotingCommand <span class=\"title\">processRequest</span><span class=\"params\">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class=\"keyword\">throws</span> RemotingCommandException </span>&#123;</div><div class=\"line\">  <span class=\"number\">3</span>:     SendMessageContext mqtraceContext;</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"keyword\">switch</span> (request.getCode()) &#123;</div><div class=\"line\">  <span class=\"number\">5</span>:         <span class=\"keyword\">case</span> RequestCode.CONSUMER_SEND_MSG_BACK:</div><div class=\"line\">  <span class=\"number\">6</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.consumerSendMsgBack(ctx, request);</div><div class=\"line\">  <span class=\"number\">7</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\">  <span class=\"number\">8</span>:             <span class=\"comment\">// è§£æè¯·æ±‚</span></div><div class=\"line\">  <span class=\"number\">9</span>:             SendMessageRequestHeader requestHeader = parseRequestHeader(request);</div><div class=\"line\"> <span class=\"number\">10</span>:             <span class=\"keyword\">if</span> (requestHeader == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">11</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">12</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">13</span>:             <span class=\"comment\">// å‘é€è¯·æ±‚Contextã€‚åœ¨ hook åœºæ™¯ä¸‹ä½¿ç”¨</span></div><div class=\"line\"> <span class=\"number\">14</span>:             mqtraceContext = buildMsgContext(ctx, requestHeader);</div><div class=\"line\"> <span class=\"number\">15</span>:             <span class=\"comment\">// hookï¼šå¤„ç†å‘é€æ¶ˆæ¯å‰é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">16</span>:             <span class=\"keyword\">this</span>.executeSendMessageHookBefore(ctx, request, mqtraceContext);</div><div class=\"line\"> <span class=\"number\">17</span>:             <span class=\"comment\">// å¤„ç†å‘é€æ¶ˆæ¯é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">18</span>:             <span class=\"keyword\">final</span> RemotingCommand response = <span class=\"keyword\">this</span>.sendMessage(ctx, request, mqtraceContext, requestHeader);</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"comment\">// hookï¼šå¤„ç†å‘é€æ¶ˆæ¯åé€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"keyword\">this</span>.executeSendMessageHookAfter(response, mqtraceContext);</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">22</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">23</span>: &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">sendMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx, //</span></span></div><div class=\"line\"> <span class=\"number\">26</span>:     <span class=\"keyword\">final</span> RemotingCommand request, //</div><div class=\"line\"> <span class=\"number\">27</span>:     <span class=\"keyword\">final</span> SendMessageContext sendMessageContext, //</div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"keyword\">final</span> SendMessageRequestHeader requestHeader) <span class=\"keyword\">throws</span> RemotingCommandException &#123;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:     <span class=\"comment\">// åˆå§‹åŒ–å“åº”</span></div><div class=\"line\"> <span class=\"number\">31</span>:     <span class=\"keyword\">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(SendMessageResponseHeader.class);</div><div class=\"line\"> <span class=\"number\">32</span>:     <span class=\"keyword\">final</span> SendMessageResponseHeader responseHeader = (SendMessageResponseHeader) response.readCustomHeader();</div><div class=\"line\"> <span class=\"number\">33</span>:     response.setOpaque(request.getOpaque());</div><div class=\"line\"> <span class=\"number\">34</span>:     response.addExtField(MessageConst.PROPERTY_MSG_REGION, <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getRegionId());</div><div class=\"line\"> <span class=\"number\">35</span>:     response.addExtField(MessageConst.PROPERTY_TRACE_SWITCH, String.valueOf(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isTraceOn()));</div><div class=\"line\"> <span class=\"number\">36</span>: </div><div class=\"line\"> <span class=\"number\">37</span>:     <span class=\"keyword\">if</span> (log.isDebugEnabled()) &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:         log.debug(<span class=\"string\">\"receive SendMessage request command, &#123;&#125;\"</span>, request);</div><div class=\"line\"> <span class=\"number\">39</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">40</span>: </div><div class=\"line\"> <span class=\"number\">41</span>:     <span class=\"comment\">// å¦‚æœæœªå¼€å§‹æ¥æ”¶æ¶ˆæ¯ï¼ŒæŠ›å‡ºç³»ç»Ÿå¼‚å¸¸</span></div><div class=\"line\"> <span class=\"number\">42</span>:     <span class=\"meta\">@SuppressWarnings</span>(<span class=\"string\">\"SpellCheckingInspection\"</span>)</div><div class=\"line\"> <span class=\"number\">43</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> startTimstamp = <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getStartAcceptSendRequestTimeStamp();</div><div class=\"line\"> <span class=\"number\">44</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getMessageStore().now() &lt; startTimstamp) &#123;</div><div class=\"line\"> <span class=\"number\">45</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">46</span>:         response.setRemark(String.format(<span class=\"string\">\"broker unable to service, until %s\"</span>, UtilAll.timeMillisToHumanString2(startTimstamp)));</div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">48</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">49</span>: </div><div class=\"line\"> <span class=\"number\">50</span>:     <span class=\"comment\">// æ¶ˆæ¯é…ç½®(Topicé…ç½®ï¼‰æ ¡éªŒ</span></div><div class=\"line\"> <span class=\"number\">51</span>:     response.setCode(-<span class=\"number\">1</span>);</div><div class=\"line\"> <span class=\"number\">52</span>:     <span class=\"keyword\">super</span>.msgCheck(ctx, requestHeader, response);</div><div class=\"line\"> <span class=\"number\">53</span>:     <span class=\"keyword\">if</span> (response.getCode() != -<span class=\"number\">1</span>) &#123;</div><div class=\"line\"> <span class=\"number\">54</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">55</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">56</span>: </div><div class=\"line\"> <span class=\"number\">57</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] body = request.getBody();</div><div class=\"line\"> <span class=\"number\">58</span>: </div><div class=\"line\"> <span class=\"number\">59</span>:     <span class=\"comment\">// å¦‚æœé˜Ÿåˆ—å°äº0ï¼Œä»å¯ç”¨é˜Ÿåˆ—éšæœºé€‰æ‹©</span></div><div class=\"line\"> <span class=\"number\">60</span>:     <span class=\"keyword\">int</span> queueIdInt = requestHeader.getQueueId();</div><div class=\"line\"> <span class=\"number\">61</span>:     TopicConfig topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class=\"line\"> <span class=\"number\">62</span>:     <span class=\"keyword\">if</span> (queueIdInt &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:         queueIdInt = Math.abs(<span class=\"keyword\">this</span>.random.nextInt() % <span class=\"number\">99999999</span>) % topicConfig.getWriteQueueNums();</div><div class=\"line\"> <span class=\"number\">64</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:     <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">67</span>:     <span class=\"keyword\">int</span> sysFlag = requestHeader.getSysFlag();</div><div class=\"line\"> <span class=\"number\">68</span>:     <span class=\"keyword\">if</span> (TopicFilterType.MULTI_TAG == topicConfig.getTopicFilterType()) &#123;</div><div class=\"line\"> <span class=\"number\">69</span>:         sysFlag |= MessageSysFlag.MULTI_TAGS_FLAG;</div><div class=\"line\"> <span class=\"number\">70</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">71</span>: </div><div class=\"line\"> <span class=\"number\">72</span>:     <span class=\"comment\">// å¯¹RETRYç±»å‹çš„æ¶ˆæ¯å¤„ç†ã€‚å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)</span></div><div class=\"line\"> <span class=\"number\">73</span>:     String newTopic = requestHeader.getTopic();</div><div class=\"line\"> <span class=\"number\">74</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != newTopic &amp;&amp; newTopic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"comment\">// è·å–è®¢é˜…åˆ†ç»„é…ç½®</span></div><div class=\"line\"> <span class=\"number\">76</span>:         String groupName = newTopic.substring(MixAll.RETRY_GROUP_TOPIC_PREFIX.length());</div><div class=\"line\"> <span class=\"number\">77</span>:         SubscriptionGroupConfig subscriptionGroupConfig =</div><div class=\"line\"> <span class=\"number\">78</span>:             <span class=\"keyword\">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(groupName);</div><div class=\"line\"> <span class=\"number\">79</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionGroupConfig) &#123;</div><div class=\"line\"> <span class=\"number\">80</span>:             response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">81</span>:             response.setRemark(<span class=\"string\">\"subscription group not exist, \"</span> + groupName + <span class=\"string\">\" \"</span> + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</div><div class=\"line\"> <span class=\"number\">82</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">83</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">84</span>:         <span class=\"comment\">// è®¡ç®—æœ€å¤§å¯æ¶ˆè´¹æ¬¡æ•°</span></div><div class=\"line\"> <span class=\"number\">85</span>:         <span class=\"keyword\">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class=\"line\"> <span class=\"number\">86</span>:         <span class=\"keyword\">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:             maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class=\"line\"> <span class=\"number\">88</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">89</span>:         <span class=\"keyword\">int</span> reconsumeTimes = requestHeader.getReconsumeTimes() == <span class=\"keyword\">null</span> ? <span class=\"number\">0</span> : requestHeader.getReconsumeTimes();</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"keyword\">if</span> (reconsumeTimes &gt;= maxReconsumeTimes) &#123; <span class=\"comment\">// è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°</span></div><div class=\"line\"> <span class=\"number\">91</span>:             newTopic = MixAll.getDLQTopic(groupName);</div><div class=\"line\"> <span class=\"number\">92</span>:             queueIdInt = Math.abs(<span class=\"keyword\">this</span>.random.nextInt() % <span class=\"number\">99999999</span>) % DLQ_NUMS_PER_GROUP;</div><div class=\"line\"> <span class=\"number\">93</span>:             topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">94</span>:                 DLQ_NUMS_PER_GROUP, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">95</span>:                 PermName.PERM_WRITE, <span class=\"number\">0</span></div><div class=\"line\"> <span class=\"number\">96</span>:             );</div><div class=\"line\"> <span class=\"number\">97</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">99</span>:                 response.setRemark(<span class=\"string\">\"topic[\"</span> + newTopic + <span class=\"string\">\"] not exist\"</span>);</div><div class=\"line\"><span class=\"number\">100</span>:                 <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">101</span>:             &#125;</div><div class=\"line\"><span class=\"number\">102</span>:         &#125;</div><div class=\"line\"><span class=\"number\">103</span>:     &#125;</div><div class=\"line\"><span class=\"number\">104</span>: </div><div class=\"line\"><span class=\"number\">105</span>:     <span class=\"comment\">// åˆ›å»ºMessageExtBrokerInner</span></div><div class=\"line\"><span class=\"number\">106</span>:     MessageExtBrokerInner msgInner = <span class=\"keyword\">new</span> MessageExtBrokerInner();</div><div class=\"line\"><span class=\"number\">107</span>:     msgInner.setTopic(newTopic);</div><div class=\"line\"><span class=\"number\">108</span>:     msgInner.setBody(body);</div><div class=\"line\"><span class=\"number\">109</span>:     msgInner.setFlag(requestHeader.getFlag());</div><div class=\"line\"><span class=\"number\">110</span>:     MessageAccessor.setProperties(msgInner, MessageDecoder.string2messageProperties(requestHeader.getProperties()));</div><div class=\"line\"><span class=\"number\">111</span>:     msgInner.setPropertiesString(requestHeader.getProperties());</div><div class=\"line\"><span class=\"number\">112</span>:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(topicConfig.getTopicFilterType(), msgInner.getTags()));</div><div class=\"line\"><span class=\"number\">113</span>:     msgInner.setQueueId(queueIdInt);</div><div class=\"line\"><span class=\"number\">114</span>:     msgInner.setSysFlag(sysFlag);</div><div class=\"line\"><span class=\"number\">115</span>:     msgInner.setBornTimestamp(requestHeader.getBornTimestamp());</div><div class=\"line\"><span class=\"number\">116</span>:     msgInner.setBornHost(ctx.channel().remoteAddress());</div><div class=\"line\"><span class=\"number\">117</span>:     msgInner.setStoreHost(<span class=\"keyword\">this</span>.getStoreHost());</div><div class=\"line\"><span class=\"number\">118</span>:     msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == <span class=\"keyword\">null</span> ? <span class=\"number\">0</span> : requestHeader.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">119</span>: </div><div class=\"line\"><span class=\"number\">120</span>:     <span class=\"comment\">// æ ¡éªŒæ˜¯å¦ä¸å…è®¸å‘é€äº‹åŠ¡æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">121</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isRejectTransactionMessage()) &#123;</div><div class=\"line\"><span class=\"number\">122</span>:         String traFlag = msgInner.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class=\"line\"><span class=\"number\">123</span>:         <span class=\"keyword\">if</span> (traFlag != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:             response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"><span class=\"number\">125</span>:             response.setRemark(</div><div class=\"line\"><span class=\"number\">126</span>:                 <span class=\"string\">\"the broker[\"</span> + <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerIP1() + <span class=\"string\">\"] sending transaction message is forbidden\"</span>);</div><div class=\"line\"><span class=\"number\">127</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">128</span>:         &#125;</div><div class=\"line\"><span class=\"number\">129</span>:     &#125;</div><div class=\"line\"><span class=\"number\">130</span>: </div><div class=\"line\"><span class=\"number\">131</span>:     <span class=\"comment\">// æ·»åŠ æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">132</span>:     PutMessageResult putMessageResult = <span class=\"keyword\">this</span>.brokerController.getMessageStore().putMessage(msgInner);</div><div class=\"line\"><span class=\"number\">133</span>:     <span class=\"keyword\">if</span> (putMessageResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">134</span>:         <span class=\"keyword\">boolean</span> sendOK = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">135</span>: </div><div class=\"line\"><span class=\"number\">136</span>:         <span class=\"keyword\">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class=\"line\"><span class=\"number\">137</span>:             <span class=\"comment\">// Success</span></div><div class=\"line\"><span class=\"number\">138</span>:             <span class=\"keyword\">case</span> PUT_OK:</div><div class=\"line\"><span class=\"number\">139</span>:                 sendOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">140</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"><span class=\"number\">141</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">142</span>:             <span class=\"keyword\">case</span> FLUSH_DISK_TIMEOUT:</div><div class=\"line\"><span class=\"number\">143</span>:                 response.setCode(ResponseCode.FLUSH_DISK_TIMEOUT);</div><div class=\"line\"><span class=\"number\">144</span>:                 sendOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">145</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">146</span>:             <span class=\"keyword\">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class=\"line\"><span class=\"number\">147</span>:                 response.setCode(ResponseCode.FLUSH_SLAVE_TIMEOUT);</div><div class=\"line\"><span class=\"number\">148</span>:                 sendOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">149</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">150</span>:             <span class=\"keyword\">case</span> SLAVE_NOT_AVAILABLE:</div><div class=\"line\"><span class=\"number\">151</span>:                 response.setCode(ResponseCode.SLAVE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">152</span>:                 sendOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">153</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">154</span>: </div><div class=\"line\"><span class=\"number\">155</span>:             <span class=\"comment\">// Failed</span></div><div class=\"line\"><span class=\"number\">156</span>:             <span class=\"keyword\">case</span> CREATE_MAPEDFILE_FAILED:</div><div class=\"line\"><span class=\"number\">157</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">158</span>:                 response.setRemark(<span class=\"string\">\"create mapped file failed, server is busy or broken.\"</span>);</div><div class=\"line\"><span class=\"number\">159</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">160</span>:             <span class=\"keyword\">case</span> MESSAGE_ILLEGAL:</div><div class=\"line\"><span class=\"number\">161</span>:             <span class=\"keyword\">case</span> PROPERTIES_SIZE_EXCEEDED:</div><div class=\"line\"><span class=\"number\">162</span>:                 response.setCode(ResponseCode.MESSAGE_ILLEGAL);</div><div class=\"line\"><span class=\"number\">163</span>:                 response.setRemark(</div><div class=\"line\"><span class=\"number\">164</span>:                     <span class=\"string\">\"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.\"</span>);</div><div class=\"line\"><span class=\"number\">165</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">166</span>:             <span class=\"keyword\">case</span> SERVICE_NOT_AVAILABLE:</div><div class=\"line\"><span class=\"number\">167</span>:                 response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">168</span>:                 response.setRemark(</div><div class=\"line\"><span class=\"number\">169</span>:                     <span class=\"string\">\"service not available now, maybe disk full, \"</span> + diskUtil() + <span class=\"string\">\", maybe your broker machine memory too small.\"</span>);</div><div class=\"line\"><span class=\"number\">170</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">171</span>:             <span class=\"keyword\">case</span> OS_PAGECACHE_BUSY:</div><div class=\"line\"><span class=\"number\">172</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">173</span>:                 response.setRemark(<span class=\"string\">\"[PC_SYNCHRONIZED]broker busy, start flow control for a while\"</span>);</div><div class=\"line\"><span class=\"number\">174</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">175</span>:             <span class=\"keyword\">case</span> UNKNOWN_ERROR:</div><div class=\"line\"><span class=\"number\">176</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">177</span>:                 response.setRemark(<span class=\"string\">\"UNKNOWN_ERROR\"</span>);</div><div class=\"line\"><span class=\"number\">178</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">179</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">180</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">181</span>:                 response.setRemark(<span class=\"string\">\"UNKNOWN_ERROR DEFAULT\"</span>);</div><div class=\"line\"><span class=\"number\">182</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">183</span>:         &#125;</div><div class=\"line\"><span class=\"number\">184</span>: </div><div class=\"line\"><span class=\"number\">185</span>:         String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</div><div class=\"line\"><span class=\"number\">186</span>:         <span class=\"keyword\">if</span> (sendOK) &#123;</div><div class=\"line\"><span class=\"number\">187</span>:             <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"><span class=\"number\">188</span>:             <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incTopicPutNums(msgInner.getTopic());</div><div class=\"line\"><span class=\"number\">189</span>:             <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incTopicPutSize(msgInner.getTopic(), putMessageResult.getAppendMessageResult().getWroteBytes());</div><div class=\"line\"><span class=\"number\">190</span>:             <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incBrokerPutNums();</div><div class=\"line\"><span class=\"number\">191</span>: </div><div class=\"line\"><span class=\"number\">192</span>:             <span class=\"comment\">// å“åº”</span></div><div class=\"line\"><span class=\"number\">193</span>:             response.setRemark(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">194</span>:             responseHeader.setMsgId(putMessageResult.getAppendMessageResult().getMsgId());</div><div class=\"line\"><span class=\"number\">195</span>:             responseHeader.setQueueId(queueIdInt);</div><div class=\"line\"><span class=\"number\">196</span>:             responseHeader.setQueueOffset(putMessageResult.getAppendMessageResult().getLogicsOffset());</div><div class=\"line\"><span class=\"number\">197</span>:             doResponse(ctx, request, response);</div><div class=\"line\"><span class=\"number\">198</span>: </div><div class=\"line\"><span class=\"number\">199</span>:             <span class=\"comment\">// hookï¼šè®¾ç½®å‘é€æˆåŠŸåˆ°context</span></div><div class=\"line\"><span class=\"number\">200</span>:             <span class=\"keyword\">if</span> (hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">201</span>:                 sendMessageContext.setMsgId(responseHeader.getMsgId());</div><div class=\"line\"><span class=\"number\">202</span>:                 sendMessageContext.setQueueId(responseHeader.getQueueId());</div><div class=\"line\"><span class=\"number\">203</span>:                 sendMessageContext.setQueueOffset(responseHeader.getQueueOffset());</div><div class=\"line\"><span class=\"number\">204</span>: </div><div class=\"line\"><span class=\"number\">205</span>:                 <span class=\"keyword\">int</span> commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</div><div class=\"line\"><span class=\"number\">206</span>:                 <span class=\"keyword\">int</span> wroteSize = putMessageResult.getAppendMessageResult().getWroteBytes();</div><div class=\"line\"><span class=\"number\">207</span>:                 <span class=\"keyword\">int</span> incValue = (<span class=\"keyword\">int</span>) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT) * commercialBaseCount;</div><div class=\"line\"><span class=\"number\">208</span>: </div><div class=\"line\"><span class=\"number\">209</span>:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_SUCCESS);</div><div class=\"line\"><span class=\"number\">210</span>:                 sendMessageContext.setCommercialSendTimes(incValue);</div><div class=\"line\"><span class=\"number\">211</span>:                 sendMessageContext.setCommercialSendSize(wroteSize);</div><div class=\"line\"><span class=\"number\">212</span>:                 sendMessageContext.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">213</span>:             &#125;</div><div class=\"line\"><span class=\"number\">214</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">215</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">216</span>:             <span class=\"comment\">// hookï¼šè®¾ç½®å‘é€å¤±è´¥åˆ°context</span></div><div class=\"line\"><span class=\"number\">217</span>:             <span class=\"keyword\">if</span> (hasSendMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">218</span>:                 <span class=\"keyword\">int</span> wroteSize = request.getBody().length;</div><div class=\"line\"><span class=\"number\">219</span>:                 <span class=\"keyword\">int</span> incValue = (<span class=\"keyword\">int</span>) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT);</div><div class=\"line\"><span class=\"number\">220</span>: </div><div class=\"line\"><span class=\"number\">221</span>:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_FAILURE);</div><div class=\"line\"><span class=\"number\">222</span>:                 sendMessageContext.setCommercialSendTimes(incValue);</div><div class=\"line\"><span class=\"number\">223</span>:                 sendMessageContext.setCommercialSendSize(wroteSize);</div><div class=\"line\"><span class=\"number\">224</span>:                 sendMessageContext.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">225</span>:             &#125;</div><div class=\"line\"><span class=\"number\">226</span>:         &#125;</div><div class=\"line\"><span class=\"number\">227</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">228</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">229</span>:         response.setRemark(<span class=\"string\">\"store putMessage return null\"</span>);</div><div class=\"line\"><span class=\"number\">230</span>:     &#125;</div><div class=\"line\"><span class=\"number\">231</span>: </div><div class=\"line\"><span class=\"number\">232</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">233</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li><code>#processRequest()</code> è¯´æ˜ ï¼šå¤„ç†æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li><code>#sendMessage()</code> è¯´æ˜ ï¼šå‘é€æ¶ˆæ¯ï¼Œå¹¶è¿”å›å‘é€æ¶ˆæ¯ç»“æœã€‚</li>\n<li>ç¬¬ 51 è‡³ 55 è¡Œ ï¼šæ¶ˆæ¯é…ç½®(Topicé…ç½®ï¼‰æ ¡éªŒï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#abstractsendmessageprocessormsgcheck\">AbstractSendMessageProcessor#msgCheck()</a>ã€‚</li>\n<li>ç¬¬ 60 è‡³ 64 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼–å·å°äº0æ—¶ï¼Œ<code>Broker</code> å¯ä»¥è®¾ç½®éšæœºé€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 72 è‡³ 103 è¡Œ ï¼šå¯¹RETRYç±»å‹çš„æ¶ˆæ¯å¤„ç†ã€‚å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆâ€%DLQ%â€ + åˆ†ç»„åï¼Œ å³åŠ   æ­»ä¿¡é˜Ÿ (Dead Letter Queue)ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/topic/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹</a>ã€‚</li>\n<li>ç¬¬ 105 è‡³ 118 è¡Œ ï¼šåˆ›å»º<code>MessageExtBrokerInner</code>ã€‚</li>\n<li>ç¬¬ 132 ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"defaultmessagestoreputmessage\">DefaultMessageStore#putMessage()</a>ã€‚</li>\n<li>ç¬¬ 133 è‡³ 183 è¡Œ ï¼šå¤„ç†æ¶ˆæ¯å‘é€ç»“æœï¼Œè®¾ç½®å“åº”ç»“æœå’Œæç¤ºã€‚</li>\n<li>ç¬¬ 186 è‡³ 214 è¡Œ ï¼šå‘é€æˆåŠŸï¼Œå“åº”ã€‚è¿™é‡Œ<code>doResponse(ctx, request, response)</code>è¿›è¡Œå“åº”ï¼Œæœ€å<code>return null</code>ï¼ŒåŸå› æ˜¯ï¼šå“åº”ç»™ <code>Producer</code> å¯èƒ½å‘ç”Ÿå¼‚å¸¸ï¼Œ<code>#doResponse(ctx, request, response)</code>æ•æ‰äº†è¯¥å¼‚å¸¸å¹¶è¾“å‡ºæ—¥å¿—ã€‚è¿™æ ·åšçš„è¯ï¼Œæˆ‘ä»¬è¿›è¡Œæ’æŸ¥ <code>Broker</code> æ¥æ”¶æ¶ˆæ¯æˆåŠŸåå“åº”æ˜¯å¦å­˜åœ¨å¼‚å¸¸ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚</li>\n</ul>\n<h3 id=\"AbstractSendMessageProcessor-msgCheck\"><a href=\"#AbstractSendMessageProcessor-msgCheck\" class=\"headerlink\" title=\"AbstractSendMessageProcessor#msgCheck\"></a>AbstractSendMessageProcessor#msgCheck</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">protected</span> RemotingCommand <span class=\"title\">msgCheck</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx,</span></span></div><div class=\"line\"> <span class=\"number\">2</span>:                                    <span class=\"keyword\">final</span> SendMessageRequestHeader requestHeader, <span class=\"keyword\">final</span> RemotingCommand response) &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™</span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">if</span> (!PermName.isWriteable(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerPermission())</div><div class=\"line\"> <span class=\"number\">5</span>:         &amp;&amp; <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().isOrderTopic(requestHeader.getTopic())) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">7</span>:         response.setRemark(<span class=\"string\">\"the broker[\"</span> + <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerIP1()</div><div class=\"line\"> <span class=\"number\">8</span>:             + <span class=\"string\">\"] sending message is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">10</span>:     &#125;</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"comment\">// æ£€æŸ¥topicæ˜¯å¦å¯ä»¥è¢«å‘é€ã€‚ç›®å‰æ˜¯&#123;@link MixAll.DEFAULT_TOPIC&#125;ä¸è¢«å…è®¸å‘é€</span></div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().isTopicCanSendMessage(requestHeader.getTopic())) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:         String errorMsg = <span class=\"string\">\"the topic[\"</span> + requestHeader.getTopic() + <span class=\"string\">\"] is conflict with system reserved words.\"</span>;</div><div class=\"line\"><span class=\"number\">14</span>:         log.warn(errorMsg);</div><div class=\"line\"><span class=\"number\">15</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">16</span>:         response.setRemark(errorMsg);</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">18</span>:     &#125;</div><div class=\"line\"><span class=\"number\">19</span>:     TopicConfig topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123; <span class=\"comment\">// ä¸èƒ½å­˜åœ¨topicConfigï¼Œåˆ™è¿›è¡Œåˆ›å»º</span></div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"keyword\">int</span> topicSysFlag = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">22</span>:         <span class=\"keyword\">if</span> (requestHeader.isUnitMode()) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 topicSysFlag = TopicSysFlag.buildSysFlag(<span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">25</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 topicSysFlag = TopicSysFlag.buildSysFlag(<span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"comment\">// åˆ›å»ºtopicé…ç½®</span></div><div class=\"line\"><span class=\"number\">30</span>:         log.warn(<span class=\"string\">\"the topic &#123;&#125; not exist, producer: &#123;&#125;\"</span>, requestHeader.getTopic(), ctx.channel().remoteAddress());</div><div class=\"line\"><span class=\"number\">31</span>:         topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageMethod(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">32</span>:             requestHeader.getTopic(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">33</span>:             requestHeader.getDefaultTopic(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">34</span>:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">35</span>:             requestHeader.getDefaultTopicQueueNums(), topicSysFlag);</div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                 topicConfig =</div><div class=\"line\"><span class=\"number\">39</span>:                     <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(</div><div class=\"line\"><span class=\"number\">40</span>:                         requestHeader.getTopic(), <span class=\"number\">1</span>, PermName.PERM_WRITE | PermName.PERM_READ,</div><div class=\"line\"><span class=\"number\">41</span>:                         topicSysFlag);</div><div class=\"line\"><span class=\"number\">42</span>:             &#125;</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"comment\">// å¦‚æœæ²¡é…ç½®</span></div><div class=\"line\"><span class=\"number\">45</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"><span class=\"number\">46</span>:             response.setCode(ResponseCode.TOPIC_NOT_EXIST);</div><div class=\"line\"><span class=\"number\">47</span>:             response.setRemark(<span class=\"string\">\"topic[\"</span> + requestHeader.getTopic() + <span class=\"string\">\"] not exist, apply first please!\"</span></div><div class=\"line\"><span class=\"number\">48</span>:                 + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));</div><div class=\"line\"><span class=\"number\">49</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">50</span>:         &#125;</div><div class=\"line\"><span class=\"number\">51</span>:     &#125;</div><div class=\"line\"><span class=\"number\">52</span>:     <span class=\"comment\">// é˜Ÿåˆ—ç¼–å·æ˜¯å¦æ­£ç¡®</span></div><div class=\"line\"><span class=\"number\">53</span>:     <span class=\"keyword\">int</span> queueIdInt = requestHeader.getQueueId();</div><div class=\"line\"><span class=\"number\">54</span>:     <span class=\"keyword\">int</span> idValid = Math.max(topicConfig.getWriteQueueNums(), topicConfig.getReadQueueNums());</div><div class=\"line\"><span class=\"number\">55</span>:     <span class=\"keyword\">if</span> (queueIdInt &gt;= idValid) &#123;</div><div class=\"line\"><span class=\"number\">56</span>:         String errorInfo = String.format(<span class=\"string\">\"request queueId[%d] is illegal, %s Producer: %s\"</span>,</div><div class=\"line\"><span class=\"number\">57</span>:             queueIdInt,</div><div class=\"line\"><span class=\"number\">58</span>:             topicConfig.toString(),</div><div class=\"line\"><span class=\"number\">59</span>:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()));</div><div class=\"line\"><span class=\"number\">60</span>:         log.warn(errorInfo);</div><div class=\"line\"><span class=\"number\">61</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">62</span>:         response.setRemark(errorInfo);</div><div class=\"line\"><span class=\"number\">63</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">64</span>:     &#125;</div><div class=\"line\"><span class=\"number\">65</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">66</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ï¼šæ ¡éªŒæ¶ˆæ¯æ˜¯å¦æ­£ç¡®ï¼Œä¸»è¦æ˜¯Topicé…ç½®æ–¹é¢ï¼Œä¾‹å¦‚ï¼š<code>Broker</code> æ˜¯å¦æœ‰å†™å…¥æƒé™ï¼Œtopicé…ç½®æ˜¯å¦å­˜åœ¨ï¼Œé˜Ÿåˆ—ç¼–å·æ˜¯å¦æ­£ç¡®ã€‚</li>\n<li>ç¬¬ 11 è‡³ 18 è¡Œ ï¼šæ£€æŸ¥Topicæ˜¯å¦å¯ä»¥è¢«å‘é€ã€‚ç›®å‰æ˜¯ <code>{@link MixAll.DEFAULT_TOPIC}</code> ä¸è¢«å…è®¸å‘é€ã€‚</li>\n<li>ç¬¬ 20 è‡³ 51 è¡Œ ï¼šå½“æ‰¾ä¸åˆ°Topicé…ç½®ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚å½“ç„¶ï¼Œåˆ›å»ºä¼šå­˜åœ¨ä¸æˆåŠŸçš„æƒ…å†µï¼Œä¾‹å¦‚è¯´ï¼š<code>defaultTopic</code> çš„Topicé…ç½®ä¸å­˜åœ¨ï¼Œåˆæˆ–è€…æ˜¯ å­˜åœ¨ä½†æ˜¯ä¸å…è®¸ç»§æ‰¿ï¼Œè¯¦ç»†è§£æè§<a href=\"http://www.yunai.me/RocketMQ/topic/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Topicã€‹</a>ã€‚</li>\n</ul>\n<h2 id=\"DefaultMessageStore-putMessage\"><a href=\"#DefaultMessageStore-putMessage\" class=\"headerlink\" title=\"DefaultMessageStore#putMessage\"></a>DefaultMessageStore#putMessage</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> PutMessageResult <span class=\"title\">putMessage</span><span class=\"params\">(MessageExtBrokerInner msg)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.shutdown) &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:         log.warn(<span class=\"string\">\"message store has shutdown, so putMessage is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">5</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">// ä»èŠ‚ç‚¹ä¸å…è®¸å†™å…¥</span></div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">if</span> (BrokerRole.SLAVE == <span class=\"keyword\">this</span>.messageStoreConfig.getBrokerRole()) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">long</span> value = <span class=\"keyword\">this</span>.printTimes.getAndIncrement();</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">if</span> ((value % <span class=\"number\">50000</span>) == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:             log.warn(<span class=\"string\">\"message store is slave mode, so putMessage is forbidden \"</span>);</div><div class=\"line\"><span class=\"number\">12</span>:         &#125;</div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">15</span>:     &#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"comment\">// storeæ˜¯å¦å…è®¸å†™å…¥</span></div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.runningFlags.isWriteable()) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">long</span> value = <span class=\"keyword\">this</span>.printTimes.getAndIncrement();</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"keyword\">if</span> ((value % <span class=\"number\">50000</span>) == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:             log.warn(<span class=\"string\">\"message store is not writeable, so putMessage is forbidden \"</span> + <span class=\"keyword\">this</span>.runningFlags.getFlagBits());</div><div class=\"line\"><span class=\"number\">22</span>:         &#125;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">25</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">this</span>.printTimes.set(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">27</span>:     &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"comment\">// æ¶ˆæ¯è¿‡é•¿</span></div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">if</span> (msg.getTopic().length() &gt; Byte.MAX_VALUE) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:         log.warn(<span class=\"string\">\"putMessage message topic length too long \"</span> + msg.getTopic().length());</div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">33</span>:     &#125;</div><div class=\"line\"><span class=\"number\">34</span>: </div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"comment\">// æ¶ˆæ¯é™„åŠ å±æ€§è¿‡é•¿</span></div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"keyword\">if</span> (msg.getPropertiesString() != <span class=\"keyword\">null</span> &amp;&amp; msg.getPropertiesString().length() &gt; Short.MAX_VALUE) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:         log.warn(<span class=\"string\">\"putMessage message properties length too long \"</span> + msg.getPropertiesString().length());</div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.PROPERTIES_SIZE_EXCEEDED, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">39</span>:     &#125;</div><div class=\"line\"><span class=\"number\">40</span>: </div><div class=\"line\"><span class=\"number\">41</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isOSPageCacheBusy()) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.OS_PAGECACHE_BUSY, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"keyword\">long</span> beginTime = <span class=\"keyword\">this</span>.getSystemClock().now();</div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"comment\">// æ·»åŠ æ¶ˆæ¯åˆ°commitLog</span></div><div class=\"line\"><span class=\"number\">47</span>:     PutMessageResult result = <span class=\"keyword\">this</span>.commitLog.putMessage(msg);</div><div class=\"line\"><span class=\"number\">48</span>: </div><div class=\"line\"><span class=\"number\">49</span>:     <span class=\"keyword\">long</span> eclipseTime = <span class=\"keyword\">this</span>.getSystemClock().now() - beginTime;</div><div class=\"line\"><span class=\"number\">50</span>:     <span class=\"keyword\">if</span> (eclipseTime &gt; <span class=\"number\">500</span>) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:         log.warn(<span class=\"string\">\"putMessage not in lock eclipse time(ms)=&#123;&#125;, bodyLength=&#123;&#125;\"</span>, eclipseTime, msg.getBody().length);</div><div class=\"line\"><span class=\"number\">52</span>:     &#125;</div><div class=\"line\"><span class=\"number\">53</span>:     <span class=\"keyword\">this</span>.storeStatsService.setPutMessageEntireTimeMax(eclipseTime);</div><div class=\"line\"><span class=\"number\">54</span>: </div><div class=\"line\"><span class=\"number\">55</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == result || !result.isOk()) &#123;</div><div class=\"line\"><span class=\"number\">56</span>:         <span class=\"keyword\">this</span>.storeStatsService.getPutMessageFailedTimes().incrementAndGet();</div><div class=\"line\"><span class=\"number\">57</span>:     &#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">60</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>è¯´æ˜ï¼šå­˜å‚¨æ¶ˆæ¯å°è£…ï¼Œæœ€ç»ˆå­˜å‚¨éœ€è¦ <code>CommitLog</code> å®ç°ã€‚</li>\n<li>ç¬¬ 7 è‡³ 27 è¡Œ ï¼šæ ¡éªŒ <code>Broker</code> æ˜¯å¦å¯ä»¥å†™å…¥ã€‚</li>\n<li>ç¬¬ 29 è‡³ 39 è¡Œ ï¼šæ¶ˆæ¯æ ¼å¼ä¸å¤§å°æ ¡éªŒã€‚</li>\n<li>ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ <code>CommitLong</code> è¿›è¡Œå­˜å‚¨ï¼Œè¯¦ç»†é€»è¾‘è§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-store/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨ã€‹</a></li>\n</ul>\n<h1 id=\"4ã€æŸç§ç»“å°¾\"><a href=\"#4ã€æŸç§ç»“å°¾\" class=\"headerlink\" title=\"4ã€æŸç§ç»“å°¾\"></a>4ã€æŸç§ç»“å°¾</h1><p>æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€ç‚¹èµæœ¬æ–‡çš„å·¥ç¨‹å¸ˆåŒå­¦ã€‚</p>\n<p>é˜…è¯»æºç æ˜¯ä»¶ä»¤è‡ªå·±å¾ˆæ„‰æ‚¦çš„äº‹æƒ…ï¼Œç¼–å†™æºç è§£ææ˜¯è®©è‡ªå·±è„‘ç»†èƒæ­»ä¼¤æ— æ•°çš„è¿‡ç¨‹ï¼Œç—›å¹¶å¿«ä¹ç€ã€‚</p>\n<p>å¦‚æœæœ‰å†…å®¹å†™çš„å­˜åœ¨é”™è¯¯ï¼Œæˆ–æ˜¯ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œè§ç¬‘äº†ï¼ŒğŸ™‚ã€‚æ¬¢è¿åŠ  QQï¼š7685413 æˆ‘ä»¬ä¸€èµ·æ¢è®¨ï¼Œå…±è¿›æ­¥ã€‚</p>\n<p>å†æ¬¡æ„Ÿè°¢é˜…è¯»ã€æ”¶è—ã€ç‚¹èµæœ¬æ–‡çš„å·¥ç¨‹å¸ˆåŒå­¦ã€‚</p>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨","date":"2017-04-22T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[http://www.yunai.me/RocketMQ/message-store/](http://www.yunai.me/RocketMQ/message-store/)  \n> `RocketMQ` **å¸¦æ³¨é‡Šæºç **åœ°å€ ï¼š[https://github.com/YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **  \n\n![wechat_mp](http://www.yunai.me/images/common/wechat_mp.jpeg)\n\n-------\n\n- [1ã€æ¦‚è¿°](#)\n- [2ã€CommitLog ç»“æ„](#)\n- [3ã€CommitLog å­˜å‚¨æ¶ˆæ¯](#)\n\t- [CommitLog#putMessage(...)](#)\n\t- [MappedFileQueue#getLastMappedFile(...)](#)\n\t- [MappedFile#appendMessage(...)](#)\n\t- [DefaultAppendMessageCallback#doAppend(...)](#)\n\t- [FlushCommitLogService](#)\n\t\t- [MappedFile#è½ç›˜](#)\n\t\t- [FlushRealTimeService](#)\n\t\t- [CommitRealTimeService](#)\n\t\t- [GroupCommitService](#)\n- [ç»“å°¾](#)\n\n# 1ã€æ¦‚è¿°\n\næœ¬æ–‡æ¥[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶ã€‹](http://www.yunai.me/RocketMQ/message-send-and-receive/)ã€‚\nä¸»è¦è§£æ `CommitLog` å­˜å‚¨æ¶ˆæ¯éƒ¨åˆ†ã€‚\n\n# 2ã€CommitLog ç»“æ„\n\n`CommitLog`ã€`MappedFileQueue`ã€`MappedFile` çš„å…³ç³»å¦‚ä¸‹ï¼š\n\n> ![CommitLogã€MappedFileQueueã€MappedFileçš„å…³ç³»](http://www.yunai.me/images/RocketMQ/2017_04_23/02.png)\n`CommitLog` : `MappedFileQueue` : `MappedFile` = 1 : 1 : Nã€‚\n\nååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š\n\n```bash\nYunai-MacdeMacBook-Pro-2:commitlog yunai$ pwd\n/Users/yunai/store/commitlog\nYunai-MacdeMacBook-Pro-2:commitlog yunai$ ls -l\ntotal 10485760\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:27 00000000000000000000\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:29 00000000001073741824\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:32 00000000002147483648\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:33 00000000003221225472\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:32 00000000004294967296\n```\n\n-------\n\n`CommitLog`ã€`MappedFileQueue`ã€`MappedFile` çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n* `MappedFile` ï¼š00000000000000000000ã€00000000001073741824ã€00000000002147483648ç­‰æ–‡ä»¶ã€‚\n* `MappedFileQueue` ï¼š`MappedFile` æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ `MappedFile` è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚\n    * æ¯ä¸ª `MappedFile` ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚\n    * æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ `CommitLog` é‡Œé»˜è®¤ä¸º 1GBã€‚\n* `CommitLog` ï¼šé’ˆå¯¹ `MappedFileQueue` çš„å°è£…ä½¿ç”¨ã€‚\n\n`CommitLog` ç›®å‰å­˜å‚¨åœ¨ `MappedFile` æœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š\n\n1. MESSAGE ï¼šæ¶ˆæ¯ã€‚\n2. BLANK ï¼šæ–‡ä»¶ä¸è¶³ä»¥å­˜å‚¨æ¶ˆæ¯æ—¶çš„ç©ºç™½å ä½ã€‚\n\n`CommitLog` å­˜å‚¨åœ¨ `MappedFile`çš„ç»“æ„ï¼š\n\n> | MESSAGE[1] | MESSAGE[2]  | ... | MESSAGE[n - 1] | MESSAGE[n] | BLANK |\n> | --- | --- | --- | --- | --- | --- |\n\n`MESSAGE` åœ¨ `CommitLog` å­˜å‚¨ç»“æ„ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | MsgLen | æ¶ˆæ¯æ€»é•¿åº¦ | Int | 4 |\n| 2 | MagicCode | MESSAGE_MAGIC_CODE | Int | 4 |\n| 3 | BodyCRC | æ¶ˆæ¯å†…å®¹CRC | Int | 4 |\n| 4 | QueueId | æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· | Int | 4 |\n| 5 | Flag |  flag | Int  | 4 |\n| 6 | QueueOffset | æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® | Long | 8 |\n| 7 | PhysicalOffset | ç‰©ç†ä½ç½®ã€‚åœ¨ `CommitLog` çš„é¡ºåºå­˜å‚¨ä½ç½®ã€‚ | Long | 8 |\n| 8 | SysFlag | MessageSysFlag | Int | 4 |\n| 9 | BornTimestamp | ç”Ÿæˆæ¶ˆæ¯æ—¶é—´æˆ³ | Long | 8 |\n| 10 | BornHost  | ç”Ÿæ•ˆæ¶ˆæ¯çš„åœ°å€+ç«¯å£ | Long | 8 |\n| 11 | StoreTimestamp | å­˜å‚¨æ¶ˆæ¯æ—¶é—´æˆ³ | Long | 8 |\n| 12 | StoreHost | å­˜å‚¨æ¶ˆæ¯çš„åœ°å€+ç«¯å£ | Long | 8 |\n| 13 | ReconsumeTimes | é‡æ–°æ¶ˆè´¹æ¶ˆæ¯æ¬¡æ•° | Int | 4 |\n| 14 | PreparedTransationOffset |  | Long | 8 |\n| 15 | BodyLength + Body  | å†…å®¹é•¿åº¦ + å†…å®¹ | Int + Bytes | 4 + bodyLength |\n| 16 | TopicLength + Topic | Topicé•¿åº¦ + Topic | Byte + Bytes | 1 + topicLength |\n| 17 | PropertiesLength + Properties | æ‹“å±•å­—æ®µé•¿åº¦ + æ‹“å±•å­—æ®µ | Short + Bytes | 2 + PropertiesLength |\n\n`BLANK` åœ¨ `CommitLog` å­˜å‚¨ç»“æ„ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | maxBlank | ç©ºç™½é•¿åº¦ | Int | 4 |\n| 2 | MagicCode | BLANK_MAGIC_CODE | Int | 4 |\n\n# 3ã€CommitLog å­˜å‚¨æ¶ˆæ¯\n\n> ![Brokerå­˜å‚¨å‘é€æ¶ˆæ¯é¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_04_23/01.png)\n\n## CommitLog#putMessage(...)\n\n```Java\n  1: public PutMessageResult putMessage(final MessageExtBrokerInner msg) {\n  2:     // Set the storage time\n  3:     msg.setStoreTimestamp(System.currentTimeMillis());\n  4:     // Set the message body BODY CRC (consider the most appropriate setting\n  5:     // on the client)\n  6:     msg.setBodyCRC(UtilAll.crc32(msg.getBody()));\n  7:     // Back to Results\n  8:     AppendMessageResult result = null;\n  9: \n 10:     StoreStatsService storeStatsService = this.defaultMessageStore.getStoreStatsService();\n 11: \n 12:     String topic = msg.getTopic();\n 13:     int queueId = msg.getQueueId();\n 14: \n 15:     // äº‹åŠ¡ç›¸å…³ TODO å¾…è¯»ï¼šäº‹åŠ¡ç›¸å…³\n 16:     final int tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());\n 17:     if (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE//\n 18:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) {\n 19:         // Delay Delivery\n 20:         if (msg.getDelayTimeLevel() > 0) {\n 21:             if (msg.getDelayTimeLevel() > this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) {\n 22:                 msg.setDelayTimeLevel(this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());\n 23:             }\n 24: \n 25:             topic = ScheduleMessageService.SCHEDULE_TOPIC;\n 26:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());\n 27: \n 28:             // Backup real topic, queueId\n 29:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());\n 30:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));\n 31:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));\n 32: \n 33:             msg.setTopic(topic);\n 34:             msg.setQueueId(queueId);\n 35:         }\n 36:     }\n 37: \n 38:     long eclipseTimeInLock = 0;\n 39: \n 40:     // è·å–å†™å…¥æ˜ å°„æ–‡ä»¶\n 41:     MappedFile unlockMappedFile = null;\n 42:     MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile();\n 43: \n 44:     // è·å–å†™å…¥é”\n 45:     lockForPutMessage(); //spin...\n 46:     try {\n 47:         long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();\n 48:         this.beginTimeInLock = beginLockTimestamp;\n 49: \n 50:         // Here settings are stored timestamp, in order to ensure an orderly\n 51:         // global\n 52:         msg.setStoreTimestamp(beginLockTimestamp);\n 53: \n 54:         // å½“ä¸å­˜åœ¨æ˜ å°„æ–‡ä»¶æ—¶ï¼Œè¿›è¡Œåˆ›å»º\n 55:         if (null == mappedFile || mappedFile.isFull()) {\n 56:             mappedFile = this.mappedFileQueue.getLastMappedFile(0); // Mark: NewFile may be cause noise\n 57:         }\n 58:         if (null == mappedFile) {\n 59:             log.error(\"create maped file1 error, topic: \" + msg.getTopic() + \" clientAddr: \" + msg.getBornHostString());\n 60:             beginTimeInLock = 0;\n 61:             return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, null);\n 62:         }\n 63: \n 64:         // å­˜å‚¨æ¶ˆæ¯\n 65:         result = mappedFile.appendMessage(msg, this.appendMessageCallback);\n 66:         switch (result.getStatus()) {\n 67:             case PUT_OK:\n 68:                 break;\n 69:             case END_OF_FILE: // å½“æ–‡ä»¶å°¾æ—¶ï¼Œè·å–æ–°çš„æ˜ å°„æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œæ’å…¥\n 70:                 unlockMappedFile = mappedFile;\n 71:                 // Create a new file, re-write the message\n 72:                 mappedFile = this.mappedFileQueue.getLastMappedFile(0);\n 73:                 if (null == mappedFile) {\n 74:                     // XXX: warn and notify me\n 75:                     log.error(\"create maped file2 error, topic: \" + msg.getTopic() + \" clientAddr: \" + msg.getBornHostString());\n 76:                     beginTimeInLock = 0;\n 77:                     return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);\n 78:                 }\n 79:                 result = mappedFile.appendMessage(msg, this.appendMessageCallback);\n 80:                 break;\n 81:             case MESSAGE_SIZE_EXCEEDED:\n 82:             case PROPERTIES_SIZE_EXCEEDED:\n 83:                 beginTimeInLock = 0;\n 84:                 return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);\n 85:             case UNKNOWN_ERROR:\n 86:                 beginTimeInLock = 0;\n 87:                 return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);\n 88:             default:\n 89:                 beginTimeInLock = 0;\n 90:                 return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);\n 91:         }\n 92: \n 93:         eclipseTimeInLock = this.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;\n 94:         beginTimeInLock = 0;\n 95:     } finally {\n 96:         // é‡Šæ”¾å†™å…¥é”\n 97:         releasePutMessageLock();\n 98:     }\n 99: \n100:     if (eclipseTimeInLock > 500) {\n101:         log.warn(\"[NOTIFYME]putMessage in lock cost time(ms)={}, bodyLength={} AppendMessageResult={}\", eclipseTimeInLock, msg.getBody().length, result);\n102:     }\n103: \n104:     // \n105:     if (null != unlockMappedFile && this.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) {\n106:         this.defaultMessageStore.unlockMappedFile(unlockMappedFile);\n107:     }\n108: \n109:     PutMessageResult putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result);\n110: \n111:     // Statistics\n112:     storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).incrementAndGet();\n113:     storeStatsService.getSinglePutMessageTopicSizeTotal(topic).addAndGet(result.getWroteBytes());\n114: \n115:     // è¿›è¡ŒåŒæ­¥||å¼‚æ­¥ flush||commit\n116:     GroupCommitRequest request = null;\n117:     // Synchronization flush\n118:     if (FlushDiskType.SYNC_FLUSH == this.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) {\n119:         final GroupCommitService service = (GroupCommitService) this.flushCommitLogService;\n120:         if (msg.isWaitStoreMsgOK()) {\n121:             request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());\n122:             service.putRequest(request);\n123:             boolean flushOK = request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());\n124:             if (!flushOK) {\n125:                 log.error(\"do groupcommit, wait for flush failed, topic: \" + msg.getTopic() + \" tags: \" + msg.getTags()\n126:                     + \" client address: \" + msg.getBornHostString());\n127:                 putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);\n128:             }\n129:         } else {\n130:             service.wakeup();\n131:         }\n132:     }\n133:     // Asynchronous flush\n134:     else {\n135:         if (!this.defaultMessageStore.getMessageStoreConfig().isTransientStorePoolEnable()) {\n136:             flushCommitLogService.wakeup(); // importantï¼šå”¤é†’commitLogçº¿ç¨‹ï¼Œè¿›è¡Œflush\n137:         } else {\n138:             commitLogService.wakeup();\n139:         }\n140:     }\n141: \n142:     // Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹ // TODO å¾…è¯»ï¼šæ•°æ®åŒæ­¥\n143:     if (BrokerRole.SYNC_MASTER == this.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) {\n144:         HAService service = this.defaultMessageStore.getHaService();\n145:         if (msg.isWaitStoreMsgOK()) {\n146:             // Determine whether to wait\n147:             if (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) {\n148:                 if (null == request) {\n149:                     request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());\n150:                 }\n151:                 service.putRequest(request);\n152: \n153:                 service.getWaitNotifyObject().wakeupAll();\n154: \n155:                 boolean flushOK =\n156:                     // TODO\n157:                     request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());\n158:                 if (!flushOK) {\n159:                     log.error(\"do sync transfer other node, wait return, but failed, topic: \" + msg.getTopic() + \" tags: \"\n160:                         + msg.getTags() + \" client address: \" + msg.getBornHostString());\n161:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);\n162:                 }\n163:             }\n164:             // Slave problem\n165:             else {\n166:                 // Tell the producer, slave not available\n167:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);\n168:             }\n169:         }\n170:     }\n171: \n172:     return putMessageResult;\n173: }\n```\n\n* è¯´æ˜ ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œå¹¶è¿”å›å­˜å‚¨ç»“æœã€‚\n* ç¬¬ 2 è¡Œ ï¼šè®¾ç½®å­˜å‚¨æ—¶é—´ç­‰ã€‚\n* ç¬¬ 16 è‡³ 36 è¡Œ ï¼šäº‹åŠ¡æ¶ˆæ¯ç›¸å…³ï¼Œæš‚æœªäº†è§£ã€‚\n* ç¬¬ 45 & 97 è¡Œ ï¼šè·å–é”ä¸é‡Šæ”¾é”ã€‚\n* ç¬¬ 52 è¡Œ ï¼šå†æ¬¡è®¾ç½®å­˜å‚¨æ—¶é—´ã€‚ç›®å‰ä¼šæœ‰å¤šå¤„åœ°æ–¹è®¾ç½®å­˜å‚¨æ—¶é—´ã€‚\n* ç¬¬ 55 è‡³ 62 è¡Œ ï¼šè·å– `MappedFile`ï¼Œè‹¥ä¸å­˜åœ¨æˆ–å·²æ»¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚è¯¦ç»†è§£æè§ï¼š[MappedFileQueue#getLastMappedFile(...)](#mappedfilequeuegetlastmappedfile)ã€‚\n* ç¬¬ 65 è¡Œ ï¼š**æ’å…¥æ¶ˆæ¯**åˆ° `MappedFile`ï¼Œè§£æè§£æè§ï¼š[MappedFile#appendMessage(...)](#mappedfileappendmessage)ã€‚\n* ç¬¬ 69 è‡³ 80 è¡Œ ï¼š`MappedFile` å·²æ»¡ï¼Œåˆ›å»ºæ–°çš„ï¼Œå†æ¬¡**æ’å…¥æ¶ˆæ¯**ã€‚\n* ç¬¬ 116 è‡³ 140 è¡Œ ï¼š**æ¶ˆæ¯åˆ·ç›˜**ï¼Œå³æŒä¹…åŒ–åˆ°æ–‡ä»¶ã€‚ä¸Šé¢**æ’å…¥æ¶ˆæ¯**å®é™…æœªå­˜å‚¨åˆ°ç¡¬ç›˜ã€‚æ­¤å¤„ï¼Œæ ¹æ®ä¸åŒçš„åˆ·ç›˜ç­–ç•¥ï¼Œæ‰§è¡Œä¼šæœ‰ä¸åŒã€‚è¯¦ç»†è§£æè§ï¼š[FlushCommitLogService](#flushcommitlogservice)ã€‚\n* ç¬¬ 143 è‡³ 173 è¡Œ ï¼š`Broker` ä¸»ä»åŒæ­¥ã€‚åé¢çš„æ–‡ç« ä¼šè¯¦ç»†è§£æğŸ˜ˆã€‚\n\n## MappedFileQueue#getLastMappedFile(...)\n\n```Java\n  1: public MappedFile getLastMappedFile(final long startOffset, boolean needCreate) {\n  2:     long createOffset = -1; // åˆ›å»ºæ–‡ä»¶å¼€å§‹offsetã€‚-1æ—¶ï¼Œä¸åˆ›å»º\n  3:     MappedFile mappedFileLast = getLastMappedFile();\n  4: \n  5:     if (mappedFileLast == null) { // ä¸€ä¸ªæ˜ å°„æ–‡ä»¶éƒ½ä¸å­˜åœ¨\n  6:         createOffset = startOffset - (startOffset % this.mappedFileSize);\n  7:     }\n  8: \n  9:     if (mappedFileLast != null && mappedFileLast.isFull()) { // æœ€åä¸€ä¸ªæ–‡ä»¶å·²æ»¡\n 10:         createOffset = mappedFileLast.getFileFromOffset() + this.mappedFileSize;\n 11:     }\n 12: \n 13:     if (createOffset != -1 && needCreate) { // åˆ›å»ºæ–‡ä»¶\n 14:         String nextFilePath = this.storePath + File.separator + UtilAll.offset2FileName(createOffset);\n 15:         String nextNextFilePath = this.storePath + File.separator\n 16:             + UtilAll.offset2FileName(createOffset + this.mappedFileSize);\n 17:         MappedFile mappedFile = null;\n 18: \n 19:         if (this.allocateMappedFileService != null) {\n 20:             mappedFile = this.allocateMappedFileService.putRequestAndReturnMappedFile(nextFilePath,\n 21:                 nextNextFilePath, this.mappedFileSize);\n 22:         } else {\n 23:             try {\n 24:                 mappedFile = new MappedFile(nextFilePath, this.mappedFileSize);\n 25:             } catch (IOException e) {\n 26:                 log.error(\"create mappedFile exception\", e);\n 27:             }\n 28:         }\n 29: \n 30:         if (mappedFile != null) {\n 31:             if (this.mappedFiles.isEmpty()) {\n 32:                 mappedFile.setFirstCreateInQueue(true);\n 33:             }\n 34:             this.mappedFiles.add(mappedFile);\n 35:         }\n 36: \n 37:         return mappedFile;\n 38:     }\n 39: \n 40:     return mappedFileLast;\n 41: }\n```\n\n* è¯´æ˜ ï¼šè·å–æœ€åä¸€ä¸ª `MappedFile`ï¼Œè‹¥ä¸å­˜åœ¨æˆ–æ–‡ä»¶å·²æ»¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚\n* ç¬¬ 5 è‡³ 11 è¡Œ ï¼šè®¡ç®—å½“æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²æ»¡æ—¶ï¼Œæ–°åˆ›å»ºæ–‡ä»¶çš„ `createOffset`ã€‚\n* ç¬¬ 14 è¡Œ ï¼šè®¡ç®—æ–‡ä»¶åã€‚ä»æ­¤å¤„æˆ‘ä»¬å¯\nä»¥å¾—çŸ¥ï¼Œ`MappedFile`çš„æ–‡ä»¶å‘½åè§„åˆ™ï¼š\n\n    > fileName[n] = fileName[n - 1] + n * mappedFileSize\n    > fileName[0] = startOffset - (startOffset % this.mappedFileSize)\n    \n    ç›®å‰ `CommitLog` çš„ `startOffset` ä¸º 0ã€‚\n    æ­¤å¤„æœ‰ä¸ª**ç–‘é—®**ï¼Œä¸ºä»€ä¹ˆéœ€è¦ `(startOffset % this.mappedFileSize)`ã€‚ä¾‹å¦‚ï¼š\n    \n    | startOffset  | mappedFileSize | createOffset |\n    | --- | :-- | :-- |\n    | 5 | 1 | 5 |\n    | 5 | 2 | 4 |\n    | 5 | 3 | 3  |\n    | 5 | 4 | 4 |\n    | 5 | > 5 | 0 |\n    \n    _å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦ï¼Œéº»çƒ¦æç¤ºä¸‹ã€‚ğŸ˜ˆ_\n    *è§£ç­”ï¼šfileName[0] = startOffset - (startOffset % this.mappedFileSize) è®¡ç®—å‡ºæ¥çš„æ˜¯ï¼Œä»¥ `this.mappedFileSize` ä¸ºæ¯ä¸ªæ–‡ä»¶å¤§å°æ—¶ï¼Œ`startOffset` æ‰€åœ¨æ–‡ä»¶çš„å¼€å§‹`offset`*\n    \n* ç¬¬ 30 è‡³ 35 è¡Œ ï¼šè®¾ç½® `MappedFile`æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªåˆ›å»ºçš„æ–‡ä»¶ã€‚è¯¥æ ‡è¯†ç”¨äº `ConsumeQueue` å¯¹åº”çš„ `MappedFile` ï¼Œè¯¦è§ `ConsumeQueue#fillPreBlank`ã€‚\n    \n## MappedFile#appendMessage(...)\n\n```Java\n  1: public AppendMessageResult appendMessage(final MessageExtBrokerInner msg, final AppendMessageCallback cb) {\n  2:     assert msg != null;\n  3:     assert cb != null;\n  4: \n  5:     int currentPos = this.wrotePosition.get();\n  6: \n  7:     if (currentPos < this.fileSize) {\n  8:         ByteBuffer byteBuffer = writeBuffer != null ? writeBuffer.slice() : this.mappedByteBuffer.slice();\n  9:         byteBuffer.position(currentPos);\n 10:         AppendMessageResult result =\n 11:             cb.doAppend(this.getFileFromOffset(), byteBuffer, this.fileSize - currentPos, msg);\n 12:         this.wrotePosition.addAndGet(result.getWroteBytes());\n 13:         this.storeTimestamp = result.getStoreTimestamp();\n 14:         return result;\n 15:     }\n 16: \n 17:     log.error(\"MappedFile.appendMessage return null, wrotePosition: \" + currentPos + \" fileSize: \"\n 18:         + this.fileSize);\n 19:     return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);\n 20: }\n```\n\n* è¯´æ˜ ï¼š**æ’å…¥æ¶ˆæ¯**åˆ° `MappedFile`ï¼Œå¹¶è¿”å›æ’å…¥ç»“æœã€‚\n* ç¬¬ 8 è¡Œ ï¼šè·å–éœ€è¦å†™å…¥çš„å­—èŠ‚ç¼“å†²åŒºã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ `writeBuffer != null` çš„åˆ¤æ–­åï¼Œä½¿ç”¨ä¸åŒçš„å­—èŠ‚ç¼“å†²åŒºï¼Œè§ï¼š[FlushCommitLogService](#flushcommitlogservice)ã€‚\n* ç¬¬ 9 è‡³ 11 è¡Œ ï¼šè®¾ç½®å†™å…¥ `position`ï¼Œæ‰§è¡Œå†™å…¥ï¼Œæ›´æ–° `wrotePosition`(å½“å‰å†™å…¥ä½ç½®ï¼Œä¸‹æ¬¡å¼€å§‹å†™å…¥å¼€å§‹ä½ç½®)ã€‚\n\n## DefaultAppendMessageCallback#doAppend(...)\n\n```Java\n  1: class DefaultAppendMessageCallback implements AppendMessageCallback {\n  2:     // File at the end of the minimum fixed length empty\n  3:     private static final int END_FILE_MIN_BLANK_LENGTH = 4 + 4;\n  4:     /**\n  5:      * å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯ç¼–å·å­—èŠ‚Buffer\n  6:      */\n  7:     private final ByteBuffer msgIdMemory;\n  8:     /**\n  9:      * Store the message content\n 10:      * å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯å­—èŠ‚Buffer\n 11:      * å½“æ¶ˆæ¯ä¼ é€’åˆ°{@link #doAppend(long, ByteBuffer, int, MessageExtBrokerInner)}æ–¹æ³•æ—¶ï¼Œæœ€ç»ˆå†™åˆ°è¯¥å‚æ•°\n 12:      */\n 13:     private final ByteBuffer msgStoreItemMemory;\n 14:     /**\n 15:      * The maximum length of the message\n 16:      * æ¶ˆæ¯æœ€å¤§é•¿åº¦\n 17:      */\n 18:     private final int maxMessageSize;\n 19:     /**\n 20:      * Build Message Key\n 21:      * {@link #topicQueueTable}çš„key\n 22:      * è®¡ç®—æ–¹å¼ï¼štopic + \"-\" + queueId\n 23:      */\n 24:     private final StringBuilder keyBuilder = new StringBuilder();\n 25:     /**\n 26:      * hostå­—èŠ‚buffer\n 27:      * ç”¨äºé‡å¤è®¡ç®—hostçš„å­—èŠ‚å†…å®¹\n 28:      */\n 29:     private final ByteBuffer hostHolder = ByteBuffer.allocate(8);\n 30: \n 31:     DefaultAppendMessageCallback(final int size) {\n 32:         this.msgIdMemory = ByteBuffer.allocate(MessageDecoder.MSG_ID_LENGTH);\n 33:         this.msgStoreItemMemory = ByteBuffer.allocate(size + END_FILE_MIN_BLANK_LENGTH);\n 34:         this.maxMessageSize = size;\n 35:     }\n 36: \n 37:     public ByteBuffer getMsgStoreItemMemory() {\n 38:         return msgStoreItemMemory;\n 39:     }\n 40: \n 41:     public AppendMessageResult doAppend(final long fileFromOffset, final ByteBuffer byteBuffer, final int maxBlank, final MessageExtBrokerInner msgInner) {\n 42:         // STORETIMESTAMP + STOREHOSTADDRESS + OFFSET <br>\n 43: \n 44:         // PHY OFFSET\n 45:         long wroteOffset = fileFromOffset + byteBuffer.position();\n 46: \n 47:         // è®¡ç®—commitLogé‡Œçš„msgId\n 48:         this.resetByteBuffer(hostHolder, 8);\n 49:         String msgId = MessageDecoder.createMessageId(this.msgIdMemory, msgInner.getStoreHostBytes(hostHolder), wroteOffset);\n 50: \n 51:         // Record ConsumeQueue information è·å–é˜Ÿåˆ—offset\n 52:         keyBuilder.setLength(0);\n 53:         keyBuilder.append(msgInner.getTopic());\n 54:         keyBuilder.append('-');\n 55:         keyBuilder.append(msgInner.getQueueId());\n 56:         String key = keyBuilder.toString();\n 57:         Long queueOffset = CommitLog.this.topicQueueTable.get(key);\n 58:         if (null == queueOffset) {\n 59:             queueOffset = 0L;\n 60:             CommitLog.this.topicQueueTable.put(key, queueOffset);\n 61:         }\n 62: \n 63:         // Transaction messages that require special handling // TODO ç–‘é—®ï¼šç”¨é€”\n 64:         final int tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());\n 65:         switch (tranType) {\n 66:             // Prepared and Rollback message is not consumed, will not enter the\n 67:             // consumer queue\n 68:             case MessageSysFlag.TRANSACTION_PREPARED_TYPE:\n 69:             case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:\n 70:                 queueOffset = 0L;\n 71:                 break;\n 72:             case MessageSysFlag.TRANSACTION_NOT_TYPE:\n 73:             case MessageSysFlag.TRANSACTION_COMMIT_TYPE:\n 74:             default:\n 75:                 break;\n 76:         }\n 77: \n 78:         // è®¡ç®—æ¶ˆæ¯é•¿åº¦\n 79:         final byte[] propertiesData =\n 80:             msgInner.getPropertiesString() == null ? null : msgInner.getPropertiesString().getBytes(MessageDecoder.CHARSET_UTF8);\n 81:         final int propertiesLength = propertiesData == null ? 0 : propertiesData.length;\n 82:         if (propertiesLength > Short.MAX_VALUE) {\n 83:             log.warn(\"putMessage message properties length too long. length={}\", propertiesData.length);\n 84:             return new AppendMessageResult(AppendMessageStatus.PROPERTIES_SIZE_EXCEEDED);\n 85:         }\n 86:         final byte[] topicData = msgInner.getTopic().getBytes(MessageDecoder.CHARSET_UTF8);\n 87:         final int topicLength = topicData.length;\n 88:         final int bodyLength = msgInner.getBody() == null ? 0 : msgInner.getBody().length;\n 89:         final int msgLen = calMsgLength(bodyLength, topicLength, propertiesLength);\n 90:         // Exceeds the maximum message\n 91:         if (msgLen > this.maxMessageSize) {\n 92:             CommitLog.log.warn(\"message size exceeded, msg total size: \" + msgLen + \", msg body size: \" + bodyLength\n 93:                 + \", maxMessageSize: \" + this.maxMessageSize);\n 94:             return new AppendMessageResult(AppendMessageStatus.MESSAGE_SIZE_EXCEEDED);\n 95:         }\n 96: \n 97:         // Determines whether there is sufficient(è¶³å¤Ÿ) free space\n 98:         if ((msgLen + END_FILE_MIN_BLANK_LENGTH) > maxBlank) {\n 99:             this.resetByteBuffer(this.msgStoreItemMemory, maxBlank);\n100:             // 1 TOTAL_SIZE\n101:             this.msgStoreItemMemory.putInt(maxBlank);\n102:             // 2 MAGIC_CODE\n103:             this.msgStoreItemMemory.putInt(CommitLog.BLANK_MAGIC_CODE);\n104:             // 3 The remaining space may be any value\n105:             //\n106: \n107:             // Here the length of the specially set maxBlank\n108:             final long beginTimeMills = CommitLog.this.defaultMessageStore.now();\n109:             byteBuffer.put(this.msgStoreItemMemory.array(), 0, maxBlank);\n110:             return new AppendMessageResult(AppendMessageStatus.END_OF_FILE, wroteOffset, maxBlank, msgId, msgInner.getStoreTimestamp(),\n111:                 queueOffset, CommitLog.this.defaultMessageStore.now() - beginTimeMills);\n112:         }\n113: \n114:         // Initialization of storage space\n115:         this.resetByteBuffer(msgStoreItemMemory, msgLen);\n116:         // 1 TOTAL_SIZE\n117:         this.msgStoreItemMemory.putInt(msgLen);\n118:         // 2 MAGIC_CODE\n119:         this.msgStoreItemMemory.putInt(CommitLog.MESSAGE_MAGIC_CODE);\n120:         // 3 BODY_CRC\n121:         this.msgStoreItemMemory.putInt(msgInner.getBodyCRC());\n122:         // 4 QUEUE_ID\n123:         this.msgStoreItemMemory.putInt(msgInner.getQueueId());\n124:         // 5 FLAG\n125:         this.msgStoreItemMemory.putInt(msgInner.getFlag());\n126:         // 6 QUEUE_OFFSET\n127:         this.msgStoreItemMemory.putLong(queueOffset);\n128:         // 7 PHYSICAL_OFFSET\n129:         this.msgStoreItemMemory.putLong(fileFromOffset + byteBuffer.position());\n130:         // 8 SYS_FLAG\n131:         this.msgStoreItemMemory.putInt(msgInner.getSysFlag());\n132:         // 9 BORN_TIMESTAMP\n133:         this.msgStoreItemMemory.putLong(msgInner.getBornTimestamp());\n134:         // 10 BORN_HOST\n135:         this.resetByteBuffer(hostHolder, 8);\n136:         this.msgStoreItemMemory.put(msgInner.getBornHostBytes(hostHolder));\n137:         // 11 STORE_TIMESTAMP\n138:         this.msgStoreItemMemory.putLong(msgInner.getStoreTimestamp());\n139:         // 12 STORE_HOST_ADDRESS\n140:         this.resetByteBuffer(hostHolder, 8);\n141:         this.msgStoreItemMemory.put(msgInner.getStoreHostBytes(hostHolder));\n142:         //this.msgStoreItemMemory.put(msgInner.getStoreHostBytes());\n143:         // 13 RECONSUME_TIMES\n144:         this.msgStoreItemMemory.putInt(msgInner.getReconsumeTimes());\n145:         // 14 Prepared Transaction Offset\n146:         this.msgStoreItemMemory.putLong(msgInner.getPreparedTransactionOffset());\n147:         // 15 BODY\n148:         this.msgStoreItemMemory.putInt(bodyLength);\n149:         if (bodyLength > 0)\n150:             this.msgStoreItemMemory.put(msgInner.getBody());\n151:         // 16 TOPIC\n152:         this.msgStoreItemMemory.put((byte) topicLength);\n153:         this.msgStoreItemMemory.put(topicData);\n154:         // 17 PROPERTIES\n155:         this.msgStoreItemMemory.putShort((short) propertiesLength);\n156:         if (propertiesLength > 0)\n157:             this.msgStoreItemMemory.put(propertiesData);\n158: \n159:         final long beginTimeMills = CommitLog.this.defaultMessageStore.now();\n160:         // Write messages to the queue buffer\n161:         byteBuffer.put(this.msgStoreItemMemory.array(), 0, msgLen);\n162: \n163:         AppendMessageResult result = new AppendMessageResult(AppendMessageStatus.PUT_OK, wroteOffset, msgLen, msgId,\n164:             msgInner.getStoreTimestamp(), queueOffset, CommitLog.this.defaultMessageStore.now() - beginTimeMills);\n165: \n166:         switch (tranType) {\n167:             case MessageSysFlag.TRANSACTION_PREPARED_TYPE:\n168:             case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:\n169:                 break;\n170:             case MessageSysFlag.TRANSACTION_NOT_TYPE:\n171:             case MessageSysFlag.TRANSACTION_COMMIT_TYPE:\n172:                 // The next update ConsumeQueue information æ›´æ–°é˜Ÿåˆ—çš„offset\n173:                 CommitLog.this.topicQueueTable.put(key, ++queueOffset);\n174:                 break;\n175:             default:\n176:                 break;\n177:         }\n178:         return result;\n179:     }\n180: \n181:     /**\n182:      * é‡ç½®å­—èŠ‚ç¼“å†²åŒº\n183:      *\n184:      * @param byteBuffer å­—èŠ‚ç¼“å†²åŒº\n185:      * @param limit é•¿åº¦\n186:      */\n187:     private void resetByteBuffer(final ByteBuffer byteBuffer, final int limit) {\n188:         byteBuffer.flip();\n189:         byteBuffer.limit(limit);\n190:     }\n191: }\n```\n* è¯´æ˜ ï¼šæ’å…¥æ¶ˆæ¯åˆ°å­—èŠ‚ç¼“å†²åŒºã€‚\n* ç¬¬ 45 è¡Œ ï¼šè®¡ç®—ç‰©ç†ä½ç½®ã€‚åœ¨ `CommitLog` çš„é¡ºåºå­˜å‚¨ä½ç½®ã€‚\n* ç¬¬ 47 è‡³ 49 è¡Œ ï¼šè®¡ç®— `CommitLog` é‡Œçš„ `offsetMsgId`ã€‚è¿™é‡Œä¸€å®šè¦å’Œ `msgId` åŒºåˆ†å¼€ã€‚\n\n|   |   | è®¡ç®—æ–¹å¼ | é•¿åº¦ | |\n| --- | --- | --- | --- |  --- |\n| offsetMsgId | Brokerå­˜å‚¨æ—¶ç”Ÿæˆ | Hex(storeHostBytes, wroteOffset) | 32 |\n| msgId | Clientå‘é€æ¶ˆæ¯æ—¶ç”Ÿæˆ | Hex(è¿›ç¨‹ç¼–å·, IP, ClassLoader, startTime, currentTime, è‡ªå¢åºåˆ—) | 32 | [ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message åŸºç¡€ã€‹](http://www.yunai.me/RocketMQ/message/) |\n\n* ç¬¬ 51 è‡³ 61 è¡Œ ï¼šè·å–é˜Ÿåˆ—ä½ç½®(offset)ã€‚\n* ç¬¬ 78 è‡³ 95 è¡Œ ï¼šè®¡ç®—æ¶ˆæ¯æ€»é•¿åº¦ã€‚\n* ç¬¬ 98 è‡³ 112 è¡Œ ï¼šå½“æ–‡ä»¶å‰©ä½™ç©ºé—´ä¸è¶³æ—¶ï¼Œå†™å…¥ `BLANK` å ä½ï¼Œè¿”å›ç»“æœã€‚\n* ç¬¬ 114 è‡³ 161 è¡Œ ï¼šå†™å…¥ `MESSAGE` ã€‚\n* ç¬¬ 173 è¡Œ ï¼šæ›´æ–°é˜Ÿåˆ—ä½ç½®(offset)ã€‚\n\n## FlushCommitLogService\n\n![FlushCommitLogServiceç±»å›¾](http://www.yunai.me/images/RocketMQ/2017_04_23/03.png)\n\n| çº¿ç¨‹æœåŠ¡ | åœºæ™¯ | æ’å…¥æ¶ˆæ¯æ€§èƒ½ |\n| --- | --- | --- |\n| CommitRealTimeService | å¼‚æ­¥åˆ·ç›˜ && å¼€å¯å†…å­˜å­—èŠ‚ç¼“å†²åŒº | ç¬¬ä¸€ |\n| FlushRealTimeService | å¼‚æ­¥åˆ·ç›˜ && å…³é—­å†…å­˜å­—èŠ‚ç¼“å†²åŒº | ç¬¬äºŒ |\n| GroupCommitService | åŒæ­¥åˆ·ç›˜ | ç¬¬ä¸‰ |\n\n### MappedFile#è½ç›˜\n\n\n| æ–¹å¼ |   |  |  |\n| --- | --- | :-- | :-- |\n| æ–¹å¼ä¸€ | å†™å…¥å†…å­˜å­—èŠ‚ç¼“å†²åŒº(writeBuffer) | ä»å†…å­˜å­—èŠ‚ç¼“å†²åŒº(write buffer)æäº¤(commit)åˆ°æ–‡ä»¶é€šé“(fileChannel) | æ–‡ä»¶é€šé“(fileChannel)flush |\n| æ–¹å¼äºŒ |  | å†™å…¥æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer) | æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer)flush  |\n\n![MappedFileçš„positionè¿ç§»å›¾](http://www.yunai.me/images/RocketMQ/2017_04_23/04.jpeg)\n\n**flushç›¸å…³ä»£ç **\n\nè€ƒè™‘åˆ°å†™å…¥æ€§èƒ½ï¼Œæ»¡è¶³ `flushLeastPages * OS_PAGE_SIZE` æ‰è¿›è¡Œ `flush`ã€‚\n\n```Java\n  1: /**\n  2:  * flush\n  3:  *\n  4:  * @param flushLeastPages flushæœ€å°é¡µæ•°\n  5:  * @return The current flushed position\n  6:  */\n  7: public int flush(final int flushLeastPages) {\n  8:     if (this.isAbleToFlush(flushLeastPages)) {\n  9:         if (this.hold()) {\n 10:             int value = getReadPosition();\n 11: \n 12:             try {\n 13:                 //We only append data to fileChannel or mappedByteBuffer, never both.\n 14:                 if (writeBuffer != null || this.fileChannel.position() != 0) {\n 15:                     this.fileChannel.force(false);\n 16:                 } else {\n 17:                     this.mappedByteBuffer.force();\n 18:                 }\n 19:             } catch (Throwable e) {\n 20:                 log.error(\"Error occurred when force data to disk.\", e);\n 21:             }\n 22: \n 23:             this.flushedPosition.set(value);\n 24:             this.release();\n 25:         } else {\n 26:             log.warn(\"in flush, hold failed, flush offset = \" + this.flushedPosition.get());\n 27:             this.flushedPosition.set(getReadPosition());\n 28:         }\n 29:     }\n 30:     return this.getFlushedPosition();\n 31: }\n 32: \n 33: /**\n 34:  * æ˜¯å¦èƒ½å¤Ÿflushã€‚æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä»»æ„æ¡ä»¶ï¼š\n 35:  * 1. æ˜ å°„æ–‡ä»¶å·²ç»å†™æ»¡\n 36:  * 2. flushLeastPages > 0 && æœªflushéƒ¨åˆ†è¶…è¿‡flushLeastPages\n 37:  * 3. flushLeastPages = 0 && æœ‰æ–°å†™å…¥éƒ¨åˆ†\n 38:  *\n 39:  * @param flushLeastPages flushæœ€å°åˆ†é¡µ\n 40:  * @return æ˜¯å¦èƒ½å¤Ÿå†™å…¥\n 41:  */\n 42: private boolean isAbleToFlush(final int flushLeastPages) {\n 43:     int flush = this.flushedPosition.get();\n 44:     int write = getReadPosition();\n 45: \n 46:     if (this.isFull()) {\n 47:         return true;\n 48:     }\n 49: \n 50:     if (flushLeastPages > 0) {\n 51:         return ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) >= flushLeastPages;\n 52:     }\n 53: \n 54:     return write > flush;\n 55: }\n```\n\n**commitç›¸å…³ä»£ç ï¼š**\n\nè€ƒè™‘åˆ°å†™å…¥æ€§èƒ½ï¼Œæ»¡è¶³ `commitLeastPages * OS_PAGE_SIZE` æ‰è¿›è¡Œ `commit`ã€‚\n\n```Java\n  1: /**\n  2:  * commit\n  3:  * å½“{@link #writeBuffer}ä¸ºnullæ—¶ï¼Œç›´æ¥è¿”å›{@link #wrotePosition}\n  4:  *\n  5:  * @param commitLeastPages commitæœ€å°é¡µæ•°\n  6:  * @return å½“å‰commitä½ç½®\n  7:  */\n  8: public int commit(final int commitLeastPages) {\n  9:     if (writeBuffer == null) {\n 10:         //no need to commit data to file channel, so just regard wrotePosition as committedPosition.\n 11:         return this.wrotePosition.get();\n 12:     }\n 13:     if (this.isAbleToCommit(commitLeastPages)) {\n 14:         if (this.hold()) {\n 15:             commit0(commitLeastPages);\n 16:             this.release();\n 17:         } else {\n 18:             log.warn(\"in commit, hold failed, commit offset = \" + this.committedPosition.get());\n 19:         }\n 20:     }\n 21: \n 22:     // All dirty data has been committed to FileChannel. å†™åˆ°æ–‡ä»¶å°¾æ—¶ï¼Œå›æ”¶writeBufferã€‚\n 23:     if (writeBuffer != null && this.transientStorePool != null && this.fileSize == this.committedPosition.get()) {\n 24:         this.transientStorePool.returnBuffer(writeBuffer);\n 25:         this.writeBuffer = null;\n 26:     }\n 27: \n 28:     return this.committedPosition.get();\n 29: }\n 30: \n 31: /**\n 32:  * commitå®ç°ï¼Œå°†writeBufferå†™å…¥fileChannelã€‚\n 33:  * @param commitLeastPages commitæœ€å°é¡µæ•°ã€‚ç”¨ä¸ä¸Šè¯¥å‚æ•°\n 34:  */\n 35: protected void commit0(final int commitLeastPages) {\n 36:     int writePos = this.wrotePosition.get();\n 37:     int lastCommittedPosition = this.committedPosition.get();\n 38: \n 39:     if (writePos - this.committedPosition.get() > 0) {\n 40:         try {\n 41:             // è®¾ç½®éœ€è¦å†™å…¥çš„byteBuffer\n 42:             ByteBuffer byteBuffer = writeBuffer.slice();\n 43:             byteBuffer.position(lastCommittedPosition);\n 44:             byteBuffer.limit(writePos);\n 45:             // å†™å…¥fileChannel\n 46:             this.fileChannel.position(lastCommittedPosition);\n 47:             this.fileChannel.write(byteBuffer);\n 48:             // è®¾ç½®position\n 49:             this.committedPosition.set(writePos);\n 50:         } catch (Throwable e) {\n 51:             log.error(\"Error occurred when commit data to FileChannel.\", e);\n 52:         }\n 53:     }\n 54: }\n 55: \n 56: /**\n 57:  * æ˜¯å¦èƒ½å¤Ÿcommitã€‚æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä»»æ„æ¡ä»¶ï¼š\n 58:  * 1. æ˜ å°„æ–‡ä»¶å·²ç»å†™æ»¡\n 59:  * 2. commitLeastPages > 0 && æœªcommitéƒ¨åˆ†è¶…è¿‡commitLeastPages\n 60:  * 3. commitLeastPages = 0 && æœ‰æ–°å†™å…¥éƒ¨åˆ†\n 61:  *\n 62:  * @param commitLeastPages commitæœ€å°åˆ†é¡µ\n 63:  * @return æ˜¯å¦èƒ½å¤Ÿå†™å…¥\n 64:  */\n 65: protected boolean isAbleToCommit(final int commitLeastPages) {\n 66:     int flush = this.committedPosition.get();\n 67:     int write = this.wrotePosition.get();\n 68: \n 69:     if (this.isFull()) {\n 70:         return true;\n 71:     }\n 72: \n 73:     if (commitLeastPages > 0) {\n 74:         return ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) >= commitLeastPages;\n 75:     }\n 76: \n 77:     return write > flush;\n 78: }\n```\n\n### FlushRealTimeService\n\næ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚\n\n```Java\n  1: class FlushRealTimeService extends FlushCommitLogService {\n  2:     /**\n  3:      * æœ€åflushæ—¶é—´æˆ³\n  4:      */\n  5:     private long lastFlushTimestamp = 0;\n  6:     /**\n  7:      * printè®¡æ—¶å™¨ã€‚\n  8:      * æ»¡è¶³printæ¬¡æ•°æ—¶ï¼Œè°ƒç”¨{@link #printFlushProgress()}\n  9:      */\n 10:     private long printTimes = 0;\n 11: \n 12:     public void run() {\n 13:         CommitLog.log.info(this.getServiceName() + \" service started\");\n 14: \n 15:         while (!this.isStopped()) {\n 16:             boolean flushCommitLogTimed = CommitLog.this.defaultMessageStore.getMessageStoreConfig().isFlushCommitLogTimed();\n 17:             int interval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushIntervalCommitLog();\n 18:             int flushPhysicQueueLeastPages = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogLeastPages();\n 19:             int flushPhysicQueueThoroughInterval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogThoroughInterval();\n 20: \n 21:             // Print flush progress\n 22:             // å½“æ—¶é—´æ»¡è¶³flushPhysicQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushPhysicQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush\n 23:             boolean printFlushProgress = false;\n 24:             long currentTimeMillis = System.currentTimeMillis();\n 25:             if (currentTimeMillis >= (this.lastFlushTimestamp + flushPhysicQueueThoroughInterval)) {\n 26:                 this.lastFlushTimestamp = currentTimeMillis;\n 27:                 flushPhysicQueueLeastPages = 0;\n 28:                 printFlushProgress = (printTimes++ % 10) == 0;\n 29:             }\n 30: \n 31:             try {\n 32:                 // ç­‰å¾…æ‰§è¡Œ\n 33:                 if (flushCommitLogTimed) {\n 34:                     Thread.sleep(interval);\n 35:                 } else {\n 36:                     this.waitForRunning(interval);\n 37:                 }\n 38: \n 39:                 if (printFlushProgress) {\n 40:                     this.printFlushProgress();\n 41:                 }\n 42: \n 43:                 // flush commitLog\n 44:                 long begin = System.currentTimeMillis();\n 45:                 CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages);\n 46:                 long storeTimestamp = CommitLog.this.mappedFileQueue.getStoreTimestamp();\n 47:                 if (storeTimestamp > 0) {\n 48:                     CommitLog.this.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);\n 49:                 }\n 50:                 long past = System.currentTimeMillis() - begin;\n 51:                 if (past > 500) {\n 52:                     log.info(\"Flush data to disk costs {} ms\", past);\n 53:                 }\n 54:             } catch (Throwable e) {\n 55:                 CommitLog.log.warn(this.getServiceName() + \" service has exception. \", e);\n 56:                 this.printFlushProgress();\n 57:             }\n 58:         }\n 59: \n 60:         // Normal shutdown, to ensure that all the flush before exit\n 61:         boolean result = false;\n 62:         for (int i = 0; i < RETRY_TIMES_OVER && !result; i++) {\n 63:             result = CommitLog.this.mappedFileQueue.flush(0);\n 64:             CommitLog.log.info(this.getServiceName() + \" service shutdown, retry \" + (i + 1) + \" times \" + (result ? \"OK\" : \"Not OK\"));\n 65:         }\n 66: \n 67:         this.printFlushProgress();\n 68: \n 69:         CommitLog.log.info(this.getServiceName() + \" service end\");\n 70:     }\n 71: \n 72:     @Override\n 73:     public String getServiceName() {\n 74:         return FlushRealTimeService.class.getSimpleName();\n 75:     }\n 76: \n 77:     private void printFlushProgress() {\n 78:         // CommitLog.log.info(\"how much disk fall behind memory, \"\n 79:         // + CommitLog.this.mappedFileQueue.howMuchFallBehind());\n 80:     }\n 81: \n 82:     @Override\n 83:     @SuppressWarnings(\"SpellCheckingInspection\")\n 84:     public long getJointime() {\n 85:         return 1000 * 60 * 5;\n 86:     }\n 87: }\n```\n\n* è¯´æ˜ï¼šå®æ—¶ `flush `çº¿ç¨‹æœåŠ¡ï¼Œè°ƒç”¨ `MappedFile#flush` ç›¸å…³é€»è¾‘ã€‚\n* ç¬¬ 23 è‡³ 29 è¡Œ ï¼šæ¯ `flushPhysicQueueThoroughInterval` å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ `flush` ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ `flushCommitLogLeastPages` å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ `flush` ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ `flush`ï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚\n* ç¬¬ 33 è¡Œ è‡³ 37 è¡Œ ï¼šæ ¹æ® `flushCommitLogTimed` å‚æ•°ï¼Œå¯ä»¥é€‰æ‹©æ¯æ¬¡å¾ªç¯æ˜¯**å›ºå®šå‘¨æœŸ**è¿˜æ˜¯**ç­‰å¾…å”¤é†’**ã€‚é»˜è®¤é…ç½®æ˜¯åè€…ï¼Œæ‰€ä»¥ï¼Œæ¯æ¬¡æ’å…¥æ¶ˆæ¯å®Œæˆï¼Œä¼šå»è°ƒç”¨ `commitLogService.wakeup()` ã€‚\n* ç¬¬ 45 è¡Œ ï¼šè°ƒç”¨ `MappedFile` è¿›è¡Œ `flush`ã€‚\n* ç¬¬ 61 è‡³ 65 è¡Œ ï¼š`Broker` å…³é—­æ—¶ï¼Œå¼ºåˆ¶ `flush`ï¼Œé¿å…æœ‰æœªåˆ·ç›˜çš„æ•°æ®ã€‚\n\n### CommitRealTimeService\n\næ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚\nå’Œ `FlushRealTimeService` ç±»ä¼¼ï¼Œæ€§èƒ½æ›´å¥½ã€‚\n\n```Java\n  1: class CommitRealTimeService extends FlushCommitLogService {\n  2: \n  3:     /**\n  4:      * æœ€å commit æ—¶é—´æˆ³\n  5:      */\n  6:     private long lastCommitTimestamp = 0;\n  7: \n  8:     @Override\n  9:     public String getServiceName() {\n 10:         return CommitRealTimeService.class.getSimpleName();\n 11:     }\n 12: \n 13:     @Override\n 14:     public void run() {\n 15:         CommitLog.log.info(this.getServiceName() + \" service started\");\n 16:         while (!this.isStopped()) {\n 17:             int interval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitIntervalCommitLog();\n 18:             int commitDataLeastPages = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogLeastPages();\n 19:             int commitDataThoroughInterval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogThoroughInterval();\n 20: \n 21:             // å½“æ—¶é—´æ»¡è¶³commitDataThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³commitDataLeastPagesï¼Œä¹Ÿè¿›è¡Œflush\n 22:             long begin = System.currentTimeMillis();\n 23:             if (begin >= (this.lastCommitTimestamp + commitDataThoroughInterval)) {\n 24:                 this.lastCommitTimestamp = begin;\n 25:                 commitDataLeastPages = 0;\n 26:             }\n 27: \n 28:             try {\n 29:                 // commit\n 30:                 boolean result = CommitLog.this.mappedFileQueue.commit(commitDataLeastPages);\n 31:                 long end = System.currentTimeMillis();\n 32:                 if (!result) { // TODO ç–‘é—®ï¼šæœªå†™å…¥æˆåŠŸï¼Œä¸ºå•¥è¦å”¤é†’flushCommitLogService\n 33:                     this.lastCommitTimestamp = end; // result = false means some data committed.\n 34:                     //now wake up flush thread.\n 35:                     flushCommitLogService.wakeup();\n 36:                 }\n 37: \n 38:                 if (end - begin > 500) {\n 39:                     log.info(\"Commit data to file costs {} ms\", end - begin);\n 40:                 }\n 41: \n 42:                 // ç­‰å¾…æ‰§è¡Œ\n 43:                 this.waitForRunning(interval);\n 44:             } catch (Throwable e) {\n 45:                 CommitLog.log.error(this.getServiceName() + \" service has exception. \", e);\n 46:             }\n 47:         }\n 48: \n 49:         boolean result = false;\n 50:         for (int i = 0; i < RETRY_TIMES_OVER && !result; i++) {\n 51:             result = CommitLog.this.mappedFileQueue.commit(0);\n 52:             CommitLog.log.info(this.getServiceName() + \" service shutdown, retry \" + (i + 1) + \" times \" + (result ? \"OK\" : \"Not OK\"));\n 53:         }\n 54:         CommitLog.log.info(this.getServiceName() + \" service end\");\n 55:     }\n 56: }\n```\n\n### GroupCommitService\n\næ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼ŒåŒæ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚\n\n```Java\n  1: class GroupCommitService extends FlushCommitLogService {\n  2:     /**\n  3:      * å†™å…¥è¯·æ±‚é˜Ÿåˆ—\n  4:      */\n  5:     private volatile List<GroupCommitRequest> requestsWrite = new ArrayList<>();\n  6:     /**\n  7:      * è¯»å–è¯·æ±‚é˜Ÿåˆ—\n  8:      */\n  9:     private volatile List<GroupCommitRequest> requestsRead = new ArrayList<>();\n 10: \n 11:     /**\n 12:      * æ·»åŠ å†™å…¥è¯·æ±‚\n 13:      *\n 14:      * @param request å†™å…¥è¯·æ±‚\n 15:      */\n 16:     public synchronized void putRequest(final GroupCommitRequest request) {\n 17:         // æ·»åŠ å†™å…¥è¯·æ±‚\n 18:         synchronized (this.requestsWrite) {\n 19:             this.requestsWrite.add(request);\n 20:         }\n 21:         // åˆ‡æ¢è¯»å†™é˜Ÿåˆ—\n 22:         if (hasNotified.compareAndSet(false, true)) {\n 23:             waitPoint.countDown(); // notify\n 24:         }\n 25:     }\n 26: \n 27:     /**\n 28:      * åˆ‡æ¢è¯»å†™é˜Ÿåˆ—\n 29:      */\n 30:     private void swapRequests() {\n 31:         List<GroupCommitRequest> tmp = this.requestsWrite;\n 32:         this.requestsWrite = this.requestsRead;\n 33:         this.requestsRead = tmp;\n 34:     }\n 35: \n 36:     private void doCommit() {\n 37:         synchronized (this.requestsRead) {\n 38:             if (!this.requestsRead.isEmpty()) {\n 39:                 for (GroupCommitRequest req : this.requestsRead) {\n 40:                     // There may be a message in the next file, so a maximum of\n 41:                     // two times the flush (å¯èƒ½æ‰¹é‡æäº¤çš„messagesï¼Œåˆ†å¸ƒåœ¨ä¸¤ä¸ªMappedFile)\n 42:                     boolean flushOK = false;\n 43:                     for (int i = 0; i < 2 && !flushOK; i++) {\n 44:                         // æ˜¯å¦æ»¡è¶³éœ€è¦flushæ¡ä»¶ï¼Œå³è¯·æ±‚çš„offsetè¶…è¿‡flushçš„offset\n 45:                         flushOK = CommitLog.this.mappedFileQueue.getFlushedWhere() >= req.getNextOffset();\n 46:                         if (!flushOK) {\n 47:                             CommitLog.this.mappedFileQueue.flush(0);\n 48:                         }\n 49:                     }\n 50:                     // å”¤é†’ç­‰å¾…è¯·æ±‚\n 51:                     req.wakeupCustomer(flushOK);\n 52:                 }\n 53: \n 54:                 long storeTimestamp = CommitLog.this.mappedFileQueue.getStoreTimestamp();\n 55:                 if (storeTimestamp > 0) {\n 56:                     CommitLog.this.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);\n 57:                 }\n 58: \n 59:                 // æ¸…ç†è¯»å–é˜Ÿåˆ—\n 60:                 this.requestsRead.clear();\n 61:             } else {\n 62:                 // Because of individual messages is set to not sync flush, it\n 63:                 // will come to this process ä¸åˆæ³•çš„è¯·æ±‚ï¼Œæ¯”å¦‚messageä¸Šæœªè®¾ç½®isWaitStoreMsgOKã€‚\n 64:                 // èµ°åˆ°æ­¤å¤„çš„é€»è¾‘ï¼Œç›¸å½“äºå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè½ç›˜ä¸€æ¡æ¶ˆæ¯ï¼Œå®é™…æ— æ‰¹é‡æäº¤çš„æ•ˆæœã€‚\n 65:                 CommitLog.this.mappedFileQueue.flush(0);\n 66:             }\n 67:         }\n 68:     }\n 69: \n 70:     public void run() {\n 71:         CommitLog.log.info(this.getServiceName() + \" service started\");\n 72: \n 73:         while (!this.isStopped()) {\n 74:             try {\n 75:                 this.waitForRunning(10);\n 76:                 this.doCommit();\n 77:             } catch (Exception e) {\n 78:                 CommitLog.log.warn(this.getServiceName() + \" service has exception. \", e);\n 79:             }\n 80:         }\n 81: \n 82:         // Under normal circumstances shutdown, wait for the arrival of the\n 83:         // request, and then flush\n 84:         try {\n 85:             Thread.sleep(10);\n 86:         } catch (InterruptedException e) {\n 87:             CommitLog.log.warn(\"GroupCommitService Exception, \", e);\n 88:         }\n 89: \n 90:         synchronized (this) {\n 91:             this.swapRequests();\n 92:         }\n 93: \n 94:         this.doCommit();\n 95: \n 96:         CommitLog.log.info(this.getServiceName() + \" service end\");\n 97:     }\n 98: \n 99:     /**\n100:      * æ¯æ¬¡æ‰§è¡Œå®Œï¼Œåˆ‡æ¢è¯»å†™é˜Ÿåˆ—\n101:      */\n102:     @Override\n103:     protected void onWaitEnd() {\n104:         this.swapRequests();\n105:     }\n106: \n107:     @Override\n108:     public String getServiceName() {\n109:         return GroupCommitService.class.getSimpleName();\n110:     }\n111: \n112:     @Override\n113:     public long getJointime() {\n114:         return 1000 * 60 * 5;\n115:     }\n116: }\n```\n\n* è¯´æ˜ï¼šæ‰¹é‡å†™å…¥çº¿ç¨‹æœåŠ¡ã€‚\n* ç¬¬ 16 è‡³ 25 è¡Œ ï¼šæ·»åŠ å†™å…¥è¯·æ±‚ã€‚æ–¹æ³•è®¾ç½®äº† `sync` çš„åŸå› ï¼š`this.requestsWrite` ä¼šå’Œ `this.requestsRead` ä¸æ–­äº¤æ¢ï¼Œæ— æ³•ä¿è¯ç¨³å®šçš„åŒæ­¥ã€‚\n* ç¬¬ 27 è‡³ 34 è¡Œ ï¼šè¯»å†™é˜Ÿåˆ—äº¤æ¢ã€‚\n* ç¬¬ 38 è‡³ 60 è¡Œ ï¼šå¾ªç¯å†™å…¥é˜Ÿåˆ—ï¼Œè¿›è¡Œ `flush`ã€‚\n    * ç¬¬ 43 è¡Œ ï¼šè€ƒè™‘åˆ°æœ‰å¯èƒ½æ¯æ¬¡å¾ªç¯çš„æ¶ˆæ¯å†™å…¥çš„æ¶ˆæ¯ï¼Œå¯èƒ½åˆ†å¸ƒåœ¨**ä¸¤ä¸ª** `MappedFile`(å†™ç¬¬Nä¸ªæ¶ˆæ¯æ—¶ï¼Œ`MappedFile` å·²æ»¡ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„)ï¼Œæ‰€ä»¥éœ€è¦æœ‰å¾ªç¯2æ¬¡ã€‚\n    * ç¬¬ 51 è¡Œ ï¼šå”¤é†’ç­‰å¾…å†™å…¥è¯·æ±‚çº¿ç¨‹ï¼Œé€šè¿‡ `CountDownLatch` å®ç°ã€‚\n* ç¬¬ 61 è‡³ 66 è¡Œ ï¼šç›´æ¥åˆ·ç›˜ã€‚æ­¤å¤„æ˜¯ç”±äºå‘é€çš„æ¶ˆæ¯çš„ `isWaitStoreMsgOK` æœªè®¾ç½®æˆ `TRUE` ï¼Œå¯¼è‡´æœªèµ°æ‰¹é‡æäº¤ã€‚\n* ç¬¬ 73 è‡³ 80 è¡Œ ï¼šæ¯ 10ms æ‰§è¡Œä¸€æ¬¡æ‰¹é‡æäº¤ã€‚å½“ç„¶ï¼Œå¦‚æœ `wakeup()` æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡æ‰¹é‡æäº¤ã€‚å½“ `Broker` è®¾ç½®æˆåŒæ­¥è½ç›˜ && æ¶ˆæ¯ `isWaitStoreMsgOK=true`ï¼Œæ¶ˆæ¯éœ€è¦ç•¥å¤§äº 10ms æ‰èƒ½å‘é€æˆåŠŸã€‚å½“ç„¶ï¼Œæ€§èƒ½ç›¸å¯¹å¼‚æ­¥è½ç›˜è¾ƒå·®ï¼Œå¯é æ€§æ›´é«˜ï¼Œéœ€è¦æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨æ—¶å»å–èˆã€‚ \n\n\n# ç»“å°¾\n\nå†™çš„ç¬¬äºŒç¯‡ä¸RocketMQæºç ç›¸å…³çš„åšæ–‡ï¼Œçœ‹åˆ°æœ‰é˜…è¯»ã€ç‚¹èµã€æ”¶è—ç”šè‡³è®¢é˜…ï¼Œå¾ˆå—é¼“èˆã€‚\n\nã€ŠMessageå­˜å‚¨ã€‹æ¯”èµ·ã€ŠMessageå‘é€&æ¥æ”¶ã€‹ä»éš¾åº¦ä¸Šè¯´æ˜¯æ›´å¤§çš„ï¼Œå½“ç„¶ä¹Ÿæ˜¯æ›´æœ‰è¶£çš„ï¼Œå¦‚æœå­˜åœ¨ç†è§£é”™è¯¯æˆ–è€…è¡¨è¾¾ä¸æ¸…æ™°ï¼Œè¿˜è¯·å¤§å®¶å¤šå¤šåŒ…å«ã€‚å¦‚æœå¯ä»¥çš„è¯ï¼Œè¿˜è¯·éº»çƒ¦æ·»åŠ  QQï¼š7685413 è¿›è¡ŒæŒ‡å‡ºï¼Œé¿å…è‡ªå·±çš„ç†è§£é”™è¯¯ï¼Œç»™å¤§å®¶é€ æˆå›°æ‰°ã€‚\n\næ¨è[ã€ŠKafkaè®¾è®¡è§£æï¼ˆå…­ï¼‰- Kafkaé«˜æ€§èƒ½æ¶æ„ä¹‹é“ã€‹](http://www.jasongj.com/kafka/high_throughput/?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)ï¼Œä½œè€…ç«™åœ¨çš„é«˜åº¦æ¯”æˆ‘é«˜çš„å¤šçš„å¤šï¼Œå—¯ï¼ŒæŒ‰ç…§æå°ç’çš„è¯´æ³•ï¼šé«˜ä¸€ä¸ªå–œé©¬æ‹‰é›…å±±ã€‚ğŸ˜ˆè®¤çœŸå•ƒè¯»ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°(åŸä¹¦ç¬¬3ç‰ˆ)ã€‹ï¼Œday day upã€‚\n\nå†æ¬¡æ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ã€ç‚¹èµã€æ”¶è—ã€‚\n\nä¸‹ä¸€ç¯‡ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ã€‹](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/) èµ·èˆªï¼\n\n\n","source":"_posts/RocketMQ/2017_04_23_RocketMQæºç åˆ†æâ€”â€”Messageå­˜å‚¨.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Message å­˜å‚¨\ndate: 2017-04-23\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/message-store\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[http://www.yunai.me/RocketMQ/message-store/](http://www.yunai.me/RocketMQ/message-store/)  \n> `RocketMQ` **å¸¦æ³¨é‡Šæºç **åœ°å€ ï¼š[https://github.com/YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **  \n\n![wechat_mp](http://www.yunai.me/images/common/wechat_mp.jpeg)\n\n-------\n\n- [1ã€æ¦‚è¿°](#)\n- [2ã€CommitLog ç»“æ„](#)\n- [3ã€CommitLog å­˜å‚¨æ¶ˆæ¯](#)\n\t- [CommitLog#putMessage(...)](#)\n\t- [MappedFileQueue#getLastMappedFile(...)](#)\n\t- [MappedFile#appendMessage(...)](#)\n\t- [DefaultAppendMessageCallback#doAppend(...)](#)\n\t- [FlushCommitLogService](#)\n\t\t- [MappedFile#è½ç›˜](#)\n\t\t- [FlushRealTimeService](#)\n\t\t- [CommitRealTimeService](#)\n\t\t- [GroupCommitService](#)\n- [ç»“å°¾](#)\n\n# 1ã€æ¦‚è¿°\n\næœ¬æ–‡æ¥[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶ã€‹](http://www.yunai.me/RocketMQ/message-send-and-receive/)ã€‚\nä¸»è¦è§£æ `CommitLog` å­˜å‚¨æ¶ˆæ¯éƒ¨åˆ†ã€‚\n\n# 2ã€CommitLog ç»“æ„\n\n`CommitLog`ã€`MappedFileQueue`ã€`MappedFile` çš„å…³ç³»å¦‚ä¸‹ï¼š\n\n> ![CommitLogã€MappedFileQueueã€MappedFileçš„å…³ç³»](http://www.yunai.me/images/RocketMQ/2017_04_23/02.png)\n`CommitLog` : `MappedFileQueue` : `MappedFile` = 1 : 1 : Nã€‚\n\nååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š\n\n```bash\nYunai-MacdeMacBook-Pro-2:commitlog yunai$ pwd\n/Users/yunai/store/commitlog\nYunai-MacdeMacBook-Pro-2:commitlog yunai$ ls -l\ntotal 10485760\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:27 00000000000000000000\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:29 00000000001073741824\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:32 00000000002147483648\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:33 00000000003221225472\n-rw-r--r--  1 yunai  staff  1073741824  4 21 16:32 00000000004294967296\n```\n\n-------\n\n`CommitLog`ã€`MappedFileQueue`ã€`MappedFile` çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n* `MappedFile` ï¼š00000000000000000000ã€00000000001073741824ã€00000000002147483648ç­‰æ–‡ä»¶ã€‚\n* `MappedFileQueue` ï¼š`MappedFile` æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ `MappedFile` è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚\n    * æ¯ä¸ª `MappedFile` ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚\n    * æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ `CommitLog` é‡Œé»˜è®¤ä¸º 1GBã€‚\n* `CommitLog` ï¼šé’ˆå¯¹ `MappedFileQueue` çš„å°è£…ä½¿ç”¨ã€‚\n\n`CommitLog` ç›®å‰å­˜å‚¨åœ¨ `MappedFile` æœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š\n\n1. MESSAGE ï¼šæ¶ˆæ¯ã€‚\n2. BLANK ï¼šæ–‡ä»¶ä¸è¶³ä»¥å­˜å‚¨æ¶ˆæ¯æ—¶çš„ç©ºç™½å ä½ã€‚\n\n`CommitLog` å­˜å‚¨åœ¨ `MappedFile`çš„ç»“æ„ï¼š\n\n> | MESSAGE[1] | MESSAGE[2]  | ... | MESSAGE[n - 1] | MESSAGE[n] | BLANK |\n> | --- | --- | --- | --- | --- | --- |\n\n`MESSAGE` åœ¨ `CommitLog` å­˜å‚¨ç»“æ„ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | MsgLen | æ¶ˆæ¯æ€»é•¿åº¦ | Int | 4 |\n| 2 | MagicCode | MESSAGE_MAGIC_CODE | Int | 4 |\n| 3 | BodyCRC | æ¶ˆæ¯å†…å®¹CRC | Int | 4 |\n| 4 | QueueId | æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· | Int | 4 |\n| 5 | Flag |  flag | Int  | 4 |\n| 6 | QueueOffset | æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® | Long | 8 |\n| 7 | PhysicalOffset | ç‰©ç†ä½ç½®ã€‚åœ¨ `CommitLog` çš„é¡ºåºå­˜å‚¨ä½ç½®ã€‚ | Long | 8 |\n| 8 | SysFlag | MessageSysFlag | Int | 4 |\n| 9 | BornTimestamp | ç”Ÿæˆæ¶ˆæ¯æ—¶é—´æˆ³ | Long | 8 |\n| 10 | BornHost  | ç”Ÿæ•ˆæ¶ˆæ¯çš„åœ°å€+ç«¯å£ | Long | 8 |\n| 11 | StoreTimestamp | å­˜å‚¨æ¶ˆæ¯æ—¶é—´æˆ³ | Long | 8 |\n| 12 | StoreHost | å­˜å‚¨æ¶ˆæ¯çš„åœ°å€+ç«¯å£ | Long | 8 |\n| 13 | ReconsumeTimes | é‡æ–°æ¶ˆè´¹æ¶ˆæ¯æ¬¡æ•° | Int | 4 |\n| 14 | PreparedTransationOffset |  | Long | 8 |\n| 15 | BodyLength + Body  | å†…å®¹é•¿åº¦ + å†…å®¹ | Int + Bytes | 4 + bodyLength |\n| 16 | TopicLength + Topic | Topicé•¿åº¦ + Topic | Byte + Bytes | 1 + topicLength |\n| 17 | PropertiesLength + Properties | æ‹“å±•å­—æ®µé•¿åº¦ + æ‹“å±•å­—æ®µ | Short + Bytes | 2 + PropertiesLength |\n\n`BLANK` åœ¨ `CommitLog` å­˜å‚¨ç»“æ„ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | maxBlank | ç©ºç™½é•¿åº¦ | Int | 4 |\n| 2 | MagicCode | BLANK_MAGIC_CODE | Int | 4 |\n\n# 3ã€CommitLog å­˜å‚¨æ¶ˆæ¯\n\n> ![Brokerå­˜å‚¨å‘é€æ¶ˆæ¯é¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_04_23/01.png)\n\n## CommitLog#putMessage(...)\n\n```Java\n  1: public PutMessageResult putMessage(final MessageExtBrokerInner msg) {\n  2:     // Set the storage time\n  3:     msg.setStoreTimestamp(System.currentTimeMillis());\n  4:     // Set the message body BODY CRC (consider the most appropriate setting\n  5:     // on the client)\n  6:     msg.setBodyCRC(UtilAll.crc32(msg.getBody()));\n  7:     // Back to Results\n  8:     AppendMessageResult result = null;\n  9: \n 10:     StoreStatsService storeStatsService = this.defaultMessageStore.getStoreStatsService();\n 11: \n 12:     String topic = msg.getTopic();\n 13:     int queueId = msg.getQueueId();\n 14: \n 15:     // äº‹åŠ¡ç›¸å…³ TODO å¾…è¯»ï¼šäº‹åŠ¡ç›¸å…³\n 16:     final int tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());\n 17:     if (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE//\n 18:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) {\n 19:         // Delay Delivery\n 20:         if (msg.getDelayTimeLevel() > 0) {\n 21:             if (msg.getDelayTimeLevel() > this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) {\n 22:                 msg.setDelayTimeLevel(this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());\n 23:             }\n 24: \n 25:             topic = ScheduleMessageService.SCHEDULE_TOPIC;\n 26:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());\n 27: \n 28:             // Backup real topic, queueId\n 29:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());\n 30:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));\n 31:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));\n 32: \n 33:             msg.setTopic(topic);\n 34:             msg.setQueueId(queueId);\n 35:         }\n 36:     }\n 37: \n 38:     long eclipseTimeInLock = 0;\n 39: \n 40:     // è·å–å†™å…¥æ˜ å°„æ–‡ä»¶\n 41:     MappedFile unlockMappedFile = null;\n 42:     MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile();\n 43: \n 44:     // è·å–å†™å…¥é”\n 45:     lockForPutMessage(); //spin...\n 46:     try {\n 47:         long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();\n 48:         this.beginTimeInLock = beginLockTimestamp;\n 49: \n 50:         // Here settings are stored timestamp, in order to ensure an orderly\n 51:         // global\n 52:         msg.setStoreTimestamp(beginLockTimestamp);\n 53: \n 54:         // å½“ä¸å­˜åœ¨æ˜ å°„æ–‡ä»¶æ—¶ï¼Œè¿›è¡Œåˆ›å»º\n 55:         if (null == mappedFile || mappedFile.isFull()) {\n 56:             mappedFile = this.mappedFileQueue.getLastMappedFile(0); // Mark: NewFile may be cause noise\n 57:         }\n 58:         if (null == mappedFile) {\n 59:             log.error(\"create maped file1 error, topic: \" + msg.getTopic() + \" clientAddr: \" + msg.getBornHostString());\n 60:             beginTimeInLock = 0;\n 61:             return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, null);\n 62:         }\n 63: \n 64:         // å­˜å‚¨æ¶ˆæ¯\n 65:         result = mappedFile.appendMessage(msg, this.appendMessageCallback);\n 66:         switch (result.getStatus()) {\n 67:             case PUT_OK:\n 68:                 break;\n 69:             case END_OF_FILE: // å½“æ–‡ä»¶å°¾æ—¶ï¼Œè·å–æ–°çš„æ˜ å°„æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œæ’å…¥\n 70:                 unlockMappedFile = mappedFile;\n 71:                 // Create a new file, re-write the message\n 72:                 mappedFile = this.mappedFileQueue.getLastMappedFile(0);\n 73:                 if (null == mappedFile) {\n 74:                     // XXX: warn and notify me\n 75:                     log.error(\"create maped file2 error, topic: \" + msg.getTopic() + \" clientAddr: \" + msg.getBornHostString());\n 76:                     beginTimeInLock = 0;\n 77:                     return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);\n 78:                 }\n 79:                 result = mappedFile.appendMessage(msg, this.appendMessageCallback);\n 80:                 break;\n 81:             case MESSAGE_SIZE_EXCEEDED:\n 82:             case PROPERTIES_SIZE_EXCEEDED:\n 83:                 beginTimeInLock = 0;\n 84:                 return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);\n 85:             case UNKNOWN_ERROR:\n 86:                 beginTimeInLock = 0;\n 87:                 return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);\n 88:             default:\n 89:                 beginTimeInLock = 0;\n 90:                 return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);\n 91:         }\n 92: \n 93:         eclipseTimeInLock = this.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;\n 94:         beginTimeInLock = 0;\n 95:     } finally {\n 96:         // é‡Šæ”¾å†™å…¥é”\n 97:         releasePutMessageLock();\n 98:     }\n 99: \n100:     if (eclipseTimeInLock > 500) {\n101:         log.warn(\"[NOTIFYME]putMessage in lock cost time(ms)={}, bodyLength={} AppendMessageResult={}\", eclipseTimeInLock, msg.getBody().length, result);\n102:     }\n103: \n104:     // \n105:     if (null != unlockMappedFile && this.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) {\n106:         this.defaultMessageStore.unlockMappedFile(unlockMappedFile);\n107:     }\n108: \n109:     PutMessageResult putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result);\n110: \n111:     // Statistics\n112:     storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).incrementAndGet();\n113:     storeStatsService.getSinglePutMessageTopicSizeTotal(topic).addAndGet(result.getWroteBytes());\n114: \n115:     // è¿›è¡ŒåŒæ­¥||å¼‚æ­¥ flush||commit\n116:     GroupCommitRequest request = null;\n117:     // Synchronization flush\n118:     if (FlushDiskType.SYNC_FLUSH == this.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) {\n119:         final GroupCommitService service = (GroupCommitService) this.flushCommitLogService;\n120:         if (msg.isWaitStoreMsgOK()) {\n121:             request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());\n122:             service.putRequest(request);\n123:             boolean flushOK = request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());\n124:             if (!flushOK) {\n125:                 log.error(\"do groupcommit, wait for flush failed, topic: \" + msg.getTopic() + \" tags: \" + msg.getTags()\n126:                     + \" client address: \" + msg.getBornHostString());\n127:                 putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);\n128:             }\n129:         } else {\n130:             service.wakeup();\n131:         }\n132:     }\n133:     // Asynchronous flush\n134:     else {\n135:         if (!this.defaultMessageStore.getMessageStoreConfig().isTransientStorePoolEnable()) {\n136:             flushCommitLogService.wakeup(); // importantï¼šå”¤é†’commitLogçº¿ç¨‹ï¼Œè¿›è¡Œflush\n137:         } else {\n138:             commitLogService.wakeup();\n139:         }\n140:     }\n141: \n142:     // Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹ // TODO å¾…è¯»ï¼šæ•°æ®åŒæ­¥\n143:     if (BrokerRole.SYNC_MASTER == this.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) {\n144:         HAService service = this.defaultMessageStore.getHaService();\n145:         if (msg.isWaitStoreMsgOK()) {\n146:             // Determine whether to wait\n147:             if (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) {\n148:                 if (null == request) {\n149:                     request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());\n150:                 }\n151:                 service.putRequest(request);\n152: \n153:                 service.getWaitNotifyObject().wakeupAll();\n154: \n155:                 boolean flushOK =\n156:                     // TODO\n157:                     request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());\n158:                 if (!flushOK) {\n159:                     log.error(\"do sync transfer other node, wait return, but failed, topic: \" + msg.getTopic() + \" tags: \"\n160:                         + msg.getTags() + \" client address: \" + msg.getBornHostString());\n161:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);\n162:                 }\n163:             }\n164:             // Slave problem\n165:             else {\n166:                 // Tell the producer, slave not available\n167:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);\n168:             }\n169:         }\n170:     }\n171: \n172:     return putMessageResult;\n173: }\n```\n\n* è¯´æ˜ ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œå¹¶è¿”å›å­˜å‚¨ç»“æœã€‚\n* ç¬¬ 2 è¡Œ ï¼šè®¾ç½®å­˜å‚¨æ—¶é—´ç­‰ã€‚\n* ç¬¬ 16 è‡³ 36 è¡Œ ï¼šäº‹åŠ¡æ¶ˆæ¯ç›¸å…³ï¼Œæš‚æœªäº†è§£ã€‚\n* ç¬¬ 45 & 97 è¡Œ ï¼šè·å–é”ä¸é‡Šæ”¾é”ã€‚\n* ç¬¬ 52 è¡Œ ï¼šå†æ¬¡è®¾ç½®å­˜å‚¨æ—¶é—´ã€‚ç›®å‰ä¼šæœ‰å¤šå¤„åœ°æ–¹è®¾ç½®å­˜å‚¨æ—¶é—´ã€‚\n* ç¬¬ 55 è‡³ 62 è¡Œ ï¼šè·å– `MappedFile`ï¼Œè‹¥ä¸å­˜åœ¨æˆ–å·²æ»¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚è¯¦ç»†è§£æè§ï¼š[MappedFileQueue#getLastMappedFile(...)](#mappedfilequeuegetlastmappedfile)ã€‚\n* ç¬¬ 65 è¡Œ ï¼š**æ’å…¥æ¶ˆæ¯**åˆ° `MappedFile`ï¼Œè§£æè§£æè§ï¼š[MappedFile#appendMessage(...)](#mappedfileappendmessage)ã€‚\n* ç¬¬ 69 è‡³ 80 è¡Œ ï¼š`MappedFile` å·²æ»¡ï¼Œåˆ›å»ºæ–°çš„ï¼Œå†æ¬¡**æ’å…¥æ¶ˆæ¯**ã€‚\n* ç¬¬ 116 è‡³ 140 è¡Œ ï¼š**æ¶ˆæ¯åˆ·ç›˜**ï¼Œå³æŒä¹…åŒ–åˆ°æ–‡ä»¶ã€‚ä¸Šé¢**æ’å…¥æ¶ˆæ¯**å®é™…æœªå­˜å‚¨åˆ°ç¡¬ç›˜ã€‚æ­¤å¤„ï¼Œæ ¹æ®ä¸åŒçš„åˆ·ç›˜ç­–ç•¥ï¼Œæ‰§è¡Œä¼šæœ‰ä¸åŒã€‚è¯¦ç»†è§£æè§ï¼š[FlushCommitLogService](#flushcommitlogservice)ã€‚\n* ç¬¬ 143 è‡³ 173 è¡Œ ï¼š`Broker` ä¸»ä»åŒæ­¥ã€‚åé¢çš„æ–‡ç« ä¼šè¯¦ç»†è§£æğŸ˜ˆã€‚\n\n## MappedFileQueue#getLastMappedFile(...)\n\n```Java\n  1: public MappedFile getLastMappedFile(final long startOffset, boolean needCreate) {\n  2:     long createOffset = -1; // åˆ›å»ºæ–‡ä»¶å¼€å§‹offsetã€‚-1æ—¶ï¼Œä¸åˆ›å»º\n  3:     MappedFile mappedFileLast = getLastMappedFile();\n  4: \n  5:     if (mappedFileLast == null) { // ä¸€ä¸ªæ˜ å°„æ–‡ä»¶éƒ½ä¸å­˜åœ¨\n  6:         createOffset = startOffset - (startOffset % this.mappedFileSize);\n  7:     }\n  8: \n  9:     if (mappedFileLast != null && mappedFileLast.isFull()) { // æœ€åä¸€ä¸ªæ–‡ä»¶å·²æ»¡\n 10:         createOffset = mappedFileLast.getFileFromOffset() + this.mappedFileSize;\n 11:     }\n 12: \n 13:     if (createOffset != -1 && needCreate) { // åˆ›å»ºæ–‡ä»¶\n 14:         String nextFilePath = this.storePath + File.separator + UtilAll.offset2FileName(createOffset);\n 15:         String nextNextFilePath = this.storePath + File.separator\n 16:             + UtilAll.offset2FileName(createOffset + this.mappedFileSize);\n 17:         MappedFile mappedFile = null;\n 18: \n 19:         if (this.allocateMappedFileService != null) {\n 20:             mappedFile = this.allocateMappedFileService.putRequestAndReturnMappedFile(nextFilePath,\n 21:                 nextNextFilePath, this.mappedFileSize);\n 22:         } else {\n 23:             try {\n 24:                 mappedFile = new MappedFile(nextFilePath, this.mappedFileSize);\n 25:             } catch (IOException e) {\n 26:                 log.error(\"create mappedFile exception\", e);\n 27:             }\n 28:         }\n 29: \n 30:         if (mappedFile != null) {\n 31:             if (this.mappedFiles.isEmpty()) {\n 32:                 mappedFile.setFirstCreateInQueue(true);\n 33:             }\n 34:             this.mappedFiles.add(mappedFile);\n 35:         }\n 36: \n 37:         return mappedFile;\n 38:     }\n 39: \n 40:     return mappedFileLast;\n 41: }\n```\n\n* è¯´æ˜ ï¼šè·å–æœ€åä¸€ä¸ª `MappedFile`ï¼Œè‹¥ä¸å­˜åœ¨æˆ–æ–‡ä»¶å·²æ»¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚\n* ç¬¬ 5 è‡³ 11 è¡Œ ï¼šè®¡ç®—å½“æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²æ»¡æ—¶ï¼Œæ–°åˆ›å»ºæ–‡ä»¶çš„ `createOffset`ã€‚\n* ç¬¬ 14 è¡Œ ï¼šè®¡ç®—æ–‡ä»¶åã€‚ä»æ­¤å¤„æˆ‘ä»¬å¯\nä»¥å¾—çŸ¥ï¼Œ`MappedFile`çš„æ–‡ä»¶å‘½åè§„åˆ™ï¼š\n\n    > fileName[n] = fileName[n - 1] + n * mappedFileSize\n    > fileName[0] = startOffset - (startOffset % this.mappedFileSize)\n    \n    ç›®å‰ `CommitLog` çš„ `startOffset` ä¸º 0ã€‚\n    æ­¤å¤„æœ‰ä¸ª**ç–‘é—®**ï¼Œä¸ºä»€ä¹ˆéœ€è¦ `(startOffset % this.mappedFileSize)`ã€‚ä¾‹å¦‚ï¼š\n    \n    | startOffset  | mappedFileSize | createOffset |\n    | --- | :-- | :-- |\n    | 5 | 1 | 5 |\n    | 5 | 2 | 4 |\n    | 5 | 3 | 3  |\n    | 5 | 4 | 4 |\n    | 5 | > 5 | 0 |\n    \n    _å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦ï¼Œéº»çƒ¦æç¤ºä¸‹ã€‚ğŸ˜ˆ_\n    *è§£ç­”ï¼šfileName[0] = startOffset - (startOffset % this.mappedFileSize) è®¡ç®—å‡ºæ¥çš„æ˜¯ï¼Œä»¥ `this.mappedFileSize` ä¸ºæ¯ä¸ªæ–‡ä»¶å¤§å°æ—¶ï¼Œ`startOffset` æ‰€åœ¨æ–‡ä»¶çš„å¼€å§‹`offset`*\n    \n* ç¬¬ 30 è‡³ 35 è¡Œ ï¼šè®¾ç½® `MappedFile`æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªåˆ›å»ºçš„æ–‡ä»¶ã€‚è¯¥æ ‡è¯†ç”¨äº `ConsumeQueue` å¯¹åº”çš„ `MappedFile` ï¼Œè¯¦è§ `ConsumeQueue#fillPreBlank`ã€‚\n    \n## MappedFile#appendMessage(...)\n\n```Java\n  1: public AppendMessageResult appendMessage(final MessageExtBrokerInner msg, final AppendMessageCallback cb) {\n  2:     assert msg != null;\n  3:     assert cb != null;\n  4: \n  5:     int currentPos = this.wrotePosition.get();\n  6: \n  7:     if (currentPos < this.fileSize) {\n  8:         ByteBuffer byteBuffer = writeBuffer != null ? writeBuffer.slice() : this.mappedByteBuffer.slice();\n  9:         byteBuffer.position(currentPos);\n 10:         AppendMessageResult result =\n 11:             cb.doAppend(this.getFileFromOffset(), byteBuffer, this.fileSize - currentPos, msg);\n 12:         this.wrotePosition.addAndGet(result.getWroteBytes());\n 13:         this.storeTimestamp = result.getStoreTimestamp();\n 14:         return result;\n 15:     }\n 16: \n 17:     log.error(\"MappedFile.appendMessage return null, wrotePosition: \" + currentPos + \" fileSize: \"\n 18:         + this.fileSize);\n 19:     return new AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);\n 20: }\n```\n\n* è¯´æ˜ ï¼š**æ’å…¥æ¶ˆæ¯**åˆ° `MappedFile`ï¼Œå¹¶è¿”å›æ’å…¥ç»“æœã€‚\n* ç¬¬ 8 è¡Œ ï¼šè·å–éœ€è¦å†™å…¥çš„å­—èŠ‚ç¼“å†²åŒºã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ `writeBuffer != null` çš„åˆ¤æ–­åï¼Œä½¿ç”¨ä¸åŒçš„å­—èŠ‚ç¼“å†²åŒºï¼Œè§ï¼š[FlushCommitLogService](#flushcommitlogservice)ã€‚\n* ç¬¬ 9 è‡³ 11 è¡Œ ï¼šè®¾ç½®å†™å…¥ `position`ï¼Œæ‰§è¡Œå†™å…¥ï¼Œæ›´æ–° `wrotePosition`(å½“å‰å†™å…¥ä½ç½®ï¼Œä¸‹æ¬¡å¼€å§‹å†™å…¥å¼€å§‹ä½ç½®)ã€‚\n\n## DefaultAppendMessageCallback#doAppend(...)\n\n```Java\n  1: class DefaultAppendMessageCallback implements AppendMessageCallback {\n  2:     // File at the end of the minimum fixed length empty\n  3:     private static final int END_FILE_MIN_BLANK_LENGTH = 4 + 4;\n  4:     /**\n  5:      * å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯ç¼–å·å­—èŠ‚Buffer\n  6:      */\n  7:     private final ByteBuffer msgIdMemory;\n  8:     /**\n  9:      * Store the message content\n 10:      * å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯å­—èŠ‚Buffer\n 11:      * å½“æ¶ˆæ¯ä¼ é€’åˆ°{@link #doAppend(long, ByteBuffer, int, MessageExtBrokerInner)}æ–¹æ³•æ—¶ï¼Œæœ€ç»ˆå†™åˆ°è¯¥å‚æ•°\n 12:      */\n 13:     private final ByteBuffer msgStoreItemMemory;\n 14:     /**\n 15:      * The maximum length of the message\n 16:      * æ¶ˆæ¯æœ€å¤§é•¿åº¦\n 17:      */\n 18:     private final int maxMessageSize;\n 19:     /**\n 20:      * Build Message Key\n 21:      * {@link #topicQueueTable}çš„key\n 22:      * è®¡ç®—æ–¹å¼ï¼štopic + \"-\" + queueId\n 23:      */\n 24:     private final StringBuilder keyBuilder = new StringBuilder();\n 25:     /**\n 26:      * hostå­—èŠ‚buffer\n 27:      * ç”¨äºé‡å¤è®¡ç®—hostçš„å­—èŠ‚å†…å®¹\n 28:      */\n 29:     private final ByteBuffer hostHolder = ByteBuffer.allocate(8);\n 30: \n 31:     DefaultAppendMessageCallback(final int size) {\n 32:         this.msgIdMemory = ByteBuffer.allocate(MessageDecoder.MSG_ID_LENGTH);\n 33:         this.msgStoreItemMemory = ByteBuffer.allocate(size + END_FILE_MIN_BLANK_LENGTH);\n 34:         this.maxMessageSize = size;\n 35:     }\n 36: \n 37:     public ByteBuffer getMsgStoreItemMemory() {\n 38:         return msgStoreItemMemory;\n 39:     }\n 40: \n 41:     public AppendMessageResult doAppend(final long fileFromOffset, final ByteBuffer byteBuffer, final int maxBlank, final MessageExtBrokerInner msgInner) {\n 42:         // STORETIMESTAMP + STOREHOSTADDRESS + OFFSET <br>\n 43: \n 44:         // PHY OFFSET\n 45:         long wroteOffset = fileFromOffset + byteBuffer.position();\n 46: \n 47:         // è®¡ç®—commitLogé‡Œçš„msgId\n 48:         this.resetByteBuffer(hostHolder, 8);\n 49:         String msgId = MessageDecoder.createMessageId(this.msgIdMemory, msgInner.getStoreHostBytes(hostHolder), wroteOffset);\n 50: \n 51:         // Record ConsumeQueue information è·å–é˜Ÿåˆ—offset\n 52:         keyBuilder.setLength(0);\n 53:         keyBuilder.append(msgInner.getTopic());\n 54:         keyBuilder.append('-');\n 55:         keyBuilder.append(msgInner.getQueueId());\n 56:         String key = keyBuilder.toString();\n 57:         Long queueOffset = CommitLog.this.topicQueueTable.get(key);\n 58:         if (null == queueOffset) {\n 59:             queueOffset = 0L;\n 60:             CommitLog.this.topicQueueTable.put(key, queueOffset);\n 61:         }\n 62: \n 63:         // Transaction messages that require special handling // TODO ç–‘é—®ï¼šç”¨é€”\n 64:         final int tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());\n 65:         switch (tranType) {\n 66:             // Prepared and Rollback message is not consumed, will not enter the\n 67:             // consumer queue\n 68:             case MessageSysFlag.TRANSACTION_PREPARED_TYPE:\n 69:             case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:\n 70:                 queueOffset = 0L;\n 71:                 break;\n 72:             case MessageSysFlag.TRANSACTION_NOT_TYPE:\n 73:             case MessageSysFlag.TRANSACTION_COMMIT_TYPE:\n 74:             default:\n 75:                 break;\n 76:         }\n 77: \n 78:         // è®¡ç®—æ¶ˆæ¯é•¿åº¦\n 79:         final byte[] propertiesData =\n 80:             msgInner.getPropertiesString() == null ? null : msgInner.getPropertiesString().getBytes(MessageDecoder.CHARSET_UTF8);\n 81:         final int propertiesLength = propertiesData == null ? 0 : propertiesData.length;\n 82:         if (propertiesLength > Short.MAX_VALUE) {\n 83:             log.warn(\"putMessage message properties length too long. length={}\", propertiesData.length);\n 84:             return new AppendMessageResult(AppendMessageStatus.PROPERTIES_SIZE_EXCEEDED);\n 85:         }\n 86:         final byte[] topicData = msgInner.getTopic().getBytes(MessageDecoder.CHARSET_UTF8);\n 87:         final int topicLength = topicData.length;\n 88:         final int bodyLength = msgInner.getBody() == null ? 0 : msgInner.getBody().length;\n 89:         final int msgLen = calMsgLength(bodyLength, topicLength, propertiesLength);\n 90:         // Exceeds the maximum message\n 91:         if (msgLen > this.maxMessageSize) {\n 92:             CommitLog.log.warn(\"message size exceeded, msg total size: \" + msgLen + \", msg body size: \" + bodyLength\n 93:                 + \", maxMessageSize: \" + this.maxMessageSize);\n 94:             return new AppendMessageResult(AppendMessageStatus.MESSAGE_SIZE_EXCEEDED);\n 95:         }\n 96: \n 97:         // Determines whether there is sufficient(è¶³å¤Ÿ) free space\n 98:         if ((msgLen + END_FILE_MIN_BLANK_LENGTH) > maxBlank) {\n 99:             this.resetByteBuffer(this.msgStoreItemMemory, maxBlank);\n100:             // 1 TOTAL_SIZE\n101:             this.msgStoreItemMemory.putInt(maxBlank);\n102:             // 2 MAGIC_CODE\n103:             this.msgStoreItemMemory.putInt(CommitLog.BLANK_MAGIC_CODE);\n104:             // 3 The remaining space may be any value\n105:             //\n106: \n107:             // Here the length of the specially set maxBlank\n108:             final long beginTimeMills = CommitLog.this.defaultMessageStore.now();\n109:             byteBuffer.put(this.msgStoreItemMemory.array(), 0, maxBlank);\n110:             return new AppendMessageResult(AppendMessageStatus.END_OF_FILE, wroteOffset, maxBlank, msgId, msgInner.getStoreTimestamp(),\n111:                 queueOffset, CommitLog.this.defaultMessageStore.now() - beginTimeMills);\n112:         }\n113: \n114:         // Initialization of storage space\n115:         this.resetByteBuffer(msgStoreItemMemory, msgLen);\n116:         // 1 TOTAL_SIZE\n117:         this.msgStoreItemMemory.putInt(msgLen);\n118:         // 2 MAGIC_CODE\n119:         this.msgStoreItemMemory.putInt(CommitLog.MESSAGE_MAGIC_CODE);\n120:         // 3 BODY_CRC\n121:         this.msgStoreItemMemory.putInt(msgInner.getBodyCRC());\n122:         // 4 QUEUE_ID\n123:         this.msgStoreItemMemory.putInt(msgInner.getQueueId());\n124:         // 5 FLAG\n125:         this.msgStoreItemMemory.putInt(msgInner.getFlag());\n126:         // 6 QUEUE_OFFSET\n127:         this.msgStoreItemMemory.putLong(queueOffset);\n128:         // 7 PHYSICAL_OFFSET\n129:         this.msgStoreItemMemory.putLong(fileFromOffset + byteBuffer.position());\n130:         // 8 SYS_FLAG\n131:         this.msgStoreItemMemory.putInt(msgInner.getSysFlag());\n132:         // 9 BORN_TIMESTAMP\n133:         this.msgStoreItemMemory.putLong(msgInner.getBornTimestamp());\n134:         // 10 BORN_HOST\n135:         this.resetByteBuffer(hostHolder, 8);\n136:         this.msgStoreItemMemory.put(msgInner.getBornHostBytes(hostHolder));\n137:         // 11 STORE_TIMESTAMP\n138:         this.msgStoreItemMemory.putLong(msgInner.getStoreTimestamp());\n139:         // 12 STORE_HOST_ADDRESS\n140:         this.resetByteBuffer(hostHolder, 8);\n141:         this.msgStoreItemMemory.put(msgInner.getStoreHostBytes(hostHolder));\n142:         //this.msgStoreItemMemory.put(msgInner.getStoreHostBytes());\n143:         // 13 RECONSUME_TIMES\n144:         this.msgStoreItemMemory.putInt(msgInner.getReconsumeTimes());\n145:         // 14 Prepared Transaction Offset\n146:         this.msgStoreItemMemory.putLong(msgInner.getPreparedTransactionOffset());\n147:         // 15 BODY\n148:         this.msgStoreItemMemory.putInt(bodyLength);\n149:         if (bodyLength > 0)\n150:             this.msgStoreItemMemory.put(msgInner.getBody());\n151:         // 16 TOPIC\n152:         this.msgStoreItemMemory.put((byte) topicLength);\n153:         this.msgStoreItemMemory.put(topicData);\n154:         // 17 PROPERTIES\n155:         this.msgStoreItemMemory.putShort((short) propertiesLength);\n156:         if (propertiesLength > 0)\n157:             this.msgStoreItemMemory.put(propertiesData);\n158: \n159:         final long beginTimeMills = CommitLog.this.defaultMessageStore.now();\n160:         // Write messages to the queue buffer\n161:         byteBuffer.put(this.msgStoreItemMemory.array(), 0, msgLen);\n162: \n163:         AppendMessageResult result = new AppendMessageResult(AppendMessageStatus.PUT_OK, wroteOffset, msgLen, msgId,\n164:             msgInner.getStoreTimestamp(), queueOffset, CommitLog.this.defaultMessageStore.now() - beginTimeMills);\n165: \n166:         switch (tranType) {\n167:             case MessageSysFlag.TRANSACTION_PREPARED_TYPE:\n168:             case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:\n169:                 break;\n170:             case MessageSysFlag.TRANSACTION_NOT_TYPE:\n171:             case MessageSysFlag.TRANSACTION_COMMIT_TYPE:\n172:                 // The next update ConsumeQueue information æ›´æ–°é˜Ÿåˆ—çš„offset\n173:                 CommitLog.this.topicQueueTable.put(key, ++queueOffset);\n174:                 break;\n175:             default:\n176:                 break;\n177:         }\n178:         return result;\n179:     }\n180: \n181:     /**\n182:      * é‡ç½®å­—èŠ‚ç¼“å†²åŒº\n183:      *\n184:      * @param byteBuffer å­—èŠ‚ç¼“å†²åŒº\n185:      * @param limit é•¿åº¦\n186:      */\n187:     private void resetByteBuffer(final ByteBuffer byteBuffer, final int limit) {\n188:         byteBuffer.flip();\n189:         byteBuffer.limit(limit);\n190:     }\n191: }\n```\n* è¯´æ˜ ï¼šæ’å…¥æ¶ˆæ¯åˆ°å­—èŠ‚ç¼“å†²åŒºã€‚\n* ç¬¬ 45 è¡Œ ï¼šè®¡ç®—ç‰©ç†ä½ç½®ã€‚åœ¨ `CommitLog` çš„é¡ºåºå­˜å‚¨ä½ç½®ã€‚\n* ç¬¬ 47 è‡³ 49 è¡Œ ï¼šè®¡ç®— `CommitLog` é‡Œçš„ `offsetMsgId`ã€‚è¿™é‡Œä¸€å®šè¦å’Œ `msgId` åŒºåˆ†å¼€ã€‚\n\n|   |   | è®¡ç®—æ–¹å¼ | é•¿åº¦ | |\n| --- | --- | --- | --- |  --- |\n| offsetMsgId | Brokerå­˜å‚¨æ—¶ç”Ÿæˆ | Hex(storeHostBytes, wroteOffset) | 32 |\n| msgId | Clientå‘é€æ¶ˆæ¯æ—¶ç”Ÿæˆ | Hex(è¿›ç¨‹ç¼–å·, IP, ClassLoader, startTime, currentTime, è‡ªå¢åºåˆ—) | 32 | [ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message åŸºç¡€ã€‹](http://www.yunai.me/RocketMQ/message/) |\n\n* ç¬¬ 51 è‡³ 61 è¡Œ ï¼šè·å–é˜Ÿåˆ—ä½ç½®(offset)ã€‚\n* ç¬¬ 78 è‡³ 95 è¡Œ ï¼šè®¡ç®—æ¶ˆæ¯æ€»é•¿åº¦ã€‚\n* ç¬¬ 98 è‡³ 112 è¡Œ ï¼šå½“æ–‡ä»¶å‰©ä½™ç©ºé—´ä¸è¶³æ—¶ï¼Œå†™å…¥ `BLANK` å ä½ï¼Œè¿”å›ç»“æœã€‚\n* ç¬¬ 114 è‡³ 161 è¡Œ ï¼šå†™å…¥ `MESSAGE` ã€‚\n* ç¬¬ 173 è¡Œ ï¼šæ›´æ–°é˜Ÿåˆ—ä½ç½®(offset)ã€‚\n\n## FlushCommitLogService\n\n![FlushCommitLogServiceç±»å›¾](http://www.yunai.me/images/RocketMQ/2017_04_23/03.png)\n\n| çº¿ç¨‹æœåŠ¡ | åœºæ™¯ | æ’å…¥æ¶ˆæ¯æ€§èƒ½ |\n| --- | --- | --- |\n| CommitRealTimeService | å¼‚æ­¥åˆ·ç›˜ && å¼€å¯å†…å­˜å­—èŠ‚ç¼“å†²åŒº | ç¬¬ä¸€ |\n| FlushRealTimeService | å¼‚æ­¥åˆ·ç›˜ && å…³é—­å†…å­˜å­—èŠ‚ç¼“å†²åŒº | ç¬¬äºŒ |\n| GroupCommitService | åŒæ­¥åˆ·ç›˜ | ç¬¬ä¸‰ |\n\n### MappedFile#è½ç›˜\n\n\n| æ–¹å¼ |   |  |  |\n| --- | --- | :-- | :-- |\n| æ–¹å¼ä¸€ | å†™å…¥å†…å­˜å­—èŠ‚ç¼“å†²åŒº(writeBuffer) | ä»å†…å­˜å­—èŠ‚ç¼“å†²åŒº(write buffer)æäº¤(commit)åˆ°æ–‡ä»¶é€šé“(fileChannel) | æ–‡ä»¶é€šé“(fileChannel)flush |\n| æ–¹å¼äºŒ |  | å†™å…¥æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer) | æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer)flush  |\n\n![MappedFileçš„positionè¿ç§»å›¾](http://www.yunai.me/images/RocketMQ/2017_04_23/04.jpeg)\n\n**flushç›¸å…³ä»£ç **\n\nè€ƒè™‘åˆ°å†™å…¥æ€§èƒ½ï¼Œæ»¡è¶³ `flushLeastPages * OS_PAGE_SIZE` æ‰è¿›è¡Œ `flush`ã€‚\n\n```Java\n  1: /**\n  2:  * flush\n  3:  *\n  4:  * @param flushLeastPages flushæœ€å°é¡µæ•°\n  5:  * @return The current flushed position\n  6:  */\n  7: public int flush(final int flushLeastPages) {\n  8:     if (this.isAbleToFlush(flushLeastPages)) {\n  9:         if (this.hold()) {\n 10:             int value = getReadPosition();\n 11: \n 12:             try {\n 13:                 //We only append data to fileChannel or mappedByteBuffer, never both.\n 14:                 if (writeBuffer != null || this.fileChannel.position() != 0) {\n 15:                     this.fileChannel.force(false);\n 16:                 } else {\n 17:                     this.mappedByteBuffer.force();\n 18:                 }\n 19:             } catch (Throwable e) {\n 20:                 log.error(\"Error occurred when force data to disk.\", e);\n 21:             }\n 22: \n 23:             this.flushedPosition.set(value);\n 24:             this.release();\n 25:         } else {\n 26:             log.warn(\"in flush, hold failed, flush offset = \" + this.flushedPosition.get());\n 27:             this.flushedPosition.set(getReadPosition());\n 28:         }\n 29:     }\n 30:     return this.getFlushedPosition();\n 31: }\n 32: \n 33: /**\n 34:  * æ˜¯å¦èƒ½å¤Ÿflushã€‚æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä»»æ„æ¡ä»¶ï¼š\n 35:  * 1. æ˜ å°„æ–‡ä»¶å·²ç»å†™æ»¡\n 36:  * 2. flushLeastPages > 0 && æœªflushéƒ¨åˆ†è¶…è¿‡flushLeastPages\n 37:  * 3. flushLeastPages = 0 && æœ‰æ–°å†™å…¥éƒ¨åˆ†\n 38:  *\n 39:  * @param flushLeastPages flushæœ€å°åˆ†é¡µ\n 40:  * @return æ˜¯å¦èƒ½å¤Ÿå†™å…¥\n 41:  */\n 42: private boolean isAbleToFlush(final int flushLeastPages) {\n 43:     int flush = this.flushedPosition.get();\n 44:     int write = getReadPosition();\n 45: \n 46:     if (this.isFull()) {\n 47:         return true;\n 48:     }\n 49: \n 50:     if (flushLeastPages > 0) {\n 51:         return ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) >= flushLeastPages;\n 52:     }\n 53: \n 54:     return write > flush;\n 55: }\n```\n\n**commitç›¸å…³ä»£ç ï¼š**\n\nè€ƒè™‘åˆ°å†™å…¥æ€§èƒ½ï¼Œæ»¡è¶³ `commitLeastPages * OS_PAGE_SIZE` æ‰è¿›è¡Œ `commit`ã€‚\n\n```Java\n  1: /**\n  2:  * commit\n  3:  * å½“{@link #writeBuffer}ä¸ºnullæ—¶ï¼Œç›´æ¥è¿”å›{@link #wrotePosition}\n  4:  *\n  5:  * @param commitLeastPages commitæœ€å°é¡µæ•°\n  6:  * @return å½“å‰commitä½ç½®\n  7:  */\n  8: public int commit(final int commitLeastPages) {\n  9:     if (writeBuffer == null) {\n 10:         //no need to commit data to file channel, so just regard wrotePosition as committedPosition.\n 11:         return this.wrotePosition.get();\n 12:     }\n 13:     if (this.isAbleToCommit(commitLeastPages)) {\n 14:         if (this.hold()) {\n 15:             commit0(commitLeastPages);\n 16:             this.release();\n 17:         } else {\n 18:             log.warn(\"in commit, hold failed, commit offset = \" + this.committedPosition.get());\n 19:         }\n 20:     }\n 21: \n 22:     // All dirty data has been committed to FileChannel. å†™åˆ°æ–‡ä»¶å°¾æ—¶ï¼Œå›æ”¶writeBufferã€‚\n 23:     if (writeBuffer != null && this.transientStorePool != null && this.fileSize == this.committedPosition.get()) {\n 24:         this.transientStorePool.returnBuffer(writeBuffer);\n 25:         this.writeBuffer = null;\n 26:     }\n 27: \n 28:     return this.committedPosition.get();\n 29: }\n 30: \n 31: /**\n 32:  * commitå®ç°ï¼Œå°†writeBufferå†™å…¥fileChannelã€‚\n 33:  * @param commitLeastPages commitæœ€å°é¡µæ•°ã€‚ç”¨ä¸ä¸Šè¯¥å‚æ•°\n 34:  */\n 35: protected void commit0(final int commitLeastPages) {\n 36:     int writePos = this.wrotePosition.get();\n 37:     int lastCommittedPosition = this.committedPosition.get();\n 38: \n 39:     if (writePos - this.committedPosition.get() > 0) {\n 40:         try {\n 41:             // è®¾ç½®éœ€è¦å†™å…¥çš„byteBuffer\n 42:             ByteBuffer byteBuffer = writeBuffer.slice();\n 43:             byteBuffer.position(lastCommittedPosition);\n 44:             byteBuffer.limit(writePos);\n 45:             // å†™å…¥fileChannel\n 46:             this.fileChannel.position(lastCommittedPosition);\n 47:             this.fileChannel.write(byteBuffer);\n 48:             // è®¾ç½®position\n 49:             this.committedPosition.set(writePos);\n 50:         } catch (Throwable e) {\n 51:             log.error(\"Error occurred when commit data to FileChannel.\", e);\n 52:         }\n 53:     }\n 54: }\n 55: \n 56: /**\n 57:  * æ˜¯å¦èƒ½å¤Ÿcommitã€‚æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä»»æ„æ¡ä»¶ï¼š\n 58:  * 1. æ˜ å°„æ–‡ä»¶å·²ç»å†™æ»¡\n 59:  * 2. commitLeastPages > 0 && æœªcommitéƒ¨åˆ†è¶…è¿‡commitLeastPages\n 60:  * 3. commitLeastPages = 0 && æœ‰æ–°å†™å…¥éƒ¨åˆ†\n 61:  *\n 62:  * @param commitLeastPages commitæœ€å°åˆ†é¡µ\n 63:  * @return æ˜¯å¦èƒ½å¤Ÿå†™å…¥\n 64:  */\n 65: protected boolean isAbleToCommit(final int commitLeastPages) {\n 66:     int flush = this.committedPosition.get();\n 67:     int write = this.wrotePosition.get();\n 68: \n 69:     if (this.isFull()) {\n 70:         return true;\n 71:     }\n 72: \n 73:     if (commitLeastPages > 0) {\n 74:         return ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) >= commitLeastPages;\n 75:     }\n 76: \n 77:     return write > flush;\n 78: }\n```\n\n### FlushRealTimeService\n\næ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚\n\n```Java\n  1: class FlushRealTimeService extends FlushCommitLogService {\n  2:     /**\n  3:      * æœ€åflushæ—¶é—´æˆ³\n  4:      */\n  5:     private long lastFlushTimestamp = 0;\n  6:     /**\n  7:      * printè®¡æ—¶å™¨ã€‚\n  8:      * æ»¡è¶³printæ¬¡æ•°æ—¶ï¼Œè°ƒç”¨{@link #printFlushProgress()}\n  9:      */\n 10:     private long printTimes = 0;\n 11: \n 12:     public void run() {\n 13:         CommitLog.log.info(this.getServiceName() + \" service started\");\n 14: \n 15:         while (!this.isStopped()) {\n 16:             boolean flushCommitLogTimed = CommitLog.this.defaultMessageStore.getMessageStoreConfig().isFlushCommitLogTimed();\n 17:             int interval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushIntervalCommitLog();\n 18:             int flushPhysicQueueLeastPages = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogLeastPages();\n 19:             int flushPhysicQueueThoroughInterval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogThoroughInterval();\n 20: \n 21:             // Print flush progress\n 22:             // å½“æ—¶é—´æ»¡è¶³flushPhysicQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushPhysicQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush\n 23:             boolean printFlushProgress = false;\n 24:             long currentTimeMillis = System.currentTimeMillis();\n 25:             if (currentTimeMillis >= (this.lastFlushTimestamp + flushPhysicQueueThoroughInterval)) {\n 26:                 this.lastFlushTimestamp = currentTimeMillis;\n 27:                 flushPhysicQueueLeastPages = 0;\n 28:                 printFlushProgress = (printTimes++ % 10) == 0;\n 29:             }\n 30: \n 31:             try {\n 32:                 // ç­‰å¾…æ‰§è¡Œ\n 33:                 if (flushCommitLogTimed) {\n 34:                     Thread.sleep(interval);\n 35:                 } else {\n 36:                     this.waitForRunning(interval);\n 37:                 }\n 38: \n 39:                 if (printFlushProgress) {\n 40:                     this.printFlushProgress();\n 41:                 }\n 42: \n 43:                 // flush commitLog\n 44:                 long begin = System.currentTimeMillis();\n 45:                 CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages);\n 46:                 long storeTimestamp = CommitLog.this.mappedFileQueue.getStoreTimestamp();\n 47:                 if (storeTimestamp > 0) {\n 48:                     CommitLog.this.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);\n 49:                 }\n 50:                 long past = System.currentTimeMillis() - begin;\n 51:                 if (past > 500) {\n 52:                     log.info(\"Flush data to disk costs {} ms\", past);\n 53:                 }\n 54:             } catch (Throwable e) {\n 55:                 CommitLog.log.warn(this.getServiceName() + \" service has exception. \", e);\n 56:                 this.printFlushProgress();\n 57:             }\n 58:         }\n 59: \n 60:         // Normal shutdown, to ensure that all the flush before exit\n 61:         boolean result = false;\n 62:         for (int i = 0; i < RETRY_TIMES_OVER && !result; i++) {\n 63:             result = CommitLog.this.mappedFileQueue.flush(0);\n 64:             CommitLog.log.info(this.getServiceName() + \" service shutdown, retry \" + (i + 1) + \" times \" + (result ? \"OK\" : \"Not OK\"));\n 65:         }\n 66: \n 67:         this.printFlushProgress();\n 68: \n 69:         CommitLog.log.info(this.getServiceName() + \" service end\");\n 70:     }\n 71: \n 72:     @Override\n 73:     public String getServiceName() {\n 74:         return FlushRealTimeService.class.getSimpleName();\n 75:     }\n 76: \n 77:     private void printFlushProgress() {\n 78:         // CommitLog.log.info(\"how much disk fall behind memory, \"\n 79:         // + CommitLog.this.mappedFileQueue.howMuchFallBehind());\n 80:     }\n 81: \n 82:     @Override\n 83:     @SuppressWarnings(\"SpellCheckingInspection\")\n 84:     public long getJointime() {\n 85:         return 1000 * 60 * 5;\n 86:     }\n 87: }\n```\n\n* è¯´æ˜ï¼šå®æ—¶ `flush `çº¿ç¨‹æœåŠ¡ï¼Œè°ƒç”¨ `MappedFile#flush` ç›¸å…³é€»è¾‘ã€‚\n* ç¬¬ 23 è‡³ 29 è¡Œ ï¼šæ¯ `flushPhysicQueueThoroughInterval` å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ `flush` ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ `flushCommitLogLeastPages` å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ `flush` ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ `flush`ï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚\n* ç¬¬ 33 è¡Œ è‡³ 37 è¡Œ ï¼šæ ¹æ® `flushCommitLogTimed` å‚æ•°ï¼Œå¯ä»¥é€‰æ‹©æ¯æ¬¡å¾ªç¯æ˜¯**å›ºå®šå‘¨æœŸ**è¿˜æ˜¯**ç­‰å¾…å”¤é†’**ã€‚é»˜è®¤é…ç½®æ˜¯åè€…ï¼Œæ‰€ä»¥ï¼Œæ¯æ¬¡æ’å…¥æ¶ˆæ¯å®Œæˆï¼Œä¼šå»è°ƒç”¨ `commitLogService.wakeup()` ã€‚\n* ç¬¬ 45 è¡Œ ï¼šè°ƒç”¨ `MappedFile` è¿›è¡Œ `flush`ã€‚\n* ç¬¬ 61 è‡³ 65 è¡Œ ï¼š`Broker` å…³é—­æ—¶ï¼Œå¼ºåˆ¶ `flush`ï¼Œé¿å…æœ‰æœªåˆ·ç›˜çš„æ•°æ®ã€‚\n\n### CommitRealTimeService\n\næ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚\nå’Œ `FlushRealTimeService` ç±»ä¼¼ï¼Œæ€§èƒ½æ›´å¥½ã€‚\n\n```Java\n  1: class CommitRealTimeService extends FlushCommitLogService {\n  2: \n  3:     /**\n  4:      * æœ€å commit æ—¶é—´æˆ³\n  5:      */\n  6:     private long lastCommitTimestamp = 0;\n  7: \n  8:     @Override\n  9:     public String getServiceName() {\n 10:         return CommitRealTimeService.class.getSimpleName();\n 11:     }\n 12: \n 13:     @Override\n 14:     public void run() {\n 15:         CommitLog.log.info(this.getServiceName() + \" service started\");\n 16:         while (!this.isStopped()) {\n 17:             int interval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitIntervalCommitLog();\n 18:             int commitDataLeastPages = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogLeastPages();\n 19:             int commitDataThoroughInterval = CommitLog.this.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogThoroughInterval();\n 20: \n 21:             // å½“æ—¶é—´æ»¡è¶³commitDataThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³commitDataLeastPagesï¼Œä¹Ÿè¿›è¡Œflush\n 22:             long begin = System.currentTimeMillis();\n 23:             if (begin >= (this.lastCommitTimestamp + commitDataThoroughInterval)) {\n 24:                 this.lastCommitTimestamp = begin;\n 25:                 commitDataLeastPages = 0;\n 26:             }\n 27: \n 28:             try {\n 29:                 // commit\n 30:                 boolean result = CommitLog.this.mappedFileQueue.commit(commitDataLeastPages);\n 31:                 long end = System.currentTimeMillis();\n 32:                 if (!result) { // TODO ç–‘é—®ï¼šæœªå†™å…¥æˆåŠŸï¼Œä¸ºå•¥è¦å”¤é†’flushCommitLogService\n 33:                     this.lastCommitTimestamp = end; // result = false means some data committed.\n 34:                     //now wake up flush thread.\n 35:                     flushCommitLogService.wakeup();\n 36:                 }\n 37: \n 38:                 if (end - begin > 500) {\n 39:                     log.info(\"Commit data to file costs {} ms\", end - begin);\n 40:                 }\n 41: \n 42:                 // ç­‰å¾…æ‰§è¡Œ\n 43:                 this.waitForRunning(interval);\n 44:             } catch (Throwable e) {\n 45:                 CommitLog.log.error(this.getServiceName() + \" service has exception. \", e);\n 46:             }\n 47:         }\n 48: \n 49:         boolean result = false;\n 50:         for (int i = 0; i < RETRY_TIMES_OVER && !result; i++) {\n 51:             result = CommitLog.this.mappedFileQueue.commit(0);\n 52:             CommitLog.log.info(this.getServiceName() + \" service shutdown, retry \" + (i + 1) + \" times \" + (result ? \"OK\" : \"Not OK\"));\n 53:         }\n 54:         CommitLog.log.info(this.getServiceName() + \" service end\");\n 55:     }\n 56: }\n```\n\n### GroupCommitService\n\næ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼ŒåŒæ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚\n\n```Java\n  1: class GroupCommitService extends FlushCommitLogService {\n  2:     /**\n  3:      * å†™å…¥è¯·æ±‚é˜Ÿåˆ—\n  4:      */\n  5:     private volatile List<GroupCommitRequest> requestsWrite = new ArrayList<>();\n  6:     /**\n  7:      * è¯»å–è¯·æ±‚é˜Ÿåˆ—\n  8:      */\n  9:     private volatile List<GroupCommitRequest> requestsRead = new ArrayList<>();\n 10: \n 11:     /**\n 12:      * æ·»åŠ å†™å…¥è¯·æ±‚\n 13:      *\n 14:      * @param request å†™å…¥è¯·æ±‚\n 15:      */\n 16:     public synchronized void putRequest(final GroupCommitRequest request) {\n 17:         // æ·»åŠ å†™å…¥è¯·æ±‚\n 18:         synchronized (this.requestsWrite) {\n 19:             this.requestsWrite.add(request);\n 20:         }\n 21:         // åˆ‡æ¢è¯»å†™é˜Ÿåˆ—\n 22:         if (hasNotified.compareAndSet(false, true)) {\n 23:             waitPoint.countDown(); // notify\n 24:         }\n 25:     }\n 26: \n 27:     /**\n 28:      * åˆ‡æ¢è¯»å†™é˜Ÿåˆ—\n 29:      */\n 30:     private void swapRequests() {\n 31:         List<GroupCommitRequest> tmp = this.requestsWrite;\n 32:         this.requestsWrite = this.requestsRead;\n 33:         this.requestsRead = tmp;\n 34:     }\n 35: \n 36:     private void doCommit() {\n 37:         synchronized (this.requestsRead) {\n 38:             if (!this.requestsRead.isEmpty()) {\n 39:                 for (GroupCommitRequest req : this.requestsRead) {\n 40:                     // There may be a message in the next file, so a maximum of\n 41:                     // two times the flush (å¯èƒ½æ‰¹é‡æäº¤çš„messagesï¼Œåˆ†å¸ƒåœ¨ä¸¤ä¸ªMappedFile)\n 42:                     boolean flushOK = false;\n 43:                     for (int i = 0; i < 2 && !flushOK; i++) {\n 44:                         // æ˜¯å¦æ»¡è¶³éœ€è¦flushæ¡ä»¶ï¼Œå³è¯·æ±‚çš„offsetè¶…è¿‡flushçš„offset\n 45:                         flushOK = CommitLog.this.mappedFileQueue.getFlushedWhere() >= req.getNextOffset();\n 46:                         if (!flushOK) {\n 47:                             CommitLog.this.mappedFileQueue.flush(0);\n 48:                         }\n 49:                     }\n 50:                     // å”¤é†’ç­‰å¾…è¯·æ±‚\n 51:                     req.wakeupCustomer(flushOK);\n 52:                 }\n 53: \n 54:                 long storeTimestamp = CommitLog.this.mappedFileQueue.getStoreTimestamp();\n 55:                 if (storeTimestamp > 0) {\n 56:                     CommitLog.this.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);\n 57:                 }\n 58: \n 59:                 // æ¸…ç†è¯»å–é˜Ÿåˆ—\n 60:                 this.requestsRead.clear();\n 61:             } else {\n 62:                 // Because of individual messages is set to not sync flush, it\n 63:                 // will come to this process ä¸åˆæ³•çš„è¯·æ±‚ï¼Œæ¯”å¦‚messageä¸Šæœªè®¾ç½®isWaitStoreMsgOKã€‚\n 64:                 // èµ°åˆ°æ­¤å¤„çš„é€»è¾‘ï¼Œç›¸å½“äºå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè½ç›˜ä¸€æ¡æ¶ˆæ¯ï¼Œå®é™…æ— æ‰¹é‡æäº¤çš„æ•ˆæœã€‚\n 65:                 CommitLog.this.mappedFileQueue.flush(0);\n 66:             }\n 67:         }\n 68:     }\n 69: \n 70:     public void run() {\n 71:         CommitLog.log.info(this.getServiceName() + \" service started\");\n 72: \n 73:         while (!this.isStopped()) {\n 74:             try {\n 75:                 this.waitForRunning(10);\n 76:                 this.doCommit();\n 77:             } catch (Exception e) {\n 78:                 CommitLog.log.warn(this.getServiceName() + \" service has exception. \", e);\n 79:             }\n 80:         }\n 81: \n 82:         // Under normal circumstances shutdown, wait for the arrival of the\n 83:         // request, and then flush\n 84:         try {\n 85:             Thread.sleep(10);\n 86:         } catch (InterruptedException e) {\n 87:             CommitLog.log.warn(\"GroupCommitService Exception, \", e);\n 88:         }\n 89: \n 90:         synchronized (this) {\n 91:             this.swapRequests();\n 92:         }\n 93: \n 94:         this.doCommit();\n 95: \n 96:         CommitLog.log.info(this.getServiceName() + \" service end\");\n 97:     }\n 98: \n 99:     /**\n100:      * æ¯æ¬¡æ‰§è¡Œå®Œï¼Œåˆ‡æ¢è¯»å†™é˜Ÿåˆ—\n101:      */\n102:     @Override\n103:     protected void onWaitEnd() {\n104:         this.swapRequests();\n105:     }\n106: \n107:     @Override\n108:     public String getServiceName() {\n109:         return GroupCommitService.class.getSimpleName();\n110:     }\n111: \n112:     @Override\n113:     public long getJointime() {\n114:         return 1000 * 60 * 5;\n115:     }\n116: }\n```\n\n* è¯´æ˜ï¼šæ‰¹é‡å†™å…¥çº¿ç¨‹æœåŠ¡ã€‚\n* ç¬¬ 16 è‡³ 25 è¡Œ ï¼šæ·»åŠ å†™å…¥è¯·æ±‚ã€‚æ–¹æ³•è®¾ç½®äº† `sync` çš„åŸå› ï¼š`this.requestsWrite` ä¼šå’Œ `this.requestsRead` ä¸æ–­äº¤æ¢ï¼Œæ— æ³•ä¿è¯ç¨³å®šçš„åŒæ­¥ã€‚\n* ç¬¬ 27 è‡³ 34 è¡Œ ï¼šè¯»å†™é˜Ÿåˆ—äº¤æ¢ã€‚\n* ç¬¬ 38 è‡³ 60 è¡Œ ï¼šå¾ªç¯å†™å…¥é˜Ÿåˆ—ï¼Œè¿›è¡Œ `flush`ã€‚\n    * ç¬¬ 43 è¡Œ ï¼šè€ƒè™‘åˆ°æœ‰å¯èƒ½æ¯æ¬¡å¾ªç¯çš„æ¶ˆæ¯å†™å…¥çš„æ¶ˆæ¯ï¼Œå¯èƒ½åˆ†å¸ƒåœ¨**ä¸¤ä¸ª** `MappedFile`(å†™ç¬¬Nä¸ªæ¶ˆæ¯æ—¶ï¼Œ`MappedFile` å·²æ»¡ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„)ï¼Œæ‰€ä»¥éœ€è¦æœ‰å¾ªç¯2æ¬¡ã€‚\n    * ç¬¬ 51 è¡Œ ï¼šå”¤é†’ç­‰å¾…å†™å…¥è¯·æ±‚çº¿ç¨‹ï¼Œé€šè¿‡ `CountDownLatch` å®ç°ã€‚\n* ç¬¬ 61 è‡³ 66 è¡Œ ï¼šç›´æ¥åˆ·ç›˜ã€‚æ­¤å¤„æ˜¯ç”±äºå‘é€çš„æ¶ˆæ¯çš„ `isWaitStoreMsgOK` æœªè®¾ç½®æˆ `TRUE` ï¼Œå¯¼è‡´æœªèµ°æ‰¹é‡æäº¤ã€‚\n* ç¬¬ 73 è‡³ 80 è¡Œ ï¼šæ¯ 10ms æ‰§è¡Œä¸€æ¬¡æ‰¹é‡æäº¤ã€‚å½“ç„¶ï¼Œå¦‚æœ `wakeup()` æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡æ‰¹é‡æäº¤ã€‚å½“ `Broker` è®¾ç½®æˆåŒæ­¥è½ç›˜ && æ¶ˆæ¯ `isWaitStoreMsgOK=true`ï¼Œæ¶ˆæ¯éœ€è¦ç•¥å¤§äº 10ms æ‰èƒ½å‘é€æˆåŠŸã€‚å½“ç„¶ï¼Œæ€§èƒ½ç›¸å¯¹å¼‚æ­¥è½ç›˜è¾ƒå·®ï¼Œå¯é æ€§æ›´é«˜ï¼Œéœ€è¦æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨æ—¶å»å–èˆã€‚ \n\n\n# ç»“å°¾\n\nå†™çš„ç¬¬äºŒç¯‡ä¸RocketMQæºç ç›¸å…³çš„åšæ–‡ï¼Œçœ‹åˆ°æœ‰é˜…è¯»ã€ç‚¹èµã€æ”¶è—ç”šè‡³è®¢é˜…ï¼Œå¾ˆå—é¼“èˆã€‚\n\nã€ŠMessageå­˜å‚¨ã€‹æ¯”èµ·ã€ŠMessageå‘é€&æ¥æ”¶ã€‹ä»éš¾åº¦ä¸Šè¯´æ˜¯æ›´å¤§çš„ï¼Œå½“ç„¶ä¹Ÿæ˜¯æ›´æœ‰è¶£çš„ï¼Œå¦‚æœå­˜åœ¨ç†è§£é”™è¯¯æˆ–è€…è¡¨è¾¾ä¸æ¸…æ™°ï¼Œè¿˜è¯·å¤§å®¶å¤šå¤šåŒ…å«ã€‚å¦‚æœå¯ä»¥çš„è¯ï¼Œè¿˜è¯·éº»çƒ¦æ·»åŠ  QQï¼š7685413 è¿›è¡ŒæŒ‡å‡ºï¼Œé¿å…è‡ªå·±çš„ç†è§£é”™è¯¯ï¼Œç»™å¤§å®¶é€ æˆå›°æ‰°ã€‚\n\næ¨è[ã€ŠKafkaè®¾è®¡è§£æï¼ˆå…­ï¼‰- Kafkaé«˜æ€§èƒ½æ¶æ„ä¹‹é“ã€‹](http://www.jasongj.com/kafka/high_throughput/?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)ï¼Œä½œè€…ç«™åœ¨çš„é«˜åº¦æ¯”æˆ‘é«˜çš„å¤šçš„å¤šï¼Œå—¯ï¼ŒæŒ‰ç…§æå°ç’çš„è¯´æ³•ï¼šé«˜ä¸€ä¸ªå–œé©¬æ‹‰é›…å±±ã€‚ğŸ˜ˆè®¤çœŸå•ƒè¯»ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°(åŸä¹¦ç¬¬3ç‰ˆ)ã€‹ï¼Œday day upã€‚\n\nå†æ¬¡æ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ã€ç‚¹èµã€æ”¶è—ã€‚\n\nä¸‹ä¸€ç¯‡ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ã€‹](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/) èµ·èˆªï¼\n\n\n","slug":"RocketMQ/message-store","published":1,"updated":"2017-06-08T10:47:50.000Z","_id":"cj3ndswzk000uak5dwrxn81cd","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>åŸæ–‡åœ°å€ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-store/\">http://www.yunai.me/RocketMQ/message-store/</a><br>\n<code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/incubator-rocketmq</a><br>\n**ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **</p>\n</blockquote>\n<p><img src=\"http://www.yunai.me/images/common/wechat_mp.jpeg\" alt=\"wechat_mp\"></p>\n<hr>\n<ul>\n<li><a href=\"#\">1ã€æ¦‚è¿°</a></li>\n<li><a href=\"#\">2ã€CommitLog ç»“æ„</a></li>\n<li><a href=\"#\">3ã€CommitLog å­˜å‚¨æ¶ˆæ¯</a>\n<ul>\n<li><a href=\"#\">CommitLog#putMessage(...)</a></li>\n<li><a href=\"#\">MappedFileQueue#getLastMappedFile(...)</a></li>\n<li><a href=\"#\">MappedFile#appendMessage(...)</a></li>\n<li><a href=\"#\">DefaultAppendMessageCallback#doAppend(...)</a></li>\n<li><a href=\"#\">FlushCommitLogService</a>\n<ul>\n<li><a href=\"#\">MappedFile#è½ç›˜</a></li>\n<li><a href=\"#\">FlushRealTimeService</a></li>\n<li><a href=\"#\">CommitRealTimeService</a></li>\n<li><a href=\"#\">GroupCommitService</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">ç»“å°¾</a></li>\n</ul>\n<h1>1ã€æ¦‚è¿°</h1>\n<p>æœ¬æ–‡æ¥<a href=\"http://www.yunai.me/RocketMQ/message-send-and-receive/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶ã€‹</a>ã€‚\nä¸»è¦è§£æ <code>CommitLog</code> å­˜å‚¨æ¶ˆæ¯éƒ¨åˆ†ã€‚</p>\n<h1>2ã€CommitLog ç»“æ„</h1>\n<p><code>CommitLog</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å…³ç³»å¦‚ä¸‹ï¼š</p>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_23/02.png\" alt=\"CommitLogã€MappedFileQueueã€MappedFileçš„å…³ç³»\">\n<code>CommitLog</code> : <code>MappedFileQueue</code> : <code>MappedFile</code> = 1 : 1 : Nã€‚</p>\n</blockquote>\n<p>ååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š</p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><div class=\"line\">Yunai-MacdeMacBook-Pro-2:commitlog yunai$ <span class=\"built_in\">pwd</span></div><div class=\"line\">/Users/yunai/store/commitlog</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:commitlog yunai$ ls -l</div><div class=\"line\">total 10485760</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:27 00000000000000000000</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:29 00000000001073741824</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:32 00000000002147483648</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:33 00000000003221225472</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:32 00000000004294967296</div></pre></td></tr></table></figure></p>\n<hr>\n<p><code>CommitLog</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>\n<ul>\n<li><code>MappedFile</code> ï¼š00000000000000000000ã€00000000001073741824ã€00000000002147483648ç­‰æ–‡ä»¶ã€‚</li>\n<li><code>MappedFileQueue</code> ï¼š<code>MappedFile</code> æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ <code>MappedFile</code> è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚\n<ul>\n<li>æ¯ä¸ª <code>MappedFile</code> ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚</li>\n<li>æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ <code>CommitLog</code> é‡Œé»˜è®¤ä¸º 1GBã€‚</li>\n</ul>\n</li>\n<li><code>CommitLog</code> ï¼šé’ˆå¯¹ <code>MappedFileQueue</code> çš„å°è£…ä½¿ç”¨ã€‚</li>\n</ul>\n<p><code>CommitLog</code> ç›®å‰å­˜å‚¨åœ¨ <code>MappedFile</code> æœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š</p>\n<ol>\n<li>MESSAGE ï¼šæ¶ˆæ¯ã€‚</li>\n<li>BLANK ï¼šæ–‡ä»¶ä¸è¶³ä»¥å­˜å‚¨æ¶ˆæ¯æ—¶çš„ç©ºç™½å ä½ã€‚</li>\n</ol>\n<p><code>CommitLog</code> å­˜å‚¨åœ¨ <code>MappedFile</code>çš„ç»“æ„ï¼š</p>\n<blockquote>\n<table>\n<thead>\n<tr>\n<th>MESSAGE[1]</th>\n<th>MESSAGE[2]</th>\n<th>...</th>\n<th>MESSAGE[n - 1]</th>\n<th>MESSAGE[n]</th>\n<th>BLANK</th>\n</tr>\n</thead>\n<tbody></tbody>\n</table>\n</blockquote>\n<p><code>MESSAGE</code> åœ¨ <code>CommitLog</code> å­˜å‚¨ç»“æ„ï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">MsgLen</td>\n<td style=\"text-align:left\">æ¶ˆæ¯æ€»é•¿åº¦</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">MagicCode</td>\n<td style=\"text-align:left\">MESSAGE_MAGIC_CODE</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">BodyCRC</td>\n<td style=\"text-align:left\">æ¶ˆæ¯å†…å®¹CRC</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">QueueId</td>\n<td style=\"text-align:left\">æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">5</td>\n<td style=\"text-align:left\">Flag</td>\n<td style=\"text-align:left\">flag</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">6</td>\n<td style=\"text-align:left\">QueueOffset</td>\n<td style=\"text-align:left\">æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">7</td>\n<td style=\"text-align:left\">PhysicalOffset</td>\n<td style=\"text-align:left\">ç‰©ç†ä½ç½®ã€‚åœ¨ <code>CommitLog</code> çš„é¡ºåºå­˜å‚¨ä½ç½®ã€‚</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">8</td>\n<td style=\"text-align:left\">SysFlag</td>\n<td style=\"text-align:left\">MessageSysFlag</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">9</td>\n<td style=\"text-align:left\">BornTimestamp</td>\n<td style=\"text-align:left\">ç”Ÿæˆæ¶ˆæ¯æ—¶é—´æˆ³</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">10</td>\n<td style=\"text-align:left\">BornHost</td>\n<td style=\"text-align:left\">ç”Ÿæ•ˆæ¶ˆæ¯çš„åœ°å€+ç«¯å£</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">11</td>\n<td style=\"text-align:left\">StoreTimestamp</td>\n<td style=\"text-align:left\">å­˜å‚¨æ¶ˆæ¯æ—¶é—´æˆ³</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">12</td>\n<td style=\"text-align:left\">StoreHost</td>\n<td style=\"text-align:left\">å­˜å‚¨æ¶ˆæ¯çš„åœ°å€+ç«¯å£</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">13</td>\n<td style=\"text-align:left\">ReconsumeTimes</td>\n<td style=\"text-align:left\">é‡æ–°æ¶ˆè´¹æ¶ˆæ¯æ¬¡æ•°</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">14</td>\n<td style=\"text-align:left\">PreparedTransationOffset</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">15</td>\n<td style=\"text-align:left\">BodyLength + Body</td>\n<td style=\"text-align:left\">å†…å®¹é•¿åº¦ + å†…å®¹</td>\n<td style=\"text-align:left\">Int + Bytes</td>\n<td style=\"text-align:left\">4 + bodyLength</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">16</td>\n<td style=\"text-align:left\">TopicLength + Topic</td>\n<td style=\"text-align:left\">Topicé•¿åº¦ + Topic</td>\n<td style=\"text-align:left\">Byte + Bytes</td>\n<td style=\"text-align:left\">1 + topicLength</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">17</td>\n<td style=\"text-align:left\">PropertiesLength + Properties</td>\n<td style=\"text-align:left\">æ‹“å±•å­—æ®µé•¿åº¦ + æ‹“å±•å­—æ®µ</td>\n<td style=\"text-align:left\">Short + Bytes</td>\n<td style=\"text-align:left\">2 + PropertiesLength</td>\n</tr>\n</tbody>\n</table>\n<p><code>BLANK</code> åœ¨ <code>CommitLog</code> å­˜å‚¨ç»“æ„ï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">maxBlank</td>\n<td style=\"text-align:left\">ç©ºç™½é•¿åº¦</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">MagicCode</td>\n<td style=\"text-align:left\">BLANK_MAGIC_CODE</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n</tbody>\n</table>\n<h1>3ã€CommitLog å­˜å‚¨æ¶ˆæ¯</h1>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_23/01.png\" alt=\"Brokerå­˜å‚¨å‘é€æ¶ˆæ¯é¡ºåºå›¾\"></p>\n</blockquote>\n<h2>CommitLog#putMessage(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> PutMessageResult <span class=\"title\">putMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"comment\">// Set the storage time</span></div><div class=\"line\">  <span class=\"number\">3</span>:     msg.setStoreTimestamp(System.currentTimeMillis());</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"comment\">// Set the message body BODY CRC (consider the most appropriate setting</span></div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"comment\">// on the client)</span></div><div class=\"line\">  <span class=\"number\">6</span>:     msg.setBodyCRC(UtilAll.crc32(msg.getBody()));</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"comment\">// Back to Results</span></div><div class=\"line\">  <span class=\"number\">8</span>:     AppendMessageResult result = <span class=\"keyword\">null</span>;</div><div class=\"line\">  <span class=\"number\">9</span>: </div><div class=\"line\"> <span class=\"number\">10</span>:     StoreStatsService storeStatsService = <span class=\"keyword\">this</span>.defaultMessageStore.getStoreStatsService();</div><div class=\"line\"> <span class=\"number\">11</span>: </div><div class=\"line\"> <span class=\"number\">12</span>:     String topic = msg.getTopic();</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">int</span> queueId = msg.getQueueId();</div><div class=\"line\"> <span class=\"number\">14</span>: </div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"comment\">// äº‹åŠ¡ç›¸å…³ TODO å¾…è¯»ï¼šäº‹åŠ¡ç›¸å…³</span></div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"keyword\">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">18</span>:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"comment\">// Delay Delivery</span></div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"keyword\">if</span> (msg.getDelayTimeLevel() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"keyword\">if</span> (msg.getDelayTimeLevel() &gt; <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:                 msg.setDelayTimeLevel(<span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</div><div class=\"line\"> <span class=\"number\">23</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:             topic = ScheduleMessageService.SCHEDULE_TOPIC;</div><div class=\"line\"> <span class=\"number\">26</span>:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</div><div class=\"line\"> <span class=\"number\">27</span>: </div><div class=\"line\"> <span class=\"number\">28</span>:             <span class=\"comment\">// Backup real topic, queueId</span></div><div class=\"line\"> <span class=\"number\">29</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</div><div class=\"line\"> <span class=\"number\">30</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</div><div class=\"line\"> <span class=\"number\">31</span>:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</div><div class=\"line\"> <span class=\"number\">32</span>: </div><div class=\"line\"> <span class=\"number\">33</span>:             msg.setTopic(topic);</div><div class=\"line\"> <span class=\"number\">34</span>:             msg.setQueueId(queueId);</div><div class=\"line\"> <span class=\"number\">35</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">36</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">37</span>: </div><div class=\"line\"> <span class=\"number\">38</span>:     <span class=\"keyword\">long</span> eclipseTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">39</span>: </div><div class=\"line\"> <span class=\"number\">40</span>:     <span class=\"comment\">// è·å–å†™å…¥æ˜ å°„æ–‡ä»¶</span></div><div class=\"line\"> <span class=\"number\">41</span>:     MappedFile unlockMappedFile = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">42</span>:     MappedFile mappedFile = <span class=\"keyword\">this</span>.mappedFileQueue.getLastMappedFile();</div><div class=\"line\"> <span class=\"number\">43</span>: </div><div class=\"line\"> <span class=\"number\">44</span>:     <span class=\"comment\">// è·å–å†™å…¥é”</span></div><div class=\"line\"> <span class=\"number\">45</span>:     lockForPutMessage(); <span class=\"comment\">//spin...</span></div><div class=\"line\"> <span class=\"number\">46</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"keyword\">long</span> beginLockTimestamp = <span class=\"keyword\">this</span>.defaultMessageStore.getSystemClock().now();</div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"keyword\">this</span>.beginTimeInLock = beginLockTimestamp;</div><div class=\"line\"> <span class=\"number\">49</span>: </div><div class=\"line\"> <span class=\"number\">50</span>:         <span class=\"comment\">// Here settings are stored timestamp, in order to ensure an orderly</span></div><div class=\"line\"> <span class=\"number\">51</span>:         <span class=\"comment\">// global</span></div><div class=\"line\"> <span class=\"number\">52</span>:         msg.setStoreTimestamp(beginLockTimestamp);</div><div class=\"line\"> <span class=\"number\">53</span>: </div><div class=\"line\"> <span class=\"number\">54</span>:         <span class=\"comment\">// å½“ä¸å­˜åœ¨æ˜ å°„æ–‡ä»¶æ—¶ï¼Œè¿›è¡Œåˆ›å»º</span></div><div class=\"line\"> <span class=\"number\">55</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mappedFile || mappedFile.isFull()) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:             mappedFile = <span class=\"keyword\">this</span>.mappedFileQueue.getLastMappedFile(<span class=\"number\">0</span>); <span class=\"comment\">// Mark: NewFile may be cause noise</span></div><div class=\"line\"> <span class=\"number\">57</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">58</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mappedFile) &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:             log.error(<span class=\"string\">\"create maped file1 error, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" clientAddr: \"</span> + msg.getBornHostString());</div><div class=\"line\"> <span class=\"number\">60</span>:             beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">61</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, <span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">62</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">63</span>: </div><div class=\"line\"> <span class=\"number\">64</span>:         <span class=\"comment\">// å­˜å‚¨æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">65</span>:         result = mappedFile.appendMessage(msg, <span class=\"keyword\">this</span>.appendMessageCallback);</div><div class=\"line\"> <span class=\"number\">66</span>:         <span class=\"keyword\">switch</span> (result.getStatus()) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:             <span class=\"keyword\">case</span> PUT_OK:</div><div class=\"line\"> <span class=\"number\">68</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:             <span class=\"keyword\">case</span> END_OF_FILE: <span class=\"comment\">// å½“æ–‡ä»¶å°¾æ—¶ï¼Œè·å–æ–°çš„æ˜ å°„æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œæ’å…¥</span></div><div class=\"line\"> <span class=\"number\">70</span>:                 unlockMappedFile = mappedFile;</div><div class=\"line\"> <span class=\"number\">71</span>:                 <span class=\"comment\">// Create a new file, re-write the message</span></div><div class=\"line\"> <span class=\"number\">72</span>:                 mappedFile = <span class=\"keyword\">this</span>.mappedFileQueue.getLastMappedFile(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">73</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mappedFile) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:                     <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">75</span>:                     log.error(<span class=\"string\">\"create maped file2 error, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" clientAddr: \"</span> + msg.getBornHostString());</div><div class=\"line\"> <span class=\"number\">76</span>:                     beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">77</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);</div><div class=\"line\"> <span class=\"number\">78</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">79</span>:                 result = mappedFile.appendMessage(msg, <span class=\"keyword\">this</span>.appendMessageCallback);</div><div class=\"line\"> <span class=\"number\">80</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">81</span>:             <span class=\"keyword\">case</span> MESSAGE_SIZE_EXCEEDED:</div><div class=\"line\"> <span class=\"number\">82</span>:             <span class=\"keyword\">case</span> PROPERTIES_SIZE_EXCEEDED:</div><div class=\"line\"> <span class=\"number\">83</span>:                 beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">84</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);</div><div class=\"line\"> <span class=\"number\">85</span>:             <span class=\"keyword\">case</span> UNKNOWN_ERROR:</div><div class=\"line\"> <span class=\"number\">86</span>:                 beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">87</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</div><div class=\"line\"> <span class=\"number\">88</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">89</span>:                 beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">90</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</div><div class=\"line\"> <span class=\"number\">91</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:         eclipseTimeInLock = <span class=\"keyword\">this</span>.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;</div><div class=\"line\"> <span class=\"number\">94</span>:         beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">95</span>:     &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:         <span class=\"comment\">// é‡Šæ”¾å†™å…¥é”</span></div><div class=\"line\"> <span class=\"number\">97</span>:         releasePutMessageLock();</div><div class=\"line\"> <span class=\"number\">98</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">99</span>: </div><div class=\"line\"><span class=\"number\">100</span>:     <span class=\"keyword\">if</span> (eclipseTimeInLock &gt; <span class=\"number\">500</span>) &#123;</div><div class=\"line\"><span class=\"number\">101</span>:         log.warn(<span class=\"string\">\"[NOTIFYME]putMessage in lock cost time(ms)=&#123;&#125;, bodyLength=&#123;&#125; AppendMessageResult=&#123;&#125;\"</span>, eclipseTimeInLock, msg.getBody().length, result);</div><div class=\"line\"><span class=\"number\">102</span>:     &#125;</div><div class=\"line\"><span class=\"number\">103</span>: </div><div class=\"line\"><span class=\"number\">104</span>:     <span class=\"comment\">// </span></div><div class=\"line\"><span class=\"number\">105</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != unlockMappedFile &amp;&amp; <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) &#123;</div><div class=\"line\"><span class=\"number\">106</span>:         <span class=\"keyword\">this</span>.defaultMessageStore.unlockMappedFile(unlockMappedFile);</div><div class=\"line\"><span class=\"number\">107</span>:     &#125;</div><div class=\"line\"><span class=\"number\">108</span>: </div><div class=\"line\"><span class=\"number\">109</span>:     PutMessageResult putMessageResult = <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.PUT_OK, result);</div><div class=\"line\"><span class=\"number\">110</span>: </div><div class=\"line\"><span class=\"number\">111</span>:     <span class=\"comment\">// Statistics</span></div><div class=\"line\"><span class=\"number\">112</span>:     storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).incrementAndGet();</div><div class=\"line\"><span class=\"number\">113</span>:     storeStatsService.getSinglePutMessageTopicSizeTotal(topic).addAndGet(result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">114</span>: </div><div class=\"line\"><span class=\"number\">115</span>:     <span class=\"comment\">// è¿›è¡ŒåŒæ­¥||å¼‚æ­¥ flush||commit</span></div><div class=\"line\"><span class=\"number\">116</span>:     GroupCommitRequest request = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">117</span>:     <span class=\"comment\">// Synchronization flush</span></div><div class=\"line\"><span class=\"number\">118</span>:     <span class=\"keyword\">if</span> (FlushDiskType.SYNC_FLUSH == <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) &#123;</div><div class=\"line\"><span class=\"number\">119</span>:         <span class=\"keyword\">final</span> GroupCommitService service = (GroupCommitService) <span class=\"keyword\">this</span>.flushCommitLogService;</div><div class=\"line\"><span class=\"number\">120</span>:         <span class=\"keyword\">if</span> (msg.isWaitStoreMsgOK()) &#123;</div><div class=\"line\"><span class=\"number\">121</span>:             request = <span class=\"keyword\">new</span> GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">122</span>:             service.putRequest(request);</div><div class=\"line\"><span class=\"number\">123</span>:             <span class=\"keyword\">boolean</span> flushOK = request.waitForFlush(<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</div><div class=\"line\"><span class=\"number\">124</span>:             <span class=\"keyword\">if</span> (!flushOK) &#123;</div><div class=\"line\"><span class=\"number\">125</span>:                 log.error(<span class=\"string\">\"do groupcommit, wait for flush failed, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" tags: \"</span> + msg.getTags()</div><div class=\"line\"><span class=\"number\">126</span>:                     + <span class=\"string\">\" client address: \"</span> + msg.getBornHostString());</div><div class=\"line\"><span class=\"number\">127</span>:                 putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);</div><div class=\"line\"><span class=\"number\">128</span>:             &#125;</div><div class=\"line\"><span class=\"number\">129</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">130</span>:             service.wakeup();</div><div class=\"line\"><span class=\"number\">131</span>:         &#125;</div><div class=\"line\"><span class=\"number\">132</span>:     &#125;</div><div class=\"line\"><span class=\"number\">133</span>:     <span class=\"comment\">// Asynchronous flush</span></div><div class=\"line\"><span class=\"number\">134</span>:     <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">135</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().isTransientStorePoolEnable()) &#123;</div><div class=\"line\"><span class=\"number\">136</span>:             flushCommitLogService.wakeup(); <span class=\"comment\">// importantï¼šå”¤é†’commitLogçº¿ç¨‹ï¼Œè¿›è¡Œflush</span></div><div class=\"line\"><span class=\"number\">137</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">138</span>:             commitLogService.wakeup();</div><div class=\"line\"><span class=\"number\">139</span>:         &#125;</div><div class=\"line\"><span class=\"number\">140</span>:     &#125;</div><div class=\"line\"><span class=\"number\">141</span>: </div><div class=\"line\"><span class=\"number\">142</span>:     <span class=\"comment\">// Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹ // TODO å¾…è¯»ï¼šæ•°æ®åŒæ­¥</span></div><div class=\"line\"><span class=\"number\">143</span>:     <span class=\"keyword\">if</span> (BrokerRole.SYNC_MASTER == <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class=\"line\"><span class=\"number\">144</span>:         HAService service = <span class=\"keyword\">this</span>.defaultMessageStore.getHaService();</div><div class=\"line\"><span class=\"number\">145</span>:         <span class=\"keyword\">if</span> (msg.isWaitStoreMsgOK()) &#123;</div><div class=\"line\"><span class=\"number\">146</span>:             <span class=\"comment\">// Determine whether to wait</span></div><div class=\"line\"><span class=\"number\">147</span>:             <span class=\"keyword\">if</span> (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) &#123;</div><div class=\"line\"><span class=\"number\">148</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == request) &#123;</div><div class=\"line\"><span class=\"number\">149</span>:                     request = <span class=\"keyword\">new</span> GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">150</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">151</span>:                 service.putRequest(request);</div><div class=\"line\"><span class=\"number\">152</span>: </div><div class=\"line\"><span class=\"number\">153</span>:                 service.getWaitNotifyObject().wakeupAll();</div><div class=\"line\"><span class=\"number\">154</span>: </div><div class=\"line\"><span class=\"number\">155</span>:                 <span class=\"keyword\">boolean</span> flushOK =</div><div class=\"line\"><span class=\"number\">156</span>:                     <span class=\"comment\">// TODO</span></div><div class=\"line\"><span class=\"number\">157</span>:                     request.waitForFlush(<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</div><div class=\"line\"><span class=\"number\">158</span>:                 <span class=\"keyword\">if</span> (!flushOK) &#123;</div><div class=\"line\"><span class=\"number\">159</span>:                     log.error(<span class=\"string\">\"do sync transfer other node, wait return, but failed, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" tags: \"</span></div><div class=\"line\"><span class=\"number\">160</span>:                         + msg.getTags() + <span class=\"string\">\" client address: \"</span> + msg.getBornHostString());</div><div class=\"line\"><span class=\"number\">161</span>:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);</div><div class=\"line\"><span class=\"number\">162</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">163</span>:             &#125;</div><div class=\"line\"><span class=\"number\">164</span>:             <span class=\"comment\">// Slave problem</span></div><div class=\"line\"><span class=\"number\">165</span>:             <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">166</span>:                 <span class=\"comment\">// Tell the producer, slave not available</span></div><div class=\"line\"><span class=\"number\">167</span>:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">168</span>:             &#125;</div><div class=\"line\"><span class=\"number\">169</span>:         &#125;</div><div class=\"line\"><span class=\"number\">170</span>:     &#125;</div><div class=\"line\"><span class=\"number\">171</span>: </div><div class=\"line\"><span class=\"number\">172</span>:     <span class=\"keyword\">return</span> putMessageResult;</div><div class=\"line\"><span class=\"number\">173</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œå¹¶è¿”å›å­˜å‚¨ç»“æœã€‚</li>\n<li>ç¬¬ 2 è¡Œ ï¼šè®¾ç½®å­˜å‚¨æ—¶é—´ç­‰ã€‚</li>\n<li>ç¬¬ 16 è‡³ 36 è¡Œ ï¼šäº‹åŠ¡æ¶ˆæ¯ç›¸å…³ï¼Œæš‚æœªäº†è§£ã€‚</li>\n<li>ç¬¬ 45 &amp; 97 è¡Œ ï¼šè·å–é”ä¸é‡Šæ”¾é”ã€‚</li>\n<li>ç¬¬ 52 è¡Œ ï¼šå†æ¬¡è®¾ç½®å­˜å‚¨æ—¶é—´ã€‚ç›®å‰ä¼šæœ‰å¤šå¤„åœ°æ–¹è®¾ç½®å­˜å‚¨æ—¶é—´ã€‚</li>\n<li>ç¬¬ 55 è‡³ 62 è¡Œ ï¼šè·å– <code>MappedFile</code>ï¼Œè‹¥ä¸å­˜åœ¨æˆ–å·²æ»¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#mappedfilequeuegetlastmappedfile\">MappedFileQueue#getLastMappedFile(...)</a>ã€‚</li>\n<li>ç¬¬ 65 è¡Œ ï¼š<strong>æ’å…¥æ¶ˆæ¯</strong>åˆ° <code>MappedFile</code>ï¼Œè§£æè§£æè§ï¼š<a href=\"#mappedfileappendmessage\">MappedFile#appendMessage(...)</a>ã€‚</li>\n<li>ç¬¬ 69 è‡³ 80 è¡Œ ï¼š<code>MappedFile</code> å·²æ»¡ï¼Œåˆ›å»ºæ–°çš„ï¼Œå†æ¬¡<strong>æ’å…¥æ¶ˆæ¯</strong>ã€‚</li>\n<li>ç¬¬ 116 è‡³ 140 è¡Œ ï¼š<strong>æ¶ˆæ¯åˆ·ç›˜</strong>ï¼Œå³æŒä¹…åŒ–åˆ°æ–‡ä»¶ã€‚ä¸Šé¢<strong>æ’å…¥æ¶ˆæ¯</strong>å®é™…æœªå­˜å‚¨åˆ°ç¡¬ç›˜ã€‚æ­¤å¤„ï¼Œæ ¹æ®ä¸åŒçš„åˆ·ç›˜ç­–ç•¥ï¼Œæ‰§è¡Œä¼šæœ‰ä¸åŒã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#flushcommitlogservice\">FlushCommitLogService</a>ã€‚</li>\n<li>ç¬¬ 143 è‡³ 173 è¡Œ ï¼š<code>Broker</code> ä¸»ä»åŒæ­¥ã€‚åé¢çš„æ–‡ç« ä¼šè¯¦ç»†è§£æğŸ˜ˆã€‚</li>\n</ul>\n<h2>MappedFileQueue#getLastMappedFile(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> MappedFile <span class=\"title\">getLastMappedFile</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> startOffset, <span class=\"keyword\">boolean</span> needCreate)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">long</span> createOffset = -<span class=\"number\">1</span>; <span class=\"comment\">// åˆ›å»ºæ–‡ä»¶å¼€å§‹offsetã€‚-1æ—¶ï¼Œä¸åˆ›å»º</span></div><div class=\"line\"> <span class=\"number\">3</span>:     MappedFile mappedFileLast = getLastMappedFile();</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (mappedFileLast == <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// ä¸€ä¸ªæ˜ å°„æ–‡ä»¶éƒ½ä¸å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">6</span>:         createOffset = startOffset - (startOffset % <span class=\"keyword\">this</span>.mappedFileSize);</div><div class=\"line\"> <span class=\"number\">7</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (mappedFileLast != <span class=\"keyword\">null</span> &amp;&amp; mappedFileLast.isFull()) &#123; <span class=\"comment\">// æœ€åä¸€ä¸ªæ–‡ä»¶å·²æ»¡</span></div><div class=\"line\"><span class=\"number\">10</span>:         createOffset = mappedFileLast.getFileFromOffset() + <span class=\"keyword\">this</span>.mappedFileSize;</div><div class=\"line\"><span class=\"number\">11</span>:     &#125;</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (createOffset != -<span class=\"number\">1</span> &amp;&amp; needCreate) &#123; <span class=\"comment\">// åˆ›å»ºæ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">14</span>:         String nextFilePath = <span class=\"keyword\">this</span>.storePath + File.separator + UtilAll.offset2FileName(createOffset);</div><div class=\"line\"><span class=\"number\">15</span>:         String nextNextFilePath = <span class=\"keyword\">this</span>.storePath + File.separator</div><div class=\"line\"><span class=\"number\">16</span>:             + UtilAll.offset2FileName(createOffset + <span class=\"keyword\">this</span>.mappedFileSize);</div><div class=\"line\"><span class=\"number\">17</span>:         MappedFile mappedFile = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">18</span>: </div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.allocateMappedFileService != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             mappedFile = <span class=\"keyword\">this</span>.allocateMappedFileService.putRequestAndReturnMappedFile(nextFilePath,</div><div class=\"line\"><span class=\"number\">21</span>:                 nextNextFilePath, <span class=\"keyword\">this</span>.mappedFileSize);</div><div class=\"line\"><span class=\"number\">22</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 mappedFile = <span class=\"keyword\">new</span> MappedFile(nextFilePath, <span class=\"keyword\">this</span>.mappedFileSize);</div><div class=\"line\"><span class=\"number\">25</span>:             &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 log.error(<span class=\"string\">\"create mappedFile exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">if</span> (mappedFile != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.mappedFiles.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                 mappedFile.setFirstCreateInQueue(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">33</span>:             &#125;</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">this</span>.mappedFiles.add(mappedFile);</div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:         <span class=\"keyword\">return</span> mappedFile;</div><div class=\"line\"><span class=\"number\">38</span>:     &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"keyword\">return</span> mappedFileLast;</div><div class=\"line\"><span class=\"number\">41</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>\n<p>è¯´æ˜ ï¼šè·å–æœ€åä¸€ä¸ª <code>MappedFile</code>ï¼Œè‹¥ä¸å­˜åœ¨æˆ–æ–‡ä»¶å·²æ»¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚</p>\n</li>\n<li>\n<p>ç¬¬ 5 è‡³ 11 è¡Œ ï¼šè®¡ç®—å½“æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²æ»¡æ—¶ï¼Œæ–°åˆ›å»ºæ–‡ä»¶çš„ <code>createOffset</code>ã€‚</p>\n</li>\n<li>\n<p>ç¬¬ 14 è¡Œ ï¼šè®¡ç®—æ–‡ä»¶åã€‚ä»æ­¤å¤„æˆ‘ä»¬å¯\nä»¥å¾—çŸ¥ï¼Œ<code>MappedFile</code>çš„æ–‡ä»¶å‘½åè§„åˆ™ï¼š</p>\n<blockquote>\n<p>fileName[n] = fileName[n - 1] + n * mappedFileSize\nfileName[0] = startOffset - (startOffset % this.mappedFileSize)</p>\n</blockquote>\n<p>ç›®å‰ <code>CommitLog</code> çš„ <code>startOffset</code> ä¸º 0ã€‚\næ­¤å¤„æœ‰ä¸ª<strong>ç–‘é—®</strong>ï¼Œä¸ºä»€ä¹ˆéœ€è¦ <code>(startOffset % this.mappedFileSize)</code>ã€‚ä¾‹å¦‚ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>startOffset</th>\n<th style=\"text-align:left\">mappedFileSize</th>\n<th style=\"text-align:left\">createOffset</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">5</td>\n</tr>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">3</td>\n</tr>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">&gt; 5</td>\n<td style=\"text-align:left\">0</td>\n</tr>\n</tbody>\n</table>\n<p><em>å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦ï¼Œéº»çƒ¦æç¤ºä¸‹ã€‚ğŸ˜ˆ</em>\n<em>è§£ç­”ï¼šfileName[0] = startOffset - (startOffset % this.mappedFileSize) è®¡ç®—å‡ºæ¥çš„æ˜¯ï¼Œä»¥ <code>this.mappedFileSize</code> ä¸ºæ¯ä¸ªæ–‡ä»¶å¤§å°æ—¶ï¼Œ<code>startOffset</code> æ‰€åœ¨æ–‡ä»¶çš„å¼€å§‹<code>offset</code></em></p>\n</li>\n<li>\n<p>ç¬¬ 30 è‡³ 35 è¡Œ ï¼šè®¾ç½® <code>MappedFile</code>æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªåˆ›å»ºçš„æ–‡ä»¶ã€‚è¯¥æ ‡è¯†ç”¨äº <code>ConsumeQueue</code> å¯¹åº”çš„ <code>MappedFile</code> ï¼Œè¯¦è§ <code>ConsumeQueue#fillPreBlank</code>ã€‚</p>\n</li>\n</ul>\n<h2>MappedFile#appendMessage(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> AppendMessageResult <span class=\"title\">appendMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExtBrokerInner msg, <span class=\"keyword\">final</span> AppendMessageCallback cb)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">assert</span> msg != <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">assert</span> cb != <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">int</span> currentPos = <span class=\"keyword\">this</span>.wrotePosition.get();</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">if</span> (currentPos &lt; <span class=\"keyword\">this</span>.fileSize) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:         ByteBuffer byteBuffer = writeBuffer != <span class=\"keyword\">null</span> ? writeBuffer.slice() : <span class=\"keyword\">this</span>.mappedByteBuffer.slice();</div><div class=\"line\"> <span class=\"number\">9</span>:         byteBuffer.position(currentPos);</div><div class=\"line\"><span class=\"number\">10</span>:         AppendMessageResult result =</div><div class=\"line\"><span class=\"number\">11</span>:             cb.doAppend(<span class=\"keyword\">this</span>.getFileFromOffset(), byteBuffer, <span class=\"keyword\">this</span>.fileSize - currentPos, msg);</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">this</span>.wrotePosition.addAndGet(result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">this</span>.storeTimestamp = result.getStoreTimestamp();</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">15</span>:     &#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:     log.error(<span class=\"string\">\"MappedFile.appendMessage return null, wrotePosition: \"</span> + currentPos + <span class=\"string\">\" fileSize: \"</span></div><div class=\"line\"><span class=\"number\">18</span>:         + <span class=\"keyword\">this</span>.fileSize);</div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);</div><div class=\"line\"><span class=\"number\">20</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼š<strong>æ’å…¥æ¶ˆæ¯</strong>åˆ° <code>MappedFile</code>ï¼Œå¹¶è¿”å›æ’å…¥ç»“æœã€‚</li>\n<li>ç¬¬ 8 è¡Œ ï¼šè·å–éœ€è¦å†™å…¥çš„å­—èŠ‚ç¼“å†²åŒºã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ <code>writeBuffer != null</code> çš„åˆ¤æ–­åï¼Œä½¿ç”¨ä¸åŒçš„å­—èŠ‚ç¼“å†²åŒºï¼Œè§ï¼š<a href=\"#flushcommitlogservice\">FlushCommitLogService</a>ã€‚</li>\n<li>ç¬¬ 9 è‡³ 11 è¡Œ ï¼šè®¾ç½®å†™å…¥ <code>position</code>ï¼Œæ‰§è¡Œå†™å…¥ï¼Œæ›´æ–° <code>wrotePosition</code>(å½“å‰å†™å…¥ä½ç½®ï¼Œä¸‹æ¬¡å¼€å§‹å†™å…¥å¼€å§‹ä½ç½®)ã€‚</li>\n</ul>\n<h2>DefaultAppendMessageCallback#doAppend(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultAppendMessageCallback</span> <span class=\"keyword\">implements</span> <span class=\"title\">AppendMessageCallback</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"comment\">// File at the end of the minimum fixed length empty</span></div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> END_FILE_MIN_BLANK_LENGTH = <span class=\"number\">4</span> + <span class=\"number\">4</span>;</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  5:      * å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯ç¼–å·å­—èŠ‚Buffer</div><div class=\"line\">  6:      */</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ByteBuffer msgIdMemory;</div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  9:      * Store the message content</div><div class=\"line\"> 10:      * å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯å­—èŠ‚Buffer</div><div class=\"line\"> 11:      * å½“æ¶ˆæ¯ä¼ é€’åˆ°&#123;<span class=\"doctag\">@link</span> #doAppend(long, ByteBuffer, int, MessageExtBrokerInner)&#125;æ–¹æ³•æ—¶ï¼Œæœ€ç»ˆå†™åˆ°è¯¥å‚æ•°</div><div class=\"line\"> 12:      */</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ByteBuffer msgStoreItemMemory;</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 15:      * The maximum length of the message</div><div class=\"line\"> 16:      * æ¶ˆæ¯æœ€å¤§é•¿åº¦</div><div class=\"line\"> 17:      */</div><div class=\"line\"> <span class=\"number\">18</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxMessageSize;</div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 20:      * Build Message Key</div><div class=\"line\"> 21:      * &#123;<span class=\"doctag\">@link</span> #topicQueueTable&#125;çš„key</div><div class=\"line\"> 22:      * è®¡ç®—æ–¹å¼ï¼štopic + \"-\" + queueId</div><div class=\"line\"> 23:      */</div><div class=\"line\"> <span class=\"number\">24</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> StringBuilder keyBuilder = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\"> <span class=\"number\">25</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 26:      * hostå­—èŠ‚buffer</div><div class=\"line\"> 27:      * ç”¨äºé‡å¤è®¡ç®—hostçš„å­—èŠ‚å†…å®¹</div><div class=\"line\"> 28:      */</div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ByteBuffer hostHolder = ByteBuffer.allocate(<span class=\"number\">8</span>);</div><div class=\"line\"> <span class=\"number\">30</span>: </div><div class=\"line\"> <span class=\"number\">31</span>:     DefaultAppendMessageCallback(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size) &#123;</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"keyword\">this</span>.msgIdMemory = ByteBuffer.allocate(MessageDecoder.MSG_ID_LENGTH);</div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory = ByteBuffer.allocate(size + END_FILE_MIN_BLANK_LENGTH);</div><div class=\"line\"> <span class=\"number\">34</span>:         <span class=\"keyword\">this</span>.maxMessageSize = size;</div><div class=\"line\"> <span class=\"number\">35</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">36</span>: </div><div class=\"line\"> <span class=\"number\">37</span>:     <span class=\"function\"><span class=\"keyword\">public</span> ByteBuffer <span class=\"title\">getMsgStoreItemMemory</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">38</span>:         <span class=\"keyword\">return</span> msgStoreItemMemory;</div><div class=\"line\"> <span class=\"number\">39</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">40</span>: </div><div class=\"line\"> <span class=\"number\">41</span>:     <span class=\"function\"><span class=\"keyword\">public</span> AppendMessageResult <span class=\"title\">doAppend</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> fileFromOffset, <span class=\"keyword\">final</span> ByteBuffer byteBuffer, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxBlank, <span class=\"keyword\">final</span> MessageExtBrokerInner msgInner)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">42</span>:         <span class=\"comment\">// STORETIMESTAMP + STOREHOSTADDRESS + OFFSET &lt;br&gt;</span></div><div class=\"line\"> <span class=\"number\">43</span>: </div><div class=\"line\"> <span class=\"number\">44</span>:         <span class=\"comment\">// PHY OFFSET</span></div><div class=\"line\"> <span class=\"number\">45</span>:         <span class=\"keyword\">long</span> wroteOffset = fileFromOffset + byteBuffer.position();</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"comment\">// è®¡ç®—commitLogé‡Œçš„msgId</span></div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"keyword\">this</span>.resetByteBuffer(hostHolder, <span class=\"number\">8</span>);</div><div class=\"line\"> <span class=\"number\">49</span>:         String msgId = MessageDecoder.createMessageId(<span class=\"keyword\">this</span>.msgIdMemory, msgInner.getStoreHostBytes(hostHolder), wroteOffset);</div><div class=\"line\"> <span class=\"number\">50</span>: </div><div class=\"line\"> <span class=\"number\">51</span>:         <span class=\"comment\">// Record ConsumeQueue information è·å–é˜Ÿåˆ—offset</span></div><div class=\"line\"> <span class=\"number\">52</span>:         keyBuilder.setLength(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">53</span>:         keyBuilder.append(msgInner.getTopic());</div><div class=\"line\"> <span class=\"number\">54</span>:         keyBuilder.append(<span class=\"string\">'-'</span>);</div><div class=\"line\"> <span class=\"number\">55</span>:         keyBuilder.append(msgInner.getQueueId());</div><div class=\"line\"> <span class=\"number\">56</span>:         String key = keyBuilder.toString();</div><div class=\"line\"> <span class=\"number\">57</span>:         Long queueOffset = CommitLog.<span class=\"keyword\">this</span>.topicQueueTable.get(key);</div><div class=\"line\"> <span class=\"number\">58</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == queueOffset) &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:             queueOffset = <span class=\"number\">0L</span>;</div><div class=\"line\"> <span class=\"number\">60</span>:             CommitLog.<span class=\"keyword\">this</span>.topicQueueTable.put(key, queueOffset);</div><div class=\"line\"> <span class=\"number\">61</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">62</span>: </div><div class=\"line\"> <span class=\"number\">63</span>:         <span class=\"comment\">// Transaction messages that require special handling // TODO ç–‘é—®ï¼šç”¨é€”</span></div><div class=\"line\"> <span class=\"number\">64</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());</div><div class=\"line\"> <span class=\"number\">65</span>:         <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">66</span>:             <span class=\"comment\">// Prepared and Rollback message is not consumed, will not enter the</span></div><div class=\"line\"> <span class=\"number\">67</span>:             <span class=\"comment\">// consumer queue</span></div><div class=\"line\"> <span class=\"number\">68</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class=\"line\"> <span class=\"number\">69</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class=\"line\"> <span class=\"number\">70</span>:                 queueOffset = <span class=\"number\">0L</span>;</div><div class=\"line\"> <span class=\"number\">71</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">72</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class=\"line\"> <span class=\"number\">73</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class=\"line\"> <span class=\"number\">74</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">75</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">76</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">77</span>: </div><div class=\"line\"> <span class=\"number\">78</span>:         <span class=\"comment\">// è®¡ç®—æ¶ˆæ¯é•¿åº¦</span></div><div class=\"line\"> <span class=\"number\">79</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] propertiesData =</div><div class=\"line\"> <span class=\"number\">80</span>:             msgInner.getPropertiesString() == <span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : msgInner.getPropertiesString().getBytes(MessageDecoder.CHARSET_UTF8);</div><div class=\"line\"> <span class=\"number\">81</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> propertiesLength = propertiesData == <span class=\"keyword\">null</span> ? <span class=\"number\">0</span> : propertiesData.length;</div><div class=\"line\"> <span class=\"number\">82</span>:         <span class=\"keyword\">if</span> (propertiesLength &gt; Short.MAX_VALUE) &#123;</div><div class=\"line\"> <span class=\"number\">83</span>:             log.warn(<span class=\"string\">\"putMessage message properties length too long. length=&#123;&#125;\"</span>, propertiesData.length);</div><div class=\"line\"> <span class=\"number\">84</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.PROPERTIES_SIZE_EXCEEDED);</div><div class=\"line\"> <span class=\"number\">85</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] topicData = msgInner.getTopic().getBytes(MessageDecoder.CHARSET_UTF8);</div><div class=\"line\"> <span class=\"number\">87</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> topicLength = topicData.length;</div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> bodyLength = msgInner.getBody() == <span class=\"keyword\">null</span> ? <span class=\"number\">0</span> : msgInner.getBody().length;</div><div class=\"line\"> <span class=\"number\">89</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> msgLen = calMsgLength(bodyLength, topicLength, propertiesLength);</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"comment\">// Exceeds the maximum message</span></div><div class=\"line\"> <span class=\"number\">91</span>:         <span class=\"keyword\">if</span> (msgLen &gt; <span class=\"keyword\">this</span>.maxMessageSize) &#123;</div><div class=\"line\"> <span class=\"number\">92</span>:             CommitLog.log.warn(<span class=\"string\">\"message size exceeded, msg total size: \"</span> + msgLen + <span class=\"string\">\", msg body size: \"</span> + bodyLength</div><div class=\"line\"> <span class=\"number\">93</span>:                 + <span class=\"string\">\", maxMessageSize: \"</span> + <span class=\"keyword\">this</span>.maxMessageSize);</div><div class=\"line\"> <span class=\"number\">94</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.MESSAGE_SIZE_EXCEEDED);</div><div class=\"line\"> <span class=\"number\">95</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">96</span>: </div><div class=\"line\"> <span class=\"number\">97</span>:         <span class=\"comment\">// Determines whether there is sufficient(è¶³å¤Ÿ) free space</span></div><div class=\"line\"> <span class=\"number\">98</span>:         <span class=\"keyword\">if</span> ((msgLen + END_FILE_MIN_BLANK_LENGTH) &gt; maxBlank) &#123;</div><div class=\"line\"> <span class=\"number\">99</span>:             <span class=\"keyword\">this</span>.resetByteBuffer(<span class=\"keyword\">this</span>.msgStoreItemMemory, maxBlank);</div><div class=\"line\"><span class=\"number\">100</span>:             <span class=\"comment\">// 1 TOTAL_SIZE</span></div><div class=\"line\"><span class=\"number\">101</span>:             <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(maxBlank);</div><div class=\"line\"><span class=\"number\">102</span>:             <span class=\"comment\">// 2 MAGIC_CODE</span></div><div class=\"line\"><span class=\"number\">103</span>:             <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(CommitLog.BLANK_MAGIC_CODE);</div><div class=\"line\"><span class=\"number\">104</span>:             <span class=\"comment\">// 3 The remaining space may be any value</span></div><div class=\"line\"><span class=\"number\">105</span>:             <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:             <span class=\"comment\">// Here the length of the specially set maxBlank</span></div><div class=\"line\"><span class=\"number\">108</span>:             <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTimeMills = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.now();</div><div class=\"line\"><span class=\"number\">109</span>:             byteBuffer.put(<span class=\"keyword\">this</span>.msgStoreItemMemory.array(), <span class=\"number\">0</span>, maxBlank);</div><div class=\"line\"><span class=\"number\">110</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.END_OF_FILE, wroteOffset, maxBlank, msgId, msgInner.getStoreTimestamp(),</div><div class=\"line\"><span class=\"number\">111</span>:                 queueOffset, CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.now() - beginTimeMills);</div><div class=\"line\"><span class=\"number\">112</span>:         &#125;</div><div class=\"line\"><span class=\"number\">113</span>: </div><div class=\"line\"><span class=\"number\">114</span>:         <span class=\"comment\">// Initialization of storage space</span></div><div class=\"line\"><span class=\"number\">115</span>:         <span class=\"keyword\">this</span>.resetByteBuffer(msgStoreItemMemory, msgLen);</div><div class=\"line\"><span class=\"number\">116</span>:         <span class=\"comment\">// 1 TOTAL_SIZE</span></div><div class=\"line\"><span class=\"number\">117</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgLen);</div><div class=\"line\"><span class=\"number\">118</span>:         <span class=\"comment\">// 2 MAGIC_CODE</span></div><div class=\"line\"><span class=\"number\">119</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(CommitLog.MESSAGE_MAGIC_CODE);</div><div class=\"line\"><span class=\"number\">120</span>:         <span class=\"comment\">// 3 BODY_CRC</span></div><div class=\"line\"><span class=\"number\">121</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getBodyCRC());</div><div class=\"line\"><span class=\"number\">122</span>:         <span class=\"comment\">// 4 QUEUE_ID</span></div><div class=\"line\"><span class=\"number\">123</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getQueueId());</div><div class=\"line\"><span class=\"number\">124</span>:         <span class=\"comment\">// 5 FLAG</span></div><div class=\"line\"><span class=\"number\">125</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getFlag());</div><div class=\"line\"><span class=\"number\">126</span>:         <span class=\"comment\">// 6 QUEUE_OFFSET</span></div><div class=\"line\"><span class=\"number\">127</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(queueOffset);</div><div class=\"line\"><span class=\"number\">128</span>:         <span class=\"comment\">// 7 PHYSICAL_OFFSET</span></div><div class=\"line\"><span class=\"number\">129</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(fileFromOffset + byteBuffer.position());</div><div class=\"line\"><span class=\"number\">130</span>:         <span class=\"comment\">// 8 SYS_FLAG</span></div><div class=\"line\"><span class=\"number\">131</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getSysFlag());</div><div class=\"line\"><span class=\"number\">132</span>:         <span class=\"comment\">// 9 BORN_TIMESTAMP</span></div><div class=\"line\"><span class=\"number\">133</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(msgInner.getBornTimestamp());</div><div class=\"line\"><span class=\"number\">134</span>:         <span class=\"comment\">// 10 BORN_HOST</span></div><div class=\"line\"><span class=\"number\">135</span>:         <span class=\"keyword\">this</span>.resetByteBuffer(hostHolder, <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">136</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.put(msgInner.getBornHostBytes(hostHolder));</div><div class=\"line\"><span class=\"number\">137</span>:         <span class=\"comment\">// 11 STORE_TIMESTAMP</span></div><div class=\"line\"><span class=\"number\">138</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(msgInner.getStoreTimestamp());</div><div class=\"line\"><span class=\"number\">139</span>:         <span class=\"comment\">// 12 STORE_HOST_ADDRESS</span></div><div class=\"line\"><span class=\"number\">140</span>:         <span class=\"keyword\">this</span>.resetByteBuffer(hostHolder, <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">141</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.put(msgInner.getStoreHostBytes(hostHolder));</div><div class=\"line\"><span class=\"number\">142</span>:         <span class=\"comment\">//this.msgStoreItemMemory.put(msgInner.getStoreHostBytes());</span></div><div class=\"line\"><span class=\"number\">143</span>:         <span class=\"comment\">// 13 RECONSUME_TIMES</span></div><div class=\"line\"><span class=\"number\">144</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">145</span>:         <span class=\"comment\">// 14 Prepared Transaction Offset</span></div><div class=\"line\"><span class=\"number\">146</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(msgInner.getPreparedTransactionOffset());</div><div class=\"line\"><span class=\"number\">147</span>:         <span class=\"comment\">// 15 BODY</span></div><div class=\"line\"><span class=\"number\">148</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(bodyLength);</div><div class=\"line\"><span class=\"number\">149</span>:         <span class=\"keyword\">if</span> (bodyLength &gt; <span class=\"number\">0</span>)</div><div class=\"line\"><span class=\"number\">150</span>:             <span class=\"keyword\">this</span>.msgStoreItemMemory.put(msgInner.getBody());</div><div class=\"line\"><span class=\"number\">151</span>:         <span class=\"comment\">// 16 TOPIC</span></div><div class=\"line\"><span class=\"number\">152</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.put((<span class=\"keyword\">byte</span>) topicLength);</div><div class=\"line\"><span class=\"number\">153</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.put(topicData);</div><div class=\"line\"><span class=\"number\">154</span>:         <span class=\"comment\">// 17 PROPERTIES</span></div><div class=\"line\"><span class=\"number\">155</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putShort((<span class=\"keyword\">short</span>) propertiesLength);</div><div class=\"line\"><span class=\"number\">156</span>:         <span class=\"keyword\">if</span> (propertiesLength &gt; <span class=\"number\">0</span>)</div><div class=\"line\"><span class=\"number\">157</span>:             <span class=\"keyword\">this</span>.msgStoreItemMemory.put(propertiesData);</div><div class=\"line\"><span class=\"number\">158</span>: </div><div class=\"line\"><span class=\"number\">159</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTimeMills = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.now();</div><div class=\"line\"><span class=\"number\">160</span>:         <span class=\"comment\">// Write messages to the queue buffer</span></div><div class=\"line\"><span class=\"number\">161</span>:         byteBuffer.put(<span class=\"keyword\">this</span>.msgStoreItemMemory.array(), <span class=\"number\">0</span>, msgLen);</div><div class=\"line\"><span class=\"number\">162</span>: </div><div class=\"line\"><span class=\"number\">163</span>:         AppendMessageResult result = <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.PUT_OK, wroteOffset, msgLen, msgId,</div><div class=\"line\"><span class=\"number\">164</span>:             msgInner.getStoreTimestamp(), queueOffset, CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.now() - beginTimeMills);</div><div class=\"line\"><span class=\"number\">165</span>: </div><div class=\"line\"><span class=\"number\">166</span>:         <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"><span class=\"number\">167</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class=\"line\"><span class=\"number\">168</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class=\"line\"><span class=\"number\">169</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">170</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class=\"line\"><span class=\"number\">171</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class=\"line\"><span class=\"number\">172</span>:                 <span class=\"comment\">// The next update ConsumeQueue information æ›´æ–°é˜Ÿåˆ—çš„offset</span></div><div class=\"line\"><span class=\"number\">173</span>:                 CommitLog.<span class=\"keyword\">this</span>.topicQueueTable.put(key, ++queueOffset);</div><div class=\"line\"><span class=\"number\">174</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">175</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">176</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">177</span>:         &#125;</div><div class=\"line\"><span class=\"number\">178</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">179</span>:     &#125;</div><div class=\"line\"><span class=\"number\">180</span>: </div><div class=\"line\"><span class=\"number\">181</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">182:      * é‡ç½®å­—èŠ‚ç¼“å†²åŒº</div><div class=\"line\">183:      *</div><div class=\"line\">184:      * <span class=\"doctag\">@param</span> byteBuffer å­—èŠ‚ç¼“å†²åŒº</div><div class=\"line\">185:      * <span class=\"doctag\">@param</span> limit é•¿åº¦</div><div class=\"line\">186:      */</div><div class=\"line\"><span class=\"number\">187</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">resetByteBuffer</span><span class=\"params\">(<span class=\"keyword\">final</span> ByteBuffer byteBuffer, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> limit)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">188</span>:         byteBuffer.flip();</div><div class=\"line\"><span class=\"number\">189</span>:         byteBuffer.limit(limit);</div><div class=\"line\"><span class=\"number\">190</span>:     &#125;</div><div class=\"line\"><span class=\"number\">191</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ’å…¥æ¶ˆæ¯åˆ°å­—èŠ‚ç¼“å†²åŒºã€‚</li>\n<li>ç¬¬ 45 è¡Œ ï¼šè®¡ç®—ç‰©ç†ä½ç½®ã€‚åœ¨ <code>CommitLog</code> çš„é¡ºåºå­˜å‚¨ä½ç½®ã€‚</li>\n<li>ç¬¬ 47 è‡³ 49 è¡Œ ï¼šè®¡ç®— <code>CommitLog</code> é‡Œçš„ <code>offsetMsgId</code>ã€‚è¿™é‡Œä¸€å®šè¦å’Œ <code>msgId</code> åŒºåˆ†å¼€ã€‚</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th>è®¡ç®—æ–¹å¼</th>\n<th>é•¿åº¦</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>offsetMsgId</td>\n<td>Brokerå­˜å‚¨æ—¶ç”Ÿæˆ</td>\n<td>Hex(storeHostBytes, wroteOffset)</td>\n<td>32</td>\n<td></td>\n</tr>\n<tr>\n<td>msgId</td>\n<td>Clientå‘é€æ¶ˆæ¯æ—¶ç”Ÿæˆ</td>\n<td>Hex(è¿›ç¨‹ç¼–å·, IP, ClassLoader, startTime, currentTime, è‡ªå¢åºåˆ—)</td>\n<td>32</td>\n<td><a href=\"http://www.yunai.me/RocketMQ/message/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message åŸºç¡€ã€‹</a></td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>ç¬¬ 51 è‡³ 61 è¡Œ ï¼šè·å–é˜Ÿåˆ—ä½ç½®(offset)ã€‚</li>\n<li>ç¬¬ 78 è‡³ 95 è¡Œ ï¼šè®¡ç®—æ¶ˆæ¯æ€»é•¿åº¦ã€‚</li>\n<li>ç¬¬ 98 è‡³ 112 è¡Œ ï¼šå½“æ–‡ä»¶å‰©ä½™ç©ºé—´ä¸è¶³æ—¶ï¼Œå†™å…¥ <code>BLANK</code> å ä½ï¼Œè¿”å›ç»“æœã€‚</li>\n<li>ç¬¬ 114 è‡³ 161 è¡Œ ï¼šå†™å…¥ <code>MESSAGE</code> ã€‚</li>\n<li>ç¬¬ 173 è¡Œ ï¼šæ›´æ–°é˜Ÿåˆ—ä½ç½®(offset)ã€‚</li>\n</ul>\n<h2>FlushCommitLogService</h2>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_23/03.png\" alt=\"FlushCommitLogServiceç±»å›¾\"></p>\n<table>\n<thead>\n<tr>\n<th>çº¿ç¨‹æœåŠ¡</th>\n<th>åœºæ™¯</th>\n<th>æ’å…¥æ¶ˆæ¯æ€§èƒ½</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CommitRealTimeService</td>\n<td>å¼‚æ­¥åˆ·ç›˜ &amp;&amp; å¼€å¯å†…å­˜å­—èŠ‚ç¼“å†²åŒº</td>\n<td>ç¬¬ä¸€</td>\n</tr>\n<tr>\n<td>FlushRealTimeService</td>\n<td>å¼‚æ­¥åˆ·ç›˜ &amp;&amp; å…³é—­å†…å­˜å­—èŠ‚ç¼“å†²åŒº</td>\n<td>ç¬¬äºŒ</td>\n</tr>\n<tr>\n<td>GroupCommitService</td>\n<td>åŒæ­¥åˆ·ç›˜</td>\n<td>ç¬¬ä¸‰</td>\n</tr>\n</tbody>\n</table>\n<h3>MappedFile#è½ç›˜</h3>\n<table>\n<thead>\n<tr>\n<th>æ–¹å¼</th>\n<th></th>\n<th style=\"text-align:left\"></th>\n<th style=\"text-align:left\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ–¹å¼ä¸€</td>\n<td>å†™å…¥å†…å­˜å­—èŠ‚ç¼“å†²åŒº(writeBuffer)</td>\n<td style=\"text-align:left\">ä»å†…å­˜å­—èŠ‚ç¼“å†²åŒº(write buffer)æäº¤(commit)åˆ°æ–‡ä»¶é€šé“(fileChannel)</td>\n<td style=\"text-align:left\">æ–‡ä»¶é€šé“(fileChannel)flush</td>\n</tr>\n<tr>\n<td>æ–¹å¼äºŒ</td>\n<td></td>\n<td style=\"text-align:left\">å†™å…¥æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer)</td>\n<td style=\"text-align:left\">æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer)flush</td>\n</tr>\n</tbody>\n</table>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_23/04.jpeg\" alt=\"MappedFileçš„positionè¿ç§»å›¾\"></p>\n<p><strong>flushç›¸å…³ä»£ç </strong></p>\n<p>è€ƒè™‘åˆ°å†™å…¥æ€§èƒ½ï¼Œæ»¡è¶³ <code>flushLeastPages * OS_PAGE_SIZE</code> æ‰è¿›è¡Œ <code>flush</code>ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * flush</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> flushLeastPages flushæœ€å°é¡µæ•°</div><div class=\"line\"> 5:  * <span class=\"doctag\">@return</span> The current flushed position</div><div class=\"line\"> 6:  */</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">flush</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> flushLeastPages)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isAbleToFlush(flushLeastPages)) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hold()) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">int</span> value = getReadPosition();</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"comment\">//We only append data to fileChannel or mappedByteBuffer, never both.</span></div><div class=\"line\"><span class=\"number\">14</span>:                 <span class=\"keyword\">if</span> (writeBuffer != <span class=\"keyword\">null</span> || <span class=\"keyword\">this</span>.fileChannel.position() != <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                     <span class=\"keyword\">this</span>.fileChannel.force(<span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">16</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                     <span class=\"keyword\">this</span>.mappedByteBuffer.force();</div><div class=\"line\"><span class=\"number\">18</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">19</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                 log.error(<span class=\"string\">\"Error occurred when force data to disk.\"</span>, e);</div><div class=\"line\"><span class=\"number\">21</span>:             &#125;</div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">this</span>.flushedPosition.set(value);</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">this</span>.release();</div><div class=\"line\"><span class=\"number\">25</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:             log.warn(<span class=\"string\">\"in flush, hold failed, flush offset = \"</span> + <span class=\"keyword\">this</span>.flushedPosition.get());</div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">this</span>.flushedPosition.set(getReadPosition());</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>:     &#125;</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.getFlushedPosition();</div><div class=\"line\"><span class=\"number\">31</span>: &#125;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>: <span class=\"comment\">/**</span></div><div class=\"line\">34:  * æ˜¯å¦èƒ½å¤Ÿflushã€‚æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä»»æ„æ¡ä»¶ï¼š</div><div class=\"line\">35:  * 1. æ˜ å°„æ–‡ä»¶å·²ç»å†™æ»¡</div><div class=\"line\">36:  * 2. flushLeastPages &gt; 0 &amp;&amp; æœªflushéƒ¨åˆ†è¶…è¿‡flushLeastPages</div><div class=\"line\">37:  * 3. flushLeastPages = 0 &amp;&amp; æœ‰æ–°å†™å…¥éƒ¨åˆ†</div><div class=\"line\">38:  *</div><div class=\"line\">39:  * <span class=\"doctag\">@param</span> flushLeastPages flushæœ€å°åˆ†é¡µ</div><div class=\"line\">40:  * <span class=\"doctag\">@return</span> æ˜¯å¦èƒ½å¤Ÿå†™å…¥</div><div class=\"line\">41:  */</div><div class=\"line\"><span class=\"number\">42</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAbleToFlush</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> flushLeastPages)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"keyword\">int</span> flush = <span class=\"keyword\">this</span>.flushedPosition.get();</div><div class=\"line\"><span class=\"number\">44</span>:     <span class=\"keyword\">int</span> write = getReadPosition();</div><div class=\"line\"><span class=\"number\">45</span>: </div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isFull()) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">48</span>:     &#125;</div><div class=\"line\"><span class=\"number\">49</span>: </div><div class=\"line\"><span class=\"number\">50</span>:     <span class=\"keyword\">if</span> (flushLeastPages &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:         <span class=\"keyword\">return</span> ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) &gt;= flushLeastPages;</div><div class=\"line\"><span class=\"number\">52</span>:     &#125;</div><div class=\"line\"><span class=\"number\">53</span>: </div><div class=\"line\"><span class=\"number\">54</span>:     <span class=\"keyword\">return</span> write &gt; flush;</div><div class=\"line\"><span class=\"number\">55</span>: &#125;</div></pre></td></tr></table></figure></p>\n<p><strong>commitç›¸å…³ä»£ç ï¼š</strong></p>\n<p>è€ƒè™‘åˆ°å†™å…¥æ€§èƒ½ï¼Œæ»¡è¶³ <code>commitLeastPages * OS_PAGE_SIZE</code> æ‰è¿›è¡Œ <code>commit</code>ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * commit</div><div class=\"line\"> 3:  * å½“&#123;<span class=\"doctag\">@link</span> #writeBuffer&#125;ä¸ºnullæ—¶ï¼Œç›´æ¥è¿”å›&#123;<span class=\"doctag\">@link</span> #wrotePosition&#125;</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> commitLeastPages commitæœ€å°é¡µæ•°</div><div class=\"line\"> 6:  * <span class=\"doctag\">@return</span> å½“å‰commitä½ç½®</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">commit</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> commitLeastPages)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (writeBuffer == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"comment\">//no need to commit data to file channel, so just regard wrotePosition as committedPosition.</span></div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.wrotePosition.get();</div><div class=\"line\"><span class=\"number\">12</span>:     &#125;</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isAbleToCommit(commitLeastPages)) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hold()) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:             commit0(commitLeastPages);</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">this</span>.release();</div><div class=\"line\"><span class=\"number\">17</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">18</span>:             log.warn(<span class=\"string\">\"in commit, hold failed, commit offset = \"</span> + <span class=\"keyword\">this</span>.committedPosition.get());</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125;</div><div class=\"line\"><span class=\"number\">21</span>: </div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"comment\">// All dirty data has been committed to FileChannel. å†™åˆ°æ–‡ä»¶å°¾æ—¶ï¼Œå›æ”¶writeBufferã€‚</span></div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"keyword\">if</span> (writeBuffer != <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.transientStorePool != <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.fileSize == <span class=\"keyword\">this</span>.committedPosition.get()) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">this</span>.transientStorePool.returnBuffer(writeBuffer);</div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">this</span>.writeBuffer = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.committedPosition.get();</div><div class=\"line\"><span class=\"number\">29</span>: &#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>: <span class=\"comment\">/**</span></div><div class=\"line\">32:  * commitå®ç°ï¼Œå°†writeBufferå†™å…¥fileChannelã€‚</div><div class=\"line\">33:  * <span class=\"doctag\">@param</span> commitLeastPages commitæœ€å°é¡µæ•°ã€‚ç”¨ä¸ä¸Šè¯¥å‚æ•°</div><div class=\"line\">34:  */</div><div class=\"line\"><span class=\"number\">35</span>: <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">commit0</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> commitLeastPages)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"keyword\">int</span> writePos = <span class=\"keyword\">this</span>.wrotePosition.get();</div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"keyword\">int</span> lastCommittedPosition = <span class=\"keyword\">this</span>.committedPosition.get();</div><div class=\"line\"><span class=\"number\">38</span>: </div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"keyword\">if</span> (writePos - <span class=\"keyword\">this</span>.committedPosition.get() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">41</span>:             <span class=\"comment\">// è®¾ç½®éœ€è¦å†™å…¥çš„byteBuffer</span></div><div class=\"line\"><span class=\"number\">42</span>:             ByteBuffer byteBuffer = writeBuffer.slice();</div><div class=\"line\"><span class=\"number\">43</span>:             byteBuffer.position(lastCommittedPosition);</div><div class=\"line\"><span class=\"number\">44</span>:             byteBuffer.limit(writePos);</div><div class=\"line\"><span class=\"number\">45</span>:             <span class=\"comment\">// å†™å…¥fileChannel</span></div><div class=\"line\"><span class=\"number\">46</span>:             <span class=\"keyword\">this</span>.fileChannel.position(lastCommittedPosition);</div><div class=\"line\"><span class=\"number\">47</span>:             <span class=\"keyword\">this</span>.fileChannel.write(byteBuffer);</div><div class=\"line\"><span class=\"number\">48</span>:             <span class=\"comment\">// è®¾ç½®position</span></div><div class=\"line\"><span class=\"number\">49</span>:             <span class=\"keyword\">this</span>.committedPosition.set(writePos);</div><div class=\"line\"><span class=\"number\">50</span>:         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:             log.error(<span class=\"string\">\"Error occurred when commit data to FileChannel.\"</span>, e);</div><div class=\"line\"><span class=\"number\">52</span>:         &#125;</div><div class=\"line\"><span class=\"number\">53</span>:     &#125;</div><div class=\"line\"><span class=\"number\">54</span>: &#125;</div><div class=\"line\"><span class=\"number\">55</span>: </div><div class=\"line\"><span class=\"number\">56</span>: <span class=\"comment\">/**</span></div><div class=\"line\">57:  * æ˜¯å¦èƒ½å¤Ÿcommitã€‚æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä»»æ„æ¡ä»¶ï¼š</div><div class=\"line\">58:  * 1. æ˜ å°„æ–‡ä»¶å·²ç»å†™æ»¡</div><div class=\"line\">59:  * 2. commitLeastPages &gt; 0 &amp;&amp; æœªcommitéƒ¨åˆ†è¶…è¿‡commitLeastPages</div><div class=\"line\">60:  * 3. commitLeastPages = 0 &amp;&amp; æœ‰æ–°å†™å…¥éƒ¨åˆ†</div><div class=\"line\">61:  *</div><div class=\"line\">62:  * <span class=\"doctag\">@param</span> commitLeastPages commitæœ€å°åˆ†é¡µ</div><div class=\"line\">63:  * <span class=\"doctag\">@return</span> æ˜¯å¦èƒ½å¤Ÿå†™å…¥</div><div class=\"line\">64:  */</div><div class=\"line\"><span class=\"number\">65</span>: <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAbleToCommit</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> commitLeastPages)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">66</span>:     <span class=\"keyword\">int</span> flush = <span class=\"keyword\">this</span>.committedPosition.get();</div><div class=\"line\"><span class=\"number\">67</span>:     <span class=\"keyword\">int</span> write = <span class=\"keyword\">this</span>.wrotePosition.get();</div><div class=\"line\"><span class=\"number\">68</span>: </div><div class=\"line\"><span class=\"number\">69</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isFull()) &#123;</div><div class=\"line\"><span class=\"number\">70</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">71</span>:     &#125;</div><div class=\"line\"><span class=\"number\">72</span>: </div><div class=\"line\"><span class=\"number\">73</span>:     <span class=\"keyword\">if</span> (commitLeastPages &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">74</span>:         <span class=\"keyword\">return</span> ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) &gt;= commitLeastPages;</div><div class=\"line\"><span class=\"number\">75</span>:     &#125;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"keyword\">return</span> write &gt; flush;</div><div class=\"line\"><span class=\"number\">78</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>FlushRealTimeService</h3>\n<p>æ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FlushRealTimeService</span> <span class=\"keyword\">extends</span> <span class=\"title\">FlushCommitLogService</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 3:      * æœ€åflushæ—¶é—´æˆ³</div><div class=\"line\"> 4:      */</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> lastFlushTimestamp = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 7:      * printè®¡æ—¶å™¨ã€‚</div><div class=\"line\"> 8:      * æ»¡è¶³printæ¬¡æ•°æ—¶ï¼Œè°ƒç”¨&#123;<span class=\"doctag\">@link</span> #printFlushProgress()&#125;</div><div class=\"line\"> 9:      */</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> printTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">13</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">boolean</span> flushCommitLogTimed = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().isFlushCommitLogTimed();</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">int</span> interval = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushIntervalCommitLog();</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">int</span> flushPhysicQueueLeastPages = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogLeastPages();</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">int</span> flushPhysicQueueThoroughInterval = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogThoroughInterval();</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"comment\">// Print flush progress</span></div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"comment\">// å½“æ—¶é—´æ»¡è¶³flushPhysicQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushPhysicQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush</span></div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">boolean</span> printFlushProgress = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">long</span> currentTimeMillis = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"keyword\">if</span> (currentTimeMillis &gt;= (<span class=\"keyword\">this</span>.lastFlushTimestamp + flushPhysicQueueThoroughInterval)) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 <span class=\"keyword\">this</span>.lastFlushTimestamp = currentTimeMillis;</div><div class=\"line\"><span class=\"number\">27</span>:                 flushPhysicQueueLeastPages = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">28</span>:                 printFlushProgress = (printTimes++ % <span class=\"number\">10</span>) == <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">29</span>:             &#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"comment\">// ç­‰å¾…æ‰§è¡Œ</span></div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"keyword\">if</span> (flushCommitLogTimed) &#123;</div><div class=\"line\"><span class=\"number\">34</span>:                     Thread.sleep(interval);</div><div class=\"line\"><span class=\"number\">35</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">36</span>:                     <span class=\"keyword\">this</span>.waitForRunning(interval);</div><div class=\"line\"><span class=\"number\">37</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">38</span>: </div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">if</span> (printFlushProgress) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                     <span class=\"keyword\">this</span>.printFlushProgress();</div><div class=\"line\"><span class=\"number\">41</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">42</span>: </div><div class=\"line\"><span class=\"number\">43</span>:                 <span class=\"comment\">// flush commitLog</span></div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"keyword\">long</span> begin = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">45</span>:                 CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.flush(flushPhysicQueueLeastPages);</div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">long</span> storeTimestamp = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.getStoreTimestamp();</div><div class=\"line\"><span class=\"number\">47</span>:                 <span class=\"keyword\">if</span> (storeTimestamp &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">48</span>:                     CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);</div><div class=\"line\"><span class=\"number\">49</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">50</span>:                 <span class=\"keyword\">long</span> past = System.currentTimeMillis() - begin;</div><div class=\"line\"><span class=\"number\">51</span>:                 <span class=\"keyword\">if</span> (past &gt; <span class=\"number\">500</span>) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:                     log.info(<span class=\"string\">\"Flush data to disk costs &#123;&#125; ms\"</span>, past);</div><div class=\"line\"><span class=\"number\">53</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">54</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">55</span>:                 CommitLog.log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">56</span>:                 <span class=\"keyword\">this</span>.printFlushProgress();</div><div class=\"line\"><span class=\"number\">57</span>:             &#125;</div><div class=\"line\"><span class=\"number\">58</span>:         &#125;</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:         <span class=\"comment\">// Normal shutdown, to ensure that all the flush before exit</span></div><div class=\"line\"><span class=\"number\">61</span>:         <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; RETRY_TIMES_OVER &amp;&amp; !result; i++) &#123;</div><div class=\"line\"><span class=\"number\">63</span>:             result = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.flush(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">64</span>:             CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service shutdown, retry \"</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">\" times \"</span> + (result ? <span class=\"string\">\"OK\"</span> : <span class=\"string\">\"Not OK\"</span>));</div><div class=\"line\"><span class=\"number\">65</span>:         &#125;</div><div class=\"line\"><span class=\"number\">66</span>: </div><div class=\"line\"><span class=\"number\">67</span>:         <span class=\"keyword\">this</span>.printFlushProgress();</div><div class=\"line\"><span class=\"number\">68</span>: </div><div class=\"line\"><span class=\"number\">69</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">70</span>:     &#125;</div><div class=\"line\"><span class=\"number\">71</span>: </div><div class=\"line\"><span class=\"number\">72</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">73</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">74</span>:         <span class=\"keyword\">return</span> FlushRealTimeService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">75</span>:     &#125;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">printFlushProgress</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">78</span>:         <span class=\"comment\">// CommitLog.log.info(\"how much disk fall behind memory, \"</span></div><div class=\"line\"><span class=\"number\">79</span>:         <span class=\"comment\">// + CommitLog.this.mappedFileQueue.howMuchFallBehind());</span></div><div class=\"line\"><span class=\"number\">80</span>:     &#125;</div><div class=\"line\"><span class=\"number\">81</span>: </div><div class=\"line\"><span class=\"number\">82</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">83</span>:     <span class=\"meta\">@SuppressWarnings</span>(<span class=\"string\">\"SpellCheckingInspection\"</span>)</div><div class=\"line\"><span class=\"number\">84</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getJointime</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">85</span>:         <span class=\"keyword\">return</span> <span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">5</span>;</div><div class=\"line\"><span class=\"number\">86</span>:     &#125;</div><div class=\"line\"><span class=\"number\">87</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šå®æ—¶ <code>flush</code>çº¿ç¨‹æœåŠ¡ï¼Œè°ƒç”¨ <code>MappedFile#flush</code> ç›¸å…³é€»è¾‘ã€‚</li>\n<li>ç¬¬ 23 è‡³ 29 è¡Œ ï¼šæ¯ <code>flushPhysicQueueThoroughInterval</code> å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ <code>flush</code> ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ <code>flushCommitLogLeastPages</code> å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ <code>flush</code> ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ <code>flush</code>ï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚</li>\n<li>ç¬¬ 33 è¡Œ è‡³ 37 è¡Œ ï¼šæ ¹æ® <code>flushCommitLogTimed</code> å‚æ•°ï¼Œå¯ä»¥é€‰æ‹©æ¯æ¬¡å¾ªç¯æ˜¯<strong>å›ºå®šå‘¨æœŸ</strong>è¿˜æ˜¯<strong>ç­‰å¾…å”¤é†’</strong>ã€‚é»˜è®¤é…ç½®æ˜¯åè€…ï¼Œæ‰€ä»¥ï¼Œæ¯æ¬¡æ’å…¥æ¶ˆæ¯å®Œæˆï¼Œä¼šå»è°ƒç”¨ <code>commitLogService.wakeup()</code> ã€‚</li>\n<li>ç¬¬ 45 è¡Œ ï¼šè°ƒç”¨ <code>MappedFile</code> è¿›è¡Œ <code>flush</code>ã€‚</li>\n<li>ç¬¬ 61 è‡³ 65 è¡Œ ï¼š<code>Broker</code> å…³é—­æ—¶ï¼Œå¼ºåˆ¶ <code>flush</code>ï¼Œé¿å…æœ‰æœªåˆ·ç›˜çš„æ•°æ®ã€‚</li>\n</ul>\n<h3>CommitRealTimeService</h3>\n<p>æ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚\nå’Œ <code>FlushRealTimeService</code> ç±»ä¼¼ï¼Œæ€§èƒ½æ›´å¥½ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CommitRealTimeService</span> <span class=\"keyword\">extends</span> <span class=\"title\">FlushCommitLogService</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * æœ€å commit æ—¶é—´æˆ³</div><div class=\"line\"> 5:      */</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> lastCommitTimestamp = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">return</span> CommitRealTimeService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">11</span>:     &#125;</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">15</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">int</span> interval = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getCommitIntervalCommitLog();</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">int</span> commitDataLeastPages = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogLeastPages();</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">int</span> commitDataThoroughInterval = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogThoroughInterval();</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"comment\">// å½“æ—¶é—´æ»¡è¶³commitDataThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³commitDataLeastPagesï¼Œä¹Ÿè¿›è¡Œflush</span></div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">long</span> begin = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">if</span> (begin &gt;= (<span class=\"keyword\">this</span>.lastCommitTimestamp + commitDataThoroughInterval)) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 <span class=\"keyword\">this</span>.lastCommitTimestamp = begin;</div><div class=\"line\"><span class=\"number\">25</span>:                 commitDataLeastPages = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">26</span>:             &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">29</span>:                 <span class=\"comment\">// commit</span></div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">boolean</span> result = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.commit(commitDataLeastPages);</div><div class=\"line\"><span class=\"number\">31</span>:                 <span class=\"keyword\">long</span> end = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"keyword\">if</span> (!result) &#123; <span class=\"comment\">// TODO ç–‘é—®ï¼šæœªå†™å…¥æˆåŠŸï¼Œä¸ºå•¥è¦å”¤é†’flushCommitLogService</span></div><div class=\"line\"><span class=\"number\">33</span>:                     <span class=\"keyword\">this</span>.lastCommitTimestamp = end; <span class=\"comment\">// result = false means some data committed.</span></div><div class=\"line\"><span class=\"number\">34</span>:                     <span class=\"comment\">//now wake up flush thread.</span></div><div class=\"line\"><span class=\"number\">35</span>:                     flushCommitLogService.wakeup();</div><div class=\"line\"><span class=\"number\">36</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">37</span>: </div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"keyword\">if</span> (end - begin &gt; <span class=\"number\">500</span>) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:                     log.info(<span class=\"string\">\"Commit data to file costs &#123;&#125; ms\"</span>, end - begin);</div><div class=\"line\"><span class=\"number\">40</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:                 <span class=\"comment\">// ç­‰å¾…æ‰§è¡Œ</span></div><div class=\"line\"><span class=\"number\">43</span>:                 <span class=\"keyword\">this</span>.waitForRunning(interval);</div><div class=\"line\"><span class=\"number\">44</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">45</span>:                 CommitLog.log.error(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">46</span>:             &#125;</div><div class=\"line\"><span class=\"number\">47</span>:         &#125;</div><div class=\"line\"><span class=\"number\">48</span>: </div><div class=\"line\"><span class=\"number\">49</span>:         <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">50</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; RETRY_TIMES_OVER &amp;&amp; !result; i++) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:             result = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.commit(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">52</span>:             CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service shutdown, retry \"</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">\" times \"</span> + (result ? <span class=\"string\">\"OK\"</span> : <span class=\"string\">\"Not OK\"</span>));</div><div class=\"line\"><span class=\"number\">53</span>:         &#125;</div><div class=\"line\"><span class=\"number\">54</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">55</span>:     &#125;</div><div class=\"line\"><span class=\"number\">56</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>GroupCommitService</h3>\n<p>æ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼ŒåŒæ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GroupCommitService</span> <span class=\"keyword\">extends</span> <span class=\"title\">FlushCommitLogService</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  3:      * å†™å…¥è¯·æ±‚é˜Ÿåˆ—</div><div class=\"line\">  4:      */</div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> List&lt;GroupCommitRequest&gt; requestsWrite = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  7:      * è¯»å–è¯·æ±‚é˜Ÿåˆ—</div><div class=\"line\">  8:      */</div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> List&lt;GroupCommitRequest&gt; requestsRead = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">10</span>: </div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 12:      * æ·»åŠ å†™å…¥è¯·æ±‚</div><div class=\"line\"> 13:      *</div><div class=\"line\"> 14:      * <span class=\"doctag\">@param</span> request å†™å…¥è¯·æ±‚</div><div class=\"line\"> 15:      */</div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">putRequest</span><span class=\"params\">(<span class=\"keyword\">final</span> GroupCommitRequest request)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"comment\">// æ·»åŠ å†™å…¥è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>.requestsWrite) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"keyword\">this</span>.requestsWrite.add(request);</div><div class=\"line\"> <span class=\"number\">20</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"comment\">// åˆ‡æ¢è¯»å†™é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">22</span>:         <span class=\"keyword\">if</span> (hasNotified.compareAndSet(<span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>)) &#123;</div><div class=\"line\"> <span class=\"number\">23</span>:             waitPoint.countDown(); <span class=\"comment\">// notify</span></div><div class=\"line\"> <span class=\"number\">24</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">25</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 28:      * åˆ‡æ¢è¯»å†™é˜Ÿåˆ—</div><div class=\"line\"> 29:      */</div><div class=\"line\"> <span class=\"number\">30</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">swapRequests</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">31</span>:         List&lt;GroupCommitRequest&gt; tmp = <span class=\"keyword\">this</span>.requestsWrite;</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"keyword\">this</span>.requestsWrite = <span class=\"keyword\">this</span>.requestsRead;</div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"keyword\">this</span>.requestsRead = tmp;</div><div class=\"line\"> <span class=\"number\">34</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">35</span>: </div><div class=\"line\"> <span class=\"number\">36</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doCommit</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">37</span>:         <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:             <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.requestsRead.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">39</span>:                 <span class=\"keyword\">for</span> (GroupCommitRequest req : <span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\"> <span class=\"number\">40</span>:                     <span class=\"comment\">// There may be a message in the next file, so a maximum of</span></div><div class=\"line\"> <span class=\"number\">41</span>:                     <span class=\"comment\">// two times the flush (å¯èƒ½æ‰¹é‡æäº¤çš„messagesï¼Œåˆ†å¸ƒåœ¨ä¸¤ä¸ªMappedFile)</span></div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"keyword\">boolean</span> flushOK = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">43</span>:                     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">2</span> &amp;&amp; !flushOK; i++) &#123;</div><div class=\"line\"> <span class=\"number\">44</span>:                         <span class=\"comment\">// æ˜¯å¦æ»¡è¶³éœ€è¦flushæ¡ä»¶ï¼Œå³è¯·æ±‚çš„offsetè¶…è¿‡flushçš„offset</span></div><div class=\"line\"> <span class=\"number\">45</span>:                         flushOK = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.getFlushedWhere() &gt;= req.getNextOffset();</div><div class=\"line\"> <span class=\"number\">46</span>:                         <span class=\"keyword\">if</span> (!flushOK) &#123;</div><div class=\"line\"> <span class=\"number\">47</span>:                             CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.flush(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">48</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">49</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">50</span>:                     <span class=\"comment\">// å”¤é†’ç­‰å¾…è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">51</span>:                     req.wakeupCustomer(flushOK);</div><div class=\"line\"> <span class=\"number\">52</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">53</span>: </div><div class=\"line\"> <span class=\"number\">54</span>:                 <span class=\"keyword\">long</span> storeTimestamp = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.getStoreTimestamp();</div><div class=\"line\"> <span class=\"number\">55</span>:                 <span class=\"keyword\">if</span> (storeTimestamp &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:                     CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);</div><div class=\"line\"> <span class=\"number\">57</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">58</span>: </div><div class=\"line\"> <span class=\"number\">59</span>:                 <span class=\"comment\">// æ¸…ç†è¯»å–é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">60</span>:                 <span class=\"keyword\">this</span>.requestsRead.clear();</div><div class=\"line\"> <span class=\"number\">61</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">62</span>:                 <span class=\"comment\">// Because of individual messages is set to not sync flush, it</span></div><div class=\"line\"> <span class=\"number\">63</span>:                 <span class=\"comment\">// will come to this process ä¸åˆæ³•çš„è¯·æ±‚ï¼Œæ¯”å¦‚messageä¸Šæœªè®¾ç½®isWaitStoreMsgOKã€‚</span></div><div class=\"line\"> <span class=\"number\">64</span>:                 <span class=\"comment\">// èµ°åˆ°æ­¤å¤„çš„é€»è¾‘ï¼Œç›¸å½“äºå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè½ç›˜ä¸€æ¡æ¶ˆæ¯ï¼Œå®é™…æ— æ‰¹é‡æäº¤çš„æ•ˆæœã€‚</span></div><div class=\"line\"> <span class=\"number\">65</span>:                 CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.flush(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">66</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">67</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">68</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">69</span>: </div><div class=\"line\"> <span class=\"number\">70</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">71</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"> <span class=\"number\">72</span>: </div><div class=\"line\"> <span class=\"number\">73</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">75</span>:                 <span class=\"keyword\">this</span>.waitForRunning(<span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">76</span>:                 <span class=\"keyword\">this</span>.doCommit();</div><div class=\"line\"> <span class=\"number\">77</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">78</span>:                 CommitLog.log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"> <span class=\"number\">79</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">80</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">81</span>: </div><div class=\"line\"> <span class=\"number\">82</span>:         <span class=\"comment\">// Under normal circumstances shutdown, wait for the arrival of the</span></div><div class=\"line\"> <span class=\"number\">83</span>:         <span class=\"comment\">// request, and then flush</span></div><div class=\"line\"> <span class=\"number\">84</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">85</span>:             Thread.sleep(<span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">86</span>:         &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:             CommitLog.log.warn(<span class=\"string\">\"GroupCommitService Exception, \"</span>, e);</div><div class=\"line\"> <span class=\"number\">88</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">89</span>: </div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</div><div class=\"line\"> <span class=\"number\">91</span>:             <span class=\"keyword\">this</span>.swapRequests();</div><div class=\"line\"> <span class=\"number\">92</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">93</span>: </div><div class=\"line\"> <span class=\"number\">94</span>:         <span class=\"keyword\">this</span>.doCommit();</div><div class=\"line\"> <span class=\"number\">95</span>: </div><div class=\"line\"> <span class=\"number\">96</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"> <span class=\"number\">97</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">98</span>: </div><div class=\"line\"> <span class=\"number\">99</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">100:      * æ¯æ¬¡æ‰§è¡Œå®Œï¼Œåˆ‡æ¢è¯»å†™é˜Ÿåˆ—</div><div class=\"line\">101:      */</div><div class=\"line\"><span class=\"number\">102</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">103</span>:     <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onWaitEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">104</span>:         <span class=\"keyword\">this</span>.swapRequests();</div><div class=\"line\"><span class=\"number\">105</span>:     &#125;</div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">108</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">109</span>:         <span class=\"keyword\">return</span> GroupCommitService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">110</span>:     &#125;</div><div class=\"line\"><span class=\"number\">111</span>: </div><div class=\"line\"><span class=\"number\">112</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">113</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getJointime</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">114</span>:         <span class=\"keyword\">return</span> <span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">5</span>;</div><div class=\"line\"><span class=\"number\">115</span>:     &#125;</div><div class=\"line\"><span class=\"number\">116</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šæ‰¹é‡å†™å…¥çº¿ç¨‹æœåŠ¡ã€‚</li>\n<li>ç¬¬ 16 è‡³ 25 è¡Œ ï¼šæ·»åŠ å†™å…¥è¯·æ±‚ã€‚æ–¹æ³•è®¾ç½®äº† <code>sync</code> çš„åŸå› ï¼š<code>this.requestsWrite</code> ä¼šå’Œ <code>this.requestsRead</code> ä¸æ–­äº¤æ¢ï¼Œæ— æ³•ä¿è¯ç¨³å®šçš„åŒæ­¥ã€‚</li>\n<li>ç¬¬ 27 è‡³ 34 è¡Œ ï¼šè¯»å†™é˜Ÿåˆ—äº¤æ¢ã€‚</li>\n<li>ç¬¬ 38 è‡³ 60 è¡Œ ï¼šå¾ªç¯å†™å…¥é˜Ÿåˆ—ï¼Œè¿›è¡Œ <code>flush</code>ã€‚\n<ul>\n<li>ç¬¬ 43 è¡Œ ï¼šè€ƒè™‘åˆ°æœ‰å¯èƒ½æ¯æ¬¡å¾ªç¯çš„æ¶ˆæ¯å†™å…¥çš„æ¶ˆæ¯ï¼Œå¯èƒ½åˆ†å¸ƒåœ¨<strong>ä¸¤ä¸ª</strong> <code>MappedFile</code>(å†™ç¬¬Nä¸ªæ¶ˆæ¯æ—¶ï¼Œ<code>MappedFile</code> å·²æ»¡ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„)ï¼Œæ‰€ä»¥éœ€è¦æœ‰å¾ªç¯2æ¬¡ã€‚</li>\n<li>ç¬¬ 51 è¡Œ ï¼šå”¤é†’ç­‰å¾…å†™å…¥è¯·æ±‚çº¿ç¨‹ï¼Œé€šè¿‡ <code>CountDownLatch</code> å®ç°ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 61 è‡³ 66 è¡Œ ï¼šç›´æ¥åˆ·ç›˜ã€‚æ­¤å¤„æ˜¯ç”±äºå‘é€çš„æ¶ˆæ¯çš„ <code>isWaitStoreMsgOK</code> æœªè®¾ç½®æˆ <code>TRUE</code> ï¼Œå¯¼è‡´æœªèµ°æ‰¹é‡æäº¤ã€‚</li>\n<li>ç¬¬ 73 è‡³ 80 è¡Œ ï¼šæ¯ 10ms æ‰§è¡Œä¸€æ¬¡æ‰¹é‡æäº¤ã€‚å½“ç„¶ï¼Œå¦‚æœ <code>wakeup()</code> æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡æ‰¹é‡æäº¤ã€‚å½“ <code>Broker</code> è®¾ç½®æˆåŒæ­¥è½ç›˜ &amp;&amp; æ¶ˆæ¯ <code>isWaitStoreMsgOK=true</code>ï¼Œæ¶ˆæ¯éœ€è¦ç•¥å¤§äº 10ms æ‰èƒ½å‘é€æˆåŠŸã€‚å½“ç„¶ï¼Œæ€§èƒ½ç›¸å¯¹å¼‚æ­¥è½ç›˜è¾ƒå·®ï¼Œå¯é æ€§æ›´é«˜ï¼Œéœ€è¦æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨æ—¶å»å–èˆã€‚</li>\n</ul>\n<h1>ç»“å°¾</h1>\n<p>å†™çš„ç¬¬äºŒç¯‡ä¸RocketMQæºç ç›¸å…³çš„åšæ–‡ï¼Œçœ‹åˆ°æœ‰é˜…è¯»ã€ç‚¹èµã€æ”¶è—ç”šè‡³è®¢é˜…ï¼Œå¾ˆå—é¼“èˆã€‚</p>\n<p>ã€ŠMessageå­˜å‚¨ã€‹æ¯”èµ·ã€ŠMessageå‘é€&amp;æ¥æ”¶ã€‹ä»éš¾åº¦ä¸Šè¯´æ˜¯æ›´å¤§çš„ï¼Œå½“ç„¶ä¹Ÿæ˜¯æ›´æœ‰è¶£çš„ï¼Œå¦‚æœå­˜åœ¨ç†è§£é”™è¯¯æˆ–è€…è¡¨è¾¾ä¸æ¸…æ™°ï¼Œè¿˜è¯·å¤§å®¶å¤šå¤šåŒ…å«ã€‚å¦‚æœå¯ä»¥çš„è¯ï¼Œè¿˜è¯·éº»çƒ¦æ·»åŠ  QQï¼š7685413 è¿›è¡ŒæŒ‡å‡ºï¼Œé¿å…è‡ªå·±çš„ç†è§£é”™è¯¯ï¼Œç»™å¤§å®¶é€ æˆå›°æ‰°ã€‚</p>\n<p>æ¨è<a href=\"http://www.jasongj.com/kafka/high_throughput/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\" target=\"_blank\" rel=\"external\">ã€ŠKafkaè®¾è®¡è§£æï¼ˆå…­ï¼‰- Kafkaé«˜æ€§èƒ½æ¶æ„ä¹‹é“ã€‹</a>ï¼Œä½œè€…ç«™åœ¨çš„é«˜åº¦æ¯”æˆ‘é«˜çš„å¤šçš„å¤šï¼Œå—¯ï¼ŒæŒ‰ç…§æå°ç’çš„è¯´æ³•ï¼šé«˜ä¸€ä¸ªå–œé©¬æ‹‰é›…å±±ã€‚ğŸ˜ˆè®¤çœŸå•ƒè¯»ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°(åŸä¹¦ç¬¬3ç‰ˆ)ã€‹ï¼Œday day upã€‚</p>\n<p>å†æ¬¡æ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ã€ç‚¹èµã€æ”¶è—ã€‚</p>\n<p>ä¸‹ä¸€ç¯‡ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ã€‹</a> èµ·èˆªï¼</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>åŸæ–‡åœ°å€ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-store/\">http://www.yunai.me/RocketMQ/message-store/</a><br>\n<code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/incubator-rocketmq</a><br>\n**ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **</p>\n</blockquote>\n<p><img src=\"http://www.yunai.me/images/common/wechat_mp.jpeg\" alt=\"wechat_mp\"></p>\n<hr>\n<ul>\n<li><a href=\"#\">1ã€æ¦‚è¿°</a></li>\n<li><a href=\"#\">2ã€CommitLog ç»“æ„</a></li>\n<li><a href=\"#\">3ã€CommitLog å­˜å‚¨æ¶ˆæ¯</a>\n<ul>\n<li><a href=\"#\">CommitLog#putMessage(...)</a></li>\n<li><a href=\"#\">MappedFileQueue#getLastMappedFile(...)</a></li>\n<li><a href=\"#\">MappedFile#appendMessage(...)</a></li>\n<li><a href=\"#\">DefaultAppendMessageCallback#doAppend(...)</a></li>\n<li><a href=\"#\">FlushCommitLogService</a>\n<ul>\n<li><a href=\"#\">MappedFile#è½ç›˜</a></li>\n<li><a href=\"#\">FlushRealTimeService</a></li>\n<li><a href=\"#\">CommitRealTimeService</a></li>\n<li><a href=\"#\">GroupCommitService</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">ç»“å°¾</a></li>\n</ul>\n<h1>1ã€æ¦‚è¿°</h1>\n<p>æœ¬æ–‡æ¥<a href=\"http://www.yunai.me/RocketMQ/message-send-and-receive/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message å‘é€ä¸æ¥æ”¶ã€‹</a>ã€‚\nä¸»è¦è§£æ <code>CommitLog</code> å­˜å‚¨æ¶ˆæ¯éƒ¨åˆ†ã€‚</p>\n<h1>2ã€CommitLog ç»“æ„</h1>\n<p><code>CommitLog</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å…³ç³»å¦‚ä¸‹ï¼š</p>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_23/02.png\" alt=\"CommitLogã€MappedFileQueueã€MappedFileçš„å…³ç³»\">\n<code>CommitLog</code> : <code>MappedFileQueue</code> : <code>MappedFile</code> = 1 : 1 : Nã€‚</p>\n</blockquote>\n<p>ååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š</p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><div class=\"line\">Yunai-MacdeMacBook-Pro-2:commitlog yunai$ <span class=\"built_in\">pwd</span></div><div class=\"line\">/Users/yunai/store/commitlog</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:commitlog yunai$ ls -l</div><div class=\"line\">total 10485760</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:27 00000000000000000000</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:29 00000000001073741824</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:32 00000000002147483648</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:33 00000000003221225472</div><div class=\"line\">-rw-r--r--  1 yunai  staff  1073741824  4 21 16:32 00000000004294967296</div></pre></td></tr></table></figure></p>\n<hr>\n<p><code>CommitLog</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>\n<ul>\n<li><code>MappedFile</code> ï¼š00000000000000000000ã€00000000001073741824ã€00000000002147483648ç­‰æ–‡ä»¶ã€‚</li>\n<li><code>MappedFileQueue</code> ï¼š<code>MappedFile</code> æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ <code>MappedFile</code> è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚\n<ul>\n<li>æ¯ä¸ª <code>MappedFile</code> ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚</li>\n<li>æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ <code>CommitLog</code> é‡Œé»˜è®¤ä¸º 1GBã€‚</li>\n</ul>\n</li>\n<li><code>CommitLog</code> ï¼šé’ˆå¯¹ <code>MappedFileQueue</code> çš„å°è£…ä½¿ç”¨ã€‚</li>\n</ul>\n<p><code>CommitLog</code> ç›®å‰å­˜å‚¨åœ¨ <code>MappedFile</code> æœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š</p>\n<ol>\n<li>MESSAGE ï¼šæ¶ˆæ¯ã€‚</li>\n<li>BLANK ï¼šæ–‡ä»¶ä¸è¶³ä»¥å­˜å‚¨æ¶ˆæ¯æ—¶çš„ç©ºç™½å ä½ã€‚</li>\n</ol>\n<p><code>CommitLog</code> å­˜å‚¨åœ¨ <code>MappedFile</code>çš„ç»“æ„ï¼š</p>\n<blockquote>\n<table>\n<thead>\n<tr>\n<th>MESSAGE[1]</th>\n<th>MESSAGE[2]</th>\n<th>...</th>\n<th>MESSAGE[n - 1]</th>\n<th>MESSAGE[n]</th>\n<th>BLANK</th>\n</tr>\n</thead>\n<tbody></tbody>\n</table>\n</blockquote>\n<p><code>MESSAGE</code> åœ¨ <code>CommitLog</code> å­˜å‚¨ç»“æ„ï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">MsgLen</td>\n<td style=\"text-align:left\">æ¶ˆæ¯æ€»é•¿åº¦</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">MagicCode</td>\n<td style=\"text-align:left\">MESSAGE_MAGIC_CODE</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">BodyCRC</td>\n<td style=\"text-align:left\">æ¶ˆæ¯å†…å®¹CRC</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">QueueId</td>\n<td style=\"text-align:left\">æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">5</td>\n<td style=\"text-align:left\">Flag</td>\n<td style=\"text-align:left\">flag</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">6</td>\n<td style=\"text-align:left\">QueueOffset</td>\n<td style=\"text-align:left\">æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">7</td>\n<td style=\"text-align:left\">PhysicalOffset</td>\n<td style=\"text-align:left\">ç‰©ç†ä½ç½®ã€‚åœ¨ <code>CommitLog</code> çš„é¡ºåºå­˜å‚¨ä½ç½®ã€‚</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">8</td>\n<td style=\"text-align:left\">SysFlag</td>\n<td style=\"text-align:left\">MessageSysFlag</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">9</td>\n<td style=\"text-align:left\">BornTimestamp</td>\n<td style=\"text-align:left\">ç”Ÿæˆæ¶ˆæ¯æ—¶é—´æˆ³</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">10</td>\n<td style=\"text-align:left\">BornHost</td>\n<td style=\"text-align:left\">ç”Ÿæ•ˆæ¶ˆæ¯çš„åœ°å€+ç«¯å£</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">11</td>\n<td style=\"text-align:left\">StoreTimestamp</td>\n<td style=\"text-align:left\">å­˜å‚¨æ¶ˆæ¯æ—¶é—´æˆ³</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">12</td>\n<td style=\"text-align:left\">StoreHost</td>\n<td style=\"text-align:left\">å­˜å‚¨æ¶ˆæ¯çš„åœ°å€+ç«¯å£</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">13</td>\n<td style=\"text-align:left\">ReconsumeTimes</td>\n<td style=\"text-align:left\">é‡æ–°æ¶ˆè´¹æ¶ˆæ¯æ¬¡æ•°</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">14</td>\n<td style=\"text-align:left\">PreparedTransationOffset</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">15</td>\n<td style=\"text-align:left\">BodyLength + Body</td>\n<td style=\"text-align:left\">å†…å®¹é•¿åº¦ + å†…å®¹</td>\n<td style=\"text-align:left\">Int + Bytes</td>\n<td style=\"text-align:left\">4 + bodyLength</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">16</td>\n<td style=\"text-align:left\">TopicLength + Topic</td>\n<td style=\"text-align:left\">Topicé•¿åº¦ + Topic</td>\n<td style=\"text-align:left\">Byte + Bytes</td>\n<td style=\"text-align:left\">1 + topicLength</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">17</td>\n<td style=\"text-align:left\">PropertiesLength + Properties</td>\n<td style=\"text-align:left\">æ‹“å±•å­—æ®µé•¿åº¦ + æ‹“å±•å­—æ®µ</td>\n<td style=\"text-align:left\">Short + Bytes</td>\n<td style=\"text-align:left\">2 + PropertiesLength</td>\n</tr>\n</tbody>\n</table>\n<p><code>BLANK</code> åœ¨ <code>CommitLog</code> å­˜å‚¨ç»“æ„ï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">maxBlank</td>\n<td style=\"text-align:left\">ç©ºç™½é•¿åº¦</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">MagicCode</td>\n<td style=\"text-align:left\">BLANK_MAGIC_CODE</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n</tbody>\n</table>\n<h1>3ã€CommitLog å­˜å‚¨æ¶ˆæ¯</h1>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_23/01.png\" alt=\"Brokerå­˜å‚¨å‘é€æ¶ˆæ¯é¡ºåºå›¾\"></p>\n</blockquote>\n<h2>CommitLog#putMessage(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> PutMessageResult <span class=\"title\">putMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"comment\">// Set the storage time</span></div><div class=\"line\">  <span class=\"number\">3</span>:     msg.setStoreTimestamp(System.currentTimeMillis());</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"comment\">// Set the message body BODY CRC (consider the most appropriate setting</span></div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"comment\">// on the client)</span></div><div class=\"line\">  <span class=\"number\">6</span>:     msg.setBodyCRC(UtilAll.crc32(msg.getBody()));</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"comment\">// Back to Results</span></div><div class=\"line\">  <span class=\"number\">8</span>:     AppendMessageResult result = <span class=\"keyword\">null</span>;</div><div class=\"line\">  <span class=\"number\">9</span>: </div><div class=\"line\"> <span class=\"number\">10</span>:     StoreStatsService storeStatsService = <span class=\"keyword\">this</span>.defaultMessageStore.getStoreStatsService();</div><div class=\"line\"> <span class=\"number\">11</span>: </div><div class=\"line\"> <span class=\"number\">12</span>:     String topic = msg.getTopic();</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">int</span> queueId = msg.getQueueId();</div><div class=\"line\"> <span class=\"number\">14</span>: </div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"comment\">// äº‹åŠ¡ç›¸å…³ TODO å¾…è¯»ï¼šäº‹åŠ¡ç›¸å…³</span></div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"keyword\">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">18</span>:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"comment\">// Delay Delivery</span></div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"keyword\">if</span> (msg.getDelayTimeLevel() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"keyword\">if</span> (msg.getDelayTimeLevel() &gt; <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:                 msg.setDelayTimeLevel(<span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</div><div class=\"line\"> <span class=\"number\">23</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:             topic = ScheduleMessageService.SCHEDULE_TOPIC;</div><div class=\"line\"> <span class=\"number\">26</span>:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</div><div class=\"line\"> <span class=\"number\">27</span>: </div><div class=\"line\"> <span class=\"number\">28</span>:             <span class=\"comment\">// Backup real topic, queueId</span></div><div class=\"line\"> <span class=\"number\">29</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</div><div class=\"line\"> <span class=\"number\">30</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</div><div class=\"line\"> <span class=\"number\">31</span>:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</div><div class=\"line\"> <span class=\"number\">32</span>: </div><div class=\"line\"> <span class=\"number\">33</span>:             msg.setTopic(topic);</div><div class=\"line\"> <span class=\"number\">34</span>:             msg.setQueueId(queueId);</div><div class=\"line\"> <span class=\"number\">35</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">36</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">37</span>: </div><div class=\"line\"> <span class=\"number\">38</span>:     <span class=\"keyword\">long</span> eclipseTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">39</span>: </div><div class=\"line\"> <span class=\"number\">40</span>:     <span class=\"comment\">// è·å–å†™å…¥æ˜ å°„æ–‡ä»¶</span></div><div class=\"line\"> <span class=\"number\">41</span>:     MappedFile unlockMappedFile = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">42</span>:     MappedFile mappedFile = <span class=\"keyword\">this</span>.mappedFileQueue.getLastMappedFile();</div><div class=\"line\"> <span class=\"number\">43</span>: </div><div class=\"line\"> <span class=\"number\">44</span>:     <span class=\"comment\">// è·å–å†™å…¥é”</span></div><div class=\"line\"> <span class=\"number\">45</span>:     lockForPutMessage(); <span class=\"comment\">//spin...</span></div><div class=\"line\"> <span class=\"number\">46</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"keyword\">long</span> beginLockTimestamp = <span class=\"keyword\">this</span>.defaultMessageStore.getSystemClock().now();</div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"keyword\">this</span>.beginTimeInLock = beginLockTimestamp;</div><div class=\"line\"> <span class=\"number\">49</span>: </div><div class=\"line\"> <span class=\"number\">50</span>:         <span class=\"comment\">// Here settings are stored timestamp, in order to ensure an orderly</span></div><div class=\"line\"> <span class=\"number\">51</span>:         <span class=\"comment\">// global</span></div><div class=\"line\"> <span class=\"number\">52</span>:         msg.setStoreTimestamp(beginLockTimestamp);</div><div class=\"line\"> <span class=\"number\">53</span>: </div><div class=\"line\"> <span class=\"number\">54</span>:         <span class=\"comment\">// å½“ä¸å­˜åœ¨æ˜ å°„æ–‡ä»¶æ—¶ï¼Œè¿›è¡Œåˆ›å»º</span></div><div class=\"line\"> <span class=\"number\">55</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mappedFile || mappedFile.isFull()) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:             mappedFile = <span class=\"keyword\">this</span>.mappedFileQueue.getLastMappedFile(<span class=\"number\">0</span>); <span class=\"comment\">// Mark: NewFile may be cause noise</span></div><div class=\"line\"> <span class=\"number\">57</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">58</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mappedFile) &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:             log.error(<span class=\"string\">\"create maped file1 error, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" clientAddr: \"</span> + msg.getBornHostString());</div><div class=\"line\"> <span class=\"number\">60</span>:             beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">61</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, <span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">62</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">63</span>: </div><div class=\"line\"> <span class=\"number\">64</span>:         <span class=\"comment\">// å­˜å‚¨æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">65</span>:         result = mappedFile.appendMessage(msg, <span class=\"keyword\">this</span>.appendMessageCallback);</div><div class=\"line\"> <span class=\"number\">66</span>:         <span class=\"keyword\">switch</span> (result.getStatus()) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:             <span class=\"keyword\">case</span> PUT_OK:</div><div class=\"line\"> <span class=\"number\">68</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:             <span class=\"keyword\">case</span> END_OF_FILE: <span class=\"comment\">// å½“æ–‡ä»¶å°¾æ—¶ï¼Œè·å–æ–°çš„æ˜ å°„æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œæ’å…¥</span></div><div class=\"line\"> <span class=\"number\">70</span>:                 unlockMappedFile = mappedFile;</div><div class=\"line\"> <span class=\"number\">71</span>:                 <span class=\"comment\">// Create a new file, re-write the message</span></div><div class=\"line\"> <span class=\"number\">72</span>:                 mappedFile = <span class=\"keyword\">this</span>.mappedFileQueue.getLastMappedFile(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">73</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mappedFile) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:                     <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">75</span>:                     log.error(<span class=\"string\">\"create maped file2 error, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" clientAddr: \"</span> + msg.getBornHostString());</div><div class=\"line\"> <span class=\"number\">76</span>:                     beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">77</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);</div><div class=\"line\"> <span class=\"number\">78</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">79</span>:                 result = mappedFile.appendMessage(msg, <span class=\"keyword\">this</span>.appendMessageCallback);</div><div class=\"line\"> <span class=\"number\">80</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">81</span>:             <span class=\"keyword\">case</span> MESSAGE_SIZE_EXCEEDED:</div><div class=\"line\"> <span class=\"number\">82</span>:             <span class=\"keyword\">case</span> PROPERTIES_SIZE_EXCEEDED:</div><div class=\"line\"> <span class=\"number\">83</span>:                 beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">84</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);</div><div class=\"line\"> <span class=\"number\">85</span>:             <span class=\"keyword\">case</span> UNKNOWN_ERROR:</div><div class=\"line\"> <span class=\"number\">86</span>:                 beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">87</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</div><div class=\"line\"> <span class=\"number\">88</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">89</span>:                 beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">90</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</div><div class=\"line\"> <span class=\"number\">91</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:         eclipseTimeInLock = <span class=\"keyword\">this</span>.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;</div><div class=\"line\"> <span class=\"number\">94</span>:         beginTimeInLock = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">95</span>:     &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:         <span class=\"comment\">// é‡Šæ”¾å†™å…¥é”</span></div><div class=\"line\"> <span class=\"number\">97</span>:         releasePutMessageLock();</div><div class=\"line\"> <span class=\"number\">98</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">99</span>: </div><div class=\"line\"><span class=\"number\">100</span>:     <span class=\"keyword\">if</span> (eclipseTimeInLock &gt; <span class=\"number\">500</span>) &#123;</div><div class=\"line\"><span class=\"number\">101</span>:         log.warn(<span class=\"string\">\"[NOTIFYME]putMessage in lock cost time(ms)=&#123;&#125;, bodyLength=&#123;&#125; AppendMessageResult=&#123;&#125;\"</span>, eclipseTimeInLock, msg.getBody().length, result);</div><div class=\"line\"><span class=\"number\">102</span>:     &#125;</div><div class=\"line\"><span class=\"number\">103</span>: </div><div class=\"line\"><span class=\"number\">104</span>:     <span class=\"comment\">// </span></div><div class=\"line\"><span class=\"number\">105</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != unlockMappedFile &amp;&amp; <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) &#123;</div><div class=\"line\"><span class=\"number\">106</span>:         <span class=\"keyword\">this</span>.defaultMessageStore.unlockMappedFile(unlockMappedFile);</div><div class=\"line\"><span class=\"number\">107</span>:     &#125;</div><div class=\"line\"><span class=\"number\">108</span>: </div><div class=\"line\"><span class=\"number\">109</span>:     PutMessageResult putMessageResult = <span class=\"keyword\">new</span> PutMessageResult(PutMessageStatus.PUT_OK, result);</div><div class=\"line\"><span class=\"number\">110</span>: </div><div class=\"line\"><span class=\"number\">111</span>:     <span class=\"comment\">// Statistics</span></div><div class=\"line\"><span class=\"number\">112</span>:     storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).incrementAndGet();</div><div class=\"line\"><span class=\"number\">113</span>:     storeStatsService.getSinglePutMessageTopicSizeTotal(topic).addAndGet(result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">114</span>: </div><div class=\"line\"><span class=\"number\">115</span>:     <span class=\"comment\">// è¿›è¡ŒåŒæ­¥||å¼‚æ­¥ flush||commit</span></div><div class=\"line\"><span class=\"number\">116</span>:     GroupCommitRequest request = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">117</span>:     <span class=\"comment\">// Synchronization flush</span></div><div class=\"line\"><span class=\"number\">118</span>:     <span class=\"keyword\">if</span> (FlushDiskType.SYNC_FLUSH == <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) &#123;</div><div class=\"line\"><span class=\"number\">119</span>:         <span class=\"keyword\">final</span> GroupCommitService service = (GroupCommitService) <span class=\"keyword\">this</span>.flushCommitLogService;</div><div class=\"line\"><span class=\"number\">120</span>:         <span class=\"keyword\">if</span> (msg.isWaitStoreMsgOK()) &#123;</div><div class=\"line\"><span class=\"number\">121</span>:             request = <span class=\"keyword\">new</span> GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">122</span>:             service.putRequest(request);</div><div class=\"line\"><span class=\"number\">123</span>:             <span class=\"keyword\">boolean</span> flushOK = request.waitForFlush(<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</div><div class=\"line\"><span class=\"number\">124</span>:             <span class=\"keyword\">if</span> (!flushOK) &#123;</div><div class=\"line\"><span class=\"number\">125</span>:                 log.error(<span class=\"string\">\"do groupcommit, wait for flush failed, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" tags: \"</span> + msg.getTags()</div><div class=\"line\"><span class=\"number\">126</span>:                     + <span class=\"string\">\" client address: \"</span> + msg.getBornHostString());</div><div class=\"line\"><span class=\"number\">127</span>:                 putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);</div><div class=\"line\"><span class=\"number\">128</span>:             &#125;</div><div class=\"line\"><span class=\"number\">129</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">130</span>:             service.wakeup();</div><div class=\"line\"><span class=\"number\">131</span>:         &#125;</div><div class=\"line\"><span class=\"number\">132</span>:     &#125;</div><div class=\"line\"><span class=\"number\">133</span>:     <span class=\"comment\">// Asynchronous flush</span></div><div class=\"line\"><span class=\"number\">134</span>:     <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">135</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().isTransientStorePoolEnable()) &#123;</div><div class=\"line\"><span class=\"number\">136</span>:             flushCommitLogService.wakeup(); <span class=\"comment\">// importantï¼šå”¤é†’commitLogçº¿ç¨‹ï¼Œè¿›è¡Œflush</span></div><div class=\"line\"><span class=\"number\">137</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">138</span>:             commitLogService.wakeup();</div><div class=\"line\"><span class=\"number\">139</span>:         &#125;</div><div class=\"line\"><span class=\"number\">140</span>:     &#125;</div><div class=\"line\"><span class=\"number\">141</span>: </div><div class=\"line\"><span class=\"number\">142</span>:     <span class=\"comment\">// Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹ // TODO å¾…è¯»ï¼šæ•°æ®åŒæ­¥</span></div><div class=\"line\"><span class=\"number\">143</span>:     <span class=\"keyword\">if</span> (BrokerRole.SYNC_MASTER == <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class=\"line\"><span class=\"number\">144</span>:         HAService service = <span class=\"keyword\">this</span>.defaultMessageStore.getHaService();</div><div class=\"line\"><span class=\"number\">145</span>:         <span class=\"keyword\">if</span> (msg.isWaitStoreMsgOK()) &#123;</div><div class=\"line\"><span class=\"number\">146</span>:             <span class=\"comment\">// Determine whether to wait</span></div><div class=\"line\"><span class=\"number\">147</span>:             <span class=\"keyword\">if</span> (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) &#123;</div><div class=\"line\"><span class=\"number\">148</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == request) &#123;</div><div class=\"line\"><span class=\"number\">149</span>:                     request = <span class=\"keyword\">new</span> GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">150</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">151</span>:                 service.putRequest(request);</div><div class=\"line\"><span class=\"number\">152</span>: </div><div class=\"line\"><span class=\"number\">153</span>:                 service.getWaitNotifyObject().wakeupAll();</div><div class=\"line\"><span class=\"number\">154</span>: </div><div class=\"line\"><span class=\"number\">155</span>:                 <span class=\"keyword\">boolean</span> flushOK =</div><div class=\"line\"><span class=\"number\">156</span>:                     <span class=\"comment\">// TODO</span></div><div class=\"line\"><span class=\"number\">157</span>:                     request.waitForFlush(<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</div><div class=\"line\"><span class=\"number\">158</span>:                 <span class=\"keyword\">if</span> (!flushOK) &#123;</div><div class=\"line\"><span class=\"number\">159</span>:                     log.error(<span class=\"string\">\"do sync transfer other node, wait return, but failed, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" tags: \"</span></div><div class=\"line\"><span class=\"number\">160</span>:                         + msg.getTags() + <span class=\"string\">\" client address: \"</span> + msg.getBornHostString());</div><div class=\"line\"><span class=\"number\">161</span>:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);</div><div class=\"line\"><span class=\"number\">162</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">163</span>:             &#125;</div><div class=\"line\"><span class=\"number\">164</span>:             <span class=\"comment\">// Slave problem</span></div><div class=\"line\"><span class=\"number\">165</span>:             <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">166</span>:                 <span class=\"comment\">// Tell the producer, slave not available</span></div><div class=\"line\"><span class=\"number\">167</span>:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">168</span>:             &#125;</div><div class=\"line\"><span class=\"number\">169</span>:         &#125;</div><div class=\"line\"><span class=\"number\">170</span>:     &#125;</div><div class=\"line\"><span class=\"number\">171</span>: </div><div class=\"line\"><span class=\"number\">172</span>:     <span class=\"keyword\">return</span> putMessageResult;</div><div class=\"line\"><span class=\"number\">173</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå­˜å‚¨æ¶ˆæ¯ï¼Œå¹¶è¿”å›å­˜å‚¨ç»“æœã€‚</li>\n<li>ç¬¬ 2 è¡Œ ï¼šè®¾ç½®å­˜å‚¨æ—¶é—´ç­‰ã€‚</li>\n<li>ç¬¬ 16 è‡³ 36 è¡Œ ï¼šäº‹åŠ¡æ¶ˆæ¯ç›¸å…³ï¼Œæš‚æœªäº†è§£ã€‚</li>\n<li>ç¬¬ 45 &amp; 97 è¡Œ ï¼šè·å–é”ä¸é‡Šæ”¾é”ã€‚</li>\n<li>ç¬¬ 52 è¡Œ ï¼šå†æ¬¡è®¾ç½®å­˜å‚¨æ—¶é—´ã€‚ç›®å‰ä¼šæœ‰å¤šå¤„åœ°æ–¹è®¾ç½®å­˜å‚¨æ—¶é—´ã€‚</li>\n<li>ç¬¬ 55 è‡³ 62 è¡Œ ï¼šè·å– <code>MappedFile</code>ï¼Œè‹¥ä¸å­˜åœ¨æˆ–å·²æ»¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#mappedfilequeuegetlastmappedfile\">MappedFileQueue#getLastMappedFile(...)</a>ã€‚</li>\n<li>ç¬¬ 65 è¡Œ ï¼š<strong>æ’å…¥æ¶ˆæ¯</strong>åˆ° <code>MappedFile</code>ï¼Œè§£æè§£æè§ï¼š<a href=\"#mappedfileappendmessage\">MappedFile#appendMessage(...)</a>ã€‚</li>\n<li>ç¬¬ 69 è‡³ 80 è¡Œ ï¼š<code>MappedFile</code> å·²æ»¡ï¼Œåˆ›å»ºæ–°çš„ï¼Œå†æ¬¡<strong>æ’å…¥æ¶ˆæ¯</strong>ã€‚</li>\n<li>ç¬¬ 116 è‡³ 140 è¡Œ ï¼š<strong>æ¶ˆæ¯åˆ·ç›˜</strong>ï¼Œå³æŒä¹…åŒ–åˆ°æ–‡ä»¶ã€‚ä¸Šé¢<strong>æ’å…¥æ¶ˆæ¯</strong>å®é™…æœªå­˜å‚¨åˆ°ç¡¬ç›˜ã€‚æ­¤å¤„ï¼Œæ ¹æ®ä¸åŒçš„åˆ·ç›˜ç­–ç•¥ï¼Œæ‰§è¡Œä¼šæœ‰ä¸åŒã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#flushcommitlogservice\">FlushCommitLogService</a>ã€‚</li>\n<li>ç¬¬ 143 è‡³ 173 è¡Œ ï¼š<code>Broker</code> ä¸»ä»åŒæ­¥ã€‚åé¢çš„æ–‡ç« ä¼šè¯¦ç»†è§£æğŸ˜ˆã€‚</li>\n</ul>\n<h2>MappedFileQueue#getLastMappedFile(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> MappedFile <span class=\"title\">getLastMappedFile</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> startOffset, <span class=\"keyword\">boolean</span> needCreate)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">long</span> createOffset = -<span class=\"number\">1</span>; <span class=\"comment\">// åˆ›å»ºæ–‡ä»¶å¼€å§‹offsetã€‚-1æ—¶ï¼Œä¸åˆ›å»º</span></div><div class=\"line\"> <span class=\"number\">3</span>:     MappedFile mappedFileLast = getLastMappedFile();</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (mappedFileLast == <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// ä¸€ä¸ªæ˜ å°„æ–‡ä»¶éƒ½ä¸å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">6</span>:         createOffset = startOffset - (startOffset % <span class=\"keyword\">this</span>.mappedFileSize);</div><div class=\"line\"> <span class=\"number\">7</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (mappedFileLast != <span class=\"keyword\">null</span> &amp;&amp; mappedFileLast.isFull()) &#123; <span class=\"comment\">// æœ€åä¸€ä¸ªæ–‡ä»¶å·²æ»¡</span></div><div class=\"line\"><span class=\"number\">10</span>:         createOffset = mappedFileLast.getFileFromOffset() + <span class=\"keyword\">this</span>.mappedFileSize;</div><div class=\"line\"><span class=\"number\">11</span>:     &#125;</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (createOffset != -<span class=\"number\">1</span> &amp;&amp; needCreate) &#123; <span class=\"comment\">// åˆ›å»ºæ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">14</span>:         String nextFilePath = <span class=\"keyword\">this</span>.storePath + File.separator + UtilAll.offset2FileName(createOffset);</div><div class=\"line\"><span class=\"number\">15</span>:         String nextNextFilePath = <span class=\"keyword\">this</span>.storePath + File.separator</div><div class=\"line\"><span class=\"number\">16</span>:             + UtilAll.offset2FileName(createOffset + <span class=\"keyword\">this</span>.mappedFileSize);</div><div class=\"line\"><span class=\"number\">17</span>:         MappedFile mappedFile = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">18</span>: </div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.allocateMappedFileService != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             mappedFile = <span class=\"keyword\">this</span>.allocateMappedFileService.putRequestAndReturnMappedFile(nextFilePath,</div><div class=\"line\"><span class=\"number\">21</span>:                 nextNextFilePath, <span class=\"keyword\">this</span>.mappedFileSize);</div><div class=\"line\"><span class=\"number\">22</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 mappedFile = <span class=\"keyword\">new</span> MappedFile(nextFilePath, <span class=\"keyword\">this</span>.mappedFileSize);</div><div class=\"line\"><span class=\"number\">25</span>:             &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 log.error(<span class=\"string\">\"create mappedFile exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">if</span> (mappedFile != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.mappedFiles.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                 mappedFile.setFirstCreateInQueue(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">33</span>:             &#125;</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">this</span>.mappedFiles.add(mappedFile);</div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:         <span class=\"keyword\">return</span> mappedFile;</div><div class=\"line\"><span class=\"number\">38</span>:     &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"keyword\">return</span> mappedFileLast;</div><div class=\"line\"><span class=\"number\">41</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>\n<p>è¯´æ˜ ï¼šè·å–æœ€åä¸€ä¸ª <code>MappedFile</code>ï¼Œè‹¥ä¸å­˜åœ¨æˆ–æ–‡ä»¶å·²æ»¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚</p>\n</li>\n<li>\n<p>ç¬¬ 5 è‡³ 11 è¡Œ ï¼šè®¡ç®—å½“æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²æ»¡æ—¶ï¼Œæ–°åˆ›å»ºæ–‡ä»¶çš„ <code>createOffset</code>ã€‚</p>\n</li>\n<li>\n<p>ç¬¬ 14 è¡Œ ï¼šè®¡ç®—æ–‡ä»¶åã€‚ä»æ­¤å¤„æˆ‘ä»¬å¯\nä»¥å¾—çŸ¥ï¼Œ<code>MappedFile</code>çš„æ–‡ä»¶å‘½åè§„åˆ™ï¼š</p>\n<blockquote>\n<p>fileName[n] = fileName[n - 1] + n * mappedFileSize\nfileName[0] = startOffset - (startOffset % this.mappedFileSize)</p>\n</blockquote>\n<p>ç›®å‰ <code>CommitLog</code> çš„ <code>startOffset</code> ä¸º 0ã€‚\næ­¤å¤„æœ‰ä¸ª<strong>ç–‘é—®</strong>ï¼Œä¸ºä»€ä¹ˆéœ€è¦ <code>(startOffset % this.mappedFileSize)</code>ã€‚ä¾‹å¦‚ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>startOffset</th>\n<th style=\"text-align:left\">mappedFileSize</th>\n<th style=\"text-align:left\">createOffset</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">5</td>\n</tr>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">3</td>\n</tr>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td>5</td>\n<td style=\"text-align:left\">&gt; 5</td>\n<td style=\"text-align:left\">0</td>\n</tr>\n</tbody>\n</table>\n<p><em>å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦ï¼Œéº»çƒ¦æç¤ºä¸‹ã€‚ğŸ˜ˆ</em>\n<em>è§£ç­”ï¼šfileName[0] = startOffset - (startOffset % this.mappedFileSize) è®¡ç®—å‡ºæ¥çš„æ˜¯ï¼Œä»¥ <code>this.mappedFileSize</code> ä¸ºæ¯ä¸ªæ–‡ä»¶å¤§å°æ—¶ï¼Œ<code>startOffset</code> æ‰€åœ¨æ–‡ä»¶çš„å¼€å§‹<code>offset</code></em></p>\n</li>\n<li>\n<p>ç¬¬ 30 è‡³ 35 è¡Œ ï¼šè®¾ç½® <code>MappedFile</code>æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªåˆ›å»ºçš„æ–‡ä»¶ã€‚è¯¥æ ‡è¯†ç”¨äº <code>ConsumeQueue</code> å¯¹åº”çš„ <code>MappedFile</code> ï¼Œè¯¦è§ <code>ConsumeQueue#fillPreBlank</code>ã€‚</p>\n</li>\n</ul>\n<h2>MappedFile#appendMessage(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> AppendMessageResult <span class=\"title\">appendMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExtBrokerInner msg, <span class=\"keyword\">final</span> AppendMessageCallback cb)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">assert</span> msg != <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">assert</span> cb != <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">int</span> currentPos = <span class=\"keyword\">this</span>.wrotePosition.get();</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">if</span> (currentPos &lt; <span class=\"keyword\">this</span>.fileSize) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:         ByteBuffer byteBuffer = writeBuffer != <span class=\"keyword\">null</span> ? writeBuffer.slice() : <span class=\"keyword\">this</span>.mappedByteBuffer.slice();</div><div class=\"line\"> <span class=\"number\">9</span>:         byteBuffer.position(currentPos);</div><div class=\"line\"><span class=\"number\">10</span>:         AppendMessageResult result =</div><div class=\"line\"><span class=\"number\">11</span>:             cb.doAppend(<span class=\"keyword\">this</span>.getFileFromOffset(), byteBuffer, <span class=\"keyword\">this</span>.fileSize - currentPos, msg);</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">this</span>.wrotePosition.addAndGet(result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">this</span>.storeTimestamp = result.getStoreTimestamp();</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">15</span>:     &#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:     log.error(<span class=\"string\">\"MappedFile.appendMessage return null, wrotePosition: \"</span> + currentPos + <span class=\"string\">\" fileSize: \"</span></div><div class=\"line\"><span class=\"number\">18</span>:         + <span class=\"keyword\">this</span>.fileSize);</div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);</div><div class=\"line\"><span class=\"number\">20</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼š<strong>æ’å…¥æ¶ˆæ¯</strong>åˆ° <code>MappedFile</code>ï¼Œå¹¶è¿”å›æ’å…¥ç»“æœã€‚</li>\n<li>ç¬¬ 8 è¡Œ ï¼šè·å–éœ€è¦å†™å…¥çš„å­—èŠ‚ç¼“å†²åŒºã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ <code>writeBuffer != null</code> çš„åˆ¤æ–­åï¼Œä½¿ç”¨ä¸åŒçš„å­—èŠ‚ç¼“å†²åŒºï¼Œè§ï¼š<a href=\"#flushcommitlogservice\">FlushCommitLogService</a>ã€‚</li>\n<li>ç¬¬ 9 è‡³ 11 è¡Œ ï¼šè®¾ç½®å†™å…¥ <code>position</code>ï¼Œæ‰§è¡Œå†™å…¥ï¼Œæ›´æ–° <code>wrotePosition</code>(å½“å‰å†™å…¥ä½ç½®ï¼Œä¸‹æ¬¡å¼€å§‹å†™å…¥å¼€å§‹ä½ç½®)ã€‚</li>\n</ul>\n<h2>DefaultAppendMessageCallback#doAppend(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultAppendMessageCallback</span> <span class=\"keyword\">implements</span> <span class=\"title\">AppendMessageCallback</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"comment\">// File at the end of the minimum fixed length empty</span></div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> END_FILE_MIN_BLANK_LENGTH = <span class=\"number\">4</span> + <span class=\"number\">4</span>;</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  5:      * å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯ç¼–å·å­—èŠ‚Buffer</div><div class=\"line\">  6:      */</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ByteBuffer msgIdMemory;</div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  9:      * Store the message content</div><div class=\"line\"> 10:      * å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯å­—èŠ‚Buffer</div><div class=\"line\"> 11:      * å½“æ¶ˆæ¯ä¼ é€’åˆ°&#123;<span class=\"doctag\">@link</span> #doAppend(long, ByteBuffer, int, MessageExtBrokerInner)&#125;æ–¹æ³•æ—¶ï¼Œæœ€ç»ˆå†™åˆ°è¯¥å‚æ•°</div><div class=\"line\"> 12:      */</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ByteBuffer msgStoreItemMemory;</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 15:      * The maximum length of the message</div><div class=\"line\"> 16:      * æ¶ˆæ¯æœ€å¤§é•¿åº¦</div><div class=\"line\"> 17:      */</div><div class=\"line\"> <span class=\"number\">18</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxMessageSize;</div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 20:      * Build Message Key</div><div class=\"line\"> 21:      * &#123;<span class=\"doctag\">@link</span> #topicQueueTable&#125;çš„key</div><div class=\"line\"> 22:      * è®¡ç®—æ–¹å¼ï¼štopic + \"-\" + queueId</div><div class=\"line\"> 23:      */</div><div class=\"line\"> <span class=\"number\">24</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> StringBuilder keyBuilder = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\"> <span class=\"number\">25</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 26:      * hostå­—èŠ‚buffer</div><div class=\"line\"> 27:      * ç”¨äºé‡å¤è®¡ç®—hostçš„å­—èŠ‚å†…å®¹</div><div class=\"line\"> 28:      */</div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ByteBuffer hostHolder = ByteBuffer.allocate(<span class=\"number\">8</span>);</div><div class=\"line\"> <span class=\"number\">30</span>: </div><div class=\"line\"> <span class=\"number\">31</span>:     DefaultAppendMessageCallback(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size) &#123;</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"keyword\">this</span>.msgIdMemory = ByteBuffer.allocate(MessageDecoder.MSG_ID_LENGTH);</div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory = ByteBuffer.allocate(size + END_FILE_MIN_BLANK_LENGTH);</div><div class=\"line\"> <span class=\"number\">34</span>:         <span class=\"keyword\">this</span>.maxMessageSize = size;</div><div class=\"line\"> <span class=\"number\">35</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">36</span>: </div><div class=\"line\"> <span class=\"number\">37</span>:     <span class=\"function\"><span class=\"keyword\">public</span> ByteBuffer <span class=\"title\">getMsgStoreItemMemory</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">38</span>:         <span class=\"keyword\">return</span> msgStoreItemMemory;</div><div class=\"line\"> <span class=\"number\">39</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">40</span>: </div><div class=\"line\"> <span class=\"number\">41</span>:     <span class=\"function\"><span class=\"keyword\">public</span> AppendMessageResult <span class=\"title\">doAppend</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> fileFromOffset, <span class=\"keyword\">final</span> ByteBuffer byteBuffer, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxBlank, <span class=\"keyword\">final</span> MessageExtBrokerInner msgInner)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">42</span>:         <span class=\"comment\">// STORETIMESTAMP + STOREHOSTADDRESS + OFFSET &lt;br&gt;</span></div><div class=\"line\"> <span class=\"number\">43</span>: </div><div class=\"line\"> <span class=\"number\">44</span>:         <span class=\"comment\">// PHY OFFSET</span></div><div class=\"line\"> <span class=\"number\">45</span>:         <span class=\"keyword\">long</span> wroteOffset = fileFromOffset + byteBuffer.position();</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"comment\">// è®¡ç®—commitLogé‡Œçš„msgId</span></div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"keyword\">this</span>.resetByteBuffer(hostHolder, <span class=\"number\">8</span>);</div><div class=\"line\"> <span class=\"number\">49</span>:         String msgId = MessageDecoder.createMessageId(<span class=\"keyword\">this</span>.msgIdMemory, msgInner.getStoreHostBytes(hostHolder), wroteOffset);</div><div class=\"line\"> <span class=\"number\">50</span>: </div><div class=\"line\"> <span class=\"number\">51</span>:         <span class=\"comment\">// Record ConsumeQueue information è·å–é˜Ÿåˆ—offset</span></div><div class=\"line\"> <span class=\"number\">52</span>:         keyBuilder.setLength(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">53</span>:         keyBuilder.append(msgInner.getTopic());</div><div class=\"line\"> <span class=\"number\">54</span>:         keyBuilder.append(<span class=\"string\">'-'</span>);</div><div class=\"line\"> <span class=\"number\">55</span>:         keyBuilder.append(msgInner.getQueueId());</div><div class=\"line\"> <span class=\"number\">56</span>:         String key = keyBuilder.toString();</div><div class=\"line\"> <span class=\"number\">57</span>:         Long queueOffset = CommitLog.<span class=\"keyword\">this</span>.topicQueueTable.get(key);</div><div class=\"line\"> <span class=\"number\">58</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == queueOffset) &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:             queueOffset = <span class=\"number\">0L</span>;</div><div class=\"line\"> <span class=\"number\">60</span>:             CommitLog.<span class=\"keyword\">this</span>.topicQueueTable.put(key, queueOffset);</div><div class=\"line\"> <span class=\"number\">61</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">62</span>: </div><div class=\"line\"> <span class=\"number\">63</span>:         <span class=\"comment\">// Transaction messages that require special handling // TODO ç–‘é—®ï¼šç”¨é€”</span></div><div class=\"line\"> <span class=\"number\">64</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());</div><div class=\"line\"> <span class=\"number\">65</span>:         <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">66</span>:             <span class=\"comment\">// Prepared and Rollback message is not consumed, will not enter the</span></div><div class=\"line\"> <span class=\"number\">67</span>:             <span class=\"comment\">// consumer queue</span></div><div class=\"line\"> <span class=\"number\">68</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class=\"line\"> <span class=\"number\">69</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class=\"line\"> <span class=\"number\">70</span>:                 queueOffset = <span class=\"number\">0L</span>;</div><div class=\"line\"> <span class=\"number\">71</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">72</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class=\"line\"> <span class=\"number\">73</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class=\"line\"> <span class=\"number\">74</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">75</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">76</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">77</span>: </div><div class=\"line\"> <span class=\"number\">78</span>:         <span class=\"comment\">// è®¡ç®—æ¶ˆæ¯é•¿åº¦</span></div><div class=\"line\"> <span class=\"number\">79</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] propertiesData =</div><div class=\"line\"> <span class=\"number\">80</span>:             msgInner.getPropertiesString() == <span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : msgInner.getPropertiesString().getBytes(MessageDecoder.CHARSET_UTF8);</div><div class=\"line\"> <span class=\"number\">81</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> propertiesLength = propertiesData == <span class=\"keyword\">null</span> ? <span class=\"number\">0</span> : propertiesData.length;</div><div class=\"line\"> <span class=\"number\">82</span>:         <span class=\"keyword\">if</span> (propertiesLength &gt; Short.MAX_VALUE) &#123;</div><div class=\"line\"> <span class=\"number\">83</span>:             log.warn(<span class=\"string\">\"putMessage message properties length too long. length=&#123;&#125;\"</span>, propertiesData.length);</div><div class=\"line\"> <span class=\"number\">84</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.PROPERTIES_SIZE_EXCEEDED);</div><div class=\"line\"> <span class=\"number\">85</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] topicData = msgInner.getTopic().getBytes(MessageDecoder.CHARSET_UTF8);</div><div class=\"line\"> <span class=\"number\">87</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> topicLength = topicData.length;</div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> bodyLength = msgInner.getBody() == <span class=\"keyword\">null</span> ? <span class=\"number\">0</span> : msgInner.getBody().length;</div><div class=\"line\"> <span class=\"number\">89</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> msgLen = calMsgLength(bodyLength, topicLength, propertiesLength);</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"comment\">// Exceeds the maximum message</span></div><div class=\"line\"> <span class=\"number\">91</span>:         <span class=\"keyword\">if</span> (msgLen &gt; <span class=\"keyword\">this</span>.maxMessageSize) &#123;</div><div class=\"line\"> <span class=\"number\">92</span>:             CommitLog.log.warn(<span class=\"string\">\"message size exceeded, msg total size: \"</span> + msgLen + <span class=\"string\">\", msg body size: \"</span> + bodyLength</div><div class=\"line\"> <span class=\"number\">93</span>:                 + <span class=\"string\">\", maxMessageSize: \"</span> + <span class=\"keyword\">this</span>.maxMessageSize);</div><div class=\"line\"> <span class=\"number\">94</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.MESSAGE_SIZE_EXCEEDED);</div><div class=\"line\"> <span class=\"number\">95</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">96</span>: </div><div class=\"line\"> <span class=\"number\">97</span>:         <span class=\"comment\">// Determines whether there is sufficient(è¶³å¤Ÿ) free space</span></div><div class=\"line\"> <span class=\"number\">98</span>:         <span class=\"keyword\">if</span> ((msgLen + END_FILE_MIN_BLANK_LENGTH) &gt; maxBlank) &#123;</div><div class=\"line\"> <span class=\"number\">99</span>:             <span class=\"keyword\">this</span>.resetByteBuffer(<span class=\"keyword\">this</span>.msgStoreItemMemory, maxBlank);</div><div class=\"line\"><span class=\"number\">100</span>:             <span class=\"comment\">// 1 TOTAL_SIZE</span></div><div class=\"line\"><span class=\"number\">101</span>:             <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(maxBlank);</div><div class=\"line\"><span class=\"number\">102</span>:             <span class=\"comment\">// 2 MAGIC_CODE</span></div><div class=\"line\"><span class=\"number\">103</span>:             <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(CommitLog.BLANK_MAGIC_CODE);</div><div class=\"line\"><span class=\"number\">104</span>:             <span class=\"comment\">// 3 The remaining space may be any value</span></div><div class=\"line\"><span class=\"number\">105</span>:             <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:             <span class=\"comment\">// Here the length of the specially set maxBlank</span></div><div class=\"line\"><span class=\"number\">108</span>:             <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTimeMills = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.now();</div><div class=\"line\"><span class=\"number\">109</span>:             byteBuffer.put(<span class=\"keyword\">this</span>.msgStoreItemMemory.array(), <span class=\"number\">0</span>, maxBlank);</div><div class=\"line\"><span class=\"number\">110</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.END_OF_FILE, wroteOffset, maxBlank, msgId, msgInner.getStoreTimestamp(),</div><div class=\"line\"><span class=\"number\">111</span>:                 queueOffset, CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.now() - beginTimeMills);</div><div class=\"line\"><span class=\"number\">112</span>:         &#125;</div><div class=\"line\"><span class=\"number\">113</span>: </div><div class=\"line\"><span class=\"number\">114</span>:         <span class=\"comment\">// Initialization of storage space</span></div><div class=\"line\"><span class=\"number\">115</span>:         <span class=\"keyword\">this</span>.resetByteBuffer(msgStoreItemMemory, msgLen);</div><div class=\"line\"><span class=\"number\">116</span>:         <span class=\"comment\">// 1 TOTAL_SIZE</span></div><div class=\"line\"><span class=\"number\">117</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgLen);</div><div class=\"line\"><span class=\"number\">118</span>:         <span class=\"comment\">// 2 MAGIC_CODE</span></div><div class=\"line\"><span class=\"number\">119</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(CommitLog.MESSAGE_MAGIC_CODE);</div><div class=\"line\"><span class=\"number\">120</span>:         <span class=\"comment\">// 3 BODY_CRC</span></div><div class=\"line\"><span class=\"number\">121</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getBodyCRC());</div><div class=\"line\"><span class=\"number\">122</span>:         <span class=\"comment\">// 4 QUEUE_ID</span></div><div class=\"line\"><span class=\"number\">123</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getQueueId());</div><div class=\"line\"><span class=\"number\">124</span>:         <span class=\"comment\">// 5 FLAG</span></div><div class=\"line\"><span class=\"number\">125</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getFlag());</div><div class=\"line\"><span class=\"number\">126</span>:         <span class=\"comment\">// 6 QUEUE_OFFSET</span></div><div class=\"line\"><span class=\"number\">127</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(queueOffset);</div><div class=\"line\"><span class=\"number\">128</span>:         <span class=\"comment\">// 7 PHYSICAL_OFFSET</span></div><div class=\"line\"><span class=\"number\">129</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(fileFromOffset + byteBuffer.position());</div><div class=\"line\"><span class=\"number\">130</span>:         <span class=\"comment\">// 8 SYS_FLAG</span></div><div class=\"line\"><span class=\"number\">131</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getSysFlag());</div><div class=\"line\"><span class=\"number\">132</span>:         <span class=\"comment\">// 9 BORN_TIMESTAMP</span></div><div class=\"line\"><span class=\"number\">133</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(msgInner.getBornTimestamp());</div><div class=\"line\"><span class=\"number\">134</span>:         <span class=\"comment\">// 10 BORN_HOST</span></div><div class=\"line\"><span class=\"number\">135</span>:         <span class=\"keyword\">this</span>.resetByteBuffer(hostHolder, <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">136</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.put(msgInner.getBornHostBytes(hostHolder));</div><div class=\"line\"><span class=\"number\">137</span>:         <span class=\"comment\">// 11 STORE_TIMESTAMP</span></div><div class=\"line\"><span class=\"number\">138</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(msgInner.getStoreTimestamp());</div><div class=\"line\"><span class=\"number\">139</span>:         <span class=\"comment\">// 12 STORE_HOST_ADDRESS</span></div><div class=\"line\"><span class=\"number\">140</span>:         <span class=\"keyword\">this</span>.resetByteBuffer(hostHolder, <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">141</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.put(msgInner.getStoreHostBytes(hostHolder));</div><div class=\"line\"><span class=\"number\">142</span>:         <span class=\"comment\">//this.msgStoreItemMemory.put(msgInner.getStoreHostBytes());</span></div><div class=\"line\"><span class=\"number\">143</span>:         <span class=\"comment\">// 13 RECONSUME_TIMES</span></div><div class=\"line\"><span class=\"number\">144</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(msgInner.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">145</span>:         <span class=\"comment\">// 14 Prepared Transaction Offset</span></div><div class=\"line\"><span class=\"number\">146</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putLong(msgInner.getPreparedTransactionOffset());</div><div class=\"line\"><span class=\"number\">147</span>:         <span class=\"comment\">// 15 BODY</span></div><div class=\"line\"><span class=\"number\">148</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putInt(bodyLength);</div><div class=\"line\"><span class=\"number\">149</span>:         <span class=\"keyword\">if</span> (bodyLength &gt; <span class=\"number\">0</span>)</div><div class=\"line\"><span class=\"number\">150</span>:             <span class=\"keyword\">this</span>.msgStoreItemMemory.put(msgInner.getBody());</div><div class=\"line\"><span class=\"number\">151</span>:         <span class=\"comment\">// 16 TOPIC</span></div><div class=\"line\"><span class=\"number\">152</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.put((<span class=\"keyword\">byte</span>) topicLength);</div><div class=\"line\"><span class=\"number\">153</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.put(topicData);</div><div class=\"line\"><span class=\"number\">154</span>:         <span class=\"comment\">// 17 PROPERTIES</span></div><div class=\"line\"><span class=\"number\">155</span>:         <span class=\"keyword\">this</span>.msgStoreItemMemory.putShort((<span class=\"keyword\">short</span>) propertiesLength);</div><div class=\"line\"><span class=\"number\">156</span>:         <span class=\"keyword\">if</span> (propertiesLength &gt; <span class=\"number\">0</span>)</div><div class=\"line\"><span class=\"number\">157</span>:             <span class=\"keyword\">this</span>.msgStoreItemMemory.put(propertiesData);</div><div class=\"line\"><span class=\"number\">158</span>: </div><div class=\"line\"><span class=\"number\">159</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTimeMills = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.now();</div><div class=\"line\"><span class=\"number\">160</span>:         <span class=\"comment\">// Write messages to the queue buffer</span></div><div class=\"line\"><span class=\"number\">161</span>:         byteBuffer.put(<span class=\"keyword\">this</span>.msgStoreItemMemory.array(), <span class=\"number\">0</span>, msgLen);</div><div class=\"line\"><span class=\"number\">162</span>: </div><div class=\"line\"><span class=\"number\">163</span>:         AppendMessageResult result = <span class=\"keyword\">new</span> AppendMessageResult(AppendMessageStatus.PUT_OK, wroteOffset, msgLen, msgId,</div><div class=\"line\"><span class=\"number\">164</span>:             msgInner.getStoreTimestamp(), queueOffset, CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.now() - beginTimeMills);</div><div class=\"line\"><span class=\"number\">165</span>: </div><div class=\"line\"><span class=\"number\">166</span>:         <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"><span class=\"number\">167</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class=\"line\"><span class=\"number\">168</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class=\"line\"><span class=\"number\">169</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">170</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class=\"line\"><span class=\"number\">171</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class=\"line\"><span class=\"number\">172</span>:                 <span class=\"comment\">// The next update ConsumeQueue information æ›´æ–°é˜Ÿåˆ—çš„offset</span></div><div class=\"line\"><span class=\"number\">173</span>:                 CommitLog.<span class=\"keyword\">this</span>.topicQueueTable.put(key, ++queueOffset);</div><div class=\"line\"><span class=\"number\">174</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">175</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">176</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">177</span>:         &#125;</div><div class=\"line\"><span class=\"number\">178</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">179</span>:     &#125;</div><div class=\"line\"><span class=\"number\">180</span>: </div><div class=\"line\"><span class=\"number\">181</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">182:      * é‡ç½®å­—èŠ‚ç¼“å†²åŒº</div><div class=\"line\">183:      *</div><div class=\"line\">184:      * <span class=\"doctag\">@param</span> byteBuffer å­—èŠ‚ç¼“å†²åŒº</div><div class=\"line\">185:      * <span class=\"doctag\">@param</span> limit é•¿åº¦</div><div class=\"line\">186:      */</div><div class=\"line\"><span class=\"number\">187</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">resetByteBuffer</span><span class=\"params\">(<span class=\"keyword\">final</span> ByteBuffer byteBuffer, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> limit)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">188</span>:         byteBuffer.flip();</div><div class=\"line\"><span class=\"number\">189</span>:         byteBuffer.limit(limit);</div><div class=\"line\"><span class=\"number\">190</span>:     &#125;</div><div class=\"line\"><span class=\"number\">191</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ’å…¥æ¶ˆæ¯åˆ°å­—èŠ‚ç¼“å†²åŒºã€‚</li>\n<li>ç¬¬ 45 è¡Œ ï¼šè®¡ç®—ç‰©ç†ä½ç½®ã€‚åœ¨ <code>CommitLog</code> çš„é¡ºåºå­˜å‚¨ä½ç½®ã€‚</li>\n<li>ç¬¬ 47 è‡³ 49 è¡Œ ï¼šè®¡ç®— <code>CommitLog</code> é‡Œçš„ <code>offsetMsgId</code>ã€‚è¿™é‡Œä¸€å®šè¦å’Œ <code>msgId</code> åŒºåˆ†å¼€ã€‚</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th>è®¡ç®—æ–¹å¼</th>\n<th>é•¿åº¦</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>offsetMsgId</td>\n<td>Brokerå­˜å‚¨æ—¶ç”Ÿæˆ</td>\n<td>Hex(storeHostBytes, wroteOffset)</td>\n<td>32</td>\n<td></td>\n</tr>\n<tr>\n<td>msgId</td>\n<td>Clientå‘é€æ¶ˆæ¯æ—¶ç”Ÿæˆ</td>\n<td>Hex(è¿›ç¨‹ç¼–å·, IP, ClassLoader, startTime, currentTime, è‡ªå¢åºåˆ—)</td>\n<td>32</td>\n<td><a href=\"http://www.yunai.me/RocketMQ/message/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message åŸºç¡€ã€‹</a></td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>ç¬¬ 51 è‡³ 61 è¡Œ ï¼šè·å–é˜Ÿåˆ—ä½ç½®(offset)ã€‚</li>\n<li>ç¬¬ 78 è‡³ 95 è¡Œ ï¼šè®¡ç®—æ¶ˆæ¯æ€»é•¿åº¦ã€‚</li>\n<li>ç¬¬ 98 è‡³ 112 è¡Œ ï¼šå½“æ–‡ä»¶å‰©ä½™ç©ºé—´ä¸è¶³æ—¶ï¼Œå†™å…¥ <code>BLANK</code> å ä½ï¼Œè¿”å›ç»“æœã€‚</li>\n<li>ç¬¬ 114 è‡³ 161 è¡Œ ï¼šå†™å…¥ <code>MESSAGE</code> ã€‚</li>\n<li>ç¬¬ 173 è¡Œ ï¼šæ›´æ–°é˜Ÿåˆ—ä½ç½®(offset)ã€‚</li>\n</ul>\n<h2>FlushCommitLogService</h2>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_23/03.png\" alt=\"FlushCommitLogServiceç±»å›¾\"></p>\n<table>\n<thead>\n<tr>\n<th>çº¿ç¨‹æœåŠ¡</th>\n<th>åœºæ™¯</th>\n<th>æ’å…¥æ¶ˆæ¯æ€§èƒ½</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CommitRealTimeService</td>\n<td>å¼‚æ­¥åˆ·ç›˜ &amp;&amp; å¼€å¯å†…å­˜å­—èŠ‚ç¼“å†²åŒº</td>\n<td>ç¬¬ä¸€</td>\n</tr>\n<tr>\n<td>FlushRealTimeService</td>\n<td>å¼‚æ­¥åˆ·ç›˜ &amp;&amp; å…³é—­å†…å­˜å­—èŠ‚ç¼“å†²åŒº</td>\n<td>ç¬¬äºŒ</td>\n</tr>\n<tr>\n<td>GroupCommitService</td>\n<td>åŒæ­¥åˆ·ç›˜</td>\n<td>ç¬¬ä¸‰</td>\n</tr>\n</tbody>\n</table>\n<h3>MappedFile#è½ç›˜</h3>\n<table>\n<thead>\n<tr>\n<th>æ–¹å¼</th>\n<th></th>\n<th style=\"text-align:left\"></th>\n<th style=\"text-align:left\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ–¹å¼ä¸€</td>\n<td>å†™å…¥å†…å­˜å­—èŠ‚ç¼“å†²åŒº(writeBuffer)</td>\n<td style=\"text-align:left\">ä»å†…å­˜å­—èŠ‚ç¼“å†²åŒº(write buffer)æäº¤(commit)åˆ°æ–‡ä»¶é€šé“(fileChannel)</td>\n<td style=\"text-align:left\">æ–‡ä»¶é€šé“(fileChannel)flush</td>\n</tr>\n<tr>\n<td>æ–¹å¼äºŒ</td>\n<td></td>\n<td style=\"text-align:left\">å†™å…¥æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer)</td>\n<td style=\"text-align:left\">æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer)flush</td>\n</tr>\n</tbody>\n</table>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_04_23/04.jpeg\" alt=\"MappedFileçš„positionè¿ç§»å›¾\"></p>\n<p><strong>flushç›¸å…³ä»£ç </strong></p>\n<p>è€ƒè™‘åˆ°å†™å…¥æ€§èƒ½ï¼Œæ»¡è¶³ <code>flushLeastPages * OS_PAGE_SIZE</code> æ‰è¿›è¡Œ <code>flush</code>ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * flush</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> flushLeastPages flushæœ€å°é¡µæ•°</div><div class=\"line\"> 5:  * <span class=\"doctag\">@return</span> The current flushed position</div><div class=\"line\"> 6:  */</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">flush</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> flushLeastPages)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isAbleToFlush(flushLeastPages)) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hold()) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">int</span> value = getReadPosition();</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"comment\">//We only append data to fileChannel or mappedByteBuffer, never both.</span></div><div class=\"line\"><span class=\"number\">14</span>:                 <span class=\"keyword\">if</span> (writeBuffer != <span class=\"keyword\">null</span> || <span class=\"keyword\">this</span>.fileChannel.position() != <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                     <span class=\"keyword\">this</span>.fileChannel.force(<span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">16</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                     <span class=\"keyword\">this</span>.mappedByteBuffer.force();</div><div class=\"line\"><span class=\"number\">18</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">19</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                 log.error(<span class=\"string\">\"Error occurred when force data to disk.\"</span>, e);</div><div class=\"line\"><span class=\"number\">21</span>:             &#125;</div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">this</span>.flushedPosition.set(value);</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">this</span>.release();</div><div class=\"line\"><span class=\"number\">25</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:             log.warn(<span class=\"string\">\"in flush, hold failed, flush offset = \"</span> + <span class=\"keyword\">this</span>.flushedPosition.get());</div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">this</span>.flushedPosition.set(getReadPosition());</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>:     &#125;</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.getFlushedPosition();</div><div class=\"line\"><span class=\"number\">31</span>: &#125;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>: <span class=\"comment\">/**</span></div><div class=\"line\">34:  * æ˜¯å¦èƒ½å¤Ÿflushã€‚æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä»»æ„æ¡ä»¶ï¼š</div><div class=\"line\">35:  * 1. æ˜ å°„æ–‡ä»¶å·²ç»å†™æ»¡</div><div class=\"line\">36:  * 2. flushLeastPages &gt; 0 &amp;&amp; æœªflushéƒ¨åˆ†è¶…è¿‡flushLeastPages</div><div class=\"line\">37:  * 3. flushLeastPages = 0 &amp;&amp; æœ‰æ–°å†™å…¥éƒ¨åˆ†</div><div class=\"line\">38:  *</div><div class=\"line\">39:  * <span class=\"doctag\">@param</span> flushLeastPages flushæœ€å°åˆ†é¡µ</div><div class=\"line\">40:  * <span class=\"doctag\">@return</span> æ˜¯å¦èƒ½å¤Ÿå†™å…¥</div><div class=\"line\">41:  */</div><div class=\"line\"><span class=\"number\">42</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAbleToFlush</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> flushLeastPages)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"keyword\">int</span> flush = <span class=\"keyword\">this</span>.flushedPosition.get();</div><div class=\"line\"><span class=\"number\">44</span>:     <span class=\"keyword\">int</span> write = getReadPosition();</div><div class=\"line\"><span class=\"number\">45</span>: </div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isFull()) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">48</span>:     &#125;</div><div class=\"line\"><span class=\"number\">49</span>: </div><div class=\"line\"><span class=\"number\">50</span>:     <span class=\"keyword\">if</span> (flushLeastPages &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:         <span class=\"keyword\">return</span> ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) &gt;= flushLeastPages;</div><div class=\"line\"><span class=\"number\">52</span>:     &#125;</div><div class=\"line\"><span class=\"number\">53</span>: </div><div class=\"line\"><span class=\"number\">54</span>:     <span class=\"keyword\">return</span> write &gt; flush;</div><div class=\"line\"><span class=\"number\">55</span>: &#125;</div></pre></td></tr></table></figure></p>\n<p><strong>commitç›¸å…³ä»£ç ï¼š</strong></p>\n<p>è€ƒè™‘åˆ°å†™å…¥æ€§èƒ½ï¼Œæ»¡è¶³ <code>commitLeastPages * OS_PAGE_SIZE</code> æ‰è¿›è¡Œ <code>commit</code>ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * commit</div><div class=\"line\"> 3:  * å½“&#123;<span class=\"doctag\">@link</span> #writeBuffer&#125;ä¸ºnullæ—¶ï¼Œç›´æ¥è¿”å›&#123;<span class=\"doctag\">@link</span> #wrotePosition&#125;</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> commitLeastPages commitæœ€å°é¡µæ•°</div><div class=\"line\"> 6:  * <span class=\"doctag\">@return</span> å½“å‰commitä½ç½®</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">commit</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> commitLeastPages)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (writeBuffer == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"comment\">//no need to commit data to file channel, so just regard wrotePosition as committedPosition.</span></div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.wrotePosition.get();</div><div class=\"line\"><span class=\"number\">12</span>:     &#125;</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isAbleToCommit(commitLeastPages)) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hold()) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:             commit0(commitLeastPages);</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">this</span>.release();</div><div class=\"line\"><span class=\"number\">17</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">18</span>:             log.warn(<span class=\"string\">\"in commit, hold failed, commit offset = \"</span> + <span class=\"keyword\">this</span>.committedPosition.get());</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125;</div><div class=\"line\"><span class=\"number\">21</span>: </div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"comment\">// All dirty data has been committed to FileChannel. å†™åˆ°æ–‡ä»¶å°¾æ—¶ï¼Œå›æ”¶writeBufferã€‚</span></div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"keyword\">if</span> (writeBuffer != <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.transientStorePool != <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.fileSize == <span class=\"keyword\">this</span>.committedPosition.get()) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">this</span>.transientStorePool.returnBuffer(writeBuffer);</div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">this</span>.writeBuffer = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.committedPosition.get();</div><div class=\"line\"><span class=\"number\">29</span>: &#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>: <span class=\"comment\">/**</span></div><div class=\"line\">32:  * commitå®ç°ï¼Œå°†writeBufferå†™å…¥fileChannelã€‚</div><div class=\"line\">33:  * <span class=\"doctag\">@param</span> commitLeastPages commitæœ€å°é¡µæ•°ã€‚ç”¨ä¸ä¸Šè¯¥å‚æ•°</div><div class=\"line\">34:  */</div><div class=\"line\"><span class=\"number\">35</span>: <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">commit0</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> commitLeastPages)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"keyword\">int</span> writePos = <span class=\"keyword\">this</span>.wrotePosition.get();</div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"keyword\">int</span> lastCommittedPosition = <span class=\"keyword\">this</span>.committedPosition.get();</div><div class=\"line\"><span class=\"number\">38</span>: </div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"keyword\">if</span> (writePos - <span class=\"keyword\">this</span>.committedPosition.get() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">41</span>:             <span class=\"comment\">// è®¾ç½®éœ€è¦å†™å…¥çš„byteBuffer</span></div><div class=\"line\"><span class=\"number\">42</span>:             ByteBuffer byteBuffer = writeBuffer.slice();</div><div class=\"line\"><span class=\"number\">43</span>:             byteBuffer.position(lastCommittedPosition);</div><div class=\"line\"><span class=\"number\">44</span>:             byteBuffer.limit(writePos);</div><div class=\"line\"><span class=\"number\">45</span>:             <span class=\"comment\">// å†™å…¥fileChannel</span></div><div class=\"line\"><span class=\"number\">46</span>:             <span class=\"keyword\">this</span>.fileChannel.position(lastCommittedPosition);</div><div class=\"line\"><span class=\"number\">47</span>:             <span class=\"keyword\">this</span>.fileChannel.write(byteBuffer);</div><div class=\"line\"><span class=\"number\">48</span>:             <span class=\"comment\">// è®¾ç½®position</span></div><div class=\"line\"><span class=\"number\">49</span>:             <span class=\"keyword\">this</span>.committedPosition.set(writePos);</div><div class=\"line\"><span class=\"number\">50</span>:         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:             log.error(<span class=\"string\">\"Error occurred when commit data to FileChannel.\"</span>, e);</div><div class=\"line\"><span class=\"number\">52</span>:         &#125;</div><div class=\"line\"><span class=\"number\">53</span>:     &#125;</div><div class=\"line\"><span class=\"number\">54</span>: &#125;</div><div class=\"line\"><span class=\"number\">55</span>: </div><div class=\"line\"><span class=\"number\">56</span>: <span class=\"comment\">/**</span></div><div class=\"line\">57:  * æ˜¯å¦èƒ½å¤Ÿcommitã€‚æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä»»æ„æ¡ä»¶ï¼š</div><div class=\"line\">58:  * 1. æ˜ å°„æ–‡ä»¶å·²ç»å†™æ»¡</div><div class=\"line\">59:  * 2. commitLeastPages &gt; 0 &amp;&amp; æœªcommitéƒ¨åˆ†è¶…è¿‡commitLeastPages</div><div class=\"line\">60:  * 3. commitLeastPages = 0 &amp;&amp; æœ‰æ–°å†™å…¥éƒ¨åˆ†</div><div class=\"line\">61:  *</div><div class=\"line\">62:  * <span class=\"doctag\">@param</span> commitLeastPages commitæœ€å°åˆ†é¡µ</div><div class=\"line\">63:  * <span class=\"doctag\">@return</span> æ˜¯å¦èƒ½å¤Ÿå†™å…¥</div><div class=\"line\">64:  */</div><div class=\"line\"><span class=\"number\">65</span>: <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAbleToCommit</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> commitLeastPages)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">66</span>:     <span class=\"keyword\">int</span> flush = <span class=\"keyword\">this</span>.committedPosition.get();</div><div class=\"line\"><span class=\"number\">67</span>:     <span class=\"keyword\">int</span> write = <span class=\"keyword\">this</span>.wrotePosition.get();</div><div class=\"line\"><span class=\"number\">68</span>: </div><div class=\"line\"><span class=\"number\">69</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isFull()) &#123;</div><div class=\"line\"><span class=\"number\">70</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">71</span>:     &#125;</div><div class=\"line\"><span class=\"number\">72</span>: </div><div class=\"line\"><span class=\"number\">73</span>:     <span class=\"keyword\">if</span> (commitLeastPages &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">74</span>:         <span class=\"keyword\">return</span> ((write / OS_PAGE_SIZE) - (flush / OS_PAGE_SIZE)) &gt;= commitLeastPages;</div><div class=\"line\"><span class=\"number\">75</span>:     &#125;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"keyword\">return</span> write &gt; flush;</div><div class=\"line\"><span class=\"number\">78</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>FlushRealTimeService</h3>\n<p>æ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FlushRealTimeService</span> <span class=\"keyword\">extends</span> <span class=\"title\">FlushCommitLogService</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 3:      * æœ€åflushæ—¶é—´æˆ³</div><div class=\"line\"> 4:      */</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> lastFlushTimestamp = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 7:      * printè®¡æ—¶å™¨ã€‚</div><div class=\"line\"> 8:      * æ»¡è¶³printæ¬¡æ•°æ—¶ï¼Œè°ƒç”¨&#123;<span class=\"doctag\">@link</span> #printFlushProgress()&#125;</div><div class=\"line\"> 9:      */</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> printTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">13</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">boolean</span> flushCommitLogTimed = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().isFlushCommitLogTimed();</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">int</span> interval = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushIntervalCommitLog();</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">int</span> flushPhysicQueueLeastPages = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogLeastPages();</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">int</span> flushPhysicQueueThoroughInterval = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushCommitLogThoroughInterval();</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"comment\">// Print flush progress</span></div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"comment\">// å½“æ—¶é—´æ»¡è¶³flushPhysicQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushPhysicQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush</span></div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">boolean</span> printFlushProgress = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">long</span> currentTimeMillis = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"keyword\">if</span> (currentTimeMillis &gt;= (<span class=\"keyword\">this</span>.lastFlushTimestamp + flushPhysicQueueThoroughInterval)) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 <span class=\"keyword\">this</span>.lastFlushTimestamp = currentTimeMillis;</div><div class=\"line\"><span class=\"number\">27</span>:                 flushPhysicQueueLeastPages = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">28</span>:                 printFlushProgress = (printTimes++ % <span class=\"number\">10</span>) == <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">29</span>:             &#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"comment\">// ç­‰å¾…æ‰§è¡Œ</span></div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"keyword\">if</span> (flushCommitLogTimed) &#123;</div><div class=\"line\"><span class=\"number\">34</span>:                     Thread.sleep(interval);</div><div class=\"line\"><span class=\"number\">35</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">36</span>:                     <span class=\"keyword\">this</span>.waitForRunning(interval);</div><div class=\"line\"><span class=\"number\">37</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">38</span>: </div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">if</span> (printFlushProgress) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                     <span class=\"keyword\">this</span>.printFlushProgress();</div><div class=\"line\"><span class=\"number\">41</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">42</span>: </div><div class=\"line\"><span class=\"number\">43</span>:                 <span class=\"comment\">// flush commitLog</span></div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"keyword\">long</span> begin = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">45</span>:                 CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.flush(flushPhysicQueueLeastPages);</div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">long</span> storeTimestamp = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.getStoreTimestamp();</div><div class=\"line\"><span class=\"number\">47</span>:                 <span class=\"keyword\">if</span> (storeTimestamp &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">48</span>:                     CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);</div><div class=\"line\"><span class=\"number\">49</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">50</span>:                 <span class=\"keyword\">long</span> past = System.currentTimeMillis() - begin;</div><div class=\"line\"><span class=\"number\">51</span>:                 <span class=\"keyword\">if</span> (past &gt; <span class=\"number\">500</span>) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:                     log.info(<span class=\"string\">\"Flush data to disk costs &#123;&#125; ms\"</span>, past);</div><div class=\"line\"><span class=\"number\">53</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">54</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">55</span>:                 CommitLog.log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">56</span>:                 <span class=\"keyword\">this</span>.printFlushProgress();</div><div class=\"line\"><span class=\"number\">57</span>:             &#125;</div><div class=\"line\"><span class=\"number\">58</span>:         &#125;</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:         <span class=\"comment\">// Normal shutdown, to ensure that all the flush before exit</span></div><div class=\"line\"><span class=\"number\">61</span>:         <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; RETRY_TIMES_OVER &amp;&amp; !result; i++) &#123;</div><div class=\"line\"><span class=\"number\">63</span>:             result = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.flush(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">64</span>:             CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service shutdown, retry \"</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">\" times \"</span> + (result ? <span class=\"string\">\"OK\"</span> : <span class=\"string\">\"Not OK\"</span>));</div><div class=\"line\"><span class=\"number\">65</span>:         &#125;</div><div class=\"line\"><span class=\"number\">66</span>: </div><div class=\"line\"><span class=\"number\">67</span>:         <span class=\"keyword\">this</span>.printFlushProgress();</div><div class=\"line\"><span class=\"number\">68</span>: </div><div class=\"line\"><span class=\"number\">69</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">70</span>:     &#125;</div><div class=\"line\"><span class=\"number\">71</span>: </div><div class=\"line\"><span class=\"number\">72</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">73</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">74</span>:         <span class=\"keyword\">return</span> FlushRealTimeService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">75</span>:     &#125;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">printFlushProgress</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">78</span>:         <span class=\"comment\">// CommitLog.log.info(\"how much disk fall behind memory, \"</span></div><div class=\"line\"><span class=\"number\">79</span>:         <span class=\"comment\">// + CommitLog.this.mappedFileQueue.howMuchFallBehind());</span></div><div class=\"line\"><span class=\"number\">80</span>:     &#125;</div><div class=\"line\"><span class=\"number\">81</span>: </div><div class=\"line\"><span class=\"number\">82</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">83</span>:     <span class=\"meta\">@SuppressWarnings</span>(<span class=\"string\">\"SpellCheckingInspection\"</span>)</div><div class=\"line\"><span class=\"number\">84</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getJointime</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">85</span>:         <span class=\"keyword\">return</span> <span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">5</span>;</div><div class=\"line\"><span class=\"number\">86</span>:     &#125;</div><div class=\"line\"><span class=\"number\">87</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šå®æ—¶ <code>flush</code>çº¿ç¨‹æœåŠ¡ï¼Œè°ƒç”¨ <code>MappedFile#flush</code> ç›¸å…³é€»è¾‘ã€‚</li>\n<li>ç¬¬ 23 è‡³ 29 è¡Œ ï¼šæ¯ <code>flushPhysicQueueThoroughInterval</code> å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ <code>flush</code> ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ <code>flushCommitLogLeastPages</code> å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ <code>flush</code> ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ <code>flush</code>ï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚</li>\n<li>ç¬¬ 33 è¡Œ è‡³ 37 è¡Œ ï¼šæ ¹æ® <code>flushCommitLogTimed</code> å‚æ•°ï¼Œå¯ä»¥é€‰æ‹©æ¯æ¬¡å¾ªç¯æ˜¯<strong>å›ºå®šå‘¨æœŸ</strong>è¿˜æ˜¯<strong>ç­‰å¾…å”¤é†’</strong>ã€‚é»˜è®¤é…ç½®æ˜¯åè€…ï¼Œæ‰€ä»¥ï¼Œæ¯æ¬¡æ’å…¥æ¶ˆæ¯å®Œæˆï¼Œä¼šå»è°ƒç”¨ <code>commitLogService.wakeup()</code> ã€‚</li>\n<li>ç¬¬ 45 è¡Œ ï¼šè°ƒç”¨ <code>MappedFile</code> è¿›è¡Œ <code>flush</code>ã€‚</li>\n<li>ç¬¬ 61 è‡³ 65 è¡Œ ï¼š<code>Broker</code> å…³é—­æ—¶ï¼Œå¼ºåˆ¶ <code>flush</code>ï¼Œé¿å…æœ‰æœªåˆ·ç›˜çš„æ•°æ®ã€‚</li>\n</ul>\n<h3>CommitRealTimeService</h3>\n<p>æ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚\nå’Œ <code>FlushRealTimeService</code> ç±»ä¼¼ï¼Œæ€§èƒ½æ›´å¥½ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CommitRealTimeService</span> <span class=\"keyword\">extends</span> <span class=\"title\">FlushCommitLogService</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * æœ€å commit æ—¶é—´æˆ³</div><div class=\"line\"> 5:      */</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> lastCommitTimestamp = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">return</span> CommitRealTimeService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">11</span>:     &#125;</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">15</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">int</span> interval = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getCommitIntervalCommitLog();</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">int</span> commitDataLeastPages = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogLeastPages();</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">int</span> commitDataThoroughInterval = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getCommitCommitLogThoroughInterval();</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"comment\">// å½“æ—¶é—´æ»¡è¶³commitDataThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³commitDataLeastPagesï¼Œä¹Ÿè¿›è¡Œflush</span></div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">long</span> begin = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">if</span> (begin &gt;= (<span class=\"keyword\">this</span>.lastCommitTimestamp + commitDataThoroughInterval)) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 <span class=\"keyword\">this</span>.lastCommitTimestamp = begin;</div><div class=\"line\"><span class=\"number\">25</span>:                 commitDataLeastPages = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">26</span>:             &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">29</span>:                 <span class=\"comment\">// commit</span></div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">boolean</span> result = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.commit(commitDataLeastPages);</div><div class=\"line\"><span class=\"number\">31</span>:                 <span class=\"keyword\">long</span> end = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"keyword\">if</span> (!result) &#123; <span class=\"comment\">// TODO ç–‘é—®ï¼šæœªå†™å…¥æˆåŠŸï¼Œä¸ºå•¥è¦å”¤é†’flushCommitLogService</span></div><div class=\"line\"><span class=\"number\">33</span>:                     <span class=\"keyword\">this</span>.lastCommitTimestamp = end; <span class=\"comment\">// result = false means some data committed.</span></div><div class=\"line\"><span class=\"number\">34</span>:                     <span class=\"comment\">//now wake up flush thread.</span></div><div class=\"line\"><span class=\"number\">35</span>:                     flushCommitLogService.wakeup();</div><div class=\"line\"><span class=\"number\">36</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">37</span>: </div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"keyword\">if</span> (end - begin &gt; <span class=\"number\">500</span>) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:                     log.info(<span class=\"string\">\"Commit data to file costs &#123;&#125; ms\"</span>, end - begin);</div><div class=\"line\"><span class=\"number\">40</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:                 <span class=\"comment\">// ç­‰å¾…æ‰§è¡Œ</span></div><div class=\"line\"><span class=\"number\">43</span>:                 <span class=\"keyword\">this</span>.waitForRunning(interval);</div><div class=\"line\"><span class=\"number\">44</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">45</span>:                 CommitLog.log.error(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">46</span>:             &#125;</div><div class=\"line\"><span class=\"number\">47</span>:         &#125;</div><div class=\"line\"><span class=\"number\">48</span>: </div><div class=\"line\"><span class=\"number\">49</span>:         <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">50</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; RETRY_TIMES_OVER &amp;&amp; !result; i++) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:             result = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.commit(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">52</span>:             CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service shutdown, retry \"</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">\" times \"</span> + (result ? <span class=\"string\">\"OK\"</span> : <span class=\"string\">\"Not OK\"</span>));</div><div class=\"line\"><span class=\"number\">53</span>:         &#125;</div><div class=\"line\"><span class=\"number\">54</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">55</span>:     &#125;</div><div class=\"line\"><span class=\"number\">56</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>GroupCommitService</h3>\n<p>æ¶ˆæ¯æ’å…¥æˆåŠŸæ—¶ï¼ŒåŒæ­¥åˆ·ç›˜æ—¶ä½¿ç”¨ã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GroupCommitService</span> <span class=\"keyword\">extends</span> <span class=\"title\">FlushCommitLogService</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  3:      * å†™å…¥è¯·æ±‚é˜Ÿåˆ—</div><div class=\"line\">  4:      */</div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> List&lt;GroupCommitRequest&gt; requestsWrite = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  7:      * è¯»å–è¯·æ±‚é˜Ÿåˆ—</div><div class=\"line\">  8:      */</div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> List&lt;GroupCommitRequest&gt; requestsRead = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">10</span>: </div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 12:      * æ·»åŠ å†™å…¥è¯·æ±‚</div><div class=\"line\"> 13:      *</div><div class=\"line\"> 14:      * <span class=\"doctag\">@param</span> request å†™å…¥è¯·æ±‚</div><div class=\"line\"> 15:      */</div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">putRequest</span><span class=\"params\">(<span class=\"keyword\">final</span> GroupCommitRequest request)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"comment\">// æ·»åŠ å†™å…¥è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>.requestsWrite) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"keyword\">this</span>.requestsWrite.add(request);</div><div class=\"line\"> <span class=\"number\">20</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"comment\">// åˆ‡æ¢è¯»å†™é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">22</span>:         <span class=\"keyword\">if</span> (hasNotified.compareAndSet(<span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>)) &#123;</div><div class=\"line\"> <span class=\"number\">23</span>:             waitPoint.countDown(); <span class=\"comment\">// notify</span></div><div class=\"line\"> <span class=\"number\">24</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">25</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 28:      * åˆ‡æ¢è¯»å†™é˜Ÿåˆ—</div><div class=\"line\"> 29:      */</div><div class=\"line\"> <span class=\"number\">30</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">swapRequests</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">31</span>:         List&lt;GroupCommitRequest&gt; tmp = <span class=\"keyword\">this</span>.requestsWrite;</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"keyword\">this</span>.requestsWrite = <span class=\"keyword\">this</span>.requestsRead;</div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"keyword\">this</span>.requestsRead = tmp;</div><div class=\"line\"> <span class=\"number\">34</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">35</span>: </div><div class=\"line\"> <span class=\"number\">36</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doCommit</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">37</span>:         <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:             <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.requestsRead.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">39</span>:                 <span class=\"keyword\">for</span> (GroupCommitRequest req : <span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\"> <span class=\"number\">40</span>:                     <span class=\"comment\">// There may be a message in the next file, so a maximum of</span></div><div class=\"line\"> <span class=\"number\">41</span>:                     <span class=\"comment\">// two times the flush (å¯èƒ½æ‰¹é‡æäº¤çš„messagesï¼Œåˆ†å¸ƒåœ¨ä¸¤ä¸ªMappedFile)</span></div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"keyword\">boolean</span> flushOK = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">43</span>:                     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">2</span> &amp;&amp; !flushOK; i++) &#123;</div><div class=\"line\"> <span class=\"number\">44</span>:                         <span class=\"comment\">// æ˜¯å¦æ»¡è¶³éœ€è¦flushæ¡ä»¶ï¼Œå³è¯·æ±‚çš„offsetè¶…è¿‡flushçš„offset</span></div><div class=\"line\"> <span class=\"number\">45</span>:                         flushOK = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.getFlushedWhere() &gt;= req.getNextOffset();</div><div class=\"line\"> <span class=\"number\">46</span>:                         <span class=\"keyword\">if</span> (!flushOK) &#123;</div><div class=\"line\"> <span class=\"number\">47</span>:                             CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.flush(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">48</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">49</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">50</span>:                     <span class=\"comment\">// å”¤é†’ç­‰å¾…è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">51</span>:                     req.wakeupCustomer(flushOK);</div><div class=\"line\"> <span class=\"number\">52</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">53</span>: </div><div class=\"line\"> <span class=\"number\">54</span>:                 <span class=\"keyword\">long</span> storeTimestamp = CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.getStoreTimestamp();</div><div class=\"line\"> <span class=\"number\">55</span>:                 <span class=\"keyword\">if</span> (storeTimestamp &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:                     CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getStoreCheckpoint().setPhysicMsgTimestamp(storeTimestamp);</div><div class=\"line\"> <span class=\"number\">57</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">58</span>: </div><div class=\"line\"> <span class=\"number\">59</span>:                 <span class=\"comment\">// æ¸…ç†è¯»å–é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">60</span>:                 <span class=\"keyword\">this</span>.requestsRead.clear();</div><div class=\"line\"> <span class=\"number\">61</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">62</span>:                 <span class=\"comment\">// Because of individual messages is set to not sync flush, it</span></div><div class=\"line\"> <span class=\"number\">63</span>:                 <span class=\"comment\">// will come to this process ä¸åˆæ³•çš„è¯·æ±‚ï¼Œæ¯”å¦‚messageä¸Šæœªè®¾ç½®isWaitStoreMsgOKã€‚</span></div><div class=\"line\"> <span class=\"number\">64</span>:                 <span class=\"comment\">// èµ°åˆ°æ­¤å¤„çš„é€»è¾‘ï¼Œç›¸å½“äºå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè½ç›˜ä¸€æ¡æ¶ˆæ¯ï¼Œå®é™…æ— æ‰¹é‡æäº¤çš„æ•ˆæœã€‚</span></div><div class=\"line\"> <span class=\"number\">65</span>:                 CommitLog.<span class=\"keyword\">this</span>.mappedFileQueue.flush(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">66</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">67</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">68</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">69</span>: </div><div class=\"line\"> <span class=\"number\">70</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">71</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"> <span class=\"number\">72</span>: </div><div class=\"line\"> <span class=\"number\">73</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">75</span>:                 <span class=\"keyword\">this</span>.waitForRunning(<span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">76</span>:                 <span class=\"keyword\">this</span>.doCommit();</div><div class=\"line\"> <span class=\"number\">77</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">78</span>:                 CommitLog.log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"> <span class=\"number\">79</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">80</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">81</span>: </div><div class=\"line\"> <span class=\"number\">82</span>:         <span class=\"comment\">// Under normal circumstances shutdown, wait for the arrival of the</span></div><div class=\"line\"> <span class=\"number\">83</span>:         <span class=\"comment\">// request, and then flush</span></div><div class=\"line\"> <span class=\"number\">84</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">85</span>:             Thread.sleep(<span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">86</span>:         &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:             CommitLog.log.warn(<span class=\"string\">\"GroupCommitService Exception, \"</span>, e);</div><div class=\"line\"> <span class=\"number\">88</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">89</span>: </div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</div><div class=\"line\"> <span class=\"number\">91</span>:             <span class=\"keyword\">this</span>.swapRequests();</div><div class=\"line\"> <span class=\"number\">92</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">93</span>: </div><div class=\"line\"> <span class=\"number\">94</span>:         <span class=\"keyword\">this</span>.doCommit();</div><div class=\"line\"> <span class=\"number\">95</span>: </div><div class=\"line\"> <span class=\"number\">96</span>:         CommitLog.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"> <span class=\"number\">97</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">98</span>: </div><div class=\"line\"> <span class=\"number\">99</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">100:      * æ¯æ¬¡æ‰§è¡Œå®Œï¼Œåˆ‡æ¢è¯»å†™é˜Ÿåˆ—</div><div class=\"line\">101:      */</div><div class=\"line\"><span class=\"number\">102</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">103</span>:     <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onWaitEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">104</span>:         <span class=\"keyword\">this</span>.swapRequests();</div><div class=\"line\"><span class=\"number\">105</span>:     &#125;</div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">108</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">109</span>:         <span class=\"keyword\">return</span> GroupCommitService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">110</span>:     &#125;</div><div class=\"line\"><span class=\"number\">111</span>: </div><div class=\"line\"><span class=\"number\">112</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">113</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getJointime</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">114</span>:         <span class=\"keyword\">return</span> <span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">5</span>;</div><div class=\"line\"><span class=\"number\">115</span>:     &#125;</div><div class=\"line\"><span class=\"number\">116</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šæ‰¹é‡å†™å…¥çº¿ç¨‹æœåŠ¡ã€‚</li>\n<li>ç¬¬ 16 è‡³ 25 è¡Œ ï¼šæ·»åŠ å†™å…¥è¯·æ±‚ã€‚æ–¹æ³•è®¾ç½®äº† <code>sync</code> çš„åŸå› ï¼š<code>this.requestsWrite</code> ä¼šå’Œ <code>this.requestsRead</code> ä¸æ–­äº¤æ¢ï¼Œæ— æ³•ä¿è¯ç¨³å®šçš„åŒæ­¥ã€‚</li>\n<li>ç¬¬ 27 è‡³ 34 è¡Œ ï¼šè¯»å†™é˜Ÿåˆ—äº¤æ¢ã€‚</li>\n<li>ç¬¬ 38 è‡³ 60 è¡Œ ï¼šå¾ªç¯å†™å…¥é˜Ÿåˆ—ï¼Œè¿›è¡Œ <code>flush</code>ã€‚\n<ul>\n<li>ç¬¬ 43 è¡Œ ï¼šè€ƒè™‘åˆ°æœ‰å¯èƒ½æ¯æ¬¡å¾ªç¯çš„æ¶ˆæ¯å†™å…¥çš„æ¶ˆæ¯ï¼Œå¯èƒ½åˆ†å¸ƒåœ¨<strong>ä¸¤ä¸ª</strong> <code>MappedFile</code>(å†™ç¬¬Nä¸ªæ¶ˆæ¯æ—¶ï¼Œ<code>MappedFile</code> å·²æ»¡ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„)ï¼Œæ‰€ä»¥éœ€è¦æœ‰å¾ªç¯2æ¬¡ã€‚</li>\n<li>ç¬¬ 51 è¡Œ ï¼šå”¤é†’ç­‰å¾…å†™å…¥è¯·æ±‚çº¿ç¨‹ï¼Œé€šè¿‡ <code>CountDownLatch</code> å®ç°ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 61 è‡³ 66 è¡Œ ï¼šç›´æ¥åˆ·ç›˜ã€‚æ­¤å¤„æ˜¯ç”±äºå‘é€çš„æ¶ˆæ¯çš„ <code>isWaitStoreMsgOK</code> æœªè®¾ç½®æˆ <code>TRUE</code> ï¼Œå¯¼è‡´æœªèµ°æ‰¹é‡æäº¤ã€‚</li>\n<li>ç¬¬ 73 è‡³ 80 è¡Œ ï¼šæ¯ 10ms æ‰§è¡Œä¸€æ¬¡æ‰¹é‡æäº¤ã€‚å½“ç„¶ï¼Œå¦‚æœ <code>wakeup()</code> æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡æ‰¹é‡æäº¤ã€‚å½“ <code>Broker</code> è®¾ç½®æˆåŒæ­¥è½ç›˜ &amp;&amp; æ¶ˆæ¯ <code>isWaitStoreMsgOK=true</code>ï¼Œæ¶ˆæ¯éœ€è¦ç•¥å¤§äº 10ms æ‰èƒ½å‘é€æˆåŠŸã€‚å½“ç„¶ï¼Œæ€§èƒ½ç›¸å¯¹å¼‚æ­¥è½ç›˜è¾ƒå·®ï¼Œå¯é æ€§æ›´é«˜ï¼Œéœ€è¦æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨æ—¶å»å–èˆã€‚</li>\n</ul>\n<h1>ç»“å°¾</h1>\n<p>å†™çš„ç¬¬äºŒç¯‡ä¸RocketMQæºç ç›¸å…³çš„åšæ–‡ï¼Œçœ‹åˆ°æœ‰é˜…è¯»ã€ç‚¹èµã€æ”¶è—ç”šè‡³è®¢é˜…ï¼Œå¾ˆå—é¼“èˆã€‚</p>\n<p>ã€ŠMessageå­˜å‚¨ã€‹æ¯”èµ·ã€ŠMessageå‘é€&amp;æ¥æ”¶ã€‹ä»éš¾åº¦ä¸Šè¯´æ˜¯æ›´å¤§çš„ï¼Œå½“ç„¶ä¹Ÿæ˜¯æ›´æœ‰è¶£çš„ï¼Œå¦‚æœå­˜åœ¨ç†è§£é”™è¯¯æˆ–è€…è¡¨è¾¾ä¸æ¸…æ™°ï¼Œè¿˜è¯·å¤§å®¶å¤šå¤šåŒ…å«ã€‚å¦‚æœå¯ä»¥çš„è¯ï¼Œè¿˜è¯·éº»çƒ¦æ·»åŠ  QQï¼š7685413 è¿›è¡ŒæŒ‡å‡ºï¼Œé¿å…è‡ªå·±çš„ç†è§£é”™è¯¯ï¼Œç»™å¤§å®¶é€ æˆå›°æ‰°ã€‚</p>\n<p>æ¨è<a href=\"http://www.jasongj.com/kafka/high_throughput/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\" target=\"_blank\" rel=\"external\">ã€ŠKafkaè®¾è®¡è§£æï¼ˆå…­ï¼‰- Kafkaé«˜æ€§èƒ½æ¶æ„ä¹‹é“ã€‹</a>ï¼Œä½œè€…ç«™åœ¨çš„é«˜åº¦æ¯”æˆ‘é«˜çš„å¤šçš„å¤šï¼Œå—¯ï¼ŒæŒ‰ç…§æå°ç’çš„è¯´æ³•ï¼šé«˜ä¸€ä¸ªå–œé©¬æ‹‰é›…å±±ã€‚ğŸ˜ˆè®¤çœŸå•ƒè¯»ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°(åŸä¹¦ç¬¬3ç‰ˆ)ã€‹ï¼Œday day upã€‚</p>\n<p>å†æ¬¡æ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ã€ç‚¹èµã€æ”¶è—ã€‚</p>\n<p>ä¸‹ä¸€ç¯‡ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ã€‹</a> èµ·èˆªï¼</p>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” é«˜å¯ç”¨","date":"2017-05-13T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šé«˜å¯ç”¨](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1009-RocketMQæºç è§£æï¼šé«˜å¯ç”¨.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n- [1. æ¦‚è¿°](#)\n- [2. Namesrv é«˜å¯ç”¨](#)\n\t- [2.1 Broker æ³¨å†Œåˆ° Namesrv](#)\n\t- [2.2 Producerã€Consumer è®¿é—® Namesrv](#)\n- [3. Broker é«˜å¯ç”¨](#)\n\t- [3.2 Broker ä¸»ä»](#)\n\t\t- [3.1.1 é…ç½®](#)\n\t\t- [3.1.2 ç»„ä»¶](#)\n\t\t- [3.1.3 é€šä¿¡åè®®](#)\n\t\t- [3.1.4 Slave](#)\n\t\t- [3.1.5 Master](#)\n\t\t- [3.1.6 Master_SYNC](#)\n\t- [3.2 Producer å‘é€æ¶ˆæ¯](#)\n\t- [3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯](#)\n- [4. æ€»ç»“](#)\n\n# 1. æ¦‚è¿°\n\næœ¬æ–‡ä¸»è¦è§£æ `Namesrv`ã€`Broker` å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Œ`Producer`ã€`Consumer` æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚\n\n# 2. Namesrv é«˜å¯ç”¨\n\n**å¯åŠ¨å¤šä¸ª `Namesrv` å®ç°é«˜å¯ç”¨ã€‚**  \nç›¸è¾ƒäº `Zookeeper`ã€`Consul`ã€`Etcd` ç­‰ï¼Œ`Namesrv` æ˜¯ä¸€ä¸ª**è¶…è½»é‡çº§**çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›**å‘½åæœåŠ¡**ã€‚\n\n## 2.1 Broker æ³¨å†Œåˆ° Namesrv\n\n* ğŸ“Œ **å¤šä¸ª `Namesrv` ä¹‹é—´ï¼Œæ²¡æœ‰ä»»ä½•å…³ç³»ï¼ˆä¸å­˜åœ¨ç±»ä¼¼ `Zookeeper` çš„ `Leader`/`Follower` ç­‰è§’è‰²ï¼‰ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚é€šè¿‡ `Broker` å¾ªç¯æ³¨å†Œå¤šä¸ª `Namesrv`ã€‚**\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€BrokerOuterAPI.javaã€‘\n  2: public RegisterBrokerResult registerBrokerAll(\n  3:     final String clusterName,\n  4:     final String brokerAddr,\n  5:     final String brokerName,\n  6:     final long brokerId,\n  7:     final String haServerAddr,\n  8:     final TopicConfigSerializeWrapper topicConfigWrapper,\n  9:     final List<String> filterServerList,\n 10:     final boolean oneway,\n 11:     final int timeoutMills) {\n 12:     RegisterBrokerResult registerBrokerResult = null;\n 13: \n 14:     List<String> nameServerAddressList = this.remotingClient.getNameServerAddressList();\n 15:     if (nameServerAddressList != null) {\n 16:         for (String namesrvAddr : nameServerAddressList) { // å¾ªç¯å¤šä¸ª Namesrv\n 17:             try {\n 18:                 RegisterBrokerResult result = this.registerBroker(namesrvAddr, clusterName, brokerAddr, brokerName, brokerId,\n 19:                     haServerAddr, topicConfigWrapper, filterServerList, oneway, timeoutMills);\n 20:                 if (result != null) {\n 21:                     registerBrokerResult = result;\n 22:                 }\n 23: \n 24:                 log.info(\"register broker to name server {} OK\", namesrvAddr);\n 25:             } catch (Exception e) {\n 26:                 log.warn(\"registerBroker Exception, {}\", namesrvAddr, e);\n 27:             }\n 28:         }\n 29:     }\n 30: \n 31:     return registerBrokerResult;\n 32: }\n```\n\n## 2.2 Producerã€Consumer è®¿é—® Namesrv\n\n* ğŸ“Œ **`Producer`ã€`Consumer` ä» `Namesrv`åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªå¯è¿æ¥çš„è¿›è¡Œé€šä¿¡ã€‚**\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€NettyRemotingClient.javaã€‘\n  2: private Channel getAndCreateNameserverChannel() throws InterruptedException {\n  3:     // è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥Namesrv\n  4:     String addr = this.namesrvAddrChoosed.get();\n  5:     if (addr != null) {\n  6:         ChannelWrapper cw = this.channelTables.get(addr);\n  7:         if (cw != null && cw.isOK()) {\n  8:             return cw.getChannel();\n  9:         }\n 10:     }\n 11:     //\n 12:     final List<String> addrList = this.namesrvAddrList.get();\n 13:     if (this.lockNamesrvChannel.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) {\n 14:         try {\n 15:             // è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥çš„Namesrv\n 16:             addr = this.namesrvAddrChoosed.get();\n 17:             if (addr != null) {\n 18:                 ChannelWrapper cw = this.channelTables.get(addr);\n 19:                 if (cw != null && cw.isOK()) {\n 20:                     return cw.getChannel();\n 21:                 }\n 22:             }\n 23:             // ä»ã€Namesrvåˆ—è¡¨ã€‘ä¸­é€‰æ‹©ä¸€ä¸ªè¿æ¥çš„è¿”å›\n 24:             if (addrList != null && !addrList.isEmpty()) {\n 25:                 for (int i = 0; i < addrList.size(); i++) {\n 26:                     int index = this.namesrvIndex.incrementAndGet();\n 27:                     index = Math.abs(index);\n 28:                     index = index % addrList.size();\n 29:                     String newAddr = addrList.get(index);\n 30: \n 31:                     this.namesrvAddrChoosed.set(newAddr);\n 32:                     Channel channelNew = this.createChannel(newAddr);\n 33:                     if (channelNew != null)\n 34:                         return channelNew;\n 35:                 }\n 36:             }\n 37:         } catch (Exception e) {\n 38:             log.error(\"getAndCreateNameserverChannel: create name server channel exception\", e);\n 39:         } finally {\n 40:             this.lockNamesrvChannel.unlock();\n 41:         }\n 42:     } else {\n 43:         log.warn(\"getAndCreateNameserverChannel: try to lock name server, but timeout, {}ms\", LOCK_TIMEOUT_MILLIS);\n 44:     }\n 45: \n 46:     return null;\n 47: }\n```\n\n# 3. Broker é«˜å¯ç”¨\n\n**å¯åŠ¨å¤šä¸ª `Brokeråˆ†ç»„` å½¢æˆ `é›†ç¾¤` å®ç°é«˜å¯ç”¨ã€‚**  \n**`Brokeråˆ†ç»„` = `MasterèŠ‚ç‚¹`x1 + `SlaveèŠ‚ç‚¹`xNã€‚**  \nç±»ä¼¼ `MySQL`ï¼Œ`MasterèŠ‚ç‚¹` æä¾›**è¯»å†™**æœåŠ¡ï¼Œ`SlaveèŠ‚ç‚¹` åªæä¾›**è¯»**æœåŠ¡ã€‚  \n\n## 3.2 Broker ä¸»ä»\n\n* **æ¯ä¸ªåˆ†ç»„ï¼Œ`Master`èŠ‚ç‚¹ ä¸æ–­å‘é€æ–°çš„ `CommitLog` ç»™ `Slave`èŠ‚ç‚¹ã€‚ `Slave`èŠ‚ç‚¹ ä¸æ–­ä¸ŠæŠ¥æœ¬åœ°çš„ `CommitLog` å·²ç»åŒæ­¥åˆ°çš„ä½ç½®ç»™ `Master`èŠ‚ç‚¹ã€‚**\n* **`Brokeråˆ†ç»„` ä¸ `Brokeråˆ†ç»„` ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚**\n* **æ¶ˆè´¹è¿›åº¦ ç›®å‰ä¸æ”¯æŒ `Master`/`Slave` åŒæ­¥ã€‚**\n\né›†ç¾¤å†…ï¼Œ`Master`èŠ‚ç‚¹ æœ‰**ä¸¤ç§**ç±»å‹ï¼š`Master_SYNC`ã€`Master_ASYNC`ï¼šå‰è€…åœ¨ `Producer` å‘é€æ¶ˆæ¯æ—¶ï¼Œç­‰å¾… `Slave`èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœï¼Œè€Œåè€…ä¸éœ€è¦ç­‰å¾…ã€‚\n\n\n### 3.1.1 é…ç½®\n\nç›®å‰å®˜æ–¹æä¾›ä¸‰å¥—é…ç½®ï¼š\n\n* **2m-2s-async**\n\n| brokerClusterName| brokerName | brokerRole | brokerId |\n| --- | --- | --- | --- |\n| DefaultCluster | broker-a | ASYNC_MASTER | 0 |\n| DefaultCluster | broker-a | SLAVE | 1 |\n| DefaultCluster | broker-b | ASYNC_MASTER | 0 |\n| DefaultCluster | broker-b | SLAVE | 1 |\n\n* **2m-2s-sync**\n\n| brokerClusterName| brokerName | brokerRole | brokerId |\n| ---| --- | --- | --- |\n| DefaultCluster | broker-a | SYNC_MASTER | 0 |\n| DefaultCluster | broker-a | SLAVE | 1 |\n| DefaultCluster | broker-b | SYNC_MASTER | 0 |\n| DefaultCluster | broker-b | SLAVE | 1 |\n\n* **2m-noslave**\n\n| brokerClusterName| brokerName | brokerRole | brokerId |\n| ---| --- | --- | --- |\n| DefaultCluster | broker-a | ASYNC_MASTER | 0 |\n| DefaultCluster | broker-b | ASYNC_MASTER | 0 |\n\n### 3.1.2 ç»„ä»¶\n\nå†çœ‹å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ `Master`/`Slave`èŠ‚ç‚¹ åŒ…å«çš„ç»„ä»¶ï¼š  \n![HAç»„ä»¶å›¾.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAç»„ä»¶å›¾.png)\n\n* `Master`èŠ‚ç‚¹\n    * `AcceptSocketService` ï¼šæ¥æ”¶ `Slave`èŠ‚ç‚¹ è¿æ¥ã€‚\n    * `HAConnection`\n        * `ReadSocketService` ï¼š**è¯»**æ¥è‡ª `Slave`èŠ‚ç‚¹ çš„æ•°æ®ã€‚ \n        * `WriteSocketService` ï¼š**å†™**åˆ°å¾€ `Slave`èŠ‚ç‚¹ çš„æ•°æ®ã€‚\n* `Slave`èŠ‚ç‚¹\n    * `HAClient` ï¼šå¯¹ `Master`èŠ‚ç‚¹ è¿æ¥ã€è¯»å†™æ•°æ®ã€‚\n\n### 3.1.3 é€šä¿¡åè®®\n\n`Master`èŠ‚ç‚¹ ä¸ `Slave`èŠ‚ç‚¹ **é€šä¿¡åè®®**å¾ˆç®€å•ï¼Œåªæœ‰å¦‚ä¸‹ä¸¤æ¡ã€‚\n\n| å¯¹è±¡ | ç”¨é€” | ç¬¬å‡ ä½ | å­—æ®µ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° | è¯´æ˜\n| :-- | :-- | :-- | :-- | :-- | :-- | :-- |\n| Slave=>Master | ä¸ŠæŠ¥CommitLog**å·²ç»**åŒæ­¥åˆ°çš„**ç‰©ç†**ä½ç½® |  |  |  |  |  |\n|  | | 0 | maxPhyOffset  |  Long | 8 | CommitLogæœ€å¤§ç‰©ç†ä½ç½® |\n| Master=>Slave | ä¼ è¾“æ–°çš„ `CommitLog` æ•°æ® |  |  |  |  |  |\n| | | 0 | fromPhyOffset | Long | 8 | CommitLogå¼€å§‹ç‰©ç†ä½ç½® | \n| | | 1 | size | Int | 4 | ä¼ è¾“CommitLogæ•°æ®é•¿åº¦ | \n| | | 2 | body | Bytes | size | ä¼ è¾“CommitLogæ•°æ® | \n\n### 3.1.4 Slave\n\n![HAClienté¡ºåºå›¾](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAClienté¡ºåºå›¾.png)\n\n-------\n\n* **`Slave` ä¸»å¾ªç¯ï¼Œå®ç°äº†**ä¸æ–­ä¸æ–­ä¸æ–­**ä» `Master` ä¼ è¾“ `CommitLog` æ•°æ®ï¼Œä¸Šä¼  `Master` è‡ªå·±æœ¬åœ°çš„ `CommitLog` å·²ç»åŒæ­¥ç‰©ç†ä½ç½®ã€‚**\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€HAClient.javaã€‘\n  2: public void run() {\n  3:     log.info(this.getServiceName() + \" service started\");\n  4: \n  5:     while (!this.isStopped()) {\n  6:         try {\n  7:             if (this.connectMaster()) {\n  8:                 // è‹¥åˆ°æ»¡è¶³ä¸ŠæŠ¥é—´éš”ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦\n  9:                 if (this.isTimeToReportOffset()) {\n 10:                     boolean result = this.reportSlaveMaxOffset(this.currentReportedOffset);\n 11:                     if (!result) {\n 12:                         this.closeMaster();\n 13:                     }\n 14:                 }\n 15: \n 16:                 this.selector.select(1000);\n 17: \n 18:                 // å¤„ç†è¯»å–äº‹ä»¶\n 19:                 boolean ok = this.processReadEvent();\n 20:                 if (!ok) {\n 21:                     this.closeMaster();\n 22:                 }\n 23: \n 24:                 // è‹¥è¿›åº¦æœ‰å˜åŒ–ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦\n 25:                 if (!reportSlaveMaxOffsetPlus()) {\n 26:                     continue;\n 27:                 }\n 28: \n 29:                 // Masterè¿‡ä¹…æœªè¿”å›æ•°æ®ï¼Œå…³é—­è¿æ¥\n 30:                 long interval = HAService.this.getDefaultMessageStore().getSystemClock().now() - this.lastWriteTimestamp;\n 31:                 if (interval > HAService.this.getDefaultMessageStore().getMessageStoreConfig()\n 32:                     .getHaHousekeepingInterval()) {\n 33:                     log.warn(\"HAClient, housekeeping, found this connection[\" + this.masterAddress\n 34:                         + \"] expired, \" + interval);\n 35:                     this.closeMaster();\n 36:                     log.warn(\"HAClient, master not response some time, so close connection\");\n 37:                 }\n 38:             } else {\n 39:                 this.waitForRunning(1000 * 5);\n 40:             }\n 41:         } catch (Exception e) {\n 42:             log.warn(this.getServiceName() + \" service has exception. \", e);\n 43:             this.waitForRunning(1000 * 5);\n 44:         }\n 45:     }\n 46: \n 47:     log.info(this.getServiceName() + \" service end\");\n 48: }\n```\n\n* ç¬¬ 8 è‡³ 14 è¡Œ ï¼š**å›ºå®šé—´éš”ï¼ˆé»˜è®¤5sï¼‰**å‘ `Master` ä¸ŠæŠ¥ `Slave` æœ¬åœ° `CommitLog` å·²ç»åŒæ­¥åˆ°çš„ç‰©ç†ä½ç½®ã€‚è¯¥æ“ä½œè¿˜æœ‰**å¿ƒè·³**çš„ä½œç”¨ã€‚\n* ç¬¬ 16 è‡³ 22 è¡Œ ï¼šå¤„ç† `Master` ä¼ è¾“ `Slave` çš„ `CommitLog` æ•°æ®ã€‚\n\n-------\n\n* **æˆ‘ä»¬æ¥çœ‹çœ‹ `#dispatchReadRequest(...)` ä¸ `#reportSlaveMaxOffset(...)` æ˜¯æ€ä¹ˆå®ç°çš„ã€‚**\n\n```Java\n  1: // ã€HAClient.javaã€‘\n  2: /**\n  3:  * è¯»å–Masterä¼ è¾“çš„CommitLogæ•°æ®ï¼Œå¹¶è¿”å›æ˜¯å¼‚å¸¸\n  4:  * å¦‚æœè¯»å–åˆ°æ•°æ®ï¼Œå†™å…¥CommitLog\n  5:  * å¼‚å¸¸åŸå› ï¼š\n  6:  *   1. Masterä¼ è¾“æ¥çš„æ•°æ®offset ä¸ç­‰äº Slaveçš„CommitLogæ•°æ®æœ€å¤§offset\n  7:  *   2. ä¸ŠæŠ¥åˆ°Masterè¿›åº¦å¤±è´¥\n  8:  *\n  9:  * @return æ˜¯å¦å¼‚å¸¸\n 10:  */\n 11: private boolean dispatchReadRequest() {\n 12:     final int msgHeaderSize = 8 + 4; // phyoffset + size\n 13:     int readSocketPos = this.byteBufferRead.position();\n 14: \n 15:     while (true) {\n 16:         // è¯»å–åˆ°è¯·æ±‚\n 17:         int diff = this.byteBufferRead.position() - this.dispatchPostion;\n 18:         if (diff >= msgHeaderSize) {\n 19:             // è¯»å–masterPhyOffsetã€bodySizeã€‚ä½¿ç”¨dispatchPostionçš„åŸå› æ˜¯ï¼šå¤„ç†æ•°æ®â€œç²˜åŒ…â€å¯¼è‡´æ•°æ®è¯»å–ä¸å®Œæ•´ã€‚\n 20:             long masterPhyOffset = this.byteBufferRead.getLong(this.dispatchPostion);\n 21:             int bodySize = this.byteBufferRead.getInt(this.dispatchPostion + 8);\n 22:             // æ ¡éªŒ Masterä¼ è¾“æ¥çš„æ•°æ®offset æ˜¯å¦å’Œ Slaveçš„CommitLogæ•°æ®æœ€å¤§offset æ˜¯å¦ç›¸åŒã€‚\n 23:             long slavePhyOffset = HAService.this.defaultMessageStore.getMaxPhyOffset();\n 24:             if (slavePhyOffset != 0) {\n 25:                 if (slavePhyOffset != masterPhyOffset) {\n 26:                     log.error(\"master pushed offset not equal the max phy offset in slave, SLAVE: \"\n 27:                         + slavePhyOffset + \" MASTER: \" + masterPhyOffset);\n 28:                     return false;\n 29:                 }\n 30:             }\n 31:             // è¯»å–åˆ°æ¶ˆæ¯\n 32:             if (diff >= (msgHeaderSize + bodySize)) {\n 33:                 // å†™å…¥CommitLog\n 34:                 byte[] bodyData = new byte[bodySize];\n 35:                 this.byteBufferRead.position(this.dispatchPostion + msgHeaderSize);\n 36:                 this.byteBufferRead.get(bodyData);\n 37:                 HAService.this.defaultMessageStore.appendToCommitLog(masterPhyOffset, bodyData);\n 38:                 // è®¾ç½®å¤„ç†åˆ°çš„ä½ç½®\n 39:                 this.byteBufferRead.position(readSocketPos);\n 40:                 this.dispatchPostion += msgHeaderSize + bodySize;\n 41:                 // ä¸ŠæŠ¥åˆ°Masterè¿›åº¦\n 42:                 if (!reportSlaveMaxOffsetPlus()) {\n 43:                     return false;\n 44:                 }\n 45:                 // ç»§ç»­å¾ªç¯\n 46:                 continue;\n 47:             }\n 48:         }\n 49: \n 50:         // ç©ºé—´å†™æ»¡ï¼Œé‡æ–°åˆ†é…ç©ºé—´\n 51:         if (!this.byteBufferRead.hasRemaining()) {\n 52:             this.reallocateByteBuffer();\n 53:         }\n 54: \n 55:         break;\n 56:     }\n 57: \n 58:     return true;\n 59: }\n 60: \n 61: /**\n 62:  * ä¸ŠæŠ¥è¿›åº¦\n 63:  *\n 64:  * @param maxOffset è¿›åº¦\n 65:  * @return æ˜¯å¦ä¸ŠæŠ¥æˆåŠŸ\n 66:  */\n 67: private boolean reportSlaveMaxOffset(final long maxOffset) {\n 68:     this.reportOffset.position(0);\n 69:     this.reportOffset.limit(8);\n 70:     this.reportOffset.putLong(maxOffset);\n 71:     this.reportOffset.position(0);\n 72:     this.reportOffset.limit(8);\n 73: \n 74:     for (int i = 0; i < 3 && this.reportOffset.hasRemaining(); i++) {\n 75:         try {\n 76:             this.socketChannel.write(this.reportOffset);\n 77:         } catch (IOException e) {\n 78:             log.error(this.getServiceName()\n 79:                 + \"reportSlaveMaxOffset this.socketChannel.write exception\", e);\n 80:             return false;\n 81:         }\n 82:     }\n 83: \n 84:     return !this.reportOffset.hasRemaining();\n 85: }\n```\n\n### 3.1.5 Master\n\n* **`ReadSocketService` é€»è¾‘åŒ `HAClient#processReadEvent(...)` åŸºæœ¬ç›¸åŒï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ã€‚**\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ReadSocketService.javaã€‘\n  2: private boolean processReadEvent() {\n  3:     int readSizeZeroTimes = 0;\n  4: \n  5:     // æ¸…ç©ºbyteBufferRead\n  6:     if (!this.byteBufferRead.hasRemaining()) {\n  7:         this.byteBufferRead.flip();\n  8:         this.processPostion = 0;\n  9:     }\n 10: \n 11:     while (this.byteBufferRead.hasRemaining()) {\n 12:         try {\n 13:             int readSize = this.socketChannel.read(this.byteBufferRead);\n 14:             if (readSize > 0) {\n 15:                 readSizeZeroTimes = 0;\n 16: \n 17:                 // è®¾ç½®æœ€åè¯»å–æ—¶é—´\n 18:                 this.lastReadTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();\n 19: \n 20:                 if ((this.byteBufferRead.position() - this.processPostion) >= 8) {\n 21:                     // è¯»å–Slave è¯·æ±‚æ¥çš„CommitLogçš„æœ€å¤§ä½ç½®\n 22:                     int pos = this.byteBufferRead.position() - (this.byteBufferRead.position() % 8);\n 23:                     long readOffset = this.byteBufferRead.getLong(pos - 8);\n 24:                     this.processPostion = pos;\n 25: \n 26:                     // è®¾ç½®Slave CommitLogçš„æœ€å¤§ä½ç½®\n 27:                     HAConnection.this.slaveAckOffset = readOffset;\n 28: \n 29:                     // è®¾ç½®Slave ç¬¬ä¸€æ¬¡è¯·æ±‚çš„ä½ç½®\n 30:                     if (HAConnection.this.slaveRequestOffset < 0) {\n 31:                         HAConnection.this.slaveRequestOffset = readOffset;\n 32:                         log.info(\"slave[\" + HAConnection.this.clientAddr + \"] request offset \" + readOffset);\n 33:                     }\n 34: \n 35:                     // é€šçŸ¥ç›®å‰Slaveè¿›åº¦ã€‚ä¸»è¦ç”¨äºMasterèŠ‚ç‚¹ä¸ºåŒæ­¥ç±»å‹çš„ã€‚\n 36:                     HAConnection.this.haService.notifyTransferSome(HAConnection.this.slaveAckOffset);\n 37:                 }\n 38:             } else if (readSize == 0) {\n 39:                 if (++readSizeZeroTimes >= 3) {\n 40:                     break;\n 41:                 }\n 42:             } else {\n 43:                 log.error(\"read socket[\" + HAConnection.this.clientAddr + \"] < 0\");\n 44:                 return false;\n 45:             }\n 46:         } catch (IOException e) {\n 47:             log.error(\"processReadEvent exception\", e);\n 48:             return false;\n 49:         }\n 50:     }\n 51: \n 52:     return true;\n 53: }\n```\n\n-------\n\n* **`WriteSocketService` è®¡ç®— `Slave`å¼€å§‹åŒæ­¥çš„ä½ç½®åï¼Œä¸æ–­å‘ `Slave` ä¼ è¾“æ–°çš„ `CommitLog`æ•°æ®ã€‚**\n\n![HA.WriteSocketServiceæµç¨‹å›¾](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HA.WriteSocketServiceæµç¨‹å›¾.png)\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€WriteSocketService.javaã€‘\n  2: @Override\n  3: public void run() {\n  4:     HAConnection.log.info(this.getServiceName() + \" service started\");\n  5: \n  6:     while (!this.isStopped()) {\n  7:         try {\n  8:             this.selector.select(1000);\n  9: \n 10:             // æœªè·å¾—Slaveè¯»å–è¿›åº¦è¯·æ±‚ï¼Œsleepç­‰å¾…ã€‚\n 11:             if (-1 == HAConnection.this.slaveRequestOffset) {\n 12:                 Thread.sleep(10);\n 13:                 continue;\n 14:             }\n 15: \n 16:             // è®¡ç®—åˆå§‹åŒ–nextTransferFromWhere\n 17:             if (-1 == this.nextTransferFromWhere) {\n 18:                 if (0 == HAConnection.this.slaveRequestOffset) {\n 19:                     long masterOffset = HAConnection.this.haService.getDefaultMessageStore().getCommitLog().getMaxOffset();\n 20:                     masterOffset = masterOffset - (masterOffset % HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getMapedFileSizeCommitLog());\n 21:                     if (masterOffset < 0) {\n 22:                         masterOffset = 0;\n 23:                     }\n 24: \n 25:                     this.nextTransferFromWhere = masterOffset;\n 26:                 } else {\n 27:                     this.nextTransferFromWhere = HAConnection.this.slaveRequestOffset;\n 28:                 }\n 29: \n 30:                 log.info(\"master transfer data from \" + this.nextTransferFromWhere + \" to slave[\" + HAConnection.this.clientAddr\n 31:                     + \"], and slave request \" + HAConnection.this.slaveRequestOffset);\n 32:             }\n 33: \n 34:             if (this.lastWriteOver) {\n 35:                 long interval = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now() - this.lastWriteTimestamp;\n 36:                 if (interval > HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaSendHeartbeatInterval()) { // å¿ƒè·³\n 37: \n 38:                     // Build Header\n 39:                     this.byteBufferHeader.position(0);\n 40:                     this.byteBufferHeader.limit(headerSize);\n 41:                     this.byteBufferHeader.putLong(this.nextTransferFromWhere);\n 42:                     this.byteBufferHeader.putInt(0);\n 43:                     this.byteBufferHeader.flip();\n 44: \n 45:                     this.lastWriteOver = this.transferData();\n 46:                     if (!this.lastWriteOver)\n 47:                         continue;\n 48:                 }\n 49:             } else { // æœªä¼ è¾“å®Œæˆï¼Œç»§ç»­ä¼ è¾“\n 50:                 this.lastWriteOver = this.transferData();\n 51:                 if (!this.lastWriteOver)\n 52:                     continue;\n 53:             }\n 54: \n 55:             // é€‰æ‹©æ–°çš„CommitLogæ•°æ®è¿›è¡Œä¼ è¾“\n 56:             SelectMappedBufferResult selectResult =\n 57:                 HAConnection.this.haService.getDefaultMessageStore().getCommitLogData(this.nextTransferFromWhere);\n 58:             if (selectResult != null) {\n 59:                 int size = selectResult.getSize();\n 60:                 if (size > HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize()) {\n 61:                     size = HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize();\n 62:                 }\n 63: \n 64:                 long thisOffset = this.nextTransferFromWhere;\n 65:                 this.nextTransferFromWhere += size;\n 66: \n 67:                 selectResult.getByteBuffer().limit(size);\n 68:                 this.selectMappedBufferResult = selectResult;\n 69: \n 70:                 // Build Header\n 71:                 this.byteBufferHeader.position(0);\n 72:                 this.byteBufferHeader.limit(headerSize);\n 73:                 this.byteBufferHeader.putLong(thisOffset);\n 74:                 this.byteBufferHeader.putInt(size);\n 75:                 this.byteBufferHeader.flip();\n 76: \n 77:                 this.lastWriteOver = this.transferData();\n 78:             } else { // æ²¡æ–°çš„æ¶ˆæ¯ï¼ŒæŒ‚èµ·ç­‰å¾…\n 79:                 HAConnection.this.haService.getWaitNotifyObject().allWaitForRunning(100);\n 80:             }\n 81:         } catch (Exception e) {\n 82: \n 83:             HAConnection.log.error(this.getServiceName() + \" service has exception.\", e);\n 84:             break;\n 85:         }\n 86:     }\n 87: \n 88:     // æ–­å¼€è¿æ¥ & æš‚åœå†™çº¿ç¨‹ & æš‚åœè¯»çº¿ç¨‹ & é‡Šæ”¾CommitLog\n 89:     if (this.selectMappedBufferResult != null) {\n 90:         this.selectMappedBufferResult.release();\n 91:     }\n 92: \n 93:     this.makeStop();\n 94: \n 95:     readSocketService.makeStop();\n 96: \n 97:     haService.removeConnection(HAConnection.this);\n 98: \n 99:     SelectionKey sk = this.socketChannel.keyFor(this.selector);\n100:     if (sk != null) {\n101:         sk.cancel();\n102:     }\n103: \n104:     try {\n105:         this.selector.close();\n106:         this.socketChannel.close();\n107:     } catch (IOException e) {\n108:         HAConnection.log.error(\"\", e);\n109:     }\n110: \n111:     HAConnection.log.info(this.getServiceName() + \" service end\");\n112: }\n113: \n114: /**\n115:  * ä¼ è¾“æ•°æ®\n116:  */\n117: private boolean transferData() throws Exception {\n118:     int writeSizeZeroTimes = 0;\n119:     // Write Header\n120:     while (this.byteBufferHeader.hasRemaining()) {\n121:         int writeSize = this.socketChannel.write(this.byteBufferHeader);\n122:         if (writeSize > 0) {\n123:             writeSizeZeroTimes = 0;\n124:             this.lastWriteTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();\n125:         } else if (writeSize == 0) {\n126:             if (++writeSizeZeroTimes >= 3) {\n127:                 break;\n128:             }\n129:         } else {\n130:             throw new Exception(\"ha master write header error < 0\");\n131:         }\n132:     }\n133: \n134:     if (null == this.selectMappedBufferResult) {\n135:         return !this.byteBufferHeader.hasRemaining();\n136:     }\n137: \n138:     writeSizeZeroTimes = 0;\n139: \n140:     // Write Body\n141:     if (!this.byteBufferHeader.hasRemaining()) {\n142:         while (this.selectMappedBufferResult.getByteBuffer().hasRemaining()) {\n143:             int writeSize = this.socketChannel.write(this.selectMappedBufferResult.getByteBuffer());\n144:             if (writeSize > 0) {\n145:                 writeSizeZeroTimes = 0;\n146:                 this.lastWriteTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();\n147:             } else if (writeSize == 0) {\n148:                 if (++writeSizeZeroTimes >= 3) {\n149:                     break;\n150:                 }\n151:             } else {\n152:                 throw new Exception(\"ha master write body error < 0\");\n153:             }\n154:         }\n155:     }\n156: \n157:     boolean result = !this.byteBufferHeader.hasRemaining() && !this.selectMappedBufferResult.getByteBuffer().hasRemaining();\n158: \n159:     if (!this.selectMappedBufferResult.getByteBuffer().hasRemaining()) {\n160:         this.selectMappedBufferResult.release();\n161:         this.selectMappedBufferResult = null;\n162:     }\n163: \n164:     return result;\n165: }\n```\n\n### 3.1.6 Master_SYNC\n\n* **`Producer` å‘é€æ¶ˆæ¯æ—¶ï¼Œ`Master_SYNC`èŠ‚ç‚¹ ä¼šç­‰å¾… `Slave`èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœã€‚**\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘\n  2: public PutMessageResult putMessage(final MessageExtBrokerInner msg) {\n  3:     // ....çœç•¥å¤„ç†å‘é€ä»£ç  \n  4:     // Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹\n  5:     if (BrokerRole.SYNC_MASTER == this.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) {\n  6:         HAService service = this.defaultMessageStore.getHaService();\n  7:         if (msg.isWaitStoreMsgOK()) {\n  8:             // Determine whether to wait\n  9:             if (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) {\n 10:                 if (null == request) {\n 11:                     request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());\n 12:                 }\n 13:                 service.putRequest(request);\n 14: \n 15:                 // å”¤é†’WriteSocketService\n 16:                 service.getWaitNotifyObject().wakeupAll();\n 17: \n 18:                 boolean flushOK = request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());\n 19:                 if (!flushOK) {\n 20:                     log.error(\"do sync transfer other node, wait return, but failed, topic: \" + msg.getTopic() + \" tags: \"\n 21:                         + msg.getTags() + \" client address: \" + msg.getBornHostString());\n 22:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);\n 23:                 }\n 24:             }\n 25:             // Slave problem\n 26:             else {\n 27:                 // Tell the producer, slave not available\n 28:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);\n 29:             }\n 30:         }\n 31:     }\n 32: \n 33:     return putMessageResult;\n 34: }\n```\n\n* ç¬¬ 16 è¡Œ ï¼šå”¤é†’ `WriteSocketService`ã€‚\n    * å”¤é†’åï¼Œ`WriteSocketService` æŒ‚èµ·ç­‰å¾…æ–°æ¶ˆæ¯ç»“æŸï¼Œ`Master` ä¼ è¾“ `Slave` æ–°çš„ `CommitLog` æ•°æ®ã€‚\n    * `Slave` æ”¶åˆ°æ•°æ®åï¼Œ**ç«‹å³**ä¸ŠæŠ¥æœ€æ–°çš„ `CommitLog` åŒæ­¥è¿›åº¦åˆ° `Master`ã€‚`ReadSocketService` å”¤é†’**ç¬¬ 18 è¡Œ**ï¼š`request#waitForFlush(...)`ã€‚\n\næˆ‘ä»¬æ¥çœ‹ä¸‹ `GroupTransferService` çš„æ ¸å¿ƒé€»è¾‘ä»£ç ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€GroupTransferService.javaã€‘\n  2: private void doWaitTransfer() {\n  3:     synchronized (this.requestsRead) {\n  4:         if (!this.requestsRead.isEmpty()) {\n  5:             for (CommitLog.GroupCommitRequest req : this.requestsRead) {\n  6:                 // ç­‰å¾…Slaveä¸Šä¼ è¿›åº¦\n  7:                 boolean transferOK = HAService.this.push2SlaveMaxOffset.get() >= req.getNextOffset();\n  8:                 for (int i = 0; !transferOK && i < 5; i++) {\n  9:                     this.notifyTransferObject.waitForRunning(1000); // å”¤é†’\n 10:                     transferOK = HAService.this.push2SlaveMaxOffset.get() >= req.getNextOffset();\n 11:                 }\n 12: \n 13:                 if (!transferOK) {\n 14:                     log.warn(\"transfer messsage to slave timeout, \" + req.getNextOffset());\n 15:                 }\n 16: \n 17:                 // å”¤é†’è¯·æ±‚ï¼Œå¹¶è®¾ç½®æ˜¯å¦SlaveåŒæ­¥æˆåŠŸ\n 18:                 req.wakeupCustomer(transferOK);\n 19:             }\n 20: \n 21:             this.requestsRead.clear();\n 22:         }\n 23:     }\n 24: }\n```\n\n## 3.2 Producer å‘é€æ¶ˆæ¯\n\n* **`Producer` å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ `Broker`é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚**\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘\n  2: private SendResult sendDefaultImpl(//\n  3:     Message msg, //\n  4:     final CommunicationMode communicationMode, //\n  5:     final SendCallback sendCallback, //\n  6:     final long timeout//\n  7: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  8:     // .... çœç•¥ï¼šå¤„ç†ã€æ ¡éªŒé€»è¾‘ã€‘\n  9:     // è·å– Topicè·¯ç”±ä¿¡æ¯\n 10:     TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());\n 11:     if (topicPublishInfo != null && topicPublishInfo.ok()) {\n 12:         MessageQueue mq = null; // æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—\n 13:         Exception exception = null;\n 14:         SendResult sendResult = null; // æœ€åä¸€æ¬¡å‘é€ç»“æœ\n 15:         int timesTotal = communicationMode == CommunicationMode.SYNC ? 1 + this.defaultMQProducer.getRetryTimesWhenSendFailed() : 1; // åŒæ­¥å¤šæ¬¡è°ƒç”¨\n 16:         int times = 0; // ç¬¬å‡ æ¬¡å‘é€\n 17:         String[] brokersSent = new String[timesTotal]; // å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå\n 18:         // å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ\n 19:         for (; times < timesTotal; times++) {\n 20:             String lastBrokerName = null == mq ? null : mq.getBrokerName();\n 21:             MessageQueue tmpmq = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName); // é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—\n 22:             if (tmpmq != null) {\n 23:                 mq = tmpmq;\n 24:                 brokersSent[times] = mq.getBrokerName();\n 25:                 try {\n 26:                     beginTimestampPrev = System.currentTimeMillis();\n 27:                     // è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•\n 28:                     sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);\n 29:                     endTimestamp = System.currentTimeMillis();\n 30:                     // æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯\n 31:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);\n 32:                     // .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘\n 33:                     }\n 34:                 } catch (e) { // .... çœç•¥ï¼šå¤„ç†ã€å¼‚å¸¸ã€‘\n 35:                     \n 36:                 }\n 37:             } else {\n 38:                 break;\n 39:             }\n 40:         }\n 41:         // .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘\n 42:     }\n 43:     // .... çœç•¥ï¼šå¤„ç†ã€æ‰¾ä¸åˆ°æ¶ˆæ¯è·¯ç”±ã€‘\n 44: }\n```\n\nå¦‚ä¸‹æ˜¯è°ƒè¯• `#sendDefaultImpl(...)` æ—¶ `TopicPublishInfo` çš„ç»“æœï¼Œ`Producer` è·å¾—åˆ°äº† `broker-a`,`broker-b` ä¸¤ä¸ª `Broker`åˆ†ç»„ çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š\n![Producer.TopicPublishInfo.è°ƒè¯•.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/Producer.TopicPublishInfo.è°ƒè¯•.png)\n\n## 3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯\n\n* **`Consumer` æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ `Broker`é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚**\n\n# 4. æ€»ç»“\n\n![HAæ€»ç»“.jpeg](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAæ€»ç»“.jpeg)\n\n\n","source":"_posts/RocketMQ/2017_05_14_RocketMQæºç åˆ†æâ€”â€”é«˜å¯ç”¨.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” é«˜å¯ç”¨\ndate: 2017-05-14\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/high-availability\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šé«˜å¯ç”¨](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1009-RocketMQæºç è§£æï¼šé«˜å¯ç”¨.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n- [1. æ¦‚è¿°](#)\n- [2. Namesrv é«˜å¯ç”¨](#)\n\t- [2.1 Broker æ³¨å†Œåˆ° Namesrv](#)\n\t- [2.2 Producerã€Consumer è®¿é—® Namesrv](#)\n- [3. Broker é«˜å¯ç”¨](#)\n\t- [3.2 Broker ä¸»ä»](#)\n\t\t- [3.1.1 é…ç½®](#)\n\t\t- [3.1.2 ç»„ä»¶](#)\n\t\t- [3.1.3 é€šä¿¡åè®®](#)\n\t\t- [3.1.4 Slave](#)\n\t\t- [3.1.5 Master](#)\n\t\t- [3.1.6 Master_SYNC](#)\n\t- [3.2 Producer å‘é€æ¶ˆæ¯](#)\n\t- [3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯](#)\n- [4. æ€»ç»“](#)\n\n# 1. æ¦‚è¿°\n\næœ¬æ–‡ä¸»è¦è§£æ `Namesrv`ã€`Broker` å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Œ`Producer`ã€`Consumer` æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚\n\n# 2. Namesrv é«˜å¯ç”¨\n\n**å¯åŠ¨å¤šä¸ª `Namesrv` å®ç°é«˜å¯ç”¨ã€‚**  \nç›¸è¾ƒäº `Zookeeper`ã€`Consul`ã€`Etcd` ç­‰ï¼Œ`Namesrv` æ˜¯ä¸€ä¸ª**è¶…è½»é‡çº§**çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›**å‘½åæœåŠ¡**ã€‚\n\n## 2.1 Broker æ³¨å†Œåˆ° Namesrv\n\n* ğŸ“Œ **å¤šä¸ª `Namesrv` ä¹‹é—´ï¼Œæ²¡æœ‰ä»»ä½•å…³ç³»ï¼ˆä¸å­˜åœ¨ç±»ä¼¼ `Zookeeper` çš„ `Leader`/`Follower` ç­‰è§’è‰²ï¼‰ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚é€šè¿‡ `Broker` å¾ªç¯æ³¨å†Œå¤šä¸ª `Namesrv`ã€‚**\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€BrokerOuterAPI.javaã€‘\n  2: public RegisterBrokerResult registerBrokerAll(\n  3:     final String clusterName,\n  4:     final String brokerAddr,\n  5:     final String brokerName,\n  6:     final long brokerId,\n  7:     final String haServerAddr,\n  8:     final TopicConfigSerializeWrapper topicConfigWrapper,\n  9:     final List<String> filterServerList,\n 10:     final boolean oneway,\n 11:     final int timeoutMills) {\n 12:     RegisterBrokerResult registerBrokerResult = null;\n 13: \n 14:     List<String> nameServerAddressList = this.remotingClient.getNameServerAddressList();\n 15:     if (nameServerAddressList != null) {\n 16:         for (String namesrvAddr : nameServerAddressList) { // å¾ªç¯å¤šä¸ª Namesrv\n 17:             try {\n 18:                 RegisterBrokerResult result = this.registerBroker(namesrvAddr, clusterName, brokerAddr, brokerName, brokerId,\n 19:                     haServerAddr, topicConfigWrapper, filterServerList, oneway, timeoutMills);\n 20:                 if (result != null) {\n 21:                     registerBrokerResult = result;\n 22:                 }\n 23: \n 24:                 log.info(\"register broker to name server {} OK\", namesrvAddr);\n 25:             } catch (Exception e) {\n 26:                 log.warn(\"registerBroker Exception, {}\", namesrvAddr, e);\n 27:             }\n 28:         }\n 29:     }\n 30: \n 31:     return registerBrokerResult;\n 32: }\n```\n\n## 2.2 Producerã€Consumer è®¿é—® Namesrv\n\n* ğŸ“Œ **`Producer`ã€`Consumer` ä» `Namesrv`åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªå¯è¿æ¥çš„è¿›è¡Œé€šä¿¡ã€‚**\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€NettyRemotingClient.javaã€‘\n  2: private Channel getAndCreateNameserverChannel() throws InterruptedException {\n  3:     // è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥Namesrv\n  4:     String addr = this.namesrvAddrChoosed.get();\n  5:     if (addr != null) {\n  6:         ChannelWrapper cw = this.channelTables.get(addr);\n  7:         if (cw != null && cw.isOK()) {\n  8:             return cw.getChannel();\n  9:         }\n 10:     }\n 11:     //\n 12:     final List<String> addrList = this.namesrvAddrList.get();\n 13:     if (this.lockNamesrvChannel.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) {\n 14:         try {\n 15:             // è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥çš„Namesrv\n 16:             addr = this.namesrvAddrChoosed.get();\n 17:             if (addr != null) {\n 18:                 ChannelWrapper cw = this.channelTables.get(addr);\n 19:                 if (cw != null && cw.isOK()) {\n 20:                     return cw.getChannel();\n 21:                 }\n 22:             }\n 23:             // ä»ã€Namesrvåˆ—è¡¨ã€‘ä¸­é€‰æ‹©ä¸€ä¸ªè¿æ¥çš„è¿”å›\n 24:             if (addrList != null && !addrList.isEmpty()) {\n 25:                 for (int i = 0; i < addrList.size(); i++) {\n 26:                     int index = this.namesrvIndex.incrementAndGet();\n 27:                     index = Math.abs(index);\n 28:                     index = index % addrList.size();\n 29:                     String newAddr = addrList.get(index);\n 30: \n 31:                     this.namesrvAddrChoosed.set(newAddr);\n 32:                     Channel channelNew = this.createChannel(newAddr);\n 33:                     if (channelNew != null)\n 34:                         return channelNew;\n 35:                 }\n 36:             }\n 37:         } catch (Exception e) {\n 38:             log.error(\"getAndCreateNameserverChannel: create name server channel exception\", e);\n 39:         } finally {\n 40:             this.lockNamesrvChannel.unlock();\n 41:         }\n 42:     } else {\n 43:         log.warn(\"getAndCreateNameserverChannel: try to lock name server, but timeout, {}ms\", LOCK_TIMEOUT_MILLIS);\n 44:     }\n 45: \n 46:     return null;\n 47: }\n```\n\n# 3. Broker é«˜å¯ç”¨\n\n**å¯åŠ¨å¤šä¸ª `Brokeråˆ†ç»„` å½¢æˆ `é›†ç¾¤` å®ç°é«˜å¯ç”¨ã€‚**  \n**`Brokeråˆ†ç»„` = `MasterèŠ‚ç‚¹`x1 + `SlaveèŠ‚ç‚¹`xNã€‚**  \nç±»ä¼¼ `MySQL`ï¼Œ`MasterèŠ‚ç‚¹` æä¾›**è¯»å†™**æœåŠ¡ï¼Œ`SlaveèŠ‚ç‚¹` åªæä¾›**è¯»**æœåŠ¡ã€‚  \n\n## 3.2 Broker ä¸»ä»\n\n* **æ¯ä¸ªåˆ†ç»„ï¼Œ`Master`èŠ‚ç‚¹ ä¸æ–­å‘é€æ–°çš„ `CommitLog` ç»™ `Slave`èŠ‚ç‚¹ã€‚ `Slave`èŠ‚ç‚¹ ä¸æ–­ä¸ŠæŠ¥æœ¬åœ°çš„ `CommitLog` å·²ç»åŒæ­¥åˆ°çš„ä½ç½®ç»™ `Master`èŠ‚ç‚¹ã€‚**\n* **`Brokeråˆ†ç»„` ä¸ `Brokeråˆ†ç»„` ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚**\n* **æ¶ˆè´¹è¿›åº¦ ç›®å‰ä¸æ”¯æŒ `Master`/`Slave` åŒæ­¥ã€‚**\n\né›†ç¾¤å†…ï¼Œ`Master`èŠ‚ç‚¹ æœ‰**ä¸¤ç§**ç±»å‹ï¼š`Master_SYNC`ã€`Master_ASYNC`ï¼šå‰è€…åœ¨ `Producer` å‘é€æ¶ˆæ¯æ—¶ï¼Œç­‰å¾… `Slave`èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœï¼Œè€Œåè€…ä¸éœ€è¦ç­‰å¾…ã€‚\n\n\n### 3.1.1 é…ç½®\n\nç›®å‰å®˜æ–¹æä¾›ä¸‰å¥—é…ç½®ï¼š\n\n* **2m-2s-async**\n\n| brokerClusterName| brokerName | brokerRole | brokerId |\n| --- | --- | --- | --- |\n| DefaultCluster | broker-a | ASYNC_MASTER | 0 |\n| DefaultCluster | broker-a | SLAVE | 1 |\n| DefaultCluster | broker-b | ASYNC_MASTER | 0 |\n| DefaultCluster | broker-b | SLAVE | 1 |\n\n* **2m-2s-sync**\n\n| brokerClusterName| brokerName | brokerRole | brokerId |\n| ---| --- | --- | --- |\n| DefaultCluster | broker-a | SYNC_MASTER | 0 |\n| DefaultCluster | broker-a | SLAVE | 1 |\n| DefaultCluster | broker-b | SYNC_MASTER | 0 |\n| DefaultCluster | broker-b | SLAVE | 1 |\n\n* **2m-noslave**\n\n| brokerClusterName| brokerName | brokerRole | brokerId |\n| ---| --- | --- | --- |\n| DefaultCluster | broker-a | ASYNC_MASTER | 0 |\n| DefaultCluster | broker-b | ASYNC_MASTER | 0 |\n\n### 3.1.2 ç»„ä»¶\n\nå†çœ‹å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ `Master`/`Slave`èŠ‚ç‚¹ åŒ…å«çš„ç»„ä»¶ï¼š  \n![HAç»„ä»¶å›¾.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAç»„ä»¶å›¾.png)\n\n* `Master`èŠ‚ç‚¹\n    * `AcceptSocketService` ï¼šæ¥æ”¶ `Slave`èŠ‚ç‚¹ è¿æ¥ã€‚\n    * `HAConnection`\n        * `ReadSocketService` ï¼š**è¯»**æ¥è‡ª `Slave`èŠ‚ç‚¹ çš„æ•°æ®ã€‚ \n        * `WriteSocketService` ï¼š**å†™**åˆ°å¾€ `Slave`èŠ‚ç‚¹ çš„æ•°æ®ã€‚\n* `Slave`èŠ‚ç‚¹\n    * `HAClient` ï¼šå¯¹ `Master`èŠ‚ç‚¹ è¿æ¥ã€è¯»å†™æ•°æ®ã€‚\n\n### 3.1.3 é€šä¿¡åè®®\n\n`Master`èŠ‚ç‚¹ ä¸ `Slave`èŠ‚ç‚¹ **é€šä¿¡åè®®**å¾ˆç®€å•ï¼Œåªæœ‰å¦‚ä¸‹ä¸¤æ¡ã€‚\n\n| å¯¹è±¡ | ç”¨é€” | ç¬¬å‡ ä½ | å­—æ®µ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° | è¯´æ˜\n| :-- | :-- | :-- | :-- | :-- | :-- | :-- |\n| Slave=>Master | ä¸ŠæŠ¥CommitLog**å·²ç»**åŒæ­¥åˆ°çš„**ç‰©ç†**ä½ç½® |  |  |  |  |  |\n|  | | 0 | maxPhyOffset  |  Long | 8 | CommitLogæœ€å¤§ç‰©ç†ä½ç½® |\n| Master=>Slave | ä¼ è¾“æ–°çš„ `CommitLog` æ•°æ® |  |  |  |  |  |\n| | | 0 | fromPhyOffset | Long | 8 | CommitLogå¼€å§‹ç‰©ç†ä½ç½® | \n| | | 1 | size | Int | 4 | ä¼ è¾“CommitLogæ•°æ®é•¿åº¦ | \n| | | 2 | body | Bytes | size | ä¼ è¾“CommitLogæ•°æ® | \n\n### 3.1.4 Slave\n\n![HAClienté¡ºåºå›¾](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAClienté¡ºåºå›¾.png)\n\n-------\n\n* **`Slave` ä¸»å¾ªç¯ï¼Œå®ç°äº†**ä¸æ–­ä¸æ–­ä¸æ–­**ä» `Master` ä¼ è¾“ `CommitLog` æ•°æ®ï¼Œä¸Šä¼  `Master` è‡ªå·±æœ¬åœ°çš„ `CommitLog` å·²ç»åŒæ­¥ç‰©ç†ä½ç½®ã€‚**\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€HAClient.javaã€‘\n  2: public void run() {\n  3:     log.info(this.getServiceName() + \" service started\");\n  4: \n  5:     while (!this.isStopped()) {\n  6:         try {\n  7:             if (this.connectMaster()) {\n  8:                 // è‹¥åˆ°æ»¡è¶³ä¸ŠæŠ¥é—´éš”ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦\n  9:                 if (this.isTimeToReportOffset()) {\n 10:                     boolean result = this.reportSlaveMaxOffset(this.currentReportedOffset);\n 11:                     if (!result) {\n 12:                         this.closeMaster();\n 13:                     }\n 14:                 }\n 15: \n 16:                 this.selector.select(1000);\n 17: \n 18:                 // å¤„ç†è¯»å–äº‹ä»¶\n 19:                 boolean ok = this.processReadEvent();\n 20:                 if (!ok) {\n 21:                     this.closeMaster();\n 22:                 }\n 23: \n 24:                 // è‹¥è¿›åº¦æœ‰å˜åŒ–ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦\n 25:                 if (!reportSlaveMaxOffsetPlus()) {\n 26:                     continue;\n 27:                 }\n 28: \n 29:                 // Masterè¿‡ä¹…æœªè¿”å›æ•°æ®ï¼Œå…³é—­è¿æ¥\n 30:                 long interval = HAService.this.getDefaultMessageStore().getSystemClock().now() - this.lastWriteTimestamp;\n 31:                 if (interval > HAService.this.getDefaultMessageStore().getMessageStoreConfig()\n 32:                     .getHaHousekeepingInterval()) {\n 33:                     log.warn(\"HAClient, housekeeping, found this connection[\" + this.masterAddress\n 34:                         + \"] expired, \" + interval);\n 35:                     this.closeMaster();\n 36:                     log.warn(\"HAClient, master not response some time, so close connection\");\n 37:                 }\n 38:             } else {\n 39:                 this.waitForRunning(1000 * 5);\n 40:             }\n 41:         } catch (Exception e) {\n 42:             log.warn(this.getServiceName() + \" service has exception. \", e);\n 43:             this.waitForRunning(1000 * 5);\n 44:         }\n 45:     }\n 46: \n 47:     log.info(this.getServiceName() + \" service end\");\n 48: }\n```\n\n* ç¬¬ 8 è‡³ 14 è¡Œ ï¼š**å›ºå®šé—´éš”ï¼ˆé»˜è®¤5sï¼‰**å‘ `Master` ä¸ŠæŠ¥ `Slave` æœ¬åœ° `CommitLog` å·²ç»åŒæ­¥åˆ°çš„ç‰©ç†ä½ç½®ã€‚è¯¥æ“ä½œè¿˜æœ‰**å¿ƒè·³**çš„ä½œç”¨ã€‚\n* ç¬¬ 16 è‡³ 22 è¡Œ ï¼šå¤„ç† `Master` ä¼ è¾“ `Slave` çš„ `CommitLog` æ•°æ®ã€‚\n\n-------\n\n* **æˆ‘ä»¬æ¥çœ‹çœ‹ `#dispatchReadRequest(...)` ä¸ `#reportSlaveMaxOffset(...)` æ˜¯æ€ä¹ˆå®ç°çš„ã€‚**\n\n```Java\n  1: // ã€HAClient.javaã€‘\n  2: /**\n  3:  * è¯»å–Masterä¼ è¾“çš„CommitLogæ•°æ®ï¼Œå¹¶è¿”å›æ˜¯å¼‚å¸¸\n  4:  * å¦‚æœè¯»å–åˆ°æ•°æ®ï¼Œå†™å…¥CommitLog\n  5:  * å¼‚å¸¸åŸå› ï¼š\n  6:  *   1. Masterä¼ è¾“æ¥çš„æ•°æ®offset ä¸ç­‰äº Slaveçš„CommitLogæ•°æ®æœ€å¤§offset\n  7:  *   2. ä¸ŠæŠ¥åˆ°Masterè¿›åº¦å¤±è´¥\n  8:  *\n  9:  * @return æ˜¯å¦å¼‚å¸¸\n 10:  */\n 11: private boolean dispatchReadRequest() {\n 12:     final int msgHeaderSize = 8 + 4; // phyoffset + size\n 13:     int readSocketPos = this.byteBufferRead.position();\n 14: \n 15:     while (true) {\n 16:         // è¯»å–åˆ°è¯·æ±‚\n 17:         int diff = this.byteBufferRead.position() - this.dispatchPostion;\n 18:         if (diff >= msgHeaderSize) {\n 19:             // è¯»å–masterPhyOffsetã€bodySizeã€‚ä½¿ç”¨dispatchPostionçš„åŸå› æ˜¯ï¼šå¤„ç†æ•°æ®â€œç²˜åŒ…â€å¯¼è‡´æ•°æ®è¯»å–ä¸å®Œæ•´ã€‚\n 20:             long masterPhyOffset = this.byteBufferRead.getLong(this.dispatchPostion);\n 21:             int bodySize = this.byteBufferRead.getInt(this.dispatchPostion + 8);\n 22:             // æ ¡éªŒ Masterä¼ è¾“æ¥çš„æ•°æ®offset æ˜¯å¦å’Œ Slaveçš„CommitLogæ•°æ®æœ€å¤§offset æ˜¯å¦ç›¸åŒã€‚\n 23:             long slavePhyOffset = HAService.this.defaultMessageStore.getMaxPhyOffset();\n 24:             if (slavePhyOffset != 0) {\n 25:                 if (slavePhyOffset != masterPhyOffset) {\n 26:                     log.error(\"master pushed offset not equal the max phy offset in slave, SLAVE: \"\n 27:                         + slavePhyOffset + \" MASTER: \" + masterPhyOffset);\n 28:                     return false;\n 29:                 }\n 30:             }\n 31:             // è¯»å–åˆ°æ¶ˆæ¯\n 32:             if (diff >= (msgHeaderSize + bodySize)) {\n 33:                 // å†™å…¥CommitLog\n 34:                 byte[] bodyData = new byte[bodySize];\n 35:                 this.byteBufferRead.position(this.dispatchPostion + msgHeaderSize);\n 36:                 this.byteBufferRead.get(bodyData);\n 37:                 HAService.this.defaultMessageStore.appendToCommitLog(masterPhyOffset, bodyData);\n 38:                 // è®¾ç½®å¤„ç†åˆ°çš„ä½ç½®\n 39:                 this.byteBufferRead.position(readSocketPos);\n 40:                 this.dispatchPostion += msgHeaderSize + bodySize;\n 41:                 // ä¸ŠæŠ¥åˆ°Masterè¿›åº¦\n 42:                 if (!reportSlaveMaxOffsetPlus()) {\n 43:                     return false;\n 44:                 }\n 45:                 // ç»§ç»­å¾ªç¯\n 46:                 continue;\n 47:             }\n 48:         }\n 49: \n 50:         // ç©ºé—´å†™æ»¡ï¼Œé‡æ–°åˆ†é…ç©ºé—´\n 51:         if (!this.byteBufferRead.hasRemaining()) {\n 52:             this.reallocateByteBuffer();\n 53:         }\n 54: \n 55:         break;\n 56:     }\n 57: \n 58:     return true;\n 59: }\n 60: \n 61: /**\n 62:  * ä¸ŠæŠ¥è¿›åº¦\n 63:  *\n 64:  * @param maxOffset è¿›åº¦\n 65:  * @return æ˜¯å¦ä¸ŠæŠ¥æˆåŠŸ\n 66:  */\n 67: private boolean reportSlaveMaxOffset(final long maxOffset) {\n 68:     this.reportOffset.position(0);\n 69:     this.reportOffset.limit(8);\n 70:     this.reportOffset.putLong(maxOffset);\n 71:     this.reportOffset.position(0);\n 72:     this.reportOffset.limit(8);\n 73: \n 74:     for (int i = 0; i < 3 && this.reportOffset.hasRemaining(); i++) {\n 75:         try {\n 76:             this.socketChannel.write(this.reportOffset);\n 77:         } catch (IOException e) {\n 78:             log.error(this.getServiceName()\n 79:                 + \"reportSlaveMaxOffset this.socketChannel.write exception\", e);\n 80:             return false;\n 81:         }\n 82:     }\n 83: \n 84:     return !this.reportOffset.hasRemaining();\n 85: }\n```\n\n### 3.1.5 Master\n\n* **`ReadSocketService` é€»è¾‘åŒ `HAClient#processReadEvent(...)` åŸºæœ¬ç›¸åŒï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ã€‚**\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ReadSocketService.javaã€‘\n  2: private boolean processReadEvent() {\n  3:     int readSizeZeroTimes = 0;\n  4: \n  5:     // æ¸…ç©ºbyteBufferRead\n  6:     if (!this.byteBufferRead.hasRemaining()) {\n  7:         this.byteBufferRead.flip();\n  8:         this.processPostion = 0;\n  9:     }\n 10: \n 11:     while (this.byteBufferRead.hasRemaining()) {\n 12:         try {\n 13:             int readSize = this.socketChannel.read(this.byteBufferRead);\n 14:             if (readSize > 0) {\n 15:                 readSizeZeroTimes = 0;\n 16: \n 17:                 // è®¾ç½®æœ€åè¯»å–æ—¶é—´\n 18:                 this.lastReadTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();\n 19: \n 20:                 if ((this.byteBufferRead.position() - this.processPostion) >= 8) {\n 21:                     // è¯»å–Slave è¯·æ±‚æ¥çš„CommitLogçš„æœ€å¤§ä½ç½®\n 22:                     int pos = this.byteBufferRead.position() - (this.byteBufferRead.position() % 8);\n 23:                     long readOffset = this.byteBufferRead.getLong(pos - 8);\n 24:                     this.processPostion = pos;\n 25: \n 26:                     // è®¾ç½®Slave CommitLogçš„æœ€å¤§ä½ç½®\n 27:                     HAConnection.this.slaveAckOffset = readOffset;\n 28: \n 29:                     // è®¾ç½®Slave ç¬¬ä¸€æ¬¡è¯·æ±‚çš„ä½ç½®\n 30:                     if (HAConnection.this.slaveRequestOffset < 0) {\n 31:                         HAConnection.this.slaveRequestOffset = readOffset;\n 32:                         log.info(\"slave[\" + HAConnection.this.clientAddr + \"] request offset \" + readOffset);\n 33:                     }\n 34: \n 35:                     // é€šçŸ¥ç›®å‰Slaveè¿›åº¦ã€‚ä¸»è¦ç”¨äºMasterèŠ‚ç‚¹ä¸ºåŒæ­¥ç±»å‹çš„ã€‚\n 36:                     HAConnection.this.haService.notifyTransferSome(HAConnection.this.slaveAckOffset);\n 37:                 }\n 38:             } else if (readSize == 0) {\n 39:                 if (++readSizeZeroTimes >= 3) {\n 40:                     break;\n 41:                 }\n 42:             } else {\n 43:                 log.error(\"read socket[\" + HAConnection.this.clientAddr + \"] < 0\");\n 44:                 return false;\n 45:             }\n 46:         } catch (IOException e) {\n 47:             log.error(\"processReadEvent exception\", e);\n 48:             return false;\n 49:         }\n 50:     }\n 51: \n 52:     return true;\n 53: }\n```\n\n-------\n\n* **`WriteSocketService` è®¡ç®— `Slave`å¼€å§‹åŒæ­¥çš„ä½ç½®åï¼Œä¸æ–­å‘ `Slave` ä¼ è¾“æ–°çš„ `CommitLog`æ•°æ®ã€‚**\n\n![HA.WriteSocketServiceæµç¨‹å›¾](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HA.WriteSocketServiceæµç¨‹å›¾.png)\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€WriteSocketService.javaã€‘\n  2: @Override\n  3: public void run() {\n  4:     HAConnection.log.info(this.getServiceName() + \" service started\");\n  5: \n  6:     while (!this.isStopped()) {\n  7:         try {\n  8:             this.selector.select(1000);\n  9: \n 10:             // æœªè·å¾—Slaveè¯»å–è¿›åº¦è¯·æ±‚ï¼Œsleepç­‰å¾…ã€‚\n 11:             if (-1 == HAConnection.this.slaveRequestOffset) {\n 12:                 Thread.sleep(10);\n 13:                 continue;\n 14:             }\n 15: \n 16:             // è®¡ç®—åˆå§‹åŒ–nextTransferFromWhere\n 17:             if (-1 == this.nextTransferFromWhere) {\n 18:                 if (0 == HAConnection.this.slaveRequestOffset) {\n 19:                     long masterOffset = HAConnection.this.haService.getDefaultMessageStore().getCommitLog().getMaxOffset();\n 20:                     masterOffset = masterOffset - (masterOffset % HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getMapedFileSizeCommitLog());\n 21:                     if (masterOffset < 0) {\n 22:                         masterOffset = 0;\n 23:                     }\n 24: \n 25:                     this.nextTransferFromWhere = masterOffset;\n 26:                 } else {\n 27:                     this.nextTransferFromWhere = HAConnection.this.slaveRequestOffset;\n 28:                 }\n 29: \n 30:                 log.info(\"master transfer data from \" + this.nextTransferFromWhere + \" to slave[\" + HAConnection.this.clientAddr\n 31:                     + \"], and slave request \" + HAConnection.this.slaveRequestOffset);\n 32:             }\n 33: \n 34:             if (this.lastWriteOver) {\n 35:                 long interval = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now() - this.lastWriteTimestamp;\n 36:                 if (interval > HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaSendHeartbeatInterval()) { // å¿ƒè·³\n 37: \n 38:                     // Build Header\n 39:                     this.byteBufferHeader.position(0);\n 40:                     this.byteBufferHeader.limit(headerSize);\n 41:                     this.byteBufferHeader.putLong(this.nextTransferFromWhere);\n 42:                     this.byteBufferHeader.putInt(0);\n 43:                     this.byteBufferHeader.flip();\n 44: \n 45:                     this.lastWriteOver = this.transferData();\n 46:                     if (!this.lastWriteOver)\n 47:                         continue;\n 48:                 }\n 49:             } else { // æœªä¼ è¾“å®Œæˆï¼Œç»§ç»­ä¼ è¾“\n 50:                 this.lastWriteOver = this.transferData();\n 51:                 if (!this.lastWriteOver)\n 52:                     continue;\n 53:             }\n 54: \n 55:             // é€‰æ‹©æ–°çš„CommitLogæ•°æ®è¿›è¡Œä¼ è¾“\n 56:             SelectMappedBufferResult selectResult =\n 57:                 HAConnection.this.haService.getDefaultMessageStore().getCommitLogData(this.nextTransferFromWhere);\n 58:             if (selectResult != null) {\n 59:                 int size = selectResult.getSize();\n 60:                 if (size > HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize()) {\n 61:                     size = HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize();\n 62:                 }\n 63: \n 64:                 long thisOffset = this.nextTransferFromWhere;\n 65:                 this.nextTransferFromWhere += size;\n 66: \n 67:                 selectResult.getByteBuffer().limit(size);\n 68:                 this.selectMappedBufferResult = selectResult;\n 69: \n 70:                 // Build Header\n 71:                 this.byteBufferHeader.position(0);\n 72:                 this.byteBufferHeader.limit(headerSize);\n 73:                 this.byteBufferHeader.putLong(thisOffset);\n 74:                 this.byteBufferHeader.putInt(size);\n 75:                 this.byteBufferHeader.flip();\n 76: \n 77:                 this.lastWriteOver = this.transferData();\n 78:             } else { // æ²¡æ–°çš„æ¶ˆæ¯ï¼ŒæŒ‚èµ·ç­‰å¾…\n 79:                 HAConnection.this.haService.getWaitNotifyObject().allWaitForRunning(100);\n 80:             }\n 81:         } catch (Exception e) {\n 82: \n 83:             HAConnection.log.error(this.getServiceName() + \" service has exception.\", e);\n 84:             break;\n 85:         }\n 86:     }\n 87: \n 88:     // æ–­å¼€è¿æ¥ & æš‚åœå†™çº¿ç¨‹ & æš‚åœè¯»çº¿ç¨‹ & é‡Šæ”¾CommitLog\n 89:     if (this.selectMappedBufferResult != null) {\n 90:         this.selectMappedBufferResult.release();\n 91:     }\n 92: \n 93:     this.makeStop();\n 94: \n 95:     readSocketService.makeStop();\n 96: \n 97:     haService.removeConnection(HAConnection.this);\n 98: \n 99:     SelectionKey sk = this.socketChannel.keyFor(this.selector);\n100:     if (sk != null) {\n101:         sk.cancel();\n102:     }\n103: \n104:     try {\n105:         this.selector.close();\n106:         this.socketChannel.close();\n107:     } catch (IOException e) {\n108:         HAConnection.log.error(\"\", e);\n109:     }\n110: \n111:     HAConnection.log.info(this.getServiceName() + \" service end\");\n112: }\n113: \n114: /**\n115:  * ä¼ è¾“æ•°æ®\n116:  */\n117: private boolean transferData() throws Exception {\n118:     int writeSizeZeroTimes = 0;\n119:     // Write Header\n120:     while (this.byteBufferHeader.hasRemaining()) {\n121:         int writeSize = this.socketChannel.write(this.byteBufferHeader);\n122:         if (writeSize > 0) {\n123:             writeSizeZeroTimes = 0;\n124:             this.lastWriteTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();\n125:         } else if (writeSize == 0) {\n126:             if (++writeSizeZeroTimes >= 3) {\n127:                 break;\n128:             }\n129:         } else {\n130:             throw new Exception(\"ha master write header error < 0\");\n131:         }\n132:     }\n133: \n134:     if (null == this.selectMappedBufferResult) {\n135:         return !this.byteBufferHeader.hasRemaining();\n136:     }\n137: \n138:     writeSizeZeroTimes = 0;\n139: \n140:     // Write Body\n141:     if (!this.byteBufferHeader.hasRemaining()) {\n142:         while (this.selectMappedBufferResult.getByteBuffer().hasRemaining()) {\n143:             int writeSize = this.socketChannel.write(this.selectMappedBufferResult.getByteBuffer());\n144:             if (writeSize > 0) {\n145:                 writeSizeZeroTimes = 0;\n146:                 this.lastWriteTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();\n147:             } else if (writeSize == 0) {\n148:                 if (++writeSizeZeroTimes >= 3) {\n149:                     break;\n150:                 }\n151:             } else {\n152:                 throw new Exception(\"ha master write body error < 0\");\n153:             }\n154:         }\n155:     }\n156: \n157:     boolean result = !this.byteBufferHeader.hasRemaining() && !this.selectMappedBufferResult.getByteBuffer().hasRemaining();\n158: \n159:     if (!this.selectMappedBufferResult.getByteBuffer().hasRemaining()) {\n160:         this.selectMappedBufferResult.release();\n161:         this.selectMappedBufferResult = null;\n162:     }\n163: \n164:     return result;\n165: }\n```\n\n### 3.1.6 Master_SYNC\n\n* **`Producer` å‘é€æ¶ˆæ¯æ—¶ï¼Œ`Master_SYNC`èŠ‚ç‚¹ ä¼šç­‰å¾… `Slave`èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœã€‚**\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘\n  2: public PutMessageResult putMessage(final MessageExtBrokerInner msg) {\n  3:     // ....çœç•¥å¤„ç†å‘é€ä»£ç  \n  4:     // Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹\n  5:     if (BrokerRole.SYNC_MASTER == this.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) {\n  6:         HAService service = this.defaultMessageStore.getHaService();\n  7:         if (msg.isWaitStoreMsgOK()) {\n  8:             // Determine whether to wait\n  9:             if (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) {\n 10:                 if (null == request) {\n 11:                     request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());\n 12:                 }\n 13:                 service.putRequest(request);\n 14: \n 15:                 // å”¤é†’WriteSocketService\n 16:                 service.getWaitNotifyObject().wakeupAll();\n 17: \n 18:                 boolean flushOK = request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());\n 19:                 if (!flushOK) {\n 20:                     log.error(\"do sync transfer other node, wait return, but failed, topic: \" + msg.getTopic() + \" tags: \"\n 21:                         + msg.getTags() + \" client address: \" + msg.getBornHostString());\n 22:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);\n 23:                 }\n 24:             }\n 25:             // Slave problem\n 26:             else {\n 27:                 // Tell the producer, slave not available\n 28:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);\n 29:             }\n 30:         }\n 31:     }\n 32: \n 33:     return putMessageResult;\n 34: }\n```\n\n* ç¬¬ 16 è¡Œ ï¼šå”¤é†’ `WriteSocketService`ã€‚\n    * å”¤é†’åï¼Œ`WriteSocketService` æŒ‚èµ·ç­‰å¾…æ–°æ¶ˆæ¯ç»“æŸï¼Œ`Master` ä¼ è¾“ `Slave` æ–°çš„ `CommitLog` æ•°æ®ã€‚\n    * `Slave` æ”¶åˆ°æ•°æ®åï¼Œ**ç«‹å³**ä¸ŠæŠ¥æœ€æ–°çš„ `CommitLog` åŒæ­¥è¿›åº¦åˆ° `Master`ã€‚`ReadSocketService` å”¤é†’**ç¬¬ 18 è¡Œ**ï¼š`request#waitForFlush(...)`ã€‚\n\næˆ‘ä»¬æ¥çœ‹ä¸‹ `GroupTransferService` çš„æ ¸å¿ƒé€»è¾‘ä»£ç ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€GroupTransferService.javaã€‘\n  2: private void doWaitTransfer() {\n  3:     synchronized (this.requestsRead) {\n  4:         if (!this.requestsRead.isEmpty()) {\n  5:             for (CommitLog.GroupCommitRequest req : this.requestsRead) {\n  6:                 // ç­‰å¾…Slaveä¸Šä¼ è¿›åº¦\n  7:                 boolean transferOK = HAService.this.push2SlaveMaxOffset.get() >= req.getNextOffset();\n  8:                 for (int i = 0; !transferOK && i < 5; i++) {\n  9:                     this.notifyTransferObject.waitForRunning(1000); // å”¤é†’\n 10:                     transferOK = HAService.this.push2SlaveMaxOffset.get() >= req.getNextOffset();\n 11:                 }\n 12: \n 13:                 if (!transferOK) {\n 14:                     log.warn(\"transfer messsage to slave timeout, \" + req.getNextOffset());\n 15:                 }\n 16: \n 17:                 // å”¤é†’è¯·æ±‚ï¼Œå¹¶è®¾ç½®æ˜¯å¦SlaveåŒæ­¥æˆåŠŸ\n 18:                 req.wakeupCustomer(transferOK);\n 19:             }\n 20: \n 21:             this.requestsRead.clear();\n 22:         }\n 23:     }\n 24: }\n```\n\n## 3.2 Producer å‘é€æ¶ˆæ¯\n\n* **`Producer` å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ `Broker`é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚**\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘\n  2: private SendResult sendDefaultImpl(//\n  3:     Message msg, //\n  4:     final CommunicationMode communicationMode, //\n  5:     final SendCallback sendCallback, //\n  6:     final long timeout//\n  7: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n  8:     // .... çœç•¥ï¼šå¤„ç†ã€æ ¡éªŒé€»è¾‘ã€‘\n  9:     // è·å– Topicè·¯ç”±ä¿¡æ¯\n 10:     TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());\n 11:     if (topicPublishInfo != null && topicPublishInfo.ok()) {\n 12:         MessageQueue mq = null; // æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—\n 13:         Exception exception = null;\n 14:         SendResult sendResult = null; // æœ€åä¸€æ¬¡å‘é€ç»“æœ\n 15:         int timesTotal = communicationMode == CommunicationMode.SYNC ? 1 + this.defaultMQProducer.getRetryTimesWhenSendFailed() : 1; // åŒæ­¥å¤šæ¬¡è°ƒç”¨\n 16:         int times = 0; // ç¬¬å‡ æ¬¡å‘é€\n 17:         String[] brokersSent = new String[timesTotal]; // å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå\n 18:         // å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ\n 19:         for (; times < timesTotal; times++) {\n 20:             String lastBrokerName = null == mq ? null : mq.getBrokerName();\n 21:             MessageQueue tmpmq = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName); // é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—\n 22:             if (tmpmq != null) {\n 23:                 mq = tmpmq;\n 24:                 brokersSent[times] = mq.getBrokerName();\n 25:                 try {\n 26:                     beginTimestampPrev = System.currentTimeMillis();\n 27:                     // è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•\n 28:                     sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);\n 29:                     endTimestamp = System.currentTimeMillis();\n 30:                     // æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯\n 31:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);\n 32:                     // .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘\n 33:                     }\n 34:                 } catch (e) { // .... çœç•¥ï¼šå¤„ç†ã€å¼‚å¸¸ã€‘\n 35:                     \n 36:                 }\n 37:             } else {\n 38:                 break;\n 39:             }\n 40:         }\n 41:         // .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘\n 42:     }\n 43:     // .... çœç•¥ï¼šå¤„ç†ã€æ‰¾ä¸åˆ°æ¶ˆæ¯è·¯ç”±ã€‘\n 44: }\n```\n\nå¦‚ä¸‹æ˜¯è°ƒè¯• `#sendDefaultImpl(...)` æ—¶ `TopicPublishInfo` çš„ç»“æœï¼Œ`Producer` è·å¾—åˆ°äº† `broker-a`,`broker-b` ä¸¤ä¸ª `Broker`åˆ†ç»„ çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š\n![Producer.TopicPublishInfo.è°ƒè¯•.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/Producer.TopicPublishInfo.è°ƒè¯•.png)\n\n## 3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯\n\n* **`Consumer` æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ `Broker`é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚**\n\n# 4. æ€»ç»“\n\n![HAæ€»ç»“.jpeg](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAæ€»ç»“.jpeg)\n\n\n","slug":"RocketMQ/high-availability","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswzl000xak5dw4kls0uc","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1009-RocketMQæºç è§£æï¼šé«˜å¯ç”¨.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šé«˜å¯ç”¨</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. Namesrv é«˜å¯ç”¨</a><ul>\n<li><a href=\"#\">2.1 Broker æ³¨å†Œåˆ° Namesrv</a></li>\n<li><a href=\"#\">2.2 Producerã€Consumer è®¿é—® Namesrv</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3. Broker é«˜å¯ç”¨</a><ul>\n<li><a href=\"#\">3.2 Broker ä¸»ä»</a><ul>\n<li><a href=\"#\">3.1.1 é…ç½®</a></li>\n<li><a href=\"#\">3.1.2 ç»„ä»¶</a></li>\n<li><a href=\"#\">3.1.3 é€šä¿¡åè®®</a></li>\n<li><a href=\"#\">3.1.4 Slave</a></li>\n<li><a href=\"#\">3.1.5 Master</a></li>\n<li><a href=\"#\">3.1.6 Master_SYNC</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3.2 Producer å‘é€æ¶ˆæ¯</a></li>\n<li><a href=\"#\">3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4. æ€»ç»“</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦è§£æ <code>Namesrv</code>ã€<code>Broker</code> å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Œ<code>Producer</code>ã€<code>Consumer</code> æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚</p>\n<h1 id=\"2-Namesrv-é«˜å¯ç”¨\"><a href=\"#2-Namesrv-é«˜å¯ç”¨\" class=\"headerlink\" title=\"2. Namesrv é«˜å¯ç”¨\"></a>2. Namesrv é«˜å¯ç”¨</h1><p><strong>å¯åŠ¨å¤šä¸ª <code>Namesrv</code> å®ç°é«˜å¯ç”¨ã€‚</strong><br>ç›¸è¾ƒäº <code>Zookeeper</code>ã€<code>Consul</code>ã€<code>Etcd</code> ç­‰ï¼Œ<code>Namesrv</code> æ˜¯ä¸€ä¸ª<strong>è¶…è½»é‡çº§</strong>çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›<strong>å‘½åæœåŠ¡</strong>ã€‚</p>\n<h2 id=\"2-1-Broker-æ³¨å†Œåˆ°-Namesrv\"><a href=\"#2-1-Broker-æ³¨å†Œåˆ°-Namesrv\" class=\"headerlink\" title=\"2.1 Broker æ³¨å†Œåˆ° Namesrv\"></a>2.1 Broker æ³¨å†Œåˆ° Namesrv</h2><ul>\n<li>ğŸ“Œ <strong>å¤šä¸ª <code>Namesrv</code> ä¹‹é—´ï¼Œæ²¡æœ‰ä»»ä½•å…³ç³»ï¼ˆä¸å­˜åœ¨ç±»ä¼¼ <code>Zookeeper</code> çš„ <code>Leader</code>/<code>Follower</code> ç­‰è§’è‰²ï¼‰ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚é€šè¿‡ <code>Broker</code> å¾ªç¯æ³¨å†Œå¤šä¸ª <code>Namesrv</code>ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€BrokerOuterAPI.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RegisterBrokerResult <span class=\"title\">registerBrokerAll</span><span class=\"params\">(</span></span></div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> String clusterName,</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> String brokerAddr,</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> String brokerName,</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> brokerId,</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">final</span> String haServerAddr,</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">final</span> TopicConfigSerializeWrapper topicConfigWrapper,</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">final</span> List&lt;String&gt; filterServerList,</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> oneway,</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> timeoutMills) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:     RegisterBrokerResult registerBrokerResult = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:     List&lt;String&gt; nameServerAddressList = <span class=\"keyword\">this</span>.remotingClient.getNameServerAddressList();</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (nameServerAddressList != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">for</span> (String namesrvAddr : nameServerAddressList) &#123; <span class=\"comment\">// å¾ªç¯å¤šä¸ª Namesrv</span></div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">18</span>:                 RegisterBrokerResult result = <span class=\"keyword\">this</span>.registerBroker(namesrvAddr, clusterName, brokerAddr, brokerName, brokerId,</div><div class=\"line\"><span class=\"number\">19</span>:                     haServerAddr, topicConfigWrapper, filterServerList, oneway, timeoutMills);</div><div class=\"line\"><span class=\"number\">20</span>:                 <span class=\"keyword\">if</span> (result != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                     registerBrokerResult = result;</div><div class=\"line\"><span class=\"number\">22</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:                 log.info(<span class=\"string\">\"register broker to name server &#123;&#125; OK\"</span>, namesrvAddr);</div><div class=\"line\"><span class=\"number\">25</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 log.warn(<span class=\"string\">\"registerBroker Exception, &#123;&#125;\"</span>, namesrvAddr, e);</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>:     &#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"keyword\">return</span> registerBrokerResult;</div><div class=\"line\"><span class=\"number\">32</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-2-Producerã€Consumer-è®¿é—®-Namesrv\"><a href=\"#2-2-Producerã€Consumer-è®¿é—®-Namesrv\" class=\"headerlink\" title=\"2.2 Producerã€Consumer è®¿é—® Namesrv\"></a>2.2 Producerã€Consumer è®¿é—® Namesrv</h2><ul>\n<li>ğŸ“Œ <strong><code>Producer</code>ã€<code>Consumer</code> ä» <code>Namesrv</code>åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªå¯è¿æ¥çš„è¿›è¡Œé€šä¿¡ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€NettyRemotingClient.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> Channel <span class=\"title\">getAndCreateNameserverChannel</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥Namesrv</span></div><div class=\"line\"> <span class=\"number\">4</span>:     String addr = <span class=\"keyword\">this</span>.namesrvAddrChoosed.get();</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (addr != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         ChannelWrapper cw = <span class=\"keyword\">this</span>.channelTables.get(addr);</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">if</span> (cw != <span class=\"keyword\">null</span> &amp;&amp; cw.isOK()) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"keyword\">return</span> cw.getChannel();</div><div class=\"line\"> <span class=\"number\">9</span>:         &#125;</div><div class=\"line\"><span class=\"number\">10</span>:     &#125;</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> List&lt;String&gt; addrList = <span class=\"keyword\">this</span>.namesrvAddrList.get();</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lockNamesrvChannel.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"comment\">// è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥çš„Namesrv</span></div><div class=\"line\"><span class=\"number\">16</span>:             addr = <span class=\"keyword\">this</span>.namesrvAddrChoosed.get();</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">if</span> (addr != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">18</span>:                 ChannelWrapper cw = <span class=\"keyword\">this</span>.channelTables.get(addr);</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">if</span> (cw != <span class=\"keyword\">null</span> &amp;&amp; cw.isOK()) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                     <span class=\"keyword\">return</span> cw.getChannel();</div><div class=\"line\"><span class=\"number\">21</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">22</span>:             &#125;</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"comment\">// ä»ã€Namesrvåˆ—è¡¨ã€‘ä¸­é€‰æ‹©ä¸€ä¸ªè¿æ¥çš„è¿”å›</span></div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (addrList != <span class=\"keyword\">null</span> &amp;&amp; !addrList.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; addrList.size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"keyword\">int</span> index = <span class=\"keyword\">this</span>.namesrvIndex.incrementAndGet();</div><div class=\"line\"><span class=\"number\">27</span>:                     index = Math.abs(index);</div><div class=\"line\"><span class=\"number\">28</span>:                     index = index % addrList.size();</div><div class=\"line\"><span class=\"number\">29</span>:                     String newAddr = addrList.get(index);</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:                     <span class=\"keyword\">this</span>.namesrvAddrChoosed.set(newAddr);</div><div class=\"line\"><span class=\"number\">32</span>:                     Channel channelNew = <span class=\"keyword\">this</span>.createChannel(newAddr);</div><div class=\"line\"><span class=\"number\">33</span>:                     <span class=\"keyword\">if</span> (channelNew != <span class=\"keyword\">null</span>)</div><div class=\"line\"><span class=\"number\">34</span>:                         <span class=\"keyword\">return</span> channelNew;</div><div class=\"line\"><span class=\"number\">35</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">36</span>:             &#125;</div><div class=\"line\"><span class=\"number\">37</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">38</span>:             log.error(<span class=\"string\">\"getAndCreateNameserverChannel: create name server channel exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">39</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">40</span>:             <span class=\"keyword\">this</span>.lockNamesrvChannel.unlock();</div><div class=\"line\"><span class=\"number\">41</span>:         &#125;</div><div class=\"line\"><span class=\"number\">42</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">43</span>:         log.warn(<span class=\"string\">\"getAndCreateNameserverChannel: try to lock name server, but timeout, &#123;&#125;ms\"</span>, LOCK_TIMEOUT_MILLIS);</div><div class=\"line\"><span class=\"number\">44</span>:     &#125;</div><div class=\"line\"><span class=\"number\">45</span>: </div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">47</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-Broker-é«˜å¯ç”¨\"><a href=\"#3-Broker-é«˜å¯ç”¨\" class=\"headerlink\" title=\"3. Broker é«˜å¯ç”¨\"></a>3. Broker é«˜å¯ç”¨</h1><p><strong>å¯åŠ¨å¤šä¸ª <code>Brokeråˆ†ç»„</code> å½¢æˆ <code>é›†ç¾¤</code> å®ç°é«˜å¯ç”¨ã€‚</strong><br><strong><code>Brokeråˆ†ç»„</code> = <code>MasterèŠ‚ç‚¹</code>x1 + <code>SlaveèŠ‚ç‚¹</code>xNã€‚</strong><br>ç±»ä¼¼ <code>MySQL</code>ï¼Œ<code>MasterèŠ‚ç‚¹</code> æä¾›<strong>è¯»å†™</strong>æœåŠ¡ï¼Œ<code>SlaveèŠ‚ç‚¹</code> åªæä¾›<strong>è¯»</strong>æœåŠ¡ã€‚  </p>\n<h2 id=\"3-2-Broker-ä¸»ä»\"><a href=\"#3-2-Broker-ä¸»ä»\" class=\"headerlink\" title=\"3.2 Broker ä¸»ä»\"></a>3.2 Broker ä¸»ä»</h2><ul>\n<li><strong>æ¯ä¸ªåˆ†ç»„ï¼Œ<code>Master</code>èŠ‚ç‚¹ ä¸æ–­å‘é€æ–°çš„ <code>CommitLog</code> ç»™ <code>Slave</code>èŠ‚ç‚¹ã€‚ <code>Slave</code>èŠ‚ç‚¹ ä¸æ–­ä¸ŠæŠ¥æœ¬åœ°çš„ <code>CommitLog</code> å·²ç»åŒæ­¥åˆ°çš„ä½ç½®ç»™ <code>Master</code>èŠ‚ç‚¹ã€‚</strong></li>\n<li><strong><code>Brokeråˆ†ç»„</code> ä¸ <code>Brokeråˆ†ç»„</code> ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚</strong></li>\n<li><strong>æ¶ˆè´¹è¿›åº¦ ç›®å‰ä¸æ”¯æŒ <code>Master</code>/<code>Slave</code> åŒæ­¥ã€‚</strong></li>\n</ul>\n<p>é›†ç¾¤å†…ï¼Œ<code>Master</code>èŠ‚ç‚¹ æœ‰<strong>ä¸¤ç§</strong>ç±»å‹ï¼š<code>Master_SYNC</code>ã€<code>Master_ASYNC</code>ï¼šå‰è€…åœ¨ <code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œç­‰å¾… <code>Slave</code>èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœï¼Œè€Œåè€…ä¸éœ€è¦ç­‰å¾…ã€‚</p>\n<h3 id=\"3-1-1-é…ç½®\"><a href=\"#3-1-1-é…ç½®\" class=\"headerlink\" title=\"3.1.1 é…ç½®\"></a>3.1.1 é…ç½®</h3><p>ç›®å‰å®˜æ–¹æä¾›ä¸‰å¥—é…ç½®ï¼š</p>\n<ul>\n<li><strong>2m-2s-async</strong></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>brokerClusterName</th>\n<th>brokerName</th>\n<th>brokerRole</th>\n<th>brokerId</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>ASYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>SLAVE</td>\n<td>1</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>ASYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>SLAVE</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>2m-2s-sync</strong></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>brokerClusterName</th>\n<th>brokerName</th>\n<th>brokerRole</th>\n<th>brokerId</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>SYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>SLAVE</td>\n<td>1</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>SYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>SLAVE</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>2m-noslave</strong></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>brokerClusterName</th>\n<th>brokerName</th>\n<th>brokerRole</th>\n<th>brokerId</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>ASYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>ASYNC_MASTER</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-1-2-ç»„ä»¶\"><a href=\"#3-1-2-ç»„ä»¶\" class=\"headerlink\" title=\"3.1.2 ç»„ä»¶\"></a>3.1.2 ç»„ä»¶</h3><p>å†çœ‹å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>Master</code>/<code>Slave</code>èŠ‚ç‚¹ åŒ…å«çš„ç»„ä»¶ï¼š<br><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAç»„ä»¶å›¾.png\" alt=\"HAç»„ä»¶å›¾.png\"></p>\n<ul>\n<li><code>Master</code>èŠ‚ç‚¹<ul>\n<li><code>AcceptSocketService</code> ï¼šæ¥æ”¶ <code>Slave</code>èŠ‚ç‚¹ è¿æ¥ã€‚</li>\n<li><code>HAConnection</code><ul>\n<li><code>ReadSocketService</code> ï¼š<strong>è¯»</strong>æ¥è‡ª <code>Slave</code>èŠ‚ç‚¹ çš„æ•°æ®ã€‚ </li>\n<li><code>WriteSocketService</code> ï¼š<strong>å†™</strong>åˆ°å¾€ <code>Slave</code>èŠ‚ç‚¹ çš„æ•°æ®ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>Slave</code>èŠ‚ç‚¹<ul>\n<li><code>HAClient</code> ï¼šå¯¹ <code>Master</code>èŠ‚ç‚¹ è¿æ¥ã€è¯»å†™æ•°æ®ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"3-1-3-é€šä¿¡åè®®\"><a href=\"#3-1-3-é€šä¿¡åè®®\" class=\"headerlink\" title=\"3.1.3 é€šä¿¡åè®®\"></a>3.1.3 é€šä¿¡åè®®</h3><p><code>Master</code>èŠ‚ç‚¹ ä¸ <code>Slave</code>èŠ‚ç‚¹ <strong>é€šä¿¡åè®®</strong>å¾ˆç®€å•ï¼Œåªæœ‰å¦‚ä¸‹ä¸¤æ¡ã€‚</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">å¯¹è±¡</th>\n<th style=\"text-align:left\">ç”¨é€”</th>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Slave=&gt;Master</td>\n<td style=\"text-align:left\">ä¸ŠæŠ¥CommitLog<strong>å·²ç»</strong>åŒæ­¥åˆ°çš„<strong>ç‰©ç†</strong>ä½ç½®</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">maxPhyOffset</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n<td style=\"text-align:left\">CommitLogæœ€å¤§ç‰©ç†ä½ç½®</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Master=&gt;Slave</td>\n<td style=\"text-align:left\">ä¼ è¾“æ–°çš„ <code>CommitLog</code> æ•°æ®</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">fromPhyOffset</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n<td style=\"text-align:left\">CommitLogå¼€å§‹ç‰©ç†ä½ç½®</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">size</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">ä¼ è¾“CommitLogæ•°æ®é•¿åº¦</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">body</td>\n<td style=\"text-align:left\">Bytes</td>\n<td style=\"text-align:left\">size</td>\n<td style=\"text-align:left\">ä¼ è¾“CommitLogæ•°æ®</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-1-4-Slave\"><a href=\"#3-1-4-Slave\" class=\"headerlink\" title=\"3.1.4 Slave\"></a>3.1.4 Slave</h3><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAClienté¡ºåºå›¾.png\" alt=\"HAClienté¡ºåºå›¾\"></p>\n<hr>\n<ul>\n<li><strong><code>Slave</code> ä¸»å¾ªç¯ï¼Œå®ç°äº†</strong>ä¸æ–­ä¸æ–­ä¸æ–­<strong>ä» <code>Master</code> ä¼ è¾“ <code>CommitLog</code> æ•°æ®ï¼Œä¸Šä¼  <code>Master</code> è‡ªå·±æœ¬åœ°çš„ <code>CommitLog</code> å·²ç»åŒæ­¥ç‰©ç†ä½ç½®ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€HAClient.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.connectMaster()) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:                 <span class=\"comment\">// è‹¥åˆ°æ»¡è¶³ä¸ŠæŠ¥é—´éš”ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">9</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isTimeToReportOffset()) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:                     <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">this</span>.reportSlaveMaxOffset(<span class=\"keyword\">this</span>.currentReportedOffset);</div><div class=\"line\"><span class=\"number\">11</span>:                     <span class=\"keyword\">if</span> (!result) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:                         <span class=\"keyword\">this</span>.closeMaster();</div><div class=\"line\"><span class=\"number\">13</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">14</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>:                 <span class=\"keyword\">this</span>.selector.select(<span class=\"number\">1000</span>);</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"comment\">// å¤„ç†è¯»å–äº‹ä»¶</span></div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">boolean</span> ok = <span class=\"keyword\">this</span>.processReadEvent();</div><div class=\"line\"><span class=\"number\">20</span>:                 <span class=\"keyword\">if</span> (!ok) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                     <span class=\"keyword\">this</span>.closeMaster();</div><div class=\"line\"><span class=\"number\">22</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:                 <span class=\"comment\">// è‹¥è¿›åº¦æœ‰å˜åŒ–ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">if</span> (!reportSlaveMaxOffsetPlus()) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">27</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:                 <span class=\"comment\">// Masterè¿‡ä¹…æœªè¿”å›æ•°æ®ï¼Œå…³é—­è¿æ¥</span></div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">long</span> interval = HAService.<span class=\"keyword\">this</span>.getDefaultMessageStore().getSystemClock().now() - <span class=\"keyword\">this</span>.lastWriteTimestamp;</div><div class=\"line\"><span class=\"number\">31</span>:                 <span class=\"keyword\">if</span> (interval &gt; HAService.<span class=\"keyword\">this</span>.getDefaultMessageStore().getMessageStoreConfig()</div><div class=\"line\"><span class=\"number\">32</span>:                     .getHaHousekeepingInterval()) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:                     log.warn(<span class=\"string\">\"HAClient, housekeeping, found this connection[\"</span> + <span class=\"keyword\">this</span>.masterAddress</div><div class=\"line\"><span class=\"number\">34</span>:                         + <span class=\"string\">\"] expired, \"</span> + interval);</div><div class=\"line\"><span class=\"number\">35</span>:                     <span class=\"keyword\">this</span>.closeMaster();</div><div class=\"line\"><span class=\"number\">36</span>:                     log.warn(<span class=\"string\">\"HAClient, master not response some time, so close connection\"</span>);</div><div class=\"line\"><span class=\"number\">37</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">38</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">this</span>.waitForRunning(<span class=\"number\">1000</span> * <span class=\"number\">5</span>);</div><div class=\"line\"><span class=\"number\">40</span>:             &#125;</div><div class=\"line\"><span class=\"number\">41</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"keyword\">this</span>.waitForRunning(<span class=\"number\">1000</span> * <span class=\"number\">5</span>);</div><div class=\"line\"><span class=\"number\">44</span>:         &#125;</div><div class=\"line\"><span class=\"number\">45</span>:     &#125;</div><div class=\"line\"><span class=\"number\">46</span>: </div><div class=\"line\"><span class=\"number\">47</span>:     log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">48</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ 8 è‡³ 14 è¡Œ ï¼š<strong>å›ºå®šé—´éš”ï¼ˆé»˜è®¤5sï¼‰</strong>å‘ <code>Master</code> ä¸ŠæŠ¥ <code>Slave</code> æœ¬åœ° <code>CommitLog</code> å·²ç»åŒæ­¥åˆ°çš„ç‰©ç†ä½ç½®ã€‚è¯¥æ“ä½œè¿˜æœ‰<strong>å¿ƒè·³</strong>çš„ä½œç”¨ã€‚</li>\n<li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šå¤„ç† <code>Master</code> ä¼ è¾“ <code>Slave</code> çš„ <code>CommitLog</code> æ•°æ®ã€‚</li>\n</ul>\n<hr>\n<ul>\n<li><strong>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>#dispatchReadRequest(...)</code> ä¸ <code>#reportSlaveMaxOffset(...)</code> æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// ã€HAClient.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * è¯»å–Masterä¼ è¾“çš„CommitLogæ•°æ®ï¼Œå¹¶è¿”å›æ˜¯å¼‚å¸¸</div><div class=\"line\"> 4:  * å¦‚æœè¯»å–åˆ°æ•°æ®ï¼Œå†™å…¥CommitLog</div><div class=\"line\"> 5:  * å¼‚å¸¸åŸå› ï¼š</div><div class=\"line\"> 6:  *   1. Masterä¼ è¾“æ¥çš„æ•°æ®offset ä¸ç­‰äº Slaveçš„CommitLogæ•°æ®æœ€å¤§offset</div><div class=\"line\"> 7:  *   2. ä¸ŠæŠ¥åˆ°Masterè¿›åº¦å¤±è´¥</div><div class=\"line\"> 8:  *</div><div class=\"line\"> 9:  * <span class=\"doctag\">@return</span> æ˜¯å¦å¼‚å¸¸</div><div class=\"line\">10:  */</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">dispatchReadRequest</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> msgHeaderSize = <span class=\"number\">8</span> + <span class=\"number\">4</span>; <span class=\"comment\">// phyoffset + size</span></div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">int</span> readSocketPos = <span class=\"keyword\">this</span>.byteBufferRead.position();</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"comment\">// è¯»å–åˆ°è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">int</span> diff = <span class=\"keyword\">this</span>.byteBufferRead.position() - <span class=\"keyword\">this</span>.dispatchPostion;</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">if</span> (diff &gt;= msgHeaderSize) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"comment\">// è¯»å–masterPhyOffsetã€bodySizeã€‚ä½¿ç”¨dispatchPostionçš„åŸå› æ˜¯ï¼šå¤„ç†æ•°æ®â€œç²˜åŒ…â€å¯¼è‡´æ•°æ®è¯»å–ä¸å®Œæ•´ã€‚</span></div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">long</span> masterPhyOffset = <span class=\"keyword\">this</span>.byteBufferRead.getLong(<span class=\"keyword\">this</span>.dispatchPostion);</div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"keyword\">int</span> bodySize = <span class=\"keyword\">this</span>.byteBufferRead.getInt(<span class=\"keyword\">this</span>.dispatchPostion + <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"comment\">// æ ¡éªŒ Masterä¼ è¾“æ¥çš„æ•°æ®offset æ˜¯å¦å’Œ Slaveçš„CommitLogæ•°æ®æœ€å¤§offset æ˜¯å¦ç›¸åŒã€‚</span></div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">long</span> slavePhyOffset = HAService.<span class=\"keyword\">this</span>.defaultMessageStore.getMaxPhyOffset();</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (slavePhyOffset != <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">if</span> (slavePhyOffset != masterPhyOffset) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                     log.error(<span class=\"string\">\"master pushed offset not equal the max phy offset in slave, SLAVE: \"</span></div><div class=\"line\"><span class=\"number\">27</span>:                         + slavePhyOffset + <span class=\"string\">\" MASTER: \"</span> + masterPhyOffset);</div><div class=\"line\"><span class=\"number\">28</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">30</span>:             &#125;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"comment\">// è¯»å–åˆ°æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">if</span> (diff &gt;= (msgHeaderSize + bodySize)) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"comment\">// å†™å…¥CommitLog</span></div><div class=\"line\"><span class=\"number\">34</span>:                 <span class=\"keyword\">byte</span>[] bodyData = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[bodySize];</div><div class=\"line\"><span class=\"number\">35</span>:                 <span class=\"keyword\">this</span>.byteBufferRead.position(<span class=\"keyword\">this</span>.dispatchPostion + msgHeaderSize);</div><div class=\"line\"><span class=\"number\">36</span>:                 <span class=\"keyword\">this</span>.byteBufferRead.get(bodyData);</div><div class=\"line\"><span class=\"number\">37</span>:                 HAService.<span class=\"keyword\">this</span>.defaultMessageStore.appendToCommitLog(masterPhyOffset, bodyData);</div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"comment\">// è®¾ç½®å¤„ç†åˆ°çš„ä½ç½®</span></div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">this</span>.byteBufferRead.position(readSocketPos);</div><div class=\"line\"><span class=\"number\">40</span>:                 <span class=\"keyword\">this</span>.dispatchPostion += msgHeaderSize + bodySize;</div><div class=\"line\"><span class=\"number\">41</span>:                 <span class=\"comment\">// ä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class=\"line\"><span class=\"number\">42</span>:                 <span class=\"keyword\">if</span> (!reportSlaveMaxOffsetPlus()) &#123;</div><div class=\"line\"><span class=\"number\">43</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">44</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">45</span>:                 <span class=\"comment\">// ç»§ç»­å¾ªç¯</span></div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">47</span>:             &#125;</div><div class=\"line\"><span class=\"number\">48</span>:         &#125;</div><div class=\"line\"><span class=\"number\">49</span>: </div><div class=\"line\"><span class=\"number\">50</span>:         <span class=\"comment\">// ç©ºé—´å†™æ»¡ï¼Œé‡æ–°åˆ†é…ç©ºé—´</span></div><div class=\"line\"><span class=\"number\">51</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:             <span class=\"keyword\">this</span>.reallocateByteBuffer();</div><div class=\"line\"><span class=\"number\">53</span>:         &#125;</div><div class=\"line\"><span class=\"number\">54</span>: </div><div class=\"line\"><span class=\"number\">55</span>:         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">56</span>:     &#125;</div><div class=\"line\"><span class=\"number\">57</span>: </div><div class=\"line\"><span class=\"number\">58</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">59</span>: &#125;</div><div class=\"line\"><span class=\"number\">60</span>: </div><div class=\"line\"><span class=\"number\">61</span>: <span class=\"comment\">/**</span></div><div class=\"line\">62:  * ä¸ŠæŠ¥è¿›åº¦</div><div class=\"line\">63:  *</div><div class=\"line\">64:  * <span class=\"doctag\">@param</span> maxOffset è¿›åº¦</div><div class=\"line\">65:  * <span class=\"doctag\">@return</span> æ˜¯å¦ä¸ŠæŠ¥æˆåŠŸ</div><div class=\"line\">66:  */</div><div class=\"line\"><span class=\"number\">67</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">reportSlaveMaxOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> maxOffset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">68</span>:     <span class=\"keyword\">this</span>.reportOffset.position(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">69</span>:     <span class=\"keyword\">this</span>.reportOffset.limit(<span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">70</span>:     <span class=\"keyword\">this</span>.reportOffset.putLong(maxOffset);</div><div class=\"line\"><span class=\"number\">71</span>:     <span class=\"keyword\">this</span>.reportOffset.position(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">72</span>:     <span class=\"keyword\">this</span>.reportOffset.limit(<span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">73</span>: </div><div class=\"line\"><span class=\"number\">74</span>:     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">3</span> &amp;&amp; <span class=\"keyword\">this</span>.reportOffset.hasRemaining(); i++) &#123;</div><div class=\"line\"><span class=\"number\">75</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">76</span>:             <span class=\"keyword\">this</span>.socketChannel.write(<span class=\"keyword\">this</span>.reportOffset);</div><div class=\"line\"><span class=\"number\">77</span>:         &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">78</span>:             log.error(<span class=\"keyword\">this</span>.getServiceName()</div><div class=\"line\"><span class=\"number\">79</span>:                 + <span class=\"string\">\"reportSlaveMaxOffset this.socketChannel.write exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">80</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">81</span>:         &#125;</div><div class=\"line\"><span class=\"number\">82</span>:     &#125;</div><div class=\"line\"><span class=\"number\">83</span>: </div><div class=\"line\"><span class=\"number\">84</span>:     <span class=\"keyword\">return</span> !<span class=\"keyword\">this</span>.reportOffset.hasRemaining();</div><div class=\"line\"><span class=\"number\">85</span>: &#125;</div></pre></td></tr></table></figure>\n<h3 id=\"3-1-5-Master\"><a href=\"#3-1-5-Master\" class=\"headerlink\" title=\"3.1.5 Master\"></a>3.1.5 Master</h3><ul>\n<li><strong><code>ReadSocketService</code> é€»è¾‘åŒ <code>HAClient#processReadEvent(...)</code> åŸºæœ¬ç›¸åŒï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ReadSocketService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">processReadEvent</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">int</span> readSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"comment\">// æ¸…ç©ºbyteBufferRead</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">this</span>.byteBufferRead.flip();</div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">this</span>.processPostion = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">9</span>:     &#125;</div><div class=\"line\"><span class=\"number\">10</span>: </div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">while</span> (<span class=\"keyword\">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">int</span> readSize = <span class=\"keyword\">this</span>.socketChannel.read(<span class=\"keyword\">this</span>.byteBufferRead);</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">if</span> (readSize &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 readSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// è®¾ç½®æœ€åè¯»å–æ—¶é—´</span></div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"keyword\">this</span>.lastReadTimestamp = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:                 <span class=\"keyword\">if</span> ((<span class=\"keyword\">this</span>.byteBufferRead.position() - <span class=\"keyword\">this</span>.processPostion) &gt;= <span class=\"number\">8</span>) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                     <span class=\"comment\">// è¯»å–Slave è¯·æ±‚æ¥çš„CommitLogçš„æœ€å¤§ä½ç½®</span></div><div class=\"line\"><span class=\"number\">22</span>:                     <span class=\"keyword\">int</span> pos = <span class=\"keyword\">this</span>.byteBufferRead.position() - (<span class=\"keyword\">this</span>.byteBufferRead.position() % <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">23</span>:                     <span class=\"keyword\">long</span> readOffset = <span class=\"keyword\">this</span>.byteBufferRead.getLong(pos - <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">24</span>:                     <span class=\"keyword\">this</span>.processPostion = pos;</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"comment\">// è®¾ç½®Slave CommitLogçš„æœ€å¤§ä½ç½®</span></div><div class=\"line\"><span class=\"number\">27</span>:                     HAConnection.<span class=\"keyword\">this</span>.slaveAckOffset = readOffset;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:                     <span class=\"comment\">// è®¾ç½®Slave ç¬¬ä¸€æ¬¡è¯·æ±‚çš„ä½ç½®</span></div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"keyword\">if</span> (HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                         HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset = readOffset;</div><div class=\"line\"><span class=\"number\">32</span>:                         log.info(<span class=\"string\">\"slave[\"</span> + HAConnection.<span class=\"keyword\">this</span>.clientAddr + <span class=\"string\">\"] request offset \"</span> + readOffset);</div><div class=\"line\"><span class=\"number\">33</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">34</span>: </div><div class=\"line\"><span class=\"number\">35</span>:                     <span class=\"comment\">// é€šçŸ¥ç›®å‰Slaveè¿›åº¦ã€‚ä¸»è¦ç”¨äºMasterèŠ‚ç‚¹ä¸ºåŒæ­¥ç±»å‹çš„ã€‚</span></div><div class=\"line\"><span class=\"number\">36</span>:                     HAConnection.<span class=\"keyword\">this</span>.haService.notifyTransferSome(HAConnection.<span class=\"keyword\">this</span>.slaveAckOffset);</div><div class=\"line\"><span class=\"number\">37</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">38</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (readSize == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">if</span> (++readSizeZeroTimes &gt;= <span class=\"number\">3</span>) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">41</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">42</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">43</span>:                 log.error(<span class=\"string\">\"read socket[\"</span> + HAConnection.<span class=\"keyword\">this</span>.clientAddr + <span class=\"string\">\"] &lt; 0\"</span>);</div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">45</span>:             &#125;</div><div class=\"line\"><span class=\"number\">46</span>:         &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:             log.error(<span class=\"string\">\"processReadEvent exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">48</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">49</span>:         &#125;</div><div class=\"line\"><span class=\"number\">50</span>:     &#125;</div><div class=\"line\"><span class=\"number\">51</span>: </div><div class=\"line\"><span class=\"number\">52</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">53</span>: &#125;</div></pre></td></tr></table></figure>\n<hr>\n<ul>\n<li><strong><code>WriteSocketService</code> è®¡ç®— <code>Slave</code>å¼€å§‹åŒæ­¥çš„ä½ç½®åï¼Œä¸æ–­å‘ <code>Slave</code> ä¼ è¾“æ–°çš„ <code>CommitLog</code>æ•°æ®ã€‚</strong></li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HA.WriteSocketServiceæµç¨‹å›¾.png\" alt=\"HA.WriteSocketServiceæµç¨‹å›¾\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€WriteSocketService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\">  <span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">4</span>:     HAConnection.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\">  <span class=\"number\">5</span>: </div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\">  <span class=\"number\">7</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">  <span class=\"number\">8</span>:             <span class=\"keyword\">this</span>.selector.select(<span class=\"number\">1000</span>);</div><div class=\"line\">  <span class=\"number\">9</span>: </div><div class=\"line\"> <span class=\"number\">10</span>:             <span class=\"comment\">// æœªè·å¾—Slaveè¯»å–è¿›åº¦è¯·æ±‚ï¼Œsleepç­‰å¾…ã€‚</span></div><div class=\"line\"> <span class=\"number\">11</span>:             <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset) &#123;</div><div class=\"line\"> <span class=\"number\">12</span>:                 Thread.sleep(<span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">13</span>:                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">14</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">15</span>: </div><div class=\"line\"> <span class=\"number\">16</span>:             <span class=\"comment\">// è®¡ç®—åˆå§‹åŒ–nextTransferFromWhere</span></div><div class=\"line\"> <span class=\"number\">17</span>:             <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == <span class=\"keyword\">this</span>.nextTransferFromWhere) &#123;</div><div class=\"line\"> <span class=\"number\">18</span>:                 <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:                     <span class=\"keyword\">long</span> masterOffset = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getCommitLog().getMaxOffset();</div><div class=\"line\"> <span class=\"number\">20</span>:                     masterOffset = masterOffset - (masterOffset % HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getMapedFileSizeCommitLog());</div><div class=\"line\"> <span class=\"number\">21</span>:                     <span class=\"keyword\">if</span> (masterOffset &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:                         masterOffset = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">23</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:                     <span class=\"keyword\">this</span>.nextTransferFromWhere = masterOffset;</div><div class=\"line\"> <span class=\"number\">26</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">27</span>:                     <span class=\"keyword\">this</span>.nextTransferFromWhere = HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset;</div><div class=\"line\"> <span class=\"number\">28</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:                 log.info(<span class=\"string\">\"master transfer data from \"</span> + <span class=\"keyword\">this</span>.nextTransferFromWhere + <span class=\"string\">\" to slave[\"</span> + HAConnection.<span class=\"keyword\">this</span>.clientAddr</div><div class=\"line\"> <span class=\"number\">31</span>:                     + <span class=\"string\">\"], and slave request \"</span> + HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset);</div><div class=\"line\"> <span class=\"number\">32</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lastWriteOver) &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"keyword\">long</span> interval = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getSystemClock().now() - <span class=\"keyword\">this</span>.lastWriteTimestamp;</div><div class=\"line\"> <span class=\"number\">36</span>:                 <span class=\"keyword\">if</span> (interval &gt; HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaSendHeartbeatInterval()) &#123; <span class=\"comment\">// å¿ƒè·³</span></div><div class=\"line\"> <span class=\"number\">37</span>: </div><div class=\"line\"> <span class=\"number\">38</span>:                     <span class=\"comment\">// Build Header</span></div><div class=\"line\"> <span class=\"number\">39</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.position(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">40</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.limit(headerSize);</div><div class=\"line\"> <span class=\"number\">41</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.putLong(<span class=\"keyword\">this</span>.nextTransferFromWhere);</div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.putInt(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">43</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.flip();</div><div class=\"line\"> <span class=\"number\">44</span>: </div><div class=\"line\"> <span class=\"number\">45</span>:                     <span class=\"keyword\">this</span>.lastWriteOver = <span class=\"keyword\">this</span>.transferData();</div><div class=\"line\"> <span class=\"number\">46</span>:                     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.lastWriteOver)</div><div class=\"line\"> <span class=\"number\">47</span>:                         <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">48</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">49</span>:             &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æœªä¼ è¾“å®Œæˆï¼Œç»§ç»­ä¼ è¾“</span></div><div class=\"line\"> <span class=\"number\">50</span>:                 <span class=\"keyword\">this</span>.lastWriteOver = <span class=\"keyword\">this</span>.transferData();</div><div class=\"line\"> <span class=\"number\">51</span>:                 <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.lastWriteOver)</div><div class=\"line\"> <span class=\"number\">52</span>:                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">53</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">54</span>: </div><div class=\"line\"> <span class=\"number\">55</span>:             <span class=\"comment\">// é€‰æ‹©æ–°çš„CommitLogæ•°æ®è¿›è¡Œä¼ è¾“</span></div><div class=\"line\"> <span class=\"number\">56</span>:             SelectMappedBufferResult selectResult =</div><div class=\"line\"> <span class=\"number\">57</span>:                 HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getCommitLogData(<span class=\"keyword\">this</span>.nextTransferFromWhere);</div><div class=\"line\"> <span class=\"number\">58</span>:             <span class=\"keyword\">if</span> (selectResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:                 <span class=\"keyword\">int</span> size = selectResult.getSize();</div><div class=\"line\"> <span class=\"number\">60</span>:                 <span class=\"keyword\">if</span> (size &gt; HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize()) &#123;</div><div class=\"line\"> <span class=\"number\">61</span>:                     size = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize();</div><div class=\"line\"> <span class=\"number\">62</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">63</span>: </div><div class=\"line\"> <span class=\"number\">64</span>:                 <span class=\"keyword\">long</span> thisOffset = <span class=\"keyword\">this</span>.nextTransferFromWhere;</div><div class=\"line\"> <span class=\"number\">65</span>:                 <span class=\"keyword\">this</span>.nextTransferFromWhere += size;</div><div class=\"line\"> <span class=\"number\">66</span>: </div><div class=\"line\"> <span class=\"number\">67</span>:                 selectResult.getByteBuffer().limit(size);</div><div class=\"line\"> <span class=\"number\">68</span>:                 <span class=\"keyword\">this</span>.selectMappedBufferResult = selectResult;</div><div class=\"line\"> <span class=\"number\">69</span>: </div><div class=\"line\"> <span class=\"number\">70</span>:                 <span class=\"comment\">// Build Header</span></div><div class=\"line\"> <span class=\"number\">71</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.position(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">72</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.limit(headerSize);</div><div class=\"line\"> <span class=\"number\">73</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.putLong(thisOffset);</div><div class=\"line\"> <span class=\"number\">74</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.putInt(size);</div><div class=\"line\"> <span class=\"number\">75</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.flip();</div><div class=\"line\"> <span class=\"number\">76</span>: </div><div class=\"line\"> <span class=\"number\">77</span>:                 <span class=\"keyword\">this</span>.lastWriteOver = <span class=\"keyword\">this</span>.transferData();</div><div class=\"line\"> <span class=\"number\">78</span>:             &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æ²¡æ–°çš„æ¶ˆæ¯ï¼ŒæŒ‚èµ·ç­‰å¾…</span></div><div class=\"line\"> <span class=\"number\">79</span>:                 HAConnection.<span class=\"keyword\">this</span>.haService.getWaitNotifyObject().allWaitForRunning(<span class=\"number\">100</span>);</div><div class=\"line\"> <span class=\"number\">80</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">81</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">82</span>: </div><div class=\"line\"> <span class=\"number\">83</span>:             HAConnection.log.error(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception.\"</span>, e);</div><div class=\"line\"> <span class=\"number\">84</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">85</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">87</span>: </div><div class=\"line\"> <span class=\"number\">88</span>:     <span class=\"comment\">// æ–­å¼€è¿æ¥ &amp; æš‚åœå†™çº¿ç¨‹ &amp; æš‚åœè¯»çº¿ç¨‹ &amp; é‡Šæ”¾CommitLog</span></div><div class=\"line\"> <span class=\"number\">89</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.selectMappedBufferResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"keyword\">this</span>.selectMappedBufferResult.release();</div><div class=\"line\"> <span class=\"number\">91</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:     <span class=\"keyword\">this</span>.makeStop();</div><div class=\"line\"> <span class=\"number\">94</span>: </div><div class=\"line\"> <span class=\"number\">95</span>:     readSocketService.makeStop();</div><div class=\"line\"> <span class=\"number\">96</span>: </div><div class=\"line\"> <span class=\"number\">97</span>:     haService.removeConnection(HAConnection.<span class=\"keyword\">this</span>);</div><div class=\"line\"> <span class=\"number\">98</span>: </div><div class=\"line\"> <span class=\"number\">99</span>:     SelectionKey sk = <span class=\"keyword\">this</span>.socketChannel.keyFor(<span class=\"keyword\">this</span>.selector);</div><div class=\"line\"><span class=\"number\">100</span>:     <span class=\"keyword\">if</span> (sk != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">101</span>:         sk.cancel();</div><div class=\"line\"><span class=\"number\">102</span>:     &#125;</div><div class=\"line\"><span class=\"number\">103</span>: </div><div class=\"line\"><span class=\"number\">104</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">105</span>:         <span class=\"keyword\">this</span>.selector.close();</div><div class=\"line\"><span class=\"number\">106</span>:         <span class=\"keyword\">this</span>.socketChannel.close();</div><div class=\"line\"><span class=\"number\">107</span>:     &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">108</span>:         HAConnection.log.error(<span class=\"string\">\"\"</span>, e);</div><div class=\"line\"><span class=\"number\">109</span>:     &#125;</div><div class=\"line\"><span class=\"number\">110</span>: </div><div class=\"line\"><span class=\"number\">111</span>:     HAConnection.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">112</span>: &#125;</div><div class=\"line\"><span class=\"number\">113</span>: </div><div class=\"line\"><span class=\"number\">114</span>: <span class=\"comment\">/**</span></div><div class=\"line\">115:  * ä¼ è¾“æ•°æ®</div><div class=\"line\">116:  */</div><div class=\"line\"><span class=\"number\">117</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">transferData</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</div><div class=\"line\"><span class=\"number\">118</span>:     <span class=\"keyword\">int</span> writeSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">119</span>:     <span class=\"comment\">// Write Header</span></div><div class=\"line\"><span class=\"number\">120</span>:     <span class=\"keyword\">while</span> (<span class=\"keyword\">this</span>.byteBufferHeader.hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">121</span>:         <span class=\"keyword\">int</span> writeSize = <span class=\"keyword\">this</span>.socketChannel.write(<span class=\"keyword\">this</span>.byteBufferHeader);</div><div class=\"line\"><span class=\"number\">122</span>:         <span class=\"keyword\">if</span> (writeSize &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">123</span>:             writeSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">124</span>:             <span class=\"keyword\">this</span>.lastWriteTimestamp = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class=\"line\"><span class=\"number\">125</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (writeSize == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">126</span>:             <span class=\"keyword\">if</span> (++writeSizeZeroTimes &gt;= <span class=\"number\">3</span>) &#123;</div><div class=\"line\"><span class=\"number\">127</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">128</span>:             &#125;</div><div class=\"line\"><span class=\"number\">129</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">130</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Exception(<span class=\"string\">\"ha master write header error &lt; 0\"</span>);</div><div class=\"line\"><span class=\"number\">131</span>:         &#125;</div><div class=\"line\"><span class=\"number\">132</span>:     &#125;</div><div class=\"line\"><span class=\"number\">133</span>: </div><div class=\"line\"><span class=\"number\">134</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == <span class=\"keyword\">this</span>.selectMappedBufferResult) &#123;</div><div class=\"line\"><span class=\"number\">135</span>:         <span class=\"keyword\">return</span> !<span class=\"keyword\">this</span>.byteBufferHeader.hasRemaining();</div><div class=\"line\"><span class=\"number\">136</span>:     &#125;</div><div class=\"line\"><span class=\"number\">137</span>: </div><div class=\"line\"><span class=\"number\">138</span>:     writeSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">139</span>: </div><div class=\"line\"><span class=\"number\">140</span>:     <span class=\"comment\">// Write Body</span></div><div class=\"line\"><span class=\"number\">141</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.byteBufferHeader.hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">142</span>:         <span class=\"keyword\">while</span> (<span class=\"keyword\">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">143</span>:             <span class=\"keyword\">int</span> writeSize = <span class=\"keyword\">this</span>.socketChannel.write(<span class=\"keyword\">this</span>.selectMappedBufferResult.getByteBuffer());</div><div class=\"line\"><span class=\"number\">144</span>:             <span class=\"keyword\">if</span> (writeSize &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">145</span>:                 writeSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">146</span>:                 <span class=\"keyword\">this</span>.lastWriteTimestamp = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class=\"line\"><span class=\"number\">147</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (writeSize == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">148</span>:                 <span class=\"keyword\">if</span> (++writeSizeZeroTimes &gt;= <span class=\"number\">3</span>) &#123;</div><div class=\"line\"><span class=\"number\">149</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">150</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">151</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">152</span>:                 <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Exception(<span class=\"string\">\"ha master write body error &lt; 0\"</span>);</div><div class=\"line\"><span class=\"number\">153</span>:             &#125;</div><div class=\"line\"><span class=\"number\">154</span>:         &#125;</div><div class=\"line\"><span class=\"number\">155</span>:     &#125;</div><div class=\"line\"><span class=\"number\">156</span>: </div><div class=\"line\"><span class=\"number\">157</span>:     <span class=\"keyword\">boolean</span> result = !<span class=\"keyword\">this</span>.byteBufferHeader.hasRemaining() &amp;&amp; !<span class=\"keyword\">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining();</div><div class=\"line\"><span class=\"number\">158</span>: </div><div class=\"line\"><span class=\"number\">159</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">160</span>:         <span class=\"keyword\">this</span>.selectMappedBufferResult.release();</div><div class=\"line\"><span class=\"number\">161</span>:         <span class=\"keyword\">this</span>.selectMappedBufferResult = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">162</span>:     &#125;</div><div class=\"line\"><span class=\"number\">163</span>: </div><div class=\"line\"><span class=\"number\">164</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">165</span>: &#125;</div></pre></td></tr></table></figure>\n<h3 id=\"3-1-6-Master-SYNC\"><a href=\"#3-1-6-Master-SYNC\" class=\"headerlink\" title=\"3.1.6 Master_SYNC\"></a>3.1.6 Master_SYNC</h3><ul>\n<li><strong><code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œ<code>Master_SYNC</code>èŠ‚ç‚¹ ä¼šç­‰å¾… <code>Slave</code>èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœã€‚</strong></li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> PutMessageResult <span class=\"title\">putMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// ....çœç•¥å¤„ç†å‘é€ä»£ç  </span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"comment\">// Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (BrokerRole.SYNC_MASTER == <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         HAService service = <span class=\"keyword\">this</span>.defaultMessageStore.getHaService();</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">if</span> (msg.isWaitStoreMsgOK()) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"comment\">// Determine whether to wait</span></div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">if</span> (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == request) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                     request = <span class=\"keyword\">new</span> GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">12</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">13</span>:                 service.putRequest(request);</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"comment\">// å”¤é†’WriteSocketService</span></div><div class=\"line\"><span class=\"number\">16</span>:                 service.getWaitNotifyObject().wakeupAll();</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"keyword\">boolean</span> flushOK = request.waitForFlush(<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">if</span> (!flushOK) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                     log.error(<span class=\"string\">\"do sync transfer other node, wait return, but failed, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" tags: \"</span></div><div class=\"line\"><span class=\"number\">21</span>:                         + msg.getTags() + <span class=\"string\">\" client address: \"</span> + msg.getBornHostString());</div><div class=\"line\"><span class=\"number\">22</span>:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);</div><div class=\"line\"><span class=\"number\">23</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">24</span>:             &#125;</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"comment\">// Slave problem</span></div><div class=\"line\"><span class=\"number\">26</span>:             <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">27</span>:                 <span class=\"comment\">// Tell the producer, slave not available</span></div><div class=\"line\"><span class=\"number\">28</span>:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">29</span>:             &#125;</div><div class=\"line\"><span class=\"number\">30</span>:         &#125;</div><div class=\"line\"><span class=\"number\">31</span>:     &#125;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"keyword\">return</span> putMessageResult;</div><div class=\"line\"><span class=\"number\">34</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ 16 è¡Œ ï¼šå”¤é†’ <code>WriteSocketService</code>ã€‚<ul>\n<li>å”¤é†’åï¼Œ<code>WriteSocketService</code> æŒ‚èµ·ç­‰å¾…æ–°æ¶ˆæ¯ç»“æŸï¼Œ<code>Master</code> ä¼ è¾“ <code>Slave</code> æ–°çš„ <code>CommitLog</code> æ•°æ®ã€‚</li>\n<li><code>Slave</code> æ”¶åˆ°æ•°æ®åï¼Œ<strong>ç«‹å³</strong>ä¸ŠæŠ¥æœ€æ–°çš„ <code>CommitLog</code> åŒæ­¥è¿›åº¦åˆ° <code>Master</code>ã€‚<code>ReadSocketService</code> å”¤é†’<strong>ç¬¬ 18 è¡Œ</strong>ï¼š<code>request#waitForFlush(...)</code>ã€‚</li>\n</ul>\n</li>\n</ul>\n<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>GroupTransferService</code> çš„æ ¸å¿ƒé€»è¾‘ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€GroupTransferService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doWaitTransfer</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.requestsRead.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">for</span> (CommitLog.GroupCommitRequest req : <span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:                 <span class=\"comment\">// ç­‰å¾…Slaveä¸Šä¼ è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">7</span>:                 <span class=\"keyword\">boolean</span> transferOK = HAService.<span class=\"keyword\">this</span>.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</div><div class=\"line\"> <span class=\"number\">8</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; !transferOK &amp;&amp; i &lt; <span class=\"number\">5</span>; i++) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:                     <span class=\"keyword\">this</span>.notifyTransferObject.waitForRunning(<span class=\"number\">1000</span>); <span class=\"comment\">// å”¤é†’</span></div><div class=\"line\"><span class=\"number\">10</span>:                     transferOK = HAService.<span class=\"keyword\">this</span>.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</div><div class=\"line\"><span class=\"number\">11</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">if</span> (!transferOK) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:                     log.warn(<span class=\"string\">\"transfer messsage to slave timeout, \"</span> + req.getNextOffset());</div><div class=\"line\"><span class=\"number\">15</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// å”¤é†’è¯·æ±‚ï¼Œå¹¶è®¾ç½®æ˜¯å¦SlaveåŒæ­¥æˆåŠŸ</span></div><div class=\"line\"><span class=\"number\">18</span>:                 req.wakeupCustomer(transferOK);</div><div class=\"line\"><span class=\"number\">19</span>:             &#125;</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"keyword\">this</span>.requestsRead.clear();</div><div class=\"line\"><span class=\"number\">22</span>:         &#125;</div><div class=\"line\"><span class=\"number\">23</span>:     &#125;</div><div class=\"line\"><span class=\"number\">24</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"3-2-Producer-å‘é€æ¶ˆæ¯\"><a href=\"#3-2-Producer-å‘é€æ¶ˆæ¯\" class=\"headerlink\" title=\"3.2 Producer å‘é€æ¶ˆæ¯\"></a>3.2 Producer å‘é€æ¶ˆæ¯</h2><ul>\n<li><strong><code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ <code>Broker</code>é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚</strong></li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> SendResult <span class=\"title\">sendDefaultImpl</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">3</span>:     Message msg, //</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode, //</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> SendCallback sendCallback, //</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeout//</div><div class=\"line\"> <span class=\"number\">7</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€æ ¡éªŒé€»è¾‘ã€‘</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"comment\">// è·å– Topicè·¯ç”±ä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">10</span>:     TopicPublishInfo topicPublishInfo = <span class=\"keyword\">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">if</span> (topicPublishInfo != <span class=\"keyword\">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         MessageQueue mq = <span class=\"keyword\">null</span>; <span class=\"comment\">// æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">13</span>:         Exception exception = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">14</span>:         SendResult sendResult = <span class=\"keyword\">null</span>; <span class=\"comment\">// æœ€åä¸€æ¬¡å‘é€ç»“æœ</span></div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"keyword\">int</span> timesTotal = communicationMode == CommunicationMode.SYNC ? <span class=\"number\">1</span> + <span class=\"keyword\">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class=\"number\">1</span>; <span class=\"comment\">// åŒæ­¥å¤šæ¬¡è°ƒç”¨</span></div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">int</span> times = <span class=\"number\">0</span>; <span class=\"comment\">// ç¬¬å‡ æ¬¡å‘é€</span></div><div class=\"line\"><span class=\"number\">17</span>:         String[] brokersSent = <span class=\"keyword\">new</span> String[timesTotal]; <span class=\"comment\">// å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå</span></div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"comment\">// å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">for</span> (; times &lt; timesTotal; times++) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             String lastBrokerName = <span class=\"keyword\">null</span> == mq ? <span class=\"keyword\">null</span> : mq.getBrokerName();</div><div class=\"line\"><span class=\"number\">21</span>:             MessageQueue tmpmq = <span class=\"keyword\">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName); <span class=\"comment\">// é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">if</span> (tmpmq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:                 mq = tmpmq;</div><div class=\"line\"><span class=\"number\">24</span>:                 brokersSent[times] = mq.getBrokerName();</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                     beginTimestampPrev = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">27</span>:                     <span class=\"comment\">// è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</span></div><div class=\"line\"><span class=\"number\">28</span>:                     sendResult = <span class=\"keyword\">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);</div><div class=\"line\"><span class=\"number\">29</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"comment\">// æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">31</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">32</span>:                     <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘</span></div><div class=\"line\"><span class=\"number\">33</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">34</span>:                 &#125; <span class=\"keyword\">catch</span> (e) &#123; <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€å¼‚å¸¸ã€‘</span></div><div class=\"line\"><span class=\"number\">35</span>:                     </div><div class=\"line\"><span class=\"number\">36</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">37</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">39</span>:             &#125;</div><div class=\"line\"><span class=\"number\">40</span>:         &#125;</div><div class=\"line\"><span class=\"number\">41</span>:         <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘</span></div><div class=\"line\"><span class=\"number\">42</span>:     &#125;</div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€æ‰¾ä¸åˆ°æ¶ˆæ¯è·¯ç”±ã€‘</span></div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<p>å¦‚ä¸‹æ˜¯è°ƒè¯• <code>#sendDefaultImpl(...)</code> æ—¶ <code>TopicPublishInfo</code> çš„ç»“æœï¼Œ<code>Producer</code> è·å¾—åˆ°äº† <code>broker-a</code>,<code>broker-b</code> ä¸¤ä¸ª <code>Broker</code>åˆ†ç»„ çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š<br><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/Producer.TopicPublishInfo.è°ƒè¯•.png\" alt=\"Producer.TopicPublishInfo.è°ƒè¯•.png\"></p>\n<h2 id=\"3-3-Consumer-æ¶ˆè´¹æ¶ˆæ¯\"><a href=\"#3-3-Consumer-æ¶ˆè´¹æ¶ˆæ¯\" class=\"headerlink\" title=\"3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯\"></a>3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯</h2><ul>\n<li><strong><code>Consumer</code> æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ <code>Broker</code>é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚</strong></li>\n</ul>\n<h1 id=\"4-æ€»ç»“\"><a href=\"#4-æ€»ç»“\" class=\"headerlink\" title=\"4. æ€»ç»“\"></a>4. æ€»ç»“</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAæ€»ç»“.jpeg\" alt=\"HAæ€»ç»“.jpeg\"></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1009-RocketMQæºç è§£æï¼šé«˜å¯ç”¨.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šé«˜å¯ç”¨</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. Namesrv é«˜å¯ç”¨</a><ul>\n<li><a href=\"#\">2.1 Broker æ³¨å†Œåˆ° Namesrv</a></li>\n<li><a href=\"#\">2.2 Producerã€Consumer è®¿é—® Namesrv</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3. Broker é«˜å¯ç”¨</a><ul>\n<li><a href=\"#\">3.2 Broker ä¸»ä»</a><ul>\n<li><a href=\"#\">3.1.1 é…ç½®</a></li>\n<li><a href=\"#\">3.1.2 ç»„ä»¶</a></li>\n<li><a href=\"#\">3.1.3 é€šä¿¡åè®®</a></li>\n<li><a href=\"#\">3.1.4 Slave</a></li>\n<li><a href=\"#\">3.1.5 Master</a></li>\n<li><a href=\"#\">3.1.6 Master_SYNC</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3.2 Producer å‘é€æ¶ˆæ¯</a></li>\n<li><a href=\"#\">3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4. æ€»ç»“</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦è§£æ <code>Namesrv</code>ã€<code>Broker</code> å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Œ<code>Producer</code>ã€<code>Consumer</code> æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚</p>\n<h1 id=\"2-Namesrv-é«˜å¯ç”¨\"><a href=\"#2-Namesrv-é«˜å¯ç”¨\" class=\"headerlink\" title=\"2. Namesrv é«˜å¯ç”¨\"></a>2. Namesrv é«˜å¯ç”¨</h1><p><strong>å¯åŠ¨å¤šä¸ª <code>Namesrv</code> å®ç°é«˜å¯ç”¨ã€‚</strong><br>ç›¸è¾ƒäº <code>Zookeeper</code>ã€<code>Consul</code>ã€<code>Etcd</code> ç­‰ï¼Œ<code>Namesrv</code> æ˜¯ä¸€ä¸ª<strong>è¶…è½»é‡çº§</strong>çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›<strong>å‘½åæœåŠ¡</strong>ã€‚</p>\n<h2 id=\"2-1-Broker-æ³¨å†Œåˆ°-Namesrv\"><a href=\"#2-1-Broker-æ³¨å†Œåˆ°-Namesrv\" class=\"headerlink\" title=\"2.1 Broker æ³¨å†Œåˆ° Namesrv\"></a>2.1 Broker æ³¨å†Œåˆ° Namesrv</h2><ul>\n<li>ğŸ“Œ <strong>å¤šä¸ª <code>Namesrv</code> ä¹‹é—´ï¼Œæ²¡æœ‰ä»»ä½•å…³ç³»ï¼ˆä¸å­˜åœ¨ç±»ä¼¼ <code>Zookeeper</code> çš„ <code>Leader</code>/<code>Follower</code> ç­‰è§’è‰²ï¼‰ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚é€šè¿‡ <code>Broker</code> å¾ªç¯æ³¨å†Œå¤šä¸ª <code>Namesrv</code>ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€BrokerOuterAPI.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RegisterBrokerResult <span class=\"title\">registerBrokerAll</span><span class=\"params\">(</span></span></div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> String clusterName,</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> String brokerAddr,</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> String brokerName,</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> brokerId,</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">final</span> String haServerAddr,</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">final</span> TopicConfigSerializeWrapper topicConfigWrapper,</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">final</span> List&lt;String&gt; filterServerList,</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> oneway,</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> timeoutMills) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:     RegisterBrokerResult registerBrokerResult = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:     List&lt;String&gt; nameServerAddressList = <span class=\"keyword\">this</span>.remotingClient.getNameServerAddressList();</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (nameServerAddressList != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">for</span> (String namesrvAddr : nameServerAddressList) &#123; <span class=\"comment\">// å¾ªç¯å¤šä¸ª Namesrv</span></div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">18</span>:                 RegisterBrokerResult result = <span class=\"keyword\">this</span>.registerBroker(namesrvAddr, clusterName, brokerAddr, brokerName, brokerId,</div><div class=\"line\"><span class=\"number\">19</span>:                     haServerAddr, topicConfigWrapper, filterServerList, oneway, timeoutMills);</div><div class=\"line\"><span class=\"number\">20</span>:                 <span class=\"keyword\">if</span> (result != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                     registerBrokerResult = result;</div><div class=\"line\"><span class=\"number\">22</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:                 log.info(<span class=\"string\">\"register broker to name server &#123;&#125; OK\"</span>, namesrvAddr);</div><div class=\"line\"><span class=\"number\">25</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 log.warn(<span class=\"string\">\"registerBroker Exception, &#123;&#125;\"</span>, namesrvAddr, e);</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>:     &#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"keyword\">return</span> registerBrokerResult;</div><div class=\"line\"><span class=\"number\">32</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-2-Producerã€Consumer-è®¿é—®-Namesrv\"><a href=\"#2-2-Producerã€Consumer-è®¿é—®-Namesrv\" class=\"headerlink\" title=\"2.2 Producerã€Consumer è®¿é—® Namesrv\"></a>2.2 Producerã€Consumer è®¿é—® Namesrv</h2><ul>\n<li>ğŸ“Œ <strong><code>Producer</code>ã€<code>Consumer</code> ä» <code>Namesrv</code>åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªå¯è¿æ¥çš„è¿›è¡Œé€šä¿¡ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€NettyRemotingClient.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> Channel <span class=\"title\">getAndCreateNameserverChannel</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥Namesrv</span></div><div class=\"line\"> <span class=\"number\">4</span>:     String addr = <span class=\"keyword\">this</span>.namesrvAddrChoosed.get();</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (addr != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         ChannelWrapper cw = <span class=\"keyword\">this</span>.channelTables.get(addr);</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">if</span> (cw != <span class=\"keyword\">null</span> &amp;&amp; cw.isOK()) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"keyword\">return</span> cw.getChannel();</div><div class=\"line\"> <span class=\"number\">9</span>:         &#125;</div><div class=\"line\"><span class=\"number\">10</span>:     &#125;</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> List&lt;String&gt; addrList = <span class=\"keyword\">this</span>.namesrvAddrList.get();</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lockNamesrvChannel.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"comment\">// è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥çš„Namesrv</span></div><div class=\"line\"><span class=\"number\">16</span>:             addr = <span class=\"keyword\">this</span>.namesrvAddrChoosed.get();</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">if</span> (addr != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">18</span>:                 ChannelWrapper cw = <span class=\"keyword\">this</span>.channelTables.get(addr);</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">if</span> (cw != <span class=\"keyword\">null</span> &amp;&amp; cw.isOK()) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                     <span class=\"keyword\">return</span> cw.getChannel();</div><div class=\"line\"><span class=\"number\">21</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">22</span>:             &#125;</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"comment\">// ä»ã€Namesrvåˆ—è¡¨ã€‘ä¸­é€‰æ‹©ä¸€ä¸ªè¿æ¥çš„è¿”å›</span></div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (addrList != <span class=\"keyword\">null</span> &amp;&amp; !addrList.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; addrList.size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"keyword\">int</span> index = <span class=\"keyword\">this</span>.namesrvIndex.incrementAndGet();</div><div class=\"line\"><span class=\"number\">27</span>:                     index = Math.abs(index);</div><div class=\"line\"><span class=\"number\">28</span>:                     index = index % addrList.size();</div><div class=\"line\"><span class=\"number\">29</span>:                     String newAddr = addrList.get(index);</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:                     <span class=\"keyword\">this</span>.namesrvAddrChoosed.set(newAddr);</div><div class=\"line\"><span class=\"number\">32</span>:                     Channel channelNew = <span class=\"keyword\">this</span>.createChannel(newAddr);</div><div class=\"line\"><span class=\"number\">33</span>:                     <span class=\"keyword\">if</span> (channelNew != <span class=\"keyword\">null</span>)</div><div class=\"line\"><span class=\"number\">34</span>:                         <span class=\"keyword\">return</span> channelNew;</div><div class=\"line\"><span class=\"number\">35</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">36</span>:             &#125;</div><div class=\"line\"><span class=\"number\">37</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">38</span>:             log.error(<span class=\"string\">\"getAndCreateNameserverChannel: create name server channel exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">39</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">40</span>:             <span class=\"keyword\">this</span>.lockNamesrvChannel.unlock();</div><div class=\"line\"><span class=\"number\">41</span>:         &#125;</div><div class=\"line\"><span class=\"number\">42</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">43</span>:         log.warn(<span class=\"string\">\"getAndCreateNameserverChannel: try to lock name server, but timeout, &#123;&#125;ms\"</span>, LOCK_TIMEOUT_MILLIS);</div><div class=\"line\"><span class=\"number\">44</span>:     &#125;</div><div class=\"line\"><span class=\"number\">45</span>: </div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">47</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-Broker-é«˜å¯ç”¨\"><a href=\"#3-Broker-é«˜å¯ç”¨\" class=\"headerlink\" title=\"3. Broker é«˜å¯ç”¨\"></a>3. Broker é«˜å¯ç”¨</h1><p><strong>å¯åŠ¨å¤šä¸ª <code>Brokeråˆ†ç»„</code> å½¢æˆ <code>é›†ç¾¤</code> å®ç°é«˜å¯ç”¨ã€‚</strong><br><strong><code>Brokeråˆ†ç»„</code> = <code>MasterèŠ‚ç‚¹</code>x1 + <code>SlaveèŠ‚ç‚¹</code>xNã€‚</strong><br>ç±»ä¼¼ <code>MySQL</code>ï¼Œ<code>MasterèŠ‚ç‚¹</code> æä¾›<strong>è¯»å†™</strong>æœåŠ¡ï¼Œ<code>SlaveèŠ‚ç‚¹</code> åªæä¾›<strong>è¯»</strong>æœåŠ¡ã€‚  </p>\n<h2 id=\"3-2-Broker-ä¸»ä»\"><a href=\"#3-2-Broker-ä¸»ä»\" class=\"headerlink\" title=\"3.2 Broker ä¸»ä»\"></a>3.2 Broker ä¸»ä»</h2><ul>\n<li><strong>æ¯ä¸ªåˆ†ç»„ï¼Œ<code>Master</code>èŠ‚ç‚¹ ä¸æ–­å‘é€æ–°çš„ <code>CommitLog</code> ç»™ <code>Slave</code>èŠ‚ç‚¹ã€‚ <code>Slave</code>èŠ‚ç‚¹ ä¸æ–­ä¸ŠæŠ¥æœ¬åœ°çš„ <code>CommitLog</code> å·²ç»åŒæ­¥åˆ°çš„ä½ç½®ç»™ <code>Master</code>èŠ‚ç‚¹ã€‚</strong></li>\n<li><strong><code>Brokeråˆ†ç»„</code> ä¸ <code>Brokeråˆ†ç»„</code> ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚</strong></li>\n<li><strong>æ¶ˆè´¹è¿›åº¦ ç›®å‰ä¸æ”¯æŒ <code>Master</code>/<code>Slave</code> åŒæ­¥ã€‚</strong></li>\n</ul>\n<p>é›†ç¾¤å†…ï¼Œ<code>Master</code>èŠ‚ç‚¹ æœ‰<strong>ä¸¤ç§</strong>ç±»å‹ï¼š<code>Master_SYNC</code>ã€<code>Master_ASYNC</code>ï¼šå‰è€…åœ¨ <code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œç­‰å¾… <code>Slave</code>èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœï¼Œè€Œåè€…ä¸éœ€è¦ç­‰å¾…ã€‚</p>\n<h3 id=\"3-1-1-é…ç½®\"><a href=\"#3-1-1-é…ç½®\" class=\"headerlink\" title=\"3.1.1 é…ç½®\"></a>3.1.1 é…ç½®</h3><p>ç›®å‰å®˜æ–¹æä¾›ä¸‰å¥—é…ç½®ï¼š</p>\n<ul>\n<li><strong>2m-2s-async</strong></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>brokerClusterName</th>\n<th>brokerName</th>\n<th>brokerRole</th>\n<th>brokerId</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>ASYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>SLAVE</td>\n<td>1</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>ASYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>SLAVE</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>2m-2s-sync</strong></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>brokerClusterName</th>\n<th>brokerName</th>\n<th>brokerRole</th>\n<th>brokerId</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>SYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>SLAVE</td>\n<td>1</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>SYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>SLAVE</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>2m-noslave</strong></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>brokerClusterName</th>\n<th>brokerName</th>\n<th>brokerRole</th>\n<th>brokerId</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-a</td>\n<td>ASYNC_MASTER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>DefaultCluster</td>\n<td>broker-b</td>\n<td>ASYNC_MASTER</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-1-2-ç»„ä»¶\"><a href=\"#3-1-2-ç»„ä»¶\" class=\"headerlink\" title=\"3.1.2 ç»„ä»¶\"></a>3.1.2 ç»„ä»¶</h3><p>å†çœ‹å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>Master</code>/<code>Slave</code>èŠ‚ç‚¹ åŒ…å«çš„ç»„ä»¶ï¼š<br><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAç»„ä»¶å›¾.png\" alt=\"HAç»„ä»¶å›¾.png\"></p>\n<ul>\n<li><code>Master</code>èŠ‚ç‚¹<ul>\n<li><code>AcceptSocketService</code> ï¼šæ¥æ”¶ <code>Slave</code>èŠ‚ç‚¹ è¿æ¥ã€‚</li>\n<li><code>HAConnection</code><ul>\n<li><code>ReadSocketService</code> ï¼š<strong>è¯»</strong>æ¥è‡ª <code>Slave</code>èŠ‚ç‚¹ çš„æ•°æ®ã€‚ </li>\n<li><code>WriteSocketService</code> ï¼š<strong>å†™</strong>åˆ°å¾€ <code>Slave</code>èŠ‚ç‚¹ çš„æ•°æ®ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>Slave</code>èŠ‚ç‚¹<ul>\n<li><code>HAClient</code> ï¼šå¯¹ <code>Master</code>èŠ‚ç‚¹ è¿æ¥ã€è¯»å†™æ•°æ®ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"3-1-3-é€šä¿¡åè®®\"><a href=\"#3-1-3-é€šä¿¡åè®®\" class=\"headerlink\" title=\"3.1.3 é€šä¿¡åè®®\"></a>3.1.3 é€šä¿¡åè®®</h3><p><code>Master</code>èŠ‚ç‚¹ ä¸ <code>Slave</code>èŠ‚ç‚¹ <strong>é€šä¿¡åè®®</strong>å¾ˆç®€å•ï¼Œåªæœ‰å¦‚ä¸‹ä¸¤æ¡ã€‚</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">å¯¹è±¡</th>\n<th style=\"text-align:left\">ç”¨é€”</th>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Slave=&gt;Master</td>\n<td style=\"text-align:left\">ä¸ŠæŠ¥CommitLog<strong>å·²ç»</strong>åŒæ­¥åˆ°çš„<strong>ç‰©ç†</strong>ä½ç½®</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">maxPhyOffset</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n<td style=\"text-align:left\">CommitLogæœ€å¤§ç‰©ç†ä½ç½®</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Master=&gt;Slave</td>\n<td style=\"text-align:left\">ä¼ è¾“æ–°çš„ <code>CommitLog</code> æ•°æ®</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">fromPhyOffset</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n<td style=\"text-align:left\">CommitLogå¼€å§‹ç‰©ç†ä½ç½®</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">size</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">ä¼ è¾“CommitLogæ•°æ®é•¿åº¦</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">body</td>\n<td style=\"text-align:left\">Bytes</td>\n<td style=\"text-align:left\">size</td>\n<td style=\"text-align:left\">ä¼ è¾“CommitLogæ•°æ®</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-1-4-Slave\"><a href=\"#3-1-4-Slave\" class=\"headerlink\" title=\"3.1.4 Slave\"></a>3.1.4 Slave</h3><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAClienté¡ºåºå›¾.png\" alt=\"HAClienté¡ºåºå›¾\"></p>\n<hr>\n<ul>\n<li><strong><code>Slave</code> ä¸»å¾ªç¯ï¼Œå®ç°äº†</strong>ä¸æ–­ä¸æ–­ä¸æ–­<strong>ä» <code>Master</code> ä¼ è¾“ <code>CommitLog</code> æ•°æ®ï¼Œä¸Šä¼  <code>Master</code> è‡ªå·±æœ¬åœ°çš„ <code>CommitLog</code> å·²ç»åŒæ­¥ç‰©ç†ä½ç½®ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€HAClient.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.connectMaster()) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:                 <span class=\"comment\">// è‹¥åˆ°æ»¡è¶³ä¸ŠæŠ¥é—´éš”ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">9</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isTimeToReportOffset()) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:                     <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">this</span>.reportSlaveMaxOffset(<span class=\"keyword\">this</span>.currentReportedOffset);</div><div class=\"line\"><span class=\"number\">11</span>:                     <span class=\"keyword\">if</span> (!result) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:                         <span class=\"keyword\">this</span>.closeMaster();</div><div class=\"line\"><span class=\"number\">13</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">14</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>:                 <span class=\"keyword\">this</span>.selector.select(<span class=\"number\">1000</span>);</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"comment\">// å¤„ç†è¯»å–äº‹ä»¶</span></div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">boolean</span> ok = <span class=\"keyword\">this</span>.processReadEvent();</div><div class=\"line\"><span class=\"number\">20</span>:                 <span class=\"keyword\">if</span> (!ok) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                     <span class=\"keyword\">this</span>.closeMaster();</div><div class=\"line\"><span class=\"number\">22</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:                 <span class=\"comment\">// è‹¥è¿›åº¦æœ‰å˜åŒ–ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">if</span> (!reportSlaveMaxOffsetPlus()) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">27</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:                 <span class=\"comment\">// Masterè¿‡ä¹…æœªè¿”å›æ•°æ®ï¼Œå…³é—­è¿æ¥</span></div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">long</span> interval = HAService.<span class=\"keyword\">this</span>.getDefaultMessageStore().getSystemClock().now() - <span class=\"keyword\">this</span>.lastWriteTimestamp;</div><div class=\"line\"><span class=\"number\">31</span>:                 <span class=\"keyword\">if</span> (interval &gt; HAService.<span class=\"keyword\">this</span>.getDefaultMessageStore().getMessageStoreConfig()</div><div class=\"line\"><span class=\"number\">32</span>:                     .getHaHousekeepingInterval()) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:                     log.warn(<span class=\"string\">\"HAClient, housekeeping, found this connection[\"</span> + <span class=\"keyword\">this</span>.masterAddress</div><div class=\"line\"><span class=\"number\">34</span>:                         + <span class=\"string\">\"] expired, \"</span> + interval);</div><div class=\"line\"><span class=\"number\">35</span>:                     <span class=\"keyword\">this</span>.closeMaster();</div><div class=\"line\"><span class=\"number\">36</span>:                     log.warn(<span class=\"string\">\"HAClient, master not response some time, so close connection\"</span>);</div><div class=\"line\"><span class=\"number\">37</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">38</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">this</span>.waitForRunning(<span class=\"number\">1000</span> * <span class=\"number\">5</span>);</div><div class=\"line\"><span class=\"number\">40</span>:             &#125;</div><div class=\"line\"><span class=\"number\">41</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"keyword\">this</span>.waitForRunning(<span class=\"number\">1000</span> * <span class=\"number\">5</span>);</div><div class=\"line\"><span class=\"number\">44</span>:         &#125;</div><div class=\"line\"><span class=\"number\">45</span>:     &#125;</div><div class=\"line\"><span class=\"number\">46</span>: </div><div class=\"line\"><span class=\"number\">47</span>:     log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">48</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ 8 è‡³ 14 è¡Œ ï¼š<strong>å›ºå®šé—´éš”ï¼ˆé»˜è®¤5sï¼‰</strong>å‘ <code>Master</code> ä¸ŠæŠ¥ <code>Slave</code> æœ¬åœ° <code>CommitLog</code> å·²ç»åŒæ­¥åˆ°çš„ç‰©ç†ä½ç½®ã€‚è¯¥æ“ä½œè¿˜æœ‰<strong>å¿ƒè·³</strong>çš„ä½œç”¨ã€‚</li>\n<li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šå¤„ç† <code>Master</code> ä¼ è¾“ <code>Slave</code> çš„ <code>CommitLog</code> æ•°æ®ã€‚</li>\n</ul>\n<hr>\n<ul>\n<li><strong>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>#dispatchReadRequest(...)</code> ä¸ <code>#reportSlaveMaxOffset(...)</code> æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// ã€HAClient.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * è¯»å–Masterä¼ è¾“çš„CommitLogæ•°æ®ï¼Œå¹¶è¿”å›æ˜¯å¼‚å¸¸</div><div class=\"line\"> 4:  * å¦‚æœè¯»å–åˆ°æ•°æ®ï¼Œå†™å…¥CommitLog</div><div class=\"line\"> 5:  * å¼‚å¸¸åŸå› ï¼š</div><div class=\"line\"> 6:  *   1. Masterä¼ è¾“æ¥çš„æ•°æ®offset ä¸ç­‰äº Slaveçš„CommitLogæ•°æ®æœ€å¤§offset</div><div class=\"line\"> 7:  *   2. ä¸ŠæŠ¥åˆ°Masterè¿›åº¦å¤±è´¥</div><div class=\"line\"> 8:  *</div><div class=\"line\"> 9:  * <span class=\"doctag\">@return</span> æ˜¯å¦å¼‚å¸¸</div><div class=\"line\">10:  */</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">dispatchReadRequest</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> msgHeaderSize = <span class=\"number\">8</span> + <span class=\"number\">4</span>; <span class=\"comment\">// phyoffset + size</span></div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">int</span> readSocketPos = <span class=\"keyword\">this</span>.byteBufferRead.position();</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"comment\">// è¯»å–åˆ°è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">int</span> diff = <span class=\"keyword\">this</span>.byteBufferRead.position() - <span class=\"keyword\">this</span>.dispatchPostion;</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">if</span> (diff &gt;= msgHeaderSize) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"comment\">// è¯»å–masterPhyOffsetã€bodySizeã€‚ä½¿ç”¨dispatchPostionçš„åŸå› æ˜¯ï¼šå¤„ç†æ•°æ®â€œç²˜åŒ…â€å¯¼è‡´æ•°æ®è¯»å–ä¸å®Œæ•´ã€‚</span></div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">long</span> masterPhyOffset = <span class=\"keyword\">this</span>.byteBufferRead.getLong(<span class=\"keyword\">this</span>.dispatchPostion);</div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"keyword\">int</span> bodySize = <span class=\"keyword\">this</span>.byteBufferRead.getInt(<span class=\"keyword\">this</span>.dispatchPostion + <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"comment\">// æ ¡éªŒ Masterä¼ è¾“æ¥çš„æ•°æ®offset æ˜¯å¦å’Œ Slaveçš„CommitLogæ•°æ®æœ€å¤§offset æ˜¯å¦ç›¸åŒã€‚</span></div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">long</span> slavePhyOffset = HAService.<span class=\"keyword\">this</span>.defaultMessageStore.getMaxPhyOffset();</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (slavePhyOffset != <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">if</span> (slavePhyOffset != masterPhyOffset) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                     log.error(<span class=\"string\">\"master pushed offset not equal the max phy offset in slave, SLAVE: \"</span></div><div class=\"line\"><span class=\"number\">27</span>:                         + slavePhyOffset + <span class=\"string\">\" MASTER: \"</span> + masterPhyOffset);</div><div class=\"line\"><span class=\"number\">28</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">30</span>:             &#125;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"comment\">// è¯»å–åˆ°æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">if</span> (diff &gt;= (msgHeaderSize + bodySize)) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"comment\">// å†™å…¥CommitLog</span></div><div class=\"line\"><span class=\"number\">34</span>:                 <span class=\"keyword\">byte</span>[] bodyData = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[bodySize];</div><div class=\"line\"><span class=\"number\">35</span>:                 <span class=\"keyword\">this</span>.byteBufferRead.position(<span class=\"keyword\">this</span>.dispatchPostion + msgHeaderSize);</div><div class=\"line\"><span class=\"number\">36</span>:                 <span class=\"keyword\">this</span>.byteBufferRead.get(bodyData);</div><div class=\"line\"><span class=\"number\">37</span>:                 HAService.<span class=\"keyword\">this</span>.defaultMessageStore.appendToCommitLog(masterPhyOffset, bodyData);</div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"comment\">// è®¾ç½®å¤„ç†åˆ°çš„ä½ç½®</span></div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">this</span>.byteBufferRead.position(readSocketPos);</div><div class=\"line\"><span class=\"number\">40</span>:                 <span class=\"keyword\">this</span>.dispatchPostion += msgHeaderSize + bodySize;</div><div class=\"line\"><span class=\"number\">41</span>:                 <span class=\"comment\">// ä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span></div><div class=\"line\"><span class=\"number\">42</span>:                 <span class=\"keyword\">if</span> (!reportSlaveMaxOffsetPlus()) &#123;</div><div class=\"line\"><span class=\"number\">43</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">44</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">45</span>:                 <span class=\"comment\">// ç»§ç»­å¾ªç¯</span></div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">47</span>:             &#125;</div><div class=\"line\"><span class=\"number\">48</span>:         &#125;</div><div class=\"line\"><span class=\"number\">49</span>: </div><div class=\"line\"><span class=\"number\">50</span>:         <span class=\"comment\">// ç©ºé—´å†™æ»¡ï¼Œé‡æ–°åˆ†é…ç©ºé—´</span></div><div class=\"line\"><span class=\"number\">51</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:             <span class=\"keyword\">this</span>.reallocateByteBuffer();</div><div class=\"line\"><span class=\"number\">53</span>:         &#125;</div><div class=\"line\"><span class=\"number\">54</span>: </div><div class=\"line\"><span class=\"number\">55</span>:         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">56</span>:     &#125;</div><div class=\"line\"><span class=\"number\">57</span>: </div><div class=\"line\"><span class=\"number\">58</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">59</span>: &#125;</div><div class=\"line\"><span class=\"number\">60</span>: </div><div class=\"line\"><span class=\"number\">61</span>: <span class=\"comment\">/**</span></div><div class=\"line\">62:  * ä¸ŠæŠ¥è¿›åº¦</div><div class=\"line\">63:  *</div><div class=\"line\">64:  * <span class=\"doctag\">@param</span> maxOffset è¿›åº¦</div><div class=\"line\">65:  * <span class=\"doctag\">@return</span> æ˜¯å¦ä¸ŠæŠ¥æˆåŠŸ</div><div class=\"line\">66:  */</div><div class=\"line\"><span class=\"number\">67</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">reportSlaveMaxOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> maxOffset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">68</span>:     <span class=\"keyword\">this</span>.reportOffset.position(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">69</span>:     <span class=\"keyword\">this</span>.reportOffset.limit(<span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">70</span>:     <span class=\"keyword\">this</span>.reportOffset.putLong(maxOffset);</div><div class=\"line\"><span class=\"number\">71</span>:     <span class=\"keyword\">this</span>.reportOffset.position(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">72</span>:     <span class=\"keyword\">this</span>.reportOffset.limit(<span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">73</span>: </div><div class=\"line\"><span class=\"number\">74</span>:     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">3</span> &amp;&amp; <span class=\"keyword\">this</span>.reportOffset.hasRemaining(); i++) &#123;</div><div class=\"line\"><span class=\"number\">75</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">76</span>:             <span class=\"keyword\">this</span>.socketChannel.write(<span class=\"keyword\">this</span>.reportOffset);</div><div class=\"line\"><span class=\"number\">77</span>:         &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">78</span>:             log.error(<span class=\"keyword\">this</span>.getServiceName()</div><div class=\"line\"><span class=\"number\">79</span>:                 + <span class=\"string\">\"reportSlaveMaxOffset this.socketChannel.write exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">80</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">81</span>:         &#125;</div><div class=\"line\"><span class=\"number\">82</span>:     &#125;</div><div class=\"line\"><span class=\"number\">83</span>: </div><div class=\"line\"><span class=\"number\">84</span>:     <span class=\"keyword\">return</span> !<span class=\"keyword\">this</span>.reportOffset.hasRemaining();</div><div class=\"line\"><span class=\"number\">85</span>: &#125;</div></pre></td></tr></table></figure>\n<h3 id=\"3-1-5-Master\"><a href=\"#3-1-5-Master\" class=\"headerlink\" title=\"3.1.5 Master\"></a>3.1.5 Master</h3><ul>\n<li><strong><code>ReadSocketService</code> é€»è¾‘åŒ <code>HAClient#processReadEvent(...)</code> åŸºæœ¬ç›¸åŒï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ã€‚</strong></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ReadSocketService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">processReadEvent</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">int</span> readSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"comment\">// æ¸…ç©ºbyteBufferRead</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">this</span>.byteBufferRead.flip();</div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">this</span>.processPostion = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">9</span>:     &#125;</div><div class=\"line\"><span class=\"number\">10</span>: </div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">while</span> (<span class=\"keyword\">this</span>.byteBufferRead.hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">int</span> readSize = <span class=\"keyword\">this</span>.socketChannel.read(<span class=\"keyword\">this</span>.byteBufferRead);</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">if</span> (readSize &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 readSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// è®¾ç½®æœ€åè¯»å–æ—¶é—´</span></div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"keyword\">this</span>.lastReadTimestamp = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:                 <span class=\"keyword\">if</span> ((<span class=\"keyword\">this</span>.byteBufferRead.position() - <span class=\"keyword\">this</span>.processPostion) &gt;= <span class=\"number\">8</span>) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                     <span class=\"comment\">// è¯»å–Slave è¯·æ±‚æ¥çš„CommitLogçš„æœ€å¤§ä½ç½®</span></div><div class=\"line\"><span class=\"number\">22</span>:                     <span class=\"keyword\">int</span> pos = <span class=\"keyword\">this</span>.byteBufferRead.position() - (<span class=\"keyword\">this</span>.byteBufferRead.position() % <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">23</span>:                     <span class=\"keyword\">long</span> readOffset = <span class=\"keyword\">this</span>.byteBufferRead.getLong(pos - <span class=\"number\">8</span>);</div><div class=\"line\"><span class=\"number\">24</span>:                     <span class=\"keyword\">this</span>.processPostion = pos;</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"comment\">// è®¾ç½®Slave CommitLogçš„æœ€å¤§ä½ç½®</span></div><div class=\"line\"><span class=\"number\">27</span>:                     HAConnection.<span class=\"keyword\">this</span>.slaveAckOffset = readOffset;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:                     <span class=\"comment\">// è®¾ç½®Slave ç¬¬ä¸€æ¬¡è¯·æ±‚çš„ä½ç½®</span></div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"keyword\">if</span> (HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                         HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset = readOffset;</div><div class=\"line\"><span class=\"number\">32</span>:                         log.info(<span class=\"string\">\"slave[\"</span> + HAConnection.<span class=\"keyword\">this</span>.clientAddr + <span class=\"string\">\"] request offset \"</span> + readOffset);</div><div class=\"line\"><span class=\"number\">33</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">34</span>: </div><div class=\"line\"><span class=\"number\">35</span>:                     <span class=\"comment\">// é€šçŸ¥ç›®å‰Slaveè¿›åº¦ã€‚ä¸»è¦ç”¨äºMasterèŠ‚ç‚¹ä¸ºåŒæ­¥ç±»å‹çš„ã€‚</span></div><div class=\"line\"><span class=\"number\">36</span>:                     HAConnection.<span class=\"keyword\">this</span>.haService.notifyTransferSome(HAConnection.<span class=\"keyword\">this</span>.slaveAckOffset);</div><div class=\"line\"><span class=\"number\">37</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">38</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (readSize == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">if</span> (++readSizeZeroTimes &gt;= <span class=\"number\">3</span>) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">41</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">42</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">43</span>:                 log.error(<span class=\"string\">\"read socket[\"</span> + HAConnection.<span class=\"keyword\">this</span>.clientAddr + <span class=\"string\">\"] &lt; 0\"</span>);</div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">45</span>:             &#125;</div><div class=\"line\"><span class=\"number\">46</span>:         &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:             log.error(<span class=\"string\">\"processReadEvent exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">48</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">49</span>:         &#125;</div><div class=\"line\"><span class=\"number\">50</span>:     &#125;</div><div class=\"line\"><span class=\"number\">51</span>: </div><div class=\"line\"><span class=\"number\">52</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">53</span>: &#125;</div></pre></td></tr></table></figure>\n<hr>\n<ul>\n<li><strong><code>WriteSocketService</code> è®¡ç®— <code>Slave</code>å¼€å§‹åŒæ­¥çš„ä½ç½®åï¼Œä¸æ–­å‘ <code>Slave</code> ä¼ è¾“æ–°çš„ <code>CommitLog</code>æ•°æ®ã€‚</strong></li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HA.WriteSocketServiceæµç¨‹å›¾.png\" alt=\"HA.WriteSocketServiceæµç¨‹å›¾\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€WriteSocketService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\">  <span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">4</span>:     HAConnection.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\">  <span class=\"number\">5</span>: </div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\">  <span class=\"number\">7</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">  <span class=\"number\">8</span>:             <span class=\"keyword\">this</span>.selector.select(<span class=\"number\">1000</span>);</div><div class=\"line\">  <span class=\"number\">9</span>: </div><div class=\"line\"> <span class=\"number\">10</span>:             <span class=\"comment\">// æœªè·å¾—Slaveè¯»å–è¿›åº¦è¯·æ±‚ï¼Œsleepç­‰å¾…ã€‚</span></div><div class=\"line\"> <span class=\"number\">11</span>:             <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset) &#123;</div><div class=\"line\"> <span class=\"number\">12</span>:                 Thread.sleep(<span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">13</span>:                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">14</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">15</span>: </div><div class=\"line\"> <span class=\"number\">16</span>:             <span class=\"comment\">// è®¡ç®—åˆå§‹åŒ–nextTransferFromWhere</span></div><div class=\"line\"> <span class=\"number\">17</span>:             <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == <span class=\"keyword\">this</span>.nextTransferFromWhere) &#123;</div><div class=\"line\"> <span class=\"number\">18</span>:                 <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:                     <span class=\"keyword\">long</span> masterOffset = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getCommitLog().getMaxOffset();</div><div class=\"line\"> <span class=\"number\">20</span>:                     masterOffset = masterOffset - (masterOffset % HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getMapedFileSizeCommitLog());</div><div class=\"line\"> <span class=\"number\">21</span>:                     <span class=\"keyword\">if</span> (masterOffset &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:                         masterOffset = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">23</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:                     <span class=\"keyword\">this</span>.nextTransferFromWhere = masterOffset;</div><div class=\"line\"> <span class=\"number\">26</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">27</span>:                     <span class=\"keyword\">this</span>.nextTransferFromWhere = HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset;</div><div class=\"line\"> <span class=\"number\">28</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:                 log.info(<span class=\"string\">\"master transfer data from \"</span> + <span class=\"keyword\">this</span>.nextTransferFromWhere + <span class=\"string\">\" to slave[\"</span> + HAConnection.<span class=\"keyword\">this</span>.clientAddr</div><div class=\"line\"> <span class=\"number\">31</span>:                     + <span class=\"string\">\"], and slave request \"</span> + HAConnection.<span class=\"keyword\">this</span>.slaveRequestOffset);</div><div class=\"line\"> <span class=\"number\">32</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lastWriteOver) &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"keyword\">long</span> interval = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getSystemClock().now() - <span class=\"keyword\">this</span>.lastWriteTimestamp;</div><div class=\"line\"> <span class=\"number\">36</span>:                 <span class=\"keyword\">if</span> (interval &gt; HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaSendHeartbeatInterval()) &#123; <span class=\"comment\">// å¿ƒè·³</span></div><div class=\"line\"> <span class=\"number\">37</span>: </div><div class=\"line\"> <span class=\"number\">38</span>:                     <span class=\"comment\">// Build Header</span></div><div class=\"line\"> <span class=\"number\">39</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.position(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">40</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.limit(headerSize);</div><div class=\"line\"> <span class=\"number\">41</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.putLong(<span class=\"keyword\">this</span>.nextTransferFromWhere);</div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.putInt(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">43</span>:                     <span class=\"keyword\">this</span>.byteBufferHeader.flip();</div><div class=\"line\"> <span class=\"number\">44</span>: </div><div class=\"line\"> <span class=\"number\">45</span>:                     <span class=\"keyword\">this</span>.lastWriteOver = <span class=\"keyword\">this</span>.transferData();</div><div class=\"line\"> <span class=\"number\">46</span>:                     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.lastWriteOver)</div><div class=\"line\"> <span class=\"number\">47</span>:                         <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">48</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">49</span>:             &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æœªä¼ è¾“å®Œæˆï¼Œç»§ç»­ä¼ è¾“</span></div><div class=\"line\"> <span class=\"number\">50</span>:                 <span class=\"keyword\">this</span>.lastWriteOver = <span class=\"keyword\">this</span>.transferData();</div><div class=\"line\"> <span class=\"number\">51</span>:                 <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.lastWriteOver)</div><div class=\"line\"> <span class=\"number\">52</span>:                     <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">53</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">54</span>: </div><div class=\"line\"> <span class=\"number\">55</span>:             <span class=\"comment\">// é€‰æ‹©æ–°çš„CommitLogæ•°æ®è¿›è¡Œä¼ è¾“</span></div><div class=\"line\"> <span class=\"number\">56</span>:             SelectMappedBufferResult selectResult =</div><div class=\"line\"> <span class=\"number\">57</span>:                 HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getCommitLogData(<span class=\"keyword\">this</span>.nextTransferFromWhere);</div><div class=\"line\"> <span class=\"number\">58</span>:             <span class=\"keyword\">if</span> (selectResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:                 <span class=\"keyword\">int</span> size = selectResult.getSize();</div><div class=\"line\"> <span class=\"number\">60</span>:                 <span class=\"keyword\">if</span> (size &gt; HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize()) &#123;</div><div class=\"line\"> <span class=\"number\">61</span>:                     size = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize();</div><div class=\"line\"> <span class=\"number\">62</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">63</span>: </div><div class=\"line\"> <span class=\"number\">64</span>:                 <span class=\"keyword\">long</span> thisOffset = <span class=\"keyword\">this</span>.nextTransferFromWhere;</div><div class=\"line\"> <span class=\"number\">65</span>:                 <span class=\"keyword\">this</span>.nextTransferFromWhere += size;</div><div class=\"line\"> <span class=\"number\">66</span>: </div><div class=\"line\"> <span class=\"number\">67</span>:                 selectResult.getByteBuffer().limit(size);</div><div class=\"line\"> <span class=\"number\">68</span>:                 <span class=\"keyword\">this</span>.selectMappedBufferResult = selectResult;</div><div class=\"line\"> <span class=\"number\">69</span>: </div><div class=\"line\"> <span class=\"number\">70</span>:                 <span class=\"comment\">// Build Header</span></div><div class=\"line\"> <span class=\"number\">71</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.position(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">72</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.limit(headerSize);</div><div class=\"line\"> <span class=\"number\">73</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.putLong(thisOffset);</div><div class=\"line\"> <span class=\"number\">74</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.putInt(size);</div><div class=\"line\"> <span class=\"number\">75</span>:                 <span class=\"keyword\">this</span>.byteBufferHeader.flip();</div><div class=\"line\"> <span class=\"number\">76</span>: </div><div class=\"line\"> <span class=\"number\">77</span>:                 <span class=\"keyword\">this</span>.lastWriteOver = <span class=\"keyword\">this</span>.transferData();</div><div class=\"line\"> <span class=\"number\">78</span>:             &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æ²¡æ–°çš„æ¶ˆæ¯ï¼ŒæŒ‚èµ·ç­‰å¾…</span></div><div class=\"line\"> <span class=\"number\">79</span>:                 HAConnection.<span class=\"keyword\">this</span>.haService.getWaitNotifyObject().allWaitForRunning(<span class=\"number\">100</span>);</div><div class=\"line\"> <span class=\"number\">80</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">81</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">82</span>: </div><div class=\"line\"> <span class=\"number\">83</span>:             HAConnection.log.error(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception.\"</span>, e);</div><div class=\"line\"> <span class=\"number\">84</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">85</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">87</span>: </div><div class=\"line\"> <span class=\"number\">88</span>:     <span class=\"comment\">// æ–­å¼€è¿æ¥ &amp; æš‚åœå†™çº¿ç¨‹ &amp; æš‚åœè¯»çº¿ç¨‹ &amp; é‡Šæ”¾CommitLog</span></div><div class=\"line\"> <span class=\"number\">89</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.selectMappedBufferResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"keyword\">this</span>.selectMappedBufferResult.release();</div><div class=\"line\"> <span class=\"number\">91</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:     <span class=\"keyword\">this</span>.makeStop();</div><div class=\"line\"> <span class=\"number\">94</span>: </div><div class=\"line\"> <span class=\"number\">95</span>:     readSocketService.makeStop();</div><div class=\"line\"> <span class=\"number\">96</span>: </div><div class=\"line\"> <span class=\"number\">97</span>:     haService.removeConnection(HAConnection.<span class=\"keyword\">this</span>);</div><div class=\"line\"> <span class=\"number\">98</span>: </div><div class=\"line\"> <span class=\"number\">99</span>:     SelectionKey sk = <span class=\"keyword\">this</span>.socketChannel.keyFor(<span class=\"keyword\">this</span>.selector);</div><div class=\"line\"><span class=\"number\">100</span>:     <span class=\"keyword\">if</span> (sk != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">101</span>:         sk.cancel();</div><div class=\"line\"><span class=\"number\">102</span>:     &#125;</div><div class=\"line\"><span class=\"number\">103</span>: </div><div class=\"line\"><span class=\"number\">104</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">105</span>:         <span class=\"keyword\">this</span>.selector.close();</div><div class=\"line\"><span class=\"number\">106</span>:         <span class=\"keyword\">this</span>.socketChannel.close();</div><div class=\"line\"><span class=\"number\">107</span>:     &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">108</span>:         HAConnection.log.error(<span class=\"string\">\"\"</span>, e);</div><div class=\"line\"><span class=\"number\">109</span>:     &#125;</div><div class=\"line\"><span class=\"number\">110</span>: </div><div class=\"line\"><span class=\"number\">111</span>:     HAConnection.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">112</span>: &#125;</div><div class=\"line\"><span class=\"number\">113</span>: </div><div class=\"line\"><span class=\"number\">114</span>: <span class=\"comment\">/**</span></div><div class=\"line\">115:  * ä¼ è¾“æ•°æ®</div><div class=\"line\">116:  */</div><div class=\"line\"><span class=\"number\">117</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">transferData</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</div><div class=\"line\"><span class=\"number\">118</span>:     <span class=\"keyword\">int</span> writeSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">119</span>:     <span class=\"comment\">// Write Header</span></div><div class=\"line\"><span class=\"number\">120</span>:     <span class=\"keyword\">while</span> (<span class=\"keyword\">this</span>.byteBufferHeader.hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">121</span>:         <span class=\"keyword\">int</span> writeSize = <span class=\"keyword\">this</span>.socketChannel.write(<span class=\"keyword\">this</span>.byteBufferHeader);</div><div class=\"line\"><span class=\"number\">122</span>:         <span class=\"keyword\">if</span> (writeSize &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">123</span>:             writeSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">124</span>:             <span class=\"keyword\">this</span>.lastWriteTimestamp = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class=\"line\"><span class=\"number\">125</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (writeSize == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">126</span>:             <span class=\"keyword\">if</span> (++writeSizeZeroTimes &gt;= <span class=\"number\">3</span>) &#123;</div><div class=\"line\"><span class=\"number\">127</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">128</span>:             &#125;</div><div class=\"line\"><span class=\"number\">129</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">130</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Exception(<span class=\"string\">\"ha master write header error &lt; 0\"</span>);</div><div class=\"line\"><span class=\"number\">131</span>:         &#125;</div><div class=\"line\"><span class=\"number\">132</span>:     &#125;</div><div class=\"line\"><span class=\"number\">133</span>: </div><div class=\"line\"><span class=\"number\">134</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == <span class=\"keyword\">this</span>.selectMappedBufferResult) &#123;</div><div class=\"line\"><span class=\"number\">135</span>:         <span class=\"keyword\">return</span> !<span class=\"keyword\">this</span>.byteBufferHeader.hasRemaining();</div><div class=\"line\"><span class=\"number\">136</span>:     &#125;</div><div class=\"line\"><span class=\"number\">137</span>: </div><div class=\"line\"><span class=\"number\">138</span>:     writeSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">139</span>: </div><div class=\"line\"><span class=\"number\">140</span>:     <span class=\"comment\">// Write Body</span></div><div class=\"line\"><span class=\"number\">141</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.byteBufferHeader.hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">142</span>:         <span class=\"keyword\">while</span> (<span class=\"keyword\">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">143</span>:             <span class=\"keyword\">int</span> writeSize = <span class=\"keyword\">this</span>.socketChannel.write(<span class=\"keyword\">this</span>.selectMappedBufferResult.getByteBuffer());</div><div class=\"line\"><span class=\"number\">144</span>:             <span class=\"keyword\">if</span> (writeSize &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">145</span>:                 writeSizeZeroTimes = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">146</span>:                 <span class=\"keyword\">this</span>.lastWriteTimestamp = HAConnection.<span class=\"keyword\">this</span>.haService.getDefaultMessageStore().getSystemClock().now();</div><div class=\"line\"><span class=\"number\">147</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (writeSize == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">148</span>:                 <span class=\"keyword\">if</span> (++writeSizeZeroTimes &gt;= <span class=\"number\">3</span>) &#123;</div><div class=\"line\"><span class=\"number\">149</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">150</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">151</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">152</span>:                 <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Exception(<span class=\"string\">\"ha master write body error &lt; 0\"</span>);</div><div class=\"line\"><span class=\"number\">153</span>:             &#125;</div><div class=\"line\"><span class=\"number\">154</span>:         &#125;</div><div class=\"line\"><span class=\"number\">155</span>:     &#125;</div><div class=\"line\"><span class=\"number\">156</span>: </div><div class=\"line\"><span class=\"number\">157</span>:     <span class=\"keyword\">boolean</span> result = !<span class=\"keyword\">this</span>.byteBufferHeader.hasRemaining() &amp;&amp; !<span class=\"keyword\">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining();</div><div class=\"line\"><span class=\"number\">158</span>: </div><div class=\"line\"><span class=\"number\">159</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.selectMappedBufferResult.getByteBuffer().hasRemaining()) &#123;</div><div class=\"line\"><span class=\"number\">160</span>:         <span class=\"keyword\">this</span>.selectMappedBufferResult.release();</div><div class=\"line\"><span class=\"number\">161</span>:         <span class=\"keyword\">this</span>.selectMappedBufferResult = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">162</span>:     &#125;</div><div class=\"line\"><span class=\"number\">163</span>: </div><div class=\"line\"><span class=\"number\">164</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">165</span>: &#125;</div></pre></td></tr></table></figure>\n<h3 id=\"3-1-6-Master-SYNC\"><a href=\"#3-1-6-Master-SYNC\" class=\"headerlink\" title=\"3.1.6 Master_SYNC\"></a>3.1.6 Master_SYNC</h3><ul>\n<li><strong><code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œ<code>Master_SYNC</code>èŠ‚ç‚¹ ä¼šç­‰å¾… <code>Slave</code>èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœã€‚</strong></li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> PutMessageResult <span class=\"title\">putMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// ....çœç•¥å¤„ç†å‘é€ä»£ç  </span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"comment\">// Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (BrokerRole.SYNC_MASTER == <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         HAService service = <span class=\"keyword\">this</span>.defaultMessageStore.getHaService();</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">if</span> (msg.isWaitStoreMsgOK()) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"comment\">// Determine whether to wait</span></div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">if</span> (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == request) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                     request = <span class=\"keyword\">new</span> GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</div><div class=\"line\"><span class=\"number\">12</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">13</span>:                 service.putRequest(request);</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"comment\">// å”¤é†’WriteSocketService</span></div><div class=\"line\"><span class=\"number\">16</span>:                 service.getWaitNotifyObject().wakeupAll();</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"keyword\">boolean</span> flushOK = request.waitForFlush(<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">if</span> (!flushOK) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                     log.error(<span class=\"string\">\"do sync transfer other node, wait return, but failed, topic: \"</span> + msg.getTopic() + <span class=\"string\">\" tags: \"</span></div><div class=\"line\"><span class=\"number\">21</span>:                         + msg.getTags() + <span class=\"string\">\" client address: \"</span> + msg.getBornHostString());</div><div class=\"line\"><span class=\"number\">22</span>:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);</div><div class=\"line\"><span class=\"number\">23</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">24</span>:             &#125;</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"comment\">// Slave problem</span></div><div class=\"line\"><span class=\"number\">26</span>:             <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">27</span>:                 <span class=\"comment\">// Tell the producer, slave not available</span></div><div class=\"line\"><span class=\"number\">28</span>:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">29</span>:             &#125;</div><div class=\"line\"><span class=\"number\">30</span>:         &#125;</div><div class=\"line\"><span class=\"number\">31</span>:     &#125;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"keyword\">return</span> putMessageResult;</div><div class=\"line\"><span class=\"number\">34</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ 16 è¡Œ ï¼šå”¤é†’ <code>WriteSocketService</code>ã€‚<ul>\n<li>å”¤é†’åï¼Œ<code>WriteSocketService</code> æŒ‚èµ·ç­‰å¾…æ–°æ¶ˆæ¯ç»“æŸï¼Œ<code>Master</code> ä¼ è¾“ <code>Slave</code> æ–°çš„ <code>CommitLog</code> æ•°æ®ã€‚</li>\n<li><code>Slave</code> æ”¶åˆ°æ•°æ®åï¼Œ<strong>ç«‹å³</strong>ä¸ŠæŠ¥æœ€æ–°çš„ <code>CommitLog</code> åŒæ­¥è¿›åº¦åˆ° <code>Master</code>ã€‚<code>ReadSocketService</code> å”¤é†’<strong>ç¬¬ 18 è¡Œ</strong>ï¼š<code>request#waitForFlush(...)</code>ã€‚</li>\n</ul>\n</li>\n</ul>\n<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>GroupTransferService</code> çš„æ ¸å¿ƒé€»è¾‘ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€GroupTransferService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doWaitTransfer</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.requestsRead.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">for</span> (CommitLog.GroupCommitRequest req : <span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:                 <span class=\"comment\">// ç­‰å¾…Slaveä¸Šä¼ è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">7</span>:                 <span class=\"keyword\">boolean</span> transferOK = HAService.<span class=\"keyword\">this</span>.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</div><div class=\"line\"> <span class=\"number\">8</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; !transferOK &amp;&amp; i &lt; <span class=\"number\">5</span>; i++) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:                     <span class=\"keyword\">this</span>.notifyTransferObject.waitForRunning(<span class=\"number\">1000</span>); <span class=\"comment\">// å”¤é†’</span></div><div class=\"line\"><span class=\"number\">10</span>:                     transferOK = HAService.<span class=\"keyword\">this</span>.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</div><div class=\"line\"><span class=\"number\">11</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">if</span> (!transferOK) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:                     log.warn(<span class=\"string\">\"transfer messsage to slave timeout, \"</span> + req.getNextOffset());</div><div class=\"line\"><span class=\"number\">15</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// å”¤é†’è¯·æ±‚ï¼Œå¹¶è®¾ç½®æ˜¯å¦SlaveåŒæ­¥æˆåŠŸ</span></div><div class=\"line\"><span class=\"number\">18</span>:                 req.wakeupCustomer(transferOK);</div><div class=\"line\"><span class=\"number\">19</span>:             &#125;</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"keyword\">this</span>.requestsRead.clear();</div><div class=\"line\"><span class=\"number\">22</span>:         &#125;</div><div class=\"line\"><span class=\"number\">23</span>:     &#125;</div><div class=\"line\"><span class=\"number\">24</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"3-2-Producer-å‘é€æ¶ˆæ¯\"><a href=\"#3-2-Producer-å‘é€æ¶ˆæ¯\" class=\"headerlink\" title=\"3.2 Producer å‘é€æ¶ˆæ¯\"></a>3.2 Producer å‘é€æ¶ˆæ¯</h2><ul>\n<li><strong><code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ <code>Broker</code>é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚</strong></li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> SendResult <span class=\"title\">sendDefaultImpl</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">3</span>:     Message msg, //</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode, //</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> SendCallback sendCallback, //</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeout//</div><div class=\"line\"> <span class=\"number\">7</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€æ ¡éªŒé€»è¾‘ã€‘</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"comment\">// è·å– Topicè·¯ç”±ä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">10</span>:     TopicPublishInfo topicPublishInfo = <span class=\"keyword\">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">if</span> (topicPublishInfo != <span class=\"keyword\">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         MessageQueue mq = <span class=\"keyword\">null</span>; <span class=\"comment\">// æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">13</span>:         Exception exception = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">14</span>:         SendResult sendResult = <span class=\"keyword\">null</span>; <span class=\"comment\">// æœ€åä¸€æ¬¡å‘é€ç»“æœ</span></div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"keyword\">int</span> timesTotal = communicationMode == CommunicationMode.SYNC ? <span class=\"number\">1</span> + <span class=\"keyword\">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class=\"number\">1</span>; <span class=\"comment\">// åŒæ­¥å¤šæ¬¡è°ƒç”¨</span></div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">int</span> times = <span class=\"number\">0</span>; <span class=\"comment\">// ç¬¬å‡ æ¬¡å‘é€</span></div><div class=\"line\"><span class=\"number\">17</span>:         String[] brokersSent = <span class=\"keyword\">new</span> String[timesTotal]; <span class=\"comment\">// å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå</span></div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"comment\">// å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">for</span> (; times &lt; timesTotal; times++) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             String lastBrokerName = <span class=\"keyword\">null</span> == mq ? <span class=\"keyword\">null</span> : mq.getBrokerName();</div><div class=\"line\"><span class=\"number\">21</span>:             MessageQueue tmpmq = <span class=\"keyword\">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName); <span class=\"comment\">// é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">if</span> (tmpmq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:                 mq = tmpmq;</div><div class=\"line\"><span class=\"number\">24</span>:                 brokersSent[times] = mq.getBrokerName();</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                     beginTimestampPrev = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">27</span>:                     <span class=\"comment\">// è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</span></div><div class=\"line\"><span class=\"number\">28</span>:                     sendResult = <span class=\"keyword\">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);</div><div class=\"line\"><span class=\"number\">29</span>:                     endTimestamp = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"comment\">// æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">31</span>:                     <span class=\"keyword\">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">32</span>:                     <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘</span></div><div class=\"line\"><span class=\"number\">33</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">34</span>:                 &#125; <span class=\"keyword\">catch</span> (e) &#123; <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€å¼‚å¸¸ã€‘</span></div><div class=\"line\"><span class=\"number\">35</span>:                     </div><div class=\"line\"><span class=\"number\">36</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">37</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">39</span>:             &#125;</div><div class=\"line\"><span class=\"number\">40</span>:         &#125;</div><div class=\"line\"><span class=\"number\">41</span>:         <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘</span></div><div class=\"line\"><span class=\"number\">42</span>:     &#125;</div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"comment\">// .... çœç•¥ï¼šå¤„ç†ã€æ‰¾ä¸åˆ°æ¶ˆæ¯è·¯ç”±ã€‘</span></div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<p>å¦‚ä¸‹æ˜¯è°ƒè¯• <code>#sendDefaultImpl(...)</code> æ—¶ <code>TopicPublishInfo</code> çš„ç»“æœï¼Œ<code>Producer</code> è·å¾—åˆ°äº† <code>broker-a</code>,<code>broker-b</code> ä¸¤ä¸ª <code>Broker</code>åˆ†ç»„ çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š<br><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/Producer.TopicPublishInfo.è°ƒè¯•.png\" alt=\"Producer.TopicPublishInfo.è°ƒè¯•.png\"></p>\n<h2 id=\"3-3-Consumer-æ¶ˆè´¹æ¶ˆæ¯\"><a href=\"#3-3-Consumer-æ¶ˆè´¹æ¶ˆæ¯\" class=\"headerlink\" title=\"3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯\"></a>3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯</h2><ul>\n<li><strong><code>Consumer</code> æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ <code>Broker</code>é›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚</strong></li>\n</ul>\n<h1 id=\"4-æ€»ç»“\"><a href=\"#4-æ€»ç»“\" class=\"headerlink\" title=\"4. æ€»ç»“\"></a>4. æ€»ç»“</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1009/HAæ€»ç»“.jpeg\" alt=\"HAæ€»ç»“.jpeg\"></p>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” Filtersrv","date":"2017-05-16T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šFiltersrv](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1008-RocketMQæºç è§£æï¼šFiltersrv.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. Filtersrv æ³¨å†Œåˆ° Broker](#)\n- [3. è¿‡æ»¤ç±»](#)\n\t- [3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç ](#)\n\t- [3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç ](#)\n\t- [3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç ](#)\n- [4. è¿‡æ»¤æ¶ˆæ¯](#)\n\t- [4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯](#)\n\t- [4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯](#)\n- [5. Filtersrv é«˜å¯ç”¨](#)\n\n# 1. æ¦‚è¿°\n\n`Filtersrv` ï¼Œè´Ÿè´£**è‡ªå®šä¹‰è§„åˆ™**è¿‡æ»¤ `Consumer` ä» `Broker` æ‹‰å–çš„æ¶ˆæ¯ã€‚\n\n![Filtersrv.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrv.png)\n\nä¸ºä»€ä¹ˆ `Broker` ä¸æä¾›è¿‡æ»¤æ¶ˆæ¯çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹å®˜æ–¹çš„è¯´æ³•ï¼š\n\n> * Broker ç«¯æ¶ˆæ¯è¿‡æ»¤  \n>  åœ¨ Broker ä¸­ï¼ŒæŒ‰ç…§ Consumer çš„è¦æ±‚åšè¿‡æ»¤ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ã€‚ ç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ï¼Œå®ç°ç›¸å¯¹å¤æ‚ã€‚  \n> (1). æ·˜å® Notify æ”¯æŒå¤šç§è¿‡æ»¤æ–¹å¼ï¼ŒåŒ…å«ç›´æ¥æŒ‰ç…§æ¶ˆæ¯ç±»å‹è¿‡æ»¤ï¼Œçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ï¼Œå‡ ä¹å¯ä»¥æ»¡è¶³æœ€è‹›åˆ»çš„è¿‡æ»¤éœ€æ±‚ã€‚  \n> (2). æ·˜å® RocketMQ æ”¯æŒæŒ‰ç…§ç®€å•çš„ Message Tag è¿‡æ»¤ï¼Œä¹Ÿæ”¯æŒæŒ‰ç…§ Message Headerã€body è¿›è¡Œè¿‡æ»¤ã€‚  \n(3). CORBA Notification è§„èŒƒä¸­ä¹Ÿæ”¯æŒçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ã€‚  \n> * Consumer ç«¯æ¶ˆæ¯è¿‡æ»¤  \n> è¿™ç§è¿‡æ»¤æ–¹å¼å¯ç”±åº”ç”¨å®Œå…¨è‡ªå®šä¹‰å®ç°ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯å¾ˆå¤šæ— ç”¨çš„æ¶ˆæ¯è¦ä¼ è¾“åˆ° Consumer ç«¯ã€‚\n\n**å°±æ˜¯åœ¨è¿™ç§è€ƒè™‘ä¸‹ï¼Œ`Filtersrv` å‡ºç°äº†ã€‚å‡å°‘äº† `Broker` çš„è´Ÿæ‹…ï¼Œåˆå‡å°‘äº† `Consumer` æ¥æ”¶æ— ç”¨çš„æ¶ˆæ¯ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œå¤šäº†ä¸€å±‚ `Filtersrv` ç½‘ç»œå¼€é”€ã€‚**\n \n# 2. Filtersrv æ³¨å†Œåˆ° Broker\n\n* ğŸ¦… ä¸€ä¸ª `Filtersrv` **åª**å¯¹åº”ä¸€ä¸ª `Broker`ã€‚\n* ğŸ¦… ä¸€ä¸ª `Broker` å¯ä»¥å¯¹åº”**å¤šä¸ª** `Filtersrv`ã€‚**`Filtersrv` çš„é«˜å¯ç”¨é€šè¿‡å¯åŠ¨å¤šä¸ª `Filtersrv` å®ç°**ã€‚\n* ğŸ¦… `Filtersrv` æ³¨å†Œå¤±è´¥æ—¶ï¼Œä¸»åŠ¨**é€€å‡ºå…³é—­**ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FiltersrvController.javaã€‘\n  2: public boolean initialize() {\n  3:     // ....(çœç•¥ä»£ç )\n  4: \n  5:     // å›ºå®šé—´éš”æ³¨å†Œåˆ°Broker\n  6:     this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n  7: \n  8:         @Override\n  9:         public void run() {\n 10:             FiltersrvController.this.registerFilterServerToBroker();\n 11:         }\n 12:     }, 15, 10, TimeUnit.SECONDS); // TODO edit by èŠ‹è‰¿ï¼šinitialDelayæ—¶é—´å¤ªçŸ­ï¼Œå¯èƒ½å¯¼è‡´åˆå§‹åŒ–å¤±è´¥ã€‚ä»3=ã€‹15\n 13: \n 14:     // ....(çœç•¥ä»£ç )\n 15: }\n 16: \n 17: /**\n 18:  * æ³¨å†ŒFiltersrv åˆ° Broker\n 19:  * ï¼ï¼ï¼å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œå…³é—­Filtersrv\n 20:  */\n 21: public void registerFilterServerToBroker() {\n 22:     try {\n 23:         RegisterFilterServerResponseHeader responseHeader =\n 24:             this.filterServerOuterAPI.registerFilterServerToBroker(\n 25:                 this.filtersrvConfig.getConnectWhichBroker(), this.localAddr());\n 26:         this.defaultMQPullConsumer.getDefaultMQPullConsumerImpl().getPullAPIWrapper()\n 27:             .setDefaultBrokerId(responseHeader.getBrokerId());\n 28: \n 29:         if (null == this.brokerName) {\n 30:             this.brokerName = responseHeader.getBrokerName();\n 31:         }\n 32: \n 33:         log.info(\"register filter server<{}> to broker<{}> OK, Return: {} {}\",\n 34:             this.localAddr(),\n 35:             this.filtersrvConfig.getConnectWhichBroker(),\n 36:             responseHeader.getBrokerName(),\n 37:             responseHeader.getBrokerId());\n 38:     } catch (Exception e) {\n 39:         log.warn(\"register filter server Exception\", e);\n 40: \n 41:         log.warn(\"access broker failed, kill oneself\");\n 42:         System.exit(-1); // å¼‚å¸¸é€€å‡º\n 43:     }\n 44: }\n```\n\n# 3. è¿‡æ»¤ç±» \n\n![Filtersrvè¿‡æ»¤ç±»](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrvè¿‡æ»¤ç±».png)\n\n## 3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç \n\n* ğŸ¦… `Consumer` é’ˆå¯¹æ¯ä¸ª `Topic` å¯ä»¥è®¢é˜…ä¸åŒçš„ `è¿‡æ»¤ç±»ä»£ç `ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQPushConsumer.javaã€‘\n  2: @Override\n  3: public void subscribe(String topic, String fullClassName, String filterClassSource) throws MQClientException {\n  4:     this.defaultMQPushConsumerImpl.subscribe(topic, fullClassName, filterClassSource);\n  5: }\n```\n\n## 3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç \n\n* ğŸ¦… `Consumer` å¿ƒè·³æ³¨å†Œåˆ° `Broker` çš„åŒæ—¶ï¼Œä¸Šä¼  `è¿‡æ»¤ç±»ä»£ç ` åˆ° `Broker` å¯¹åº”çš„**æ‰€æœ‰** `Filtersrv`ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MQClientInstance.javaã€‘\n  2: /**\n  3:  * å‘é€å¿ƒè·³åˆ°Brokerï¼Œä¸Šä¼ è¿‡æ»¤ç±»æºç åˆ°Filtersrv\n  4:  */\n  5: public void sendHeartbeatToAllBrokerWithLock() {\n  6:     if (this.lockHeartbeat.tryLock()) {\n  7:         try {\n  8:             this.sendHeartbeatToAllBroker();\n  9:             this.uploadFilterClassSource();\n 10:         } catch (final Exception e) {\n 11:             log.error(\"sendHeartbeatToAllBroker exception\", e);\n 12:         } finally {\n 13:             this.lockHeartbeat.unlock();\n 14:         }\n 15:     } else {\n 16:         log.warn(\"lock heartBeat, but failed.\");\n 17:     }\n 18: }\n 19: \n 20: /**\n 21:  * ä¸Šä¼ è¿‡æ»¤ç±»åˆ°Filtersrv\n 22:  */\n 23: private void uploadFilterClassSource() {\n 24:     Iterator<Entry<String, MQConsumerInner>> it = this.consumerTable.entrySet().iterator();\n 25:     while (it.hasNext()) {\n 26:         Entry<String, MQConsumerInner> next = it.next();\n 27:         MQConsumerInner consumer = next.getValue();\n 28:         if (ConsumeType.CONSUME_PASSIVELY == consumer.consumeType()) {\n 29:             Set<SubscriptionData> subscriptions = consumer.subscriptions();\n 30:             for (SubscriptionData sub : subscriptions) {\n 31:                 if (sub.isClassFilterMode() && sub.getFilterClassSource() != null) {\n 32:                     final String consumerGroup = consumer.groupName();\n 33:                     final String className = sub.getSubString();\n 34:                     final String topic = sub.getTopic();\n 35:                     final String filterClassSource = sub.getFilterClassSource();\n 36:                     try {\n 37:                         this.uploadFilterClassToAllFilterServer(consumerGroup, className, topic, filterClassSource);\n 38:                     } catch (Exception e) {\n 39:                         log.error(\"uploadFilterClassToAllFilterServer Exception\", e);\n 40:                     }\n 41:                 }\n 42:             }\n 43:         }\n 44:     }\n 45: }\n```\n\n## 3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç \n\n* ğŸ¦… `Filtersrv` å¤„ç† `Consumer` ä¸Šä¼ çš„ `è¿‡æ»¤ç±»ä»£ç `ï¼Œå¹¶è¿›è¡Œ**ç¼–è¯‘**ä½¿ç”¨ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FilterClassManager.javaã€‘\n  2: /**\n  3:  * æ³¨å†Œè¿‡æ»¤ç±»\n  4:  *\n  5:  * @param consumerGroup æ¶ˆè´¹åˆ†ç»„\n  6:  * @param topic Topic\n  7:  * @param className è¿‡æ»¤ç±»å\n  8:  * @param classCRC è¿‡æ»¤ç±»æºç CRC\n  9:  * @param filterSourceBinary è¿‡æ»¤ç±»æºç \n 10:  * @return æ˜¯å¦æ³¨å†ŒæˆåŠŸ\n 11:  */\n 12: public boolean registerFilterClass(final String consumerGroup, final String topic,\n 13:     final String className, final int classCRC, final byte[] filterSourceBinary) {\n 14:     final String key = buildKey(consumerGroup, topic);\n 15:     // åˆ¤æ–­æ˜¯å¦è¦æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»\n 16:     boolean registerNew = false;\n 17:     FilterClassInfo filterClassInfoPrev = this.filterClassTable.get(key);\n 18:     if (null == filterClassInfoPrev) {\n 19:         registerNew = true;\n 20:     } else {\n 21:         if (this.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) {\n 22:             if (filterClassInfoPrev.getClassCRC() != classCRC && classCRC != 0) { // ç±»æœ‰å˜åŒ–\n 23:                 registerNew = true;\n 24:             }\n 25:         }\n 26:     }\n 27:     // æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»\n 28:     if (registerNew) {\n 29:         synchronized (this.compileLock) {\n 30:             filterClassInfoPrev = this.filterClassTable.get(key);\n 31:             if (null != filterClassInfoPrev && filterClassInfoPrev.getClassCRC() == classCRC) {\n 32:                 return true;\n 33:             }\n 34:             try {\n 35:                 FilterClassInfo filterClassInfoNew = new FilterClassInfo();\n 36:                 filterClassInfoNew.setClassName(className);\n 37:                 filterClassInfoNew.setClassCRC(0);\n 38:                 filterClassInfoNew.setMessageFilter(null);\n 39: \n 40:                 if (this.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) {\n 41:                     String javaSource = new String(filterSourceBinary, MixAll.DEFAULT_CHARSET);\n 42:                     // ç¼–è¯‘æ–°çš„è¿‡æ»¤ç±»\n 43:                     Class<?> newClass = DynaCode.compileAndLoadClass(className, javaSource);\n 44:                     // åˆ›å»ºæ–°çš„è¿‡æ»¤ç±»å¯¹è±¡\n 45:                     Object newInstance = newClass.newInstance();\n 46:                     filterClassInfoNew.setMessageFilter((MessageFilter) newInstance);\n 47:                     filterClassInfoNew.setClassCRC(classCRC);\n 48:                 }\n 49: \n 50:                 this.filterClassTable.put(key, filterClassInfoNew);\n 51:             } catch (Throwable e) {\n 52:                 String info = String.format(\"FilterServer, registerFilterClass Exception, consumerGroup: %s topic: %s className: %s\",\n 53:                             consumerGroup, topic, className);\n 54:                 log.error(info, e);\n 55:                 return false;\n 56:             }\n 57:         }\n 58:     }\n 59: \n 60:     return true;\n 61: }\n```\n\n-------\n\n# 4. è¿‡æ»¤æ¶ˆæ¯\n\n![Filtersrv.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrv.png)\n\n## 4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯\n\n* ğŸ¦… `Consumer` æ‹‰å– **ä½¿ç”¨è¿‡æ»¤ç±»æ–¹å¼è®¢é˜…** çš„æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä» `Broker` å¯¹åº”çš„ `Filtersrv` åˆ—è¡¨**éšæœº**é€‰æ‹©ä¸€ä¸ªæ‹‰å–æ¶ˆæ¯ã€‚**å¦‚æœé€‰æ‹©ä¸åˆ° `Filtersrv`ï¼Œåˆ™æ— æ³•æ‹‰å–æ¶ˆæ¯ã€‚å› æ­¤ï¼Œ`Filtersrv` ä¸€å®šè¦åšé«˜å¯ç”¨**ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€PullAPIWrapper.javaã€‘\n  2: /**\n  3:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•\n  4:  *\n  5:  * @param mq æ¶ˆæ¯å˜Ÿåˆ—\n  6:  * @param subExpression è®¢é˜…è¡¨è¾¾å¼\n  7:  * @param subVersion è®¢é˜…ç‰ˆæœ¬å·\n  8:  * @param offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®\n  9:  * @param maxNums æ‰¹é‡æ‹‰ å–æ¶ˆæ¯æ•°é‡\n 10:  * @param sysFlag æ‹‰å–ç³»ç»Ÿæ ‡è¯†\n 11:  * @param commitOffset æäº¤æ¶ˆè´¹è¿›åº¦\n 12:  * @param brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´\n 13:  * @param timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é—´\n 14:  * @param communicationMode é€šè®¯æ¨¡å¼\n 15:  * @param pullCallback æ‹‰å–å›è°ƒ\n 16:  * @return æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚\n 17:  * @throws MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸\n 18:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶\n 19:  * @throws MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚\n 20:  * @throws InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶\n 21:  */\n 22: protected PullResult pullKernelImpl(\n 23:     final MessageQueue mq,\n 24:     final String subExpression,\n 25:     final long subVersion,\n 26:     final long offset,\n 27:     final int maxNums,\n 28:     final int sysFlag,\n 29:     final long commitOffset,\n 30:     final long brokerSuspendMaxTimeMillis,\n 31:     final long timeoutMillis,\n 32:     final CommunicationMode communicationMode,\n 33:     final PullCallback pullCallback\n 34: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n 35:     // // ....(çœç•¥ä»£ç )\n 36:     // è¯·æ±‚æ‹‰å–æ¶ˆæ¯\n 37:     if (findBrokerResult != null) {\n 38:         // ....(çœç•¥ä»£ç )\n 39:         // è‹¥è®¢é˜…topicä½¿ç”¨è¿‡æ»¤ç±»ï¼Œä½¿ç”¨filtersrvè·å–æ¶ˆæ¯\n 40:         String brokerAddr = findBrokerResult.getBrokerAddr();\n 41:         if (PullSysFlag.hasClassFilterFlag(sysFlagInner)) {\n 42:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);\n 43:         }\n 44: \n 45:         PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage(\n 46:             brokerAddr,\n 47:             requestHeader,\n 48:             timeoutMillis,\n 49:             communicationMode,\n 50:             pullCallback);\n 51: \n 52:         return pullResult;\n 53:     }\n 54: \n 55:     // Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n 56:     throw new MQClientException(\"The broker[\" + mq.getBrokerName() + \"] not exist\", null);\n 57: }\n 58: \n 59: /**\n 60:  * è®¡ç®—filtersrvåœ°å€ã€‚å¦‚æœæœ‰å¤šä¸ªfiltersrvï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªã€‚\n 61:  *\n 62:  * @param topic Topic\n 63:  * @param brokerAddr brokeråœ°å€\n 64:  * @return filtersrvåœ°å€\n 65:  * @throws MQClientException å½“filtersrvä¸å­˜åœ¨æ—¶\n 66:  */\n 67: private String computPullFromWhichFilterServer(final String topic, final String brokerAddr)\n 68:     throws MQClientException {\n 69:     ConcurrentHashMap<String, TopicRouteData> topicRouteTable = this.mQClientFactory.getTopicRouteTable();\n 70:     if (topicRouteTable != null) {\n 71:         TopicRouteData topicRouteData = topicRouteTable.get(topic);\n 72:         List<String> list = topicRouteData.getFilterServerTable().get(brokerAddr);\n 73:         if (list != null && !list.isEmpty()) {\n 74:             return list.get(randomNum() % list.size());\n 75:         }\n 76:     }\n 77:     throw new MQClientException(\"Find Filter Server Failed, Broker Addr: \" + brokerAddr + \" topic: \"\n 78:         + topic, null);\n 79: }\n```\n\n## 4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯\n\n* ğŸ¦… `Filtersrv` æ‹‰å–æ¶ˆæ¯åï¼Œä¼šå»ºè®® `Consumer` å‘ `Brokerä¸»èŠ‚ç‚¹` æ‹‰å–æ¶ˆæ¯ã€‚\n* ğŸ¦… `Filtersrv` å¯ä»¥ç†è§£æˆä¸€ä¸ª `Consumer`ï¼Œå‘ `Broker` æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå®é™…ä½¿ç”¨çš„ `DefaultMQPullConsumer.java` çš„æ–¹æ³•å’Œé€»è¾‘ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultRequestProcessor.javaã€‘\n  2: /**\n  3:  * æ‹‰å–æ¶ˆæ¯\n  4:  *\n  5:  * @param ctx æ‹‰å–æ¶ˆæ¯context\n  6:  * @param request æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n  7:  * @return å“åº”\n  8:  * @throws Exception å½“å‘ç”Ÿå¼‚å¸¸æ—¶\n  9:  */\n 10: private RemotingCommand pullMessageForward(final ChannelHandlerContext ctx, final RemotingCommand request) throws Exception {\n 11:     final RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);\n 12:     final PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();\n 13:     final PullMessageRequestHeader requestHeader =\n 14:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);\n 15: \n 16:     final FilterContext filterContext = new FilterContext();\n 17:     filterContext.setConsumerGroup(requestHeader.getConsumerGroup());\n 18: \n 19:     response.setOpaque(request.getOpaque());\n 20: \n 21:     DefaultMQPullConsumer pullConsumer = this.filtersrvController.getDefaultMQPullConsumer();\n 22: \n 23:     // æ ¡éªŒTopicè¿‡æ»¤ç±»æ˜¯å¦å®Œæ•´\n 24:     final FilterClassInfo findFilterClass = this.filtersrvController.getFilterClassManager().findFilterClass(requestHeader.getConsumerGroup(), requestHeader.getTopic());\n 25:     if (null == findFilterClass) {\n 26:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 27:         response.setRemark(\"Find Filter class failed, not registered\");\n 28:         return response;\n 29:     }\n 30:     if (null == findFilterClass.getMessageFilter()) {\n 31:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 32:         response.setRemark(\"Find Filter class failed, registered but no class\");\n 33:         return response;\n 34:     }\n 35: \n 36:     // è®¾ç½®ä¸‹æ¬¡è¯·æ±‚ä» Brokerä¸»èŠ‚ç‚¹ã€‚\n 37:     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n 38: \n 39:     MessageQueue mq = new MessageQueue();\n 40:     mq.setTopic(requestHeader.getTopic());\n 41:     mq.setQueueId(requestHeader.getQueueId());\n 42:     mq.setBrokerName(this.filtersrvController.getBrokerName());\n 43:     long offset = requestHeader.getQueueOffset();\n 44:     int maxNums = requestHeader.getMaxMsgNums();\n 45: \n 46:     final PullCallback pullCallback = new PullCallback() {\n 47: \n 48:         @Override\n 49:         public void onSuccess(PullResult pullResult) {\n 50:             responseHeader.setMaxOffset(pullResult.getMaxOffset());\n 51:             responseHeader.setMinOffset(pullResult.getMinOffset());\n 52:             responseHeader.setNextBeginOffset(pullResult.getNextBeginOffset());\n 53:             response.setRemark(null);\n 54: \n 55:             switch (pullResult.getPullStatus()) {\n 56:                 case FOUND:\n 57:                     response.setCode(ResponseCode.SUCCESS);\n 58: \n 59:                     List<MessageExt> msgListOK = new ArrayList<MessageExt>();\n 60:                     try {\n 61:                         for (MessageExt msg : pullResult.getMsgFoundList()) {\n 62:                             // ä½¿ç”¨è¿‡æ»¤ç±»è¿‡æ»¤æ¶ˆæ¯\n 63:                             boolean match = findFilterClass.getMessageFilter().match(msg, filterContext);\n 64:                             if (match) {\n 65:                                 msgListOK.add(msg);\n 66:                             }\n 67:                         }\n 68: \n 69:                         if (!msgListOK.isEmpty()) {\n 70:                             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, msgListOK);\n 71:                             return;\n 72:                         } else {\n 73:                             response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n 74:                         }\n 75:                     } catch (Throwable e) {\n 76:                         final String error =\n 77:                             String.format(\"do Message Filter Exception, ConsumerGroup: %s Topic: %s \",\n 78:                                 requestHeader.getConsumerGroup(), requestHeader.getTopic());\n 79:                         log.error(error, e);\n 80: \n 81:                         response.setCode(ResponseCode.SYSTEM_ERROR);\n 82:                         response.setRemark(error + RemotingHelper.exceptionSimpleDesc(e));\n 83:                         returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);\n 84:                         return;\n 85:                     }\n 86: \n 87:                     break;\n 88:                 case NO_MATCHED_MSG:\n 89:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n 90:                     break;\n 91:                 case NO_NEW_MSG:\n 92:                     response.setCode(ResponseCode.PULL_NOT_FOUND);\n 93:                     break;\n 94:                 case OFFSET_ILLEGAL:\n 95:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n 96:                     break;\n 97:                 default:\n 98:                     break;\n 99:             }\n100: \n101:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);\n102:         }\n103: \n104:         @Override\n105:         public void onException(Throwable e) {\n106:             response.setCode(ResponseCode.SYSTEM_ERROR);\n107:             response.setRemark(\"Pull Callback Exception, \" + RemotingHelper.exceptionSimpleDesc(e));\n108:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);\n109:             return;\n110:         }\n111:     };\n112: \n113:     // æ‹‰å–æ¶ˆæ¯\n114:     pullConsumer.pullBlockIfNotFound(mq, null, offset, maxNums, pullCallback);\n115:     return null;\n116: }\n``` \n\n# 5. Filtersrv é«˜å¯ç”¨\n\n![Filtersrvè¿‡å¯ç”¨](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrvè¿‡å¯ç”¨.png)\n\n\n","source":"_posts/RocketMQ/2017_05_17_RocketMQæºç åˆ†æâ€”â€”Filtersrv.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Filtersrv\ndate: 2017-05-17\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/filtersrv\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šFiltersrv](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1008-RocketMQæºç è§£æï¼šFiltersrv.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. Filtersrv æ³¨å†Œåˆ° Broker](#)\n- [3. è¿‡æ»¤ç±»](#)\n\t- [3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç ](#)\n\t- [3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç ](#)\n\t- [3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç ](#)\n- [4. è¿‡æ»¤æ¶ˆæ¯](#)\n\t- [4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯](#)\n\t- [4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯](#)\n- [5. Filtersrv é«˜å¯ç”¨](#)\n\n# 1. æ¦‚è¿°\n\n`Filtersrv` ï¼Œè´Ÿè´£**è‡ªå®šä¹‰è§„åˆ™**è¿‡æ»¤ `Consumer` ä» `Broker` æ‹‰å–çš„æ¶ˆæ¯ã€‚\n\n![Filtersrv.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrv.png)\n\nä¸ºä»€ä¹ˆ `Broker` ä¸æä¾›è¿‡æ»¤æ¶ˆæ¯çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹å®˜æ–¹çš„è¯´æ³•ï¼š\n\n> * Broker ç«¯æ¶ˆæ¯è¿‡æ»¤  \n>  åœ¨ Broker ä¸­ï¼ŒæŒ‰ç…§ Consumer çš„è¦æ±‚åšè¿‡æ»¤ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ã€‚ ç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ï¼Œå®ç°ç›¸å¯¹å¤æ‚ã€‚  \n> (1). æ·˜å® Notify æ”¯æŒå¤šç§è¿‡æ»¤æ–¹å¼ï¼ŒåŒ…å«ç›´æ¥æŒ‰ç…§æ¶ˆæ¯ç±»å‹è¿‡æ»¤ï¼Œçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ï¼Œå‡ ä¹å¯ä»¥æ»¡è¶³æœ€è‹›åˆ»çš„è¿‡æ»¤éœ€æ±‚ã€‚  \n> (2). æ·˜å® RocketMQ æ”¯æŒæŒ‰ç…§ç®€å•çš„ Message Tag è¿‡æ»¤ï¼Œä¹Ÿæ”¯æŒæŒ‰ç…§ Message Headerã€body è¿›è¡Œè¿‡æ»¤ã€‚  \n(3). CORBA Notification è§„èŒƒä¸­ä¹Ÿæ”¯æŒçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ã€‚  \n> * Consumer ç«¯æ¶ˆæ¯è¿‡æ»¤  \n> è¿™ç§è¿‡æ»¤æ–¹å¼å¯ç”±åº”ç”¨å®Œå…¨è‡ªå®šä¹‰å®ç°ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯å¾ˆå¤šæ— ç”¨çš„æ¶ˆæ¯è¦ä¼ è¾“åˆ° Consumer ç«¯ã€‚\n\n**å°±æ˜¯åœ¨è¿™ç§è€ƒè™‘ä¸‹ï¼Œ`Filtersrv` å‡ºç°äº†ã€‚å‡å°‘äº† `Broker` çš„è´Ÿæ‹…ï¼Œåˆå‡å°‘äº† `Consumer` æ¥æ”¶æ— ç”¨çš„æ¶ˆæ¯ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œå¤šäº†ä¸€å±‚ `Filtersrv` ç½‘ç»œå¼€é”€ã€‚**\n \n# 2. Filtersrv æ³¨å†Œåˆ° Broker\n\n* ğŸ¦… ä¸€ä¸ª `Filtersrv` **åª**å¯¹åº”ä¸€ä¸ª `Broker`ã€‚\n* ğŸ¦… ä¸€ä¸ª `Broker` å¯ä»¥å¯¹åº”**å¤šä¸ª** `Filtersrv`ã€‚**`Filtersrv` çš„é«˜å¯ç”¨é€šè¿‡å¯åŠ¨å¤šä¸ª `Filtersrv` å®ç°**ã€‚\n* ğŸ¦… `Filtersrv` æ³¨å†Œå¤±è´¥æ—¶ï¼Œä¸»åŠ¨**é€€å‡ºå…³é—­**ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FiltersrvController.javaã€‘\n  2: public boolean initialize() {\n  3:     // ....(çœç•¥ä»£ç )\n  4: \n  5:     // å›ºå®šé—´éš”æ³¨å†Œåˆ°Broker\n  6:     this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n  7: \n  8:         @Override\n  9:         public void run() {\n 10:             FiltersrvController.this.registerFilterServerToBroker();\n 11:         }\n 12:     }, 15, 10, TimeUnit.SECONDS); // TODO edit by èŠ‹è‰¿ï¼šinitialDelayæ—¶é—´å¤ªçŸ­ï¼Œå¯èƒ½å¯¼è‡´åˆå§‹åŒ–å¤±è´¥ã€‚ä»3=ã€‹15\n 13: \n 14:     // ....(çœç•¥ä»£ç )\n 15: }\n 16: \n 17: /**\n 18:  * æ³¨å†ŒFiltersrv åˆ° Broker\n 19:  * ï¼ï¼ï¼å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œå…³é—­Filtersrv\n 20:  */\n 21: public void registerFilterServerToBroker() {\n 22:     try {\n 23:         RegisterFilterServerResponseHeader responseHeader =\n 24:             this.filterServerOuterAPI.registerFilterServerToBroker(\n 25:                 this.filtersrvConfig.getConnectWhichBroker(), this.localAddr());\n 26:         this.defaultMQPullConsumer.getDefaultMQPullConsumerImpl().getPullAPIWrapper()\n 27:             .setDefaultBrokerId(responseHeader.getBrokerId());\n 28: \n 29:         if (null == this.brokerName) {\n 30:             this.brokerName = responseHeader.getBrokerName();\n 31:         }\n 32: \n 33:         log.info(\"register filter server<{}> to broker<{}> OK, Return: {} {}\",\n 34:             this.localAddr(),\n 35:             this.filtersrvConfig.getConnectWhichBroker(),\n 36:             responseHeader.getBrokerName(),\n 37:             responseHeader.getBrokerId());\n 38:     } catch (Exception e) {\n 39:         log.warn(\"register filter server Exception\", e);\n 40: \n 41:         log.warn(\"access broker failed, kill oneself\");\n 42:         System.exit(-1); // å¼‚å¸¸é€€å‡º\n 43:     }\n 44: }\n```\n\n# 3. è¿‡æ»¤ç±» \n\n![Filtersrvè¿‡æ»¤ç±»](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrvè¿‡æ»¤ç±».png)\n\n## 3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç \n\n* ğŸ¦… `Consumer` é’ˆå¯¹æ¯ä¸ª `Topic` å¯ä»¥è®¢é˜…ä¸åŒçš„ `è¿‡æ»¤ç±»ä»£ç `ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQPushConsumer.javaã€‘\n  2: @Override\n  3: public void subscribe(String topic, String fullClassName, String filterClassSource) throws MQClientException {\n  4:     this.defaultMQPushConsumerImpl.subscribe(topic, fullClassName, filterClassSource);\n  5: }\n```\n\n## 3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç \n\n* ğŸ¦… `Consumer` å¿ƒè·³æ³¨å†Œåˆ° `Broker` çš„åŒæ—¶ï¼Œä¸Šä¼  `è¿‡æ»¤ç±»ä»£ç ` åˆ° `Broker` å¯¹åº”çš„**æ‰€æœ‰** `Filtersrv`ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MQClientInstance.javaã€‘\n  2: /**\n  3:  * å‘é€å¿ƒè·³åˆ°Brokerï¼Œä¸Šä¼ è¿‡æ»¤ç±»æºç åˆ°Filtersrv\n  4:  */\n  5: public void sendHeartbeatToAllBrokerWithLock() {\n  6:     if (this.lockHeartbeat.tryLock()) {\n  7:         try {\n  8:             this.sendHeartbeatToAllBroker();\n  9:             this.uploadFilterClassSource();\n 10:         } catch (final Exception e) {\n 11:             log.error(\"sendHeartbeatToAllBroker exception\", e);\n 12:         } finally {\n 13:             this.lockHeartbeat.unlock();\n 14:         }\n 15:     } else {\n 16:         log.warn(\"lock heartBeat, but failed.\");\n 17:     }\n 18: }\n 19: \n 20: /**\n 21:  * ä¸Šä¼ è¿‡æ»¤ç±»åˆ°Filtersrv\n 22:  */\n 23: private void uploadFilterClassSource() {\n 24:     Iterator<Entry<String, MQConsumerInner>> it = this.consumerTable.entrySet().iterator();\n 25:     while (it.hasNext()) {\n 26:         Entry<String, MQConsumerInner> next = it.next();\n 27:         MQConsumerInner consumer = next.getValue();\n 28:         if (ConsumeType.CONSUME_PASSIVELY == consumer.consumeType()) {\n 29:             Set<SubscriptionData> subscriptions = consumer.subscriptions();\n 30:             for (SubscriptionData sub : subscriptions) {\n 31:                 if (sub.isClassFilterMode() && sub.getFilterClassSource() != null) {\n 32:                     final String consumerGroup = consumer.groupName();\n 33:                     final String className = sub.getSubString();\n 34:                     final String topic = sub.getTopic();\n 35:                     final String filterClassSource = sub.getFilterClassSource();\n 36:                     try {\n 37:                         this.uploadFilterClassToAllFilterServer(consumerGroup, className, topic, filterClassSource);\n 38:                     } catch (Exception e) {\n 39:                         log.error(\"uploadFilterClassToAllFilterServer Exception\", e);\n 40:                     }\n 41:                 }\n 42:             }\n 43:         }\n 44:     }\n 45: }\n```\n\n## 3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç \n\n* ğŸ¦… `Filtersrv` å¤„ç† `Consumer` ä¸Šä¼ çš„ `è¿‡æ»¤ç±»ä»£ç `ï¼Œå¹¶è¿›è¡Œ**ç¼–è¯‘**ä½¿ç”¨ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FilterClassManager.javaã€‘\n  2: /**\n  3:  * æ³¨å†Œè¿‡æ»¤ç±»\n  4:  *\n  5:  * @param consumerGroup æ¶ˆè´¹åˆ†ç»„\n  6:  * @param topic Topic\n  7:  * @param className è¿‡æ»¤ç±»å\n  8:  * @param classCRC è¿‡æ»¤ç±»æºç CRC\n  9:  * @param filterSourceBinary è¿‡æ»¤ç±»æºç \n 10:  * @return æ˜¯å¦æ³¨å†ŒæˆåŠŸ\n 11:  */\n 12: public boolean registerFilterClass(final String consumerGroup, final String topic,\n 13:     final String className, final int classCRC, final byte[] filterSourceBinary) {\n 14:     final String key = buildKey(consumerGroup, topic);\n 15:     // åˆ¤æ–­æ˜¯å¦è¦æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»\n 16:     boolean registerNew = false;\n 17:     FilterClassInfo filterClassInfoPrev = this.filterClassTable.get(key);\n 18:     if (null == filterClassInfoPrev) {\n 19:         registerNew = true;\n 20:     } else {\n 21:         if (this.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) {\n 22:             if (filterClassInfoPrev.getClassCRC() != classCRC && classCRC != 0) { // ç±»æœ‰å˜åŒ–\n 23:                 registerNew = true;\n 24:             }\n 25:         }\n 26:     }\n 27:     // æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»\n 28:     if (registerNew) {\n 29:         synchronized (this.compileLock) {\n 30:             filterClassInfoPrev = this.filterClassTable.get(key);\n 31:             if (null != filterClassInfoPrev && filterClassInfoPrev.getClassCRC() == classCRC) {\n 32:                 return true;\n 33:             }\n 34:             try {\n 35:                 FilterClassInfo filterClassInfoNew = new FilterClassInfo();\n 36:                 filterClassInfoNew.setClassName(className);\n 37:                 filterClassInfoNew.setClassCRC(0);\n 38:                 filterClassInfoNew.setMessageFilter(null);\n 39: \n 40:                 if (this.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) {\n 41:                     String javaSource = new String(filterSourceBinary, MixAll.DEFAULT_CHARSET);\n 42:                     // ç¼–è¯‘æ–°çš„è¿‡æ»¤ç±»\n 43:                     Class<?> newClass = DynaCode.compileAndLoadClass(className, javaSource);\n 44:                     // åˆ›å»ºæ–°çš„è¿‡æ»¤ç±»å¯¹è±¡\n 45:                     Object newInstance = newClass.newInstance();\n 46:                     filterClassInfoNew.setMessageFilter((MessageFilter) newInstance);\n 47:                     filterClassInfoNew.setClassCRC(classCRC);\n 48:                 }\n 49: \n 50:                 this.filterClassTable.put(key, filterClassInfoNew);\n 51:             } catch (Throwable e) {\n 52:                 String info = String.format(\"FilterServer, registerFilterClass Exception, consumerGroup: %s topic: %s className: %s\",\n 53:                             consumerGroup, topic, className);\n 54:                 log.error(info, e);\n 55:                 return false;\n 56:             }\n 57:         }\n 58:     }\n 59: \n 60:     return true;\n 61: }\n```\n\n-------\n\n# 4. è¿‡æ»¤æ¶ˆæ¯\n\n![Filtersrv.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrv.png)\n\n## 4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯\n\n* ğŸ¦… `Consumer` æ‹‰å– **ä½¿ç”¨è¿‡æ»¤ç±»æ–¹å¼è®¢é˜…** çš„æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä» `Broker` å¯¹åº”çš„ `Filtersrv` åˆ—è¡¨**éšæœº**é€‰æ‹©ä¸€ä¸ªæ‹‰å–æ¶ˆæ¯ã€‚**å¦‚æœé€‰æ‹©ä¸åˆ° `Filtersrv`ï¼Œåˆ™æ— æ³•æ‹‰å–æ¶ˆæ¯ã€‚å› æ­¤ï¼Œ`Filtersrv` ä¸€å®šè¦åšé«˜å¯ç”¨**ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€PullAPIWrapper.javaã€‘\n  2: /**\n  3:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•\n  4:  *\n  5:  * @param mq æ¶ˆæ¯å˜Ÿåˆ—\n  6:  * @param subExpression è®¢é˜…è¡¨è¾¾å¼\n  7:  * @param subVersion è®¢é˜…ç‰ˆæœ¬å·\n  8:  * @param offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®\n  9:  * @param maxNums æ‰¹é‡æ‹‰ å–æ¶ˆæ¯æ•°é‡\n 10:  * @param sysFlag æ‹‰å–ç³»ç»Ÿæ ‡è¯†\n 11:  * @param commitOffset æäº¤æ¶ˆè´¹è¿›åº¦\n 12:  * @param brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´\n 13:  * @param timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é—´\n 14:  * @param communicationMode é€šè®¯æ¨¡å¼\n 15:  * @param pullCallback æ‹‰å–å›è°ƒ\n 16:  * @return æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚\n 17:  * @throws MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸\n 18:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶\n 19:  * @throws MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚\n 20:  * @throws InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶\n 21:  */\n 22: protected PullResult pullKernelImpl(\n 23:     final MessageQueue mq,\n 24:     final String subExpression,\n 25:     final long subVersion,\n 26:     final long offset,\n 27:     final int maxNums,\n 28:     final int sysFlag,\n 29:     final long commitOffset,\n 30:     final long brokerSuspendMaxTimeMillis,\n 31:     final long timeoutMillis,\n 32:     final CommunicationMode communicationMode,\n 33:     final PullCallback pullCallback\n 34: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n 35:     // // ....(çœç•¥ä»£ç )\n 36:     // è¯·æ±‚æ‹‰å–æ¶ˆæ¯\n 37:     if (findBrokerResult != null) {\n 38:         // ....(çœç•¥ä»£ç )\n 39:         // è‹¥è®¢é˜…topicä½¿ç”¨è¿‡æ»¤ç±»ï¼Œä½¿ç”¨filtersrvè·å–æ¶ˆæ¯\n 40:         String brokerAddr = findBrokerResult.getBrokerAddr();\n 41:         if (PullSysFlag.hasClassFilterFlag(sysFlagInner)) {\n 42:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);\n 43:         }\n 44: \n 45:         PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage(\n 46:             brokerAddr,\n 47:             requestHeader,\n 48:             timeoutMillis,\n 49:             communicationMode,\n 50:             pullCallback);\n 51: \n 52:         return pullResult;\n 53:     }\n 54: \n 55:     // Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n 56:     throw new MQClientException(\"The broker[\" + mq.getBrokerName() + \"] not exist\", null);\n 57: }\n 58: \n 59: /**\n 60:  * è®¡ç®—filtersrvåœ°å€ã€‚å¦‚æœæœ‰å¤šä¸ªfiltersrvï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªã€‚\n 61:  *\n 62:  * @param topic Topic\n 63:  * @param brokerAddr brokeråœ°å€\n 64:  * @return filtersrvåœ°å€\n 65:  * @throws MQClientException å½“filtersrvä¸å­˜åœ¨æ—¶\n 66:  */\n 67: private String computPullFromWhichFilterServer(final String topic, final String brokerAddr)\n 68:     throws MQClientException {\n 69:     ConcurrentHashMap<String, TopicRouteData> topicRouteTable = this.mQClientFactory.getTopicRouteTable();\n 70:     if (topicRouteTable != null) {\n 71:         TopicRouteData topicRouteData = topicRouteTable.get(topic);\n 72:         List<String> list = topicRouteData.getFilterServerTable().get(brokerAddr);\n 73:         if (list != null && !list.isEmpty()) {\n 74:             return list.get(randomNum() % list.size());\n 75:         }\n 76:     }\n 77:     throw new MQClientException(\"Find Filter Server Failed, Broker Addr: \" + brokerAddr + \" topic: \"\n 78:         + topic, null);\n 79: }\n```\n\n## 4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯\n\n* ğŸ¦… `Filtersrv` æ‹‰å–æ¶ˆæ¯åï¼Œä¼šå»ºè®® `Consumer` å‘ `Brokerä¸»èŠ‚ç‚¹` æ‹‰å–æ¶ˆæ¯ã€‚\n* ğŸ¦… `Filtersrv` å¯ä»¥ç†è§£æˆä¸€ä¸ª `Consumer`ï¼Œå‘ `Broker` æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå®é™…ä½¿ç”¨çš„ `DefaultMQPullConsumer.java` çš„æ–¹æ³•å’Œé€»è¾‘ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultRequestProcessor.javaã€‘\n  2: /**\n  3:  * æ‹‰å–æ¶ˆæ¯\n  4:  *\n  5:  * @param ctx æ‹‰å–æ¶ˆæ¯context\n  6:  * @param request æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n  7:  * @return å“åº”\n  8:  * @throws Exception å½“å‘ç”Ÿå¼‚å¸¸æ—¶\n  9:  */\n 10: private RemotingCommand pullMessageForward(final ChannelHandlerContext ctx, final RemotingCommand request) throws Exception {\n 11:     final RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);\n 12:     final PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();\n 13:     final PullMessageRequestHeader requestHeader =\n 14:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);\n 15: \n 16:     final FilterContext filterContext = new FilterContext();\n 17:     filterContext.setConsumerGroup(requestHeader.getConsumerGroup());\n 18: \n 19:     response.setOpaque(request.getOpaque());\n 20: \n 21:     DefaultMQPullConsumer pullConsumer = this.filtersrvController.getDefaultMQPullConsumer();\n 22: \n 23:     // æ ¡éªŒTopicè¿‡æ»¤ç±»æ˜¯å¦å®Œæ•´\n 24:     final FilterClassInfo findFilterClass = this.filtersrvController.getFilterClassManager().findFilterClass(requestHeader.getConsumerGroup(), requestHeader.getTopic());\n 25:     if (null == findFilterClass) {\n 26:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 27:         response.setRemark(\"Find Filter class failed, not registered\");\n 28:         return response;\n 29:     }\n 30:     if (null == findFilterClass.getMessageFilter()) {\n 31:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 32:         response.setRemark(\"Find Filter class failed, registered but no class\");\n 33:         return response;\n 34:     }\n 35: \n 36:     // è®¾ç½®ä¸‹æ¬¡è¯·æ±‚ä» Brokerä¸»èŠ‚ç‚¹ã€‚\n 37:     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n 38: \n 39:     MessageQueue mq = new MessageQueue();\n 40:     mq.setTopic(requestHeader.getTopic());\n 41:     mq.setQueueId(requestHeader.getQueueId());\n 42:     mq.setBrokerName(this.filtersrvController.getBrokerName());\n 43:     long offset = requestHeader.getQueueOffset();\n 44:     int maxNums = requestHeader.getMaxMsgNums();\n 45: \n 46:     final PullCallback pullCallback = new PullCallback() {\n 47: \n 48:         @Override\n 49:         public void onSuccess(PullResult pullResult) {\n 50:             responseHeader.setMaxOffset(pullResult.getMaxOffset());\n 51:             responseHeader.setMinOffset(pullResult.getMinOffset());\n 52:             responseHeader.setNextBeginOffset(pullResult.getNextBeginOffset());\n 53:             response.setRemark(null);\n 54: \n 55:             switch (pullResult.getPullStatus()) {\n 56:                 case FOUND:\n 57:                     response.setCode(ResponseCode.SUCCESS);\n 58: \n 59:                     List<MessageExt> msgListOK = new ArrayList<MessageExt>();\n 60:                     try {\n 61:                         for (MessageExt msg : pullResult.getMsgFoundList()) {\n 62:                             // ä½¿ç”¨è¿‡æ»¤ç±»è¿‡æ»¤æ¶ˆæ¯\n 63:                             boolean match = findFilterClass.getMessageFilter().match(msg, filterContext);\n 64:                             if (match) {\n 65:                                 msgListOK.add(msg);\n 66:                             }\n 67:                         }\n 68: \n 69:                         if (!msgListOK.isEmpty()) {\n 70:                             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, msgListOK);\n 71:                             return;\n 72:                         } else {\n 73:                             response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n 74:                         }\n 75:                     } catch (Throwable e) {\n 76:                         final String error =\n 77:                             String.format(\"do Message Filter Exception, ConsumerGroup: %s Topic: %s \",\n 78:                                 requestHeader.getConsumerGroup(), requestHeader.getTopic());\n 79:                         log.error(error, e);\n 80: \n 81:                         response.setCode(ResponseCode.SYSTEM_ERROR);\n 82:                         response.setRemark(error + RemotingHelper.exceptionSimpleDesc(e));\n 83:                         returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);\n 84:                         return;\n 85:                     }\n 86: \n 87:                     break;\n 88:                 case NO_MATCHED_MSG:\n 89:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n 90:                     break;\n 91:                 case NO_NEW_MSG:\n 92:                     response.setCode(ResponseCode.PULL_NOT_FOUND);\n 93:                     break;\n 94:                 case OFFSET_ILLEGAL:\n 95:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n 96:                     break;\n 97:                 default:\n 98:                     break;\n 99:             }\n100: \n101:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);\n102:         }\n103: \n104:         @Override\n105:         public void onException(Throwable e) {\n106:             response.setCode(ResponseCode.SYSTEM_ERROR);\n107:             response.setRemark(\"Pull Callback Exception, \" + RemotingHelper.exceptionSimpleDesc(e));\n108:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, null);\n109:             return;\n110:         }\n111:     };\n112: \n113:     // æ‹‰å–æ¶ˆæ¯\n114:     pullConsumer.pullBlockIfNotFound(mq, null, offset, maxNums, pullCallback);\n115:     return null;\n116: }\n``` \n\n# 5. Filtersrv é«˜å¯ç”¨\n\n![Filtersrvè¿‡å¯ç”¨](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrvè¿‡å¯ç”¨.png)\n\n\n","slug":"RocketMQ/filtersrv","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswzm000zak5d4zpi9pvo","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1008-RocketMQæºç è§£æï¼šFiltersrv.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šFiltersrv</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. Filtersrv æ³¨å†Œåˆ° Broker</a></li>\n<li><a href=\"#\">3. è¿‡æ»¤ç±»</a><ul>\n<li><a href=\"#\">3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç </a></li>\n<li><a href=\"#\">3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç </a></li>\n<li><a href=\"#\">3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç </a></li>\n</ul>\n</li>\n<li><a href=\"#\">4. è¿‡æ»¤æ¶ˆæ¯</a><ul>\n<li><a href=\"#\">4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯</a></li>\n<li><a href=\"#\">4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯</a></li>\n</ul>\n</li>\n<li><a href=\"#\">5. Filtersrv é«˜å¯ç”¨</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p><code>Filtersrv</code> ï¼Œè´Ÿè´£<strong>è‡ªå®šä¹‰è§„åˆ™</strong>è¿‡æ»¤ <code>Consumer</code> ä» <code>Broker</code> æ‹‰å–çš„æ¶ˆæ¯ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrv.png\" alt=\"Filtersrv.png\"></p>\n<p>ä¸ºä»€ä¹ˆ <code>Broker</code> ä¸æä¾›è¿‡æ»¤æ¶ˆæ¯çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹å®˜æ–¹çš„è¯´æ³•ï¼š</p>\n<blockquote>\n<ul>\n<li>Broker ç«¯æ¶ˆæ¯è¿‡æ»¤<br>åœ¨ Broker ä¸­ï¼ŒæŒ‰ç…§ Consumer çš„è¦æ±‚åšè¿‡æ»¤ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ã€‚ ç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ï¼Œå®ç°ç›¸å¯¹å¤æ‚ã€‚<br>(1). æ·˜å® Notify æ”¯æŒå¤šç§è¿‡æ»¤æ–¹å¼ï¼ŒåŒ…å«ç›´æ¥æŒ‰ç…§æ¶ˆæ¯ç±»å‹è¿‡æ»¤ï¼Œçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ï¼Œå‡ ä¹å¯ä»¥æ»¡è¶³æœ€è‹›åˆ»çš„è¿‡æ»¤éœ€æ±‚ã€‚<br>(2). æ·˜å® RocketMQ æ”¯æŒæŒ‰ç…§ç®€å•çš„ Message Tag è¿‡æ»¤ï¼Œä¹Ÿæ”¯æŒæŒ‰ç…§ Message Headerã€body è¿›è¡Œè¿‡æ»¤ã€‚<br>(3). CORBA Notification è§„èŒƒä¸­ä¹Ÿæ”¯æŒçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ã€‚  </li>\n<li>Consumer ç«¯æ¶ˆæ¯è¿‡æ»¤<br>è¿™ç§è¿‡æ»¤æ–¹å¼å¯ç”±åº”ç”¨å®Œå…¨è‡ªå®šä¹‰å®ç°ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯å¾ˆå¤šæ— ç”¨çš„æ¶ˆæ¯è¦ä¼ è¾“åˆ° Consumer ç«¯ã€‚</li>\n</ul>\n</blockquote>\n<p><strong>å°±æ˜¯åœ¨è¿™ç§è€ƒè™‘ä¸‹ï¼Œ<code>Filtersrv</code> å‡ºç°äº†ã€‚å‡å°‘äº† <code>Broker</code> çš„è´Ÿæ‹…ï¼Œåˆå‡å°‘äº† <code>Consumer</code> æ¥æ”¶æ— ç”¨çš„æ¶ˆæ¯ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œå¤šäº†ä¸€å±‚ <code>Filtersrv</code> ç½‘ç»œå¼€é”€ã€‚</strong></p>\n<h1 id=\"2-Filtersrv-æ³¨å†Œåˆ°-Broker\"><a href=\"#2-Filtersrv-æ³¨å†Œåˆ°-Broker\" class=\"headerlink\" title=\"2. Filtersrv æ³¨å†Œåˆ° Broker\"></a>2. Filtersrv æ³¨å†Œåˆ° Broker</h1><ul>\n<li>ğŸ¦… ä¸€ä¸ª <code>Filtersrv</code> <strong>åª</strong>å¯¹åº”ä¸€ä¸ª <code>Broker</code>ã€‚</li>\n<li>ğŸ¦… ä¸€ä¸ª <code>Broker</code> å¯ä»¥å¯¹åº”<strong>å¤šä¸ª</strong> <code>Filtersrv</code>ã€‚<strong><code>Filtersrv</code> çš„é«˜å¯ç”¨é€šè¿‡å¯åŠ¨å¤šä¸ª <code>Filtersrv</code> å®ç°</strong>ã€‚</li>\n<li>ğŸ¦… <code>Filtersrv</code> æ³¨å†Œå¤±è´¥æ—¶ï¼Œä¸»åŠ¨<strong>é€€å‡ºå…³é—­</strong>ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FiltersrvController.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">initialize</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"comment\">// å›ºå®šé—´éš”æ³¨å†Œåˆ°Broker</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">10</span>:             FiltersrvController.<span class=\"keyword\">this</span>.registerFilterServerToBroker();</div><div class=\"line\"><span class=\"number\">11</span>:         &#125;</div><div class=\"line\"><span class=\"number\">12</span>:     &#125;, <span class=\"number\">15</span>, <span class=\"number\">10</span>, TimeUnit.SECONDS); <span class=\"comment\">// TODO edit by èŠ‹è‰¿ï¼šinitialDelayæ—¶é—´å¤ªçŸ­ï¼Œå¯èƒ½å¯¼è‡´åˆå§‹åŒ–å¤±è´¥ã€‚ä»3=ã€‹15</span></div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">15</span>: &#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>: <span class=\"comment\">/**</span></div><div class=\"line\">18:  * æ³¨å†ŒFiltersrv åˆ° Broker</div><div class=\"line\">19:  * ï¼ï¼ï¼å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œå…³é—­Filtersrv</div><div class=\"line\">20:  */</div><div class=\"line\"><span class=\"number\">21</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerFilterServerToBroker</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">23</span>:         RegisterFilterServerResponseHeader responseHeader =</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">this</span>.filterServerOuterAPI.registerFilterServerToBroker(</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">this</span>.filtersrvConfig.getConnectWhichBroker(), <span class=\"keyword\">this</span>.localAddr());</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">this</span>.defaultMQPullConsumer.getDefaultMQPullConsumerImpl().getPullAPIWrapper()</div><div class=\"line\"><span class=\"number\">27</span>:             .setDefaultBrokerId(responseHeader.getBrokerId());</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == <span class=\"keyword\">this</span>.brokerName) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             <span class=\"keyword\">this</span>.brokerName = responseHeader.getBrokerName();</div><div class=\"line\"><span class=\"number\">31</span>:         &#125;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>:         log.info(<span class=\"string\">\"register filter server&lt;&#123;&#125;&gt; to broker&lt;&#123;&#125;&gt; OK, Return: &#123;&#125; &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">this</span>.localAddr(),</div><div class=\"line\"><span class=\"number\">35</span>:             <span class=\"keyword\">this</span>.filtersrvConfig.getConnectWhichBroker(),</div><div class=\"line\"><span class=\"number\">36</span>:             responseHeader.getBrokerName(),</div><div class=\"line\"><span class=\"number\">37</span>:             responseHeader.getBrokerId());</div><div class=\"line\"><span class=\"number\">38</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:         log.warn(<span class=\"string\">\"register filter server Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">40</span>: </div><div class=\"line\"><span class=\"number\">41</span>:         log.warn(<span class=\"string\">\"access broker failed, kill oneself\"</span>);</div><div class=\"line\"><span class=\"number\">42</span>:         System.exit(-<span class=\"number\">1</span>); <span class=\"comment\">// å¼‚å¸¸é€€å‡º</span></div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-è¿‡æ»¤ç±»\"><a href=\"#3-è¿‡æ»¤ç±»\" class=\"headerlink\" title=\"3. è¿‡æ»¤ç±»\"></a>3. è¿‡æ»¤ç±»</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrvè¿‡æ»¤ç±».png\" alt=\"Filtersrvè¿‡æ»¤ç±»\"></p>\n<h2 id=\"3-1-Consumer-è®¢é˜…æ—¶è®¾ç½®-è¿‡æ»¤ç±»ä»£ç \"><a href=\"#3-1-Consumer-è®¢é˜…æ—¶è®¾ç½®-è¿‡æ»¤ç±»ä»£ç \" class=\"headerlink\" title=\"3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç \"></a>3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç </h2><ul>\n<li>ğŸ¦… <code>Consumer</code> é’ˆå¯¹æ¯ä¸ª <code>Topic</code> å¯ä»¥è®¢é˜…ä¸åŒçš„ <code>è¿‡æ»¤ç±»ä»£ç </code>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQPushConsumer.javaã€‘</span></div><div class=\"line\"><span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">subscribe</span><span class=\"params\">(String topic, String fullClassName, String filterClassSource)</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</div><div class=\"line\"><span class=\"number\">4</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.subscribe(topic, fullClassName, filterClassSource);</div><div class=\"line\"><span class=\"number\">5</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"3-2-Consumer-ä¸Šä¼ -è¿‡æ»¤ç±»ä»£ç \"><a href=\"#3-2-Consumer-ä¸Šä¼ -è¿‡æ»¤ç±»ä»£ç \" class=\"headerlink\" title=\"3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç \"></a>3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç </h2><ul>\n<li>ğŸ¦… <code>Consumer</code> å¿ƒè·³æ³¨å†Œåˆ° <code>Broker</code> çš„åŒæ—¶ï¼Œä¸Šä¼  <code>è¿‡æ»¤ç±»ä»£ç </code> åˆ° <code>Broker</code> å¯¹åº”çš„<strong>æ‰€æœ‰</strong> <code>Filtersrv</code>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MQClientInstance.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * å‘é€å¿ƒè·³åˆ°Brokerï¼Œä¸Šä¼ è¿‡æ»¤ç±»æºç åˆ°Filtersrv</div><div class=\"line\"> 4:  */</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendHeartbeatToAllBrokerWithLock</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lockHeartbeat.tryLock()) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"keyword\">this</span>.sendHeartbeatToAllBroker();</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">this</span>.uploadFilterClassSource();</div><div class=\"line\"><span class=\"number\">10</span>:         &#125; <span class=\"keyword\">catch</span> (<span class=\"keyword\">final</span> Exception e) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:             log.error(<span class=\"string\">\"sendHeartbeatToAllBroker exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">12</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">this</span>.lockHeartbeat.unlock();</div><div class=\"line\"><span class=\"number\">14</span>:         &#125;</div><div class=\"line\"><span class=\"number\">15</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">16</span>:         log.warn(<span class=\"string\">\"lock heartBeat, but failed.\"</span>);</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: &#125;</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>: <span class=\"comment\">/**</span></div><div class=\"line\">21:  * ä¸Šä¼ è¿‡æ»¤ç±»åˆ°Filtersrv</div><div class=\"line\">22:  */</div><div class=\"line\"><span class=\"number\">23</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">uploadFilterClassSource</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">24</span>:     Iterator&lt;Entry&lt;String, MQConsumerInner&gt;&gt; it = <span class=\"keyword\">this</span>.consumerTable.entrySet().iterator();</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"keyword\">while</span> (it.hasNext()) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:         Entry&lt;String, MQConsumerInner&gt; next = it.next();</div><div class=\"line\"><span class=\"number\">27</span>:         MQConsumerInner consumer = next.getValue();</div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">if</span> (ConsumeType.CONSUME_PASSIVELY == consumer.consumeType()) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:             Set&lt;SubscriptionData&gt; subscriptions = consumer.subscriptions();</div><div class=\"line\"><span class=\"number\">30</span>:             <span class=\"keyword\">for</span> (SubscriptionData sub : subscriptions) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                 <span class=\"keyword\">if</span> (sub.isClassFilterMode() &amp;&amp; sub.getFilterClassSource() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                     <span class=\"keyword\">final</span> String consumerGroup = consumer.groupName();</div><div class=\"line\"><span class=\"number\">33</span>:                     <span class=\"keyword\">final</span> String className = sub.getSubString();</div><div class=\"line\"><span class=\"number\">34</span>:                     <span class=\"keyword\">final</span> String topic = sub.getTopic();</div><div class=\"line\"><span class=\"number\">35</span>:                     <span class=\"keyword\">final</span> String filterClassSource = sub.getFilterClassSource();</div><div class=\"line\"><span class=\"number\">36</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">37</span>:                         <span class=\"keyword\">this</span>.uploadFilterClassToAllFilterServer(consumerGroup, className, topic, filterClassSource);</div><div class=\"line\"><span class=\"number\">38</span>:                     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:                         log.error(<span class=\"string\">\"uploadFilterClassToAllFilterServer Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">40</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">41</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">42</span>:             &#125;</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>:     &#125;</div><div class=\"line\"><span class=\"number\">45</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"3-3-Filter-ç¼–è¯‘-è¿‡æ»¤ç±»ä»£ç \"><a href=\"#3-3-Filter-ç¼–è¯‘-è¿‡æ»¤ç±»ä»£ç \" class=\"headerlink\" title=\"3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç \"></a>3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç </h2><ul>\n<li>ğŸ¦… <code>Filtersrv</code> å¤„ç† <code>Consumer</code> ä¸Šä¼ çš„ <code>è¿‡æ»¤ç±»ä»£ç </code>ï¼Œå¹¶è¿›è¡Œ<strong>ç¼–è¯‘</strong>ä½¿ç”¨ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FilterClassManager.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ³¨å†Œè¿‡æ»¤ç±»</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> consumerGroup æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> topic Topic</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> className è¿‡æ»¤ç±»å</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> classCRC è¿‡æ»¤ç±»æºç CRC</div><div class=\"line\"> 9:  * <span class=\"doctag\">@param</span> filterSourceBinary è¿‡æ»¤ç±»æºç </div><div class=\"line\">10:  * <span class=\"doctag\">@return</span> æ˜¯å¦æ³¨å†ŒæˆåŠŸ</div><div class=\"line\">11:  */</div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">registerFilterClass</span><span class=\"params\">(<span class=\"keyword\">final</span> String consumerGroup, <span class=\"keyword\">final</span> String topic,</span></span></div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">final</span> String className, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> classCRC, <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] filterSourceBinary) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">final</span> String key = buildKey(consumerGroup, topic);</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"comment\">// åˆ¤æ–­æ˜¯å¦è¦æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»</span></div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">boolean</span> registerNew = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">17</span>:     FilterClassInfo filterClassInfoPrev = <span class=\"keyword\">this</span>.filterClassTable.get(key);</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == filterClassInfoPrev) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:         registerNew = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">if</span> (filterClassInfoPrev.getClassCRC() != classCRC &amp;&amp; classCRC != <span class=\"number\">0</span>) &#123; <span class=\"comment\">// ç±»æœ‰å˜åŒ–</span></div><div class=\"line\"><span class=\"number\">23</span>:                 registerNew = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">24</span>:             &#125;</div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"comment\">// æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»</span></div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">if</span> (registerNew) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>.compileLock) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             filterClassInfoPrev = <span class=\"keyword\">this</span>.filterClassTable.get(key);</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != filterClassInfoPrev &amp;&amp; filterClassInfoPrev.getClassCRC() == classCRC) &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">33</span>:             &#125;</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">35</span>:                 FilterClassInfo filterClassInfoNew = <span class=\"keyword\">new</span> FilterClassInfo();</div><div class=\"line\"><span class=\"number\">36</span>:                 filterClassInfoNew.setClassName(className);</div><div class=\"line\"><span class=\"number\">37</span>:                 filterClassInfoNew.setClassCRC(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">38</span>:                 filterClassInfoNew.setMessageFilter(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) &#123;</div><div class=\"line\"><span class=\"number\">41</span>:                     String javaSource = <span class=\"keyword\">new</span> String(filterSourceBinary, MixAll.DEFAULT_CHARSET);</div><div class=\"line\"><span class=\"number\">42</span>:                     <span class=\"comment\">// ç¼–è¯‘æ–°çš„è¿‡æ»¤ç±»</span></div><div class=\"line\"><span class=\"number\">43</span>:                     Class&lt;?&gt; newClass = DynaCode.compileAndLoadClass(className, javaSource);</div><div class=\"line\"><span class=\"number\">44</span>:                     <span class=\"comment\">// åˆ›å»ºæ–°çš„è¿‡æ»¤ç±»å¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">45</span>:                     Object newInstance = newClass.newInstance();</div><div class=\"line\"><span class=\"number\">46</span>:                     filterClassInfoNew.setMessageFilter((MessageFilter) newInstance);</div><div class=\"line\"><span class=\"number\">47</span>:                     filterClassInfoNew.setClassCRC(classCRC);</div><div class=\"line\"><span class=\"number\">48</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">49</span>: </div><div class=\"line\"><span class=\"number\">50</span>:                 <span class=\"keyword\">this</span>.filterClassTable.put(key, filterClassInfoNew);</div><div class=\"line\"><span class=\"number\">51</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:                 String info = String.format(<span class=\"string\">\"FilterServer, registerFilterClass Exception, consumerGroup: %s topic: %s className: %s\"</span>,</div><div class=\"line\"><span class=\"number\">53</span>:                             consumerGroup, topic, className);</div><div class=\"line\"><span class=\"number\">54</span>:                 log.error(info, e);</div><div class=\"line\"><span class=\"number\">55</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">56</span>:             &#125;</div><div class=\"line\"><span class=\"number\">57</span>:         &#125;</div><div class=\"line\"><span class=\"number\">58</span>:     &#125;</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">61</span>: &#125;</div></pre></td></tr></table></figure>\n<hr>\n<h1 id=\"4-è¿‡æ»¤æ¶ˆæ¯\"><a href=\"#4-è¿‡æ»¤æ¶ˆæ¯\" class=\"headerlink\" title=\"4. è¿‡æ»¤æ¶ˆæ¯\"></a>4. è¿‡æ»¤æ¶ˆæ¯</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrv.png\" alt=\"Filtersrv.png\"></p>\n<h2 id=\"4-1-Consumer-ä»-Filtersrv-æ‹‰å–æ¶ˆæ¯\"><a href=\"#4-1-Consumer-ä»-Filtersrv-æ‹‰å–æ¶ˆæ¯\" class=\"headerlink\" title=\"4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯\"></a>4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦… <code>Consumer</code> æ‹‰å– <strong>ä½¿ç”¨è¿‡æ»¤ç±»æ–¹å¼è®¢é˜…</strong> çš„æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä» <code>Broker</code> å¯¹åº”çš„ <code>Filtersrv</code> åˆ—è¡¨<strong>éšæœº</strong>é€‰æ‹©ä¸€ä¸ªæ‹‰å–æ¶ˆæ¯ã€‚<strong>å¦‚æœé€‰æ‹©ä¸åˆ° <code>Filtersrv</code>ï¼Œåˆ™æ— æ³•æ‹‰å–æ¶ˆæ¯ã€‚å› æ­¤ï¼Œ<code>Filtersrv</code> ä¸€å®šè¦åšé«˜å¯ç”¨</strong>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€PullAPIWrapper.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯å˜Ÿåˆ—</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> subExpression è®¢é˜…è¡¨è¾¾å¼</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> subVersion è®¢é˜…ç‰ˆæœ¬å·</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class=\"line\"> 9:  * <span class=\"doctag\">@param</span> maxNums æ‰¹é‡æ‹‰ å–æ¶ˆæ¯æ•°é‡</div><div class=\"line\">10:  * <span class=\"doctag\">@param</span> sysFlag æ‹‰å–ç³»ç»Ÿæ ‡è¯†</div><div class=\"line\">11:  * <span class=\"doctag\">@param</span> commitOffset æäº¤æ¶ˆè´¹è¿›åº¦</div><div class=\"line\">12:  * <span class=\"doctag\">@param</span> brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´</div><div class=\"line\">13:  * <span class=\"doctag\">@param</span> timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é—´</div><div class=\"line\">14:  * <span class=\"doctag\">@param</span> communicationMode é€šè®¯æ¨¡å¼</div><div class=\"line\">15:  * <span class=\"doctag\">@param</span> pullCallback æ‹‰å–å›è°ƒ</div><div class=\"line\">16:  * <span class=\"doctag\">@return</span> æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚</div><div class=\"line\">17:  * <span class=\"doctag\">@throws</span> MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸</div><div class=\"line\">18:  * <span class=\"doctag\">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">19:  * <span class=\"doctag\">@throws</span> MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚</div><div class=\"line\">20:  * <span class=\"doctag\">@throws</span> InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶</div><div class=\"line\">21:  */</div><div class=\"line\"><span class=\"number\">22</span>: <span class=\"function\"><span class=\"keyword\">protected</span> PullResult <span class=\"title\">pullKernelImpl</span><span class=\"params\">(</span></span></div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"keyword\">final</span> MessageQueue mq,</div><div class=\"line\"><span class=\"number\">24</span>:     <span class=\"keyword\">final</span> String subExpression,</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> subVersion,</div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset,</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxNums,</div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> sysFlag,</div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> commitOffset,</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> brokerSuspendMaxTimeMillis,</div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeoutMillis,</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode,</div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"keyword\">final</span> PullCallback pullCallback</div><div class=\"line\"><span class=\"number\">34</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"comment\">// // ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"comment\">// è¯·æ±‚æ‹‰å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"keyword\">if</span> (findBrokerResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"comment\">// è‹¥è®¢é˜…topicä½¿ç”¨è¿‡æ»¤ç±»ï¼Œä½¿ç”¨filtersrvè·å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">40</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class=\"line\"><span class=\"number\">41</span>:         <span class=\"keyword\">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:         PullResult pullResult = <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class=\"line\"><span class=\"number\">46</span>:             brokerAddr,</div><div class=\"line\"><span class=\"number\">47</span>:             requestHeader,</div><div class=\"line\"><span class=\"number\">48</span>:             timeoutMillis,</div><div class=\"line\"><span class=\"number\">49</span>:             communicationMode,</div><div class=\"line\"><span class=\"number\">50</span>:             pullCallback);</div><div class=\"line\"><span class=\"number\">51</span>: </div><div class=\"line\"><span class=\"number\">52</span>:         <span class=\"keyword\">return</span> pullResult;</div><div class=\"line\"><span class=\"number\">53</span>:     &#125;</div><div class=\"line\"><span class=\"number\">54</span>: </div><div class=\"line\"><span class=\"number\">55</span>:     <span class=\"comment\">// Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">56</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"The broker[\"</span> + mq.getBrokerName() + <span class=\"string\">\"] not exist\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">57</span>: &#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>: <span class=\"comment\">/**</span></div><div class=\"line\">60:  * è®¡ç®—filtersrvåœ°å€ã€‚å¦‚æœæœ‰å¤šä¸ªfiltersrvï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªã€‚</div><div class=\"line\">61:  *</div><div class=\"line\">62:  * <span class=\"doctag\">@param</span> topic Topic</div><div class=\"line\">63:  * <span class=\"doctag\">@param</span> brokerAddr brokeråœ°å€</div><div class=\"line\">64:  * <span class=\"doctag\">@return</span> filtersrvåœ°å€</div><div class=\"line\">65:  * <span class=\"doctag\">@throws</span> MQClientException å½“filtersrvä¸å­˜åœ¨æ—¶</div><div class=\"line\">66:  */</div><div class=\"line\"><span class=\"number\">67</span>: <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">computPullFromWhichFilterServer</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> String brokerAddr)</span></span></div><div class=\"line\">68:     <span class=\"keyword\">throws</span> MQClientException &#123;</div><div class=\"line\"><span class=\"number\">69</span>:     ConcurrentHashMap&lt;String, TopicRouteData&gt; topicRouteTable = <span class=\"keyword\">this</span>.mQClientFactory.getTopicRouteTable();</div><div class=\"line\"><span class=\"number\">70</span>:     <span class=\"keyword\">if</span> (topicRouteTable != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">71</span>:         TopicRouteData topicRouteData = topicRouteTable.get(topic);</div><div class=\"line\"><span class=\"number\">72</span>:         List&lt;String&gt; list = topicRouteData.getFilterServerTable().get(brokerAddr);</div><div class=\"line\"><span class=\"number\">73</span>:         <span class=\"keyword\">if</span> (list != <span class=\"keyword\">null</span> &amp;&amp; !list.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">74</span>:             <span class=\"keyword\">return</span> list.get(randomNum() % list.size());</div><div class=\"line\"><span class=\"number\">75</span>:         &#125;</div><div class=\"line\"><span class=\"number\">76</span>:     &#125;</div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"Find Filter Server Failed, Broker Addr: \"</span> + brokerAddr + <span class=\"string\">\" topic: \"</span></div><div class=\"line\"><span class=\"number\">78</span>:         + topic, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">79</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"4-2-Filtersrv-ä»-Broker-æ‹‰å–æ¶ˆæ¯\"><a href=\"#4-2-Filtersrv-ä»-Broker-æ‹‰å–æ¶ˆæ¯\" class=\"headerlink\" title=\"4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯\"></a>4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦… <code>Filtersrv</code> æ‹‰å–æ¶ˆæ¯åï¼Œä¼šå»ºè®® <code>Consumer</code> å‘ <code>Brokerä¸»èŠ‚ç‚¹</code> æ‹‰å–æ¶ˆæ¯ã€‚</li>\n<li>ğŸ¦… <code>Filtersrv</code> å¯ä»¥ç†è§£æˆä¸€ä¸ª <code>Consumer</code>ï¼Œå‘ <code>Broker</code> æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå®é™…ä½¿ç”¨çš„ <code>DefaultMQPullConsumer.java</code> çš„æ–¹æ³•å’Œé€»è¾‘ã€‚</li>\n</ul>\n<pre><code class=\"Java\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultRequestProcessor.javaã€‘</span>\n  <span class=\"number\">2</span>: <span class=\"comment\">/**\n  3:  * æ‹‰å–æ¶ˆæ¯\n  4:  *\n  5:  * <span class=\"doctag\">@param</span> ctx æ‹‰å–æ¶ˆæ¯context\n  6:  * <span class=\"doctag\">@param</span> request æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n  7:  * <span class=\"doctag\">@return</span> å“åº”\n  8:  * <span class=\"doctag\">@throws</span> Exception å½“å‘ç”Ÿå¼‚å¸¸æ—¶\n  9:  */</span>\n <span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">pullMessageForward</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx, <span class=\"keyword\">final</span> RemotingCommand request)</span> <span class=\"keyword\">throws</span> Exception </span>{\n <span class=\"number\">11</span>:     <span class=\"keyword\">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);\n <span class=\"number\">12</span>:     <span class=\"keyword\">final</span> PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();\n <span class=\"number\">13</span>:     <span class=\"keyword\">final</span> PullMessageRequestHeader requestHeader =\n <span class=\"number\">14</span>:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);\n <span class=\"number\">15</span>: \n <span class=\"number\">16</span>:     <span class=\"keyword\">final</span> FilterContext filterContext = <span class=\"keyword\">new</span> FilterContext();\n <span class=\"number\">17</span>:     filterContext.setConsumerGroup(requestHeader.getConsumerGroup());\n <span class=\"number\">18</span>: \n <span class=\"number\">19</span>:     response.setOpaque(request.getOpaque());\n <span class=\"number\">20</span>: \n <span class=\"number\">21</span>:     DefaultMQPullConsumer pullConsumer = <span class=\"keyword\">this</span>.filtersrvController.getDefaultMQPullConsumer();\n <span class=\"number\">22</span>: \n <span class=\"number\">23</span>:     <span class=\"comment\">// æ ¡éªŒTopicè¿‡æ»¤ç±»æ˜¯å¦å®Œæ•´</span>\n <span class=\"number\">24</span>:     <span class=\"keyword\">final</span> FilterClassInfo findFilterClass = <span class=\"keyword\">this</span>.filtersrvController.getFilterClassManager().findFilterClass(requestHeader.getConsumerGroup(), requestHeader.getTopic());\n <span class=\"number\">25</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == findFilterClass) {\n <span class=\"number\">26</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);\n <span class=\"number\">27</span>:         response.setRemark(<span class=\"string\">\"Find Filter class failed, not registered\"</span>);\n <span class=\"number\">28</span>:         <span class=\"keyword\">return</span> response;\n <span class=\"number\">29</span>:     }\n <span class=\"number\">30</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == findFilterClass.getMessageFilter()) {\n <span class=\"number\">31</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);\n <span class=\"number\">32</span>:         response.setRemark(<span class=\"string\">\"Find Filter class failed, registered but no class\"</span>);\n <span class=\"number\">33</span>:         <span class=\"keyword\">return</span> response;\n <span class=\"number\">34</span>:     }\n <span class=\"number\">35</span>: \n <span class=\"number\">36</span>:     <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡è¯·æ±‚ä» Brokerä¸»èŠ‚ç‚¹ã€‚</span>\n <span class=\"number\">37</span>:     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n <span class=\"number\">38</span>: \n <span class=\"number\">39</span>:     MessageQueue mq = <span class=\"keyword\">new</span> MessageQueue();\n <span class=\"number\">40</span>:     mq.setTopic(requestHeader.getTopic());\n <span class=\"number\">41</span>:     mq.setQueueId(requestHeader.getQueueId());\n <span class=\"number\">42</span>:     mq.setBrokerName(<span class=\"keyword\">this</span>.filtersrvController.getBrokerName());\n <span class=\"number\">43</span>:     <span class=\"keyword\">long</span> offset = requestHeader.getQueueOffset();\n <span class=\"number\">44</span>:     <span class=\"keyword\">int</span> maxNums = requestHeader.getMaxMsgNums();\n <span class=\"number\">45</span>: \n <span class=\"number\">46</span>:     <span class=\"keyword\">final</span> PullCallback pullCallback = <span class=\"keyword\">new</span> PullCallback() {\n <span class=\"number\">47</span>: \n <span class=\"number\">48</span>:         <span class=\"meta\">@Override</span>\n <span class=\"number\">49</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onSuccess</span><span class=\"params\">(PullResult pullResult)</span> </span>{\n <span class=\"number\">50</span>:             responseHeader.setMaxOffset(pullResult.getMaxOffset());\n <span class=\"number\">51</span>:             responseHeader.setMinOffset(pullResult.getMinOffset());\n <span class=\"number\">52</span>:             responseHeader.setNextBeginOffset(pullResult.getNextBeginOffset());\n <span class=\"number\">53</span>:             response.setRemark(<span class=\"keyword\">null</span>);\n <span class=\"number\">54</span>: \n <span class=\"number\">55</span>:             <span class=\"keyword\">switch</span> (pullResult.getPullStatus()) {\n <span class=\"number\">56</span>:                 <span class=\"keyword\">case</span> FOUND:\n <span class=\"number\">57</span>:                     response.setCode(ResponseCode.SUCCESS);\n <span class=\"number\">58</span>: \n <span class=\"number\">59</span>:                     List&lt;MessageExt&gt; msgListOK = <span class=\"keyword\">new</span> ArrayList&lt;MessageExt&gt;();\n <span class=\"number\">60</span>:                     <span class=\"keyword\">try</span> {\n <span class=\"number\">61</span>:                         <span class=\"keyword\">for</span> (MessageExt msg : pullResult.getMsgFoundList()) {\n <span class=\"number\">62</span>:                             <span class=\"comment\">// ä½¿ç”¨è¿‡æ»¤ç±»è¿‡æ»¤æ¶ˆæ¯</span>\n <span class=\"number\">63</span>:                             <span class=\"keyword\">boolean</span> match = findFilterClass.getMessageFilter().match(msg, filterContext);\n <span class=\"number\">64</span>:                             <span class=\"keyword\">if</span> (match) {\n <span class=\"number\">65</span>:                                 msgListOK.add(msg);\n <span class=\"number\">66</span>:                             }\n <span class=\"number\">67</span>:                         }\n <span class=\"number\">68</span>: \n <span class=\"number\">69</span>:                         <span class=\"keyword\">if</span> (!msgListOK.isEmpty()) {\n <span class=\"number\">70</span>:                             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, msgListOK);\n <span class=\"number\">71</span>:                             <span class=\"keyword\">return</span>;\n <span class=\"number\">72</span>:                         } <span class=\"keyword\">else</span> {\n <span class=\"number\">73</span>:                             response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n <span class=\"number\">74</span>:                         }\n <span class=\"number\">75</span>:                     } <span class=\"keyword\">catch</span> (Throwable e) {\n <span class=\"number\">76</span>:                         <span class=\"keyword\">final</span> String error =\n <span class=\"number\">77</span>:                             String.format(<span class=\"string\">\"do Message Filter Exception, ConsumerGroup: %s Topic: %s \"</span>,\n <span class=\"number\">78</span>:                                 requestHeader.getConsumerGroup(), requestHeader.getTopic());\n <span class=\"number\">79</span>:                         log.error(error, e);\n <span class=\"number\">80</span>: \n <span class=\"number\">81</span>:                         response.setCode(ResponseCode.SYSTEM_ERROR);\n <span class=\"number\">82</span>:                         response.setRemark(error + RemotingHelper.exceptionSimpleDesc(e));\n <span class=\"number\">83</span>:                         returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, <span class=\"keyword\">null</span>);\n <span class=\"number\">84</span>:                         <span class=\"keyword\">return</span>;\n <span class=\"number\">85</span>:                     }\n <span class=\"number\">86</span>: \n <span class=\"number\">87</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">88</span>:                 <span class=\"keyword\">case</span> NO_MATCHED_MSG:\n <span class=\"number\">89</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n <span class=\"number\">90</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">91</span>:                 <span class=\"keyword\">case</span> NO_NEW_MSG:\n <span class=\"number\">92</span>:                     response.setCode(ResponseCode.PULL_NOT_FOUND);\n <span class=\"number\">93</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">94</span>:                 <span class=\"keyword\">case</span> OFFSET_ILLEGAL:\n <span class=\"number\">95</span>:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n <span class=\"number\">96</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">97</span>:                 <span class=\"keyword\">default</span>:\n <span class=\"number\">98</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">99</span>:             }\n<span class=\"number\">100</span>: \n<span class=\"number\">101</span>:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, <span class=\"keyword\">null</span>);\n<span class=\"number\">102</span>:         }\n<span class=\"number\">103</span>: \n<span class=\"number\">104</span>:         <span class=\"meta\">@Override</span>\n<span class=\"number\">105</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onException</span><span class=\"params\">(Throwable e)</span> </span>{\n<span class=\"number\">106</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);\n<span class=\"number\">107</span>:             response.setRemark(<span class=\"string\">\"Pull Callback Exception, \"</span> + RemotingHelper.exceptionSimpleDesc(e));\n<span class=\"number\">108</span>:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, <span class=\"keyword\">null</span>);\n<span class=\"number\">109</span>:             <span class=\"keyword\">return</span>;\n<span class=\"number\">110</span>:         }\n<span class=\"number\">111</span>:     };\n<span class=\"number\">112</span>: \n<span class=\"number\">113</span>:     <span class=\"comment\">// æ‹‰å–æ¶ˆæ¯</span>\n<span class=\"number\">114</span>:     pullConsumer.pullBlockIfNotFound(mq, <span class=\"keyword\">null</span>, offset, maxNums, pullCallback);\n<span class=\"number\">115</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;\n<span class=\"number\">116</span>: }\n</code></pre>\n<h1 id=\"5-Filtersrv-é«˜å¯ç”¨\"><a href=\"#5-Filtersrv-é«˜å¯ç”¨\" class=\"headerlink\" title=\"5. Filtersrv é«˜å¯ç”¨\"></a>5. Filtersrv é«˜å¯ç”¨</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrvè¿‡å¯ç”¨.png\" alt=\"Filtersrvè¿‡å¯ç”¨\"></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1008-RocketMQæºç è§£æï¼šFiltersrv.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šFiltersrv</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. Filtersrv æ³¨å†Œåˆ° Broker</a></li>\n<li><a href=\"#\">3. è¿‡æ»¤ç±»</a><ul>\n<li><a href=\"#\">3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç </a></li>\n<li><a href=\"#\">3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç </a></li>\n<li><a href=\"#\">3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç </a></li>\n</ul>\n</li>\n<li><a href=\"#\">4. è¿‡æ»¤æ¶ˆæ¯</a><ul>\n<li><a href=\"#\">4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯</a></li>\n<li><a href=\"#\">4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯</a></li>\n</ul>\n</li>\n<li><a href=\"#\">5. Filtersrv é«˜å¯ç”¨</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p><code>Filtersrv</code> ï¼Œè´Ÿè´£<strong>è‡ªå®šä¹‰è§„åˆ™</strong>è¿‡æ»¤ <code>Consumer</code> ä» <code>Broker</code> æ‹‰å–çš„æ¶ˆæ¯ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrv.png\" alt=\"Filtersrv.png\"></p>\n<p>ä¸ºä»€ä¹ˆ <code>Broker</code> ä¸æä¾›è¿‡æ»¤æ¶ˆæ¯çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹å®˜æ–¹çš„è¯´æ³•ï¼š</p>\n<blockquote>\n<ul>\n<li>Broker ç«¯æ¶ˆæ¯è¿‡æ»¤<br>åœ¨ Broker ä¸­ï¼ŒæŒ‰ç…§ Consumer çš„è¦æ±‚åšè¿‡æ»¤ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ã€‚ ç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ï¼Œå®ç°ç›¸å¯¹å¤æ‚ã€‚<br>(1). æ·˜å® Notify æ”¯æŒå¤šç§è¿‡æ»¤æ–¹å¼ï¼ŒåŒ…å«ç›´æ¥æŒ‰ç…§æ¶ˆæ¯ç±»å‹è¿‡æ»¤ï¼Œçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ï¼Œå‡ ä¹å¯ä»¥æ»¡è¶³æœ€è‹›åˆ»çš„è¿‡æ»¤éœ€æ±‚ã€‚<br>(2). æ·˜å® RocketMQ æ”¯æŒæŒ‰ç…§ç®€å•çš„ Message Tag è¿‡æ»¤ï¼Œä¹Ÿæ”¯æŒæŒ‰ç…§ Message Headerã€body è¿›è¡Œè¿‡æ»¤ã€‚<br>(3). CORBA Notification è§„èŒƒä¸­ä¹Ÿæ”¯æŒçµæ´»çš„è¯­æ³•è¡¨è¾¾å¼è¿‡æ»¤ã€‚  </li>\n<li>Consumer ç«¯æ¶ˆæ¯è¿‡æ»¤<br>è¿™ç§è¿‡æ»¤æ–¹å¼å¯ç”±åº”ç”¨å®Œå…¨è‡ªå®šä¹‰å®ç°ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯å¾ˆå¤šæ— ç”¨çš„æ¶ˆæ¯è¦ä¼ è¾“åˆ° Consumer ç«¯ã€‚</li>\n</ul>\n</blockquote>\n<p><strong>å°±æ˜¯åœ¨è¿™ç§è€ƒè™‘ä¸‹ï¼Œ<code>Filtersrv</code> å‡ºç°äº†ã€‚å‡å°‘äº† <code>Broker</code> çš„è´Ÿæ‹…ï¼Œåˆå‡å°‘äº† <code>Consumer</code> æ¥æ”¶æ— ç”¨çš„æ¶ˆæ¯ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œå¤šäº†ä¸€å±‚ <code>Filtersrv</code> ç½‘ç»œå¼€é”€ã€‚</strong></p>\n<h1 id=\"2-Filtersrv-æ³¨å†Œåˆ°-Broker\"><a href=\"#2-Filtersrv-æ³¨å†Œåˆ°-Broker\" class=\"headerlink\" title=\"2. Filtersrv æ³¨å†Œåˆ° Broker\"></a>2. Filtersrv æ³¨å†Œåˆ° Broker</h1><ul>\n<li>ğŸ¦… ä¸€ä¸ª <code>Filtersrv</code> <strong>åª</strong>å¯¹åº”ä¸€ä¸ª <code>Broker</code>ã€‚</li>\n<li>ğŸ¦… ä¸€ä¸ª <code>Broker</code> å¯ä»¥å¯¹åº”<strong>å¤šä¸ª</strong> <code>Filtersrv</code>ã€‚<strong><code>Filtersrv</code> çš„é«˜å¯ç”¨é€šè¿‡å¯åŠ¨å¤šä¸ª <code>Filtersrv</code> å®ç°</strong>ã€‚</li>\n<li>ğŸ¦… <code>Filtersrv</code> æ³¨å†Œå¤±è´¥æ—¶ï¼Œä¸»åŠ¨<strong>é€€å‡ºå…³é—­</strong>ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FiltersrvController.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">initialize</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"comment\">// å›ºå®šé—´éš”æ³¨å†Œåˆ°Broker</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">10</span>:             FiltersrvController.<span class=\"keyword\">this</span>.registerFilterServerToBroker();</div><div class=\"line\"><span class=\"number\">11</span>:         &#125;</div><div class=\"line\"><span class=\"number\">12</span>:     &#125;, <span class=\"number\">15</span>, <span class=\"number\">10</span>, TimeUnit.SECONDS); <span class=\"comment\">// TODO edit by èŠ‹è‰¿ï¼šinitialDelayæ—¶é—´å¤ªçŸ­ï¼Œå¯èƒ½å¯¼è‡´åˆå§‹åŒ–å¤±è´¥ã€‚ä»3=ã€‹15</span></div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">15</span>: &#125;</div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>: <span class=\"comment\">/**</span></div><div class=\"line\">18:  * æ³¨å†ŒFiltersrv åˆ° Broker</div><div class=\"line\">19:  * ï¼ï¼ï¼å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œå…³é—­Filtersrv</div><div class=\"line\">20:  */</div><div class=\"line\"><span class=\"number\">21</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerFilterServerToBroker</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">23</span>:         RegisterFilterServerResponseHeader responseHeader =</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">this</span>.filterServerOuterAPI.registerFilterServerToBroker(</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"keyword\">this</span>.filtersrvConfig.getConnectWhichBroker(), <span class=\"keyword\">this</span>.localAddr());</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">this</span>.defaultMQPullConsumer.getDefaultMQPullConsumerImpl().getPullAPIWrapper()</div><div class=\"line\"><span class=\"number\">27</span>:             .setDefaultBrokerId(responseHeader.getBrokerId());</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == <span class=\"keyword\">this</span>.brokerName) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             <span class=\"keyword\">this</span>.brokerName = responseHeader.getBrokerName();</div><div class=\"line\"><span class=\"number\">31</span>:         &#125;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>:         log.info(<span class=\"string\">\"register filter server&lt;&#123;&#125;&gt; to broker&lt;&#123;&#125;&gt; OK, Return: &#123;&#125; &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">this</span>.localAddr(),</div><div class=\"line\"><span class=\"number\">35</span>:             <span class=\"keyword\">this</span>.filtersrvConfig.getConnectWhichBroker(),</div><div class=\"line\"><span class=\"number\">36</span>:             responseHeader.getBrokerName(),</div><div class=\"line\"><span class=\"number\">37</span>:             responseHeader.getBrokerId());</div><div class=\"line\"><span class=\"number\">38</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:         log.warn(<span class=\"string\">\"register filter server Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">40</span>: </div><div class=\"line\"><span class=\"number\">41</span>:         log.warn(<span class=\"string\">\"access broker failed, kill oneself\"</span>);</div><div class=\"line\"><span class=\"number\">42</span>:         System.exit(-<span class=\"number\">1</span>); <span class=\"comment\">// å¼‚å¸¸é€€å‡º</span></div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-è¿‡æ»¤ç±»\"><a href=\"#3-è¿‡æ»¤ç±»\" class=\"headerlink\" title=\"3. è¿‡æ»¤ç±»\"></a>3. è¿‡æ»¤ç±»</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrvè¿‡æ»¤ç±».png\" alt=\"Filtersrvè¿‡æ»¤ç±»\"></p>\n<h2 id=\"3-1-Consumer-è®¢é˜…æ—¶è®¾ç½®-è¿‡æ»¤ç±»ä»£ç \"><a href=\"#3-1-Consumer-è®¢é˜…æ—¶è®¾ç½®-è¿‡æ»¤ç±»ä»£ç \" class=\"headerlink\" title=\"3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç \"></a>3.1 Consumer è®¢é˜…æ—¶è®¾ç½® è¿‡æ»¤ç±»ä»£ç </h2><ul>\n<li>ğŸ¦… <code>Consumer</code> é’ˆå¯¹æ¯ä¸ª <code>Topic</code> å¯ä»¥è®¢é˜…ä¸åŒçš„ <code>è¿‡æ»¤ç±»ä»£ç </code>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQPushConsumer.javaã€‘</span></div><div class=\"line\"><span class=\"number\">2</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">3</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">subscribe</span><span class=\"params\">(String topic, String fullClassName, String filterClassSource)</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</div><div class=\"line\"><span class=\"number\">4</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.subscribe(topic, fullClassName, filterClassSource);</div><div class=\"line\"><span class=\"number\">5</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"3-2-Consumer-ä¸Šä¼ -è¿‡æ»¤ç±»ä»£ç \"><a href=\"#3-2-Consumer-ä¸Šä¼ -è¿‡æ»¤ç±»ä»£ç \" class=\"headerlink\" title=\"3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç \"></a>3.2 Consumer ä¸Šä¼  è¿‡æ»¤ç±»ä»£ç </h2><ul>\n<li>ğŸ¦… <code>Consumer</code> å¿ƒè·³æ³¨å†Œåˆ° <code>Broker</code> çš„åŒæ—¶ï¼Œä¸Šä¼  <code>è¿‡æ»¤ç±»ä»£ç </code> åˆ° <code>Broker</code> å¯¹åº”çš„<strong>æ‰€æœ‰</strong> <code>Filtersrv</code>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MQClientInstance.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * å‘é€å¿ƒè·³åˆ°Brokerï¼Œä¸Šä¼ è¿‡æ»¤ç±»æºç åˆ°Filtersrv</div><div class=\"line\"> 4:  */</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendHeartbeatToAllBrokerWithLock</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lockHeartbeat.tryLock()) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"keyword\">this</span>.sendHeartbeatToAllBroker();</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">this</span>.uploadFilterClassSource();</div><div class=\"line\"><span class=\"number\">10</span>:         &#125; <span class=\"keyword\">catch</span> (<span class=\"keyword\">final</span> Exception e) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:             log.error(<span class=\"string\">\"sendHeartbeatToAllBroker exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">12</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">this</span>.lockHeartbeat.unlock();</div><div class=\"line\"><span class=\"number\">14</span>:         &#125;</div><div class=\"line\"><span class=\"number\">15</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">16</span>:         log.warn(<span class=\"string\">\"lock heartBeat, but failed.\"</span>);</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: &#125;</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>: <span class=\"comment\">/**</span></div><div class=\"line\">21:  * ä¸Šä¼ è¿‡æ»¤ç±»åˆ°Filtersrv</div><div class=\"line\">22:  */</div><div class=\"line\"><span class=\"number\">23</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">uploadFilterClassSource</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">24</span>:     Iterator&lt;Entry&lt;String, MQConsumerInner&gt;&gt; it = <span class=\"keyword\">this</span>.consumerTable.entrySet().iterator();</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"keyword\">while</span> (it.hasNext()) &#123;</div><div class=\"line\"><span class=\"number\">26</span>:         Entry&lt;String, MQConsumerInner&gt; next = it.next();</div><div class=\"line\"><span class=\"number\">27</span>:         MQConsumerInner consumer = next.getValue();</div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">if</span> (ConsumeType.CONSUME_PASSIVELY == consumer.consumeType()) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:             Set&lt;SubscriptionData&gt; subscriptions = consumer.subscriptions();</div><div class=\"line\"><span class=\"number\">30</span>:             <span class=\"keyword\">for</span> (SubscriptionData sub : subscriptions) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                 <span class=\"keyword\">if</span> (sub.isClassFilterMode() &amp;&amp; sub.getFilterClassSource() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                     <span class=\"keyword\">final</span> String consumerGroup = consumer.groupName();</div><div class=\"line\"><span class=\"number\">33</span>:                     <span class=\"keyword\">final</span> String className = sub.getSubString();</div><div class=\"line\"><span class=\"number\">34</span>:                     <span class=\"keyword\">final</span> String topic = sub.getTopic();</div><div class=\"line\"><span class=\"number\">35</span>:                     <span class=\"keyword\">final</span> String filterClassSource = sub.getFilterClassSource();</div><div class=\"line\"><span class=\"number\">36</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">37</span>:                         <span class=\"keyword\">this</span>.uploadFilterClassToAllFilterServer(consumerGroup, className, topic, filterClassSource);</div><div class=\"line\"><span class=\"number\">38</span>:                     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:                         log.error(<span class=\"string\">\"uploadFilterClassToAllFilterServer Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">40</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">41</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">42</span>:             &#125;</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>:     &#125;</div><div class=\"line\"><span class=\"number\">45</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"3-3-Filter-ç¼–è¯‘-è¿‡æ»¤ç±»ä»£ç \"><a href=\"#3-3-Filter-ç¼–è¯‘-è¿‡æ»¤ç±»ä»£ç \" class=\"headerlink\" title=\"3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç \"></a>3.3 Filter ç¼–è¯‘ è¿‡æ»¤ç±»ä»£ç </h2><ul>\n<li>ğŸ¦… <code>Filtersrv</code> å¤„ç† <code>Consumer</code> ä¸Šä¼ çš„ <code>è¿‡æ»¤ç±»ä»£ç </code>ï¼Œå¹¶è¿›è¡Œ<strong>ç¼–è¯‘</strong>ä½¿ç”¨ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FilterClassManager.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ³¨å†Œè¿‡æ»¤ç±»</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> consumerGroup æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> topic Topic</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> className è¿‡æ»¤ç±»å</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> classCRC è¿‡æ»¤ç±»æºç CRC</div><div class=\"line\"> 9:  * <span class=\"doctag\">@param</span> filterSourceBinary è¿‡æ»¤ç±»æºç </div><div class=\"line\">10:  * <span class=\"doctag\">@return</span> æ˜¯å¦æ³¨å†ŒæˆåŠŸ</div><div class=\"line\">11:  */</div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">registerFilterClass</span><span class=\"params\">(<span class=\"keyword\">final</span> String consumerGroup, <span class=\"keyword\">final</span> String topic,</span></span></div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">final</span> String className, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> classCRC, <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] filterSourceBinary) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">final</span> String key = buildKey(consumerGroup, topic);</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"comment\">// åˆ¤æ–­æ˜¯å¦è¦æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»</span></div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">boolean</span> registerNew = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">17</span>:     FilterClassInfo filterClassInfoPrev = <span class=\"keyword\">this</span>.filterClassTable.get(key);</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == filterClassInfoPrev) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:         registerNew = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">if</span> (filterClassInfoPrev.getClassCRC() != classCRC &amp;&amp; classCRC != <span class=\"number\">0</span>) &#123; <span class=\"comment\">// ç±»æœ‰å˜åŒ–</span></div><div class=\"line\"><span class=\"number\">23</span>:                 registerNew = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">24</span>:             &#125;</div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"comment\">// æ³¨å†Œæ–°çš„è¿‡æ»¤ç±»</span></div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">if</span> (registerNew) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>.compileLock) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             filterClassInfoPrev = <span class=\"keyword\">this</span>.filterClassTable.get(key);</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != filterClassInfoPrev &amp;&amp; filterClassInfoPrev.getClassCRC() == classCRC) &#123;</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">33</span>:             &#125;</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">35</span>:                 FilterClassInfo filterClassInfoNew = <span class=\"keyword\">new</span> FilterClassInfo();</div><div class=\"line\"><span class=\"number\">36</span>:                 filterClassInfoNew.setClassName(className);</div><div class=\"line\"><span class=\"number\">37</span>:                 filterClassInfoNew.setClassCRC(<span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">38</span>:                 filterClassInfoNew.setMessageFilter(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.filtersrvController.getFiltersrvConfig().isClientUploadFilterClassEnable()) &#123;</div><div class=\"line\"><span class=\"number\">41</span>:                     String javaSource = <span class=\"keyword\">new</span> String(filterSourceBinary, MixAll.DEFAULT_CHARSET);</div><div class=\"line\"><span class=\"number\">42</span>:                     <span class=\"comment\">// ç¼–è¯‘æ–°çš„è¿‡æ»¤ç±»</span></div><div class=\"line\"><span class=\"number\">43</span>:                     Class&lt;?&gt; newClass = DynaCode.compileAndLoadClass(className, javaSource);</div><div class=\"line\"><span class=\"number\">44</span>:                     <span class=\"comment\">// åˆ›å»ºæ–°çš„è¿‡æ»¤ç±»å¯¹è±¡</span></div><div class=\"line\"><span class=\"number\">45</span>:                     Object newInstance = newClass.newInstance();</div><div class=\"line\"><span class=\"number\">46</span>:                     filterClassInfoNew.setMessageFilter((MessageFilter) newInstance);</div><div class=\"line\"><span class=\"number\">47</span>:                     filterClassInfoNew.setClassCRC(classCRC);</div><div class=\"line\"><span class=\"number\">48</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">49</span>: </div><div class=\"line\"><span class=\"number\">50</span>:                 <span class=\"keyword\">this</span>.filterClassTable.put(key, filterClassInfoNew);</div><div class=\"line\"><span class=\"number\">51</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:                 String info = String.format(<span class=\"string\">\"FilterServer, registerFilterClass Exception, consumerGroup: %s topic: %s className: %s\"</span>,</div><div class=\"line\"><span class=\"number\">53</span>:                             consumerGroup, topic, className);</div><div class=\"line\"><span class=\"number\">54</span>:                 log.error(info, e);</div><div class=\"line\"><span class=\"number\">55</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">56</span>:             &#125;</div><div class=\"line\"><span class=\"number\">57</span>:         &#125;</div><div class=\"line\"><span class=\"number\">58</span>:     &#125;</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">61</span>: &#125;</div></pre></td></tr></table></figure>\n<hr>\n<h1 id=\"4-è¿‡æ»¤æ¶ˆæ¯\"><a href=\"#4-è¿‡æ»¤æ¶ˆæ¯\" class=\"headerlink\" title=\"4. è¿‡æ»¤æ¶ˆæ¯\"></a>4. è¿‡æ»¤æ¶ˆæ¯</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrv.png\" alt=\"Filtersrv.png\"></p>\n<h2 id=\"4-1-Consumer-ä»-Filtersrv-æ‹‰å–æ¶ˆæ¯\"><a href=\"#4-1-Consumer-ä»-Filtersrv-æ‹‰å–æ¶ˆæ¯\" class=\"headerlink\" title=\"4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯\"></a>4.1 Consumer ä» Filtersrv æ‹‰å–æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦… <code>Consumer</code> æ‹‰å– <strong>ä½¿ç”¨è¿‡æ»¤ç±»æ–¹å¼è®¢é˜…</strong> çš„æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä» <code>Broker</code> å¯¹åº”çš„ <code>Filtersrv</code> åˆ—è¡¨<strong>éšæœº</strong>é€‰æ‹©ä¸€ä¸ªæ‹‰å–æ¶ˆæ¯ã€‚<strong>å¦‚æœé€‰æ‹©ä¸åˆ° <code>Filtersrv</code>ï¼Œåˆ™æ— æ³•æ‹‰å–æ¶ˆæ¯ã€‚å› æ­¤ï¼Œ<code>Filtersrv</code> ä¸€å®šè¦åšé«˜å¯ç”¨</strong>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€PullAPIWrapper.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯å˜Ÿåˆ—</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> subExpression è®¢é˜…è¡¨è¾¾å¼</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> subVersion è®¢é˜…ç‰ˆæœ¬å·</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class=\"line\"> 9:  * <span class=\"doctag\">@param</span> maxNums æ‰¹é‡æ‹‰ å–æ¶ˆæ¯æ•°é‡</div><div class=\"line\">10:  * <span class=\"doctag\">@param</span> sysFlag æ‹‰å–ç³»ç»Ÿæ ‡è¯†</div><div class=\"line\">11:  * <span class=\"doctag\">@param</span> commitOffset æäº¤æ¶ˆè´¹è¿›åº¦</div><div class=\"line\">12:  * <span class=\"doctag\">@param</span> brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´</div><div class=\"line\">13:  * <span class=\"doctag\">@param</span> timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é—´</div><div class=\"line\">14:  * <span class=\"doctag\">@param</span> communicationMode é€šè®¯æ¨¡å¼</div><div class=\"line\">15:  * <span class=\"doctag\">@param</span> pullCallback æ‹‰å–å›è°ƒ</div><div class=\"line\">16:  * <span class=\"doctag\">@return</span> æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚</div><div class=\"line\">17:  * <span class=\"doctag\">@throws</span> MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸</div><div class=\"line\">18:  * <span class=\"doctag\">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">19:  * <span class=\"doctag\">@throws</span> MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚</div><div class=\"line\">20:  * <span class=\"doctag\">@throws</span> InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶</div><div class=\"line\">21:  */</div><div class=\"line\"><span class=\"number\">22</span>: <span class=\"function\"><span class=\"keyword\">protected</span> PullResult <span class=\"title\">pullKernelImpl</span><span class=\"params\">(</span></span></div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"keyword\">final</span> MessageQueue mq,</div><div class=\"line\"><span class=\"number\">24</span>:     <span class=\"keyword\">final</span> String subExpression,</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> subVersion,</div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset,</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxNums,</div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> sysFlag,</div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> commitOffset,</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> brokerSuspendMaxTimeMillis,</div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeoutMillis,</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode,</div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"keyword\">final</span> PullCallback pullCallback</div><div class=\"line\"><span class=\"number\">34</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"comment\">// // ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"comment\">// è¯·æ±‚æ‹‰å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"keyword\">if</span> (findBrokerResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"comment\">// è‹¥è®¢é˜…topicä½¿ç”¨è¿‡æ»¤ç±»ï¼Œä½¿ç”¨filtersrvè·å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">40</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class=\"line\"><span class=\"number\">41</span>:         <span class=\"keyword\">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:         PullResult pullResult = <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class=\"line\"><span class=\"number\">46</span>:             brokerAddr,</div><div class=\"line\"><span class=\"number\">47</span>:             requestHeader,</div><div class=\"line\"><span class=\"number\">48</span>:             timeoutMillis,</div><div class=\"line\"><span class=\"number\">49</span>:             communicationMode,</div><div class=\"line\"><span class=\"number\">50</span>:             pullCallback);</div><div class=\"line\"><span class=\"number\">51</span>: </div><div class=\"line\"><span class=\"number\">52</span>:         <span class=\"keyword\">return</span> pullResult;</div><div class=\"line\"><span class=\"number\">53</span>:     &#125;</div><div class=\"line\"><span class=\"number\">54</span>: </div><div class=\"line\"><span class=\"number\">55</span>:     <span class=\"comment\">// Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">56</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"The broker[\"</span> + mq.getBrokerName() + <span class=\"string\">\"] not exist\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">57</span>: &#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>: <span class=\"comment\">/**</span></div><div class=\"line\">60:  * è®¡ç®—filtersrvåœ°å€ã€‚å¦‚æœæœ‰å¤šä¸ªfiltersrvï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªã€‚</div><div class=\"line\">61:  *</div><div class=\"line\">62:  * <span class=\"doctag\">@param</span> topic Topic</div><div class=\"line\">63:  * <span class=\"doctag\">@param</span> brokerAddr brokeråœ°å€</div><div class=\"line\">64:  * <span class=\"doctag\">@return</span> filtersrvåœ°å€</div><div class=\"line\">65:  * <span class=\"doctag\">@throws</span> MQClientException å½“filtersrvä¸å­˜åœ¨æ—¶</div><div class=\"line\">66:  */</div><div class=\"line\"><span class=\"number\">67</span>: <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">computPullFromWhichFilterServer</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> String brokerAddr)</span></span></div><div class=\"line\">68:     <span class=\"keyword\">throws</span> MQClientException &#123;</div><div class=\"line\"><span class=\"number\">69</span>:     ConcurrentHashMap&lt;String, TopicRouteData&gt; topicRouteTable = <span class=\"keyword\">this</span>.mQClientFactory.getTopicRouteTable();</div><div class=\"line\"><span class=\"number\">70</span>:     <span class=\"keyword\">if</span> (topicRouteTable != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">71</span>:         TopicRouteData topicRouteData = topicRouteTable.get(topic);</div><div class=\"line\"><span class=\"number\">72</span>:         List&lt;String&gt; list = topicRouteData.getFilterServerTable().get(brokerAddr);</div><div class=\"line\"><span class=\"number\">73</span>:         <span class=\"keyword\">if</span> (list != <span class=\"keyword\">null</span> &amp;&amp; !list.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">74</span>:             <span class=\"keyword\">return</span> list.get(randomNum() % list.size());</div><div class=\"line\"><span class=\"number\">75</span>:         &#125;</div><div class=\"line\"><span class=\"number\">76</span>:     &#125;</div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"Find Filter Server Failed, Broker Addr: \"</span> + brokerAddr + <span class=\"string\">\" topic: \"</span></div><div class=\"line\"><span class=\"number\">78</span>:         + topic, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">79</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"4-2-Filtersrv-ä»-Broker-æ‹‰å–æ¶ˆæ¯\"><a href=\"#4-2-Filtersrv-ä»-Broker-æ‹‰å–æ¶ˆæ¯\" class=\"headerlink\" title=\"4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯\"></a>4.2 Filtersrv ä» Broker æ‹‰å–æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦… <code>Filtersrv</code> æ‹‰å–æ¶ˆæ¯åï¼Œä¼šå»ºè®® <code>Consumer</code> å‘ <code>Brokerä¸»èŠ‚ç‚¹</code> æ‹‰å–æ¶ˆæ¯ã€‚</li>\n<li>ğŸ¦… <code>Filtersrv</code> å¯ä»¥ç†è§£æˆä¸€ä¸ª <code>Consumer</code>ï¼Œå‘ <code>Broker</code> æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå®é™…ä½¿ç”¨çš„ <code>DefaultMQPullConsumer.java</code> çš„æ–¹æ³•å’Œé€»è¾‘ã€‚</li>\n</ul>\n<pre><code class=\"Java\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultRequestProcessor.javaã€‘</span>\n  <span class=\"number\">2</span>: <span class=\"comment\">/**\n  3:  * æ‹‰å–æ¶ˆæ¯\n  4:  *\n  5:  * <span class=\"doctag\">@param</span> ctx æ‹‰å–æ¶ˆæ¯context\n  6:  * <span class=\"doctag\">@param</span> request æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n  7:  * <span class=\"doctag\">@return</span> å“åº”\n  8:  * <span class=\"doctag\">@throws</span> Exception å½“å‘ç”Ÿå¼‚å¸¸æ—¶\n  9:  */</span>\n <span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">pullMessageForward</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx, <span class=\"keyword\">final</span> RemotingCommand request)</span> <span class=\"keyword\">throws</span> Exception </span>{\n <span class=\"number\">11</span>:     <span class=\"keyword\">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);\n <span class=\"number\">12</span>:     <span class=\"keyword\">final</span> PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();\n <span class=\"number\">13</span>:     <span class=\"keyword\">final</span> PullMessageRequestHeader requestHeader =\n <span class=\"number\">14</span>:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);\n <span class=\"number\">15</span>: \n <span class=\"number\">16</span>:     <span class=\"keyword\">final</span> FilterContext filterContext = <span class=\"keyword\">new</span> FilterContext();\n <span class=\"number\">17</span>:     filterContext.setConsumerGroup(requestHeader.getConsumerGroup());\n <span class=\"number\">18</span>: \n <span class=\"number\">19</span>:     response.setOpaque(request.getOpaque());\n <span class=\"number\">20</span>: \n <span class=\"number\">21</span>:     DefaultMQPullConsumer pullConsumer = <span class=\"keyword\">this</span>.filtersrvController.getDefaultMQPullConsumer();\n <span class=\"number\">22</span>: \n <span class=\"number\">23</span>:     <span class=\"comment\">// æ ¡éªŒTopicè¿‡æ»¤ç±»æ˜¯å¦å®Œæ•´</span>\n <span class=\"number\">24</span>:     <span class=\"keyword\">final</span> FilterClassInfo findFilterClass = <span class=\"keyword\">this</span>.filtersrvController.getFilterClassManager().findFilterClass(requestHeader.getConsumerGroup(), requestHeader.getTopic());\n <span class=\"number\">25</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == findFilterClass) {\n <span class=\"number\">26</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);\n <span class=\"number\">27</span>:         response.setRemark(<span class=\"string\">\"Find Filter class failed, not registered\"</span>);\n <span class=\"number\">28</span>:         <span class=\"keyword\">return</span> response;\n <span class=\"number\">29</span>:     }\n <span class=\"number\">30</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == findFilterClass.getMessageFilter()) {\n <span class=\"number\">31</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);\n <span class=\"number\">32</span>:         response.setRemark(<span class=\"string\">\"Find Filter class failed, registered but no class\"</span>);\n <span class=\"number\">33</span>:         <span class=\"keyword\">return</span> response;\n <span class=\"number\">34</span>:     }\n <span class=\"number\">35</span>: \n <span class=\"number\">36</span>:     <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡è¯·æ±‚ä» Brokerä¸»èŠ‚ç‚¹ã€‚</span>\n <span class=\"number\">37</span>:     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n <span class=\"number\">38</span>: \n <span class=\"number\">39</span>:     MessageQueue mq = <span class=\"keyword\">new</span> MessageQueue();\n <span class=\"number\">40</span>:     mq.setTopic(requestHeader.getTopic());\n <span class=\"number\">41</span>:     mq.setQueueId(requestHeader.getQueueId());\n <span class=\"number\">42</span>:     mq.setBrokerName(<span class=\"keyword\">this</span>.filtersrvController.getBrokerName());\n <span class=\"number\">43</span>:     <span class=\"keyword\">long</span> offset = requestHeader.getQueueOffset();\n <span class=\"number\">44</span>:     <span class=\"keyword\">int</span> maxNums = requestHeader.getMaxMsgNums();\n <span class=\"number\">45</span>: \n <span class=\"number\">46</span>:     <span class=\"keyword\">final</span> PullCallback pullCallback = <span class=\"keyword\">new</span> PullCallback() {\n <span class=\"number\">47</span>: \n <span class=\"number\">48</span>:         <span class=\"meta\">@Override</span>\n <span class=\"number\">49</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onSuccess</span><span class=\"params\">(PullResult pullResult)</span> </span>{\n <span class=\"number\">50</span>:             responseHeader.setMaxOffset(pullResult.getMaxOffset());\n <span class=\"number\">51</span>:             responseHeader.setMinOffset(pullResult.getMinOffset());\n <span class=\"number\">52</span>:             responseHeader.setNextBeginOffset(pullResult.getNextBeginOffset());\n <span class=\"number\">53</span>:             response.setRemark(<span class=\"keyword\">null</span>);\n <span class=\"number\">54</span>: \n <span class=\"number\">55</span>:             <span class=\"keyword\">switch</span> (pullResult.getPullStatus()) {\n <span class=\"number\">56</span>:                 <span class=\"keyword\">case</span> FOUND:\n <span class=\"number\">57</span>:                     response.setCode(ResponseCode.SUCCESS);\n <span class=\"number\">58</span>: \n <span class=\"number\">59</span>:                     List&lt;MessageExt&gt; msgListOK = <span class=\"keyword\">new</span> ArrayList&lt;MessageExt&gt;();\n <span class=\"number\">60</span>:                     <span class=\"keyword\">try</span> {\n <span class=\"number\">61</span>:                         <span class=\"keyword\">for</span> (MessageExt msg : pullResult.getMsgFoundList()) {\n <span class=\"number\">62</span>:                             <span class=\"comment\">// ä½¿ç”¨è¿‡æ»¤ç±»è¿‡æ»¤æ¶ˆæ¯</span>\n <span class=\"number\">63</span>:                             <span class=\"keyword\">boolean</span> match = findFilterClass.getMessageFilter().match(msg, filterContext);\n <span class=\"number\">64</span>:                             <span class=\"keyword\">if</span> (match) {\n <span class=\"number\">65</span>:                                 msgListOK.add(msg);\n <span class=\"number\">66</span>:                             }\n <span class=\"number\">67</span>:                         }\n <span class=\"number\">68</span>: \n <span class=\"number\">69</span>:                         <span class=\"keyword\">if</span> (!msgListOK.isEmpty()) {\n <span class=\"number\">70</span>:                             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, msgListOK);\n <span class=\"number\">71</span>:                             <span class=\"keyword\">return</span>;\n <span class=\"number\">72</span>:                         } <span class=\"keyword\">else</span> {\n <span class=\"number\">73</span>:                             response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n <span class=\"number\">74</span>:                         }\n <span class=\"number\">75</span>:                     } <span class=\"keyword\">catch</span> (Throwable e) {\n <span class=\"number\">76</span>:                         <span class=\"keyword\">final</span> String error =\n <span class=\"number\">77</span>:                             String.format(<span class=\"string\">\"do Message Filter Exception, ConsumerGroup: %s Topic: %s \"</span>,\n <span class=\"number\">78</span>:                                 requestHeader.getConsumerGroup(), requestHeader.getTopic());\n <span class=\"number\">79</span>:                         log.error(error, e);\n <span class=\"number\">80</span>: \n <span class=\"number\">81</span>:                         response.setCode(ResponseCode.SYSTEM_ERROR);\n <span class=\"number\">82</span>:                         response.setRemark(error + RemotingHelper.exceptionSimpleDesc(e));\n <span class=\"number\">83</span>:                         returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, <span class=\"keyword\">null</span>);\n <span class=\"number\">84</span>:                         <span class=\"keyword\">return</span>;\n <span class=\"number\">85</span>:                     }\n <span class=\"number\">86</span>: \n <span class=\"number\">87</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">88</span>:                 <span class=\"keyword\">case</span> NO_MATCHED_MSG:\n <span class=\"number\">89</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n <span class=\"number\">90</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">91</span>:                 <span class=\"keyword\">case</span> NO_NEW_MSG:\n <span class=\"number\">92</span>:                     response.setCode(ResponseCode.PULL_NOT_FOUND);\n <span class=\"number\">93</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">94</span>:                 <span class=\"keyword\">case</span> OFFSET_ILLEGAL:\n <span class=\"number\">95</span>:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n <span class=\"number\">96</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">97</span>:                 <span class=\"keyword\">default</span>:\n <span class=\"number\">98</span>:                     <span class=\"keyword\">break</span>;\n <span class=\"number\">99</span>:             }\n<span class=\"number\">100</span>: \n<span class=\"number\">101</span>:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, <span class=\"keyword\">null</span>);\n<span class=\"number\">102</span>:         }\n<span class=\"number\">103</span>: \n<span class=\"number\">104</span>:         <span class=\"meta\">@Override</span>\n<span class=\"number\">105</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onException</span><span class=\"params\">(Throwable e)</span> </span>{\n<span class=\"number\">106</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);\n<span class=\"number\">107</span>:             response.setRemark(<span class=\"string\">\"Pull Callback Exception, \"</span> + RemotingHelper.exceptionSimpleDesc(e));\n<span class=\"number\">108</span>:             returnResponse(requestHeader.getConsumerGroup(), requestHeader.getTopic(), ctx, response, <span class=\"keyword\">null</span>);\n<span class=\"number\">109</span>:             <span class=\"keyword\">return</span>;\n<span class=\"number\">110</span>:         }\n<span class=\"number\">111</span>:     };\n<span class=\"number\">112</span>: \n<span class=\"number\">113</span>:     <span class=\"comment\">// æ‹‰å–æ¶ˆæ¯</span>\n<span class=\"number\">114</span>:     pullConsumer.pullBlockIfNotFound(mq, <span class=\"keyword\">null</span>, offset, maxNums, pullCallback);\n<span class=\"number\">115</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;\n<span class=\"number\">116</span>: }\n</code></pre>\n<h1 id=\"5-Filtersrv-é«˜å¯ç”¨\"><a href=\"#5-Filtersrv-é«˜å¯ç”¨\" class=\"headerlink\" title=\"5. Filtersrv é«˜å¯ç”¨\"></a>5. Filtersrv é«˜å¯ç”¨</h1><p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1008/Filtersrvè¿‡å¯ç”¨.png\" alt=\"Filtersrvè¿‡å¯ç”¨\"></p>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹","date":"2017-05-12T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1007-RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. Producer é¡ºåºå‘é€](#)\n- [3. Consumer é¡ºåºæ¶ˆè´¹](#)\n\t- [3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—](#)\n\t- [3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—](#)\n\t- [3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—](#)\n\t\t- [3.1.1 æ¶ˆè´¹æ¶ˆæ¯](#)\n\t\t- [3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ](#)\n\t\t- [3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•](#)\n\n# 1. æ¦‚è¿°\n\n**å»ºè®®**å‰ç½®é˜…è¯»å†…å®¹ï¼š\n\n* [ã€ŠMessageå‘é€&æ¥æ”¶ã€‹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1003-RocketMQæºç è§£æï¼šMessageå‘é€&æ¥æ”¶.md)\n* [ã€ŠMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md)\n\nå½“ç„¶å¯¹ `Message` å‘é€ä¸æ¶ˆè´¹å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡ã€‚\n\n-------\n\n`RocketMQ` æä¾›äº†ä¸¤ç§é¡ºåºçº§åˆ«ï¼š\n\n* æ™®é€šé¡ºåºæ¶ˆæ¯ ï¼š`Producer` å°†ç›¸å…³è”çš„æ¶ˆæ¯å‘é€åˆ°ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* å®Œå…¨ä¸¥æ ¼é¡ºåº ï¼šåœ¨ `æ™®é€šé¡ºåºæ¶ˆæ¯` çš„åŸºç¡€ä¸Šï¼Œ`Consumer` ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚\n\nç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹åªéœ€è¦ç”¨åˆ°**æ™®é€šé¡ºåºæ¶ˆæ¯**ã€‚  \nä¾‹å¦‚è¯´ï¼šç»™ç”¨æˆ·å‘é€çŸ­ä¿¡æ¶ˆæ¯ + å‘é€æ¨é€æ¶ˆæ¯ï¼Œå°†ä¸¤æ¡æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‹¥å…¶ä¸­ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è¾ƒæ…¢é€ æˆå µå¡ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ï¼Œå¸¦æ¥çš„ä½“éªŒä¼šç›¸å¯¹è¾ƒå·®ã€‚å½“ç„¶ç±»ä¼¼è¿™ç§åœºæ™¯ï¼Œå³ä½¿æœ‰ä¸€å®šçš„æ—¶é—´å·®ï¼Œ**ä¸ä¼šäº§ç”Ÿç³»ç»Ÿé€»è¾‘ä¸ŠBUG**ã€‚å¦å¤–ï¼Œ`æ™®é€šé¡ºåºæ¶ˆæ¯`æ€§èƒ½èƒ½æ›´åŠ å¥½ã€‚  \né‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä½¿ç”¨**å®Œå…¨ä¸¥æ ¼é¡ºåº**ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼š\n> ç›®å‰å·²çŸ¥çš„åº”ç”¨åªæœ‰æ•°æ®åº“ `binlog` åŒæ­¥å¼ºä¾èµ–ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼Œå…¶ä»–åº”ç”¨ç»å¤§éƒ¨åˆ†éƒ½å¯ä»¥å®¹å¿çŸ­æš‚ä¹±åºï¼Œæ¨èä½¿ç”¨æ™®é€šçš„é¡ºåºæ¶ˆæ¯\n\n-------\n\nğŸ˜ˆä¸Šä»£ç ï¼ï¼ï¼\n\n# 2. `Producer` é¡ºåºå‘é€\n\nå®˜æ–¹å‘é€é¡ºåºæ¶ˆæ¯çš„**ä¾‹å­**ï¼š\n\n```Java\n  1: package org.apache.rocketmq.example.ordermessage;\n  2: \n  3: import java.io.UnsupportedEncodingException;\n  4: import java.util.List;\n  5: import org.apache.rocketmq.client.exception.MQBrokerException;\n  6: import org.apache.rocketmq.client.exception.MQClientException;\n  7: import org.apache.rocketmq.client.producer.DefaultMQProducer;\n  8: import org.apache.rocketmq.client.producer.MQProducer;\n  9: import org.apache.rocketmq.client.producer.MessageQueueSelector;\n 10: import org.apache.rocketmq.client.producer.SendResult;\n 11: import org.apache.rocketmq.common.message.Message;\n 12: import org.apache.rocketmq.common.message.MessageQueue;\n 13: import org.apache.rocketmq.remoting.common.RemotingHelper;\n 14: import org.apache.rocketmq.remoting.exception.RemotingException;\n 15: \n 16: public class Producer {\n 17:     public static void main(String[] args) throws UnsupportedEncodingException {\n 18:         try {\n 19:             MQProducer producer = new DefaultMQProducer(\"please_rename_unique_group_name\");\n 20:             producer.start();\n 21: \n 22:             String[] tags = new String[] {\"TagA\", \"TagB\", \"TagC\", \"TagD\", \"TagE\"};\n 23:             for (int i = 0; i < 100; i++) {\n 24:                 int orderId = i % 10;\n 25:                 Message msg =\n 26:                     new Message(\"TopicTestjjj\", tags[i % tags.length], \"KEY\" + i,\n 27:                         (\"Hello RocketMQ \" + i).getBytes(RemotingHelper.DEFAULT_CHARSET));\n 28:                 SendResult sendResult = producer.send(msg, new MessageQueueSelector() {\n 29:                     @Override\n 30:                     public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {\n 31:                         Integer id = (Integer) arg;\n 32:                         int index = id % mqs.size();\n 33:                         return mqs.get(index);\n 34:                     }\n 35:                 }, orderId);\n 36: \n 37:                 System.out.printf(\"%s%n\", sendResult);\n 38:             }\n 39: \n 40:             producer.shutdown();\n 41:         } catch (MQClientException | RemotingException | MQBrokerException | InterruptedException e) {\n 42:             e.printStackTrace();\n 43:         }\n 44:     }\n 45: }\n```\n\n* ç¬¬ 28 è‡³ 35 è¡Œ ï¼šå®ç°äº†æ ¹æ® `id % mqs.size()` æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©ã€‚å½“å‰ä¾‹å­ï¼Œ**æˆ‘ä»¬ä¼ é€’ `orderId` ä½œä¸ºå‚æ•°ï¼Œé‚£ä¹ˆç›¸åŒçš„ `orderId` èƒ½å¤Ÿè¿›å…¥ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—**ã€‚\n\n-------\n\n`MessageQueueSelector` æ¥å£çš„**æºç **ï¼š\n\n```Java\n  1: public interface MessageQueueSelector {\n  2: \n  3:     /**\n  4:      * é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—\n  5:      *\n  6:      * @param mqs æ¶ˆæ¯é˜Ÿåˆ—\n  7:      * @param msg æ¶ˆæ¯\n  8:      * @param arg å‚æ•°\n  9:      * @return æ¶ˆæ¯é˜Ÿåˆ—\n 10:      */\n 11:     MessageQueue select(final List<MessageQueue> mqs, final Message msg, final Object arg);\n 12: }\n```\n-------\n\n`Producer` é€‰æ‹©é˜Ÿåˆ—å‘é€æ¶ˆæ¯æ–¹æ³•çš„**æºç **ï¼š\n\n```Java\n 16: private SendResult sendSelectImpl(//\n 17:     Message msg, //\n 18:     MessageQueueSelector selector, //\n 19:     Object arg, //\n 20:     final CommunicationMode communicationMode, //\n 21:     final SendCallback sendCallback, final long timeout//\n 22: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n 23:     this.makeSureStateOK();\n 24:     Validators.checkMessage(msg, this.defaultMQProducer);\n 25: \n 26:     TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());\n 27:     if (topicPublishInfo != null && topicPublishInfo.ok()) {\n 28:         MessageQueue mq = null;\n 29:         try {\n 30:             mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);\n 31:         } catch (Throwable e) {\n 32:             throw new MQClientException(\"select message queue throwed exception.\", e);\n 33:         }\n 34: \n 35:         if (mq != null) {\n 36:             return this.sendKernelImpl(msg, mq, communicationMode, sendCallback, null, timeout);\n 37:         } else {\n 38:             throw new MQClientException(\"select message queue return null.\", null);\n 39:         }\n 40:     }\n 41: \n 42:     throw new MQClientException(\"No route info for this topic, \" + msg.getTopic(), null);\n 43: }\n```\n\n* ç¬¬ 30 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 36 è¡Œ ï¼šå‘é€æ¶ˆæ¯ã€‚\n\n# 3. `Consumer` ä¸¥æ ¼é¡ºåºæ¶ˆè´¹\n\n`Consumer` åœ¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹æ—¶ï¼Œé€šè¿‡ **ä¸‰** æŠŠé”ä¿è¯ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚\n\n* `Broker` æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ**åˆ†å¸ƒå¼é”**ï¼‰ ï¼š\n    * é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ`Consumer` ä» `Broker` è·å¾—è¯¥é”åï¼Œæ‰èƒ½è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€æ¶ˆè´¹ã€‚\n    * å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œ`Consumer` æ— éœ€è¯¥é”ã€‚\n* `Consumer` æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ**æœ¬åœ°é”**ï¼‰ ï¼š`Consumer` è·å¾—è¯¥é”æ‰èƒ½æ“ä½œæ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* `Consumer` æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ï¼ˆ**æœ¬åœ°é”**ï¼‰ ï¼š`Consumer` è·å¾—è¯¥é”æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n\n**å¯èƒ½åŒå­¦æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæœ‰ `Consumer` æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ `Consumer` æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢**ï¼ŸğŸ˜ˆè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®ç»§ç»­å¾€ä¸‹çœ‹ã€‚\n\n-------\n\n## 3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—\n\n**é›†ç¾¤æ¨¡å¼**ä¸‹ï¼Œ`Consumer` æ›´æ–°å±äºè‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ `Broker` é”å®šè¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ*å¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦*ï¼‰ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œåˆ™æ›´æ–°å¤±è´¥ï¼Œå³è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸å±äºè‡ªå·±ï¼Œä¸èƒ½è¿›è¡Œæ¶ˆè´¹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘\n  2: private boolean updateProcessQueueTableInRebalance(final String topic, final Set<MessageQueue> mqSet, final boolean isOrder) {\n  3: // ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  \n  4:     // å¢åŠ  ä¸åœ¨processQueueTable && å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n  5:     List<PullRequest> pullRequestList = new ArrayList<>(); // æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„\n  6:     for (MessageQueue mq : mqSet) {\n  7:         if (!this.processQueueTable.containsKey(mq)) {\n  8:             if (isOrder && !this.lock(mq)) { // é¡ºåºæ¶ˆæ¯é”å®šæ¶ˆæ¯é˜Ÿåˆ—\n  9:                 log.warn(\"doRebalance, {}, add a new mq failed, {}, because lock failed\", consumerGroup, mq);\n 10:                 continue;\n 11:             }\n 12: \n 13:             this.removeDirtyOffset(mq);\n 14:             ProcessQueue pq = new ProcessQueue();\n 15:             long nextOffset = this.computePullFromWhere(mq);\n 16:             if (nextOffset >= 0) {\n 17:                 ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq);\n 18:                 if (pre != null) {\n 19:                     log.info(\"doRebalance, {}, mq already exists, {}\", consumerGroup, mq);\n 20:                 } else {\n 21:                     log.info(\"doRebalance, {}, add a new mq, {}\", consumerGroup, mq);\n 22:                     PullRequest pullRequest = new PullRequest();\n 23:                     pullRequest.setConsumerGroup(consumerGroup);\n 24:                     pullRequest.setNextOffset(nextOffset);\n 25:                     pullRequest.setMessageQueue(mq);\n 26:                     pullRequest.setProcessQueue(pq);\n 27:                     pullRequestList.add(pullRequest);\n 28:                     changed = true;\n 29:                 }\n 30:             } else {\n 31:                 log.warn(\"doRebalance, {}, add new mq failed, {}\", consumerGroup, mq);\n 32:             }\n 33:         }\n 34:     }\n 35: \n 36: // ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  \n 37: }\n 38: \n 39: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘\n 40: /**\n 41:  * è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”\n 42:  *\n 43:  * @param mq é˜Ÿåˆ—\n 44:  * @return æ˜¯å¦æˆåŠŸ\n 45:  */\n 46: public boolean lock(final MessageQueue mq) {\n 47:     FindBrokerResult findBrokerResult = this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(), MixAll.MASTER_ID, true);\n 48:     if (findBrokerResult != null) {\n 49:         LockBatchRequestBody requestBody = new LockBatchRequestBody();\n 50:         requestBody.setConsumerGroup(this.consumerGroup);\n 51:         requestBody.setClientId(this.mQClientFactory.getClientId());\n 52:         requestBody.getMqSet().add(mq);\n 53: \n 54:         try {\n 55:             // è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”\n 56:             Set<MessageQueue> lockedMq =\n 57:                 this.mQClientFactory.getMQClientAPIImpl().lockBatchMQ(findBrokerResult.getBrokerAddr(), requestBody, 1000);\n 58: \n 59:             // è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é”å®šæˆåŠŸã€‚é”å®šæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸï¼Œå¯èƒ½æœ¬åœ°æ²¡æœ‰æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ï¼Œè®¾ç½®é”å®šæˆåŠŸä¼šåœ¨lockAll()æ–¹æ³•ã€‚\n 60:             for (MessageQueue mmqq : lockedMq) {\n 61:                 ProcessQueue processQueue = this.processQueueTable.get(mmqq);\n 62:                 if (processQueue != null) {\n 63:                     processQueue.setLocked(true);\n 64:                     processQueue.setLastLockTimestamp(System.currentTimeMillis());\n 65:                 }\n 66:             }\n 67: \n 68:             boolean lockOK = lockedMq.contains(mq);\n 69:             log.info(\"the message queue lock {}, {} {}\",\n 70:                 lockOK ? \"OK\" : \"Failed\",\n 71:                 this.consumerGroup,\n 72:                 mq);\n 73:             return lockOK;\n 74:         } catch (Exception e) {\n 75:             log.error(\"lockBatchMQ exception, \" + mq, e);\n 76:         }\n 77:     }\n 78: \n 79:     return false;\n 80: }\n```\n\n* â¬†ï¸â¬†ï¸â¬†ï¸\n* ç¬¬ 8 è‡³ 11 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œé”å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œæ–°å¢æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å¤±è´¥ã€‚\n\n-------\n\n`Broker` æ¶ˆæ¯é˜Ÿåˆ—é”ä¼šè¿‡æœŸï¼Œé»˜è®¤é…ç½® 30sã€‚å› æ­¤ï¼Œ`Consumer` éœ€è¦ä¸æ–­å‘ `Broker` åˆ·æ–°è¯¥é”è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤é…ç½® 20s åˆ·æ–°ä¸€æ¬¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘\n  2: public void start() {\n  3:     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())) {\n  4:         this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n  5:             @Override\n  6:             public void run() {\n  7:                 ConsumeMessageOrderlyService.this.lockMQPeriodically();\n  8:             }\n  9:         }, 1000 * 1, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);\n 10:     }\n 11: }\n```\n\n## 3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—\n\né›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ`Consumer` ç§»é™¤è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ `Broker` è§£é”è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘\n  2: /**\n  3:  * ç§»é™¤ä¸éœ€è¦çš„é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯\n  4:  * 1. æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹\n  5:  * 2. é¡ºåºæ¶ˆè´¹&é›†ç¾¤æ¨¡å¼ï¼Œè§£é”å¯¹è¯¥é˜Ÿåˆ—çš„é”å®š\n  6:  *\n  7:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n  8:  * @param pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n  9:  * @return æ˜¯å¦ç§»é™¤æˆåŠŸ\n 10:  */\n 11: @Override\n 12: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {\n 13:     // åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚\n 14:     this.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);\n 15:     this.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);\n 16:     // é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé¡ºåºæ¶ˆè´¹ç§»é™¤æ—¶ï¼Œè§£é”å¯¹é˜Ÿåˆ—çš„é”å®š\n 17:     if (this.defaultMQPushConsumerImpl.isConsumeOrderly()\n 18:         && MessageModel.CLUSTERING.equals(this.defaultMQPushConsumerImpl.messageModel())) {\n 19:         try {\n 20:             if (pq.getLockConsume().tryLock(1000, TimeUnit.MILLISECONDS)) {\n 21:                 try {\n 22:                     return this.unlockDelay(mq, pq);\n 23:                 } finally {\n 24:                     pq.getLockConsume().unlock();\n 25:                 }\n 26:             } else {\n 27:                 log.warn(\"[WRONG]mq is consuming, so can not unlock it, {}. maybe hanged for a while, {}\", //\n 28:                     mq, //\n 29:                     pq.getTryUnlockTimes());\n 30: \n 31:                 pq.incTryUnlockTimes();\n 32:             }\n 33:         } catch (Exception e) {\n 34:             log.error(\"removeUnnecessaryMessageQueue Exception\", e);\n 35:         }\n 36: \n 37:         return false;\n 38:     }\n 39:     return true;\n 40: }\n 41: \n 42: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘\n 43: /**\n 44:  * å»¶è¿Ÿè§£é” Broker æ¶ˆæ¯é˜Ÿåˆ—é”\n 45:  * å½“æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸å­˜åœ¨æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è§£é”\n 46:  *\n 47:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n 48:  * @param pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n 49:  * @return æ˜¯å¦è§£é”æˆåŠŸ\n 50:  */\n 51: private boolean unlockDelay(final MessageQueue mq, final ProcessQueue pq) {\n 52:     if (pq.hasTempMessage()) { // TODO ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦å»¶è¿Ÿç§»é™¤\n 53:         log.info(\"[{}]unlockDelay, begin {} \", mq.hashCode(), mq);\n 54:         this.defaultMQPushConsumerImpl.getmQClientFactory().getScheduledExecutorService().schedule(new Runnable() {\n 55:             @Override\n 56:             public void run() {\n 57:                 log.info(\"[{}]unlockDelay, execute at once {}\", mq.hashCode(), mq);\n 58:                 RebalancePushImpl.this.unlock(mq, true);\n 59:             }\n 60:         }, UNLOCK_DELAY_TIME_MILLS, TimeUnit.MILLISECONDS);\n 61:     } else {\n 62:         this.unlock(mq, true);\n 63:     }\n 64:     return true;\n 65: }\n```\n\n* â¬†ï¸â¬†ï¸â¬†ï¸\n* ç¬¬ 20 è‡³ 32 è¡Œ ï¼šè·å–**æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”**ï¼Œé¿å…å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å†²çªã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡é‡æ–°åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—æ—¶ï¼Œå†è¿›è¡Œç§»é™¤ã€‚å¦‚æœæœªè·å¾—é”è€Œè¿›è¡Œç§»é™¤ï¼Œåˆ™å¯èƒ½å‡ºç°å¦å¤–çš„  `Consumer` å’Œå½“å‰ `Consumer` åŒæ—¶æ¶ˆè´¹è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯æ— æ³•ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚\n* ç¬¬ 51 è‡³ 64 è¡Œ ï¼šè§£é” `Broker` æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚å¦‚æœæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿè§£é” `Broker` æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚â“ä¸ºä»€ä¹ˆæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ä¸èƒ½ç›´æ¥è§£é”å‘¢ï¼ŸğŸ˜ˆæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç™¾æ€ä¸å¾—å…¶è§£ã€‚å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦æ•™è‚²ä¸‹ä¿ºã€‚\n\n## 3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\n\nğŸ˜æœ¬èŠ‚ä¼šç±»æ¯”**å¹¶å‘æ¶ˆè´¹æ¶ˆè´¹é˜Ÿåˆ—**ï¼Œå»ºè®®å¯¹ç…§ [PushConsumerå¹¶å‘æ¶ˆè´¹æ¶ˆæ¯](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md#6pushconsumer-æ¶ˆè´¹æ¶ˆæ¯) ä¸€èµ·ç†è§£ã€‚\n\n### 3.1.1 æ¶ˆè´¹æ¶ˆæ¯\n\n![é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯](images/1007/é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯.png)\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘\n  2: class ConsumeRequest implements Runnable {\n  3: \n  4:     /**\n  5:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n  6:      */\n  7:     private final ProcessQueue processQueue;\n  8:     /**\n  9:      * æ¶ˆæ¯é˜Ÿåˆ—\n 10:      */\n 11:     private final MessageQueue messageQueue;\n 12: \n 13:     @Override\n 14:     public void run() {\n 15:         if (this.processQueue.isDropped()) {\n 16:             log.warn(\"run, the message queue not be able to consume, because it's dropped. {}\", this.messageQueue);\n 17:             return;\n 18:         }\n 19: \n 20:         // è·å¾— Consumer æ¶ˆæ¯é˜Ÿåˆ—é”\n 21:         final Object objLock = messageQueueLock.fetchLockObject(this.messageQueue);\n 22:         synchronized (objLock) {\n 23:             // (å¹¿æ’­æ¨¡å¼) æˆ–è€… (é›†ç¾¤æ¨¡å¼ && Brokeræ¶ˆæ¯é˜Ÿåˆ—é”æœ‰æ•ˆ)\n 24:             if (MessageModel.BROADCASTING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())\n 25:                 || (this.processQueue.isLocked() && !this.processQueue.isLockExpired())) {\n 26:                 final long beginTime = System.currentTimeMillis();\n 27:                 // å¾ªç¯\n 28:                 for (boolean continueConsume = true; continueConsume; ) {\n 29:                     if (this.processQueue.isDropped()) {\n 30:                         log.warn(\"the message queue not be able to consume, because it's dropped. {}\", this.messageQueue);\n 31:                         break;\n 32:                     }\n 33: \n 34:                     // æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”æœªé”å®šï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚\n 35:                     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())\n 36:                         && !this.processQueue.isLocked()) {\n 37:                         log.warn(\"the message queue not locked, so consume later, {}\", this.messageQueue);\n 38:                         ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 10);\n 39:                         break;\n 40:                     }\n 41:                     // æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”å·²ç»è¿‡æœŸï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚\n 42:                     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())\n 43:                         && this.processQueue.isLockExpired()) {\n 44:                         log.warn(\"the message queue lock expired, so consume later, {}\", this.messageQueue);\n 45:                         ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 10);\n 46:                         break;\n 47:                     }\n 48: \n 49:                     // å½“å‰å‘¨æœŸæ¶ˆè´¹æ—¶é—´è¶…è¿‡è¿ç»­æ—¶é•¿ï¼Œé»˜è®¤ï¼š60sï¼Œæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¶ˆè´¹1åˆ†é’Ÿä¼‘æ¯10msã€‚\n 50:                     long interval = System.currentTimeMillis() - beginTime;\n 51:                     if (interval > MAX_TIME_CONSUME_CONTINUOUSLY) {\n 52:                         ConsumeMessageOrderlyService.this.submitConsumeRequestLater(processQueue, messageQueue, 10);\n 53:                         break;\n 54:                     }\n 55: \n 56:                     // è·å–æ¶ˆè´¹æ¶ˆæ¯ã€‚æ­¤å¤„å’Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚ä¸åŒï¼Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚å·²ç»å¸¦äº†æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚\n 57:                     final int consumeBatchSize = ConsumeMessageOrderlyService.this.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();\n 58:                     List<MessageExt> msgs = this.processQueue.takeMessags(consumeBatchSize);\n 59:                     if (!msgs.isEmpty()) {\n 60:                         final ConsumeOrderlyContext context = new ConsumeOrderlyContext(this.messageQueue);\n 61: \n 62:                         ConsumeOrderlyStatus status = null;\n 63: \n 64:                         // ....çœç•¥ä»£ç ï¼šHookï¼šbefore\n 65: \n 66:                         // æ‰§è¡Œæ¶ˆè´¹\n 67:                         long beginTimestamp = System.currentTimeMillis();\n 68:                         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;\n 69:                         boolean hasException = false;\n 70:                         try {\n 71:                             this.processQueue.getLockConsume().lock(); // é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”\n 72: \n 73:                             if (this.processQueue.isDropped()) {\n 74:                                 log.warn(\"consumeMessage, the message queue not be able to consume, because it's dropped. {}\",\n 75:                                     this.messageQueue);\n 76:                                 break;\n 77:                             }\n 78: \n 79:                             status = messageListener.consumeMessage(Collections.unmodifiableList(msgs), context);\n 80:                         } catch (Throwable e) {\n 81:                             log.warn(\"consumeMessage exception: {} Group: {} Msgs: {} MQ: {}\", //\n 82:                                 RemotingHelper.exceptionSimpleDesc(e), //\n 83:                                 ConsumeMessageOrderlyService.this.consumerGroup, //\n 84:                                 msgs, //\n 85:                                 messageQueue);\n 86:                             hasException = true;\n 87:                         } finally {\n 88:                             this.processQueue.getLockConsume().unlock(); // é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”\n 89:                         }\n 90: \n 91:                         // ....çœç•¥ä»£ç ï¼šè§£ææ¶ˆè´¹ç»“æœçŠ¶æ€\n 92: \n 93:                         // ....çœç•¥ä»£ç ï¼šHookï¼šafter\n 94: \n 95:                         ConsumeMessageOrderlyService.this.getConsumerStatsManager()\n 96:                             .incConsumeRT(ConsumeMessageOrderlyService.this.consumerGroup, messageQueue.getTopic(), consumeRT);\n 97: \n 98:                         // å¤„ç†æ¶ˆè´¹ç»“æœ\n 99:                         continueConsume = ConsumeMessageOrderlyService.this.processConsumeResult(msgs, status, context, this);\n100:                     } else {\n101:                         continueConsume = false;\n102:                     }\n103:                 }\n104:             } else {\n105:                 if (this.processQueue.isDropped()) {\n106:                     log.warn(\"the message queue not be able to consume, because it's dropped. {}\", this.messageQueue);\n107:                     return;\n108:                 }\n109: \n110:                 ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 100);\n111:             }\n112:         }\n113:     }\n114: \n115: }\n```\n\n* â¬†ï¸â¬†ï¸â¬†ï¸\n* ç¬¬ 20 è¡Œ ï¼šè·å¾— `Consumer` æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚\n* ç¬¬ 58 è¡Œ ï¼šä»æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é¡ºåºè·å¾—æ¶ˆæ¯ã€‚**å’Œå¹¶å‘æ¶ˆè´¹è·å¾—æ¶ˆæ¯ä¸åŒã€‚å¹¶å‘æ¶ˆè´¹è¯·æ±‚åœ¨è¯·æ±‚åˆ›å»ºæ—¶ï¼Œå·²ç»è®¾ç½®å¥½æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚**\n* ç¬¬ 71 è¡Œ ï¼šè·å¾— `Consumer` æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ã€‚ç›¸æ¯”ã€`Consumer`æ¶ˆæ¯é˜Ÿåˆ—é”ã€‘ï¼Œå…¶ç²’åº¦è¾ƒå°ã€‚è¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„â“**ä¸ºä»€ä¹ˆæœ‰`Consumer`æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ Consumer æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢**çš„åŸå› ã€‚\n* ç¬¬ 79 è¡Œ ï¼š**æ‰§è¡Œæ¶ˆè´¹**ã€‚\n* ç¬¬ 99 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚\n\n### 3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ\n\né¡ºåºæ¶ˆè´¹æ¶ˆæ¯ç»“æœ (`ConsumeOrderlyStatus`) æœ‰å››ç§æƒ…å†µï¼š\n\n* `SUCCESS` ï¼šæ¶ˆè´¹æˆåŠŸ**ä½†ä¸æäº¤**ã€‚\n* `ROLLBACK` ï¼šæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆè´¹å›æ»šã€‚\n* `COMMIT` ï¼šæ¶ˆè´¹æˆåŠŸæäº¤å¹¶ä¸”æäº¤ã€‚\n* `SUSPEND_CURRENT_QUEUE_A_MOMENT` ï¼šæ¶ˆè´¹å¤±è´¥ï¼ŒæŒ‚èµ·æ¶ˆè´¹é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚\n\nè€ƒè™‘åˆ° `ROLLBACK` ã€`COMMIT` æš‚æ—¶åªä½¿ç”¨åœ¨ `MySQL binlog` åœºæ™¯ï¼Œå®˜æ–¹å°†è¿™ä¸¤çŠ¶æ€æ ‡è®°ä¸º `@Deprecated`ã€‚å½“ç„¶ï¼Œç›¸åº”çš„å®ç°é€»è¾‘ä¾ç„¶ä¿ç•™ã€‚\n\nåœ¨**å¹¶å‘æ¶ˆè´¹**åœºæ™¯æ—¶ï¼Œå¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œ`Consumer` ä¼šå°†æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯å‘å›åˆ° `Broker` é‡è¯•é˜Ÿåˆ—ï¼Œè·³è¿‡å½“å‰æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹æ¬¡æ‹‰å–è¯¥æ¶ˆæ¯å†è¿›è¡Œæ¶ˆè´¹ã€‚\n\nä½†æ˜¯åœ¨**å®Œå…¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹**æ¶ˆè´¹æ—¶ï¼Œè¿™æ ·åšæ˜¾ç„¶ä¸è¡Œã€‚ä¹Ÿå› æ­¤ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¼šæŒ‚èµ·é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚ \n\nä¸è¿‡æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ä¸€ç›´å¤±è´¥ï¼Œä¹Ÿä¸å¯èƒ½ä¸€ç›´æ¶ˆè´¹ã€‚å½“è¶…è¿‡æ¶ˆè´¹é‡è¯•ä¸Šé™æ—¶ï¼Œ`Consumer` ä¼šå°†æ¶ˆè´¹å¤±è´¥è¶…è¿‡ä¸Šé™çš„æ¶ˆæ¯å‘å›åˆ° `Broker` æ­»ä¿¡é˜Ÿåˆ—ã€‚\n\nè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘\n  2: /**\n  3:  * å¤„ç†æ¶ˆè´¹ç»“æœï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­æ¶ˆè´¹\n  4:  *\n  5:  * @param msgs æ¶ˆæ¯\n  6:  * @param status æ¶ˆè´¹ç»“æœçŠ¶æ€\n  7:  * @param context æ¶ˆè´¹Context\n  8:  * @param consumeRequest æ¶ˆè´¹è¯·æ±‚\n  9:  * @return æ˜¯å¦ç»§ç»­æ¶ˆè´¹\n 10:  */\n 11: public boolean processConsumeResult(//\n 12:     final List<MessageExt> msgs, //\n 13:     final ConsumeOrderlyStatus status, //\n 14:     final ConsumeOrderlyContext context, //\n 15:     final ConsumeRequest consumeRequest//\n 16: ) {\n 17:     boolean continueConsume = true;\n 18:     long commitOffset = -1L;\n 19:     if (context.isAutoCommit()) {\n 20:         switch (status) {\n 21:             case COMMIT:\n 22:             case ROLLBACK:\n 23:                 log.warn(\"the message queue consume result is illegal, we think you want to ack these message {}\", consumeRequest.getMessageQueue());\n 24:             case SUCCESS:\n 25:                 // æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n 26:                 commitOffset = consumeRequest.getProcessQueue().commit();\n 27:                 // ç»Ÿè®¡\n 28:                 this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());\n 29:                 break;\n 30:             case SUSPEND_CURRENT_QUEUE_A_MOMENT:\n 31:                 // ç»Ÿè®¡\n 32:                 this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());\n 33:                 if (checkReconsumeTimes(msgs)) { // è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms\n 34:                     // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹\n 35:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);\n 36:                     // æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚\n 37:                     this.submitConsumeRequestLater(//\n 38:                         consumeRequest.getProcessQueue(), //\n 39:                         consumeRequest.getMessageQueue(), //\n 40:                         context.getSuspendCurrentQueueTimeMillis());\n 41:                     continueConsume = false;\n 42:                 } else {\n 43:                     commitOffset = consumeRequest.getProcessQueue().commit();\n 44:                 }\n 45:                 break;\n 46:             default:\n 47:                 break;\n 48:         }\n 49:     } else {\n 50:         switch (status) {\n 51:             case SUCCESS:\n 52:                 this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());\n 53:                 break;\n 54:             case COMMIT:\n 55:                 // æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n 56:                 commitOffset = consumeRequest.getProcessQueue().commit();\n 57:                 break;\n 58:             case ROLLBACK:\n 59:                 // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹\n 60:                 consumeRequest.getProcessQueue().rollback();\n 61:                 this.submitConsumeRequestLater(//\n 62:                     consumeRequest.getProcessQueue(), //\n 63:                     consumeRequest.getMessageQueue(), //\n 64:                     context.getSuspendCurrentQueueTimeMillis());\n 65:                 continueConsume = false;\n 66:                 break;\n 67:             case SUSPEND_CURRENT_QUEUE_A_MOMENT: // è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms\n 68:                 this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());\n 69:                 if (checkReconsumeTimes(msgs)) {\n 70:                     // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹\n 71:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);\n 72:                     // æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚\n 73:                     this.submitConsumeRequestLater(//\n 74:                         consumeRequest.getProcessQueue(), //\n 75:                         consumeRequest.getMessageQueue(), //\n 76:                         context.getSuspendCurrentQueueTimeMillis());\n 77:                     continueConsume = false;\n 78:                 }\n 79:                 break;\n 80:             default:\n 81:                 break;\n 82:         }\n 83:     }\n 84: \n 85:     // æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœªdroppedï¼Œæäº¤æœ‰æ•ˆæ¶ˆè´¹è¿›åº¦\n 86:     if (commitOffset >= 0 && !consumeRequest.getProcessQueue().isDropped()) {\n 87:         this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), commitOffset, false);\n 88:     }\n 89: \n 90:     return continueConsume;\n 91: }\n 92: \n 93: private int getMaxReconsumeTimes() {\n 94:     // default reconsume times: Integer.MAX_VALUE\n 95:     if (this.defaultMQPushConsumer.getMaxReconsumeTimes() == -1) {\n 96:         return Integer.MAX_VALUE;\n 97:     } else {\n 98:         return this.defaultMQPushConsumer.getMaxReconsumeTimes();\n 99:     }\n100: }\n101: \n102: /**\n103:  * è®¡ç®—æ˜¯å¦è¦æš‚åœæ¶ˆè´¹\n104:  * ä¸æš‚åœæ¡ä»¶ï¼šå­˜åœ¨æ¶ˆæ¯éƒ½è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°å¹¶ä¸”éƒ½å‘å›brokeræˆåŠŸ\n105:  *\n106:  * @param msgs æ¶ˆæ¯\n107:  * @return æ˜¯å¦è¦æš‚åœ\n108:  */\n109: private boolean checkReconsumeTimes(List<MessageExt> msgs) {\n110:     boolean suspend = false;\n111:     if (msgs != null && !msgs.isEmpty()) {\n112:         for (MessageExt msg : msgs) {\n113:             if (msg.getReconsumeTimes() >= getMaxReconsumeTimes()) {\n114:                 MessageAccessor.setReconsumeTime(msg, String.valueOf(msg.getReconsumeTimes()));\n115:                 if (!sendMessageBack(msg)) { // å‘å›å¤±è´¥ï¼Œä¸­æ–­\n116:                     suspend = true;\n117:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);\n118:                 }\n119:             } else {\n120:                 suspend = true;\n121:                 msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);\n122:             }\n123:         }\n124:     }\n125:     return suspend;\n126: }\n127: \n128: /**\n129:  * å‘å›æ¶ˆæ¯ã€‚\n130:  * æ¶ˆæ¯å‘å›brokeråï¼Œå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ­»ä¿¡é˜Ÿåˆ—ã€‚\n131:  *\n132:  * @param msg æ¶ˆæ¯\n133:  * @return æ˜¯å¦å‘é€æˆåŠŸ\n134:  */\n135: public boolean sendMessageBack(final MessageExt msg) {\n136:     try {\n137:         // max reconsume times exceeded then send to dead letter queue.\n138:         Message newMsg = new Message(MixAll.getRetryTopic(this.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());\n139:         String originMsgId = MessageAccessor.getOriginMessageId(msg);\n140:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);\n141:         newMsg.setFlag(msg.getFlag());\n142:         MessageAccessor.setProperties(newMsg, msg.getProperties());\n143:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());\n144:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes()));\n145:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));\n146:         newMsg.setDelayTimeLevel(3 + msg.getReconsumeTimes());\n147: \n148:         this.defaultMQPushConsumer.getDefaultMQPushConsumerImpl().getmQClientFactory().getDefaultMQProducer().send(newMsg);\n149:         return true;\n150:     } catch (Exception e) {\n151:         log.error(\"sendMessageBack exception, group: \" + this.consumerGroup + \" msg: \" + msg.toString(), e);\n152:     }\n153: \n154:     return false;\n155: }\n```\n\n* â¬†ï¸â¬†ï¸â¬†ï¸\n* ç¬¬ 21 è‡³ 29 è¡Œ ï¼šæ¶ˆè´¹æˆåŠŸã€‚åœ¨è‡ªåŠ¨æäº¤è¿›åº¦( `AutoCommit` )çš„æƒ…å†µä¸‹ï¼Œ`COMMIT`ã€`ROLLBACK`ã€`SUCCESS` é€»è¾‘**å·²ç»ç»Ÿä¸€**ã€‚\n* ç¬¬ 30 è‡³ 45 è¡Œ ï¼šæ¶ˆè´¹å¤±è´¥ã€‚å½“æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™ï¼ˆé»˜è®¤ ï¼š16æ¬¡ï¼‰æ—¶ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° `Broker` æ­»ä¿¡é˜Ÿåˆ—ï¼Œè·³è¿‡è¿™äº›æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­æ¶ˆè´¹åé¢çš„æ¶ˆæ¯ã€‚\n* ç¬¬ 85 è‡³ 88 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¿›åº¦ã€‚\n\n### 3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•\n\nğŸ˜ˆæ¶‰åŠåˆ°çš„å››ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æºç ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ProcessQueue.javaã€‘\n  2: /**\n  3:  * æ¶ˆæ¯æ˜ å°„\n  4:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n  5:  */\n  6: private final TreeMap<Long, MessageExt> msgTreeMap = new TreeMap<>();    /**\n  7:  * æ¶ˆæ¯æ˜ å°„ä¸´æ—¶å­˜å‚¨ï¼ˆæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯ï¼‰\n  8:  */\n  9: private final TreeMap<Long, MessageExt> msgTreeMapTemp = new TreeMap<>();\n 10: \n 11: /**\n 12:  * å›æ»šæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯\n 13:  * é€»è¾‘ç±»ä¼¼äº{@link #makeMessageToCosumeAgain(List)}\n 14:  */\n 15: public void rollback() {\n 16:     try {\n 17:         this.lockTreeMap.writeLock().lockInterruptibly();\n 18:         try {\n 19:             this.msgTreeMap.putAll(this.msgTreeMapTemp);\n 20:             this.msgTreeMapTemp.clear();\n 21:         } finally {\n 22:             this.lockTreeMap.writeLock().unlock();\n 23:         }\n 24:     } catch (InterruptedException e) {\n 25:         log.error(\"rollback exception\", e);\n 26:     }\n 27: }\n 28: \n 29: /**\n 30:  * æäº¤æ¶ˆè´¹ä¸­çš„æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸï¼Œè¿”å›æ¶ˆè´¹è¿›åº¦\n 31:  *\n 32:  * @return æ¶ˆè´¹è¿›åº¦\n 33:  */\n 34: public long commit() {\n 35:     try {\n 36:         this.lockTreeMap.writeLock().lockInterruptibly();\n 37:         try {\n 38:             // æ¶ˆè´¹è¿›åº¦\n 39:             Long offset = this.msgTreeMapTemp.lastKey();\n 40: \n 41:             //\n 42:             msgCount.addAndGet(this.msgTreeMapTemp.size() * (-1));\n 43: \n 44:             //\n 45:             this.msgTreeMapTemp.clear();\n 46: \n 47:             // è¿”å›æ¶ˆè´¹è¿›åº¦\n 48:             if (offset != null) {\n 49:                 return offset + 1;\n 50:             }\n 51:         } finally {\n 52:             this.lockTreeMap.writeLock().unlock();\n 53:         }\n 54:     } catch (InterruptedException e) {\n 55:         log.error(\"commit exception\", e);\n 56:     }\n 57: \n 58:     return -1;\n 59: }\n 60: \n 61: /**\n 62:  * æŒ‡å®šæ¶ˆæ¯é‡æ–°æ¶ˆè´¹\n 63:  * é€»è¾‘ç±»ä¼¼äº{@link #rollback()}\n 64:  *\n 65:  * @param msgs æ¶ˆæ¯\n 66:  */\n 67: public void makeMessageToCosumeAgain(List<MessageExt> msgs) {\n 68:     try {\n 69:         this.lockTreeMap.writeLock().lockInterruptibly();\n 70:         try {\n 71:             for (MessageExt msg : msgs) {\n 72:                 this.msgTreeMapTemp.remove(msg.getQueueOffset());\n 73:                 this.msgTreeMap.put(msg.getQueueOffset(), msg);\n 74:             }\n 75:         } finally {\n 76:             this.lockTreeMap.writeLock().unlock();\n 77:         }\n 78:     } catch (InterruptedException e) {\n 79:         log.error(\"makeMessageToCosumeAgain exception\", e);\n 80:     }\n 81: }\n 82: \n 83: /**\n 84:  * è·å¾—æŒæœ‰æ¶ˆæ¯å‰Næ¡\n 85:  *\n 86:  * @param batchSize æ¡æ•°\n 87:  * @return æ¶ˆæ¯\n 88:  */\n 89: public List<MessageExt> takeMessags(final int batchSize) {\n 90:     List<MessageExt> result = new ArrayList<>(batchSize);\n 91:     final long now = System.currentTimeMillis();\n 92:     try {\n 93:         this.lockTreeMap.writeLock().lockInterruptibly();\n 94:         this.lastConsumeTimestamp = now;\n 95:         try {\n 96:             if (!this.msgTreeMap.isEmpty()) {\n 97:                 for (int i = 0; i < batchSize; i++) {\n 98:                     Map.Entry<Long, MessageExt> entry = this.msgTreeMap.pollFirstEntry();\n 99:                     if (entry != null) {\n100:                         result.add(entry.getValue());\n101:                         msgTreeMapTemp.put(entry.getKey(), entry.getValue());\n102:                     } else {\n103:                         break;\n104:                     }\n105:                 }\n106:             }\n107: \n108:             if (result.isEmpty()) {\n109:                 consuming = false;\n110:             }\n111:         } finally {\n112:             this.lockTreeMap.writeLock().unlock();\n113:         }\n114:     } catch (InterruptedException e) {\n115:         log.error(\"take Messages exception\", e);\n116:     }\n117: \n118:     return result;\n119: }\n```\n\n\n","source":"_posts/RocketMQ/2017_05_13_RocketMQæºç åˆ†æâ€”â€”Messageé¡ºåºå‘é€ä¸æ¶ˆè´¹.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹\ndate: 2017-05-13\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/message-send-and-consume-orderly\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1007-RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. Producer é¡ºåºå‘é€](#)\n- [3. Consumer é¡ºåºæ¶ˆè´¹](#)\n\t- [3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—](#)\n\t- [3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—](#)\n\t- [3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—](#)\n\t\t- [3.1.1 æ¶ˆè´¹æ¶ˆæ¯](#)\n\t\t- [3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ](#)\n\t\t- [3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•](#)\n\n# 1. æ¦‚è¿°\n\n**å»ºè®®**å‰ç½®é˜…è¯»å†…å®¹ï¼š\n\n* [ã€ŠMessageå‘é€&æ¥æ”¶ã€‹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1003-RocketMQæºç è§£æï¼šMessageå‘é€&æ¥æ”¶.md)\n* [ã€ŠMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md)\n\nå½“ç„¶å¯¹ `Message` å‘é€ä¸æ¶ˆè´¹å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡ã€‚\n\n-------\n\n`RocketMQ` æä¾›äº†ä¸¤ç§é¡ºåºçº§åˆ«ï¼š\n\n* æ™®é€šé¡ºåºæ¶ˆæ¯ ï¼š`Producer` å°†ç›¸å…³è”çš„æ¶ˆæ¯å‘é€åˆ°ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* å®Œå…¨ä¸¥æ ¼é¡ºåº ï¼šåœ¨ `æ™®é€šé¡ºåºæ¶ˆæ¯` çš„åŸºç¡€ä¸Šï¼Œ`Consumer` ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚\n\nç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹åªéœ€è¦ç”¨åˆ°**æ™®é€šé¡ºåºæ¶ˆæ¯**ã€‚  \nä¾‹å¦‚è¯´ï¼šç»™ç”¨æˆ·å‘é€çŸ­ä¿¡æ¶ˆæ¯ + å‘é€æ¨é€æ¶ˆæ¯ï¼Œå°†ä¸¤æ¡æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‹¥å…¶ä¸­ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è¾ƒæ…¢é€ æˆå µå¡ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ï¼Œå¸¦æ¥çš„ä½“éªŒä¼šç›¸å¯¹è¾ƒå·®ã€‚å½“ç„¶ç±»ä¼¼è¿™ç§åœºæ™¯ï¼Œå³ä½¿æœ‰ä¸€å®šçš„æ—¶é—´å·®ï¼Œ**ä¸ä¼šäº§ç”Ÿç³»ç»Ÿé€»è¾‘ä¸ŠBUG**ã€‚å¦å¤–ï¼Œ`æ™®é€šé¡ºåºæ¶ˆæ¯`æ€§èƒ½èƒ½æ›´åŠ å¥½ã€‚  \né‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä½¿ç”¨**å®Œå…¨ä¸¥æ ¼é¡ºåº**ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼š\n> ç›®å‰å·²çŸ¥çš„åº”ç”¨åªæœ‰æ•°æ®åº“ `binlog` åŒæ­¥å¼ºä¾èµ–ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼Œå…¶ä»–åº”ç”¨ç»å¤§éƒ¨åˆ†éƒ½å¯ä»¥å®¹å¿çŸ­æš‚ä¹±åºï¼Œæ¨èä½¿ç”¨æ™®é€šçš„é¡ºåºæ¶ˆæ¯\n\n-------\n\nğŸ˜ˆä¸Šä»£ç ï¼ï¼ï¼\n\n# 2. `Producer` é¡ºåºå‘é€\n\nå®˜æ–¹å‘é€é¡ºåºæ¶ˆæ¯çš„**ä¾‹å­**ï¼š\n\n```Java\n  1: package org.apache.rocketmq.example.ordermessage;\n  2: \n  3: import java.io.UnsupportedEncodingException;\n  4: import java.util.List;\n  5: import org.apache.rocketmq.client.exception.MQBrokerException;\n  6: import org.apache.rocketmq.client.exception.MQClientException;\n  7: import org.apache.rocketmq.client.producer.DefaultMQProducer;\n  8: import org.apache.rocketmq.client.producer.MQProducer;\n  9: import org.apache.rocketmq.client.producer.MessageQueueSelector;\n 10: import org.apache.rocketmq.client.producer.SendResult;\n 11: import org.apache.rocketmq.common.message.Message;\n 12: import org.apache.rocketmq.common.message.MessageQueue;\n 13: import org.apache.rocketmq.remoting.common.RemotingHelper;\n 14: import org.apache.rocketmq.remoting.exception.RemotingException;\n 15: \n 16: public class Producer {\n 17:     public static void main(String[] args) throws UnsupportedEncodingException {\n 18:         try {\n 19:             MQProducer producer = new DefaultMQProducer(\"please_rename_unique_group_name\");\n 20:             producer.start();\n 21: \n 22:             String[] tags = new String[] {\"TagA\", \"TagB\", \"TagC\", \"TagD\", \"TagE\"};\n 23:             for (int i = 0; i < 100; i++) {\n 24:                 int orderId = i % 10;\n 25:                 Message msg =\n 26:                     new Message(\"TopicTestjjj\", tags[i % tags.length], \"KEY\" + i,\n 27:                         (\"Hello RocketMQ \" + i).getBytes(RemotingHelper.DEFAULT_CHARSET));\n 28:                 SendResult sendResult = producer.send(msg, new MessageQueueSelector() {\n 29:                     @Override\n 30:                     public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {\n 31:                         Integer id = (Integer) arg;\n 32:                         int index = id % mqs.size();\n 33:                         return mqs.get(index);\n 34:                     }\n 35:                 }, orderId);\n 36: \n 37:                 System.out.printf(\"%s%n\", sendResult);\n 38:             }\n 39: \n 40:             producer.shutdown();\n 41:         } catch (MQClientException | RemotingException | MQBrokerException | InterruptedException e) {\n 42:             e.printStackTrace();\n 43:         }\n 44:     }\n 45: }\n```\n\n* ç¬¬ 28 è‡³ 35 è¡Œ ï¼šå®ç°äº†æ ¹æ® `id % mqs.size()` æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©ã€‚å½“å‰ä¾‹å­ï¼Œ**æˆ‘ä»¬ä¼ é€’ `orderId` ä½œä¸ºå‚æ•°ï¼Œé‚£ä¹ˆç›¸åŒçš„ `orderId` èƒ½å¤Ÿè¿›å…¥ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—**ã€‚\n\n-------\n\n`MessageQueueSelector` æ¥å£çš„**æºç **ï¼š\n\n```Java\n  1: public interface MessageQueueSelector {\n  2: \n  3:     /**\n  4:      * é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—\n  5:      *\n  6:      * @param mqs æ¶ˆæ¯é˜Ÿåˆ—\n  7:      * @param msg æ¶ˆæ¯\n  8:      * @param arg å‚æ•°\n  9:      * @return æ¶ˆæ¯é˜Ÿåˆ—\n 10:      */\n 11:     MessageQueue select(final List<MessageQueue> mqs, final Message msg, final Object arg);\n 12: }\n```\n-------\n\n`Producer` é€‰æ‹©é˜Ÿåˆ—å‘é€æ¶ˆæ¯æ–¹æ³•çš„**æºç **ï¼š\n\n```Java\n 16: private SendResult sendSelectImpl(//\n 17:     Message msg, //\n 18:     MessageQueueSelector selector, //\n 19:     Object arg, //\n 20:     final CommunicationMode communicationMode, //\n 21:     final SendCallback sendCallback, final long timeout//\n 22: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n 23:     this.makeSureStateOK();\n 24:     Validators.checkMessage(msg, this.defaultMQProducer);\n 25: \n 26:     TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());\n 27:     if (topicPublishInfo != null && topicPublishInfo.ok()) {\n 28:         MessageQueue mq = null;\n 29:         try {\n 30:             mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);\n 31:         } catch (Throwable e) {\n 32:             throw new MQClientException(\"select message queue throwed exception.\", e);\n 33:         }\n 34: \n 35:         if (mq != null) {\n 36:             return this.sendKernelImpl(msg, mq, communicationMode, sendCallback, null, timeout);\n 37:         } else {\n 38:             throw new MQClientException(\"select message queue return null.\", null);\n 39:         }\n 40:     }\n 41: \n 42:     throw new MQClientException(\"No route info for this topic, \" + msg.getTopic(), null);\n 43: }\n```\n\n* ç¬¬ 30 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 36 è¡Œ ï¼šå‘é€æ¶ˆæ¯ã€‚\n\n# 3. `Consumer` ä¸¥æ ¼é¡ºåºæ¶ˆè´¹\n\n`Consumer` åœ¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹æ—¶ï¼Œé€šè¿‡ **ä¸‰** æŠŠé”ä¿è¯ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚\n\n* `Broker` æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ**åˆ†å¸ƒå¼é”**ï¼‰ ï¼š\n    * é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ`Consumer` ä» `Broker` è·å¾—è¯¥é”åï¼Œæ‰èƒ½è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€æ¶ˆè´¹ã€‚\n    * å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œ`Consumer` æ— éœ€è¯¥é”ã€‚\n* `Consumer` æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ**æœ¬åœ°é”**ï¼‰ ï¼š`Consumer` è·å¾—è¯¥é”æ‰èƒ½æ“ä½œæ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* `Consumer` æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ï¼ˆ**æœ¬åœ°é”**ï¼‰ ï¼š`Consumer` è·å¾—è¯¥é”æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n\n**å¯èƒ½åŒå­¦æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæœ‰ `Consumer` æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ `Consumer` æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢**ï¼ŸğŸ˜ˆè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®ç»§ç»­å¾€ä¸‹çœ‹ã€‚\n\n-------\n\n## 3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—\n\n**é›†ç¾¤æ¨¡å¼**ä¸‹ï¼Œ`Consumer` æ›´æ–°å±äºè‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ `Broker` é”å®šè¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ*å¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦*ï¼‰ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œåˆ™æ›´æ–°å¤±è´¥ï¼Œå³è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸å±äºè‡ªå·±ï¼Œä¸èƒ½è¿›è¡Œæ¶ˆè´¹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘\n  2: private boolean updateProcessQueueTableInRebalance(final String topic, final Set<MessageQueue> mqSet, final boolean isOrder) {\n  3: // ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  \n  4:     // å¢åŠ  ä¸åœ¨processQueueTable && å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n  5:     List<PullRequest> pullRequestList = new ArrayList<>(); // æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„\n  6:     for (MessageQueue mq : mqSet) {\n  7:         if (!this.processQueueTable.containsKey(mq)) {\n  8:             if (isOrder && !this.lock(mq)) { // é¡ºåºæ¶ˆæ¯é”å®šæ¶ˆæ¯é˜Ÿåˆ—\n  9:                 log.warn(\"doRebalance, {}, add a new mq failed, {}, because lock failed\", consumerGroup, mq);\n 10:                 continue;\n 11:             }\n 12: \n 13:             this.removeDirtyOffset(mq);\n 14:             ProcessQueue pq = new ProcessQueue();\n 15:             long nextOffset = this.computePullFromWhere(mq);\n 16:             if (nextOffset >= 0) {\n 17:                 ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq);\n 18:                 if (pre != null) {\n 19:                     log.info(\"doRebalance, {}, mq already exists, {}\", consumerGroup, mq);\n 20:                 } else {\n 21:                     log.info(\"doRebalance, {}, add a new mq, {}\", consumerGroup, mq);\n 22:                     PullRequest pullRequest = new PullRequest();\n 23:                     pullRequest.setConsumerGroup(consumerGroup);\n 24:                     pullRequest.setNextOffset(nextOffset);\n 25:                     pullRequest.setMessageQueue(mq);\n 26:                     pullRequest.setProcessQueue(pq);\n 27:                     pullRequestList.add(pullRequest);\n 28:                     changed = true;\n 29:                 }\n 30:             } else {\n 31:                 log.warn(\"doRebalance, {}, add new mq failed, {}\", consumerGroup, mq);\n 32:             }\n 33:         }\n 34:     }\n 35: \n 36: // ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  \n 37: }\n 38: \n 39: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘\n 40: /**\n 41:  * è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”\n 42:  *\n 43:  * @param mq é˜Ÿåˆ—\n 44:  * @return æ˜¯å¦æˆåŠŸ\n 45:  */\n 46: public boolean lock(final MessageQueue mq) {\n 47:     FindBrokerResult findBrokerResult = this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(), MixAll.MASTER_ID, true);\n 48:     if (findBrokerResult != null) {\n 49:         LockBatchRequestBody requestBody = new LockBatchRequestBody();\n 50:         requestBody.setConsumerGroup(this.consumerGroup);\n 51:         requestBody.setClientId(this.mQClientFactory.getClientId());\n 52:         requestBody.getMqSet().add(mq);\n 53: \n 54:         try {\n 55:             // è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”\n 56:             Set<MessageQueue> lockedMq =\n 57:                 this.mQClientFactory.getMQClientAPIImpl().lockBatchMQ(findBrokerResult.getBrokerAddr(), requestBody, 1000);\n 58: \n 59:             // è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é”å®šæˆåŠŸã€‚é”å®šæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸï¼Œå¯èƒ½æœ¬åœ°æ²¡æœ‰æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ï¼Œè®¾ç½®é”å®šæˆåŠŸä¼šåœ¨lockAll()æ–¹æ³•ã€‚\n 60:             for (MessageQueue mmqq : lockedMq) {\n 61:                 ProcessQueue processQueue = this.processQueueTable.get(mmqq);\n 62:                 if (processQueue != null) {\n 63:                     processQueue.setLocked(true);\n 64:                     processQueue.setLastLockTimestamp(System.currentTimeMillis());\n 65:                 }\n 66:             }\n 67: \n 68:             boolean lockOK = lockedMq.contains(mq);\n 69:             log.info(\"the message queue lock {}, {} {}\",\n 70:                 lockOK ? \"OK\" : \"Failed\",\n 71:                 this.consumerGroup,\n 72:                 mq);\n 73:             return lockOK;\n 74:         } catch (Exception e) {\n 75:             log.error(\"lockBatchMQ exception, \" + mq, e);\n 76:         }\n 77:     }\n 78: \n 79:     return false;\n 80: }\n```\n\n* â¬†ï¸â¬†ï¸â¬†ï¸\n* ç¬¬ 8 è‡³ 11 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œé”å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œæ–°å¢æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å¤±è´¥ã€‚\n\n-------\n\n`Broker` æ¶ˆæ¯é˜Ÿåˆ—é”ä¼šè¿‡æœŸï¼Œé»˜è®¤é…ç½® 30sã€‚å› æ­¤ï¼Œ`Consumer` éœ€è¦ä¸æ–­å‘ `Broker` åˆ·æ–°è¯¥é”è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤é…ç½® 20s åˆ·æ–°ä¸€æ¬¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘\n  2: public void start() {\n  3:     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())) {\n  4:         this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n  5:             @Override\n  6:             public void run() {\n  7:                 ConsumeMessageOrderlyService.this.lockMQPeriodically();\n  8:             }\n  9:         }, 1000 * 1, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);\n 10:     }\n 11: }\n```\n\n## 3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—\n\né›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ`Consumer` ç§»é™¤è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ `Broker` è§£é”è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘\n  2: /**\n  3:  * ç§»é™¤ä¸éœ€è¦çš„é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯\n  4:  * 1. æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹\n  5:  * 2. é¡ºåºæ¶ˆè´¹&é›†ç¾¤æ¨¡å¼ï¼Œè§£é”å¯¹è¯¥é˜Ÿåˆ—çš„é”å®š\n  6:  *\n  7:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n  8:  * @param pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n  9:  * @return æ˜¯å¦ç§»é™¤æˆåŠŸ\n 10:  */\n 11: @Override\n 12: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {\n 13:     // åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚\n 14:     this.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);\n 15:     this.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);\n 16:     // é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé¡ºåºæ¶ˆè´¹ç§»é™¤æ—¶ï¼Œè§£é”å¯¹é˜Ÿåˆ—çš„é”å®š\n 17:     if (this.defaultMQPushConsumerImpl.isConsumeOrderly()\n 18:         && MessageModel.CLUSTERING.equals(this.defaultMQPushConsumerImpl.messageModel())) {\n 19:         try {\n 20:             if (pq.getLockConsume().tryLock(1000, TimeUnit.MILLISECONDS)) {\n 21:                 try {\n 22:                     return this.unlockDelay(mq, pq);\n 23:                 } finally {\n 24:                     pq.getLockConsume().unlock();\n 25:                 }\n 26:             } else {\n 27:                 log.warn(\"[WRONG]mq is consuming, so can not unlock it, {}. maybe hanged for a while, {}\", //\n 28:                     mq, //\n 29:                     pq.getTryUnlockTimes());\n 30: \n 31:                 pq.incTryUnlockTimes();\n 32:             }\n 33:         } catch (Exception e) {\n 34:             log.error(\"removeUnnecessaryMessageQueue Exception\", e);\n 35:         }\n 36: \n 37:         return false;\n 38:     }\n 39:     return true;\n 40: }\n 41: \n 42: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘\n 43: /**\n 44:  * å»¶è¿Ÿè§£é” Broker æ¶ˆæ¯é˜Ÿåˆ—é”\n 45:  * å½“æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸å­˜åœ¨æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è§£é”\n 46:  *\n 47:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n 48:  * @param pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n 49:  * @return æ˜¯å¦è§£é”æˆåŠŸ\n 50:  */\n 51: private boolean unlockDelay(final MessageQueue mq, final ProcessQueue pq) {\n 52:     if (pq.hasTempMessage()) { // TODO ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦å»¶è¿Ÿç§»é™¤\n 53:         log.info(\"[{}]unlockDelay, begin {} \", mq.hashCode(), mq);\n 54:         this.defaultMQPushConsumerImpl.getmQClientFactory().getScheduledExecutorService().schedule(new Runnable() {\n 55:             @Override\n 56:             public void run() {\n 57:                 log.info(\"[{}]unlockDelay, execute at once {}\", mq.hashCode(), mq);\n 58:                 RebalancePushImpl.this.unlock(mq, true);\n 59:             }\n 60:         }, UNLOCK_DELAY_TIME_MILLS, TimeUnit.MILLISECONDS);\n 61:     } else {\n 62:         this.unlock(mq, true);\n 63:     }\n 64:     return true;\n 65: }\n```\n\n* â¬†ï¸â¬†ï¸â¬†ï¸\n* ç¬¬ 20 è‡³ 32 è¡Œ ï¼šè·å–**æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”**ï¼Œé¿å…å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å†²çªã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡é‡æ–°åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—æ—¶ï¼Œå†è¿›è¡Œç§»é™¤ã€‚å¦‚æœæœªè·å¾—é”è€Œè¿›è¡Œç§»é™¤ï¼Œåˆ™å¯èƒ½å‡ºç°å¦å¤–çš„  `Consumer` å’Œå½“å‰ `Consumer` åŒæ—¶æ¶ˆè´¹è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯æ— æ³•ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚\n* ç¬¬ 51 è‡³ 64 è¡Œ ï¼šè§£é” `Broker` æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚å¦‚æœæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿè§£é” `Broker` æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚â“ä¸ºä»€ä¹ˆæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ä¸èƒ½ç›´æ¥è§£é”å‘¢ï¼ŸğŸ˜ˆæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç™¾æ€ä¸å¾—å…¶è§£ã€‚å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦æ•™è‚²ä¸‹ä¿ºã€‚\n\n## 3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\n\nğŸ˜æœ¬èŠ‚ä¼šç±»æ¯”**å¹¶å‘æ¶ˆè´¹æ¶ˆè´¹é˜Ÿåˆ—**ï¼Œå»ºè®®å¯¹ç…§ [PushConsumerå¹¶å‘æ¶ˆè´¹æ¶ˆæ¯](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md#6pushconsumer-æ¶ˆè´¹æ¶ˆæ¯) ä¸€èµ·ç†è§£ã€‚\n\n### 3.1.1 æ¶ˆè´¹æ¶ˆæ¯\n\n![é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯](images/1007/é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯.png)\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘\n  2: class ConsumeRequest implements Runnable {\n  3: \n  4:     /**\n  5:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n  6:      */\n  7:     private final ProcessQueue processQueue;\n  8:     /**\n  9:      * æ¶ˆæ¯é˜Ÿåˆ—\n 10:      */\n 11:     private final MessageQueue messageQueue;\n 12: \n 13:     @Override\n 14:     public void run() {\n 15:         if (this.processQueue.isDropped()) {\n 16:             log.warn(\"run, the message queue not be able to consume, because it's dropped. {}\", this.messageQueue);\n 17:             return;\n 18:         }\n 19: \n 20:         // è·å¾— Consumer æ¶ˆæ¯é˜Ÿåˆ—é”\n 21:         final Object objLock = messageQueueLock.fetchLockObject(this.messageQueue);\n 22:         synchronized (objLock) {\n 23:             // (å¹¿æ’­æ¨¡å¼) æˆ–è€… (é›†ç¾¤æ¨¡å¼ && Brokeræ¶ˆæ¯é˜Ÿåˆ—é”æœ‰æ•ˆ)\n 24:             if (MessageModel.BROADCASTING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())\n 25:                 || (this.processQueue.isLocked() && !this.processQueue.isLockExpired())) {\n 26:                 final long beginTime = System.currentTimeMillis();\n 27:                 // å¾ªç¯\n 28:                 for (boolean continueConsume = true; continueConsume; ) {\n 29:                     if (this.processQueue.isDropped()) {\n 30:                         log.warn(\"the message queue not be able to consume, because it's dropped. {}\", this.messageQueue);\n 31:                         break;\n 32:                     }\n 33: \n 34:                     // æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”æœªé”å®šï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚\n 35:                     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())\n 36:                         && !this.processQueue.isLocked()) {\n 37:                         log.warn(\"the message queue not locked, so consume later, {}\", this.messageQueue);\n 38:                         ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 10);\n 39:                         break;\n 40:                     }\n 41:                     // æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”å·²ç»è¿‡æœŸï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚\n 42:                     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())\n 43:                         && this.processQueue.isLockExpired()) {\n 44:                         log.warn(\"the message queue lock expired, so consume later, {}\", this.messageQueue);\n 45:                         ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 10);\n 46:                         break;\n 47:                     }\n 48: \n 49:                     // å½“å‰å‘¨æœŸæ¶ˆè´¹æ—¶é—´è¶…è¿‡è¿ç»­æ—¶é•¿ï¼Œé»˜è®¤ï¼š60sï¼Œæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¶ˆè´¹1åˆ†é’Ÿä¼‘æ¯10msã€‚\n 50:                     long interval = System.currentTimeMillis() - beginTime;\n 51:                     if (interval > MAX_TIME_CONSUME_CONTINUOUSLY) {\n 52:                         ConsumeMessageOrderlyService.this.submitConsumeRequestLater(processQueue, messageQueue, 10);\n 53:                         break;\n 54:                     }\n 55: \n 56:                     // è·å–æ¶ˆè´¹æ¶ˆæ¯ã€‚æ­¤å¤„å’Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚ä¸åŒï¼Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚å·²ç»å¸¦äº†æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚\n 57:                     final int consumeBatchSize = ConsumeMessageOrderlyService.this.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();\n 58:                     List<MessageExt> msgs = this.processQueue.takeMessags(consumeBatchSize);\n 59:                     if (!msgs.isEmpty()) {\n 60:                         final ConsumeOrderlyContext context = new ConsumeOrderlyContext(this.messageQueue);\n 61: \n 62:                         ConsumeOrderlyStatus status = null;\n 63: \n 64:                         // ....çœç•¥ä»£ç ï¼šHookï¼šbefore\n 65: \n 66:                         // æ‰§è¡Œæ¶ˆè´¹\n 67:                         long beginTimestamp = System.currentTimeMillis();\n 68:                         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;\n 69:                         boolean hasException = false;\n 70:                         try {\n 71:                             this.processQueue.getLockConsume().lock(); // é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”\n 72: \n 73:                             if (this.processQueue.isDropped()) {\n 74:                                 log.warn(\"consumeMessage, the message queue not be able to consume, because it's dropped. {}\",\n 75:                                     this.messageQueue);\n 76:                                 break;\n 77:                             }\n 78: \n 79:                             status = messageListener.consumeMessage(Collections.unmodifiableList(msgs), context);\n 80:                         } catch (Throwable e) {\n 81:                             log.warn(\"consumeMessage exception: {} Group: {} Msgs: {} MQ: {}\", //\n 82:                                 RemotingHelper.exceptionSimpleDesc(e), //\n 83:                                 ConsumeMessageOrderlyService.this.consumerGroup, //\n 84:                                 msgs, //\n 85:                                 messageQueue);\n 86:                             hasException = true;\n 87:                         } finally {\n 88:                             this.processQueue.getLockConsume().unlock(); // é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”\n 89:                         }\n 90: \n 91:                         // ....çœç•¥ä»£ç ï¼šè§£ææ¶ˆè´¹ç»“æœçŠ¶æ€\n 92: \n 93:                         // ....çœç•¥ä»£ç ï¼šHookï¼šafter\n 94: \n 95:                         ConsumeMessageOrderlyService.this.getConsumerStatsManager()\n 96:                             .incConsumeRT(ConsumeMessageOrderlyService.this.consumerGroup, messageQueue.getTopic(), consumeRT);\n 97: \n 98:                         // å¤„ç†æ¶ˆè´¹ç»“æœ\n 99:                         continueConsume = ConsumeMessageOrderlyService.this.processConsumeResult(msgs, status, context, this);\n100:                     } else {\n101:                         continueConsume = false;\n102:                     }\n103:                 }\n104:             } else {\n105:                 if (this.processQueue.isDropped()) {\n106:                     log.warn(\"the message queue not be able to consume, because it's dropped. {}\", this.messageQueue);\n107:                     return;\n108:                 }\n109: \n110:                 ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 100);\n111:             }\n112:         }\n113:     }\n114: \n115: }\n```\n\n* â¬†ï¸â¬†ï¸â¬†ï¸\n* ç¬¬ 20 è¡Œ ï¼šè·å¾— `Consumer` æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚\n* ç¬¬ 58 è¡Œ ï¼šä»æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é¡ºåºè·å¾—æ¶ˆæ¯ã€‚**å’Œå¹¶å‘æ¶ˆè´¹è·å¾—æ¶ˆæ¯ä¸åŒã€‚å¹¶å‘æ¶ˆè´¹è¯·æ±‚åœ¨è¯·æ±‚åˆ›å»ºæ—¶ï¼Œå·²ç»è®¾ç½®å¥½æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚**\n* ç¬¬ 71 è¡Œ ï¼šè·å¾— `Consumer` æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ã€‚ç›¸æ¯”ã€`Consumer`æ¶ˆæ¯é˜Ÿåˆ—é”ã€‘ï¼Œå…¶ç²’åº¦è¾ƒå°ã€‚è¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„â“**ä¸ºä»€ä¹ˆæœ‰`Consumer`æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ Consumer æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢**çš„åŸå› ã€‚\n* ç¬¬ 79 è¡Œ ï¼š**æ‰§è¡Œæ¶ˆè´¹**ã€‚\n* ç¬¬ 99 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚\n\n### 3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ\n\né¡ºåºæ¶ˆè´¹æ¶ˆæ¯ç»“æœ (`ConsumeOrderlyStatus`) æœ‰å››ç§æƒ…å†µï¼š\n\n* `SUCCESS` ï¼šæ¶ˆè´¹æˆåŠŸ**ä½†ä¸æäº¤**ã€‚\n* `ROLLBACK` ï¼šæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆè´¹å›æ»šã€‚\n* `COMMIT` ï¼šæ¶ˆè´¹æˆåŠŸæäº¤å¹¶ä¸”æäº¤ã€‚\n* `SUSPEND_CURRENT_QUEUE_A_MOMENT` ï¼šæ¶ˆè´¹å¤±è´¥ï¼ŒæŒ‚èµ·æ¶ˆè´¹é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚\n\nè€ƒè™‘åˆ° `ROLLBACK` ã€`COMMIT` æš‚æ—¶åªä½¿ç”¨åœ¨ `MySQL binlog` åœºæ™¯ï¼Œå®˜æ–¹å°†è¿™ä¸¤çŠ¶æ€æ ‡è®°ä¸º `@Deprecated`ã€‚å½“ç„¶ï¼Œç›¸åº”çš„å®ç°é€»è¾‘ä¾ç„¶ä¿ç•™ã€‚\n\nåœ¨**å¹¶å‘æ¶ˆè´¹**åœºæ™¯æ—¶ï¼Œå¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œ`Consumer` ä¼šå°†æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯å‘å›åˆ° `Broker` é‡è¯•é˜Ÿåˆ—ï¼Œè·³è¿‡å½“å‰æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹æ¬¡æ‹‰å–è¯¥æ¶ˆæ¯å†è¿›è¡Œæ¶ˆè´¹ã€‚\n\nä½†æ˜¯åœ¨**å®Œå…¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹**æ¶ˆè´¹æ—¶ï¼Œè¿™æ ·åšæ˜¾ç„¶ä¸è¡Œã€‚ä¹Ÿå› æ­¤ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¼šæŒ‚èµ·é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚ \n\nä¸è¿‡æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ä¸€ç›´å¤±è´¥ï¼Œä¹Ÿä¸å¯èƒ½ä¸€ç›´æ¶ˆè´¹ã€‚å½“è¶…è¿‡æ¶ˆè´¹é‡è¯•ä¸Šé™æ—¶ï¼Œ`Consumer` ä¼šå°†æ¶ˆè´¹å¤±è´¥è¶…è¿‡ä¸Šé™çš„æ¶ˆæ¯å‘å›åˆ° `Broker` æ­»ä¿¡é˜Ÿåˆ—ã€‚\n\nè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘\n  2: /**\n  3:  * å¤„ç†æ¶ˆè´¹ç»“æœï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­æ¶ˆè´¹\n  4:  *\n  5:  * @param msgs æ¶ˆæ¯\n  6:  * @param status æ¶ˆè´¹ç»“æœçŠ¶æ€\n  7:  * @param context æ¶ˆè´¹Context\n  8:  * @param consumeRequest æ¶ˆè´¹è¯·æ±‚\n  9:  * @return æ˜¯å¦ç»§ç»­æ¶ˆè´¹\n 10:  */\n 11: public boolean processConsumeResult(//\n 12:     final List<MessageExt> msgs, //\n 13:     final ConsumeOrderlyStatus status, //\n 14:     final ConsumeOrderlyContext context, //\n 15:     final ConsumeRequest consumeRequest//\n 16: ) {\n 17:     boolean continueConsume = true;\n 18:     long commitOffset = -1L;\n 19:     if (context.isAutoCommit()) {\n 20:         switch (status) {\n 21:             case COMMIT:\n 22:             case ROLLBACK:\n 23:                 log.warn(\"the message queue consume result is illegal, we think you want to ack these message {}\", consumeRequest.getMessageQueue());\n 24:             case SUCCESS:\n 25:                 // æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n 26:                 commitOffset = consumeRequest.getProcessQueue().commit();\n 27:                 // ç»Ÿè®¡\n 28:                 this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());\n 29:                 break;\n 30:             case SUSPEND_CURRENT_QUEUE_A_MOMENT:\n 31:                 // ç»Ÿè®¡\n 32:                 this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());\n 33:                 if (checkReconsumeTimes(msgs)) { // è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms\n 34:                     // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹\n 35:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);\n 36:                     // æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚\n 37:                     this.submitConsumeRequestLater(//\n 38:                         consumeRequest.getProcessQueue(), //\n 39:                         consumeRequest.getMessageQueue(), //\n 40:                         context.getSuspendCurrentQueueTimeMillis());\n 41:                     continueConsume = false;\n 42:                 } else {\n 43:                     commitOffset = consumeRequest.getProcessQueue().commit();\n 44:                 }\n 45:                 break;\n 46:             default:\n 47:                 break;\n 48:         }\n 49:     } else {\n 50:         switch (status) {\n 51:             case SUCCESS:\n 52:                 this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());\n 53:                 break;\n 54:             case COMMIT:\n 55:                 // æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n 56:                 commitOffset = consumeRequest.getProcessQueue().commit();\n 57:                 break;\n 58:             case ROLLBACK:\n 59:                 // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹\n 60:                 consumeRequest.getProcessQueue().rollback();\n 61:                 this.submitConsumeRequestLater(//\n 62:                     consumeRequest.getProcessQueue(), //\n 63:                     consumeRequest.getMessageQueue(), //\n 64:                     context.getSuspendCurrentQueueTimeMillis());\n 65:                 continueConsume = false;\n 66:                 break;\n 67:             case SUSPEND_CURRENT_QUEUE_A_MOMENT: // è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms\n 68:                 this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());\n 69:                 if (checkReconsumeTimes(msgs)) {\n 70:                     // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹\n 71:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);\n 72:                     // æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚\n 73:                     this.submitConsumeRequestLater(//\n 74:                         consumeRequest.getProcessQueue(), //\n 75:                         consumeRequest.getMessageQueue(), //\n 76:                         context.getSuspendCurrentQueueTimeMillis());\n 77:                     continueConsume = false;\n 78:                 }\n 79:                 break;\n 80:             default:\n 81:                 break;\n 82:         }\n 83:     }\n 84: \n 85:     // æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœªdroppedï¼Œæäº¤æœ‰æ•ˆæ¶ˆè´¹è¿›åº¦\n 86:     if (commitOffset >= 0 && !consumeRequest.getProcessQueue().isDropped()) {\n 87:         this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), commitOffset, false);\n 88:     }\n 89: \n 90:     return continueConsume;\n 91: }\n 92: \n 93: private int getMaxReconsumeTimes() {\n 94:     // default reconsume times: Integer.MAX_VALUE\n 95:     if (this.defaultMQPushConsumer.getMaxReconsumeTimes() == -1) {\n 96:         return Integer.MAX_VALUE;\n 97:     } else {\n 98:         return this.defaultMQPushConsumer.getMaxReconsumeTimes();\n 99:     }\n100: }\n101: \n102: /**\n103:  * è®¡ç®—æ˜¯å¦è¦æš‚åœæ¶ˆè´¹\n104:  * ä¸æš‚åœæ¡ä»¶ï¼šå­˜åœ¨æ¶ˆæ¯éƒ½è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°å¹¶ä¸”éƒ½å‘å›brokeræˆåŠŸ\n105:  *\n106:  * @param msgs æ¶ˆæ¯\n107:  * @return æ˜¯å¦è¦æš‚åœ\n108:  */\n109: private boolean checkReconsumeTimes(List<MessageExt> msgs) {\n110:     boolean suspend = false;\n111:     if (msgs != null && !msgs.isEmpty()) {\n112:         for (MessageExt msg : msgs) {\n113:             if (msg.getReconsumeTimes() >= getMaxReconsumeTimes()) {\n114:                 MessageAccessor.setReconsumeTime(msg, String.valueOf(msg.getReconsumeTimes()));\n115:                 if (!sendMessageBack(msg)) { // å‘å›å¤±è´¥ï¼Œä¸­æ–­\n116:                     suspend = true;\n117:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);\n118:                 }\n119:             } else {\n120:                 suspend = true;\n121:                 msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);\n122:             }\n123:         }\n124:     }\n125:     return suspend;\n126: }\n127: \n128: /**\n129:  * å‘å›æ¶ˆæ¯ã€‚\n130:  * æ¶ˆæ¯å‘å›brokeråï¼Œå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ­»ä¿¡é˜Ÿåˆ—ã€‚\n131:  *\n132:  * @param msg æ¶ˆæ¯\n133:  * @return æ˜¯å¦å‘é€æˆåŠŸ\n134:  */\n135: public boolean sendMessageBack(final MessageExt msg) {\n136:     try {\n137:         // max reconsume times exceeded then send to dead letter queue.\n138:         Message newMsg = new Message(MixAll.getRetryTopic(this.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());\n139:         String originMsgId = MessageAccessor.getOriginMessageId(msg);\n140:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);\n141:         newMsg.setFlag(msg.getFlag());\n142:         MessageAccessor.setProperties(newMsg, msg.getProperties());\n143:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());\n144:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes()));\n145:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));\n146:         newMsg.setDelayTimeLevel(3 + msg.getReconsumeTimes());\n147: \n148:         this.defaultMQPushConsumer.getDefaultMQPushConsumerImpl().getmQClientFactory().getDefaultMQProducer().send(newMsg);\n149:         return true;\n150:     } catch (Exception e) {\n151:         log.error(\"sendMessageBack exception, group: \" + this.consumerGroup + \" msg: \" + msg.toString(), e);\n152:     }\n153: \n154:     return false;\n155: }\n```\n\n* â¬†ï¸â¬†ï¸â¬†ï¸\n* ç¬¬ 21 è‡³ 29 è¡Œ ï¼šæ¶ˆè´¹æˆåŠŸã€‚åœ¨è‡ªåŠ¨æäº¤è¿›åº¦( `AutoCommit` )çš„æƒ…å†µä¸‹ï¼Œ`COMMIT`ã€`ROLLBACK`ã€`SUCCESS` é€»è¾‘**å·²ç»ç»Ÿä¸€**ã€‚\n* ç¬¬ 30 è‡³ 45 è¡Œ ï¼šæ¶ˆè´¹å¤±è´¥ã€‚å½“æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™ï¼ˆé»˜è®¤ ï¼š16æ¬¡ï¼‰æ—¶ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° `Broker` æ­»ä¿¡é˜Ÿåˆ—ï¼Œè·³è¿‡è¿™äº›æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­æ¶ˆè´¹åé¢çš„æ¶ˆæ¯ã€‚\n* ç¬¬ 85 è‡³ 88 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¿›åº¦ã€‚\n\n### 3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•\n\nğŸ˜ˆæ¶‰åŠåˆ°çš„å››ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æºç ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ProcessQueue.javaã€‘\n  2: /**\n  3:  * æ¶ˆæ¯æ˜ å°„\n  4:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n  5:  */\n  6: private final TreeMap<Long, MessageExt> msgTreeMap = new TreeMap<>();    /**\n  7:  * æ¶ˆæ¯æ˜ å°„ä¸´æ—¶å­˜å‚¨ï¼ˆæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯ï¼‰\n  8:  */\n  9: private final TreeMap<Long, MessageExt> msgTreeMapTemp = new TreeMap<>();\n 10: \n 11: /**\n 12:  * å›æ»šæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯\n 13:  * é€»è¾‘ç±»ä¼¼äº{@link #makeMessageToCosumeAgain(List)}\n 14:  */\n 15: public void rollback() {\n 16:     try {\n 17:         this.lockTreeMap.writeLock().lockInterruptibly();\n 18:         try {\n 19:             this.msgTreeMap.putAll(this.msgTreeMapTemp);\n 20:             this.msgTreeMapTemp.clear();\n 21:         } finally {\n 22:             this.lockTreeMap.writeLock().unlock();\n 23:         }\n 24:     } catch (InterruptedException e) {\n 25:         log.error(\"rollback exception\", e);\n 26:     }\n 27: }\n 28: \n 29: /**\n 30:  * æäº¤æ¶ˆè´¹ä¸­çš„æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸï¼Œè¿”å›æ¶ˆè´¹è¿›åº¦\n 31:  *\n 32:  * @return æ¶ˆè´¹è¿›åº¦\n 33:  */\n 34: public long commit() {\n 35:     try {\n 36:         this.lockTreeMap.writeLock().lockInterruptibly();\n 37:         try {\n 38:             // æ¶ˆè´¹è¿›åº¦\n 39:             Long offset = this.msgTreeMapTemp.lastKey();\n 40: \n 41:             //\n 42:             msgCount.addAndGet(this.msgTreeMapTemp.size() * (-1));\n 43: \n 44:             //\n 45:             this.msgTreeMapTemp.clear();\n 46: \n 47:             // è¿”å›æ¶ˆè´¹è¿›åº¦\n 48:             if (offset != null) {\n 49:                 return offset + 1;\n 50:             }\n 51:         } finally {\n 52:             this.lockTreeMap.writeLock().unlock();\n 53:         }\n 54:     } catch (InterruptedException e) {\n 55:         log.error(\"commit exception\", e);\n 56:     }\n 57: \n 58:     return -1;\n 59: }\n 60: \n 61: /**\n 62:  * æŒ‡å®šæ¶ˆæ¯é‡æ–°æ¶ˆè´¹\n 63:  * é€»è¾‘ç±»ä¼¼äº{@link #rollback()}\n 64:  *\n 65:  * @param msgs æ¶ˆæ¯\n 66:  */\n 67: public void makeMessageToCosumeAgain(List<MessageExt> msgs) {\n 68:     try {\n 69:         this.lockTreeMap.writeLock().lockInterruptibly();\n 70:         try {\n 71:             for (MessageExt msg : msgs) {\n 72:                 this.msgTreeMapTemp.remove(msg.getQueueOffset());\n 73:                 this.msgTreeMap.put(msg.getQueueOffset(), msg);\n 74:             }\n 75:         } finally {\n 76:             this.lockTreeMap.writeLock().unlock();\n 77:         }\n 78:     } catch (InterruptedException e) {\n 79:         log.error(\"makeMessageToCosumeAgain exception\", e);\n 80:     }\n 81: }\n 82: \n 83: /**\n 84:  * è·å¾—æŒæœ‰æ¶ˆæ¯å‰Næ¡\n 85:  *\n 86:  * @param batchSize æ¡æ•°\n 87:  * @return æ¶ˆæ¯\n 88:  */\n 89: public List<MessageExt> takeMessags(final int batchSize) {\n 90:     List<MessageExt> result = new ArrayList<>(batchSize);\n 91:     final long now = System.currentTimeMillis();\n 92:     try {\n 93:         this.lockTreeMap.writeLock().lockInterruptibly();\n 94:         this.lastConsumeTimestamp = now;\n 95:         try {\n 96:             if (!this.msgTreeMap.isEmpty()) {\n 97:                 for (int i = 0; i < batchSize; i++) {\n 98:                     Map.Entry<Long, MessageExt> entry = this.msgTreeMap.pollFirstEntry();\n 99:                     if (entry != null) {\n100:                         result.add(entry.getValue());\n101:                         msgTreeMapTemp.put(entry.getKey(), entry.getValue());\n102:                     } else {\n103:                         break;\n104:                     }\n105:                 }\n106:             }\n107: \n108:             if (result.isEmpty()) {\n109:                 consuming = false;\n110:             }\n111:         } finally {\n112:             this.lockTreeMap.writeLock().unlock();\n113:         }\n114:     } catch (InterruptedException e) {\n115:         log.error(\"take Messages exception\", e);\n116:     }\n117: \n118:     return result;\n119: }\n```\n\n\n","slug":"RocketMQ/message-send-and-consume-orderly","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswzn0011ak5dpbi560lr","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1007-RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. Producer é¡ºåºå‘é€</a></li>\n<li><a href=\"#\">3. Consumer é¡ºåºæ¶ˆè´¹</a><ul>\n<li><a href=\"#\">3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</a></li>\n<li><a href=\"#\">3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</a></li>\n<li><a href=\"#\">3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</a><ul>\n<li><a href=\"#\">3.1.1 æ¶ˆè´¹æ¶ˆæ¯</a></li>\n<li><a href=\"#\">3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</a></li>\n<li><a href=\"#\">3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p><strong>å»ºè®®</strong>å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>\n<ul>\n<li><a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1003-RocketMQæºç è§£æï¼šMessageå‘é€&amp;æ¥æ”¶.md\" target=\"_blank\" rel=\"external\">ã€ŠMessageå‘é€&amp;æ¥æ”¶ã€‹</a></li>\n<li><a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md\" target=\"_blank\" rel=\"external\">ã€ŠMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹</a></li>\n</ul>\n<p>å½“ç„¶å¯¹ <code>Message</code> å‘é€ä¸æ¶ˆè´¹å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡ã€‚</p>\n<hr>\n<p><code>RocketMQ</code> æä¾›äº†ä¸¤ç§é¡ºåºçº§åˆ«ï¼š</p>\n<ul>\n<li>æ™®é€šé¡ºåºæ¶ˆæ¯ ï¼š<code>Producer</code> å°†ç›¸å…³è”çš„æ¶ˆæ¯å‘é€åˆ°ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>å®Œå…¨ä¸¥æ ¼é¡ºåº ï¼šåœ¨ <code>æ™®é€šé¡ºåºæ¶ˆæ¯</code> çš„åŸºç¡€ä¸Šï¼Œ<code>Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>\n</ul>\n<p>ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹åªéœ€è¦ç”¨åˆ°<strong>æ™®é€šé¡ºåºæ¶ˆæ¯</strong>ã€‚<br>ä¾‹å¦‚è¯´ï¼šç»™ç”¨æˆ·å‘é€çŸ­ä¿¡æ¶ˆæ¯ + å‘é€æ¨é€æ¶ˆæ¯ï¼Œå°†ä¸¤æ¡æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‹¥å…¶ä¸­ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è¾ƒæ…¢é€ æˆå µå¡ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ï¼Œå¸¦æ¥çš„ä½“éªŒä¼šç›¸å¯¹è¾ƒå·®ã€‚å½“ç„¶ç±»ä¼¼è¿™ç§åœºæ™¯ï¼Œå³ä½¿æœ‰ä¸€å®šçš„æ—¶é—´å·®ï¼Œ<strong>ä¸ä¼šäº§ç”Ÿç³»ç»Ÿé€»è¾‘ä¸ŠBUG</strong>ã€‚å¦å¤–ï¼Œ<code>æ™®é€šé¡ºåºæ¶ˆæ¯</code>æ€§èƒ½èƒ½æ›´åŠ å¥½ã€‚<br>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä½¿ç”¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåº</strong>ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼š</p>\n<blockquote>\n<p>ç›®å‰å·²çŸ¥çš„åº”ç”¨åªæœ‰æ•°æ®åº“ <code>binlog</code> åŒæ­¥å¼ºä¾èµ–ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼Œå…¶ä»–åº”ç”¨ç»å¤§éƒ¨åˆ†éƒ½å¯ä»¥å®¹å¿çŸ­æš‚ä¹±åºï¼Œæ¨èä½¿ç”¨æ™®é€šçš„é¡ºåºæ¶ˆæ¯</p>\n</blockquote>\n<hr>\n<p>ğŸ˜ˆä¸Šä»£ç ï¼ï¼ï¼</p>\n<h1 id=\"2-Producer-é¡ºåºå‘é€\"><a href=\"#2-Producer-é¡ºåºå‘é€\" class=\"headerlink\" title=\"2. Producer é¡ºåºå‘é€\"></a>2. <code>Producer</code> é¡ºåºå‘é€</h1><p>å®˜æ–¹å‘é€é¡ºåºæ¶ˆæ¯çš„<strong>ä¾‹å­</strong>ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">package</span> org.apache.rocketmq.example.ordermessage;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"keyword\">import</span> java.io.UnsupportedEncodingException;</div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"keyword\">import</span> java.util.List;</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.exception.MQBrokerException;</div><div class=\"line\"> <span class=\"number\">6</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.exception.MQClientException;</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.producer.MQProducer;</div><div class=\"line\"> <span class=\"number\">9</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.producer.MessageQueueSelector;</div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.producer.SendResult;</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.common.message.Message;</div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.common.message.MessageQueue;</div><div class=\"line\"><span class=\"number\">13</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</div><div class=\"line\"><span class=\"number\">14</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.remoting.exception.RemotingException;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> UnsupportedEncodingException </span>&#123;</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             MQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(<span class=\"string\">\"please_rename_unique_group_name\"</span>);</div><div class=\"line\"><span class=\"number\">20</span>:             producer.start();</div><div class=\"line\"><span class=\"number\">21</span>: </div><div class=\"line\"><span class=\"number\">22</span>:             String[] tags = <span class=\"keyword\">new</span> String[] &#123;<span class=\"string\">\"TagA\"</span>, <span class=\"string\">\"TagB\"</span>, <span class=\"string\">\"TagC\"</span>, <span class=\"string\">\"TagD\"</span>, <span class=\"string\">\"TagE\"</span>&#125;;</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">100</span>; i++) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 <span class=\"keyword\">int</span> orderId = i % <span class=\"number\">10</span>;</div><div class=\"line\"><span class=\"number\">25</span>:                 Message msg =</div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"keyword\">new</span> Message(<span class=\"string\">\"TopicTestjjj\"</span>, tags[i % tags.length], <span class=\"string\">\"KEY\"</span> + i,</div><div class=\"line\"><span class=\"number\">27</span>:                         (<span class=\"string\">\"Hello RocketMQ \"</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</div><div class=\"line\"><span class=\"number\">28</span>:                 SendResult sendResult = producer.send(msg, <span class=\"keyword\">new</span> MessageQueueSelector() &#123;</div><div class=\"line\"><span class=\"number\">29</span>:                     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"function\"><span class=\"keyword\">public</span> MessageQueue <span class=\"title\">select</span><span class=\"params\">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">31</span>:                         Integer id = (Integer) arg;</div><div class=\"line\"><span class=\"number\">32</span>:                         <span class=\"keyword\">int</span> index = id % mqs.size();</div><div class=\"line\"><span class=\"number\">33</span>:                         <span class=\"keyword\">return</span> mqs.get(index);</div><div class=\"line\"><span class=\"number\">34</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">35</span>:                 &#125;, orderId);</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:                 System.out.printf(<span class=\"string\">\"%s%n\"</span>, sendResult);</div><div class=\"line\"><span class=\"number\">38</span>:             &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:             producer.shutdown();</div><div class=\"line\"><span class=\"number\">41</span>:         &#125; <span class=\"keyword\">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             e.printStackTrace();</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>:     &#125;</div><div class=\"line\"><span class=\"number\">45</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ 28 è‡³ 35 è¡Œ ï¼šå®ç°äº†æ ¹æ® <code>id % mqs.size()</code> æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©ã€‚å½“å‰ä¾‹å­ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’ <code>orderId</code> ä½œä¸ºå‚æ•°ï¼Œé‚£ä¹ˆç›¸åŒçš„ <code>orderId</code> èƒ½å¤Ÿè¿›å…¥ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚</li>\n</ul>\n<hr>\n<p><code>MessageQueueSelector</code> æ¥å£çš„<strong>æºç </strong>ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">MessageQueueSelector</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 5:      *</div><div class=\"line\"> 6:      * <span class=\"doctag\">@param</span> mqs æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 7:      * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\"> 8:      * <span class=\"doctag\">@param</span> arg å‚æ•°</div><div class=\"line\"> 9:      * <span class=\"doctag\">@return</span> æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">10:      */</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"function\">MessageQueue <span class=\"title\">select</span><span class=\"params\">(<span class=\"keyword\">final</span> List&lt;MessageQueue&gt; mqs, <span class=\"keyword\">final</span> Message msg, <span class=\"keyword\">final</span> Object arg)</span></span>;</div><div class=\"line\"><span class=\"number\">12</span>: &#125;</div></pre></td></tr></table></figure>\n<hr>\n<p><code>Producer</code> é€‰æ‹©é˜Ÿåˆ—å‘é€æ¶ˆæ¯æ–¹æ³•çš„<strong>æºç </strong>ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">16</span>: <span class=\"function\"><span class=\"keyword\">private</span> SendResult <span class=\"title\">sendSelectImpl</span><span class=\"params\">(//</span></span></div><div class=\"line\"><span class=\"number\">17</span>:     Message msg, //</div><div class=\"line\"><span class=\"number\">18</span>:     MessageQueueSelector selector, //</div><div class=\"line\"><span class=\"number\">19</span>:     Object arg, //</div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode, //</div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"keyword\">final</span> SendCallback sendCallback, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeout//</div><div class=\"line\"><span class=\"number\">22</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"keyword\">this</span>.makeSureStateOK();</div><div class=\"line\"><span class=\"number\">24</span>:     Validators.checkMessage(msg, <span class=\"keyword\">this</span>.defaultMQProducer);</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:     TopicPublishInfo topicPublishInfo = <span class=\"keyword\">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"keyword\">if</span> (topicPublishInfo != <span class=\"keyword\">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class=\"line\"><span class=\"number\">28</span>:         MessageQueue mq = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);</div><div class=\"line\"><span class=\"number\">31</span>:         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"select message queue throwed exception.\"</span>, e);</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>: </div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">if</span> (mq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">36</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, <span class=\"keyword\">null</span>, timeout);</div><div class=\"line\"><span class=\"number\">37</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">38</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"select message queue return null.\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">39</span>:         &#125;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"No route info for this topic, \"</span> + msg.getTopic(), <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">43</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ 30 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 36 è¡Œ ï¼šå‘é€æ¶ˆæ¯ã€‚</li>\n</ul>\n<h1 id=\"3-Consumer-ä¸¥æ ¼é¡ºåºæ¶ˆè´¹\"><a href=\"#3-Consumer-ä¸¥æ ¼é¡ºåºæ¶ˆè´¹\" class=\"headerlink\" title=\"3. Consumer ä¸¥æ ¼é¡ºåºæ¶ˆè´¹\"></a>3. <code>Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</h1><p><code>Consumer</code> åœ¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹æ—¶ï¼Œé€šè¿‡ <strong>ä¸‰</strong> æŠŠé”ä¿è¯ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</p>\n<ul>\n<li><code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>åˆ†å¸ƒå¼é”</strong>ï¼‰ ï¼š<ul>\n<li>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> ä» <code>Broker</code> è·å¾—è¯¥é”åï¼Œæ‰èƒ½è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€æ¶ˆè´¹ã€‚</li>\n<li>å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> æ— éœ€è¯¥é”ã€‚</li>\n</ul>\n</li>\n<li><code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code>Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ“ä½œæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li><code>Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code>Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n<p><strong>å¯èƒ½åŒå­¦æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæœ‰ <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>ï¼ŸğŸ˜ˆè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>\n<hr>\n<h2 id=\"3-1-è·å¾—-é”å®š-æ¶ˆæ¯é˜Ÿåˆ—\"><a href=\"#3-1-è·å¾—-é”å®š-æ¶ˆæ¯é˜Ÿåˆ—\" class=\"headerlink\" title=\"3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—\"></a>3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</h2><p><strong>é›†ç¾¤æ¨¡å¼</strong>ä¸‹ï¼Œ<code>Consumer</code> æ›´æ–°å±äºè‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code>Broker</code> é”å®šè¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ<em>å¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦</em>ï¼‰ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œåˆ™æ›´æ–°å¤±è´¥ï¼Œå³è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸å±äºè‡ªå·±ï¼Œä¸èƒ½è¿›è¡Œæ¶ˆè´¹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">updateProcessQueueTableInRebalance</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> Set&lt;MessageQueue&gt; mqSet, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrder)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"comment\">// ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"comment\">// å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class=\"line\"> <span class=\"number\">5</span>:     List&lt;PullRequest&gt; pullRequestList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(); <span class=\"comment\">// æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">for</span> (MessageQueue mq : mqSet) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"keyword\">if</span> (isOrder &amp;&amp; !<span class=\"keyword\">this</span>.lock(mq)) &#123; <span class=\"comment\">// é¡ºåºæ¶ˆæ¯é”å®šæ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">9</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">10</span>:                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">11</span>:             &#125;</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">this</span>.removeDirtyOffset(mq);</div><div class=\"line\"><span class=\"number\">14</span>:             ProcessQueue pq = <span class=\"keyword\">new</span> ProcessQueue();</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">long</span> nextOffset = <span class=\"keyword\">this</span>.computePullFromWhere(mq);</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">if</span> (nextOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                 ProcessQueue pre = <span class=\"keyword\">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"keyword\">if</span> (pre != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">20</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">22</span>:                     PullRequest pullRequest = <span class=\"keyword\">new</span> PullRequest();</div><div class=\"line\"><span class=\"number\">23</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class=\"line\"><span class=\"number\">24</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class=\"line\"><span class=\"number\">25</span>:                     pullRequest.setMessageQueue(mq);</div><div class=\"line\"><span class=\"number\">26</span>:                     pullRequest.setProcessQueue(pq);</div><div class=\"line\"><span class=\"number\">27</span>:                     pullRequestList.add(pullRequest);</div><div class=\"line\"><span class=\"number\">28</span>:                     changed = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">30</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">32</span>:             &#125;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:     &#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>: <span class=\"comment\">// ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class=\"line\"><span class=\"number\">37</span>: &#125;</div><div class=\"line\"><span class=\"number\">38</span>: </div><div class=\"line\"><span class=\"number\">39</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘</span></div><div class=\"line\"><span class=\"number\">40</span>: <span class=\"comment\">/**</span></div><div class=\"line\">41:  * è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”</div><div class=\"line\">42:  *</div><div class=\"line\">43:  * <span class=\"doctag\">@param</span> mq é˜Ÿåˆ—</div><div class=\"line\">44:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\">45:  */</div><div class=\"line\"><span class=\"number\">46</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">lock</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">47</span>:     FindBrokerResult findBrokerResult = <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(), MixAll.MASTER_ID, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">48</span>:     <span class=\"keyword\">if</span> (findBrokerResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">49</span>:         LockBatchRequestBody requestBody = <span class=\"keyword\">new</span> LockBatchRequestBody();</div><div class=\"line\"><span class=\"number\">50</span>:         requestBody.setConsumerGroup(<span class=\"keyword\">this</span>.consumerGroup);</div><div class=\"line\"><span class=\"number\">51</span>:         requestBody.setClientId(<span class=\"keyword\">this</span>.mQClientFactory.getClientId());</div><div class=\"line\"><span class=\"number\">52</span>:         requestBody.getMqSet().add(mq);</div><div class=\"line\"><span class=\"number\">53</span>: </div><div class=\"line\"><span class=\"number\">54</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">55</span>:             <span class=\"comment\">// è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”</span></div><div class=\"line\"><span class=\"number\">56</span>:             Set&lt;MessageQueue&gt; lockedMq =</div><div class=\"line\"><span class=\"number\">57</span>:                 <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().lockBatchMQ(findBrokerResult.getBrokerAddr(), requestBody, <span class=\"number\">1000</span>);</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>:             <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é”å®šæˆåŠŸã€‚é”å®šæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸï¼Œå¯èƒ½æœ¬åœ°æ²¡æœ‰æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ï¼Œè®¾ç½®é”å®šæˆåŠŸä¼šåœ¨lockAll()æ–¹æ³•ã€‚</span></div><div class=\"line\"><span class=\"number\">60</span>:             <span class=\"keyword\">for</span> (MessageQueue mmqq : lockedMq) &#123;</div><div class=\"line\"><span class=\"number\">61</span>:                 ProcessQueue processQueue = <span class=\"keyword\">this</span>.processQueueTable.get(mmqq);</div><div class=\"line\"><span class=\"number\">62</span>:                 <span class=\"keyword\">if</span> (processQueue != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">63</span>:                     processQueue.setLocked(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">64</span>:                     processQueue.setLastLockTimestamp(System.currentTimeMillis());</div><div class=\"line\"><span class=\"number\">65</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">66</span>:             &#125;</div><div class=\"line\"><span class=\"number\">67</span>: </div><div class=\"line\"><span class=\"number\">68</span>:             <span class=\"keyword\">boolean</span> lockOK = lockedMq.contains(mq);</div><div class=\"line\"><span class=\"number\">69</span>:             log.info(<span class=\"string\">\"the message queue lock &#123;&#125;, &#123;&#125; &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">70</span>:                 lockOK ? <span class=\"string\">\"OK\"</span> : <span class=\"string\">\"Failed\"</span>,</div><div class=\"line\"><span class=\"number\">71</span>:                 <span class=\"keyword\">this</span>.consumerGroup,</div><div class=\"line\"><span class=\"number\">72</span>:                 mq);</div><div class=\"line\"><span class=\"number\">73</span>:             <span class=\"keyword\">return</span> lockOK;</div><div class=\"line\"><span class=\"number\">74</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">75</span>:             log.error(<span class=\"string\">\"lockBatchMQ exception, \"</span> + mq, e);</div><div class=\"line\"><span class=\"number\">76</span>:         &#125;</div><div class=\"line\"><span class=\"number\">77</span>:     &#125;</div><div class=\"line\"><span class=\"number\">78</span>: </div><div class=\"line\"><span class=\"number\">79</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">80</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>\n<li>ç¬¬ 8 è‡³ 11 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œé”å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œæ–°å¢æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å¤±è´¥ã€‚</li>\n</ul>\n<hr>\n<p><code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ä¼šè¿‡æœŸï¼Œé»˜è®¤é…ç½® 30sã€‚å› æ­¤ï¼Œ<code>Consumer</code> éœ€è¦ä¸æ–­å‘ <code>Broker</code> åˆ·æ–°è¯¥é”è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤é…ç½® 20s åˆ·æ–°ä¸€æ¬¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">6</span>:             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">7</span>:                 ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.lockMQPeriodically();</div><div class=\"line\"> <span class=\"number\">8</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">9</span>:         &#125;, <span class=\"number\">1000</span> * <span class=\"number\">1</span>, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">10</span>:     &#125;</div><div class=\"line\"><span class=\"number\">11</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"3-2-ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—\"><a href=\"#3-2-ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—\" class=\"headerlink\" title=\"3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—\"></a>3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</h2><p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> ç§»é™¤è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code>Broker</code> è§£é”è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * ç§»é™¤ä¸éœ€è¦çš„é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯</div><div class=\"line\"> 4:  * 1. æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹</div><div class=\"line\"> 5:  * 2. é¡ºåºæ¶ˆè´¹&amp;é›†ç¾¤æ¨¡å¼ï¼Œè§£é”å¯¹è¯¥é˜Ÿåˆ—çš„é”å®š</div><div class=\"line\"> 6:  *</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\"> 9:  * <span class=\"doctag\">@return</span> æ˜¯å¦ç§»é™¤æˆåŠŸ</div><div class=\"line\">10:  */</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">removeUnnecessaryMessageQueue</span><span class=\"params\">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"comment\">// åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"comment\">// é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé¡ºåºæ¶ˆè´¹ç§»é™¤æ—¶ï¼Œè§£é”å¯¹é˜Ÿåˆ—çš„é”å®š</span></div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class=\"line\"><span class=\"number\">18</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">if</span> (pq.getLockConsume().tryLock(<span class=\"number\">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.unlockDelay(mq, pq);</div><div class=\"line\"><span class=\"number\">23</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                     pq.getLockConsume().unlock();</div><div class=\"line\"><span class=\"number\">25</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">26</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">27</span>:                 log.warn(<span class=\"string\">\"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">28</span>:                     mq, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">29</span>:                     pq.getTryUnlockTimes());</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:                 pq.incTryUnlockTimes();</div><div class=\"line\"><span class=\"number\">32</span>:             &#125;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">34</span>:             log.error(<span class=\"string\">\"removeUnnecessaryMessageQueue Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">38</span>:     &#125;</div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">40</span>: &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘</span></div><div class=\"line\"><span class=\"number\">43</span>: <span class=\"comment\">/**</span></div><div class=\"line\">44:  * å»¶è¿Ÿè§£é” Broker æ¶ˆæ¯é˜Ÿåˆ—é”</div><div class=\"line\">45:  * å½“æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸å­˜åœ¨æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è§£é”</div><div class=\"line\">46:  *</div><div class=\"line\">47:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">48:  * <span class=\"doctag\">@param</span> pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\">49:  * <span class=\"doctag\">@return</span> æ˜¯å¦è§£é”æˆåŠŸ</div><div class=\"line\">50:  */</div><div class=\"line\"><span class=\"number\">51</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">unlockDelay</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq, <span class=\"keyword\">final</span> ProcessQueue pq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">52</span>:     <span class=\"keyword\">if</span> (pq.hasTempMessage()) &#123; <span class=\"comment\">// TODO ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦å»¶è¿Ÿç§»é™¤</span></div><div class=\"line\"><span class=\"number\">53</span>:         log.info(<span class=\"string\">\"[&#123;&#125;]unlockDelay, begin &#123;&#125; \"</span>, mq.hashCode(), mq);</div><div class=\"line\"><span class=\"number\">54</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getmQClientFactory().getScheduledExecutorService().schedule(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"><span class=\"number\">55</span>:             <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">56</span>:             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">57</span>:                 log.info(<span class=\"string\">\"[&#123;&#125;]unlockDelay, execute at once &#123;&#125;\"</span>, mq.hashCode(), mq);</div><div class=\"line\"><span class=\"number\">58</span>:                 RebalancePushImpl.<span class=\"keyword\">this</span>.unlock(mq, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">59</span>:             &#125;</div><div class=\"line\"><span class=\"number\">60</span>:         &#125;, UNLOCK_DELAY_TIME_MILLS, TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">61</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">this</span>.unlock(mq, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">63</span>:     &#125;</div><div class=\"line\"><span class=\"number\">64</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">65</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>\n<li>ç¬¬ 20 è‡³ 32 è¡Œ ï¼šè·å–<strong>æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”</strong>ï¼Œé¿å…å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å†²çªã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡é‡æ–°åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—æ—¶ï¼Œå†è¿›è¡Œç§»é™¤ã€‚å¦‚æœæœªè·å¾—é”è€Œè¿›è¡Œç§»é™¤ï¼Œåˆ™å¯èƒ½å‡ºç°å¦å¤–çš„  <code>Consumer</code> å’Œå½“å‰ <code>Consumer</code> åŒæ—¶æ¶ˆè´¹è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯æ— æ³•ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 51 è‡³ 64 è¡Œ ï¼šè§£é” <code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚å¦‚æœæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿè§£é” <code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚â“ä¸ºä»€ä¹ˆæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ä¸èƒ½ç›´æ¥è§£é”å‘¢ï¼ŸğŸ˜ˆæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç™¾æ€ä¸å¾—å…¶è§£ã€‚å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦æ•™è‚²ä¸‹ä¿ºã€‚</li>\n</ul>\n<h2 id=\"3-3-æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\"><a href=\"#3-3-æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\" class=\"headerlink\" title=\"3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\"></a>3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</h2><p>ğŸ˜æœ¬èŠ‚ä¼šç±»æ¯”<strong>å¹¶å‘æ¶ˆè´¹æ¶ˆè´¹é˜Ÿåˆ—</strong>ï¼Œå»ºè®®å¯¹ç…§ <a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md#6pushconsumer-æ¶ˆè´¹æ¶ˆæ¯\" target=\"_blank\" rel=\"external\">PushConsumerå¹¶å‘æ¶ˆè´¹æ¶ˆæ¯</a> ä¸€èµ·ç†è§£ã€‚</p>\n<h3 id=\"3-1-1-æ¶ˆè´¹æ¶ˆæ¯\"><a href=\"#3-1-1-æ¶ˆè´¹æ¶ˆæ¯\" class=\"headerlink\" title=\"3.1.1 æ¶ˆè´¹æ¶ˆæ¯\"></a>3.1.1 æ¶ˆè´¹æ¶ˆæ¯</h3><p><img src=\"images/1007/é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯.png\" alt=\"é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConsumeRequest</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">3</span>: </div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  5:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\">  6:      */</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ProcessQueue processQueue;</div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  9:      * æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 10:      */</div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MessageQueue messageQueue;</div><div class=\"line\"> <span class=\"number\">12</span>: </div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">15</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:             log.warn(<span class=\"string\">\"run, the message queue not be able to consume, because it's dropped. &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">17</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">19</span>: </div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"comment\">// è·å¾— Consumer æ¶ˆæ¯é˜Ÿåˆ—é”</span></div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"keyword\">final</span> Object objLock = messageQueueLock.fetchLockObject(<span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">22</span>:         <span class=\"keyword\">synchronized</span> (objLock) &#123;</div><div class=\"line\"> <span class=\"number\">23</span>:             <span class=\"comment\">// (å¹¿æ’­æ¨¡å¼) æˆ–è€… (é›†ç¾¤æ¨¡å¼ &amp;&amp; Brokeræ¶ˆæ¯é˜Ÿåˆ—é”æœ‰æ•ˆ)</span></div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (MessageModel.BROADCASTING.equals(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class=\"line\"> <span class=\"number\">25</span>:                 || (<span class=\"keyword\">this</span>.processQueue.isLocked() &amp;&amp; !<span class=\"keyword\">this</span>.processQueue.isLockExpired())) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTime = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">27</span>:                 <span class=\"comment\">// å¾ªç¯</span></div><div class=\"line\"> <span class=\"number\">28</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">boolean</span> continueConsume = <span class=\"keyword\">true</span>; continueConsume; ) &#123;</div><div class=\"line\"> <span class=\"number\">29</span>:                     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:                         log.warn(<span class=\"string\">\"the message queue not be able to consume, because it's dropped. &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">31</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">32</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:                     <span class=\"comment\">// æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”æœªé”å®šï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">35</span>:                     <span class=\"keyword\">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class=\"line\"> <span class=\"number\">36</span>:                         &amp;&amp; !<span class=\"keyword\">this</span>.processQueue.isLocked()) &#123;</div><div class=\"line\"> <span class=\"number\">37</span>:                         log.warn(<span class=\"string\">\"the message queue not locked, so consume later, &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">38</span>:                         ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.tryLockLaterAndReconsume(<span class=\"keyword\">this</span>.messageQueue, <span class=\"keyword\">this</span>.processQueue, <span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">39</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">40</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">41</span>:                     <span class=\"comment\">// æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”å·²ç»è¿‡æœŸï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"keyword\">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class=\"line\"> <span class=\"number\">43</span>:                         &amp;&amp; <span class=\"keyword\">this</span>.processQueue.isLockExpired()) &#123;</div><div class=\"line\"> <span class=\"number\">44</span>:                         log.warn(<span class=\"string\">\"the message queue lock expired, so consume later, &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">45</span>:                         ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.tryLockLaterAndReconsume(<span class=\"keyword\">this</span>.messageQueue, <span class=\"keyword\">this</span>.processQueue, <span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">46</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">47</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">48</span>: </div><div class=\"line\"> <span class=\"number\">49</span>:                     <span class=\"comment\">// å½“å‰å‘¨æœŸæ¶ˆè´¹æ—¶é—´è¶…è¿‡è¿ç»­æ—¶é•¿ï¼Œé»˜è®¤ï¼š60sï¼Œæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¶ˆè´¹1åˆ†é’Ÿä¼‘æ¯10msã€‚</span></div><div class=\"line\"> <span class=\"number\">50</span>:                     <span class=\"keyword\">long</span> interval = System.currentTimeMillis() - beginTime;</div><div class=\"line\"> <span class=\"number\">51</span>:                     <span class=\"keyword\">if</span> (interval &gt; MAX_TIME_CONSUME_CONTINUOUSLY) &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:                         ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.submitConsumeRequestLater(processQueue, messageQueue, <span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">53</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">54</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">55</span>: </div><div class=\"line\"> <span class=\"number\">56</span>:                     <span class=\"comment\">// è·å–æ¶ˆè´¹æ¶ˆæ¯ã€‚æ­¤å¤„å’Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚ä¸åŒï¼Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚å·²ç»å¸¦äº†æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</span></div><div class=\"line\"> <span class=\"number\">57</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> consumeBatchSize = ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class=\"line\"> <span class=\"number\">58</span>:                     List&lt;MessageExt&gt; msgs = <span class=\"keyword\">this</span>.processQueue.takeMessags(consumeBatchSize);</div><div class=\"line\"> <span class=\"number\">59</span>:                     <span class=\"keyword\">if</span> (!msgs.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:                         <span class=\"keyword\">final</span> ConsumeOrderlyContext context = <span class=\"keyword\">new</span> ConsumeOrderlyContext(<span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">61</span>: </div><div class=\"line\"> <span class=\"number\">62</span>:                         ConsumeOrderlyStatus status = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">63</span>: </div><div class=\"line\"> <span class=\"number\">64</span>:                         <span class=\"comment\">// ....çœç•¥ä»£ç ï¼šHookï¼šbefore</span></div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:                         <span class=\"comment\">// æ‰§è¡Œæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">67</span>:                         <span class=\"keyword\">long</span> beginTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">68</span>:                         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;</div><div class=\"line\"> <span class=\"number\">69</span>:                         <span class=\"keyword\">boolean</span> hasException = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">70</span>:                         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">71</span>:                             <span class=\"keyword\">this</span>.processQueue.getLockConsume().lock(); <span class=\"comment\">// é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”</span></div><div class=\"line\"> <span class=\"number\">72</span>: </div><div class=\"line\"> <span class=\"number\">73</span>:                             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:                                 log.warn(<span class=\"string\">\"consumeMessage, the message queue not be able to consume, because it's dropped. &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">75</span>:                                     <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">76</span>:                                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">77</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">78</span>: </div><div class=\"line\"> <span class=\"number\">79</span>:                             status = messageListener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class=\"line\"> <span class=\"number\">80</span>:                         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">81</span>:                             log.warn(<span class=\"string\">\"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">82</span>:                                 RemotingHelper.exceptionSimpleDesc(e), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">83</span>:                                 ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.consumerGroup, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">84</span>:                                 msgs, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">85</span>:                                 messageQueue);</div><div class=\"line\"> <span class=\"number\">86</span>:                             hasException = <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">87</span>:                         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">88</span>:                             <span class=\"keyword\">this</span>.processQueue.getLockConsume().unlock(); <span class=\"comment\">// é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”</span></div><div class=\"line\"> <span class=\"number\">89</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">90</span>: </div><div class=\"line\"> <span class=\"number\">91</span>:                         <span class=\"comment\">// ....çœç•¥ä»£ç ï¼šè§£ææ¶ˆè´¹ç»“æœçŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:                         <span class=\"comment\">// ....çœç•¥ä»£ç ï¼šHookï¼šafter</span></div><div class=\"line\"> <span class=\"number\">94</span>: </div><div class=\"line\"> <span class=\"number\">95</span>:                         ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.getConsumerStatsManager()</div><div class=\"line\"> <span class=\"number\">96</span>:                             .incConsumeRT(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class=\"line\"> <span class=\"number\">97</span>: </div><div class=\"line\"> <span class=\"number\">98</span>:                         <span class=\"comment\">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></div><div class=\"line\"> <span class=\"number\">99</span>:                         continueConsume = ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.processConsumeResult(msgs, status, context, <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">100</span>:                     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">101</span>:                         continueConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">102</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">103</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">104</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">105</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"><span class=\"number\">106</span>:                     log.warn(<span class=\"string\">\"the message queue not be able to consume, because it's dropped. &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"><span class=\"number\">107</span>:                     <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">108</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>:                 ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.tryLockLaterAndReconsume(<span class=\"keyword\">this</span>.messageQueue, <span class=\"keyword\">this</span>.processQueue, <span class=\"number\">100</span>);</div><div class=\"line\"><span class=\"number\">111</span>:             &#125;</div><div class=\"line\"><span class=\"number\">112</span>:         &#125;</div><div class=\"line\"><span class=\"number\">113</span>:     &#125;</div><div class=\"line\"><span class=\"number\">114</span>: </div><div class=\"line\"><span class=\"number\">115</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>\n<li>ç¬¬ 20 è¡Œ ï¼šè·å¾— <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚</li>\n<li>ç¬¬ 58 è¡Œ ï¼šä»æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é¡ºåºè·å¾—æ¶ˆæ¯ã€‚<strong>å’Œå¹¶å‘æ¶ˆè´¹è·å¾—æ¶ˆæ¯ä¸åŒã€‚å¹¶å‘æ¶ˆè´¹è¯·æ±‚åœ¨è¯·æ±‚åˆ›å»ºæ—¶ï¼Œå·²ç»è®¾ç½®å¥½æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</strong></li>\n<li>ç¬¬ 71 è¡Œ ï¼šè·å¾— <code>Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ã€‚ç›¸æ¯”ã€<code>Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”ã€‘ï¼Œå…¶ç²’åº¦è¾ƒå°ã€‚è¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„â“<strong>ä¸ºä»€ä¹ˆæœ‰<code>Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ Consumer æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>çš„åŸå› ã€‚</li>\n<li>ç¬¬ 79 è¡Œ ï¼š<strong>æ‰§è¡Œæ¶ˆè´¹</strong>ã€‚</li>\n<li>ç¬¬ 99 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>\n</ul>\n<h3 id=\"3-1-2-å¤„ç†æ¶ˆè´¹ç»“æœ\"><a href=\"#3-1-2-å¤„ç†æ¶ˆè´¹ç»“æœ\" class=\"headerlink\" title=\"3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ\"></a>3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</h3><p>é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ç»“æœ (<code>ConsumeOrderlyStatus</code>) æœ‰å››ç§æƒ…å†µï¼š</p>\n<ul>\n<li><code>SUCCESS</code> ï¼šæ¶ˆè´¹æˆåŠŸ<strong>ä½†ä¸æäº¤</strong>ã€‚</li>\n<li><code>ROLLBACK</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆè´¹å›æ»šã€‚</li>\n<li><code>COMMIT</code> ï¼šæ¶ˆè´¹æˆåŠŸæäº¤å¹¶ä¸”æäº¤ã€‚</li>\n<li><code>SUSPEND_CURRENT_QUEUE_A_MOMENT</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼ŒæŒ‚èµ·æ¶ˆè´¹é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚</li>\n</ul>\n<p>è€ƒè™‘åˆ° <code>ROLLBACK</code> ã€<code>COMMIT</code> æš‚æ—¶åªä½¿ç”¨åœ¨ <code>MySQL binlog</code> åœºæ™¯ï¼Œå®˜æ–¹å°†è¿™ä¸¤çŠ¶æ€æ ‡è®°ä¸º <code>@Deprecated</code>ã€‚å½“ç„¶ï¼Œç›¸åº”çš„å®ç°é€»è¾‘ä¾ç„¶ä¿ç•™ã€‚</p>\n<p>åœ¨<strong>å¹¶å‘æ¶ˆè´¹</strong>åœºæ™¯æ—¶ï¼Œå¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œ<code>Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯å‘å›åˆ° <code>Broker</code> é‡è¯•é˜Ÿåˆ—ï¼Œè·³è¿‡å½“å‰æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹æ¬¡æ‹‰å–è¯¥æ¶ˆæ¯å†è¿›è¡Œæ¶ˆè´¹ã€‚</p>\n<p>ä½†æ˜¯åœ¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</strong>æ¶ˆè´¹æ—¶ï¼Œè¿™æ ·åšæ˜¾ç„¶ä¸è¡Œã€‚ä¹Ÿå› æ­¤ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¼šæŒ‚èµ·é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚ </p>\n<p>ä¸è¿‡æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ä¸€ç›´å¤±è´¥ï¼Œä¹Ÿä¸å¯èƒ½ä¸€ç›´æ¶ˆè´¹ã€‚å½“è¶…è¿‡æ¶ˆè´¹é‡è¯•ä¸Šé™æ—¶ï¼Œ<code>Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥è¶…è¿‡ä¸Šé™çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code> æ­»ä¿¡é˜Ÿåˆ—ã€‚</p>\n<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * å¤„ç†æ¶ˆè´¹ç»“æœï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­æ¶ˆè´¹</div><div class=\"line\">  4:  *</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> status æ¶ˆè´¹ç»“æœçŠ¶æ€</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> context æ¶ˆè´¹Context</div><div class=\"line\">  8:  * <span class=\"doctag\">@param</span> consumeRequest æ¶ˆè´¹è¯·æ±‚</div><div class=\"line\">  9:  * <span class=\"doctag\">@return</span> æ˜¯å¦ç»§ç»­æ¶ˆè´¹</div><div class=\"line\"> 10:  */</div><div class=\"line\"> <span class=\"number\">11</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">processConsumeResult</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs, //</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">final</span> ConsumeOrderlyStatus status, //</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"keyword\">final</span> ConsumeOrderlyContext context, //</div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">final</span> ConsumeRequest consumeRequest//</div><div class=\"line\"> <span class=\"number\">16</span>: ) &#123;</div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"keyword\">boolean</span> continueConsume = <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:     <span class=\"keyword\">long</span> commitOffset = -<span class=\"number\">1L</span>;</div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"keyword\">if</span> (context.isAutoCommit()) &#123;</div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"keyword\">switch</span> (status) &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"keyword\">case</span> COMMIT:</div><div class=\"line\"> <span class=\"number\">22</span>:             <span class=\"keyword\">case</span> ROLLBACK:</div><div class=\"line\"> <span class=\"number\">23</span>:                 log.warn(<span class=\"string\">\"the message queue consume result is illegal, we think you want to ack these message &#123;&#125;\"</span>, consumeRequest.getMessageQueue());</div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"keyword\">case</span> SUCCESS:</div><div class=\"line\"> <span class=\"number\">25</span>:                 <span class=\"comment\">// æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">26</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class=\"line\"> <span class=\"number\">27</span>:                 <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"> <span class=\"number\">28</span>:                 <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class=\"line\"> <span class=\"number\">29</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">30</span>:             <span class=\"keyword\">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT:</div><div class=\"line\"> <span class=\"number\">31</span>:                 <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"> <span class=\"number\">32</span>:                 <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class=\"line\"> <span class=\"number\">33</span>:                 <span class=\"keyword\">if</span> (checkReconsumeTimes(msgs)) &#123; <span class=\"comment\">// è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms</span></div><div class=\"line\"> <span class=\"number\">34</span>:                     <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">35</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class=\"line\"> <span class=\"number\">36</span>:                     <span class=\"comment\">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">37</span>:                     <span class=\"keyword\">this</span>.submitConsumeRequestLater(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">38</span>:                         consumeRequest.getProcessQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">39</span>:                         consumeRequest.getMessageQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">40</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class=\"line\"> <span class=\"number\">41</span>:                     continueConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">42</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">43</span>:                     commitOffset = consumeRequest.getProcessQueue().commit();</div><div class=\"line\"> <span class=\"number\">44</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">45</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">46</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">47</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">48</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">49</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">50</span>:         <span class=\"keyword\">switch</span> (status) &#123;</div><div class=\"line\"> <span class=\"number\">51</span>:             <span class=\"keyword\">case</span> SUCCESS:</div><div class=\"line\"> <span class=\"number\">52</span>:                 <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class=\"line\"> <span class=\"number\">53</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">54</span>:             <span class=\"keyword\">case</span> COMMIT:</div><div class=\"line\"> <span class=\"number\">55</span>:                 <span class=\"comment\">// æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">56</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class=\"line\"> <span class=\"number\">57</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">58</span>:             <span class=\"keyword\">case</span> ROLLBACK:</div><div class=\"line\"> <span class=\"number\">59</span>:                 <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">60</span>:                 consumeRequest.getProcessQueue().rollback();</div><div class=\"line\"> <span class=\"number\">61</span>:                 <span class=\"keyword\">this</span>.submitConsumeRequestLater(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">62</span>:                     consumeRequest.getProcessQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">63</span>:                     consumeRequest.getMessageQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">64</span>:                     context.getSuspendCurrentQueueTimeMillis());</div><div class=\"line\"> <span class=\"number\">65</span>:                 continueConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">66</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">67</span>:             <span class=\"keyword\">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT: <span class=\"comment\">// è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms</span></div><div class=\"line\"> <span class=\"number\">68</span>:                 <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class=\"line\"> <span class=\"number\">69</span>:                 <span class=\"keyword\">if</span> (checkReconsumeTimes(msgs)) &#123;</div><div class=\"line\"> <span class=\"number\">70</span>:                     <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">71</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class=\"line\"> <span class=\"number\">72</span>:                     <span class=\"comment\">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">73</span>:                     <span class=\"keyword\">this</span>.submitConsumeRequestLater(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">74</span>:                         consumeRequest.getProcessQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">75</span>:                         consumeRequest.getMessageQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">76</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class=\"line\"> <span class=\"number\">77</span>:                     continueConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">78</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">79</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">80</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">81</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">82</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">83</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">84</span>: </div><div class=\"line\"> <span class=\"number\">85</span>:     <span class=\"comment\">// æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœªdroppedï¼Œæäº¤æœ‰æ•ˆæ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">86</span>:     <span class=\"keyword\">if</span> (commitOffset &gt;= <span class=\"number\">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), commitOffset, <span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">88</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">89</span>: </div><div class=\"line\"> <span class=\"number\">90</span>:     <span class=\"keyword\">return</span> continueConsume;</div><div class=\"line\"> <span class=\"number\">91</span>: &#125;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">getMaxReconsumeTimes</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">94</span>:     <span class=\"comment\">// default reconsume times: Integer.MAX_VALUE</span></div><div class=\"line\"> <span class=\"number\">95</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes() == -<span class=\"number\">1</span>) &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:         <span class=\"keyword\">return</span> Integer.MAX_VALUE;</div><div class=\"line\"> <span class=\"number\">97</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes();</div><div class=\"line\"> <span class=\"number\">99</span>:     &#125;</div><div class=\"line\"><span class=\"number\">100</span>: &#125;</div><div class=\"line\"><span class=\"number\">101</span>: </div><div class=\"line\"><span class=\"number\">102</span>: <span class=\"comment\">/**</span></div><div class=\"line\">103:  * è®¡ç®—æ˜¯å¦è¦æš‚åœæ¶ˆè´¹</div><div class=\"line\">104:  * ä¸æš‚åœæ¡ä»¶ï¼šå­˜åœ¨æ¶ˆæ¯éƒ½è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°å¹¶ä¸”éƒ½å‘å›brokeræˆåŠŸ</div><div class=\"line\">105:  *</div><div class=\"line\">106:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\">107:  * <span class=\"doctag\">@return</span> æ˜¯å¦è¦æš‚åœ</div><div class=\"line\">108:  */</div><div class=\"line\"><span class=\"number\">109</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">checkReconsumeTimes</span><span class=\"params\">(List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">110</span>:     <span class=\"keyword\">boolean</span> suspend = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">111</span>:     <span class=\"keyword\">if</span> (msgs != <span class=\"keyword\">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">112</span>:         <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"><span class=\"number\">113</span>:             <span class=\"keyword\">if</span> (msg.getReconsumeTimes() &gt;= getMaxReconsumeTimes()) &#123;</div><div class=\"line\"><span class=\"number\">114</span>:                 MessageAccessor.setReconsumeTime(msg, String.valueOf(msg.getReconsumeTimes()));</div><div class=\"line\"><span class=\"number\">115</span>:                 <span class=\"keyword\">if</span> (!sendMessageBack(msg)) &#123; <span class=\"comment\">// å‘å›å¤±è´¥ï¼Œä¸­æ–­</span></div><div class=\"line\"><span class=\"number\">116</span>:                     suspend = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">117</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">118</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">119</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">120</span>:                 suspend = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">121</span>:                 msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">122</span>:             &#125;</div><div class=\"line\"><span class=\"number\">123</span>:         &#125;</div><div class=\"line\"><span class=\"number\">124</span>:     &#125;</div><div class=\"line\"><span class=\"number\">125</span>:     <span class=\"keyword\">return</span> suspend;</div><div class=\"line\"><span class=\"number\">126</span>: &#125;</div><div class=\"line\"><span class=\"number\">127</span>: </div><div class=\"line\"><span class=\"number\">128</span>: <span class=\"comment\">/**</span></div><div class=\"line\">129:  * å‘å›æ¶ˆæ¯ã€‚</div><div class=\"line\">130:  * æ¶ˆæ¯å‘å›brokeråï¼Œå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ­»ä¿¡é˜Ÿåˆ—ã€‚</div><div class=\"line\">131:  *</div><div class=\"line\">132:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\">133:  * <span class=\"doctag\">@return</span> æ˜¯å¦å‘é€æˆåŠŸ</div><div class=\"line\">134:  */</div><div class=\"line\"><span class=\"number\">135</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">sendMessageBack</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExt msg)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">136</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">137</span>:         <span class=\"comment\">// max reconsume times exceeded then send to dead letter queue.</span></div><div class=\"line\"><span class=\"number\">138</span>:         Message newMsg = <span class=\"keyword\">new</span> Message(MixAll.getRetryTopic(<span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class=\"line\"><span class=\"number\">139</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class=\"line\"><span class=\"number\">140</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class=\"line\"><span class=\"number\">141</span>:         newMsg.setFlag(msg.getFlag());</div><div class=\"line\"><span class=\"number\">142</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class=\"line\"><span class=\"number\">143</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class=\"line\"><span class=\"number\">144</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes()));</div><div class=\"line\"><span class=\"number\">145</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class=\"line\"><span class=\"number\">146</span>:         newMsg.setDelayTimeLevel(<span class=\"number\">3</span> + msg.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">147</span>: </div><div class=\"line\"><span class=\"number\">148</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumer.getDefaultMQPushConsumerImpl().getmQClientFactory().getDefaultMQProducer().send(newMsg);</div><div class=\"line\"><span class=\"number\">149</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">150</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">151</span>:         log.error(<span class=\"string\">\"sendMessageBack exception, group: \"</span> + <span class=\"keyword\">this</span>.consumerGroup + <span class=\"string\">\" msg: \"</span> + msg.toString(), e);</div><div class=\"line\"><span class=\"number\">152</span>:     &#125;</div><div class=\"line\"><span class=\"number\">153</span>: </div><div class=\"line\"><span class=\"number\">154</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">155</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>\n<li>ç¬¬ 21 è‡³ 29 è¡Œ ï¼šæ¶ˆè´¹æˆåŠŸã€‚åœ¨è‡ªåŠ¨æäº¤è¿›åº¦( <code>AutoCommit</code> )çš„æƒ…å†µä¸‹ï¼Œ<code>COMMIT</code>ã€<code>ROLLBACK</code>ã€<code>SUCCESS</code> é€»è¾‘<strong>å·²ç»ç»Ÿä¸€</strong>ã€‚</li>\n<li>ç¬¬ 30 è‡³ 45 è¡Œ ï¼šæ¶ˆè´¹å¤±è´¥ã€‚å½“æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™ï¼ˆé»˜è®¤ ï¼š16æ¬¡ï¼‰æ—¶ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° <code>Broker</code> æ­»ä¿¡é˜Ÿåˆ—ï¼Œè·³è¿‡è¿™äº›æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­æ¶ˆè´¹åé¢çš„æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 85 è‡³ 88 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¿›åº¦ã€‚</li>\n</ul>\n<h3 id=\"3-13-æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•\"><a href=\"#3-13-æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•\" class=\"headerlink\" title=\"3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•\"></a>3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</h3><p>ğŸ˜ˆæ¶‰åŠåˆ°çš„å››ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æºç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ProcessQueue.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * æ¶ˆæ¯æ˜ å°„</div><div class=\"line\">  4:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">  5:  */</div><div class=\"line\">  <span class=\"number\">6</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class=\"keyword\">new</span> TreeMap&lt;&gt;();    <span class=\"comment\">/**</span></div><div class=\"line\">  7:  * æ¶ˆæ¯æ˜ å°„ä¸´æ—¶å­˜å‚¨ï¼ˆæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯ï¼‰</div><div class=\"line\">  8:  */</div><div class=\"line\">  <span class=\"number\">9</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMapTemp = <span class=\"keyword\">new</span> TreeMap&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">10</span>: </div><div class=\"line\"> <span class=\"number\">11</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 12:  * å›æ»šæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯</div><div class=\"line\"> 13:  * é€»è¾‘ç±»ä¼¼äº&#123;<span class=\"doctag\">@link</span> #makeMessageToCosumeAgain(List)&#125;</div><div class=\"line\"> 14:  */</div><div class=\"line\"> <span class=\"number\">15</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"keyword\">this</span>.msgTreeMap.putAll(<span class=\"keyword\">this</span>.msgTreeMapTemp);</div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"keyword\">this</span>.msgTreeMapTemp.clear();</div><div class=\"line\"> <span class=\"number\">21</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"> <span class=\"number\">23</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">24</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:         log.error(<span class=\"string\">\"rollback exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">26</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">27</span>: &#125;</div><div class=\"line\"> <span class=\"number\">28</span>: </div><div class=\"line\"> <span class=\"number\">29</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 30:  * æäº¤æ¶ˆè´¹ä¸­çš„æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸï¼Œè¿”å›æ¶ˆè´¹è¿›åº¦</div><div class=\"line\"> 31:  *</div><div class=\"line\"> 32:  * <span class=\"doctag\">@return</span> æ¶ˆè´¹è¿›åº¦</div><div class=\"line\"> 33:  */</div><div class=\"line\"> <span class=\"number\">34</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">commit</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">35</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">36</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"> <span class=\"number\">37</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:             <span class=\"comment\">// æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">39</span>:             Long offset = <span class=\"keyword\">this</span>.msgTreeMapTemp.lastKey();</div><div class=\"line\"> <span class=\"number\">40</span>: </div><div class=\"line\"> <span class=\"number\">41</span>:             <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">42</span>:             msgCount.addAndGet(<span class=\"keyword\">this</span>.msgTreeMapTemp.size() * (-<span class=\"number\">1</span>));</div><div class=\"line\"> <span class=\"number\">43</span>: </div><div class=\"line\"> <span class=\"number\">44</span>:             <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">45</span>:             <span class=\"keyword\">this</span>.msgTreeMapTemp.clear();</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:             <span class=\"comment\">// è¿”å›æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">48</span>:             <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">49</span>:                 <span class=\"keyword\">return</span> offset + <span class=\"number\">1</span>;</div><div class=\"line\"> <span class=\"number\">50</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">51</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"> <span class=\"number\">53</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">54</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">55</span>:         log.error(<span class=\"string\">\"commit exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">56</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"> <span class=\"number\">59</span>: &#125;</div><div class=\"line\"> <span class=\"number\">60</span>: </div><div class=\"line\"> <span class=\"number\">61</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 62:  * æŒ‡å®šæ¶ˆæ¯é‡æ–°æ¶ˆè´¹</div><div class=\"line\"> 63:  * é€»è¾‘ç±»ä¼¼äº&#123;<span class=\"doctag\">@link</span> #rollback()&#125;</div><div class=\"line\"> 64:  *</div><div class=\"line\"> 65:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\"> 66:  */</div><div class=\"line\"> <span class=\"number\">67</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">makeMessageToCosumeAgain</span><span class=\"params\">(List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">68</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">69</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"> <span class=\"number\">70</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">71</span>:             <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"> <span class=\"number\">72</span>:                 <span class=\"keyword\">this</span>.msgTreeMapTemp.remove(msg.getQueueOffset());</div><div class=\"line\"> <span class=\"number\">73</span>:                 <span class=\"keyword\">this</span>.msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class=\"line\"> <span class=\"number\">74</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">75</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"> <span class=\"number\">77</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">78</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">79</span>:         log.error(<span class=\"string\">\"makeMessageToCosumeAgain exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">80</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">81</span>: &#125;</div><div class=\"line\"> <span class=\"number\">82</span>: </div><div class=\"line\"> <span class=\"number\">83</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 84:  * è·å¾—æŒæœ‰æ¶ˆæ¯å‰Næ¡</div><div class=\"line\"> 85:  *</div><div class=\"line\"> 86:  * <span class=\"doctag\">@param</span> batchSize æ¡æ•°</div><div class=\"line\"> 87:  * <span class=\"doctag\">@return</span> æ¶ˆæ¯</div><div class=\"line\"> 88:  */</div><div class=\"line\"> <span class=\"number\">89</span>: <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageExt&gt; <span class=\"title\">takeMessags</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> batchSize)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">90</span>:     List&lt;MessageExt&gt; result = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(batchSize);</div><div class=\"line\"> <span class=\"number\">91</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">92</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">93</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"> <span class=\"number\">94</span>:         <span class=\"keyword\">this</span>.lastConsumeTimestamp = now;</div><div class=\"line\"> <span class=\"number\">95</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:             <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.msgTreeMap.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">97</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; batchSize; i++) &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:                     Map.Entry&lt;Long, MessageExt&gt; entry = <span class=\"keyword\">this</span>.msgTreeMap.pollFirstEntry();</div><div class=\"line\"> <span class=\"number\">99</span>:                     <span class=\"keyword\">if</span> (entry != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">100</span>:                         result.add(entry.getValue());</div><div class=\"line\"><span class=\"number\">101</span>:                         msgTreeMapTemp.put(entry.getKey(), entry.getValue());</div><div class=\"line\"><span class=\"number\">102</span>:                     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">103</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">104</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">105</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">106</span>:             &#125;</div><div class=\"line\"><span class=\"number\">107</span>: </div><div class=\"line\"><span class=\"number\">108</span>:             <span class=\"keyword\">if</span> (result.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">109</span>:                 consuming = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">110</span>:             &#125;</div><div class=\"line\"><span class=\"number\">111</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">112</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"><span class=\"number\">113</span>:         &#125;</div><div class=\"line\"><span class=\"number\">114</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">115</span>:         log.error(<span class=\"string\">\"take Messages exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">116</span>:     &#125;</div><div class=\"line\"><span class=\"number\">117</span>: </div><div class=\"line\"><span class=\"number\">118</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">119</span>: &#125;</div></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1007-RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. Producer é¡ºåºå‘é€</a></li>\n<li><a href=\"#\">3. Consumer é¡ºåºæ¶ˆè´¹</a><ul>\n<li><a href=\"#\">3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</a></li>\n<li><a href=\"#\">3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</a></li>\n<li><a href=\"#\">3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</a><ul>\n<li><a href=\"#\">3.1.1 æ¶ˆè´¹æ¶ˆæ¯</a></li>\n<li><a href=\"#\">3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</a></li>\n<li><a href=\"#\">3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p><strong>å»ºè®®</strong>å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>\n<ul>\n<li><a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1003-RocketMQæºç è§£æï¼šMessageå‘é€&amp;æ¥æ”¶.md\" target=\"_blank\" rel=\"external\">ã€ŠMessageå‘é€&amp;æ¥æ”¶ã€‹</a></li>\n<li><a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md\" target=\"_blank\" rel=\"external\">ã€ŠMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹</a></li>\n</ul>\n<p>å½“ç„¶å¯¹ <code>Message</code> å‘é€ä¸æ¶ˆè´¹å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡ã€‚</p>\n<hr>\n<p><code>RocketMQ</code> æä¾›äº†ä¸¤ç§é¡ºåºçº§åˆ«ï¼š</p>\n<ul>\n<li>æ™®é€šé¡ºåºæ¶ˆæ¯ ï¼š<code>Producer</code> å°†ç›¸å…³è”çš„æ¶ˆæ¯å‘é€åˆ°ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>å®Œå…¨ä¸¥æ ¼é¡ºåº ï¼šåœ¨ <code>æ™®é€šé¡ºåºæ¶ˆæ¯</code> çš„åŸºç¡€ä¸Šï¼Œ<code>Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>\n</ul>\n<p>ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹åªéœ€è¦ç”¨åˆ°<strong>æ™®é€šé¡ºåºæ¶ˆæ¯</strong>ã€‚<br>ä¾‹å¦‚è¯´ï¼šç»™ç”¨æˆ·å‘é€çŸ­ä¿¡æ¶ˆæ¯ + å‘é€æ¨é€æ¶ˆæ¯ï¼Œå°†ä¸¤æ¡æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‹¥å…¶ä¸­ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è¾ƒæ…¢é€ æˆå µå¡ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ï¼Œå¸¦æ¥çš„ä½“éªŒä¼šç›¸å¯¹è¾ƒå·®ã€‚å½“ç„¶ç±»ä¼¼è¿™ç§åœºæ™¯ï¼Œå³ä½¿æœ‰ä¸€å®šçš„æ—¶é—´å·®ï¼Œ<strong>ä¸ä¼šäº§ç”Ÿç³»ç»Ÿé€»è¾‘ä¸ŠBUG</strong>ã€‚å¦å¤–ï¼Œ<code>æ™®é€šé¡ºåºæ¶ˆæ¯</code>æ€§èƒ½èƒ½æ›´åŠ å¥½ã€‚<br>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä½¿ç”¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåº</strong>ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼š</p>\n<blockquote>\n<p>ç›®å‰å·²çŸ¥çš„åº”ç”¨åªæœ‰æ•°æ®åº“ <code>binlog</code> åŒæ­¥å¼ºä¾èµ–ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼Œå…¶ä»–åº”ç”¨ç»å¤§éƒ¨åˆ†éƒ½å¯ä»¥å®¹å¿çŸ­æš‚ä¹±åºï¼Œæ¨èä½¿ç”¨æ™®é€šçš„é¡ºåºæ¶ˆæ¯</p>\n</blockquote>\n<hr>\n<p>ğŸ˜ˆä¸Šä»£ç ï¼ï¼ï¼</p>\n<h1 id=\"2-Producer-é¡ºåºå‘é€\"><a href=\"#2-Producer-é¡ºåºå‘é€\" class=\"headerlink\" title=\"2. Producer é¡ºåºå‘é€\"></a>2. <code>Producer</code> é¡ºåºå‘é€</h1><p>å®˜æ–¹å‘é€é¡ºåºæ¶ˆæ¯çš„<strong>ä¾‹å­</strong>ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">package</span> org.apache.rocketmq.example.ordermessage;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"keyword\">import</span> java.io.UnsupportedEncodingException;</div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"keyword\">import</span> java.util.List;</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.exception.MQBrokerException;</div><div class=\"line\"> <span class=\"number\">6</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.exception.MQClientException;</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.producer.MQProducer;</div><div class=\"line\"> <span class=\"number\">9</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.producer.MessageQueueSelector;</div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.client.producer.SendResult;</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.common.message.Message;</div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.common.message.MessageQueue;</div><div class=\"line\"><span class=\"number\">13</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</div><div class=\"line\"><span class=\"number\">14</span>: <span class=\"keyword\">import</span> org.apache.rocketmq.remoting.exception.RemotingException;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> UnsupportedEncodingException </span>&#123;</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             MQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(<span class=\"string\">\"please_rename_unique_group_name\"</span>);</div><div class=\"line\"><span class=\"number\">20</span>:             producer.start();</div><div class=\"line\"><span class=\"number\">21</span>: </div><div class=\"line\"><span class=\"number\">22</span>:             String[] tags = <span class=\"keyword\">new</span> String[] &#123;<span class=\"string\">\"TagA\"</span>, <span class=\"string\">\"TagB\"</span>, <span class=\"string\">\"TagC\"</span>, <span class=\"string\">\"TagD\"</span>, <span class=\"string\">\"TagE\"</span>&#125;;</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">100</span>; i++) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                 <span class=\"keyword\">int</span> orderId = i % <span class=\"number\">10</span>;</div><div class=\"line\"><span class=\"number\">25</span>:                 Message msg =</div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"keyword\">new</span> Message(<span class=\"string\">\"TopicTestjjj\"</span>, tags[i % tags.length], <span class=\"string\">\"KEY\"</span> + i,</div><div class=\"line\"><span class=\"number\">27</span>:                         (<span class=\"string\">\"Hello RocketMQ \"</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</div><div class=\"line\"><span class=\"number\">28</span>:                 SendResult sendResult = producer.send(msg, <span class=\"keyword\">new</span> MessageQueueSelector() &#123;</div><div class=\"line\"><span class=\"number\">29</span>:                     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"function\"><span class=\"keyword\">public</span> MessageQueue <span class=\"title\">select</span><span class=\"params\">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">31</span>:                         Integer id = (Integer) arg;</div><div class=\"line\"><span class=\"number\">32</span>:                         <span class=\"keyword\">int</span> index = id % mqs.size();</div><div class=\"line\"><span class=\"number\">33</span>:                         <span class=\"keyword\">return</span> mqs.get(index);</div><div class=\"line\"><span class=\"number\">34</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">35</span>:                 &#125;, orderId);</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:                 System.out.printf(<span class=\"string\">\"%s%n\"</span>, sendResult);</div><div class=\"line\"><span class=\"number\">38</span>:             &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:             producer.shutdown();</div><div class=\"line\"><span class=\"number\">41</span>:         &#125; <span class=\"keyword\">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             e.printStackTrace();</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>:     &#125;</div><div class=\"line\"><span class=\"number\">45</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ 28 è‡³ 35 è¡Œ ï¼šå®ç°äº†æ ¹æ® <code>id % mqs.size()</code> æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©ã€‚å½“å‰ä¾‹å­ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’ <code>orderId</code> ä½œä¸ºå‚æ•°ï¼Œé‚£ä¹ˆç›¸åŒçš„ <code>orderId</code> èƒ½å¤Ÿè¿›å…¥ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚</li>\n</ul>\n<hr>\n<p><code>MessageQueueSelector</code> æ¥å£çš„<strong>æºç </strong>ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">MessageQueueSelector</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 5:      *</div><div class=\"line\"> 6:      * <span class=\"doctag\">@param</span> mqs æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 7:      * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\"> 8:      * <span class=\"doctag\">@param</span> arg å‚æ•°</div><div class=\"line\"> 9:      * <span class=\"doctag\">@return</span> æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">10:      */</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"function\">MessageQueue <span class=\"title\">select</span><span class=\"params\">(<span class=\"keyword\">final</span> List&lt;MessageQueue&gt; mqs, <span class=\"keyword\">final</span> Message msg, <span class=\"keyword\">final</span> Object arg)</span></span>;</div><div class=\"line\"><span class=\"number\">12</span>: &#125;</div></pre></td></tr></table></figure>\n<hr>\n<p><code>Producer</code> é€‰æ‹©é˜Ÿåˆ—å‘é€æ¶ˆæ¯æ–¹æ³•çš„<strong>æºç </strong>ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">16</span>: <span class=\"function\"><span class=\"keyword\">private</span> SendResult <span class=\"title\">sendSelectImpl</span><span class=\"params\">(//</span></span></div><div class=\"line\"><span class=\"number\">17</span>:     Message msg, //</div><div class=\"line\"><span class=\"number\">18</span>:     MessageQueueSelector selector, //</div><div class=\"line\"><span class=\"number\">19</span>:     Object arg, //</div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode, //</div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"keyword\">final</span> SendCallback sendCallback, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeout//</div><div class=\"line\"><span class=\"number\">22</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"keyword\">this</span>.makeSureStateOK();</div><div class=\"line\"><span class=\"number\">24</span>:     Validators.checkMessage(msg, <span class=\"keyword\">this</span>.defaultMQProducer);</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:     TopicPublishInfo topicPublishInfo = <span class=\"keyword\">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"keyword\">if</span> (topicPublishInfo != <span class=\"keyword\">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</div><div class=\"line\"><span class=\"number\">28</span>:         MessageQueue mq = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);</div><div class=\"line\"><span class=\"number\">31</span>:         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"select message queue throwed exception.\"</span>, e);</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>: </div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">if</span> (mq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">36</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, <span class=\"keyword\">null</span>, timeout);</div><div class=\"line\"><span class=\"number\">37</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">38</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"select message queue return null.\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">39</span>:         &#125;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"No route info for this topic, \"</span> + msg.getTopic(), <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">43</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ 30 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 36 è¡Œ ï¼šå‘é€æ¶ˆæ¯ã€‚</li>\n</ul>\n<h1 id=\"3-Consumer-ä¸¥æ ¼é¡ºåºæ¶ˆè´¹\"><a href=\"#3-Consumer-ä¸¥æ ¼é¡ºåºæ¶ˆè´¹\" class=\"headerlink\" title=\"3. Consumer ä¸¥æ ¼é¡ºåºæ¶ˆè´¹\"></a>3. <code>Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</h1><p><code>Consumer</code> åœ¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹æ—¶ï¼Œé€šè¿‡ <strong>ä¸‰</strong> æŠŠé”ä¿è¯ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</p>\n<ul>\n<li><code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>åˆ†å¸ƒå¼é”</strong>ï¼‰ ï¼š<ul>\n<li>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> ä» <code>Broker</code> è·å¾—è¯¥é”åï¼Œæ‰èƒ½è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€æ¶ˆè´¹ã€‚</li>\n<li>å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> æ— éœ€è¯¥é”ã€‚</li>\n</ul>\n</li>\n<li><code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code>Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ“ä½œæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li><code>Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code>Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n<p><strong>å¯èƒ½åŒå­¦æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæœ‰ <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>ï¼ŸğŸ˜ˆè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>\n<hr>\n<h2 id=\"3-1-è·å¾—-é”å®š-æ¶ˆæ¯é˜Ÿåˆ—\"><a href=\"#3-1-è·å¾—-é”å®š-æ¶ˆæ¯é˜Ÿåˆ—\" class=\"headerlink\" title=\"3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—\"></a>3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</h2><p><strong>é›†ç¾¤æ¨¡å¼</strong>ä¸‹ï¼Œ<code>Consumer</code> æ›´æ–°å±äºè‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code>Broker</code> é”å®šè¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ<em>å¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦</em>ï¼‰ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œåˆ™æ›´æ–°å¤±è´¥ï¼Œå³è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸å±äºè‡ªå·±ï¼Œä¸èƒ½è¿›è¡Œæ¶ˆè´¹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">updateProcessQueueTableInRebalance</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> Set&lt;MessageQueue&gt; mqSet, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrder)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>: <span class=\"comment\">// ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"comment\">// å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class=\"line\"> <span class=\"number\">5</span>:     List&lt;PullRequest&gt; pullRequestList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(); <span class=\"comment\">// æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">for</span> (MessageQueue mq : mqSet) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"keyword\">if</span> (isOrder &amp;&amp; !<span class=\"keyword\">this</span>.lock(mq)) &#123; <span class=\"comment\">// é¡ºåºæ¶ˆæ¯é”å®šæ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">9</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">10</span>:                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">11</span>:             &#125;</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">this</span>.removeDirtyOffset(mq);</div><div class=\"line\"><span class=\"number\">14</span>:             ProcessQueue pq = <span class=\"keyword\">new</span> ProcessQueue();</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">long</span> nextOffset = <span class=\"keyword\">this</span>.computePullFromWhere(mq);</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">if</span> (nextOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                 ProcessQueue pre = <span class=\"keyword\">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"keyword\">if</span> (pre != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">20</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">22</span>:                     PullRequest pullRequest = <span class=\"keyword\">new</span> PullRequest();</div><div class=\"line\"><span class=\"number\">23</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class=\"line\"><span class=\"number\">24</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class=\"line\"><span class=\"number\">25</span>:                     pullRequest.setMessageQueue(mq);</div><div class=\"line\"><span class=\"number\">26</span>:                     pullRequest.setProcessQueue(pq);</div><div class=\"line\"><span class=\"number\">27</span>:                     pullRequestList.add(pullRequest);</div><div class=\"line\"><span class=\"number\">28</span>:                     changed = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">30</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">32</span>:             &#125;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:     &#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>: <span class=\"comment\">// ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class=\"line\"><span class=\"number\">37</span>: &#125;</div><div class=\"line\"><span class=\"number\">38</span>: </div><div class=\"line\"><span class=\"number\">39</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘</span></div><div class=\"line\"><span class=\"number\">40</span>: <span class=\"comment\">/**</span></div><div class=\"line\">41:  * è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”</div><div class=\"line\">42:  *</div><div class=\"line\">43:  * <span class=\"doctag\">@param</span> mq é˜Ÿåˆ—</div><div class=\"line\">44:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\">45:  */</div><div class=\"line\"><span class=\"number\">46</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">lock</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">47</span>:     FindBrokerResult findBrokerResult = <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(), MixAll.MASTER_ID, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">48</span>:     <span class=\"keyword\">if</span> (findBrokerResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">49</span>:         LockBatchRequestBody requestBody = <span class=\"keyword\">new</span> LockBatchRequestBody();</div><div class=\"line\"><span class=\"number\">50</span>:         requestBody.setConsumerGroup(<span class=\"keyword\">this</span>.consumerGroup);</div><div class=\"line\"><span class=\"number\">51</span>:         requestBody.setClientId(<span class=\"keyword\">this</span>.mQClientFactory.getClientId());</div><div class=\"line\"><span class=\"number\">52</span>:         requestBody.getMqSet().add(mq);</div><div class=\"line\"><span class=\"number\">53</span>: </div><div class=\"line\"><span class=\"number\">54</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">55</span>:             <span class=\"comment\">// è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”</span></div><div class=\"line\"><span class=\"number\">56</span>:             Set&lt;MessageQueue&gt; lockedMq =</div><div class=\"line\"><span class=\"number\">57</span>:                 <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().lockBatchMQ(findBrokerResult.getBrokerAddr(), requestBody, <span class=\"number\">1000</span>);</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>:             <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é”å®šæˆåŠŸã€‚é”å®šæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸï¼Œå¯èƒ½æœ¬åœ°æ²¡æœ‰æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ï¼Œè®¾ç½®é”å®šæˆåŠŸä¼šåœ¨lockAll()æ–¹æ³•ã€‚</span></div><div class=\"line\"><span class=\"number\">60</span>:             <span class=\"keyword\">for</span> (MessageQueue mmqq : lockedMq) &#123;</div><div class=\"line\"><span class=\"number\">61</span>:                 ProcessQueue processQueue = <span class=\"keyword\">this</span>.processQueueTable.get(mmqq);</div><div class=\"line\"><span class=\"number\">62</span>:                 <span class=\"keyword\">if</span> (processQueue != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">63</span>:                     processQueue.setLocked(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">64</span>:                     processQueue.setLastLockTimestamp(System.currentTimeMillis());</div><div class=\"line\"><span class=\"number\">65</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">66</span>:             &#125;</div><div class=\"line\"><span class=\"number\">67</span>: </div><div class=\"line\"><span class=\"number\">68</span>:             <span class=\"keyword\">boolean</span> lockOK = lockedMq.contains(mq);</div><div class=\"line\"><span class=\"number\">69</span>:             log.info(<span class=\"string\">\"the message queue lock &#123;&#125;, &#123;&#125; &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">70</span>:                 lockOK ? <span class=\"string\">\"OK\"</span> : <span class=\"string\">\"Failed\"</span>,</div><div class=\"line\"><span class=\"number\">71</span>:                 <span class=\"keyword\">this</span>.consumerGroup,</div><div class=\"line\"><span class=\"number\">72</span>:                 mq);</div><div class=\"line\"><span class=\"number\">73</span>:             <span class=\"keyword\">return</span> lockOK;</div><div class=\"line\"><span class=\"number\">74</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">75</span>:             log.error(<span class=\"string\">\"lockBatchMQ exception, \"</span> + mq, e);</div><div class=\"line\"><span class=\"number\">76</span>:         &#125;</div><div class=\"line\"><span class=\"number\">77</span>:     &#125;</div><div class=\"line\"><span class=\"number\">78</span>: </div><div class=\"line\"><span class=\"number\">79</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">80</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>\n<li>ç¬¬ 8 è‡³ 11 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œé”å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œæ–°å¢æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å¤±è´¥ã€‚</li>\n</ul>\n<hr>\n<p><code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ä¼šè¿‡æœŸï¼Œé»˜è®¤é…ç½® 30sã€‚å› æ­¤ï¼Œ<code>Consumer</code> éœ€è¦ä¸æ–­å‘ <code>Broker</code> åˆ·æ–°è¯¥é”è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤é…ç½® 20s åˆ·æ–°ä¸€æ¬¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">6</span>:             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">7</span>:                 ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.lockMQPeriodically();</div><div class=\"line\"> <span class=\"number\">8</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">9</span>:         &#125;, <span class=\"number\">1000</span> * <span class=\"number\">1</span>, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">10</span>:     &#125;</div><div class=\"line\"><span class=\"number\">11</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"3-2-ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—\"><a href=\"#3-2-ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—\" class=\"headerlink\" title=\"3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—\"></a>3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</h2><p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code>Consumer</code> ç§»é™¤è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code>Broker</code> è§£é”è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * ç§»é™¤ä¸éœ€è¦çš„é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯</div><div class=\"line\"> 4:  * 1. æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹</div><div class=\"line\"> 5:  * 2. é¡ºåºæ¶ˆè´¹&amp;é›†ç¾¤æ¨¡å¼ï¼Œè§£é”å¯¹è¯¥é˜Ÿåˆ—çš„é”å®š</div><div class=\"line\"> 6:  *</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\"> 9:  * <span class=\"doctag\">@return</span> æ˜¯å¦ç§»é™¤æˆåŠŸ</div><div class=\"line\">10:  */</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">removeUnnecessaryMessageQueue</span><span class=\"params\">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"comment\">// åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"comment\">// é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé¡ºåºæ¶ˆè´¹ç§»é™¤æ—¶ï¼Œè§£é”å¯¹é˜Ÿåˆ—çš„é”å®š</span></div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class=\"line\"><span class=\"number\">18</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">if</span> (pq.getLockConsume().tryLock(<span class=\"number\">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.unlockDelay(mq, pq);</div><div class=\"line\"><span class=\"number\">23</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                     pq.getLockConsume().unlock();</div><div class=\"line\"><span class=\"number\">25</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">26</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">27</span>:                 log.warn(<span class=\"string\">\"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">28</span>:                     mq, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">29</span>:                     pq.getTryUnlockTimes());</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:                 pq.incTryUnlockTimes();</div><div class=\"line\"><span class=\"number\">32</span>:             &#125;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">34</span>:             log.error(<span class=\"string\">\"removeUnnecessaryMessageQueue Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">38</span>:     &#125;</div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">40</span>: &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘</span></div><div class=\"line\"><span class=\"number\">43</span>: <span class=\"comment\">/**</span></div><div class=\"line\">44:  * å»¶è¿Ÿè§£é” Broker æ¶ˆæ¯é˜Ÿåˆ—é”</div><div class=\"line\">45:  * å½“æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸å­˜åœ¨æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è§£é”</div><div class=\"line\">46:  *</div><div class=\"line\">47:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">48:  * <span class=\"doctag\">@param</span> pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\">49:  * <span class=\"doctag\">@return</span> æ˜¯å¦è§£é”æˆåŠŸ</div><div class=\"line\">50:  */</div><div class=\"line\"><span class=\"number\">51</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">unlockDelay</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq, <span class=\"keyword\">final</span> ProcessQueue pq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">52</span>:     <span class=\"keyword\">if</span> (pq.hasTempMessage()) &#123; <span class=\"comment\">// TODO ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦å»¶è¿Ÿç§»é™¤</span></div><div class=\"line\"><span class=\"number\">53</span>:         log.info(<span class=\"string\">\"[&#123;&#125;]unlockDelay, begin &#123;&#125; \"</span>, mq.hashCode(), mq);</div><div class=\"line\"><span class=\"number\">54</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getmQClientFactory().getScheduledExecutorService().schedule(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"><span class=\"number\">55</span>:             <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">56</span>:             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">57</span>:                 log.info(<span class=\"string\">\"[&#123;&#125;]unlockDelay, execute at once &#123;&#125;\"</span>, mq.hashCode(), mq);</div><div class=\"line\"><span class=\"number\">58</span>:                 RebalancePushImpl.<span class=\"keyword\">this</span>.unlock(mq, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">59</span>:             &#125;</div><div class=\"line\"><span class=\"number\">60</span>:         &#125;, UNLOCK_DELAY_TIME_MILLS, TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">61</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">this</span>.unlock(mq, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">63</span>:     &#125;</div><div class=\"line\"><span class=\"number\">64</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">65</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>\n<li>ç¬¬ 20 è‡³ 32 è¡Œ ï¼šè·å–<strong>æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”</strong>ï¼Œé¿å…å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å†²çªã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡é‡æ–°åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—æ—¶ï¼Œå†è¿›è¡Œç§»é™¤ã€‚å¦‚æœæœªè·å¾—é”è€Œè¿›è¡Œç§»é™¤ï¼Œåˆ™å¯èƒ½å‡ºç°å¦å¤–çš„  <code>Consumer</code> å’Œå½“å‰ <code>Consumer</code> åŒæ—¶æ¶ˆè´¹è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯æ— æ³•ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 51 è‡³ 64 è¡Œ ï¼šè§£é” <code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚å¦‚æœæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿè§£é” <code>Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚â“ä¸ºä»€ä¹ˆæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ä¸èƒ½ç›´æ¥è§£é”å‘¢ï¼ŸğŸ˜ˆæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç™¾æ€ä¸å¾—å…¶è§£ã€‚å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦æ•™è‚²ä¸‹ä¿ºã€‚</li>\n</ul>\n<h2 id=\"3-3-æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\"><a href=\"#3-3-æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\" class=\"headerlink\" title=\"3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\"></a>3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</h2><p>ğŸ˜æœ¬èŠ‚ä¼šç±»æ¯”<strong>å¹¶å‘æ¶ˆè´¹æ¶ˆè´¹é˜Ÿåˆ—</strong>ï¼Œå»ºè®®å¯¹ç…§ <a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md#6pushconsumer-æ¶ˆè´¹æ¶ˆæ¯\" target=\"_blank\" rel=\"external\">PushConsumerå¹¶å‘æ¶ˆè´¹æ¶ˆæ¯</a> ä¸€èµ·ç†è§£ã€‚</p>\n<h3 id=\"3-1-1-æ¶ˆè´¹æ¶ˆæ¯\"><a href=\"#3-1-1-æ¶ˆè´¹æ¶ˆæ¯\" class=\"headerlink\" title=\"3.1.1 æ¶ˆè´¹æ¶ˆæ¯\"></a>3.1.1 æ¶ˆè´¹æ¶ˆæ¯</h3><p><img src=\"images/1007/é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯.png\" alt=\"é¡ºåºæ¶ˆè´¹æ´»åŠ¨å›¾-æ¶ˆè´¹æ¶ˆæ¯\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConsumeRequest</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">3</span>: </div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  5:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\">  6:      */</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ProcessQueue processQueue;</div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  9:      * æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 10:      */</div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MessageQueue messageQueue;</div><div class=\"line\"> <span class=\"number\">12</span>: </div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">15</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:             log.warn(<span class=\"string\">\"run, the message queue not be able to consume, because it's dropped. &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">17</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">19</span>: </div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"comment\">// è·å¾— Consumer æ¶ˆæ¯é˜Ÿåˆ—é”</span></div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"keyword\">final</span> Object objLock = messageQueueLock.fetchLockObject(<span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">22</span>:         <span class=\"keyword\">synchronized</span> (objLock) &#123;</div><div class=\"line\"> <span class=\"number\">23</span>:             <span class=\"comment\">// (å¹¿æ’­æ¨¡å¼) æˆ–è€… (é›†ç¾¤æ¨¡å¼ &amp;&amp; Brokeræ¶ˆæ¯é˜Ÿåˆ—é”æœ‰æ•ˆ)</span></div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (MessageModel.BROADCASTING.equals(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class=\"line\"> <span class=\"number\">25</span>:                 || (<span class=\"keyword\">this</span>.processQueue.isLocked() &amp;&amp; !<span class=\"keyword\">this</span>.processQueue.isLockExpired())) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTime = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">27</span>:                 <span class=\"comment\">// å¾ªç¯</span></div><div class=\"line\"> <span class=\"number\">28</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">boolean</span> continueConsume = <span class=\"keyword\">true</span>; continueConsume; ) &#123;</div><div class=\"line\"> <span class=\"number\">29</span>:                     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:                         log.warn(<span class=\"string\">\"the message queue not be able to consume, because it's dropped. &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">31</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">32</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:                     <span class=\"comment\">// æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”æœªé”å®šï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">35</span>:                     <span class=\"keyword\">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class=\"line\"> <span class=\"number\">36</span>:                         &amp;&amp; !<span class=\"keyword\">this</span>.processQueue.isLocked()) &#123;</div><div class=\"line\"> <span class=\"number\">37</span>:                         log.warn(<span class=\"string\">\"the message queue not locked, so consume later, &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">38</span>:                         ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.tryLockLaterAndReconsume(<span class=\"keyword\">this</span>.messageQueue, <span class=\"keyword\">this</span>.processQueue, <span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">39</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">40</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">41</span>:                     <span class=\"comment\">// æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”å·²ç»è¿‡æœŸï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"keyword\">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class=\"line\"> <span class=\"number\">43</span>:                         &amp;&amp; <span class=\"keyword\">this</span>.processQueue.isLockExpired()) &#123;</div><div class=\"line\"> <span class=\"number\">44</span>:                         log.warn(<span class=\"string\">\"the message queue lock expired, so consume later, &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">45</span>:                         ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.tryLockLaterAndReconsume(<span class=\"keyword\">this</span>.messageQueue, <span class=\"keyword\">this</span>.processQueue, <span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">46</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">47</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">48</span>: </div><div class=\"line\"> <span class=\"number\">49</span>:                     <span class=\"comment\">// å½“å‰å‘¨æœŸæ¶ˆè´¹æ—¶é—´è¶…è¿‡è¿ç»­æ—¶é•¿ï¼Œé»˜è®¤ï¼š60sï¼Œæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¶ˆè´¹1åˆ†é’Ÿä¼‘æ¯10msã€‚</span></div><div class=\"line\"> <span class=\"number\">50</span>:                     <span class=\"keyword\">long</span> interval = System.currentTimeMillis() - beginTime;</div><div class=\"line\"> <span class=\"number\">51</span>:                     <span class=\"keyword\">if</span> (interval &gt; MAX_TIME_CONSUME_CONTINUOUSLY) &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:                         ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.submitConsumeRequestLater(processQueue, messageQueue, <span class=\"number\">10</span>);</div><div class=\"line\"> <span class=\"number\">53</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">54</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">55</span>: </div><div class=\"line\"> <span class=\"number\">56</span>:                     <span class=\"comment\">// è·å–æ¶ˆè´¹æ¶ˆæ¯ã€‚æ­¤å¤„å’Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚ä¸åŒï¼Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚å·²ç»å¸¦äº†æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</span></div><div class=\"line\"> <span class=\"number\">57</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> consumeBatchSize = ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class=\"line\"> <span class=\"number\">58</span>:                     List&lt;MessageExt&gt; msgs = <span class=\"keyword\">this</span>.processQueue.takeMessags(consumeBatchSize);</div><div class=\"line\"> <span class=\"number\">59</span>:                     <span class=\"keyword\">if</span> (!msgs.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:                         <span class=\"keyword\">final</span> ConsumeOrderlyContext context = <span class=\"keyword\">new</span> ConsumeOrderlyContext(<span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">61</span>: </div><div class=\"line\"> <span class=\"number\">62</span>:                         ConsumeOrderlyStatus status = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">63</span>: </div><div class=\"line\"> <span class=\"number\">64</span>:                         <span class=\"comment\">// ....çœç•¥ä»£ç ï¼šHookï¼šbefore</span></div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:                         <span class=\"comment\">// æ‰§è¡Œæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">67</span>:                         <span class=\"keyword\">long</span> beginTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">68</span>:                         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;</div><div class=\"line\"> <span class=\"number\">69</span>:                         <span class=\"keyword\">boolean</span> hasException = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">70</span>:                         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">71</span>:                             <span class=\"keyword\">this</span>.processQueue.getLockConsume().lock(); <span class=\"comment\">// é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”</span></div><div class=\"line\"> <span class=\"number\">72</span>: </div><div class=\"line\"> <span class=\"number\">73</span>:                             <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:                                 log.warn(<span class=\"string\">\"consumeMessage, the message queue not be able to consume, because it's dropped. &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">75</span>:                                     <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">76</span>:                                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">77</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">78</span>: </div><div class=\"line\"> <span class=\"number\">79</span>:                             status = messageListener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class=\"line\"> <span class=\"number\">80</span>:                         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">81</span>:                             log.warn(<span class=\"string\">\"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">82</span>:                                 RemotingHelper.exceptionSimpleDesc(e), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">83</span>:                                 ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.consumerGroup, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">84</span>:                                 msgs, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">85</span>:                                 messageQueue);</div><div class=\"line\"> <span class=\"number\">86</span>:                             hasException = <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">87</span>:                         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">88</span>:                             <span class=\"keyword\">this</span>.processQueue.getLockConsume().unlock(); <span class=\"comment\">// é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”</span></div><div class=\"line\"> <span class=\"number\">89</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">90</span>: </div><div class=\"line\"> <span class=\"number\">91</span>:                         <span class=\"comment\">// ....çœç•¥ä»£ç ï¼šè§£ææ¶ˆè´¹ç»“æœçŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:                         <span class=\"comment\">// ....çœç•¥ä»£ç ï¼šHookï¼šafter</span></div><div class=\"line\"> <span class=\"number\">94</span>: </div><div class=\"line\"> <span class=\"number\">95</span>:                         ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.getConsumerStatsManager()</div><div class=\"line\"> <span class=\"number\">96</span>:                             .incConsumeRT(ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class=\"line\"> <span class=\"number\">97</span>: </div><div class=\"line\"> <span class=\"number\">98</span>:                         <span class=\"comment\">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></div><div class=\"line\"> <span class=\"number\">99</span>:                         continueConsume = ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.processConsumeResult(msgs, status, context, <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">100</span>:                     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">101</span>:                         continueConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">102</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">103</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">104</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">105</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"><span class=\"number\">106</span>:                     log.warn(<span class=\"string\">\"the message queue not be able to consume, because it's dropped. &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"><span class=\"number\">107</span>:                     <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">108</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>:                 ConsumeMessageOrderlyService.<span class=\"keyword\">this</span>.tryLockLaterAndReconsume(<span class=\"keyword\">this</span>.messageQueue, <span class=\"keyword\">this</span>.processQueue, <span class=\"number\">100</span>);</div><div class=\"line\"><span class=\"number\">111</span>:             &#125;</div><div class=\"line\"><span class=\"number\">112</span>:         &#125;</div><div class=\"line\"><span class=\"number\">113</span>:     &#125;</div><div class=\"line\"><span class=\"number\">114</span>: </div><div class=\"line\"><span class=\"number\">115</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>\n<li>ç¬¬ 20 è¡Œ ï¼šè·å¾— <code>Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚</li>\n<li>ç¬¬ 58 è¡Œ ï¼šä»æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é¡ºåºè·å¾—æ¶ˆæ¯ã€‚<strong>å’Œå¹¶å‘æ¶ˆè´¹è·å¾—æ¶ˆæ¯ä¸åŒã€‚å¹¶å‘æ¶ˆè´¹è¯·æ±‚åœ¨è¯·æ±‚åˆ›å»ºæ—¶ï¼Œå·²ç»è®¾ç½®å¥½æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</strong></li>\n<li>ç¬¬ 71 è¡Œ ï¼šè·å¾— <code>Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ã€‚ç›¸æ¯”ã€<code>Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”ã€‘ï¼Œå…¶ç²’åº¦è¾ƒå°ã€‚è¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„â“<strong>ä¸ºä»€ä¹ˆæœ‰<code>Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ Consumer æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>çš„åŸå› ã€‚</li>\n<li>ç¬¬ 79 è¡Œ ï¼š<strong>æ‰§è¡Œæ¶ˆè´¹</strong>ã€‚</li>\n<li>ç¬¬ 99 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>\n</ul>\n<h3 id=\"3-1-2-å¤„ç†æ¶ˆè´¹ç»“æœ\"><a href=\"#3-1-2-å¤„ç†æ¶ˆè´¹ç»“æœ\" class=\"headerlink\" title=\"3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ\"></a>3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</h3><p>é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ç»“æœ (<code>ConsumeOrderlyStatus</code>) æœ‰å››ç§æƒ…å†µï¼š</p>\n<ul>\n<li><code>SUCCESS</code> ï¼šæ¶ˆè´¹æˆåŠŸ<strong>ä½†ä¸æäº¤</strong>ã€‚</li>\n<li><code>ROLLBACK</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆè´¹å›æ»šã€‚</li>\n<li><code>COMMIT</code> ï¼šæ¶ˆè´¹æˆåŠŸæäº¤å¹¶ä¸”æäº¤ã€‚</li>\n<li><code>SUSPEND_CURRENT_QUEUE_A_MOMENT</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼ŒæŒ‚èµ·æ¶ˆè´¹é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚</li>\n</ul>\n<p>è€ƒè™‘åˆ° <code>ROLLBACK</code> ã€<code>COMMIT</code> æš‚æ—¶åªä½¿ç”¨åœ¨ <code>MySQL binlog</code> åœºæ™¯ï¼Œå®˜æ–¹å°†è¿™ä¸¤çŠ¶æ€æ ‡è®°ä¸º <code>@Deprecated</code>ã€‚å½“ç„¶ï¼Œç›¸åº”çš„å®ç°é€»è¾‘ä¾ç„¶ä¿ç•™ã€‚</p>\n<p>åœ¨<strong>å¹¶å‘æ¶ˆè´¹</strong>åœºæ™¯æ—¶ï¼Œå¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œ<code>Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯å‘å›åˆ° <code>Broker</code> é‡è¯•é˜Ÿåˆ—ï¼Œè·³è¿‡å½“å‰æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹æ¬¡æ‹‰å–è¯¥æ¶ˆæ¯å†è¿›è¡Œæ¶ˆè´¹ã€‚</p>\n<p>ä½†æ˜¯åœ¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</strong>æ¶ˆè´¹æ—¶ï¼Œè¿™æ ·åšæ˜¾ç„¶ä¸è¡Œã€‚ä¹Ÿå› æ­¤ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¼šæŒ‚èµ·é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚ </p>\n<p>ä¸è¿‡æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ä¸€ç›´å¤±è´¥ï¼Œä¹Ÿä¸å¯èƒ½ä¸€ç›´æ¶ˆè´¹ã€‚å½“è¶…è¿‡æ¶ˆè´¹é‡è¯•ä¸Šé™æ—¶ï¼Œ<code>Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥è¶…è¿‡ä¸Šé™çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code> æ­»ä¿¡é˜Ÿåˆ—ã€‚</p>\n<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * å¤„ç†æ¶ˆè´¹ç»“æœï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­æ¶ˆè´¹</div><div class=\"line\">  4:  *</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> status æ¶ˆè´¹ç»“æœçŠ¶æ€</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> context æ¶ˆè´¹Context</div><div class=\"line\">  8:  * <span class=\"doctag\">@param</span> consumeRequest æ¶ˆè´¹è¯·æ±‚</div><div class=\"line\">  9:  * <span class=\"doctag\">@return</span> æ˜¯å¦ç»§ç»­æ¶ˆè´¹</div><div class=\"line\"> 10:  */</div><div class=\"line\"> <span class=\"number\">11</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">processConsumeResult</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs, //</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">final</span> ConsumeOrderlyStatus status, //</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"keyword\">final</span> ConsumeOrderlyContext context, //</div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">final</span> ConsumeRequest consumeRequest//</div><div class=\"line\"> <span class=\"number\">16</span>: ) &#123;</div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"keyword\">boolean</span> continueConsume = <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:     <span class=\"keyword\">long</span> commitOffset = -<span class=\"number\">1L</span>;</div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"keyword\">if</span> (context.isAutoCommit()) &#123;</div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"keyword\">switch</span> (status) &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"keyword\">case</span> COMMIT:</div><div class=\"line\"> <span class=\"number\">22</span>:             <span class=\"keyword\">case</span> ROLLBACK:</div><div class=\"line\"> <span class=\"number\">23</span>:                 log.warn(<span class=\"string\">\"the message queue consume result is illegal, we think you want to ack these message &#123;&#125;\"</span>, consumeRequest.getMessageQueue());</div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"keyword\">case</span> SUCCESS:</div><div class=\"line\"> <span class=\"number\">25</span>:                 <span class=\"comment\">// æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">26</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class=\"line\"> <span class=\"number\">27</span>:                 <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"> <span class=\"number\">28</span>:                 <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class=\"line\"> <span class=\"number\">29</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">30</span>:             <span class=\"keyword\">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT:</div><div class=\"line\"> <span class=\"number\">31</span>:                 <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"> <span class=\"number\">32</span>:                 <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class=\"line\"> <span class=\"number\">33</span>:                 <span class=\"keyword\">if</span> (checkReconsumeTimes(msgs)) &#123; <span class=\"comment\">// è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms</span></div><div class=\"line\"> <span class=\"number\">34</span>:                     <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">35</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class=\"line\"> <span class=\"number\">36</span>:                     <span class=\"comment\">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">37</span>:                     <span class=\"keyword\">this</span>.submitConsumeRequestLater(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">38</span>:                         consumeRequest.getProcessQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">39</span>:                         consumeRequest.getMessageQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">40</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class=\"line\"> <span class=\"number\">41</span>:                     continueConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">42</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">43</span>:                     commitOffset = consumeRequest.getProcessQueue().commit();</div><div class=\"line\"> <span class=\"number\">44</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">45</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">46</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">47</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">48</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">49</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">50</span>:         <span class=\"keyword\">switch</span> (status) &#123;</div><div class=\"line\"> <span class=\"number\">51</span>:             <span class=\"keyword\">case</span> SUCCESS:</div><div class=\"line\"> <span class=\"number\">52</span>:                 <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class=\"line\"> <span class=\"number\">53</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">54</span>:             <span class=\"keyword\">case</span> COMMIT:</div><div class=\"line\"> <span class=\"number\">55</span>:                 <span class=\"comment\">// æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">56</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class=\"line\"> <span class=\"number\">57</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">58</span>:             <span class=\"keyword\">case</span> ROLLBACK:</div><div class=\"line\"> <span class=\"number\">59</span>:                 <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">60</span>:                 consumeRequest.getProcessQueue().rollback();</div><div class=\"line\"> <span class=\"number\">61</span>:                 <span class=\"keyword\">this</span>.submitConsumeRequestLater(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">62</span>:                     consumeRequest.getProcessQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">63</span>:                     consumeRequest.getMessageQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">64</span>:                     context.getSuspendCurrentQueueTimeMillis());</div><div class=\"line\"> <span class=\"number\">65</span>:                 continueConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">66</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">67</span>:             <span class=\"keyword\">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT: <span class=\"comment\">// è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms</span></div><div class=\"line\"> <span class=\"number\">68</span>:                 <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class=\"line\"> <span class=\"number\">69</span>:                 <span class=\"keyword\">if</span> (checkReconsumeTimes(msgs)) &#123;</div><div class=\"line\"> <span class=\"number\">70</span>:                     <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">71</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class=\"line\"> <span class=\"number\">72</span>:                     <span class=\"comment\">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">73</span>:                     <span class=\"keyword\">this</span>.submitConsumeRequestLater(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">74</span>:                         consumeRequest.getProcessQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">75</span>:                         consumeRequest.getMessageQueue(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">76</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class=\"line\"> <span class=\"number\">77</span>:                     continueConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">78</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">79</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">80</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">81</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">82</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">83</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">84</span>: </div><div class=\"line\"> <span class=\"number\">85</span>:     <span class=\"comment\">// æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœªdroppedï¼Œæäº¤æœ‰æ•ˆæ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">86</span>:     <span class=\"keyword\">if</span> (commitOffset &gt;= <span class=\"number\">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), commitOffset, <span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">88</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">89</span>: </div><div class=\"line\"> <span class=\"number\">90</span>:     <span class=\"keyword\">return</span> continueConsume;</div><div class=\"line\"> <span class=\"number\">91</span>: &#125;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">getMaxReconsumeTimes</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">94</span>:     <span class=\"comment\">// default reconsume times: Integer.MAX_VALUE</span></div><div class=\"line\"> <span class=\"number\">95</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes() == -<span class=\"number\">1</span>) &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:         <span class=\"keyword\">return</span> Integer.MAX_VALUE;</div><div class=\"line\"> <span class=\"number\">97</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes();</div><div class=\"line\"> <span class=\"number\">99</span>:     &#125;</div><div class=\"line\"><span class=\"number\">100</span>: &#125;</div><div class=\"line\"><span class=\"number\">101</span>: </div><div class=\"line\"><span class=\"number\">102</span>: <span class=\"comment\">/**</span></div><div class=\"line\">103:  * è®¡ç®—æ˜¯å¦è¦æš‚åœæ¶ˆè´¹</div><div class=\"line\">104:  * ä¸æš‚åœæ¡ä»¶ï¼šå­˜åœ¨æ¶ˆæ¯éƒ½è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°å¹¶ä¸”éƒ½å‘å›brokeræˆåŠŸ</div><div class=\"line\">105:  *</div><div class=\"line\">106:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\">107:  * <span class=\"doctag\">@return</span> æ˜¯å¦è¦æš‚åœ</div><div class=\"line\">108:  */</div><div class=\"line\"><span class=\"number\">109</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">checkReconsumeTimes</span><span class=\"params\">(List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">110</span>:     <span class=\"keyword\">boolean</span> suspend = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">111</span>:     <span class=\"keyword\">if</span> (msgs != <span class=\"keyword\">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">112</span>:         <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"><span class=\"number\">113</span>:             <span class=\"keyword\">if</span> (msg.getReconsumeTimes() &gt;= getMaxReconsumeTimes()) &#123;</div><div class=\"line\"><span class=\"number\">114</span>:                 MessageAccessor.setReconsumeTime(msg, String.valueOf(msg.getReconsumeTimes()));</div><div class=\"line\"><span class=\"number\">115</span>:                 <span class=\"keyword\">if</span> (!sendMessageBack(msg)) &#123; <span class=\"comment\">// å‘å›å¤±è´¥ï¼Œä¸­æ–­</span></div><div class=\"line\"><span class=\"number\">116</span>:                     suspend = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">117</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">118</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">119</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">120</span>:                 suspend = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">121</span>:                 msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">122</span>:             &#125;</div><div class=\"line\"><span class=\"number\">123</span>:         &#125;</div><div class=\"line\"><span class=\"number\">124</span>:     &#125;</div><div class=\"line\"><span class=\"number\">125</span>:     <span class=\"keyword\">return</span> suspend;</div><div class=\"line\"><span class=\"number\">126</span>: &#125;</div><div class=\"line\"><span class=\"number\">127</span>: </div><div class=\"line\"><span class=\"number\">128</span>: <span class=\"comment\">/**</span></div><div class=\"line\">129:  * å‘å›æ¶ˆæ¯ã€‚</div><div class=\"line\">130:  * æ¶ˆæ¯å‘å›brokeråï¼Œå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ­»ä¿¡é˜Ÿåˆ—ã€‚</div><div class=\"line\">131:  *</div><div class=\"line\">132:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\">133:  * <span class=\"doctag\">@return</span> æ˜¯å¦å‘é€æˆåŠŸ</div><div class=\"line\">134:  */</div><div class=\"line\"><span class=\"number\">135</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">sendMessageBack</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExt msg)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">136</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">137</span>:         <span class=\"comment\">// max reconsume times exceeded then send to dead letter queue.</span></div><div class=\"line\"><span class=\"number\">138</span>:         Message newMsg = <span class=\"keyword\">new</span> Message(MixAll.getRetryTopic(<span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class=\"line\"><span class=\"number\">139</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class=\"line\"><span class=\"number\">140</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class=\"line\"><span class=\"number\">141</span>:         newMsg.setFlag(msg.getFlag());</div><div class=\"line\"><span class=\"number\">142</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class=\"line\"><span class=\"number\">143</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class=\"line\"><span class=\"number\">144</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes()));</div><div class=\"line\"><span class=\"number\">145</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class=\"line\"><span class=\"number\">146</span>:         newMsg.setDelayTimeLevel(<span class=\"number\">3</span> + msg.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">147</span>: </div><div class=\"line\"><span class=\"number\">148</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumer.getDefaultMQPushConsumerImpl().getmQClientFactory().getDefaultMQProducer().send(newMsg);</div><div class=\"line\"><span class=\"number\">149</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">150</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">151</span>:         log.error(<span class=\"string\">\"sendMessageBack exception, group: \"</span> + <span class=\"keyword\">this</span>.consumerGroup + <span class=\"string\">\" msg: \"</span> + msg.toString(), e);</div><div class=\"line\"><span class=\"number\">152</span>:     &#125;</div><div class=\"line\"><span class=\"number\">153</span>: </div><div class=\"line\"><span class=\"number\">154</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">155</span>: &#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>â¬†ï¸â¬†ï¸â¬†ï¸</li>\n<li>ç¬¬ 21 è‡³ 29 è¡Œ ï¼šæ¶ˆè´¹æˆåŠŸã€‚åœ¨è‡ªåŠ¨æäº¤è¿›åº¦( <code>AutoCommit</code> )çš„æƒ…å†µä¸‹ï¼Œ<code>COMMIT</code>ã€<code>ROLLBACK</code>ã€<code>SUCCESS</code> é€»è¾‘<strong>å·²ç»ç»Ÿä¸€</strong>ã€‚</li>\n<li>ç¬¬ 30 è‡³ 45 è¡Œ ï¼šæ¶ˆè´¹å¤±è´¥ã€‚å½“æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™ï¼ˆé»˜è®¤ ï¼š16æ¬¡ï¼‰æ—¶ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° <code>Broker</code> æ­»ä¿¡é˜Ÿåˆ—ï¼Œè·³è¿‡è¿™äº›æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­æ¶ˆè´¹åé¢çš„æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 85 è‡³ 88 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¿›åº¦ã€‚</li>\n</ul>\n<h3 id=\"3-13-æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•\"><a href=\"#3-13-æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•\" class=\"headerlink\" title=\"3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•\"></a>3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</h3><p>ğŸ˜ˆæ¶‰åŠåˆ°çš„å››ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æºç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ProcessQueue.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * æ¶ˆæ¯æ˜ å°„</div><div class=\"line\">  4:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">  5:  */</div><div class=\"line\">  <span class=\"number\">6</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class=\"keyword\">new</span> TreeMap&lt;&gt;();    <span class=\"comment\">/**</span></div><div class=\"line\">  7:  * æ¶ˆæ¯æ˜ å°„ä¸´æ—¶å­˜å‚¨ï¼ˆæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯ï¼‰</div><div class=\"line\">  8:  */</div><div class=\"line\">  <span class=\"number\">9</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMapTemp = <span class=\"keyword\">new</span> TreeMap&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">10</span>: </div><div class=\"line\"> <span class=\"number\">11</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 12:  * å›æ»šæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯</div><div class=\"line\"> 13:  * é€»è¾‘ç±»ä¼¼äº&#123;<span class=\"doctag\">@link</span> #makeMessageToCosumeAgain(List)&#125;</div><div class=\"line\"> 14:  */</div><div class=\"line\"> <span class=\"number\">15</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"keyword\">this</span>.msgTreeMap.putAll(<span class=\"keyword\">this</span>.msgTreeMapTemp);</div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"keyword\">this</span>.msgTreeMapTemp.clear();</div><div class=\"line\"> <span class=\"number\">21</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"> <span class=\"number\">23</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">24</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:         log.error(<span class=\"string\">\"rollback exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">26</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">27</span>: &#125;</div><div class=\"line\"> <span class=\"number\">28</span>: </div><div class=\"line\"> <span class=\"number\">29</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 30:  * æäº¤æ¶ˆè´¹ä¸­çš„æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸï¼Œè¿”å›æ¶ˆè´¹è¿›åº¦</div><div class=\"line\"> 31:  *</div><div class=\"line\"> 32:  * <span class=\"doctag\">@return</span> æ¶ˆè´¹è¿›åº¦</div><div class=\"line\"> 33:  */</div><div class=\"line\"> <span class=\"number\">34</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">commit</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">35</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">36</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"> <span class=\"number\">37</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:             <span class=\"comment\">// æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">39</span>:             Long offset = <span class=\"keyword\">this</span>.msgTreeMapTemp.lastKey();</div><div class=\"line\"> <span class=\"number\">40</span>: </div><div class=\"line\"> <span class=\"number\">41</span>:             <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">42</span>:             msgCount.addAndGet(<span class=\"keyword\">this</span>.msgTreeMapTemp.size() * (-<span class=\"number\">1</span>));</div><div class=\"line\"> <span class=\"number\">43</span>: </div><div class=\"line\"> <span class=\"number\">44</span>:             <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">45</span>:             <span class=\"keyword\">this</span>.msgTreeMapTemp.clear();</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:             <span class=\"comment\">// è¿”å›æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">48</span>:             <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">49</span>:                 <span class=\"keyword\">return</span> offset + <span class=\"number\">1</span>;</div><div class=\"line\"> <span class=\"number\">50</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">51</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"> <span class=\"number\">53</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">54</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">55</span>:         log.error(<span class=\"string\">\"commit exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">56</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"> <span class=\"number\">59</span>: &#125;</div><div class=\"line\"> <span class=\"number\">60</span>: </div><div class=\"line\"> <span class=\"number\">61</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 62:  * æŒ‡å®šæ¶ˆæ¯é‡æ–°æ¶ˆè´¹</div><div class=\"line\"> 63:  * é€»è¾‘ç±»ä¼¼äº&#123;<span class=\"doctag\">@link</span> #rollback()&#125;</div><div class=\"line\"> 64:  *</div><div class=\"line\"> 65:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\"> 66:  */</div><div class=\"line\"> <span class=\"number\">67</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">makeMessageToCosumeAgain</span><span class=\"params\">(List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">68</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">69</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"> <span class=\"number\">70</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">71</span>:             <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"> <span class=\"number\">72</span>:                 <span class=\"keyword\">this</span>.msgTreeMapTemp.remove(msg.getQueueOffset());</div><div class=\"line\"> <span class=\"number\">73</span>:                 <span class=\"keyword\">this</span>.msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class=\"line\"> <span class=\"number\">74</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">75</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"> <span class=\"number\">77</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">78</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">79</span>:         log.error(<span class=\"string\">\"makeMessageToCosumeAgain exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">80</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">81</span>: &#125;</div><div class=\"line\"> <span class=\"number\">82</span>: </div><div class=\"line\"> <span class=\"number\">83</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 84:  * è·å¾—æŒæœ‰æ¶ˆæ¯å‰Næ¡</div><div class=\"line\"> 85:  *</div><div class=\"line\"> 86:  * <span class=\"doctag\">@param</span> batchSize æ¡æ•°</div><div class=\"line\"> 87:  * <span class=\"doctag\">@return</span> æ¶ˆæ¯</div><div class=\"line\"> 88:  */</div><div class=\"line\"> <span class=\"number\">89</span>: <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageExt&gt; <span class=\"title\">takeMessags</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> batchSize)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">90</span>:     List&lt;MessageExt&gt; result = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(batchSize);</div><div class=\"line\"> <span class=\"number\">91</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">92</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">93</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"> <span class=\"number\">94</span>:         <span class=\"keyword\">this</span>.lastConsumeTimestamp = now;</div><div class=\"line\"> <span class=\"number\">95</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:             <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.msgTreeMap.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">97</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; batchSize; i++) &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:                     Map.Entry&lt;Long, MessageExt&gt; entry = <span class=\"keyword\">this</span>.msgTreeMap.pollFirstEntry();</div><div class=\"line\"> <span class=\"number\">99</span>:                     <span class=\"keyword\">if</span> (entry != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">100</span>:                         result.add(entry.getValue());</div><div class=\"line\"><span class=\"number\">101</span>:                         msgTreeMapTemp.put(entry.getKey(), entry.getValue());</div><div class=\"line\"><span class=\"number\">102</span>:                     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">103</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">104</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">105</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">106</span>:             &#125;</div><div class=\"line\"><span class=\"number\">107</span>: </div><div class=\"line\"><span class=\"number\">108</span>:             <span class=\"keyword\">if</span> (result.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">109</span>:                 consuming = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">110</span>:             &#125;</div><div class=\"line\"><span class=\"number\">111</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">112</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"><span class=\"number\">113</span>:         &#125;</div><div class=\"line\"><span class=\"number\">114</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">115</span>:         log.error(<span class=\"string\">\"take Messages exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">116</span>:     &#125;</div><div class=\"line\"><span class=\"number\">117</span>: </div><div class=\"line\"><span class=\"number\">118</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">119</span>: &#125;</div></pre></td></tr></table></figure>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” å®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•","date":"2017-05-14T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šå®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1010-RocketMQæºç è§£æï¼šå®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. å®šæ—¶æ¶ˆæ¯](#)\n\t- [2.1 å»¶è¿Ÿçº§åˆ«](#)\n\t- [2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯](#)\n\t- [2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯](#)\n\t- [2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯](#)\n\t- [2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦](#)\n- [3. æ¶ˆæ¯é‡è¯•](#)\n\n# 1. æ¦‚è¿°\n\n**å»ºè®®**å‰ç½®é˜…è¯»å†…å®¹ï¼š\n\n* [ã€ŠMessageå‘é€&æ¥æ”¶ã€‹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1003-RocketMQæºç è§£æï¼šMessageå‘é€&æ¥æ”¶.md)\n* [ã€ŠMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md)\n\nğŸ˜ˆ ä¸ºä»€ä¹ˆæŠŠ**å®šæ—¶æ¶ˆæ¯**ä¸**æ¶ˆæ¯é‡è¯•**æ”¾åœ¨ä¸€èµ·ï¼Ÿä½ çŒœã€‚  \nğŸ‘» ä½ çŒœæˆ‘çŒœä¸çŒœã€‚\n\n# 2. å®šæ—¶æ¶ˆæ¯\n\n> **å®šæ—¶æ¶ˆæ¯**æ˜¯æŒ‡æ¶ˆæ¯å‘åˆ° Broker åï¼Œä¸èƒ½ç«‹åˆ»è¢« Consumer æ¶ˆè´¹ï¼Œè¦åˆ°ç‰¹å®šçš„æ—¶é—´ç‚¹æˆ–è€…ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚\n\nä¸‹å›¾æ˜¯**å®šæ—¶æ¶ˆæ¯**çš„å¤„ç†é€»è¾‘å›¾ï¼š\n\n![å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png)\n\n## 2.1 å»¶è¿Ÿçº§åˆ«\n\n`RocketMQ` ç›®å‰åªæ”¯æŒ**å›ºå®šç²¾åº¦**çš„å®šæ—¶æ¶ˆæ¯ã€‚å®˜æ–¹è¯´æ³•å¦‚ä¸‹ï¼š\n> å¦‚æœè¦æ”¯æŒä»»æ„çš„æ—¶é—´ç²¾åº¦ï¼Œåœ¨ Broker å±‚é¢ï¼Œå¿…é¡»è¦åšæ¶ˆæ¯æ’åºï¼Œå¦‚æœå†æ¶‰åŠåˆ°æŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ¶ˆæ¯æ’åºè¦ä¸å¯é¿å…çš„äº§ç”Ÿå·¨å¤§æ€§èƒ½å¼€é”€ã€‚\n\n* å»¶è¿Ÿçº§åˆ«ï¼š\n\n| å»¶è¿Ÿçº§åˆ« | æ—¶é—´ |\n| --- | --- |\n| 1   |  1s |\n| 2   |  5s |\n| 3   | 10s |\n| 4   | 30s |\n| 5   |  1m |\n| 6   |  2m |\n| 7   |  3m |\n| 8   | 4m  |\n| 9   | 5m  |\n| 10  | 6m  |\n| 11  | 7m  |\n| 12  | 8m  |\n| 13  | 9m  |\n| 14  | 10m |\n| 15  | 20m |\n| 16  | 30m |\n| 17  | 1h  |\n| 18  | 2h  |\n\n* æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š\n\n    ```Java\n      1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MessageStoreConfig.javaã€‘\n      2: /**\n      3:  * æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«å­—ç¬¦ä¸²é…ç½®\n      4:  */\n      5: private String messageDelayLevel = \"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h\";\n      6: \n      7: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘\n      8: /**\n      9:  * è§£æå»¶è¿Ÿçº§åˆ«\n     10:  *\n     11:  * @return æ˜¯å¦è§£ææˆåŠŸ\n     12:  */\n     13: public boolean parseDelayLevel() {\n     14:     HashMap<String, Long> timeUnitTable = new HashMap<>();\n     15:     timeUnitTable.put(\"s\", 1000L);\n     16:     timeUnitTable.put(\"m\", 1000L * 60);\n     17:     timeUnitTable.put(\"h\", 1000L * 60 * 60);\n     18:     timeUnitTable.put(\"d\", 1000L * 60 * 60 * 24);\n     19: \n     20:     String levelString = this.defaultMessageStore.getMessageStoreConfig().getMessageDelayLevel();\n     21:     try {\n     22:         String[] levelArray = levelString.split(\" \");\n     23:         for (int i = 0; i < levelArray.length; i++) {\n     24:             String value = levelArray[i];\n     25:             String ch = value.substring(value.length() - 1);\n     26:             Long tu = timeUnitTable.get(ch);\n     27: \n     28:             int level = i + 1;\n     29:             if (level > this.maxDelayLevel) {\n     30:                 this.maxDelayLevel = level;\n     31:             }\n     32:             long num = Long.parseLong(value.substring(0, value.length() - 1));\n     33:             long delayTimeMillis = tu * num;\n     34:             this.delayLevelTable.put(level, delayTimeMillis);\n     35:         }\n     36:     } catch (Exception e) {\n     37:         log.error(\"parseDelayLevel exception\", e);\n     38:         log.info(\"levelString String = {}\", levelString);\n     39:         return false;\n     40:     }\n     41: \n     42:     return true;\n     43: }\n    ```\n\n## 2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯\n\n* ğŸ¦…å‘é€æ—¶ï¼Œè®¾ç½®æ¶ˆæ¯çš„**å»¶è¿Ÿçº§åˆ«**ã€‚\n\n```Java\nMessage msg = new Message(...);\nmsg.setDelayTimeLevel(level);\n```\n\n## 2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯\n\n* ğŸ¦… å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ `Topic` ä¸º `SCHEDULE_TOPIC_XXXX`ã€‚\n* ğŸ¦… å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åš**å›ºå®šæ˜ å°„ï¼šQueueId = DelayLevel - 1**ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘\n  2: /**\n  3:  * æ·»åŠ æ¶ˆæ¯ï¼Œè¿”å›æ¶ˆæ¯ç»“æœ\n  4:  *\n  5:  * @param msg æ¶ˆæ¯\n  6:  * @return ç»“æœ\n  7:  */\n  8: public PutMessageResult putMessage(final MessageExtBrokerInner msg) {\n  9:     // ....(çœç•¥ä»£ç ) \n 10: \n 11:     // å®šæ—¶æ¶ˆæ¯å¤„ç†\n 12:     final int tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());\n 13:     if (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE//\n 14:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) {\n 15:         // Delay Delivery\n 16:         if (msg.getDelayTimeLevel() > 0) {\n 17:             if (msg.getDelayTimeLevel() > this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) {\n 18:                 msg.setDelayTimeLevel(this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());\n 19:             }\n 20: \n 21:             // å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ `Topic` ä¸º `SCHEDULE_TOPIC_XXXX` ã€‚\n 22:             topic = ScheduleMessageService.SCHEDULE_TOPIC;\n 23: \n 24:             // å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åšå›ºå®šæ˜ å°„\n 25:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());\n 26: \n 27:             // Backup real topic, queueId\n 28:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());\n 29:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));\n 30:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));\n 31: \n 32:             msg.setTopic(topic);\n 33:             msg.setQueueId(queueId);\n 34:         }\n 35:     }\n 36: \n 37:     // ....(çœç•¥ä»£ç ) \n 38: }\n 39: \n 40: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘\n 41: /**\n 42:  * æ ¹æ® å»¶è¿Ÿçº§åˆ« è®¡ç®— æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·\n 43:  * QueueId = DelayLevel - 1\n 44:  *\n 45:  * @param delayLevel å»¶è¿Ÿçº§åˆ«\n 46:  * @return æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·\n 47:  */\n 48: public static int delayLevel2QueueId(final int delayLevel) {\n 49:     return delayLevel - 1;\n 50: }\n```\n\n-------\n\n* ğŸ¦… ç”Ÿæˆ `ConsumeQueue` æ—¶ï¼Œæ¯æ¡æ¶ˆæ¯çš„ `tagsCode` ä½¿ç”¨ã€æ¶ˆæ¯è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘ã€‚è¿™æ ·ï¼Œ`ScheduleMessageService` åœ¨è½®è¯¢ `ConsumeQueue` æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `tagsCode` è¿›è¡Œè¿‡æ»¤ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘\n  2: /**\n  3:  * check the message and returns the message size\n  4:  *\n  5:  * @return 0 Come the end of the file // >0 Normal messages // -1 Message checksum failure\n  6:  */\n  7: public DispatchRequest checkMessageAndReturnSize(ByteBuffer byteBuffer, final boolean checkCRC, final boolean readBody) {\n  8:     try {\n  9:         // // ....(çœç•¥ä»£ç )\n 10: \n 11:         // 17 properties\n 12:         short propertiesLength = byteBuffer.getShort();\n 13:         if (propertiesLength > 0) {\n 14:             // ....(çœç•¥ä»£ç )\n 15:             String tags = propertiesMap.get(MessageConst.PROPERTY_TAGS);\n 16:             if (tags != null && tags.length() > 0) {\n 17:                 tagsCode = MessageExtBrokerInner.tagsString2tagsCode(MessageExt.parseTopicFilterType(sysFlag), tags);\n 18:             }\n 19: \n 20:             // Timing message processing\n 21:             {\n 22:                 String t = propertiesMap.get(MessageConst.PROPERTY_DELAY_TIME_LEVEL);\n 23:                 if (ScheduleMessageService.SCHEDULE_TOPIC.equals(topic) && t != null) {\n 24:                     int delayLevel = Integer.parseInt(t);\n 25: \n 26:                     if (delayLevel > this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) {\n 27:                         delayLevel = this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel();\n 28:                     }\n 29: \n 30:                     if (delayLevel > 0) {\n 31:                         tagsCode = this.defaultMessageStore.getScheduleMessageService().computeDeliverTimestamp(delayLevel,\n 32:                             storeTimestamp);\n 33:                     }\n 34:                 }\n 35:             }\n 36:         }\n 37: \n 38:         // ....(çœç•¥ä»£ç )\n 39: \n 40:         return new DispatchRequest(//\n 41:             topic, // 1\n 42:             queueId, // 2\n 43:             physicOffset, // 3\n 44:             totalSize, // 4\n 45:             tagsCode, // 5\n 46:             storeTimestamp, // 6\n 47:             queueOffset, // 7\n 48:             keys, // 8\n 49:             uniqKey, //9\n 50:             sysFlag, // 9\n 51:             preparedTransactionOffset// 10\n 52:         );\n 53:     } catch (Exception e) {\n 54:     }\n 55: \n 56:     return new DispatchRequest(-1, false /* success */);\n 57: }\n 58: \n 59: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘\n 60: /**\n 61:  * è®¡ç®— æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘\n 62:  *\n 63:  * @param delayLevel å»¶è¿Ÿçº§åˆ«\n 64:  * @param storeTimestamp å­˜å‚¨æ—¶é—´\n 65:  * @return æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘\n 66:  */\n 67: public long computeDeliverTimestamp(final int delayLevel, final long storeTimestamp) {\n 68:     Long time = this.delayLevelTable.get(delayLevel);\n 69:     if (time != null) {\n 70:         return time + storeTimestamp;\n 71:     }\n 72: \n 73:     return storeTimestamp + 1000;\n 74: }\n```\n\n## 2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯\n\n* ğŸ¦… å¯¹ `SCHEDULE_TOPIC_XXXX` æ¯æ¡æ¶ˆè´¹é˜Ÿåˆ—å¯¹åº”**å•ç‹¬ä¸€ä¸ª**å®šæ—¶ä»»åŠ¡è¿›è¡Œè½®è¯¢ï¼Œå‘é€ **åˆ°è¾¾æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘** çš„æ¶ˆæ¯ã€‚\n\nä¸‹å›¾æ˜¯å‘é€å®šæ—¶æ¶ˆæ¯çš„å¤„ç†é€»è¾‘å›¾ï¼š\n\n![å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘.png)\n\nå®ç°ä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: /**\n  2:  * â¬‡ï¸â¬‡ï¸â¬‡ï¸ å‘é€ï¼ˆæŠ•é€’ï¼‰å»¶è¿Ÿæ¶ˆæ¯å®šæ—¶ä»»åŠ¡\n  3:  */\n  4: class DeliverDelayedMessageTimerTask extends TimerTask {\n  5:     /**\n  6:      * å»¶è¿Ÿçº§åˆ«\n  7:      */\n  8:     private final int delayLevel;\n  9:     /**\n 10:      * ä½ç½®\n 11:      */\n 12:     private final long offset;\n 13: \n 14:     public DeliverDelayedMessageTimerTask(int delayLevel, long offset) {\n 15:         this.delayLevel = delayLevel;\n 16:         this.offset = offset;\n 17:     }\n 18: \n 19:     @Override\n 20:     public void run() {\n 21:         try {\n 22:             this.executeOnTimeup();\n 23:         } catch (Exception e) {\n 24:             // XXX: warn and notify me\n 25:             log.error(\"ScheduleMessageService, executeOnTimeup exception\", e);\n 26:             ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(\n 27:                 this.delayLevel, this.offset), DELAY_FOR_A_PERIOD);\n 28:         }\n 29:     }\n 30: \n 31:     /**\n 32:      * çº æ­£å¯æŠ•é€’æ—¶é—´ã€‚\n 33:      * å› ä¸ºå‘é€çº§åˆ«å¯¹åº”çš„å‘é€é—´éš”å¯ä»¥è°ƒæ•´ï¼Œå¦‚æœè¶…è¿‡å½“å‰é—´éš”ï¼Œåˆ™ä¿®æ­£æˆå½“å‰é…ç½®ï¼Œé¿å…åé¢çš„æ¶ˆæ¯æ— æ³•å‘é€ã€‚\n 34:      *\n 35:      * @param now å½“å‰æ—¶é—´\n 36:      * @param deliverTimestamp æŠ•é€’æ—¶é—´\n 37:      * @return çº æ­£ç»“æœ\n 38:      */\n 39:     private long correctDeliverTimestamp(final long now, final long deliverTimestamp) {\n 40:         long result = deliverTimestamp;\n 41: \n 42:         long maxTimestamp = now + ScheduleMessageService.this.delayLevelTable.get(this.delayLevel);\n 43:         if (deliverTimestamp > maxTimestamp) {\n 44:             result = now;\n 45:         }\n 46: \n 47:         return result;\n 48:     }\n 49: \n 50:     public void executeOnTimeup() {\n 51:         ConsumeQueue cq = ScheduleMessageService.this.defaultMessageStore.findConsumeQueue(SCHEDULE_TOPIC,  delayLevel2QueueId(delayLevel));\n 52: \n 53:         long failScheduleOffset = offset;\n 54: \n 55:         if (cq != null) {\n 56:             SelectMappedBufferResult bufferCQ = cq.getIndexBuffer(this.offset);\n 57:             if (bufferCQ != null) {\n 58:                 try {\n 59:                     long nextOffset = offset;\n 60:                     int i = 0;\n 61:                     for (; i < bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE) {\n 62:                         long offsetPy = bufferCQ.getByteBuffer().getLong();\n 63:                         int sizePy = bufferCQ.getByteBuffer().getInt();\n 64:                         long tagsCode = bufferCQ.getByteBuffer().getLong();\n 65: \n 66:                         long now = System.currentTimeMillis();\n 67:                         long deliverTimestamp = this.correctDeliverTimestamp(now, tagsCode);\n 68: \n 69:                         nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);\n 70: \n 71:                         long countdown = deliverTimestamp - now;\n 72: \n 73:                         if (countdown <= 0) { // æ¶ˆæ¯åˆ°è¾¾å¯å‘é€æ—¶é—´\n 74:                             MessageExt msgExt = ScheduleMessageService.this.defaultMessageStore.lookMessageByOffset(offsetPy, sizePy);\n 75:                             if (msgExt != null) {\n 76:                                 try {\n 77:                                     // å‘é€æ¶ˆæ¯\n 78:                                     MessageExtBrokerInner msgInner = this.messageTimeup(msgExt);\n 79:                                     PutMessageResult putMessageResult = ScheduleMessageService.this.defaultMessageStore.putMessage(msgInner);\n 80:                                     if (putMessageResult != null && putMessageResult.getPutMessageStatus() == PutMessageStatus.PUT_OK) { // å‘é€æˆåŠŸ\n 81:                                         continue;\n 82:                                     } else { // å‘é€å¤±è´¥\n 83:                                         // XXX: warn and notify me\n 84:                                         log.error(\"ScheduleMessageService, a message time up, but reput it failed, topic: {} msgId {}\", msgExt.getTopic(), msgExt.getMsgId());\n 85: \n 86:                                         // å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡\n 87:                                         ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(this.delayLevel, nextOffset), DELAY_FOR_A_PERIOD);\n 88: \n 89:                                         // æ›´æ–°è¿›åº¦\n 90:                                         ScheduleMessageService.this.updateOffset(this.delayLevel, nextOffset);\n 91:                                         return;\n 92:                                     }\n 93:                                 } catch (Exception e) {\n 94:                                     // XXX: warn and notify me\n 95:                                     log.error(\"ScheduleMessageService, messageTimeup execute error, drop it. msgExt=\"\n 96:                                             + msgExt + \", nextOffset=\" + nextOffset + \",offsetPy=\" + offsetPy + \",sizePy=\" + sizePy, e);\n 97:                                 }\n 98:                             }\n 99:                         } else {\n100:                             // å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡\n101:                             ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(this.delayLevel, nextOffset), countdown);\n102: \n103:                             // æ›´æ–°è¿›åº¦\n104:                             ScheduleMessageService.this.updateOffset(this.delayLevel, nextOffset);\n105:                             return;\n106:                         }\n107:                     } // end of for\n108: \n109:                     nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);\n110: \n111:                     // å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡\n112:                     ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(this.delayLevel, nextOffset), DELAY_FOR_A_WHILE);\n113: \n114:                     // æ›´æ–°è¿›åº¦\n115:                     ScheduleMessageService.this.updateOffset(this.delayLevel, nextOffset);\n116:                     return;\n117:                 } finally {\n118:                     bufferCQ.release();\n119:                 }\n120:             } // end of if (bufferCQ != null)\n121:             else { // æ¶ˆè´¹é˜Ÿåˆ—å·²ç»è¢«åˆ é™¤éƒ¨åˆ†ï¼Œè·³è½¬åˆ°æœ€å°çš„æ¶ˆè´¹è¿›åº¦\n122:                 long cqMinOffset = cq.getMinOffsetInQueue();\n123:                 if (offset < cqMinOffset) {\n124:                     failScheduleOffset = cqMinOffset;\n125:                     log.error(\"schedule CQ offset invalid. offset=\" + offset + \", cqMinOffset=\"\n126:                         + cqMinOffset + \", queueId=\" + cq.getQueueId());\n127:                 }\n128:             }\n129:         } // end of if (cq != null)\n130: \n131:         ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(this.delayLevel, failScheduleOffset), DELAY_FOR_A_WHILE);\n132:     }\n133: \n134:     /**\n135:      * è®¾ç½®æ¶ˆæ¯å†…å®¹\n136:      *\n137:      * @param msgExt æ¶ˆæ¯\n138:      * @return æ¶ˆæ¯\n139:      */\n140:     private MessageExtBrokerInner messageTimeup(MessageExt msgExt) {\n141:         MessageExtBrokerInner msgInner = new MessageExtBrokerInner();\n142:         msgInner.setBody(msgExt.getBody());\n143:         msgInner.setFlag(msgExt.getFlag());\n144:         MessageAccessor.setProperties(msgInner, msgExt.getProperties());\n145: \n146:         TopicFilterType topicFilterType = MessageExt.parseTopicFilterType(msgInner.getSysFlag());\n147:         long tagsCodeValue =\n148:             MessageExtBrokerInner.tagsString2tagsCode(topicFilterType, msgInner.getTags());\n149:         msgInner.setTagsCode(tagsCodeValue);\n150:         msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));\n151: \n152:         msgInner.setSysFlag(msgExt.getSysFlag());\n153:         msgInner.setBornTimestamp(msgExt.getBornTimestamp());\n154:         msgInner.setBornHost(msgExt.getBornHost());\n155:         msgInner.setStoreHost(msgExt.getStoreHost());\n156:         msgInner.setReconsumeTimes(msgExt.getReconsumeTimes());\n157: \n158:         msgInner.setWaitStoreMsgOK(false);\n159:         MessageAccessor.clearProperty(msgInner, MessageConst.PROPERTY_DELAY_TIME_LEVEL);\n160: \n161:         msgInner.setTopic(msgInner.getProperty(MessageConst.PROPERTY_REAL_TOPIC));\n162: \n163:         String queueIdStr = msgInner.getProperty(MessageConst.PROPERTY_REAL_QUEUE_ID);\n164:         int queueId = Integer.parseInt(queueIdStr);\n165:         msgInner.setQueueId(queueId);\n166: \n167:         return msgInner;\n168:     }\n169: }\n```\n\n## 2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦\n\n* ğŸ¦… å®šæ—¶æ¶ˆæ¯å‘é€è¿›åº¦å­˜å‚¨åœ¨æ–‡ä»¶(`../config/delayOffset.json`)é‡Œ\n* ğŸ¦… æ¯ 10s å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘\n  2: /**\n  3: public void start() {\n  4:     // å®šæ—¶å‘é€æ¶ˆæ¯\n  5:     for (Map.Entry<Integer, Long> entry : this.delayLevelTable.entrySet()) {\n  6:         Integer level = entry.getKey();\n  7:         Long timeDelay = entry.getValue();\n  8:         Long offset = this.offsetTable.get(level);\n  9:         if (null == offset) {\n 10:             offset = 0L;\n 11:         }\n 12: \n 13:         if (timeDelay != null) {\n 14:             this.timer.schedule(new DeliverDelayedMessageTimerTask(level, offset), FIRST_DELAY_TIME);\n 15:         }\n 16:     }\n 17: \n 18:     // å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦\n 19:     this.timer.scheduleAtFixedRate(new TimerTask() {\n 20: \n 21:         @Override\n 22:         public void run() {\n 23:             try {\n 24:                 ScheduleMessageService.this.persist();\n 25:             } catch (Exception e) {\n 26:                 log.error(\"scheduleAtFixedRate flush exception\", e);\n 27:             }\n 28:         }\n 29:     }, 10000, this.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval());\n 30: }\n```\n\n# 3. æ¶ˆæ¯é‡è¯•\n\n> Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œè¦æä¾›ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚\n\n* ğŸ¦… `Consumer` å°†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å› `Broker`ï¼Œè¿›å…¥**å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—**ã€‚å³ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¸ä¼šç«‹å³æ¶ˆè´¹ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SendMessageProcessor.javaã€‘\n  2: /**\n  3:  * æ¶ˆè´¹è€…å‘å›æ¶ˆæ¯\n  4:  *\n  5:  * @param ctx ctx\n  6:  * @param request è¯·æ±‚\n  7:  * @return å“åº”\n  8:  * @throws RemotingCommandException å½“è¿œç¨‹è°ƒç”¨å¼‚å¸¸\n  9:  */\n 10: private RemotingCommand consumerSendMsgBack(final ChannelHandlerContext ctx, final RemotingCommand request)\n 11:     throws RemotingCommandException {\n 12:     // ....(çœç•¥ä»£ç )\n 13:     // å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚\n 14:     int delayLevel = requestHeader.getDelayLevel();\n 15:     int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();\n 16:     if (request.getVersion() >= MQVersion.Version.V3_4_9.ordinal()) {\n 17:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();\n 18:     }\n 19:     if (msgExt.getReconsumeTimes() >= maxReconsumeTimes//\n 20:     // ....(çœç•¥ä»£ç )\n 21:     } else {\n 22:         if (0 == delayLevel) {\n 23:             delayLevel = 3 + msgExt.getReconsumeTimes();\n 24:         }\n 25:         msgExt.setDelayTimeLevel(delayLevel);\n 26:     }\n 27: \n 28:     // ....(çœç•¥ä»£ç )\n 29:     return response;\n 30: }\n```\n\n","source":"_posts/RocketMQ/2017_05_15_RocketMQæºç åˆ†æâ€”â€”å®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” å®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•\ndate: 2017-05-15\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/message-schedule-and-retry\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šå®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1010-RocketMQæºç è§£æï¼šå®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. å®šæ—¶æ¶ˆæ¯](#)\n\t- [2.1 å»¶è¿Ÿçº§åˆ«](#)\n\t- [2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯](#)\n\t- [2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯](#)\n\t- [2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯](#)\n\t- [2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦](#)\n- [3. æ¶ˆæ¯é‡è¯•](#)\n\n# 1. æ¦‚è¿°\n\n**å»ºè®®**å‰ç½®é˜…è¯»å†…å®¹ï¼š\n\n* [ã€ŠMessageå‘é€&æ¥æ”¶ã€‹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1003-RocketMQæºç è§£æï¼šMessageå‘é€&æ¥æ”¶.md)\n* [ã€ŠMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md)\n\nğŸ˜ˆ ä¸ºä»€ä¹ˆæŠŠ**å®šæ—¶æ¶ˆæ¯**ä¸**æ¶ˆæ¯é‡è¯•**æ”¾åœ¨ä¸€èµ·ï¼Ÿä½ çŒœã€‚  \nğŸ‘» ä½ çŒœæˆ‘çŒœä¸çŒœã€‚\n\n# 2. å®šæ—¶æ¶ˆæ¯\n\n> **å®šæ—¶æ¶ˆæ¯**æ˜¯æŒ‡æ¶ˆæ¯å‘åˆ° Broker åï¼Œä¸èƒ½ç«‹åˆ»è¢« Consumer æ¶ˆè´¹ï¼Œè¦åˆ°ç‰¹å®šçš„æ—¶é—´ç‚¹æˆ–è€…ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚\n\nä¸‹å›¾æ˜¯**å®šæ—¶æ¶ˆæ¯**çš„å¤„ç†é€»è¾‘å›¾ï¼š\n\n![å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png)\n\n## 2.1 å»¶è¿Ÿçº§åˆ«\n\n`RocketMQ` ç›®å‰åªæ”¯æŒ**å›ºå®šç²¾åº¦**çš„å®šæ—¶æ¶ˆæ¯ã€‚å®˜æ–¹è¯´æ³•å¦‚ä¸‹ï¼š\n> å¦‚æœè¦æ”¯æŒä»»æ„çš„æ—¶é—´ç²¾åº¦ï¼Œåœ¨ Broker å±‚é¢ï¼Œå¿…é¡»è¦åšæ¶ˆæ¯æ’åºï¼Œå¦‚æœå†æ¶‰åŠåˆ°æŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ¶ˆæ¯æ’åºè¦ä¸å¯é¿å…çš„äº§ç”Ÿå·¨å¤§æ€§èƒ½å¼€é”€ã€‚\n\n* å»¶è¿Ÿçº§åˆ«ï¼š\n\n| å»¶è¿Ÿçº§åˆ« | æ—¶é—´ |\n| --- | --- |\n| 1   |  1s |\n| 2   |  5s |\n| 3   | 10s |\n| 4   | 30s |\n| 5   |  1m |\n| 6   |  2m |\n| 7   |  3m |\n| 8   | 4m  |\n| 9   | 5m  |\n| 10  | 6m  |\n| 11  | 7m  |\n| 12  | 8m  |\n| 13  | 9m  |\n| 14  | 10m |\n| 15  | 20m |\n| 16  | 30m |\n| 17  | 1h  |\n| 18  | 2h  |\n\n* æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š\n\n    ```Java\n      1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MessageStoreConfig.javaã€‘\n      2: /**\n      3:  * æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«å­—ç¬¦ä¸²é…ç½®\n      4:  */\n      5: private String messageDelayLevel = \"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h\";\n      6: \n      7: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘\n      8: /**\n      9:  * è§£æå»¶è¿Ÿçº§åˆ«\n     10:  *\n     11:  * @return æ˜¯å¦è§£ææˆåŠŸ\n     12:  */\n     13: public boolean parseDelayLevel() {\n     14:     HashMap<String, Long> timeUnitTable = new HashMap<>();\n     15:     timeUnitTable.put(\"s\", 1000L);\n     16:     timeUnitTable.put(\"m\", 1000L * 60);\n     17:     timeUnitTable.put(\"h\", 1000L * 60 * 60);\n     18:     timeUnitTable.put(\"d\", 1000L * 60 * 60 * 24);\n     19: \n     20:     String levelString = this.defaultMessageStore.getMessageStoreConfig().getMessageDelayLevel();\n     21:     try {\n     22:         String[] levelArray = levelString.split(\" \");\n     23:         for (int i = 0; i < levelArray.length; i++) {\n     24:             String value = levelArray[i];\n     25:             String ch = value.substring(value.length() - 1);\n     26:             Long tu = timeUnitTable.get(ch);\n     27: \n     28:             int level = i + 1;\n     29:             if (level > this.maxDelayLevel) {\n     30:                 this.maxDelayLevel = level;\n     31:             }\n     32:             long num = Long.parseLong(value.substring(0, value.length() - 1));\n     33:             long delayTimeMillis = tu * num;\n     34:             this.delayLevelTable.put(level, delayTimeMillis);\n     35:         }\n     36:     } catch (Exception e) {\n     37:         log.error(\"parseDelayLevel exception\", e);\n     38:         log.info(\"levelString String = {}\", levelString);\n     39:         return false;\n     40:     }\n     41: \n     42:     return true;\n     43: }\n    ```\n\n## 2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯\n\n* ğŸ¦…å‘é€æ—¶ï¼Œè®¾ç½®æ¶ˆæ¯çš„**å»¶è¿Ÿçº§åˆ«**ã€‚\n\n```Java\nMessage msg = new Message(...);\nmsg.setDelayTimeLevel(level);\n```\n\n## 2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯\n\n* ğŸ¦… å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ `Topic` ä¸º `SCHEDULE_TOPIC_XXXX`ã€‚\n* ğŸ¦… å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åš**å›ºå®šæ˜ å°„ï¼šQueueId = DelayLevel - 1**ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘\n  2: /**\n  3:  * æ·»åŠ æ¶ˆæ¯ï¼Œè¿”å›æ¶ˆæ¯ç»“æœ\n  4:  *\n  5:  * @param msg æ¶ˆæ¯\n  6:  * @return ç»“æœ\n  7:  */\n  8: public PutMessageResult putMessage(final MessageExtBrokerInner msg) {\n  9:     // ....(çœç•¥ä»£ç ) \n 10: \n 11:     // å®šæ—¶æ¶ˆæ¯å¤„ç†\n 12:     final int tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());\n 13:     if (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE//\n 14:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) {\n 15:         // Delay Delivery\n 16:         if (msg.getDelayTimeLevel() > 0) {\n 17:             if (msg.getDelayTimeLevel() > this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) {\n 18:                 msg.setDelayTimeLevel(this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());\n 19:             }\n 20: \n 21:             // å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ `Topic` ä¸º `SCHEDULE_TOPIC_XXXX` ã€‚\n 22:             topic = ScheduleMessageService.SCHEDULE_TOPIC;\n 23: \n 24:             // å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åšå›ºå®šæ˜ å°„\n 25:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());\n 26: \n 27:             // Backup real topic, queueId\n 28:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());\n 29:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));\n 30:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));\n 31: \n 32:             msg.setTopic(topic);\n 33:             msg.setQueueId(queueId);\n 34:         }\n 35:     }\n 36: \n 37:     // ....(çœç•¥ä»£ç ) \n 38: }\n 39: \n 40: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘\n 41: /**\n 42:  * æ ¹æ® å»¶è¿Ÿçº§åˆ« è®¡ç®— æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·\n 43:  * QueueId = DelayLevel - 1\n 44:  *\n 45:  * @param delayLevel å»¶è¿Ÿçº§åˆ«\n 46:  * @return æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·\n 47:  */\n 48: public static int delayLevel2QueueId(final int delayLevel) {\n 49:     return delayLevel - 1;\n 50: }\n```\n\n-------\n\n* ğŸ¦… ç”Ÿæˆ `ConsumeQueue` æ—¶ï¼Œæ¯æ¡æ¶ˆæ¯çš„ `tagsCode` ä½¿ç”¨ã€æ¶ˆæ¯è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘ã€‚è¿™æ ·ï¼Œ`ScheduleMessageService` åœ¨è½®è¯¢ `ConsumeQueue` æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `tagsCode` è¿›è¡Œè¿‡æ»¤ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘\n  2: /**\n  3:  * check the message and returns the message size\n  4:  *\n  5:  * @return 0 Come the end of the file // >0 Normal messages // -1 Message checksum failure\n  6:  */\n  7: public DispatchRequest checkMessageAndReturnSize(ByteBuffer byteBuffer, final boolean checkCRC, final boolean readBody) {\n  8:     try {\n  9:         // // ....(çœç•¥ä»£ç )\n 10: \n 11:         // 17 properties\n 12:         short propertiesLength = byteBuffer.getShort();\n 13:         if (propertiesLength > 0) {\n 14:             // ....(çœç•¥ä»£ç )\n 15:             String tags = propertiesMap.get(MessageConst.PROPERTY_TAGS);\n 16:             if (tags != null && tags.length() > 0) {\n 17:                 tagsCode = MessageExtBrokerInner.tagsString2tagsCode(MessageExt.parseTopicFilterType(sysFlag), tags);\n 18:             }\n 19: \n 20:             // Timing message processing\n 21:             {\n 22:                 String t = propertiesMap.get(MessageConst.PROPERTY_DELAY_TIME_LEVEL);\n 23:                 if (ScheduleMessageService.SCHEDULE_TOPIC.equals(topic) && t != null) {\n 24:                     int delayLevel = Integer.parseInt(t);\n 25: \n 26:                     if (delayLevel > this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) {\n 27:                         delayLevel = this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel();\n 28:                     }\n 29: \n 30:                     if (delayLevel > 0) {\n 31:                         tagsCode = this.defaultMessageStore.getScheduleMessageService().computeDeliverTimestamp(delayLevel,\n 32:                             storeTimestamp);\n 33:                     }\n 34:                 }\n 35:             }\n 36:         }\n 37: \n 38:         // ....(çœç•¥ä»£ç )\n 39: \n 40:         return new DispatchRequest(//\n 41:             topic, // 1\n 42:             queueId, // 2\n 43:             physicOffset, // 3\n 44:             totalSize, // 4\n 45:             tagsCode, // 5\n 46:             storeTimestamp, // 6\n 47:             queueOffset, // 7\n 48:             keys, // 8\n 49:             uniqKey, //9\n 50:             sysFlag, // 9\n 51:             preparedTransactionOffset// 10\n 52:         );\n 53:     } catch (Exception e) {\n 54:     }\n 55: \n 56:     return new DispatchRequest(-1, false /* success */);\n 57: }\n 58: \n 59: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘\n 60: /**\n 61:  * è®¡ç®— æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘\n 62:  *\n 63:  * @param delayLevel å»¶è¿Ÿçº§åˆ«\n 64:  * @param storeTimestamp å­˜å‚¨æ—¶é—´\n 65:  * @return æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘\n 66:  */\n 67: public long computeDeliverTimestamp(final int delayLevel, final long storeTimestamp) {\n 68:     Long time = this.delayLevelTable.get(delayLevel);\n 69:     if (time != null) {\n 70:         return time + storeTimestamp;\n 71:     }\n 72: \n 73:     return storeTimestamp + 1000;\n 74: }\n```\n\n## 2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯\n\n* ğŸ¦… å¯¹ `SCHEDULE_TOPIC_XXXX` æ¯æ¡æ¶ˆè´¹é˜Ÿåˆ—å¯¹åº”**å•ç‹¬ä¸€ä¸ª**å®šæ—¶ä»»åŠ¡è¿›è¡Œè½®è¯¢ï¼Œå‘é€ **åˆ°è¾¾æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘** çš„æ¶ˆæ¯ã€‚\n\nä¸‹å›¾æ˜¯å‘é€å®šæ—¶æ¶ˆæ¯çš„å¤„ç†é€»è¾‘å›¾ï¼š\n\n![å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘.png)\n\nå®ç°ä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: /**\n  2:  * â¬‡ï¸â¬‡ï¸â¬‡ï¸ å‘é€ï¼ˆæŠ•é€’ï¼‰å»¶è¿Ÿæ¶ˆæ¯å®šæ—¶ä»»åŠ¡\n  3:  */\n  4: class DeliverDelayedMessageTimerTask extends TimerTask {\n  5:     /**\n  6:      * å»¶è¿Ÿçº§åˆ«\n  7:      */\n  8:     private final int delayLevel;\n  9:     /**\n 10:      * ä½ç½®\n 11:      */\n 12:     private final long offset;\n 13: \n 14:     public DeliverDelayedMessageTimerTask(int delayLevel, long offset) {\n 15:         this.delayLevel = delayLevel;\n 16:         this.offset = offset;\n 17:     }\n 18: \n 19:     @Override\n 20:     public void run() {\n 21:         try {\n 22:             this.executeOnTimeup();\n 23:         } catch (Exception e) {\n 24:             // XXX: warn and notify me\n 25:             log.error(\"ScheduleMessageService, executeOnTimeup exception\", e);\n 26:             ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(\n 27:                 this.delayLevel, this.offset), DELAY_FOR_A_PERIOD);\n 28:         }\n 29:     }\n 30: \n 31:     /**\n 32:      * çº æ­£å¯æŠ•é€’æ—¶é—´ã€‚\n 33:      * å› ä¸ºå‘é€çº§åˆ«å¯¹åº”çš„å‘é€é—´éš”å¯ä»¥è°ƒæ•´ï¼Œå¦‚æœè¶…è¿‡å½“å‰é—´éš”ï¼Œåˆ™ä¿®æ­£æˆå½“å‰é…ç½®ï¼Œé¿å…åé¢çš„æ¶ˆæ¯æ— æ³•å‘é€ã€‚\n 34:      *\n 35:      * @param now å½“å‰æ—¶é—´\n 36:      * @param deliverTimestamp æŠ•é€’æ—¶é—´\n 37:      * @return çº æ­£ç»“æœ\n 38:      */\n 39:     private long correctDeliverTimestamp(final long now, final long deliverTimestamp) {\n 40:         long result = deliverTimestamp;\n 41: \n 42:         long maxTimestamp = now + ScheduleMessageService.this.delayLevelTable.get(this.delayLevel);\n 43:         if (deliverTimestamp > maxTimestamp) {\n 44:             result = now;\n 45:         }\n 46: \n 47:         return result;\n 48:     }\n 49: \n 50:     public void executeOnTimeup() {\n 51:         ConsumeQueue cq = ScheduleMessageService.this.defaultMessageStore.findConsumeQueue(SCHEDULE_TOPIC,  delayLevel2QueueId(delayLevel));\n 52: \n 53:         long failScheduleOffset = offset;\n 54: \n 55:         if (cq != null) {\n 56:             SelectMappedBufferResult bufferCQ = cq.getIndexBuffer(this.offset);\n 57:             if (bufferCQ != null) {\n 58:                 try {\n 59:                     long nextOffset = offset;\n 60:                     int i = 0;\n 61:                     for (; i < bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE) {\n 62:                         long offsetPy = bufferCQ.getByteBuffer().getLong();\n 63:                         int sizePy = bufferCQ.getByteBuffer().getInt();\n 64:                         long tagsCode = bufferCQ.getByteBuffer().getLong();\n 65: \n 66:                         long now = System.currentTimeMillis();\n 67:                         long deliverTimestamp = this.correctDeliverTimestamp(now, tagsCode);\n 68: \n 69:                         nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);\n 70: \n 71:                         long countdown = deliverTimestamp - now;\n 72: \n 73:                         if (countdown <= 0) { // æ¶ˆæ¯åˆ°è¾¾å¯å‘é€æ—¶é—´\n 74:                             MessageExt msgExt = ScheduleMessageService.this.defaultMessageStore.lookMessageByOffset(offsetPy, sizePy);\n 75:                             if (msgExt != null) {\n 76:                                 try {\n 77:                                     // å‘é€æ¶ˆæ¯\n 78:                                     MessageExtBrokerInner msgInner = this.messageTimeup(msgExt);\n 79:                                     PutMessageResult putMessageResult = ScheduleMessageService.this.defaultMessageStore.putMessage(msgInner);\n 80:                                     if (putMessageResult != null && putMessageResult.getPutMessageStatus() == PutMessageStatus.PUT_OK) { // å‘é€æˆåŠŸ\n 81:                                         continue;\n 82:                                     } else { // å‘é€å¤±è´¥\n 83:                                         // XXX: warn and notify me\n 84:                                         log.error(\"ScheduleMessageService, a message time up, but reput it failed, topic: {} msgId {}\", msgExt.getTopic(), msgExt.getMsgId());\n 85: \n 86:                                         // å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡\n 87:                                         ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(this.delayLevel, nextOffset), DELAY_FOR_A_PERIOD);\n 88: \n 89:                                         // æ›´æ–°è¿›åº¦\n 90:                                         ScheduleMessageService.this.updateOffset(this.delayLevel, nextOffset);\n 91:                                         return;\n 92:                                     }\n 93:                                 } catch (Exception e) {\n 94:                                     // XXX: warn and notify me\n 95:                                     log.error(\"ScheduleMessageService, messageTimeup execute error, drop it. msgExt=\"\n 96:                                             + msgExt + \", nextOffset=\" + nextOffset + \",offsetPy=\" + offsetPy + \",sizePy=\" + sizePy, e);\n 97:                                 }\n 98:                             }\n 99:                         } else {\n100:                             // å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡\n101:                             ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(this.delayLevel, nextOffset), countdown);\n102: \n103:                             // æ›´æ–°è¿›åº¦\n104:                             ScheduleMessageService.this.updateOffset(this.delayLevel, nextOffset);\n105:                             return;\n106:                         }\n107:                     } // end of for\n108: \n109:                     nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);\n110: \n111:                     // å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡\n112:                     ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(this.delayLevel, nextOffset), DELAY_FOR_A_WHILE);\n113: \n114:                     // æ›´æ–°è¿›åº¦\n115:                     ScheduleMessageService.this.updateOffset(this.delayLevel, nextOffset);\n116:                     return;\n117:                 } finally {\n118:                     bufferCQ.release();\n119:                 }\n120:             } // end of if (bufferCQ != null)\n121:             else { // æ¶ˆè´¹é˜Ÿåˆ—å·²ç»è¢«åˆ é™¤éƒ¨åˆ†ï¼Œè·³è½¬åˆ°æœ€å°çš„æ¶ˆè´¹è¿›åº¦\n122:                 long cqMinOffset = cq.getMinOffsetInQueue();\n123:                 if (offset < cqMinOffset) {\n124:                     failScheduleOffset = cqMinOffset;\n125:                     log.error(\"schedule CQ offset invalid. offset=\" + offset + \", cqMinOffset=\"\n126:                         + cqMinOffset + \", queueId=\" + cq.getQueueId());\n127:                 }\n128:             }\n129:         } // end of if (cq != null)\n130: \n131:         ScheduleMessageService.this.timer.schedule(new DeliverDelayedMessageTimerTask(this.delayLevel, failScheduleOffset), DELAY_FOR_A_WHILE);\n132:     }\n133: \n134:     /**\n135:      * è®¾ç½®æ¶ˆæ¯å†…å®¹\n136:      *\n137:      * @param msgExt æ¶ˆæ¯\n138:      * @return æ¶ˆæ¯\n139:      */\n140:     private MessageExtBrokerInner messageTimeup(MessageExt msgExt) {\n141:         MessageExtBrokerInner msgInner = new MessageExtBrokerInner();\n142:         msgInner.setBody(msgExt.getBody());\n143:         msgInner.setFlag(msgExt.getFlag());\n144:         MessageAccessor.setProperties(msgInner, msgExt.getProperties());\n145: \n146:         TopicFilterType topicFilterType = MessageExt.parseTopicFilterType(msgInner.getSysFlag());\n147:         long tagsCodeValue =\n148:             MessageExtBrokerInner.tagsString2tagsCode(topicFilterType, msgInner.getTags());\n149:         msgInner.setTagsCode(tagsCodeValue);\n150:         msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));\n151: \n152:         msgInner.setSysFlag(msgExt.getSysFlag());\n153:         msgInner.setBornTimestamp(msgExt.getBornTimestamp());\n154:         msgInner.setBornHost(msgExt.getBornHost());\n155:         msgInner.setStoreHost(msgExt.getStoreHost());\n156:         msgInner.setReconsumeTimes(msgExt.getReconsumeTimes());\n157: \n158:         msgInner.setWaitStoreMsgOK(false);\n159:         MessageAccessor.clearProperty(msgInner, MessageConst.PROPERTY_DELAY_TIME_LEVEL);\n160: \n161:         msgInner.setTopic(msgInner.getProperty(MessageConst.PROPERTY_REAL_TOPIC));\n162: \n163:         String queueIdStr = msgInner.getProperty(MessageConst.PROPERTY_REAL_QUEUE_ID);\n164:         int queueId = Integer.parseInt(queueIdStr);\n165:         msgInner.setQueueId(queueId);\n166: \n167:         return msgInner;\n168:     }\n169: }\n```\n\n## 2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦\n\n* ğŸ¦… å®šæ—¶æ¶ˆæ¯å‘é€è¿›åº¦å­˜å‚¨åœ¨æ–‡ä»¶(`../config/delayOffset.json`)é‡Œ\n* ğŸ¦… æ¯ 10s å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘\n  2: /**\n  3: public void start() {\n  4:     // å®šæ—¶å‘é€æ¶ˆæ¯\n  5:     for (Map.Entry<Integer, Long> entry : this.delayLevelTable.entrySet()) {\n  6:         Integer level = entry.getKey();\n  7:         Long timeDelay = entry.getValue();\n  8:         Long offset = this.offsetTable.get(level);\n  9:         if (null == offset) {\n 10:             offset = 0L;\n 11:         }\n 12: \n 13:         if (timeDelay != null) {\n 14:             this.timer.schedule(new DeliverDelayedMessageTimerTask(level, offset), FIRST_DELAY_TIME);\n 15:         }\n 16:     }\n 17: \n 18:     // å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦\n 19:     this.timer.scheduleAtFixedRate(new TimerTask() {\n 20: \n 21:         @Override\n 22:         public void run() {\n 23:             try {\n 24:                 ScheduleMessageService.this.persist();\n 25:             } catch (Exception e) {\n 26:                 log.error(\"scheduleAtFixedRate flush exception\", e);\n 27:             }\n 28:         }\n 29:     }, 10000, this.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval());\n 30: }\n```\n\n# 3. æ¶ˆæ¯é‡è¯•\n\n> Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œè¦æä¾›ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚\n\n* ğŸ¦… `Consumer` å°†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å› `Broker`ï¼Œè¿›å…¥**å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—**ã€‚å³ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¸ä¼šç«‹å³æ¶ˆè´¹ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SendMessageProcessor.javaã€‘\n  2: /**\n  3:  * æ¶ˆè´¹è€…å‘å›æ¶ˆæ¯\n  4:  *\n  5:  * @param ctx ctx\n  6:  * @param request è¯·æ±‚\n  7:  * @return å“åº”\n  8:  * @throws RemotingCommandException å½“è¿œç¨‹è°ƒç”¨å¼‚å¸¸\n  9:  */\n 10: private RemotingCommand consumerSendMsgBack(final ChannelHandlerContext ctx, final RemotingCommand request)\n 11:     throws RemotingCommandException {\n 12:     // ....(çœç•¥ä»£ç )\n 13:     // å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚\n 14:     int delayLevel = requestHeader.getDelayLevel();\n 15:     int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();\n 16:     if (request.getVersion() >= MQVersion.Version.V3_4_9.ordinal()) {\n 17:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();\n 18:     }\n 19:     if (msgExt.getReconsumeTimes() >= maxReconsumeTimes//\n 20:     // ....(çœç•¥ä»£ç )\n 21:     } else {\n 22:         if (0 == delayLevel) {\n 23:             delayLevel = 3 + msgExt.getReconsumeTimes();\n 24:         }\n 25:         msgExt.setDelayTimeLevel(delayLevel);\n 26:     }\n 27: \n 28:     // ....(çœç•¥ä»£ç )\n 29:     return response;\n 30: }\n```\n\n","slug":"RocketMQ/message-schedule-and-retry","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswzo0013ak5dms6d77z0","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1010-RocketMQæºç è§£æï¼šå®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šå®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. å®šæ—¶æ¶ˆæ¯</a><ul>\n<li><a href=\"#\">2.1 å»¶è¿Ÿçº§åˆ«</a></li>\n<li><a href=\"#\">2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯</a></li>\n<li><a href=\"#\">2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯</a></li>\n<li><a href=\"#\">2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯</a></li>\n<li><a href=\"#\">2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3. æ¶ˆæ¯é‡è¯•</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p><strong>å»ºè®®</strong>å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>\n<ul>\n<li><a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1003-RocketMQæºç è§£æï¼šMessageå‘é€&amp;æ¥æ”¶.md\" target=\"_blank\" rel=\"external\">ã€ŠMessageå‘é€&amp;æ¥æ”¶ã€‹</a></li>\n<li><a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md\" target=\"_blank\" rel=\"external\">ã€ŠMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹</a></li>\n</ul>\n<p>ğŸ˜ˆ ä¸ºä»€ä¹ˆæŠŠ<strong>å®šæ—¶æ¶ˆæ¯</strong>ä¸<strong>æ¶ˆæ¯é‡è¯•</strong>æ”¾åœ¨ä¸€èµ·ï¼Ÿä½ çŒœã€‚<br>ğŸ‘» ä½ çŒœæˆ‘çŒœä¸çŒœã€‚</p>\n<h1 id=\"2-å®šæ—¶æ¶ˆæ¯\"><a href=\"#2-å®šæ—¶æ¶ˆæ¯\" class=\"headerlink\" title=\"2. å®šæ—¶æ¶ˆæ¯\"></a>2. å®šæ—¶æ¶ˆæ¯</h1><blockquote>\n<p><strong>å®šæ—¶æ¶ˆæ¯</strong>æ˜¯æŒ‡æ¶ˆæ¯å‘åˆ° Broker åï¼Œä¸èƒ½ç«‹åˆ»è¢« Consumer æ¶ˆè´¹ï¼Œè¦åˆ°ç‰¹å®šçš„æ—¶é—´ç‚¹æˆ–è€…ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚</p>\n</blockquote>\n<p>ä¸‹å›¾æ˜¯<strong>å®šæ—¶æ¶ˆæ¯</strong>çš„å¤„ç†é€»è¾‘å›¾ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png\" alt=\"å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png\"></p>\n<h2 id=\"2-1-å»¶è¿Ÿçº§åˆ«\"><a href=\"#2-1-å»¶è¿Ÿçº§åˆ«\" class=\"headerlink\" title=\"2.1 å»¶è¿Ÿçº§åˆ«\"></a>2.1 å»¶è¿Ÿçº§åˆ«</h2><p><code>RocketMQ</code> ç›®å‰åªæ”¯æŒ<strong>å›ºå®šç²¾åº¦</strong>çš„å®šæ—¶æ¶ˆæ¯ã€‚å®˜æ–¹è¯´æ³•å¦‚ä¸‹ï¼š</p>\n<blockquote>\n<p>å¦‚æœè¦æ”¯æŒä»»æ„çš„æ—¶é—´ç²¾åº¦ï¼Œåœ¨ Broker å±‚é¢ï¼Œå¿…é¡»è¦åšæ¶ˆæ¯æ’åºï¼Œå¦‚æœå†æ¶‰åŠåˆ°æŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ¶ˆæ¯æ’åºè¦ä¸å¯é¿å…çš„äº§ç”Ÿå·¨å¤§æ€§èƒ½å¼€é”€ã€‚</p>\n</blockquote>\n<ul>\n<li>å»¶è¿Ÿçº§åˆ«ï¼š</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å»¶è¿Ÿçº§åˆ«</th>\n<th>æ—¶é—´</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1s</td>\n</tr>\n<tr>\n<td>2</td>\n<td>5s</td>\n</tr>\n<tr>\n<td>3</td>\n<td>10s</td>\n</tr>\n<tr>\n<td>4</td>\n<td>30s</td>\n</tr>\n<tr>\n<td>5</td>\n<td>1m</td>\n</tr>\n<tr>\n<td>6</td>\n<td>2m</td>\n</tr>\n<tr>\n<td>7</td>\n<td>3m</td>\n</tr>\n<tr>\n<td>8</td>\n<td>4m</td>\n</tr>\n<tr>\n<td>9</td>\n<td>5m</td>\n</tr>\n<tr>\n<td>10</td>\n<td>6m</td>\n</tr>\n<tr>\n<td>11</td>\n<td>7m</td>\n</tr>\n<tr>\n<td>12</td>\n<td>8m</td>\n</tr>\n<tr>\n<td>13</td>\n<td>9m</td>\n</tr>\n<tr>\n<td>14</td>\n<td>10m</td>\n</tr>\n<tr>\n<td>15</td>\n<td>20m</td>\n</tr>\n<tr>\n<td>16</td>\n<td>30m</td>\n</tr>\n<tr>\n<td>17</td>\n<td>1h</td>\n</tr>\n<tr>\n<td>18</td>\n<td>2h</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><p>æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MessageStoreConfig.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«å­—ç¬¦ä¸²é…ç½®</div><div class=\"line\"> 4:  */</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"keyword\">private</span> String messageDelayLevel = <span class=\"string\">\"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h\"</span>;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 9:  * è§£æå»¶è¿Ÿçº§åˆ«</div><div class=\"line\">10:  *</div><div class=\"line\">11:  * <span class=\"doctag\">@return</span> æ˜¯å¦è§£ææˆåŠŸ</div><div class=\"line\">12:  */</div><div class=\"line\"><span class=\"number\">13</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">parseDelayLevel</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">14</span>:     HashMap&lt;String, Long&gt; timeUnitTable = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</div><div class=\"line\"><span class=\"number\">15</span>:     timeUnitTable.put(<span class=\"string\">\"s\"</span>, <span class=\"number\">1000L</span>);</div><div class=\"line\"><span class=\"number\">16</span>:     timeUnitTable.put(<span class=\"string\">\"m\"</span>, <span class=\"number\">1000L</span> * <span class=\"number\">60</span>);</div><div class=\"line\"><span class=\"number\">17</span>:     timeUnitTable.put(<span class=\"string\">\"h\"</span>, <span class=\"number\">1000L</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span>);</div><div class=\"line\"><span class=\"number\">18</span>:     timeUnitTable.put(<span class=\"string\">\"d\"</span>, <span class=\"number\">1000L</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span>);</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:     String levelString = <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getMessageDelayLevel();</div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>:         String[] levelArray = levelString.split(<span class=\"string\">\" \"</span>);</div><div class=\"line\"><span class=\"number\">23</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; levelArray.length; i++) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:             String value = levelArray[i];</div><div class=\"line\"><span class=\"number\">25</span>:             String ch = value.substring(value.length() - <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">26</span>:             Long tu = timeUnitTable.get(ch);</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"keyword\">int</span> level = i + <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">if</span> (level &gt; <span class=\"keyword\">this</span>.maxDelayLevel) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">this</span>.maxDelayLevel = level;</div><div class=\"line\"><span class=\"number\">31</span>:             &#125;</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">long</span> num = Long.parseLong(value.substring(<span class=\"number\">0</span>, value.length() - <span class=\"number\">1</span>));</div><div class=\"line\"><span class=\"number\">33</span>:             <span class=\"keyword\">long</span> delayTimeMillis = tu * num;</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">this</span>.delayLevelTable.put(level, delayTimeMillis);</div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:         log.error(<span class=\"string\">\"parseDelayLevel exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">38</span>:         log.info(<span class=\"string\">\"levelString String = &#123;&#125;\"</span>, levelString);</div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">43</span>: &#125;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"2-2-Producer-å‘é€å®šæ—¶æ¶ˆæ¯\"><a href=\"#2-2-Producer-å‘é€å®šæ—¶æ¶ˆæ¯\" class=\"headerlink\" title=\"2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯\"></a>2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦…å‘é€æ—¶ï¼Œè®¾ç½®æ¶ˆæ¯çš„<strong>å»¶è¿Ÿçº§åˆ«</strong>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">Message msg = <span class=\"keyword\">new</span> Message(...);</div><div class=\"line\">msg.setDelayTimeLevel(level);</div></pre></td></tr></table></figure>\n<h2 id=\"2-3-Broker-å­˜å‚¨å®šæ—¶æ¶ˆæ¯\"><a href=\"#2-3-Broker-å­˜å‚¨å®šæ—¶æ¶ˆæ¯\" class=\"headerlink\" title=\"2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯\"></a>2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦… å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ <code>Topic</code> ä¸º <code>SCHEDULE_TOPIC_XXXX</code>ã€‚</li>\n<li>ğŸ¦… å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åš<strong>å›ºå®šæ˜ å°„ï¼šQueueId = DelayLevel - 1</strong>ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ·»åŠ æ¶ˆæ¯ï¼Œè¿”å›æ¶ˆæ¯ç»“æœ</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\"> 6:  * <span class=\"doctag\">@return</span> ç»“æœ</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">public</span> PutMessageResult <span class=\"title\">putMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç ) </span></div><div class=\"line\"><span class=\"number\">10</span>: </div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"comment\">// å®šæ—¶æ¶ˆæ¯å¤„ç†</span></div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">14</span>:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"comment\">// Delay Delivery</span></div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">if</span> (msg.getDelayTimeLevel() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">if</span> (msg.getDelayTimeLevel() &gt; <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</div><div class=\"line\"><span class=\"number\">18</span>:                 msg.setDelayTimeLevel(<span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</div><div class=\"line\"><span class=\"number\">19</span>:             &#125;</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"comment\">// å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ `Topic` ä¸º `SCHEDULE_TOPIC_XXXX` ã€‚</span></div><div class=\"line\"><span class=\"number\">22</span>:             topic = ScheduleMessageService.SCHEDULE_TOPIC;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"comment\">// å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åšå›ºå®šæ˜ å°„</span></div><div class=\"line\"><span class=\"number\">25</span>:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"comment\">// Backup real topic, queueId</span></div><div class=\"line\"><span class=\"number\">28</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</div><div class=\"line\"><span class=\"number\">29</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</div><div class=\"line\"><span class=\"number\">30</span>:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:             msg.setTopic(topic);</div><div class=\"line\"><span class=\"number\">33</span>:             msg.setQueueId(queueId);</div><div class=\"line\"><span class=\"number\">34</span>:         &#125;</div><div class=\"line\"><span class=\"number\">35</span>:     &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç ) </span></div><div class=\"line\"><span class=\"number\">38</span>: &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class=\"line\"><span class=\"number\">41</span>: <span class=\"comment\">/**</span></div><div class=\"line\">42:  * æ ¹æ® å»¶è¿Ÿçº§åˆ« è®¡ç®— æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">43:  * QueueId = DelayLevel - 1</div><div class=\"line\">44:  *</div><div class=\"line\">45:  * <span class=\"doctag\">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class=\"line\">46:  * <span class=\"doctag\">@return</span> æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">47:  */</div><div class=\"line\"><span class=\"number\">48</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">delayLevel2QueueId</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> delayLevel)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">49</span>:     <span class=\"keyword\">return</span> delayLevel - <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">50</span>: &#125;</div></pre></td></tr></table></figure>\n<hr>\n<ul>\n<li>ğŸ¦… ç”Ÿæˆ <code>ConsumeQueue</code> æ—¶ï¼Œæ¯æ¡æ¶ˆæ¯çš„ <code>tagsCode</code> ä½¿ç”¨ã€æ¶ˆæ¯è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘ã€‚è¿™æ ·ï¼Œ<code>ScheduleMessageService</code> åœ¨è½®è¯¢ <code>ConsumeQueue</code> æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>tagsCode</code> è¿›è¡Œè¿‡æ»¤ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * check the message and returns the message size</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@return</span> 0 Come the end of the file // &gt;0 Normal messages // -1 Message checksum failure</div><div class=\"line\"> 6:  */</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"function\"><span class=\"keyword\">public</span> DispatchRequest <span class=\"title\">checkMessageAndReturnSize</span><span class=\"params\">(ByteBuffer byteBuffer, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> checkCRC, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> readBody)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"comment\">// // ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">10</span>: </div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"comment\">// 17 properties</span></div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">short</span> propertiesLength = byteBuffer.getShort();</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">if</span> (propertiesLength &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">15</span>:             String tags = propertiesMap.get(MessageConst.PROPERTY_TAGS);</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">if</span> (tags != <span class=\"keyword\">null</span> &amp;&amp; tags.length() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                 tagsCode = MessageExtBrokerInner.tagsString2tagsCode(MessageExt.parseTopicFilterType(sysFlag), tags);</div><div class=\"line\"><span class=\"number\">18</span>:             &#125;</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"comment\">// Timing message processing</span></div><div class=\"line\"><span class=\"number\">21</span>:             &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                 String t = propertiesMap.get(MessageConst.PROPERTY_DELAY_TIME_LEVEL);</div><div class=\"line\"><span class=\"number\">23</span>:                 <span class=\"keyword\">if</span> (ScheduleMessageService.SCHEDULE_TOPIC.equals(topic) &amp;&amp; t != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                     <span class=\"keyword\">int</span> delayLevel = Integer.parseInt(t);</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"keyword\">if</span> (delayLevel &gt; <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:                         delayLevel = <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel();</div><div class=\"line\"><span class=\"number\">28</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"keyword\">if</span> (delayLevel &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                         tagsCode = <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().computeDeliverTimestamp(delayLevel,</div><div class=\"line\"><span class=\"number\">32</span>:                             storeTimestamp);</div><div class=\"line\"><span class=\"number\">33</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">34</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">35</span>:             &#125;</div><div class=\"line\"><span class=\"number\">36</span>:         &#125;</div><div class=\"line\"><span class=\"number\">37</span>: </div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DispatchRequest(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">41</span>:             topic, <span class=\"comment\">// 1</span></div><div class=\"line\"><span class=\"number\">42</span>:             queueId, <span class=\"comment\">// 2</span></div><div class=\"line\"><span class=\"number\">43</span>:             physicOffset, <span class=\"comment\">// 3</span></div><div class=\"line\"><span class=\"number\">44</span>:             totalSize, <span class=\"comment\">// 4</span></div><div class=\"line\"><span class=\"number\">45</span>:             tagsCode, <span class=\"comment\">// 5</span></div><div class=\"line\"><span class=\"number\">46</span>:             storeTimestamp, <span class=\"comment\">// 6</span></div><div class=\"line\"><span class=\"number\">47</span>:             queueOffset, <span class=\"comment\">// 7</span></div><div class=\"line\"><span class=\"number\">48</span>:             keys, <span class=\"comment\">// 8</span></div><div class=\"line\"><span class=\"number\">49</span>:             uniqKey, <span class=\"comment\">//9</span></div><div class=\"line\"><span class=\"number\">50</span>:             sysFlag, <span class=\"comment\">// 9</span></div><div class=\"line\"><span class=\"number\">51</span>:             preparedTransactionOffset<span class=\"comment\">// 10</span></div><div class=\"line\"><span class=\"number\">52</span>:         );</div><div class=\"line\"><span class=\"number\">53</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">54</span>:     &#125;</div><div class=\"line\"><span class=\"number\">55</span>: </div><div class=\"line\"><span class=\"number\">56</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DispatchRequest(-<span class=\"number\">1</span>, <span class=\"keyword\">false</span> <span class=\"comment\">/* success */</span>);</div><div class=\"line\"><span class=\"number\">57</span>: &#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class=\"line\"><span class=\"number\">60</span>: <span class=\"comment\">/**</span></div><div class=\"line\">61:  * è®¡ç®— æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</div><div class=\"line\">62:  *</div><div class=\"line\">63:  * <span class=\"doctag\">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class=\"line\">64:  * <span class=\"doctag\">@param</span> storeTimestamp å­˜å‚¨æ—¶é—´</div><div class=\"line\">65:  * <span class=\"doctag\">@return</span> æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</div><div class=\"line\">66:  */</div><div class=\"line\"><span class=\"number\">67</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">computeDeliverTimestamp</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> delayLevel, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> storeTimestamp)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">68</span>:     Long time = <span class=\"keyword\">this</span>.delayLevelTable.get(delayLevel);</div><div class=\"line\"><span class=\"number\">69</span>:     <span class=\"keyword\">if</span> (time != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">70</span>:         <span class=\"keyword\">return</span> time + storeTimestamp;</div><div class=\"line\"><span class=\"number\">71</span>:     &#125;</div><div class=\"line\"><span class=\"number\">72</span>: </div><div class=\"line\"><span class=\"number\">73</span>:     <span class=\"keyword\">return</span> storeTimestamp + <span class=\"number\">1000</span>;</div><div class=\"line\"><span class=\"number\">74</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-4-Broker-å‘é€å®šæ—¶æ¶ˆæ¯\"><a href=\"#2-4-Broker-å‘é€å®šæ—¶æ¶ˆæ¯\" class=\"headerlink\" title=\"2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯\"></a>2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦… å¯¹ <code>SCHEDULE_TOPIC_XXXX</code> æ¯æ¡æ¶ˆè´¹é˜Ÿåˆ—å¯¹åº”<strong>å•ç‹¬ä¸€ä¸ª</strong>å®šæ—¶ä»»åŠ¡è¿›è¡Œè½®è¯¢ï¼Œå‘é€ <strong>åˆ°è¾¾æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</strong> çš„æ¶ˆæ¯ã€‚</li>\n</ul>\n<p>ä¸‹å›¾æ˜¯å‘é€å®šæ—¶æ¶ˆæ¯çš„å¤„ç†é€»è¾‘å›¾ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘.png\" alt=\"å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘\"></p>\n<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  2:  * â¬‡ï¸â¬‡ï¸â¬‡ï¸ å‘é€ï¼ˆæŠ•é€’ï¼‰å»¶è¿Ÿæ¶ˆæ¯å®šæ—¶ä»»åŠ¡</div><div class=\"line\">  3:  */</div><div class=\"line\">  <span class=\"number\">4</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DeliverDelayedMessageTimerTask</span> <span class=\"keyword\">extends</span> <span class=\"title\">TimerTask</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  6:      * å»¶è¿Ÿçº§åˆ«</div><div class=\"line\">  7:      */</div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> delayLevel;</div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 10:      * ä½ç½®</div><div class=\"line\"> 11:      */</div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset;</div><div class=\"line\"> <span class=\"number\">13</span>: </div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DeliverDelayedMessageTimerTask</span><span class=\"params\">(<span class=\"keyword\">int</span> delayLevel, <span class=\"keyword\">long</span> offset)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">15</span>:         <span class=\"keyword\">this</span>.delayLevel = delayLevel;</div><div class=\"line\"> <span class=\"number\">16</span>:         <span class=\"keyword\">this</span>.offset = offset;</div><div class=\"line\"> <span class=\"number\">17</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">18</span>: </div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:             <span class=\"keyword\">this</span>.executeOnTimeup();</div><div class=\"line\"> <span class=\"number\">23</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">25</span>:             log.error(<span class=\"string\">\"ScheduleMessageService, executeOnTimeup exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">26</span>:             ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(</div><div class=\"line\"> <span class=\"number\">27</span>:                 <span class=\"keyword\">this</span>.delayLevel, <span class=\"keyword\">this</span>.offset), DELAY_FOR_A_PERIOD);</div><div class=\"line\"> <span class=\"number\">28</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">29</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">30</span>: </div><div class=\"line\"> <span class=\"number\">31</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 32:      * çº æ­£å¯æŠ•é€’æ—¶é—´ã€‚</div><div class=\"line\"> 33:      * å› ä¸ºå‘é€çº§åˆ«å¯¹åº”çš„å‘é€é—´éš”å¯ä»¥è°ƒæ•´ï¼Œå¦‚æœè¶…è¿‡å½“å‰é—´éš”ï¼Œåˆ™ä¿®æ­£æˆå½“å‰é…ç½®ï¼Œé¿å…åé¢çš„æ¶ˆæ¯æ— æ³•å‘é€ã€‚</div><div class=\"line\"> 34:      *</div><div class=\"line\"> 35:      * <span class=\"doctag\">@param</span> now å½“å‰æ—¶é—´</div><div class=\"line\"> 36:      * <span class=\"doctag\">@param</span> deliverTimestamp æŠ•é€’æ—¶é—´</div><div class=\"line\"> 37:      * <span class=\"doctag\">@return</span> çº æ­£ç»“æœ</div><div class=\"line\"> 38:      */</div><div class=\"line\"> <span class=\"number\">39</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">correctDeliverTimestamp</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> deliverTimestamp)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">40</span>:         <span class=\"keyword\">long</span> result = deliverTimestamp;</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:         <span class=\"keyword\">long</span> maxTimestamp = now + ScheduleMessageService.<span class=\"keyword\">this</span>.delayLevelTable.get(<span class=\"keyword\">this</span>.delayLevel);</div><div class=\"line\"> <span class=\"number\">43</span>:         <span class=\"keyword\">if</span> (deliverTimestamp &gt; maxTimestamp) &#123;</div><div class=\"line\"> <span class=\"number\">44</span>:             result = now;</div><div class=\"line\"> <span class=\"number\">45</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"> <span class=\"number\">48</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">49</span>: </div><div class=\"line\"> <span class=\"number\">50</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executeOnTimeup</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">51</span>:         ConsumeQueue cq = ScheduleMessageService.<span class=\"keyword\">this</span>.defaultMessageStore.findConsumeQueue(SCHEDULE_TOPIC,  delayLevel2QueueId(delayLevel));</div><div class=\"line\"> <span class=\"number\">52</span>: </div><div class=\"line\"> <span class=\"number\">53</span>:         <span class=\"keyword\">long</span> failScheduleOffset = offset;</div><div class=\"line\"> <span class=\"number\">54</span>: </div><div class=\"line\"> <span class=\"number\">55</span>:         <span class=\"keyword\">if</span> (cq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:             SelectMappedBufferResult bufferCQ = cq.getIndexBuffer(<span class=\"keyword\">this</span>.offset);</div><div class=\"line\"> <span class=\"number\">57</span>:             <span class=\"keyword\">if</span> (bufferCQ != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">58</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:                     <span class=\"keyword\">long</span> nextOffset = offset;</div><div class=\"line\"> <span class=\"number\">60</span>:                     <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">61</span>:                     <span class=\"keyword\">for</span> (; i &lt; bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</div><div class=\"line\"> <span class=\"number\">62</span>:                         <span class=\"keyword\">long</span> offsetPy = bufferCQ.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">63</span>:                         <span class=\"keyword\">int</span> sizePy = bufferCQ.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">64</span>:                         <span class=\"keyword\">long</span> tagsCode = bufferCQ.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:                         <span class=\"keyword\">long</span> now = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">67</span>:                         <span class=\"keyword\">long</span> deliverTimestamp = <span class=\"keyword\">this</span>.correctDeliverTimestamp(now, tagsCode);</div><div class=\"line\"> <span class=\"number\">68</span>: </div><div class=\"line\"> <span class=\"number\">69</span>:                         nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class=\"line\"> <span class=\"number\">70</span>: </div><div class=\"line\"> <span class=\"number\">71</span>:                         <span class=\"keyword\">long</span> countdown = deliverTimestamp - now;</div><div class=\"line\"> <span class=\"number\">72</span>: </div><div class=\"line\"> <span class=\"number\">73</span>:                         <span class=\"keyword\">if</span> (countdown &lt;= <span class=\"number\">0</span>) &#123; <span class=\"comment\">// æ¶ˆæ¯åˆ°è¾¾å¯å‘é€æ—¶é—´</span></div><div class=\"line\"> <span class=\"number\">74</span>:                             MessageExt msgExt = ScheduleMessageService.<span class=\"keyword\">this</span>.defaultMessageStore.lookMessageByOffset(offsetPy, sizePy);</div><div class=\"line\"> <span class=\"number\">75</span>:                             <span class=\"keyword\">if</span> (msgExt != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:                                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">77</span>:                                     <span class=\"comment\">// å‘é€æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">78</span>:                                     MessageExtBrokerInner msgInner = <span class=\"keyword\">this</span>.messageTimeup(msgExt);</div><div class=\"line\"> <span class=\"number\">79</span>:                                     PutMessageResult putMessageResult = ScheduleMessageService.<span class=\"keyword\">this</span>.defaultMessageStore.putMessage(msgInner);</div><div class=\"line\"> <span class=\"number\">80</span>:                                     <span class=\"keyword\">if</span> (putMessageResult != <span class=\"keyword\">null</span> &amp;&amp; putMessageResult.getPutMessageStatus() == PutMessageStatus.PUT_OK) &#123; <span class=\"comment\">// å‘é€æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">81</span>:                                         <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">82</span>:                                     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// å‘é€å¤±è´¥</span></div><div class=\"line\"> <span class=\"number\">83</span>:                                         <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">84</span>:                                         log.error(<span class=\"string\">\"ScheduleMessageService, a message time up, but reput it failed, topic: &#123;&#125; msgId &#123;&#125;\"</span>, msgExt.getTopic(), msgExt.getMsgId());</div><div class=\"line\"> <span class=\"number\">85</span>: </div><div class=\"line\"> <span class=\"number\">86</span>:                                         <span class=\"comment\">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class=\"line\"> <span class=\"number\">87</span>:                                         ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(<span class=\"keyword\">this</span>.delayLevel, nextOffset), DELAY_FOR_A_PERIOD);</div><div class=\"line\"> <span class=\"number\">88</span>: </div><div class=\"line\"> <span class=\"number\">89</span>:                                         <span class=\"comment\">// æ›´æ–°è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">90</span>:                                         ScheduleMessageService.<span class=\"keyword\">this</span>.updateOffset(<span class=\"keyword\">this</span>.delayLevel, nextOffset);</div><div class=\"line\"> <span class=\"number\">91</span>:                                         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">92</span>:                                     &#125;</div><div class=\"line\"> <span class=\"number\">93</span>:                                 &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">94</span>:                                     <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">95</span>:                                     log.error(<span class=\"string\">\"ScheduleMessageService, messageTimeup execute error, drop it. msgExt=\"</span></div><div class=\"line\"> <span class=\"number\">96</span>:                                             + msgExt + <span class=\"string\">\", nextOffset=\"</span> + nextOffset + <span class=\"string\">\",offsetPy=\"</span> + offsetPy + <span class=\"string\">\",sizePy=\"</span> + sizePy, e);</div><div class=\"line\"> <span class=\"number\">97</span>:                                 &#125;</div><div class=\"line\"> <span class=\"number\">98</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">99</span>:                         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">100</span>:                             <span class=\"comment\">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class=\"line\"><span class=\"number\">101</span>:                             ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(<span class=\"keyword\">this</span>.delayLevel, nextOffset), countdown);</div><div class=\"line\"><span class=\"number\">102</span>: </div><div class=\"line\"><span class=\"number\">103</span>:                             <span class=\"comment\">// æ›´æ–°è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">104</span>:                             ScheduleMessageService.<span class=\"keyword\">this</span>.updateOffset(<span class=\"keyword\">this</span>.delayLevel, nextOffset);</div><div class=\"line\"><span class=\"number\">105</span>:                             <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">106</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">107</span>:                     &#125; <span class=\"comment\">// end of for</span></div><div class=\"line\"><span class=\"number\">108</span>: </div><div class=\"line\"><span class=\"number\">109</span>:                     nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class=\"line\"><span class=\"number\">110</span>: </div><div class=\"line\"><span class=\"number\">111</span>:                     <span class=\"comment\">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class=\"line\"><span class=\"number\">112</span>:                     ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(<span class=\"keyword\">this</span>.delayLevel, nextOffset), DELAY_FOR_A_WHILE);</div><div class=\"line\"><span class=\"number\">113</span>: </div><div class=\"line\"><span class=\"number\">114</span>:                     <span class=\"comment\">// æ›´æ–°è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">115</span>:                     ScheduleMessageService.<span class=\"keyword\">this</span>.updateOffset(<span class=\"keyword\">this</span>.delayLevel, nextOffset);</div><div class=\"line\"><span class=\"number\">116</span>:                     <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">117</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">118</span>:                     bufferCQ.release();</div><div class=\"line\"><span class=\"number\">119</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">120</span>:             &#125; <span class=\"comment\">// end of if (bufferCQ != null)</span></div><div class=\"line\"><span class=\"number\">121</span>:             <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æ¶ˆè´¹é˜Ÿåˆ—å·²ç»è¢«åˆ é™¤éƒ¨åˆ†ï¼Œè·³è½¬åˆ°æœ€å°çš„æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">122</span>:                 <span class=\"keyword\">long</span> cqMinOffset = cq.getMinOffsetInQueue();</div><div class=\"line\"><span class=\"number\">123</span>:                 <span class=\"keyword\">if</span> (offset &lt; cqMinOffset) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:                     failScheduleOffset = cqMinOffset;</div><div class=\"line\"><span class=\"number\">125</span>:                     log.error(<span class=\"string\">\"schedule CQ offset invalid. offset=\"</span> + offset + <span class=\"string\">\", cqMinOffset=\"</span></div><div class=\"line\"><span class=\"number\">126</span>:                         + cqMinOffset + <span class=\"string\">\", queueId=\"</span> + cq.getQueueId());</div><div class=\"line\"><span class=\"number\">127</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">128</span>:             &#125;</div><div class=\"line\"><span class=\"number\">129</span>:         &#125; <span class=\"comment\">// end of if (cq != null)</span></div><div class=\"line\"><span class=\"number\">130</span>: </div><div class=\"line\"><span class=\"number\">131</span>:         ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(<span class=\"keyword\">this</span>.delayLevel, failScheduleOffset), DELAY_FOR_A_WHILE);</div><div class=\"line\"><span class=\"number\">132</span>:     &#125;</div><div class=\"line\"><span class=\"number\">133</span>: </div><div class=\"line\"><span class=\"number\">134</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">135:      * è®¾ç½®æ¶ˆæ¯å†…å®¹</div><div class=\"line\">136:      *</div><div class=\"line\">137:      * <span class=\"doctag\">@param</span> msgExt æ¶ˆæ¯</div><div class=\"line\">138:      * <span class=\"doctag\">@return</span> æ¶ˆæ¯</div><div class=\"line\">139:      */</div><div class=\"line\"><span class=\"number\">140</span>:     <span class=\"function\"><span class=\"keyword\">private</span> MessageExtBrokerInner <span class=\"title\">messageTimeup</span><span class=\"params\">(MessageExt msgExt)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">141</span>:         MessageExtBrokerInner msgInner = <span class=\"keyword\">new</span> MessageExtBrokerInner();</div><div class=\"line\"><span class=\"number\">142</span>:         msgInner.setBody(msgExt.getBody());</div><div class=\"line\"><span class=\"number\">143</span>:         msgInner.setFlag(msgExt.getFlag());</div><div class=\"line\"><span class=\"number\">144</span>:         MessageAccessor.setProperties(msgInner, msgExt.getProperties());</div><div class=\"line\"><span class=\"number\">145</span>: </div><div class=\"line\"><span class=\"number\">146</span>:         TopicFilterType topicFilterType = MessageExt.parseTopicFilterType(msgInner.getSysFlag());</div><div class=\"line\"><span class=\"number\">147</span>:         <span class=\"keyword\">long</span> tagsCodeValue =</div><div class=\"line\"><span class=\"number\">148</span>:             MessageExtBrokerInner.tagsString2tagsCode(topicFilterType, msgInner.getTags());</div><div class=\"line\"><span class=\"number\">149</span>:         msgInner.setTagsCode(tagsCodeValue);</div><div class=\"line\"><span class=\"number\">150</span>:         msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</div><div class=\"line\"><span class=\"number\">151</span>: </div><div class=\"line\"><span class=\"number\">152</span>:         msgInner.setSysFlag(msgExt.getSysFlag());</div><div class=\"line\"><span class=\"number\">153</span>:         msgInner.setBornTimestamp(msgExt.getBornTimestamp());</div><div class=\"line\"><span class=\"number\">154</span>:         msgInner.setBornHost(msgExt.getBornHost());</div><div class=\"line\"><span class=\"number\">155</span>:         msgInner.setStoreHost(msgExt.getStoreHost());</div><div class=\"line\"><span class=\"number\">156</span>:         msgInner.setReconsumeTimes(msgExt.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">157</span>: </div><div class=\"line\"><span class=\"number\">158</span>:         msgInner.setWaitStoreMsgOK(<span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">159</span>:         MessageAccessor.clearProperty(msgInner, MessageConst.PROPERTY_DELAY_TIME_LEVEL);</div><div class=\"line\"><span class=\"number\">160</span>: </div><div class=\"line\"><span class=\"number\">161</span>:         msgInner.setTopic(msgInner.getProperty(MessageConst.PROPERTY_REAL_TOPIC));</div><div class=\"line\"><span class=\"number\">162</span>: </div><div class=\"line\"><span class=\"number\">163</span>:         String queueIdStr = msgInner.getProperty(MessageConst.PROPERTY_REAL_QUEUE_ID);</div><div class=\"line\"><span class=\"number\">164</span>:         <span class=\"keyword\">int</span> queueId = Integer.parseInt(queueIdStr);</div><div class=\"line\"><span class=\"number\">165</span>:         msgInner.setQueueId(queueId);</div><div class=\"line\"><span class=\"number\">166</span>: </div><div class=\"line\"><span class=\"number\">167</span>:         <span class=\"keyword\">return</span> msgInner;</div><div class=\"line\"><span class=\"number\">168</span>:     &#125;</div><div class=\"line\"><span class=\"number\">169</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-5-Broker-æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦\"><a href=\"#2-5-Broker-æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦\" class=\"headerlink\" title=\"2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦\"></a>2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦</h2><ul>\n<li>ğŸ¦… å®šæ—¶æ¶ˆæ¯å‘é€è¿›åº¦å­˜å‚¨åœ¨æ–‡ä»¶(<code>../config/delayOffset.json</code>)é‡Œ</li>\n<li>ğŸ¦… æ¯ 10s å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3: public void start() &#123;</div><div class=\"line\"> 4:     // å®šæ—¶å‘é€æ¶ˆæ¯</div><div class=\"line\"> 5:     for (Map.Entry&lt;Integer, Long&gt; entry : this.delayLevelTable.entrySet()) &#123;</div><div class=\"line\"> 6:         Integer level = entry.getKey();</div><div class=\"line\"> 7:         Long timeDelay = entry.getValue();</div><div class=\"line\"> 8:         Long offset = this.offsetTable.get(level);</div><div class=\"line\"> 9:         if (null == offset) &#123;</div><div class=\"line\">10:             offset = 0L;</div><div class=\"line\">11:         &#125;</div><div class=\"line\">12: </div><div class=\"line\">13:         if (timeDelay != null) &#123;</div><div class=\"line\">14:             this.timer.schedule(new DeliverDelayedMessageTimerTask(level, offset), FIRST_DELAY_TIME);</div><div class=\"line\">15:         &#125;</div><div class=\"line\">16:     &#125;</div><div class=\"line\">17: </div><div class=\"line\">18:     // å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦</div><div class=\"line\">19:     this.timer.scheduleAtFixedRate(new TimerTask() &#123;</div><div class=\"line\">20: </div><div class=\"line\">21:         <span class=\"doctag\">@Override</span></div><div class=\"line\">22:         public void run() &#123;</div><div class=\"line\">23:             try &#123;</div><div class=\"line\">24:                 ScheduleMessageService.this.persist();</div><div class=\"line\">25:             &#125; catch (Exception e) &#123;</div><div class=\"line\">26:                 log.error(\"scheduleAtFixedRate flush exception\", e);</div><div class=\"line\">27:             &#125;</div><div class=\"line\">28:         &#125;</div><div class=\"line\">29:     &#125;, 10000, this.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval());</div><div class=\"line\">30: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-æ¶ˆæ¯é‡è¯•\"><a href=\"#3-æ¶ˆæ¯é‡è¯•\" class=\"headerlink\" title=\"3. æ¶ˆæ¯é‡è¯•\"></a>3. æ¶ˆæ¯é‡è¯•</h1><blockquote>\n<p>Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œè¦æä¾›ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚</p>\n</blockquote>\n<ul>\n<li>ğŸ¦… <code>Consumer</code> å°†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å› <code>Broker</code>ï¼Œè¿›å…¥<strong>å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚å³ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¸ä¼šç«‹å³æ¶ˆè´¹ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SendMessageProcessor.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ¶ˆè´¹è€…å‘å›æ¶ˆæ¯</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> ctx ctx</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> request è¯·æ±‚</div><div class=\"line\"> 7:  * <span class=\"doctag\">@return</span> å“åº”</div><div class=\"line\"> 8:  * <span class=\"doctag\">@throws</span> RemotingCommandException å½“è¿œç¨‹è°ƒç”¨å¼‚å¸¸</div><div class=\"line\"> 9:  */</div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">consumerSendMsgBack</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx, <span class=\"keyword\">final</span> RemotingCommand request)</span></span></div><div class=\"line\">11:     <span class=\"keyword\">throws</span> RemotingCommandException &#123;</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"comment\">// å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚</span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">int</span> delayLevel = requestHeader.getDelayLevel();</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class=\"line\"><span class=\"number\">18</span>:     &#125;</div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">if</span> (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">21</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>:         <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == delayLevel) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:             delayLevel = <span class=\"number\">3</span> + msgExt.getReconsumeTimes();</div><div class=\"line\"><span class=\"number\">24</span>:         &#125;</div><div class=\"line\"><span class=\"number\">25</span>:         msgExt.setDelayTimeLevel(delayLevel);</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">30</span>: &#125;</div></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1010-RocketMQæºç è§£æï¼šå®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šå®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. å®šæ—¶æ¶ˆæ¯</a><ul>\n<li><a href=\"#\">2.1 å»¶è¿Ÿçº§åˆ«</a></li>\n<li><a href=\"#\">2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯</a></li>\n<li><a href=\"#\">2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯</a></li>\n<li><a href=\"#\">2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯</a></li>\n<li><a href=\"#\">2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3. æ¶ˆæ¯é‡è¯•</a></li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p><strong>å»ºè®®</strong>å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>\n<ul>\n<li><a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1003-RocketMQæºç è§£æï¼šMessageå‘é€&amp;æ¥æ”¶.md\" target=\"_blank\" rel=\"external\">ã€ŠMessageå‘é€&amp;æ¥æ”¶ã€‹</a></li>\n<li><a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1005-RocketMQæºç è§£æï¼šMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md\" target=\"_blank\" rel=\"external\">ã€ŠMessageæ‹‰å–&amp;æ¶ˆè´¹ï¼ˆä¸‹ï¼‰ã€‹</a></li>\n</ul>\n<p>ğŸ˜ˆ ä¸ºä»€ä¹ˆæŠŠ<strong>å®šæ—¶æ¶ˆæ¯</strong>ä¸<strong>æ¶ˆæ¯é‡è¯•</strong>æ”¾åœ¨ä¸€èµ·ï¼Ÿä½ çŒœã€‚<br>ğŸ‘» ä½ çŒœæˆ‘çŒœä¸çŒœã€‚</p>\n<h1 id=\"2-å®šæ—¶æ¶ˆæ¯\"><a href=\"#2-å®šæ—¶æ¶ˆæ¯\" class=\"headerlink\" title=\"2. å®šæ—¶æ¶ˆæ¯\"></a>2. å®šæ—¶æ¶ˆæ¯</h1><blockquote>\n<p><strong>å®šæ—¶æ¶ˆæ¯</strong>æ˜¯æŒ‡æ¶ˆæ¯å‘åˆ° Broker åï¼Œä¸èƒ½ç«‹åˆ»è¢« Consumer æ¶ˆè´¹ï¼Œè¦åˆ°ç‰¹å®šçš„æ—¶é—´ç‚¹æˆ–è€…ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚</p>\n</blockquote>\n<p>ä¸‹å›¾æ˜¯<strong>å®šæ—¶æ¶ˆæ¯</strong>çš„å¤„ç†é€»è¾‘å›¾ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png\" alt=\"å®šæ—¶æ¶ˆæ¯é€»è¾‘å›¾.png\"></p>\n<h2 id=\"2-1-å»¶è¿Ÿçº§åˆ«\"><a href=\"#2-1-å»¶è¿Ÿçº§åˆ«\" class=\"headerlink\" title=\"2.1 å»¶è¿Ÿçº§åˆ«\"></a>2.1 å»¶è¿Ÿçº§åˆ«</h2><p><code>RocketMQ</code> ç›®å‰åªæ”¯æŒ<strong>å›ºå®šç²¾åº¦</strong>çš„å®šæ—¶æ¶ˆæ¯ã€‚å®˜æ–¹è¯´æ³•å¦‚ä¸‹ï¼š</p>\n<blockquote>\n<p>å¦‚æœè¦æ”¯æŒä»»æ„çš„æ—¶é—´ç²¾åº¦ï¼Œåœ¨ Broker å±‚é¢ï¼Œå¿…é¡»è¦åšæ¶ˆæ¯æ’åºï¼Œå¦‚æœå†æ¶‰åŠåˆ°æŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ¶ˆæ¯æ’åºè¦ä¸å¯é¿å…çš„äº§ç”Ÿå·¨å¤§æ€§èƒ½å¼€é”€ã€‚</p>\n</blockquote>\n<ul>\n<li>å»¶è¿Ÿçº§åˆ«ï¼š</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>å»¶è¿Ÿçº§åˆ«</th>\n<th>æ—¶é—´</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1s</td>\n</tr>\n<tr>\n<td>2</td>\n<td>5s</td>\n</tr>\n<tr>\n<td>3</td>\n<td>10s</td>\n</tr>\n<tr>\n<td>4</td>\n<td>30s</td>\n</tr>\n<tr>\n<td>5</td>\n<td>1m</td>\n</tr>\n<tr>\n<td>6</td>\n<td>2m</td>\n</tr>\n<tr>\n<td>7</td>\n<td>3m</td>\n</tr>\n<tr>\n<td>8</td>\n<td>4m</td>\n</tr>\n<tr>\n<td>9</td>\n<td>5m</td>\n</tr>\n<tr>\n<td>10</td>\n<td>6m</td>\n</tr>\n<tr>\n<td>11</td>\n<td>7m</td>\n</tr>\n<tr>\n<td>12</td>\n<td>8m</td>\n</tr>\n<tr>\n<td>13</td>\n<td>9m</td>\n</tr>\n<tr>\n<td>14</td>\n<td>10m</td>\n</tr>\n<tr>\n<td>15</td>\n<td>20m</td>\n</tr>\n<tr>\n<td>16</td>\n<td>30m</td>\n</tr>\n<tr>\n<td>17</td>\n<td>1h</td>\n</tr>\n<tr>\n<td>18</td>\n<td>2h</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><p>æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MessageStoreConfig.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«å­—ç¬¦ä¸²é…ç½®</div><div class=\"line\"> 4:  */</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"keyword\">private</span> String messageDelayLevel = <span class=\"string\">\"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h\"</span>;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 9:  * è§£æå»¶è¿Ÿçº§åˆ«</div><div class=\"line\">10:  *</div><div class=\"line\">11:  * <span class=\"doctag\">@return</span> æ˜¯å¦è§£ææˆåŠŸ</div><div class=\"line\">12:  */</div><div class=\"line\"><span class=\"number\">13</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">parseDelayLevel</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">14</span>:     HashMap&lt;String, Long&gt; timeUnitTable = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</div><div class=\"line\"><span class=\"number\">15</span>:     timeUnitTable.put(<span class=\"string\">\"s\"</span>, <span class=\"number\">1000L</span>);</div><div class=\"line\"><span class=\"number\">16</span>:     timeUnitTable.put(<span class=\"string\">\"m\"</span>, <span class=\"number\">1000L</span> * <span class=\"number\">60</span>);</div><div class=\"line\"><span class=\"number\">17</span>:     timeUnitTable.put(<span class=\"string\">\"h\"</span>, <span class=\"number\">1000L</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span>);</div><div class=\"line\"><span class=\"number\">18</span>:     timeUnitTable.put(<span class=\"string\">\"d\"</span>, <span class=\"number\">1000L</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span>);</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:     String levelString = <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getMessageDelayLevel();</div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>:         String[] levelArray = levelString.split(<span class=\"string\">\" \"</span>);</div><div class=\"line\"><span class=\"number\">23</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; levelArray.length; i++) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:             String value = levelArray[i];</div><div class=\"line\"><span class=\"number\">25</span>:             String ch = value.substring(value.length() - <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">26</span>:             Long tu = timeUnitTable.get(ch);</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"keyword\">int</span> level = i + <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">if</span> (level &gt; <span class=\"keyword\">this</span>.maxDelayLevel) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">this</span>.maxDelayLevel = level;</div><div class=\"line\"><span class=\"number\">31</span>:             &#125;</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">long</span> num = Long.parseLong(value.substring(<span class=\"number\">0</span>, value.length() - <span class=\"number\">1</span>));</div><div class=\"line\"><span class=\"number\">33</span>:             <span class=\"keyword\">long</span> delayTimeMillis = tu * num;</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">this</span>.delayLevelTable.put(level, delayTimeMillis);</div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:         log.error(<span class=\"string\">\"parseDelayLevel exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">38</span>:         log.info(<span class=\"string\">\"levelString String = &#123;&#125;\"</span>, levelString);</div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">43</span>: &#125;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"2-2-Producer-å‘é€å®šæ—¶æ¶ˆæ¯\"><a href=\"#2-2-Producer-å‘é€å®šæ—¶æ¶ˆæ¯\" class=\"headerlink\" title=\"2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯\"></a>2.2 Producer å‘é€å®šæ—¶æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦…å‘é€æ—¶ï¼Œè®¾ç½®æ¶ˆæ¯çš„<strong>å»¶è¿Ÿçº§åˆ«</strong>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">Message msg = <span class=\"keyword\">new</span> Message(...);</div><div class=\"line\">msg.setDelayTimeLevel(level);</div></pre></td></tr></table></figure>\n<h2 id=\"2-3-Broker-å­˜å‚¨å®šæ—¶æ¶ˆæ¯\"><a href=\"#2-3-Broker-å­˜å‚¨å®šæ—¶æ¶ˆæ¯\" class=\"headerlink\" title=\"2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯\"></a>2.3 Broker å­˜å‚¨å®šæ—¶æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦… å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ <code>Topic</code> ä¸º <code>SCHEDULE_TOPIC_XXXX</code>ã€‚</li>\n<li>ğŸ¦… å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åš<strong>å›ºå®šæ˜ å°„ï¼šQueueId = DelayLevel - 1</strong>ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ·»åŠ æ¶ˆæ¯ï¼Œè¿”å›æ¶ˆæ¯ç»“æœ</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\"> 6:  * <span class=\"doctag\">@return</span> ç»“æœ</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">public</span> PutMessageResult <span class=\"title\">putMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç ) </span></div><div class=\"line\"><span class=\"number\">10</span>: </div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"comment\">// å®šæ—¶æ¶ˆæ¯å¤„ç†</span></div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">14</span>:         || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"comment\">// Delay Delivery</span></div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">if</span> (msg.getDelayTimeLevel() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:             <span class=\"keyword\">if</span> (msg.getDelayTimeLevel() &gt; <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</div><div class=\"line\"><span class=\"number\">18</span>:                 msg.setDelayTimeLevel(<span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</div><div class=\"line\"><span class=\"number\">19</span>:             &#125;</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"comment\">// å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå»¶è¿Ÿæ¶ˆæ¯è¿›å…¥ `Topic` ä¸º `SCHEDULE_TOPIC_XXXX` ã€‚</span></div><div class=\"line\"><span class=\"number\">22</span>:             topic = ScheduleMessageService.SCHEDULE_TOPIC;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"comment\">// å»¶è¿Ÿçº§åˆ« ä¸ æ¶ˆæ¯é˜Ÿåˆ—ç¼–å· åšå›ºå®šæ˜ å°„</span></div><div class=\"line\"><span class=\"number\">25</span>:             queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"comment\">// Backup real topic, queueId</span></div><div class=\"line\"><span class=\"number\">28</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</div><div class=\"line\"><span class=\"number\">29</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</div><div class=\"line\"><span class=\"number\">30</span>:             msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:             msg.setTopic(topic);</div><div class=\"line\"><span class=\"number\">33</span>:             msg.setQueueId(queueId);</div><div class=\"line\"><span class=\"number\">34</span>:         &#125;</div><div class=\"line\"><span class=\"number\">35</span>:     &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç ) </span></div><div class=\"line\"><span class=\"number\">38</span>: &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class=\"line\"><span class=\"number\">41</span>: <span class=\"comment\">/**</span></div><div class=\"line\">42:  * æ ¹æ® å»¶è¿Ÿçº§åˆ« è®¡ç®— æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">43:  * QueueId = DelayLevel - 1</div><div class=\"line\">44:  *</div><div class=\"line\">45:  * <span class=\"doctag\">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class=\"line\">46:  * <span class=\"doctag\">@return</span> æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">47:  */</div><div class=\"line\"><span class=\"number\">48</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">delayLevel2QueueId</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> delayLevel)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">49</span>:     <span class=\"keyword\">return</span> delayLevel - <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">50</span>: &#125;</div></pre></td></tr></table></figure>\n<hr>\n<ul>\n<li>ğŸ¦… ç”Ÿæˆ <code>ConsumeQueue</code> æ—¶ï¼Œæ¯æ¡æ¶ˆæ¯çš„ <code>tagsCode</code> ä½¿ç”¨ã€æ¶ˆæ¯è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘ã€‚è¿™æ ·ï¼Œ<code>ScheduleMessageService</code> åœ¨è½®è¯¢ <code>ConsumeQueue</code> æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>tagsCode</code> è¿›è¡Œè¿‡æ»¤ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * check the message and returns the message size</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@return</span> 0 Come the end of the file // &gt;0 Normal messages // -1 Message checksum failure</div><div class=\"line\"> 6:  */</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"function\"><span class=\"keyword\">public</span> DispatchRequest <span class=\"title\">checkMessageAndReturnSize</span><span class=\"params\">(ByteBuffer byteBuffer, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> checkCRC, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> readBody)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"comment\">// // ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">10</span>: </div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"comment\">// 17 properties</span></div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">short</span> propertiesLength = byteBuffer.getShort();</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">if</span> (propertiesLength &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">15</span>:             String tags = propertiesMap.get(MessageConst.PROPERTY_TAGS);</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">if</span> (tags != <span class=\"keyword\">null</span> &amp;&amp; tags.length() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                 tagsCode = MessageExtBrokerInner.tagsString2tagsCode(MessageExt.parseTopicFilterType(sysFlag), tags);</div><div class=\"line\"><span class=\"number\">18</span>:             &#125;</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"comment\">// Timing message processing</span></div><div class=\"line\"><span class=\"number\">21</span>:             &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                 String t = propertiesMap.get(MessageConst.PROPERTY_DELAY_TIME_LEVEL);</div><div class=\"line\"><span class=\"number\">23</span>:                 <span class=\"keyword\">if</span> (ScheduleMessageService.SCHEDULE_TOPIC.equals(topic) &amp;&amp; t != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                     <span class=\"keyword\">int</span> delayLevel = Integer.parseInt(t);</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:                     <span class=\"keyword\">if</span> (delayLevel &gt; <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:                         delayLevel = <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel();</div><div class=\"line\"><span class=\"number\">28</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"keyword\">if</span> (delayLevel &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                         tagsCode = <span class=\"keyword\">this</span>.defaultMessageStore.getScheduleMessageService().computeDeliverTimestamp(delayLevel,</div><div class=\"line\"><span class=\"number\">32</span>:                             storeTimestamp);</div><div class=\"line\"><span class=\"number\">33</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">34</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">35</span>:             &#125;</div><div class=\"line\"><span class=\"number\">36</span>:         &#125;</div><div class=\"line\"><span class=\"number\">37</span>: </div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DispatchRequest(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">41</span>:             topic, <span class=\"comment\">// 1</span></div><div class=\"line\"><span class=\"number\">42</span>:             queueId, <span class=\"comment\">// 2</span></div><div class=\"line\"><span class=\"number\">43</span>:             physicOffset, <span class=\"comment\">// 3</span></div><div class=\"line\"><span class=\"number\">44</span>:             totalSize, <span class=\"comment\">// 4</span></div><div class=\"line\"><span class=\"number\">45</span>:             tagsCode, <span class=\"comment\">// 5</span></div><div class=\"line\"><span class=\"number\">46</span>:             storeTimestamp, <span class=\"comment\">// 6</span></div><div class=\"line\"><span class=\"number\">47</span>:             queueOffset, <span class=\"comment\">// 7</span></div><div class=\"line\"><span class=\"number\">48</span>:             keys, <span class=\"comment\">// 8</span></div><div class=\"line\"><span class=\"number\">49</span>:             uniqKey, <span class=\"comment\">//9</span></div><div class=\"line\"><span class=\"number\">50</span>:             sysFlag, <span class=\"comment\">// 9</span></div><div class=\"line\"><span class=\"number\">51</span>:             preparedTransactionOffset<span class=\"comment\">// 10</span></div><div class=\"line\"><span class=\"number\">52</span>:         );</div><div class=\"line\"><span class=\"number\">53</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">54</span>:     &#125;</div><div class=\"line\"><span class=\"number\">55</span>: </div><div class=\"line\"><span class=\"number\">56</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DispatchRequest(-<span class=\"number\">1</span>, <span class=\"keyword\">false</span> <span class=\"comment\">/* success */</span>);</div><div class=\"line\"><span class=\"number\">57</span>: &#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class=\"line\"><span class=\"number\">60</span>: <span class=\"comment\">/**</span></div><div class=\"line\">61:  * è®¡ç®— æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</div><div class=\"line\">62:  *</div><div class=\"line\">63:  * <span class=\"doctag\">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class=\"line\">64:  * <span class=\"doctag\">@param</span> storeTimestamp å­˜å‚¨æ—¶é—´</div><div class=\"line\">65:  * <span class=\"doctag\">@return</span> æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</div><div class=\"line\">66:  */</div><div class=\"line\"><span class=\"number\">67</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">computeDeliverTimestamp</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> delayLevel, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> storeTimestamp)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">68</span>:     Long time = <span class=\"keyword\">this</span>.delayLevelTable.get(delayLevel);</div><div class=\"line\"><span class=\"number\">69</span>:     <span class=\"keyword\">if</span> (time != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">70</span>:         <span class=\"keyword\">return</span> time + storeTimestamp;</div><div class=\"line\"><span class=\"number\">71</span>:     &#125;</div><div class=\"line\"><span class=\"number\">72</span>: </div><div class=\"line\"><span class=\"number\">73</span>:     <span class=\"keyword\">return</span> storeTimestamp + <span class=\"number\">1000</span>;</div><div class=\"line\"><span class=\"number\">74</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-4-Broker-å‘é€å®šæ—¶æ¶ˆæ¯\"><a href=\"#2-4-Broker-å‘é€å®šæ—¶æ¶ˆæ¯\" class=\"headerlink\" title=\"2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯\"></a>2.4 Broker å‘é€å®šæ—¶æ¶ˆæ¯</h2><ul>\n<li>ğŸ¦… å¯¹ <code>SCHEDULE_TOPIC_XXXX</code> æ¯æ¡æ¶ˆè´¹é˜Ÿåˆ—å¯¹åº”<strong>å•ç‹¬ä¸€ä¸ª</strong>å®šæ—¶ä»»åŠ¡è¿›è¡Œè½®è¯¢ï¼Œå‘é€ <strong>åˆ°è¾¾æŠ•é€’æ—¶é—´ã€è®¡åˆ’æ¶ˆè´¹æ—¶é—´ã€‘</strong> çš„æ¶ˆæ¯ã€‚</li>\n</ul>\n<p>ä¸‹å›¾æ˜¯å‘é€å®šæ—¶æ¶ˆæ¯çš„å¤„ç†é€»è¾‘å›¾ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1010/å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘.png\" alt=\"å®šæ—¶æ¶ˆæ¯å®šæ—¶é€»è¾‘\"></p>\n<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  2:  * â¬‡ï¸â¬‡ï¸â¬‡ï¸ å‘é€ï¼ˆæŠ•é€’ï¼‰å»¶è¿Ÿæ¶ˆæ¯å®šæ—¶ä»»åŠ¡</div><div class=\"line\">  3:  */</div><div class=\"line\">  <span class=\"number\">4</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DeliverDelayedMessageTimerTask</span> <span class=\"keyword\">extends</span> <span class=\"title\">TimerTask</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  6:      * å»¶è¿Ÿçº§åˆ«</div><div class=\"line\">  7:      */</div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> delayLevel;</div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 10:      * ä½ç½®</div><div class=\"line\"> 11:      */</div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset;</div><div class=\"line\"> <span class=\"number\">13</span>: </div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DeliverDelayedMessageTimerTask</span><span class=\"params\">(<span class=\"keyword\">int</span> delayLevel, <span class=\"keyword\">long</span> offset)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">15</span>:         <span class=\"keyword\">this</span>.delayLevel = delayLevel;</div><div class=\"line\"> <span class=\"number\">16</span>:         <span class=\"keyword\">this</span>.offset = offset;</div><div class=\"line\"> <span class=\"number\">17</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">18</span>: </div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:             <span class=\"keyword\">this</span>.executeOnTimeup();</div><div class=\"line\"> <span class=\"number\">23</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">25</span>:             log.error(<span class=\"string\">\"ScheduleMessageService, executeOnTimeup exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">26</span>:             ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(</div><div class=\"line\"> <span class=\"number\">27</span>:                 <span class=\"keyword\">this</span>.delayLevel, <span class=\"keyword\">this</span>.offset), DELAY_FOR_A_PERIOD);</div><div class=\"line\"> <span class=\"number\">28</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">29</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">30</span>: </div><div class=\"line\"> <span class=\"number\">31</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 32:      * çº æ­£å¯æŠ•é€’æ—¶é—´ã€‚</div><div class=\"line\"> 33:      * å› ä¸ºå‘é€çº§åˆ«å¯¹åº”çš„å‘é€é—´éš”å¯ä»¥è°ƒæ•´ï¼Œå¦‚æœè¶…è¿‡å½“å‰é—´éš”ï¼Œåˆ™ä¿®æ­£æˆå½“å‰é…ç½®ï¼Œé¿å…åé¢çš„æ¶ˆæ¯æ— æ³•å‘é€ã€‚</div><div class=\"line\"> 34:      *</div><div class=\"line\"> 35:      * <span class=\"doctag\">@param</span> now å½“å‰æ—¶é—´</div><div class=\"line\"> 36:      * <span class=\"doctag\">@param</span> deliverTimestamp æŠ•é€’æ—¶é—´</div><div class=\"line\"> 37:      * <span class=\"doctag\">@return</span> çº æ­£ç»“æœ</div><div class=\"line\"> 38:      */</div><div class=\"line\"> <span class=\"number\">39</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">correctDeliverTimestamp</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> deliverTimestamp)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">40</span>:         <span class=\"keyword\">long</span> result = deliverTimestamp;</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:         <span class=\"keyword\">long</span> maxTimestamp = now + ScheduleMessageService.<span class=\"keyword\">this</span>.delayLevelTable.get(<span class=\"keyword\">this</span>.delayLevel);</div><div class=\"line\"> <span class=\"number\">43</span>:         <span class=\"keyword\">if</span> (deliverTimestamp &gt; maxTimestamp) &#123;</div><div class=\"line\"> <span class=\"number\">44</span>:             result = now;</div><div class=\"line\"> <span class=\"number\">45</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"> <span class=\"number\">48</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">49</span>: </div><div class=\"line\"> <span class=\"number\">50</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executeOnTimeup</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">51</span>:         ConsumeQueue cq = ScheduleMessageService.<span class=\"keyword\">this</span>.defaultMessageStore.findConsumeQueue(SCHEDULE_TOPIC,  delayLevel2QueueId(delayLevel));</div><div class=\"line\"> <span class=\"number\">52</span>: </div><div class=\"line\"> <span class=\"number\">53</span>:         <span class=\"keyword\">long</span> failScheduleOffset = offset;</div><div class=\"line\"> <span class=\"number\">54</span>: </div><div class=\"line\"> <span class=\"number\">55</span>:         <span class=\"keyword\">if</span> (cq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:             SelectMappedBufferResult bufferCQ = cq.getIndexBuffer(<span class=\"keyword\">this</span>.offset);</div><div class=\"line\"> <span class=\"number\">57</span>:             <span class=\"keyword\">if</span> (bufferCQ != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">58</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">59</span>:                     <span class=\"keyword\">long</span> nextOffset = offset;</div><div class=\"line\"> <span class=\"number\">60</span>:                     <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">61</span>:                     <span class=\"keyword\">for</span> (; i &lt; bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</div><div class=\"line\"> <span class=\"number\">62</span>:                         <span class=\"keyword\">long</span> offsetPy = bufferCQ.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">63</span>:                         <span class=\"keyword\">int</span> sizePy = bufferCQ.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">64</span>:                         <span class=\"keyword\">long</span> tagsCode = bufferCQ.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:                         <span class=\"keyword\">long</span> now = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">67</span>:                         <span class=\"keyword\">long</span> deliverTimestamp = <span class=\"keyword\">this</span>.correctDeliverTimestamp(now, tagsCode);</div><div class=\"line\"> <span class=\"number\">68</span>: </div><div class=\"line\"> <span class=\"number\">69</span>:                         nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class=\"line\"> <span class=\"number\">70</span>: </div><div class=\"line\"> <span class=\"number\">71</span>:                         <span class=\"keyword\">long</span> countdown = deliverTimestamp - now;</div><div class=\"line\"> <span class=\"number\">72</span>: </div><div class=\"line\"> <span class=\"number\">73</span>:                         <span class=\"keyword\">if</span> (countdown &lt;= <span class=\"number\">0</span>) &#123; <span class=\"comment\">// æ¶ˆæ¯åˆ°è¾¾å¯å‘é€æ—¶é—´</span></div><div class=\"line\"> <span class=\"number\">74</span>:                             MessageExt msgExt = ScheduleMessageService.<span class=\"keyword\">this</span>.defaultMessageStore.lookMessageByOffset(offsetPy, sizePy);</div><div class=\"line\"> <span class=\"number\">75</span>:                             <span class=\"keyword\">if</span> (msgExt != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:                                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">77</span>:                                     <span class=\"comment\">// å‘é€æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">78</span>:                                     MessageExtBrokerInner msgInner = <span class=\"keyword\">this</span>.messageTimeup(msgExt);</div><div class=\"line\"> <span class=\"number\">79</span>:                                     PutMessageResult putMessageResult = ScheduleMessageService.<span class=\"keyword\">this</span>.defaultMessageStore.putMessage(msgInner);</div><div class=\"line\"> <span class=\"number\">80</span>:                                     <span class=\"keyword\">if</span> (putMessageResult != <span class=\"keyword\">null</span> &amp;&amp; putMessageResult.getPutMessageStatus() == PutMessageStatus.PUT_OK) &#123; <span class=\"comment\">// å‘é€æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">81</span>:                                         <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">82</span>:                                     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// å‘é€å¤±è´¥</span></div><div class=\"line\"> <span class=\"number\">83</span>:                                         <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">84</span>:                                         log.error(<span class=\"string\">\"ScheduleMessageService, a message time up, but reput it failed, topic: &#123;&#125; msgId &#123;&#125;\"</span>, msgExt.getTopic(), msgExt.getMsgId());</div><div class=\"line\"> <span class=\"number\">85</span>: </div><div class=\"line\"> <span class=\"number\">86</span>:                                         <span class=\"comment\">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class=\"line\"> <span class=\"number\">87</span>:                                         ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(<span class=\"keyword\">this</span>.delayLevel, nextOffset), DELAY_FOR_A_PERIOD);</div><div class=\"line\"> <span class=\"number\">88</span>: </div><div class=\"line\"> <span class=\"number\">89</span>:                                         <span class=\"comment\">// æ›´æ–°è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">90</span>:                                         ScheduleMessageService.<span class=\"keyword\">this</span>.updateOffset(<span class=\"keyword\">this</span>.delayLevel, nextOffset);</div><div class=\"line\"> <span class=\"number\">91</span>:                                         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">92</span>:                                     &#125;</div><div class=\"line\"> <span class=\"number\">93</span>:                                 &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">94</span>:                                     <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">95</span>:                                     log.error(<span class=\"string\">\"ScheduleMessageService, messageTimeup execute error, drop it. msgExt=\"</span></div><div class=\"line\"> <span class=\"number\">96</span>:                                             + msgExt + <span class=\"string\">\", nextOffset=\"</span> + nextOffset + <span class=\"string\">\",offsetPy=\"</span> + offsetPy + <span class=\"string\">\",sizePy=\"</span> + sizePy, e);</div><div class=\"line\"> <span class=\"number\">97</span>:                                 &#125;</div><div class=\"line\"> <span class=\"number\">98</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">99</span>:                         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">100</span>:                             <span class=\"comment\">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class=\"line\"><span class=\"number\">101</span>:                             ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(<span class=\"keyword\">this</span>.delayLevel, nextOffset), countdown);</div><div class=\"line\"><span class=\"number\">102</span>: </div><div class=\"line\"><span class=\"number\">103</span>:                             <span class=\"comment\">// æ›´æ–°è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">104</span>:                             ScheduleMessageService.<span class=\"keyword\">this</span>.updateOffset(<span class=\"keyword\">this</span>.delayLevel, nextOffset);</div><div class=\"line\"><span class=\"number\">105</span>:                             <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">106</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">107</span>:                     &#125; <span class=\"comment\">// end of for</span></div><div class=\"line\"><span class=\"number\">108</span>: </div><div class=\"line\"><span class=\"number\">109</span>:                     nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class=\"line\"><span class=\"number\">110</span>: </div><div class=\"line\"><span class=\"number\">111</span>:                     <span class=\"comment\">// å®‰æ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></div><div class=\"line\"><span class=\"number\">112</span>:                     ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(<span class=\"keyword\">this</span>.delayLevel, nextOffset), DELAY_FOR_A_WHILE);</div><div class=\"line\"><span class=\"number\">113</span>: </div><div class=\"line\"><span class=\"number\">114</span>:                     <span class=\"comment\">// æ›´æ–°è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">115</span>:                     ScheduleMessageService.<span class=\"keyword\">this</span>.updateOffset(<span class=\"keyword\">this</span>.delayLevel, nextOffset);</div><div class=\"line\"><span class=\"number\">116</span>:                     <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">117</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">118</span>:                     bufferCQ.release();</div><div class=\"line\"><span class=\"number\">119</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">120</span>:             &#125; <span class=\"comment\">// end of if (bufferCQ != null)</span></div><div class=\"line\"><span class=\"number\">121</span>:             <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æ¶ˆè´¹é˜Ÿåˆ—å·²ç»è¢«åˆ é™¤éƒ¨åˆ†ï¼Œè·³è½¬åˆ°æœ€å°çš„æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">122</span>:                 <span class=\"keyword\">long</span> cqMinOffset = cq.getMinOffsetInQueue();</div><div class=\"line\"><span class=\"number\">123</span>:                 <span class=\"keyword\">if</span> (offset &lt; cqMinOffset) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:                     failScheduleOffset = cqMinOffset;</div><div class=\"line\"><span class=\"number\">125</span>:                     log.error(<span class=\"string\">\"schedule CQ offset invalid. offset=\"</span> + offset + <span class=\"string\">\", cqMinOffset=\"</span></div><div class=\"line\"><span class=\"number\">126</span>:                         + cqMinOffset + <span class=\"string\">\", queueId=\"</span> + cq.getQueueId());</div><div class=\"line\"><span class=\"number\">127</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">128</span>:             &#125;</div><div class=\"line\"><span class=\"number\">129</span>:         &#125; <span class=\"comment\">// end of if (cq != null)</span></div><div class=\"line\"><span class=\"number\">130</span>: </div><div class=\"line\"><span class=\"number\">131</span>:         ScheduleMessageService.<span class=\"keyword\">this</span>.timer.schedule(<span class=\"keyword\">new</span> DeliverDelayedMessageTimerTask(<span class=\"keyword\">this</span>.delayLevel, failScheduleOffset), DELAY_FOR_A_WHILE);</div><div class=\"line\"><span class=\"number\">132</span>:     &#125;</div><div class=\"line\"><span class=\"number\">133</span>: </div><div class=\"line\"><span class=\"number\">134</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">135:      * è®¾ç½®æ¶ˆæ¯å†…å®¹</div><div class=\"line\">136:      *</div><div class=\"line\">137:      * <span class=\"doctag\">@param</span> msgExt æ¶ˆæ¯</div><div class=\"line\">138:      * <span class=\"doctag\">@return</span> æ¶ˆæ¯</div><div class=\"line\">139:      */</div><div class=\"line\"><span class=\"number\">140</span>:     <span class=\"function\"><span class=\"keyword\">private</span> MessageExtBrokerInner <span class=\"title\">messageTimeup</span><span class=\"params\">(MessageExt msgExt)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">141</span>:         MessageExtBrokerInner msgInner = <span class=\"keyword\">new</span> MessageExtBrokerInner();</div><div class=\"line\"><span class=\"number\">142</span>:         msgInner.setBody(msgExt.getBody());</div><div class=\"line\"><span class=\"number\">143</span>:         msgInner.setFlag(msgExt.getFlag());</div><div class=\"line\"><span class=\"number\">144</span>:         MessageAccessor.setProperties(msgInner, msgExt.getProperties());</div><div class=\"line\"><span class=\"number\">145</span>: </div><div class=\"line\"><span class=\"number\">146</span>:         TopicFilterType topicFilterType = MessageExt.parseTopicFilterType(msgInner.getSysFlag());</div><div class=\"line\"><span class=\"number\">147</span>:         <span class=\"keyword\">long</span> tagsCodeValue =</div><div class=\"line\"><span class=\"number\">148</span>:             MessageExtBrokerInner.tagsString2tagsCode(topicFilterType, msgInner.getTags());</div><div class=\"line\"><span class=\"number\">149</span>:         msgInner.setTagsCode(tagsCodeValue);</div><div class=\"line\"><span class=\"number\">150</span>:         msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</div><div class=\"line\"><span class=\"number\">151</span>: </div><div class=\"line\"><span class=\"number\">152</span>:         msgInner.setSysFlag(msgExt.getSysFlag());</div><div class=\"line\"><span class=\"number\">153</span>:         msgInner.setBornTimestamp(msgExt.getBornTimestamp());</div><div class=\"line\"><span class=\"number\">154</span>:         msgInner.setBornHost(msgExt.getBornHost());</div><div class=\"line\"><span class=\"number\">155</span>:         msgInner.setStoreHost(msgExt.getStoreHost());</div><div class=\"line\"><span class=\"number\">156</span>:         msgInner.setReconsumeTimes(msgExt.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">157</span>: </div><div class=\"line\"><span class=\"number\">158</span>:         msgInner.setWaitStoreMsgOK(<span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">159</span>:         MessageAccessor.clearProperty(msgInner, MessageConst.PROPERTY_DELAY_TIME_LEVEL);</div><div class=\"line\"><span class=\"number\">160</span>: </div><div class=\"line\"><span class=\"number\">161</span>:         msgInner.setTopic(msgInner.getProperty(MessageConst.PROPERTY_REAL_TOPIC));</div><div class=\"line\"><span class=\"number\">162</span>: </div><div class=\"line\"><span class=\"number\">163</span>:         String queueIdStr = msgInner.getProperty(MessageConst.PROPERTY_REAL_QUEUE_ID);</div><div class=\"line\"><span class=\"number\">164</span>:         <span class=\"keyword\">int</span> queueId = Integer.parseInt(queueIdStr);</div><div class=\"line\"><span class=\"number\">165</span>:         msgInner.setQueueId(queueId);</div><div class=\"line\"><span class=\"number\">166</span>: </div><div class=\"line\"><span class=\"number\">167</span>:         <span class=\"keyword\">return</span> msgInner;</div><div class=\"line\"><span class=\"number\">168</span>:     &#125;</div><div class=\"line\"><span class=\"number\">169</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-5-Broker-æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦\"><a href=\"#2-5-Broker-æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦\" class=\"headerlink\" title=\"2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦\"></a>2.5 Broker æŒä¹…åŒ–å®šæ—¶å‘é€è¿›åº¦</h2><ul>\n<li>ğŸ¦… å®šæ—¶æ¶ˆæ¯å‘é€è¿›åº¦å­˜å‚¨åœ¨æ–‡ä»¶(<code>../config/delayOffset.json</code>)é‡Œ</li>\n<li>ğŸ¦… æ¯ 10s å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ScheduleMessageService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3: public void start() &#123;</div><div class=\"line\"> 4:     // å®šæ—¶å‘é€æ¶ˆæ¯</div><div class=\"line\"> 5:     for (Map.Entry&lt;Integer, Long&gt; entry : this.delayLevelTable.entrySet()) &#123;</div><div class=\"line\"> 6:         Integer level = entry.getKey();</div><div class=\"line\"> 7:         Long timeDelay = entry.getValue();</div><div class=\"line\"> 8:         Long offset = this.offsetTable.get(level);</div><div class=\"line\"> 9:         if (null == offset) &#123;</div><div class=\"line\">10:             offset = 0L;</div><div class=\"line\">11:         &#125;</div><div class=\"line\">12: </div><div class=\"line\">13:         if (timeDelay != null) &#123;</div><div class=\"line\">14:             this.timer.schedule(new DeliverDelayedMessageTimerTask(level, offset), FIRST_DELAY_TIME);</div><div class=\"line\">15:         &#125;</div><div class=\"line\">16:     &#125;</div><div class=\"line\">17: </div><div class=\"line\">18:     // å®šæ—¶æŒä¹…åŒ–å‘é€è¿›åº¦</div><div class=\"line\">19:     this.timer.scheduleAtFixedRate(new TimerTask() &#123;</div><div class=\"line\">20: </div><div class=\"line\">21:         <span class=\"doctag\">@Override</span></div><div class=\"line\">22:         public void run() &#123;</div><div class=\"line\">23:             try &#123;</div><div class=\"line\">24:                 ScheduleMessageService.this.persist();</div><div class=\"line\">25:             &#125; catch (Exception e) &#123;</div><div class=\"line\">26:                 log.error(\"scheduleAtFixedRate flush exception\", e);</div><div class=\"line\">27:             &#125;</div><div class=\"line\">28:         &#125;</div><div class=\"line\">29:     &#125;, 10000, this.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval());</div><div class=\"line\">30: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-æ¶ˆæ¯é‡è¯•\"><a href=\"#3-æ¶ˆæ¯é‡è¯•\" class=\"headerlink\" title=\"3. æ¶ˆæ¯é‡è¯•\"></a>3. æ¶ˆæ¯é‡è¯•</h1><blockquote>\n<p>Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œè¦æä¾›ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚</p>\n</blockquote>\n<ul>\n<li>ğŸ¦… <code>Consumer</code> å°†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å› <code>Broker</code>ï¼Œè¿›å…¥<strong>å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚å³ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¸ä¼šç«‹å³æ¶ˆè´¹ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€SendMessageProcessor.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 3:  * æ¶ˆè´¹è€…å‘å›æ¶ˆæ¯</div><div class=\"line\"> 4:  *</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> ctx ctx</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> request è¯·æ±‚</div><div class=\"line\"> 7:  * <span class=\"doctag\">@return</span> å“åº”</div><div class=\"line\"> 8:  * <span class=\"doctag\">@throws</span> RemotingCommandException å½“è¿œç¨‹è°ƒç”¨å¼‚å¸¸</div><div class=\"line\"> 9:  */</div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">consumerSendMsgBack</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx, <span class=\"keyword\">final</span> RemotingCommand request)</span></span></div><div class=\"line\">11:     <span class=\"keyword\">throws</span> RemotingCommandException &#123;</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"comment\">// å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚</span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">int</span> delayLevel = requestHeader.getDelayLevel();</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class=\"line\"><span class=\"number\">18</span>:     &#125;</div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">if</span> (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">21</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>:         <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == delayLevel) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:             delayLevel = <span class=\"number\">3</span> + msgExt.getReconsumeTimes();</div><div class=\"line\"><span class=\"number\">24</span>:         &#125;</div><div class=\"line\"><span class=\"number\">25</span>:         msgExt.setDelayTimeLevel(delayLevel);</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"comment\">// ....(çœç•¥ä»£ç )</span></div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">30</span>: &#125;</div></pre></td></tr></table></figure>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯","date":"2017-05-20T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šäº‹åŠ¡æ¶ˆæ¯](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1011-RocketMQæºç è§£æï¼šäº‹åŠ¡æ¶ˆæ¯.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. äº‹åŠ¡æ¶ˆæ¯å‘é€](#)\n\t- [2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯](#)\n\t- [2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚](#)\n\t- [2.3 Broker ç”Ÿæˆ ConsumeQueue](#)\n- [3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥](#)\n\t- [3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘](#)\n\t\t- [3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ](#)\n\t\t\t- [3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog](#)\n\t\t\t- [3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰](#)\n\t\t\t- [3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥](#)\n\t\t\t- [3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰](#)\n\t\t\t- [3.1.1.5 è¡¥å……](#)\n\t\t- [3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“](#)\n\t- [3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘](#)\n\n# 1. æ¦‚è¿°\n\n**å¿…é¡»å¿…é¡»å¿…é¡»** å‰ç½®é˜…è¯»å†…å®¹ï¼š\n\n* [ã€Šäº‹åŠ¡æ¶ˆæ¯ï¼ˆé˜¿é‡Œäº‘ï¼‰ã€‹](https://help.aliyun.com/document_detail/43348.html?spm=5176.doc43490.6.566.Zd5Bl7)\n\n# 2. äº‹åŠ¡æ¶ˆæ¯å‘é€\n\n## 2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯\n\n* æ´»åŠ¨å›¾å¦‚ä¸‹ï¼ˆç»“åˆ `æ ¸å¿ƒä»£ç ` ç†è§£ï¼‰ï¼š\n\n![Producerå‘é€äº‹åŠ¡æ¶ˆæ¯](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Producerå‘é€äº‹åŠ¡æ¶ˆæ¯.png)\n\n* å®ç°ä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘\n  2: /**\n  3:  * å‘é€äº‹åŠ¡æ¶ˆæ¯\n  4:  *\n  5:  * @param msg æ¶ˆæ¯\n  6:  * @param tranExecuter ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨\n  7:  * @param arg ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨å‚æ•°\n  8:  * @return äº‹åŠ¡å‘é€ç»“æœ\n  9:  * @throws MQClientException å½“ Client å‘ç”Ÿå¼‚å¸¸æ—¶\n 10:  */\n 11: public TransactionSendResult sendMessageInTransaction(final Message msg, final LocalTransactionExecuter tranExecuter, final Object arg)\n 12:     throws MQClientException {\n 13:     if (null == tranExecuter) {\n 14:         throw new MQClientException(\"tranExecutor is null\", null);\n 15:     }\n 16:     Validators.checkMessage(msg, this.defaultMQProducer);\n 17: \n 18:     // å‘é€ã€Halfæ¶ˆæ¯ã€‘\n 19:     SendResult sendResult;\n 20:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, \"true\");\n 21:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_PRODUCER_GROUP, this.defaultMQProducer.getProducerGroup());\n 22:     try {\n 23:         sendResult = this.send(msg);\n 24:     } catch (Exception e) {\n 25:         throw new MQClientException(\"send message Exception\", e);\n 26:     }\n 27: \n 28:     // å¤„ç†å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ\n 29:     LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;\n 30:     Throwable localException = null;\n 31:     switch (sendResult.getSendStatus()) {\n 32:         // å‘é€ã€Halfæ¶ˆæ¯ã€‘æˆåŠŸï¼Œæ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘\n 33:         case SEND_OK: {\n 34:             try {\n 35:                 if (sendResult.getTransactionId() != null) { // äº‹åŠ¡ç¼–å·ã€‚ç›®å‰å¼€æºç‰ˆæœ¬æš‚æ—¶æ²¡ç”¨åˆ°ï¼ŒçŒœæƒ³ONSåœ¨ä½¿ç”¨ã€‚\n 36:                     msg.putUserProperty(\"__transactionId__\", sendResult.getTransactionId());\n 37:                 }\n 38: \n 39:                 // æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘\n 40:                 localTransactionState = tranExecuter.executeLocalTransactionBranch(msg, arg);\n 41:                 if (null == localTransactionState) {\n 42:                     localTransactionState = LocalTransactionState.UNKNOW;\n 43:                 }\n 44: \n 45:                 if (localTransactionState != LocalTransactionState.COMMIT_MESSAGE) {\n 46:                     log.info(\"executeLocalTransactionBranch return {}\", localTransactionState);\n 47:                     log.info(msg.toString());\n 48:                 }\n 49:             } catch (Throwable e) {\n 50:                 log.info(\"executeLocalTransactionBranch exception\", e);\n 51:                 log.info(msg.toString());\n 52:                 localException = e;\n 53:             }\n 54:         }\n 55:         break;\n 56:         // å‘é€ã€Halfæ¶ˆæ¯ã€‘å¤±è´¥ï¼Œæ ‡è®°ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€ä¸ºå›æ»š\n 57:         case FLUSH_DISK_TIMEOUT:\n 58:         case FLUSH_SLAVE_TIMEOUT:\n 59:         case SLAVE_NOT_AVAILABLE:\n 60:             localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE;\n 61:             break;\n 62:         default:\n 63:             break;\n 64:     }\n 65: \n 66:     // ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 67:     try {\n 68:         this.endTransaction(sendResult, localTransactionState, localException);\n 69:     } catch (Exception e) {\n 70:         log.warn(\"local transaction execute \" + localTransactionState + \", but end broker transaction failed\", e);\n 71:     }\n 72: \n 73:     // è¿”å›ã€äº‹åŠ¡å‘é€ç»“æœã€‘\n 74:     TransactionSendResult transactionSendResult = new TransactionSendResult();\n 75:     transactionSendResult.setSendStatus(sendResult.getSendStatus());\n 76:     transactionSendResult.setMessageQueue(sendResult.getMessageQueue());\n 77:     transactionSendResult.setMsgId(sendResult.getMsgId());\n 78:     transactionSendResult.setQueueOffset(sendResult.getQueueOffset());\n 79:     transactionSendResult.setTransactionId(sendResult.getTransactionId());\n 80:     transactionSendResult.setLocalTransactionState(localTransactionState);\n 81:     return transactionSendResult;\n 82: }\n 83: \n 84: /**\n 85:  * ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 86:  *\n 87:  * @param sendResult å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ\n 88:  * @param localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€\n 89:  * @param localException æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘äº§ç”Ÿçš„å¼‚å¸¸\n 90:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶\n 91:  * @throws MQBrokerException å½“ Broker å‘ç”Ÿå¼‚å¸¸æ—¶\n 92:  * @throws InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶\n 93:  * @throws UnknownHostException å½“è§£ç æ¶ˆæ¯ç¼–å·å¤±è´¥æ˜¯\n 94:  */\n 95: public void endTransaction(//\n 96:     final SendResult sendResult, //\n 97:     final LocalTransactionState localTransactionState, //\n 98:     final Throwable localException) throws RemotingException, MQBrokerException, InterruptedException, UnknownHostException {\n 99:     // è§£ç æ¶ˆæ¯ç¼–å·\n100:     final MessageId id;\n101:     if (sendResult.getOffsetMsgId() != null) {\n102:         id = MessageDecoder.decodeMessageId(sendResult.getOffsetMsgId());\n103:     } else {\n104:         id = MessageDecoder.decodeMessageId(sendResult.getMsgId());\n105:     }\n106: \n107:     // åˆ›å»ºè¯·æ±‚\n108:     String transactionId = sendResult.getTransactionId();\n109:     final String brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(sendResult.getMessageQueue().getBrokerName());\n110:     EndTransactionRequestHeader requestHeader = new EndTransactionRequestHeader();\n111:     requestHeader.setTransactionId(transactionId);\n112:     requestHeader.setCommitLogOffset(id.getOffset());\n113:     switch (localTransactionState) {\n114:         case COMMIT_MESSAGE:\n115:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);\n116:             break;\n117:         case ROLLBACK_MESSAGE:\n118:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);\n119:             break;\n120:         case UNKNOW:\n121:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);\n122:             break;\n123:         default:\n124:             break;\n125:     }\n126:     requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());\n127:     requestHeader.setTranStateTableOffset(sendResult.getQueueOffset());\n128:     requestHeader.setMsgId(sendResult.getMsgId());\n129:     String remark = localException != null ? (\"executeLocalTransactionBranch exception: \" + localException.toString()) : null;\n130: \n131:     // æäº¤æ¶ˆæ¯ COMMIT / ROLLBACKã€‚ï¼ï¼ï¼é€šä¿¡æ–¹å¼ä¸ºï¼šOnewayï¼ï¼ï¼\n132:     this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, requestHeader, remark, this.defaultMQProducer.getSendMsgTimeout());\n133: }\n```\n\n## 2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚\n\n* ğŸ¦… æŸ¥è¯¢è¯·æ±‚çš„æ¶ˆæ¯ï¼Œè¿›è¡Œ**æäº¤ / å›æ»š**ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€EndTransactionProcessor.javaã€‘\n  2: public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request) throws RemotingCommandException {\n  3:     final RemotingCommand response = RemotingCommand.createResponseCommand(null);\n  4:     final EndTransactionRequestHeader requestHeader = (EndTransactionRequestHeader) request.decodeCommandCustomHeader(EndTransactionRequestHeader.class);\n  5: \n  6:     // çœç•¥ä»£ç  =ã€‹æ‰“å°æ—¥å¿—ï¼ˆåªå¤„ç† COMMIT / ROLLBACKï¼‰\n  7: \n  8:     // æŸ¥è¯¢æäº¤çš„æ¶ˆæ¯\n  9:     final MessageExt msgExt = this.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getCommitLogOffset());\n 10:     if (msgExt != null) {\n 11:         // çœç•¥ä»£ç  =ã€‹æ ¡éªŒæ¶ˆæ¯\n 12: \n 13:         // ç”Ÿæˆæ¶ˆæ¯\n 14:         MessageExtBrokerInner msgInner = this.endMessageTransaction(msgExt);\n 15:         msgInner.setSysFlag(MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), requestHeader.getCommitOrRollback()));\n 16:         msgInner.setQueueOffset(requestHeader.getTranStateTableOffset());\n 17:         msgInner.setPreparedTransactionOffset(requestHeader.getCommitLogOffset());\n 18:         msgInner.setStoreTimestamp(msgExt.getStoreTimestamp());\n 19:         if (MessageSysFlag.TRANSACTION_ROLLBACK_TYPE == requestHeader.getCommitOrRollback()) {\n 20:             msgInner.setBody(null);\n 21:         }\n 22: \n 23:         // å­˜å‚¨ç”Ÿæˆæ¶ˆæ¯\n 24:         final MessageStore messageStore = this.brokerController.getMessageStore();\n 25:         final PutMessageResult putMessageResult = messageStore.putMessage(msgInner);\n 26: \n 27:         // å¤„ç†å­˜å‚¨ç»“æœ\n 28:         if (putMessageResult != null) {\n 29:             switch (putMessageResult.getPutMessageStatus()) {\n 30:                 // Success\n 31:                 case PUT_OK:\n 32:                 case FLUSH_DISK_TIMEOUT:\n 33:                 case FLUSH_SLAVE_TIMEOUT:\n 34:                 case SLAVE_NOT_AVAILABLE:\n 35:                     response.setCode(ResponseCode.SUCCESS);\n 36:                     response.setRemark(null);\n 37:                     break;\n 38:                 // Failed\n 39:                 case CREATE_MAPEDFILE_FAILED:\n 40:                     response.setCode(ResponseCode.SYSTEM_ERROR);\n 41:                     response.setRemark(\"create maped file failed.\");\n 42:                     break;\n 43:                 case MESSAGE_ILLEGAL:\n 44:                 case PROPERTIES_SIZE_EXCEEDED:\n 45:                     response.setCode(ResponseCode.MESSAGE_ILLEGAL);\n 46:                     response.setRemark(\"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.\");\n 47:                     break;\n 48:                 case SERVICE_NOT_AVAILABLE:\n 49:                     response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);\n 50:                     response.setRemark(\"service not available now.\");\n 51:                     break;\n 52:                 case OS_PAGECACHE_BUSY:\n 53:                     response.setCode(ResponseCode.SYSTEM_ERROR);\n 54:                     response.setRemark(\"OS page cache busy, please try another machine\");\n 55:                     break;\n 56:                 case UNKNOWN_ERROR:\n 57:                     response.setCode(ResponseCode.SYSTEM_ERROR);\n 58:                     response.setRemark(\"UNKNOWN_ERROR\");\n 59:                     break;\n 60:                 default:\n 61:                     response.setCode(ResponseCode.SYSTEM_ERROR);\n 62:                     response.setRemark(\"UNKNOWN_ERROR DEFAULT\");\n 63:                     break;\n 64:             }\n 65: \n 66:             return response;\n 67:         } else {\n 68:             response.setCode(ResponseCode.SYSTEM_ERROR);\n 69:             response.setRemark(\"store putMessage return null\");\n 70:         }\n 71:     } else {\n 72:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 73:         response.setRemark(\"find prepared transaction message failed\");\n 74:         return response;\n 75:     }\n 76: \n 77:     return response;\n 78: }\n```\n\n## 2.3 Broker ç”Ÿæˆ ConsumeQueue\n\n* ğŸ¦… äº‹åŠ¡æ¶ˆæ¯ï¼Œæäº¤ï¼ˆ`COMMIT`ï¼‰åæ‰ç”Ÿæˆ `ConsumeQueue`ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMessageStore.javaã€‘\n  2: public void doDispatch(DispatchRequest req) {\n  3:     // éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue\n  4:     final int tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());\n  5:     switch (tranType) {\n  6:         case MessageSysFlag.TRANSACTION_NOT_TYPE: // éäº‹åŠ¡æ¶ˆæ¯\n  7:         case MessageSysFlag.TRANSACTION_COMMIT_TYPE: // äº‹åŠ¡æ¶ˆæ¯COMMIT\n  8:             DefaultMessageStore.this.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),\n  9:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());\n 10:             break;\n 11:         case MessageSysFlag.TRANSACTION_PREPARED_TYPE: // äº‹åŠ¡æ¶ˆæ¯PREPARED\n 12:         case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE: // äº‹åŠ¡æ¶ˆæ¯ROLLBACK\n 13:             break;\n 14:     }\n 15:     // çœç•¥ä»£ç  =ã€‹ å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile\n 16: }\n```\n\n# 3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥\n\n* ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½æ›¾ç»å¼€æºè¿‡ï¼Œç›®å‰ï¼ˆV4.0.0ï¼‰æš‚æœªå¼€æºã€‚å¦‚ä¸‹æ˜¯è¯¥åŠŸèƒ½çš„å¼€æºæƒ…å†µï¼š\n\n| ç‰ˆæœ¬ | ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘ | |\n| --- | --- | --- |\n| å®˜æ–¹V3.0.4 ~ V3.1.4 | åŸºäº æ–‡ä»¶ç³»ç»Ÿ å®ç° | å·²å¼€æº |\n| å®˜æ–¹V3.1.5 ~ V4.0.0 | åŸºäº æ•°æ®åº“ å®ç° | æœªå®Œå…¨å¼€æº |\n\næˆ‘ä»¬æ¥çœ‹çœ‹ä¸¤ç§æƒ…å†µä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\n\n## 3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\n\n### 3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ\n\n> ä»“åº“åœ°å€ï¼šhttps://github.com/YunaiV/rocketmq-3.1.9/tree/release_3.1.4\n\nç›¸è¾ƒäºæ™®é€šæ¶ˆæ¯ï¼Œã€äº‹åŠ¡æ¶ˆæ¯ã€‘å¤šä¾èµ–å¦‚ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š\n\n* **TransactionStateService** ï¼šäº‹åŠ¡çŠ¶æ€æœåŠ¡ï¼Œè´Ÿè´£å¯¹ã€äº‹åŠ¡æ¶ˆæ¯ã€‘è¿›è¡Œç®¡ç†ï¼ŒåŒ…æ‹¬å­˜å‚¨ä¸æ›´æ–°äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ã€å›æŸ¥äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ç­‰ç­‰ã€‚\n* **TranStateTable** ï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ã€‚åŸºäº `MappedFileQueue` å®ç°ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º `~/store/transaction/statetable`ï¼Œæ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | offset | CommitLog ç‰©ç†å­˜å‚¨ä½ç½® | Long | 8 |\n| 2 | size | æ¶ˆæ¯é•¿åº¦ | Int | 4 |\n| 3 | timestamp | æ¶ˆæ¯å­˜å‚¨æ—¶é—´ï¼Œå•ä½ï¼šç§’ | Int | 4 |\n| 4 | producerGroupHash | producerGroup æ±‚ HashCode | Int | 4 |\n| 5 | state | äº‹åŠ¡çŠ¶æ€ | Int | 4 |\n\n* **TranRedoLog** ï¼š`TranStateTable` é‡æ”¾æ—¥å¿—ï¼Œæ¯æ¬¡**å†™æ“ä½œ** `TranStateTable` è®°å½•é‡æ”¾æ—¥å¿—ã€‚å½“ `Broker` å¼‚å¸¸å…³é—­æ—¶ï¼Œä½¿ç”¨ `TranRedoLog` æ¢å¤ `TranStateTable`ã€‚åŸºäº `ConsumeQueue` å®ç°ï¼Œ`Topic` ä¸º `TRANSACTION_REDOLOG_TOPIC_XXXX`ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º `~/store/transaction/redolog`ã€‚\n\n-------\n\nç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š\n\n![Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ.jpeg)\n\n#### 3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog\n\n* ğŸ¦…å­˜å‚¨ã€halfæ¶ˆæ¯ã€‘åˆ° `CommitLog` æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ`queueOffset`ï¼‰ä½¿ç”¨ `TranStateTable` æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ã€‚è¿™æ ·ï¼Œæ¶ˆæ¯å¯ä»¥ç´¢å¼•åˆ°è‡ªå·±å¯¹åº”çš„ `TranStateTable` çš„ä½ç½®å’Œè®°å½•ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultAppendMessageCallback.javaã€‘\n  2: class DefaultAppendMessageCallback implements AppendMessageCallback {\n  3:     public AppendMessageResult doAppend(final long fileFromOffset, final ByteBuffer byteBuffer,  final int maxBlank, final Object msg) {\n  4:         // ...çœç•¥ä»£ç \n  5: \n  6:         // äº‹åŠ¡æ¶ˆæ¯éœ€è¦ç‰¹æ®Šå¤„ç† \n  7:         final int tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());\n  8:         switch (tranType) {\n  9:         case MessageSysFlag.TransactionPreparedType: // æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆqueueOffsetï¼‰ä½¿ç”¨ TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ \n 10:             queueOffset = CommitLog.this.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().get();\n 11:             break;\n 12:         case MessageSysFlag.TransactionRollbackType:\n 13:             queueOffset = msgInner.getQueueOffset();\n 14:             break;\n 15:         case MessageSysFlag.TransactionNotType:\n 16:         case MessageSysFlag.TransactionCommitType:\n 17:         default:\n 18:             break;\n 19:         }\n 20: \n 21:         // ...çœç•¥ä»£ç \n 22: \n 23:         switch (tranType) {\n 24:         case MessageSysFlag.TransactionPreparedType:\n 25:             // æ›´æ–° TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ \n 26:             CommitLog.this.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().incrementAndGet();\n 27:             break;\n 28:         case MessageSysFlag.TransactionRollbackType:\n 29:             break;\n 30:         case MessageSysFlag.TransactionNotType:\n 31:         case MessageSysFlag.TransactionCommitType:\n 32:             // æ›´æ–°ä¸‹ä¸€æ¬¡çš„ConsumeQueueä¿¡æ¯\n 33:             CommitLog.this.topicQueueTable.put(key, ++queueOffset);\n 34:             break;\n 35:         default:\n 36:             break;\n 37:         }\n 38: \n 39:         // è¿”å›ç»“æœ\n 40:         return result;\n 41:     }\n 42: }\n```\n\n#### 3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\n\n* ğŸ¦…å¤„ç†ã€Halfæ¶ˆæ¯ã€‘æ—¶ï¼Œæ–°å¢ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ`TranStateTable`ï¼‰ã€‚\n* ğŸ¦…å¤„ç†ã€Commit / Rollbackæ¶ˆæ¯ã€‘æ—¶ï¼Œæ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ`TranStateTable`ï¼‰ COMMIT / ROLLBACKã€‚\n* ğŸ¦…æ¯æ¬¡**å†™æ“ä½œã€**äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ`TranStateTable`ï¼‰ï¼Œè®°å½•é‡æ”¾æ—¥å¿—ï¼ˆ`TranRedoLog`ï¼‰ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DispatchMessageService.javaã€‘\n  2: private void doDispatch() {\n  3:     if (!this.requestsRead.isEmpty()) {\n  4:         for (DispatchRequest req : this.requestsRead) {\n  5: \n  6:             // ...çœç•¥ä»£ç \n  7: \n  8:             // 2ã€å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\n  9:             if (req.getProducerGroup() != null) {\n 10:                 switch (tranType) {\n 11:                 case MessageSysFlag.TransactionNotType:\n 12:                     break;\n 13:                 case MessageSysFlag.TransactionPreparedType:\n 14:                     // æ–°å¢ ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\n 15:                     DefaultMessageStore.this.getTransactionStateService().appendPreparedTransaction(\n 16:                         req.getCommitLogOffset(), req.getMsgSize(), (int) (req.getStoreTimestamp() / 1000), req.getProducerGroup().hashCode());\n 17:                     break;\n 18:                 case MessageSysFlag.TransactionCommitType:\n 19:                 case MessageSysFlag.TransactionRollbackType:\n 20:                     // æ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰ COMMIT / ROLLBACK\n 21:                     DefaultMessageStore.this.getTransactionStateService().updateTransactionState(\n 22:                         req.getTranStateTableOffset(), req.getPreparedTransactionOffset(), req.getProducerGroup().hashCode(), tranType);\n 23:                     break;\n 24:                 }\n 25:             }\n 26:             // 3ã€è®°å½• TranRedoLog\n 27:             switch (tranType) {\n 28:             case MessageSysFlag.TransactionNotType:\n 29:                 break;\n 30:             case MessageSysFlag.TransactionPreparedType:\n 31:                 // è®°å½• TranRedoLog\n 32:                 DefaultMessageStore.this.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(\n 33:                         req.getCommitLogOffset(), req.getMsgSize(), TransactionStateService.PreparedMessageTagsCode,\n 34:                         req.getStoreTimestamp(), 0L);\n 35:                 break;\n 36:             case MessageSysFlag.TransactionCommitType:\n 37:             case MessageSysFlag.TransactionRollbackType:\n 38:                 // è®°å½• TranRedoLog\n 39:                 DefaultMessageStore.this.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(\n 40:                         req.getCommitLogOffset(), req.getMsgSize(), req.getPreparedTransactionOffset(),\n 41:                         req.getStoreTimestamp(), 0L);\n 42:                 break;\n 43:             }\n 44:         }\n 45: \n 46:         // ...çœç•¥ä»£ç \n 47:     }\n 48: }\n 49: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘\n 50: /**\n 51:  * æ–°å¢äº‹åŠ¡çŠ¶æ€\n 52:  *\n 53:  * @param clOffset commitLog ç‰©ç†ä½ç½®\n 54:  * @param size æ¶ˆæ¯é•¿åº¦\n 55:  * @param timestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´\n 56:  * @param groupHashCode groupHashCode\n 57:  * @return æ˜¯å¦æˆåŠŸ\n 58:  */\n 59: public boolean appendPreparedTransaction(//\n 60:         final long clOffset,//\n 61:         final int size,//\n 62:         final int timestamp,//\n 63:         final int groupHashCode//\n 64: ) {\n 65:     MapedFile mapedFile = this.tranStateTable.getLastMapedFile();\n 66:     if (null == mapedFile) {\n 67:         log.error(\"appendPreparedTransaction: create mapedfile error.\");\n 68:         return false;\n 69:     }\n 70: \n 71:     // é¦–æ¬¡åˆ›å»ºï¼ŒåŠ å…¥å®šæ—¶ä»»åŠ¡ä¸­\n 72:     if (0 == mapedFile.getWrotePostion()) {\n 73:         this.addTimerTask(mapedFile);\n 74:     }\n 75: \n 76:     this.byteBufferAppend.position(0);\n 77:     this.byteBufferAppend.limit(TSStoreUnitSize);\n 78: \n 79:     // Commit Log Offset\n 80:     this.byteBufferAppend.putLong(clOffset);\n 81:     // Message Size\n 82:     this.byteBufferAppend.putInt(size);\n 83:     // Timestamp\n 84:     this.byteBufferAppend.putInt(timestamp);\n 85:     // Producer Group Hashcode\n 86:     this.byteBufferAppend.putInt(groupHashCode);\n 87:     // Transaction State\n 88:     this.byteBufferAppend.putInt(MessageSysFlag.TransactionPreparedType);\n 89: \n 90:     return mapedFile.appendMessage(this.byteBufferAppend.array());\n 91: }\n 92: \n 93: /**\n 94:  * æ›´æ–°äº‹åŠ¡çŠ¶æ€\n 95:  *\n 96:  * @param tsOffset tranStateTable ç‰©ç†ä½ç½®\n 97:  * @param clOffset commitLog ç‰©ç†ä½ç½®\n 98:  * @param groupHashCode groupHashCode\n 99:  * @param state äº‹åŠ¡çŠ¶æ€\n100:  * @return æ˜¯å¦æˆåŠŸ\n101:  */\n102: public boolean updateTransactionState(\n103:         final long tsOffset,\n104:         final long clOffset,\n105:         final int groupHashCode,\n106:         final int state) {\n107:     SelectMapedBufferResult selectMapedBufferResult = this.findTransactionBuffer(tsOffset);\n108:     if (selectMapedBufferResult != null) {\n109:         try {\n110: \n111:             // ....çœç•¥ä»£ç ï¼šæ ¡éªŒæ˜¯å¦èƒ½å¤Ÿæ›´æ–°\n112: \n113:             // æ›´æ–°äº‹åŠ¡çŠ¶æ€\n114:             selectMapedBufferResult.getByteBuffer().putInt(TS_STATE_POS, state);\n115:         }\n116:         catch (Exception e) {\n117:             log.error(\"updateTransactionState exception\", e);\n118:         }\n119:         finally {\n120:             selectMapedBufferResult.release();\n121:         }\n122:     }\n123: \n124:     return false;\n125: }\n```\n\n#### 3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥\n\n* ğŸ¦…`TranStateTable` æ¯ä¸ª `MappedFile` éƒ½å¯¹åº”ä¸€ä¸ª `Timer`ã€‚`Timer` å›ºå®šå‘¨æœŸï¼ˆé»˜è®¤ï¼š60sï¼‰éå† `MappedFile`ï¼ŒæŸ¥æ‰¾ã€halfæ¶ˆæ¯ã€‘ï¼Œå‘ `Producer` å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥è¯·æ±‚ã€‚ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥ç»“æœçš„é€»è¾‘ä¸åœ¨æ­¤å¤„è¿›è¡Œï¼Œåœ¨ [CommitLog dispatch](#3112-å†™äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€å­˜å‚¨transtatetable)æ—¶æ‰§è¡Œã€‚\n\nå®ç°ä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘\n  2: /**\n  3:  * åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡\n  4:  */\n  5: private void initTimerTask() {\n  6:     //\n  7:     final List<MapedFile> mapedFiles = this.tranStateTable.getMapedFiles();\n  8:     for (MapedFile mf : mapedFiles) {\n  9:         this.addTimerTask(mf);\n 10:     }\n 11: }\n 12: \n 13: /**\n 14:  * æ¯ä¸ªæ–‡ä»¶åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡\n 15:  * @param mf æ–‡ä»¶\n 16:  */\n 17: private void addTimerTask(final MapedFile mf) {\n 18:     this.timer.scheduleAtFixedRate(new TimerTask() {\n 19:         private final MapedFile mapedFile = mf;\n 20:         private final TransactionCheckExecuter transactionCheckExecuter = TransactionStateService.this.defaultMessageStore.getTransactionCheckExecuter();\n 21:         private final long checkTransactionMessageAtleastInterval = TransactionStateService.this.defaultMessageStore.getMessageStoreConfig()\n 22:                     .getCheckTransactionMessageAtleastInterval();\n 23:         private final boolean slave = TransactionStateService.this.defaultMessageStore.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE;\n 24: \n 25:         @Override\n 26:         public void run() {\n 27:             // Slaveä¸éœ€è¦å›æŸ¥äº‹åŠ¡çŠ¶æ€\n 28:             if (slave) {\n 29:                 return;\n 30:             }\n 31:             // CheckåŠŸèƒ½æ˜¯å¦å¼€å¯\n 32:             if (!TransactionStateService.this.defaultMessageStore.getMessageStoreConfig()\n 33:                 .isCheckTransactionMessageEnable()) {\n 34:                 return;\n 35:             }\n 36: \n 37:             try {\n 38:                 SelectMapedBufferResult selectMapedBufferResult = mapedFile.selectMapedBuffer(0);\n 39:                 if (selectMapedBufferResult != null) {\n 40:                     long preparedMessageCountInThisMapedFile = 0; // å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡\n 41:                     int i = 0;\n 42:                     try {\n 43:                         // å¾ªç¯æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€ï¼Œå¯¹ã€halfæ¶ˆæ¯ã€‘è¿›è¡Œå›æŸ¥\n 44:                         for (; i < selectMapedBufferResult.getSize(); i += TSStoreUnitSize) {\n 45:                             selectMapedBufferResult.getByteBuffer().position(i);\n 46: \n 47:                             // Commit Log Offset\n 48:                             long clOffset = selectMapedBufferResult.getByteBuffer().getLong();\n 49:                             // Message Size\n 50:                             int msgSize = selectMapedBufferResult.getByteBuffer().getInt();\n 51:                             // Timestamp\n 52:                             int timestamp = selectMapedBufferResult.getByteBuffer().getInt();\n 53:                             // Producer Group Hashcode\n 54:                             int groupHashCode = selectMapedBufferResult.getByteBuffer().getInt();\n 55:                             // Transaction State\n 56:                             int tranType = selectMapedBufferResult.getByteBuffer().getInt();\n 57: \n 58:                             // å·²ç»æäº¤æˆ–è€…å›æ»šçš„æ¶ˆæ¯è·³è¿‡\n 59:                             if (tranType != MessageSysFlag.TransactionPreparedType) {\n 60:                                 continue;\n 61:                             }\n 62: \n 63:                             // é‡åˆ°æ—¶é—´ä¸ç¬¦åˆæœ€å°è½®è¯¢é—´éš”ï¼Œç»ˆæ­¢\n 64:                             long timestampLong = timestamp * 1000;\n 65:                             long diff = System.currentTimeMillis() - timestampLong;\n 66:                             if (diff < checkTransactionMessageAtleastInterval) {\n 67:                                 break;\n 68:                             }\n 69: \n 70:                             preparedMessageCountInThisMapedFile++;\n 71: \n 72:                             // å›æŸ¥Producer\n 73:                             try {\n 74:                                 this.transactionCheckExecuter.gotoCheck(groupHashCode, getTranStateOffset(i), clOffset, msgSize);\n 75:                             } catch (Exception e) {\n 76:                                 tranlog.warn(\"gotoCheck Exception\", e);\n 77:                             }\n 78:                         }\n 79: \n 80:                         // æ— å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡ï¼Œä¸”éå†å®Œï¼Œåˆ™ç»ˆæ­¢å®šæ—¶ä»»åŠ¡\n 81:                         if (0 == preparedMessageCountInThisMapedFile //\n 82:                                 && i == mapedFile.getFileSize()) {\n 83:                             tranlog.info(\"remove the transaction timer task, because no prepared message in this mapedfile[{}]\", mapedFile.getFileName());\n 84:                             this.cancel();\n 85:                         }\n 86:                     } finally {\n 87:                         selectMapedBufferResult.release();\n 88:                     }\n 89: \n 90:                     tranlog.info(\"the transaction timer task execute over in this period, {} Prepared Message: {} Check Progress: {}/{}\", mapedFile.getFileName(),//\n 91:                             preparedMessageCountInThisMapedFile, i / TSStoreUnitSize, mapedFile.getFileSize() / TSStoreUnitSize);\n 92:                 } else if (mapedFile.isFull()) {\n 93:                     tranlog.info(\"the mapedfile[{}] maybe deleted, cancel check transaction timer task\", mapedFile.getFileName());\n 94:                     this.cancel();\n 95:                     return;\n 96:                 }\n 97:             } catch (Exception e) {\n 98:                 log.error(\"check transaction timer task Exception\", e);\n 99:             }\n100:         }\n101: \n102: \n103:         private long getTranStateOffset(final long currentIndex) {\n104:             long offset = (this.mapedFile.getFileFromOffset() + currentIndex) / TransactionStateService.TSStoreUnitSize;\n105:             return offset;\n106:         }\n107:     }, 1000 * 60, this.defaultMessageStore.getMessageStoreConfig().getCheckTransactionMessageTimerInterval());\n108: }\n109: \n110: // ã€DefaultTransactionCheckExecuter.javaã€‘\n111: @Override\n112: public void gotoCheck(int producerGroupHashCode, long tranStateTableOffset, long commitLogOffset,\n113:         int msgSize) {\n114:     // ç¬¬ä¸€æ­¥ã€æŸ¥è¯¢Producer\n115:     final ClientChannelInfo clientChannelInfo = this.brokerController.getProducerManager().pickProducerChannelRandomly(producerGroupHashCode);\n116:     if (null == clientChannelInfo) {\n117:         log.warn(\"check a producer transaction state, but not find any channel of this group[{}]\", producerGroupHashCode);\n118:         return;\n119:     }\n120: \n121:     // ç¬¬äºŒæ­¥ã€æŸ¥è¯¢æ¶ˆæ¯\n122:     SelectMapedBufferResult selectMapedBufferResult = this.brokerController.getMessageStore().selectOneMessageByOffset(commitLogOffset, msgSize);\n123:     if (null == selectMapedBufferResult) {\n124:         log.warn(\"check a producer transaction state, but not find message by commitLogOffset: {}, msgSize: \", commitLogOffset, msgSize);\n125:         return;\n126:     }\n127: \n128:     // ç¬¬ä¸‰æ­¥ã€å‘Producerå‘èµ·è¯·æ±‚\n129:     final CheckTransactionStateRequestHeader requestHeader = new CheckTransactionStateRequestHeader();\n130:     requestHeader.setCommitLogOffset(commitLogOffset);\n131:     requestHeader.setTranStateTableOffset(tranStateTableOffset);\n132:     this.brokerController.getBroker2Client().checkProducerTransactionState(clientChannelInfo.getChannel(), requestHeader, selectMapedBufferResult);\n133: }\n```\n\n#### 3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\n\n* ğŸ¦…æ ¹æ®æœ€å Broker å…³é—­æ˜¯å¦æ­£å¸¸ï¼Œä¼šæœ‰ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘\n  2: /**\n  3:  * åˆå§‹åŒ– TranRedoLog\n  4:  * @param lastExitOK æ˜¯å¦æ­£å¸¸é€€å‡º\n  5:  */\n  6: public void recoverStateTable(final boolean lastExitOK) {\n  7:     if (lastExitOK) {\n  8:         this.recoverStateTableNormal();\n  9:     } else {\n 10:         // ç¬¬ä¸€æ­¥ï¼Œåˆ é™¤State Table\n 11:         this.tranStateTable.destroy();\n 12:         // ç¬¬äºŒæ­¥ï¼Œé€šè¿‡RedoLogå…¨é‡æ¢å¤StateTable\n 13:         this.recreateStateTable();\n 14:     }\n 15: }\n 16: \n 17: /**\n 18:  * æ‰«æ TranRedoLog é‡å»º StateTable\n 19:  */\n 20: private void recreateStateTable() {\n 21:     this.tranStateTable = new MapedFileQueue(StorePathConfigHelper.getTranStateTableStorePath(defaultMessageStore\n 22:                 .getMessageStoreConfig().getStorePathRootDir()), defaultMessageStore\n 23:                 .getMessageStoreConfig().getTranStateTableMapedFileSize(), null);\n 24: \n 25:     final TreeSet<Long> preparedItemSet = new TreeSet<Long>();\n 26: \n 27:     // ç¬¬ä¸€æ­¥ï¼Œä»å¤´æ‰«æRedoLog\n 28:     final long minOffset = this.tranRedoLog.getMinOffsetInQuque();\n 29:     long processOffset = minOffset;\n 30:     while (true) {\n 31:         SelectMapedBufferResult bufferConsumeQueue = this.tranRedoLog.getIndexBuffer(processOffset);\n 32:         if (bufferConsumeQueue != null) {\n 33:             try {\n 34:                 long i = 0;\n 35:                 for (; i < bufferConsumeQueue.getSize(); i += ConsumeQueue.CQStoreUnitSize) {\n 36:                     long offsetMsg = bufferConsumeQueue.getByteBuffer().getLong();\n 37:                     int sizeMsg = bufferConsumeQueue.getByteBuffer().getInt();\n 38:                     long tagsCode = bufferConsumeQueue.getByteBuffer().getLong();\n 39: \n 40:                     if (TransactionStateService.PreparedMessageTagsCode == tagsCode) { // Prepared\n 41:                         preparedItemSet.add(offsetMsg);\n 42:                     } else { // Commit/Rollback\n 43:                         preparedItemSet.remove(tagsCode);\n 44:                     }\n 45:                 }\n 46: \n 47:                 processOffset += i;\n 48:             } finally { // å¿…é¡»é‡Šæ”¾èµ„æº\n 49:                 bufferConsumeQueue.release();\n 50:             }\n 51:         } else {\n 52:             break;\n 53:         }\n 54:     }\n 55:     log.info(\"scan transaction redolog over, End offset: {},  Prepared Transaction Count: {}\", processOffset, preparedItemSet.size());\n 56: \n 57:     // ç¬¬äºŒæ­¥ï¼Œé‡å»ºStateTable\n 58:     Iterator<Long> it = preparedItemSet.iterator();\n 59:     while (it.hasNext()) {\n 60:         Long offset = it.next();\n 61:         MessageExt msgExt = this.defaultMessageStore.lookMessageByOffset(offset);\n 62:         if (msgExt != null) {\n 63:             this.appendPreparedTransaction(msgExt.getCommitLogOffset(), msgExt.getStoreSize(),\n 64:                 (int) (msgExt.getStoreTimestamp() / 1000),\n 65:                 msgExt.getProperty(MessageConst.PROPERTY_PRODUCER_GROUP).hashCode());\n 66:             this.tranStateTableOffset.incrementAndGet();\n 67:         }\n 68:     }\n 69: }\n 70: \n 71: /**\n 72:  * åŠ è½½ï¼ˆè§£æï¼‰TranStateTable çš„ MappedFile\n 73:  * 1. æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position\n 74:  * 2. è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰\n 75:  */\n 76: private void recoverStateTableNormal() {\n 77:     final List<MapedFile> mapedFiles = this.tranStateTable.getMapedFiles();\n 78:     if (!mapedFiles.isEmpty()) {\n 79:         // ä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹æ¢å¤\n 80:         int index = mapedFiles.size() - 3;\n 81:         if (index < 0) {\n 82:             index = 0;\n 83:         }\n 84: \n 85:         int mapedFileSizeLogics = this.tranStateTable.getMapedFileSize();\n 86:         MapedFile mapedFile = mapedFiles.get(index);\n 87:         ByteBuffer byteBuffer = mapedFile.sliceByteBuffer();\n 88:         long processOffset = mapedFile.getFileFromOffset();\n 89:         long mapedFileOffset = 0;\n 90:         while (true) {\n 91:             for (int i = 0; i < mapedFileSizeLogics; i += TSStoreUnitSize) {\n 92: \n 93:                 final long clOffset_read = byteBuffer.getLong();\n 94:                 final int size_read = byteBuffer.getInt();\n 95:                 final int timestamp_read = byteBuffer.getInt();\n 96:                 final int groupHashCode_read = byteBuffer.getInt();\n 97:                 final int state_read = byteBuffer.getInt();\n 98: \n 99:                 boolean stateOK = false;\n100:                 switch (state_read) {\n101:                 case MessageSysFlag.TransactionPreparedType:\n102:                 case MessageSysFlag.TransactionCommitType:\n103:                 case MessageSysFlag.TransactionRollbackType:\n104:                     stateOK = true;\n105:                     break;\n106:                 default:\n107:                     break;\n108:                 }\n109: \n110:                 // è¯´æ˜å½“å‰å­˜å‚¨å•å…ƒæœ‰æ•ˆ\n111:                 if (clOffset_read >= 0 && size_read > 0 && stateOK) {\n112:                     mapedFileOffset = i + TSStoreUnitSize;\n113:                 } else {\n114:                     log.info(\"recover current transaction state table file over,  \" + mapedFile.getFileName() + \" \"\n115:                             + clOffset_read + \" \" + size_read + \" \" + timestamp_read);\n116:                     break;\n117:                 }\n118:             }\n119: \n120:             // èµ°åˆ°æ–‡ä»¶æœ«å°¾ï¼Œåˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªæ–‡ä»¶\n121:             if (mapedFileOffset == mapedFileSizeLogics) {\n122:                 index++;\n123:                 if (index >= mapedFiles.size()) { // å¾ªç¯whileç»“æŸ\n124:                     log.info(\"recover last transaction state table file over, last maped file \" + mapedFile.getFileName());\n125:                     break;\n126:                 } else { // åˆ‡æ¢ä¸‹ä¸€ä¸ªæ–‡ä»¶\n127:                     mapedFile = mapedFiles.get(index);\n128:                     byteBuffer = mapedFile.sliceByteBuffer();\n129:                     processOffset = mapedFile.getFileFromOffset();\n130:                     mapedFileOffset = 0;\n131:                     log.info(\"recover next transaction state table file, \" + mapedFile.getFileName());\n132:                 }\n133:             } else {\n134:                 log.info(\"recover current transaction state table queue over \" + mapedFile.getFileName() + \" \" + (processOffset + mapedFileOffset));\n135:                 break;\n136:             }\n137:         }\n138: \n139:         // æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position\n140:         processOffset += mapedFileOffset;\n141:         this.tranStateTable.truncateDirtyFiles(processOffset);\n142: \n143:         // è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰\n144:         this.tranStateTableOffset.set(this.tranStateTable.getMaxOffset() / TSStoreUnitSize);\n145:         log.info(\"recover normal over, transaction state table max offset: {}\", this.tranStateTableOffset.get());\n146:     }\n147: }\n```\n\n#### 3.1.1.5 è¡¥å……\n\n* ä¸ºä»€ä¹ˆ V3.1.5 å¼€å§‹ï¼Œä½¿ç”¨ æ•°æ®åº“ å®ç°ã€äº‹åŠ¡çŠ¶æ€ã€‘çš„å­˜å‚¨ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼Œå¯èƒ½æ˜¯ä¸€éƒ¨åˆ†åŸå› ï¼š\n\n> RocketMQ è¿™ç§å®ç°äº‹åŠ¡æ–¹å¼ï¼Œæ²¡æœ‰é€šè¿‡ KV å­˜å‚¨åšï¼Œè€Œæ˜¯é€šè¿‡ Offset æ–¹å¼ï¼Œå­˜åœ¨ä¸€ä¸ªæ˜¾è‘—ç¼ºé™·ï¼Œå³é€šè¿‡ Offset æ›´æ”¹æ•°æ®ï¼Œä¼šä»¤ç³»ç»Ÿçš„è„é¡µè¿‡å¤šï¼Œéœ€è¦ç‰¹åˆ«å…³æ³¨ã€‚\n\n### 3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“\n\n> ä»“åº“åœ°å€ï¼šhttps://github.com/apache/incubator-rocketmq\n\nå®˜æ–¹V4.0.0 æš‚æ—¶æœª**å®Œå…¨**å¼€æºã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½ï¼Œ**So æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›çŒœæƒ³ï¼Œå¯èƒ½ä¸ä¸€å®šæ­£ç¡®ğŸ˜ˆ**ã€‚\n\nğŸ˜†æˆ‘ä»¬æ¥å¯¹æ¯”ã€å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ã€‘çš„å®ç°ã€‚\n\n* TransactionRecord ï¼šè®°å½•æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘ã€‚ç±»ä¼¼ `TranStateTable`ã€‚\n\n| TranStateTable | TransactionRecord |  |\n| --- | --- | --- |\n| offset | offset |  |\n| producerGroupHash | producerGroup |  |\n| size | æ—  | éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚ |\n| timestamp | æ—  | éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚ |\n| state | æ—  | éå¿…é¡»å­—æ®µï¼š äº‹åŠ¡å¼€å§‹ï¼Œå¢åŠ è®°å½•ï¼›äº‹åŠ¡ç»“æŸï¼Œåˆ é™¤è®°å½•ã€‚|\n\nå¦å¤–ï¼Œæ•°æ®åº“æœ¬èº«ä¿è¯äº†æ•°æ®å­˜å‚¨çš„å¯é æ€§ï¼Œæ— éœ€ `TranRedoLog`ã€‚\n\n-------\n\nç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š\n\n![Broker_V4.0.0_åŸºäºæ•°æ®åº“](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Broker_V4.0.0_åŸºäºæ•°æ®åº“.jpeg)\n\n## 3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\n\n* é¡ºåºå›¾å¦‚ä¸‹ï¼š\n\n![Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘.png)\n\n* æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘\n  2: /**\n  3:  * æ£€æŸ¥ã€äº‹åŠ¡çŠ¶æ€ã€‘çŠ¶æ€\n  4:  *\n  5:  * @param addr brokeråœ°å€\n  6:  * @param msg æ¶ˆæ¯\n  7:  * @param header è¯·æ±‚\n  8:  */\n  9: @Override\n 10: public void checkTransactionState(final String addr, final MessageExt msg, final CheckTransactionStateRequestHeader header) {\n 11:     Runnable request = new Runnable() {\n 12:         private final String brokerAddr = addr;\n 13:         private final MessageExt message = msg;\n 14:         private final CheckTransactionStateRequestHeader checkRequestHeader = header;\n 15:         private final String group = DefaultMQProducerImpl.this.defaultMQProducer.getProducerGroup();\n 16: \n 17:         @Override\n 18:         public void run() {\n 19:             TransactionCheckListener transactionCheckListener = DefaultMQProducerImpl.this.checkListener();\n 20:             if (transactionCheckListener != null) {\n 21:                 // è·å–äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€\n 22:                 LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;\n 23:                 Throwable exception = null;\n 24:                 try {\n 25:                     localTransactionState = transactionCheckListener.checkLocalTransactionState(message);\n 26:                 } catch (Throwable e) {\n 27:                     log.error(\"Broker call checkTransactionState, but checkLocalTransactionState exception\", e);\n 28:                     exception = e;\n 29:                 }\n 30: \n 31:                 // å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 32:                 this.processTransactionState(//\n 33:                     localTransactionState, //\n 34:                     group, //\n 35:                     exception);\n 36:             } else {\n 37:                 log.warn(\"checkTransactionState, pick transactionCheckListener by group[{}] failed\", group);\n 38:             }\n 39:         }\n 40: \n 41:         /**\n 42:          * å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 43:          *\n 44:          * @param localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€\n 45:          * @param producerGroup producerGroup\n 46:          * @param exception æ£€æŸ¥ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€å‘ç”Ÿçš„å¼‚å¸¸\n 47:          */\n 48:         private void processTransactionState(//\n 49:             final LocalTransactionState localTransactionState, //\n 50:             final String producerGroup, //\n 51:             final Throwable exception) {\n 52:             final EndTransactionRequestHeader thisHeader = new EndTransactionRequestHeader();\n 53:             thisHeader.setCommitLogOffset(checkRequestHeader.getCommitLogOffset());\n 54:             thisHeader.setProducerGroup(producerGroup);\n 55:             thisHeader.setTranStateTableOffset(checkRequestHeader.getTranStateTableOffset());\n 56:             thisHeader.setFromTransactionCheck(true);\n 57: \n 58:             // è®¾ç½®æ¶ˆæ¯ç¼–å·\n 59:             String uniqueKey = message.getProperties().get(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);\n 60:             if (uniqueKey == null) {\n 61:                 uniqueKey = message.getMsgId();\n 62:             }\n 63:             thisHeader.setMsgId(uniqueKey);\n 64: \n 65:             thisHeader.setTransactionId(checkRequestHeader.getTransactionId());\n 66:             switch (localTransactionState) {\n 67:                 case COMMIT_MESSAGE:\n 68:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);\n 69:                     break;\n 70:                 case ROLLBACK_MESSAGE:\n 71:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);\n 72:                     log.warn(\"when broker check, client rollback this transaction, {}\", thisHeader);\n 73:                     break;\n 74:                 case UNKNOW:\n 75:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);\n 76:                     log.warn(\"when broker check, client does not know this transaction state, {}\", thisHeader);\n 77:                     break;\n 78:                 default:\n 79:                     break;\n 80:             }\n 81: \n 82:             String remark = null;\n 83:             if (exception != null) {\n 84:                 remark = \"checkLocalTransactionState Exception: \" + RemotingHelper.exceptionSimpleDesc(exception);\n 85:             }\n 86: \n 87:             try {\n 88:                 // æäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 89:                 DefaultMQProducerImpl.this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, thisHeader, remark,\n 90:                     3000);\n 91:             } catch (Exception e) {\n 92:                 log.error(\"endTransactionOneway exception\", e);\n 93:             }\n 94:         }\n 95:     };\n 96: \n 97:     // æäº¤æ‰§è¡Œ\n 98:     this.checkExecutor.submit(request);\n 99: }\n100: \n101: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘\n102: /**\n103:  * ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘æ£€æŸ¥ç›‘å¬å™¨\n104:  */\n105: public interface TransactionCheckListener {\n106: \n107:     /**\n108:      * è·å–ï¼ˆæ£€æŸ¥ï¼‰ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€\n109:      *\n110:      * @param msg æ¶ˆæ¯\n111:      * @return äº‹åŠ¡çŠ¶æ€\n112:      */\n113:     LocalTransactionState checkLocalTransactionState(final MessageExt msg);\n114: \n115: }\n```\n\n","source":"_posts/RocketMQ/2017_05_21_RocketMQæºç åˆ†æâ€”â€”äº‹åŠ¡æ¶ˆæ¯.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯\ndate: 2017-05-21\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/message-transaction\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[RocketMQæºç è§£æï¼šäº‹åŠ¡æ¶ˆæ¯](https://github.com/YunaiV/Blog/blob/master/RocketMQ/1011-RocketMQæºç è§£æï¼šäº‹åŠ¡æ¶ˆæ¯.md)  \n> `RocketMQ` **å¸¦æ³¨é‡Š**åœ°å€ ï¼š[YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼šhttps://github.com/YunaiV/Blogã€‚**  \n\n-------\n\n- [1. æ¦‚è¿°](#)\n- [2. äº‹åŠ¡æ¶ˆæ¯å‘é€](#)\n\t- [2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯](#)\n\t- [2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚](#)\n\t- [2.3 Broker ç”Ÿæˆ ConsumeQueue](#)\n- [3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥](#)\n\t- [3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘](#)\n\t\t- [3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ](#)\n\t\t\t- [3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog](#)\n\t\t\t- [3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰](#)\n\t\t\t- [3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥](#)\n\t\t\t- [3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰](#)\n\t\t\t- [3.1.1.5 è¡¥å……](#)\n\t\t- [3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“](#)\n\t- [3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘](#)\n\n# 1. æ¦‚è¿°\n\n**å¿…é¡»å¿…é¡»å¿…é¡»** å‰ç½®é˜…è¯»å†…å®¹ï¼š\n\n* [ã€Šäº‹åŠ¡æ¶ˆæ¯ï¼ˆé˜¿é‡Œäº‘ï¼‰ã€‹](https://help.aliyun.com/document_detail/43348.html?spm=5176.doc43490.6.566.Zd5Bl7)\n\n# 2. äº‹åŠ¡æ¶ˆæ¯å‘é€\n\n## 2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯\n\n* æ´»åŠ¨å›¾å¦‚ä¸‹ï¼ˆç»“åˆ `æ ¸å¿ƒä»£ç ` ç†è§£ï¼‰ï¼š\n\n![Producerå‘é€äº‹åŠ¡æ¶ˆæ¯](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Producerå‘é€äº‹åŠ¡æ¶ˆæ¯.png)\n\n* å®ç°ä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘\n  2: /**\n  3:  * å‘é€äº‹åŠ¡æ¶ˆæ¯\n  4:  *\n  5:  * @param msg æ¶ˆæ¯\n  6:  * @param tranExecuter ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨\n  7:  * @param arg ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨å‚æ•°\n  8:  * @return äº‹åŠ¡å‘é€ç»“æœ\n  9:  * @throws MQClientException å½“ Client å‘ç”Ÿå¼‚å¸¸æ—¶\n 10:  */\n 11: public TransactionSendResult sendMessageInTransaction(final Message msg, final LocalTransactionExecuter tranExecuter, final Object arg)\n 12:     throws MQClientException {\n 13:     if (null == tranExecuter) {\n 14:         throw new MQClientException(\"tranExecutor is null\", null);\n 15:     }\n 16:     Validators.checkMessage(msg, this.defaultMQProducer);\n 17: \n 18:     // å‘é€ã€Halfæ¶ˆæ¯ã€‘\n 19:     SendResult sendResult;\n 20:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, \"true\");\n 21:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_PRODUCER_GROUP, this.defaultMQProducer.getProducerGroup());\n 22:     try {\n 23:         sendResult = this.send(msg);\n 24:     } catch (Exception e) {\n 25:         throw new MQClientException(\"send message Exception\", e);\n 26:     }\n 27: \n 28:     // å¤„ç†å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ\n 29:     LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;\n 30:     Throwable localException = null;\n 31:     switch (sendResult.getSendStatus()) {\n 32:         // å‘é€ã€Halfæ¶ˆæ¯ã€‘æˆåŠŸï¼Œæ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘\n 33:         case SEND_OK: {\n 34:             try {\n 35:                 if (sendResult.getTransactionId() != null) { // äº‹åŠ¡ç¼–å·ã€‚ç›®å‰å¼€æºç‰ˆæœ¬æš‚æ—¶æ²¡ç”¨åˆ°ï¼ŒçŒœæƒ³ONSåœ¨ä½¿ç”¨ã€‚\n 36:                     msg.putUserProperty(\"__transactionId__\", sendResult.getTransactionId());\n 37:                 }\n 38: \n 39:                 // æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘\n 40:                 localTransactionState = tranExecuter.executeLocalTransactionBranch(msg, arg);\n 41:                 if (null == localTransactionState) {\n 42:                     localTransactionState = LocalTransactionState.UNKNOW;\n 43:                 }\n 44: \n 45:                 if (localTransactionState != LocalTransactionState.COMMIT_MESSAGE) {\n 46:                     log.info(\"executeLocalTransactionBranch return {}\", localTransactionState);\n 47:                     log.info(msg.toString());\n 48:                 }\n 49:             } catch (Throwable e) {\n 50:                 log.info(\"executeLocalTransactionBranch exception\", e);\n 51:                 log.info(msg.toString());\n 52:                 localException = e;\n 53:             }\n 54:         }\n 55:         break;\n 56:         // å‘é€ã€Halfæ¶ˆæ¯ã€‘å¤±è´¥ï¼Œæ ‡è®°ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€ä¸ºå›æ»š\n 57:         case FLUSH_DISK_TIMEOUT:\n 58:         case FLUSH_SLAVE_TIMEOUT:\n 59:         case SLAVE_NOT_AVAILABLE:\n 60:             localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE;\n 61:             break;\n 62:         default:\n 63:             break;\n 64:     }\n 65: \n 66:     // ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 67:     try {\n 68:         this.endTransaction(sendResult, localTransactionState, localException);\n 69:     } catch (Exception e) {\n 70:         log.warn(\"local transaction execute \" + localTransactionState + \", but end broker transaction failed\", e);\n 71:     }\n 72: \n 73:     // è¿”å›ã€äº‹åŠ¡å‘é€ç»“æœã€‘\n 74:     TransactionSendResult transactionSendResult = new TransactionSendResult();\n 75:     transactionSendResult.setSendStatus(sendResult.getSendStatus());\n 76:     transactionSendResult.setMessageQueue(sendResult.getMessageQueue());\n 77:     transactionSendResult.setMsgId(sendResult.getMsgId());\n 78:     transactionSendResult.setQueueOffset(sendResult.getQueueOffset());\n 79:     transactionSendResult.setTransactionId(sendResult.getTransactionId());\n 80:     transactionSendResult.setLocalTransactionState(localTransactionState);\n 81:     return transactionSendResult;\n 82: }\n 83: \n 84: /**\n 85:  * ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 86:  *\n 87:  * @param sendResult å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ\n 88:  * @param localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€\n 89:  * @param localException æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘äº§ç”Ÿçš„å¼‚å¸¸\n 90:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶\n 91:  * @throws MQBrokerException å½“ Broker å‘ç”Ÿå¼‚å¸¸æ—¶\n 92:  * @throws InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶\n 93:  * @throws UnknownHostException å½“è§£ç æ¶ˆæ¯ç¼–å·å¤±è´¥æ˜¯\n 94:  */\n 95: public void endTransaction(//\n 96:     final SendResult sendResult, //\n 97:     final LocalTransactionState localTransactionState, //\n 98:     final Throwable localException) throws RemotingException, MQBrokerException, InterruptedException, UnknownHostException {\n 99:     // è§£ç æ¶ˆæ¯ç¼–å·\n100:     final MessageId id;\n101:     if (sendResult.getOffsetMsgId() != null) {\n102:         id = MessageDecoder.decodeMessageId(sendResult.getOffsetMsgId());\n103:     } else {\n104:         id = MessageDecoder.decodeMessageId(sendResult.getMsgId());\n105:     }\n106: \n107:     // åˆ›å»ºè¯·æ±‚\n108:     String transactionId = sendResult.getTransactionId();\n109:     final String brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(sendResult.getMessageQueue().getBrokerName());\n110:     EndTransactionRequestHeader requestHeader = new EndTransactionRequestHeader();\n111:     requestHeader.setTransactionId(transactionId);\n112:     requestHeader.setCommitLogOffset(id.getOffset());\n113:     switch (localTransactionState) {\n114:         case COMMIT_MESSAGE:\n115:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);\n116:             break;\n117:         case ROLLBACK_MESSAGE:\n118:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);\n119:             break;\n120:         case UNKNOW:\n121:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);\n122:             break;\n123:         default:\n124:             break;\n125:     }\n126:     requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());\n127:     requestHeader.setTranStateTableOffset(sendResult.getQueueOffset());\n128:     requestHeader.setMsgId(sendResult.getMsgId());\n129:     String remark = localException != null ? (\"executeLocalTransactionBranch exception: \" + localException.toString()) : null;\n130: \n131:     // æäº¤æ¶ˆæ¯ COMMIT / ROLLBACKã€‚ï¼ï¼ï¼é€šä¿¡æ–¹å¼ä¸ºï¼šOnewayï¼ï¼ï¼\n132:     this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, requestHeader, remark, this.defaultMQProducer.getSendMsgTimeout());\n133: }\n```\n\n## 2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚\n\n* ğŸ¦… æŸ¥è¯¢è¯·æ±‚çš„æ¶ˆæ¯ï¼Œè¿›è¡Œ**æäº¤ / å›æ»š**ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€EndTransactionProcessor.javaã€‘\n  2: public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request) throws RemotingCommandException {\n  3:     final RemotingCommand response = RemotingCommand.createResponseCommand(null);\n  4:     final EndTransactionRequestHeader requestHeader = (EndTransactionRequestHeader) request.decodeCommandCustomHeader(EndTransactionRequestHeader.class);\n  5: \n  6:     // çœç•¥ä»£ç  =ã€‹æ‰“å°æ—¥å¿—ï¼ˆåªå¤„ç† COMMIT / ROLLBACKï¼‰\n  7: \n  8:     // æŸ¥è¯¢æäº¤çš„æ¶ˆæ¯\n  9:     final MessageExt msgExt = this.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getCommitLogOffset());\n 10:     if (msgExt != null) {\n 11:         // çœç•¥ä»£ç  =ã€‹æ ¡éªŒæ¶ˆæ¯\n 12: \n 13:         // ç”Ÿæˆæ¶ˆæ¯\n 14:         MessageExtBrokerInner msgInner = this.endMessageTransaction(msgExt);\n 15:         msgInner.setSysFlag(MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), requestHeader.getCommitOrRollback()));\n 16:         msgInner.setQueueOffset(requestHeader.getTranStateTableOffset());\n 17:         msgInner.setPreparedTransactionOffset(requestHeader.getCommitLogOffset());\n 18:         msgInner.setStoreTimestamp(msgExt.getStoreTimestamp());\n 19:         if (MessageSysFlag.TRANSACTION_ROLLBACK_TYPE == requestHeader.getCommitOrRollback()) {\n 20:             msgInner.setBody(null);\n 21:         }\n 22: \n 23:         // å­˜å‚¨ç”Ÿæˆæ¶ˆæ¯\n 24:         final MessageStore messageStore = this.brokerController.getMessageStore();\n 25:         final PutMessageResult putMessageResult = messageStore.putMessage(msgInner);\n 26: \n 27:         // å¤„ç†å­˜å‚¨ç»“æœ\n 28:         if (putMessageResult != null) {\n 29:             switch (putMessageResult.getPutMessageStatus()) {\n 30:                 // Success\n 31:                 case PUT_OK:\n 32:                 case FLUSH_DISK_TIMEOUT:\n 33:                 case FLUSH_SLAVE_TIMEOUT:\n 34:                 case SLAVE_NOT_AVAILABLE:\n 35:                     response.setCode(ResponseCode.SUCCESS);\n 36:                     response.setRemark(null);\n 37:                     break;\n 38:                 // Failed\n 39:                 case CREATE_MAPEDFILE_FAILED:\n 40:                     response.setCode(ResponseCode.SYSTEM_ERROR);\n 41:                     response.setRemark(\"create maped file failed.\");\n 42:                     break;\n 43:                 case MESSAGE_ILLEGAL:\n 44:                 case PROPERTIES_SIZE_EXCEEDED:\n 45:                     response.setCode(ResponseCode.MESSAGE_ILLEGAL);\n 46:                     response.setRemark(\"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.\");\n 47:                     break;\n 48:                 case SERVICE_NOT_AVAILABLE:\n 49:                     response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);\n 50:                     response.setRemark(\"service not available now.\");\n 51:                     break;\n 52:                 case OS_PAGECACHE_BUSY:\n 53:                     response.setCode(ResponseCode.SYSTEM_ERROR);\n 54:                     response.setRemark(\"OS page cache busy, please try another machine\");\n 55:                     break;\n 56:                 case UNKNOWN_ERROR:\n 57:                     response.setCode(ResponseCode.SYSTEM_ERROR);\n 58:                     response.setRemark(\"UNKNOWN_ERROR\");\n 59:                     break;\n 60:                 default:\n 61:                     response.setCode(ResponseCode.SYSTEM_ERROR);\n 62:                     response.setRemark(\"UNKNOWN_ERROR DEFAULT\");\n 63:                     break;\n 64:             }\n 65: \n 66:             return response;\n 67:         } else {\n 68:             response.setCode(ResponseCode.SYSTEM_ERROR);\n 69:             response.setRemark(\"store putMessage return null\");\n 70:         }\n 71:     } else {\n 72:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 73:         response.setRemark(\"find prepared transaction message failed\");\n 74:         return response;\n 75:     }\n 76: \n 77:     return response;\n 78: }\n```\n\n## 2.3 Broker ç”Ÿæˆ ConsumeQueue\n\n* ğŸ¦… äº‹åŠ¡æ¶ˆæ¯ï¼Œæäº¤ï¼ˆ`COMMIT`ï¼‰åæ‰ç”Ÿæˆ `ConsumeQueue`ã€‚\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMessageStore.javaã€‘\n  2: public void doDispatch(DispatchRequest req) {\n  3:     // éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue\n  4:     final int tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());\n  5:     switch (tranType) {\n  6:         case MessageSysFlag.TRANSACTION_NOT_TYPE: // éäº‹åŠ¡æ¶ˆæ¯\n  7:         case MessageSysFlag.TRANSACTION_COMMIT_TYPE: // äº‹åŠ¡æ¶ˆæ¯COMMIT\n  8:             DefaultMessageStore.this.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),\n  9:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());\n 10:             break;\n 11:         case MessageSysFlag.TRANSACTION_PREPARED_TYPE: // äº‹åŠ¡æ¶ˆæ¯PREPARED\n 12:         case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE: // äº‹åŠ¡æ¶ˆæ¯ROLLBACK\n 13:             break;\n 14:     }\n 15:     // çœç•¥ä»£ç  =ã€‹ å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile\n 16: }\n```\n\n# 3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥\n\n* ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½æ›¾ç»å¼€æºè¿‡ï¼Œç›®å‰ï¼ˆV4.0.0ï¼‰æš‚æœªå¼€æºã€‚å¦‚ä¸‹æ˜¯è¯¥åŠŸèƒ½çš„å¼€æºæƒ…å†µï¼š\n\n| ç‰ˆæœ¬ | ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘ | |\n| --- | --- | --- |\n| å®˜æ–¹V3.0.4 ~ V3.1.4 | åŸºäº æ–‡ä»¶ç³»ç»Ÿ å®ç° | å·²å¼€æº |\n| å®˜æ–¹V3.1.5 ~ V4.0.0 | åŸºäº æ•°æ®åº“ å®ç° | æœªå®Œå…¨å¼€æº |\n\næˆ‘ä»¬æ¥çœ‹çœ‹ä¸¤ç§æƒ…å†µä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\n\n## 3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\n\n### 3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ\n\n> ä»“åº“åœ°å€ï¼šhttps://github.com/YunaiV/rocketmq-3.1.9/tree/release_3.1.4\n\nç›¸è¾ƒäºæ™®é€šæ¶ˆæ¯ï¼Œã€äº‹åŠ¡æ¶ˆæ¯ã€‘å¤šä¾èµ–å¦‚ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š\n\n* **TransactionStateService** ï¼šäº‹åŠ¡çŠ¶æ€æœåŠ¡ï¼Œè´Ÿè´£å¯¹ã€äº‹åŠ¡æ¶ˆæ¯ã€‘è¿›è¡Œç®¡ç†ï¼ŒåŒ…æ‹¬å­˜å‚¨ä¸æ›´æ–°äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ã€å›æŸ¥äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ç­‰ç­‰ã€‚\n* **TranStateTable** ï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ã€‚åŸºäº `MappedFileQueue` å®ç°ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º `~/store/transaction/statetable`ï¼Œæ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | offset | CommitLog ç‰©ç†å­˜å‚¨ä½ç½® | Long | 8 |\n| 2 | size | æ¶ˆæ¯é•¿åº¦ | Int | 4 |\n| 3 | timestamp | æ¶ˆæ¯å­˜å‚¨æ—¶é—´ï¼Œå•ä½ï¼šç§’ | Int | 4 |\n| 4 | producerGroupHash | producerGroup æ±‚ HashCode | Int | 4 |\n| 5 | state | äº‹åŠ¡çŠ¶æ€ | Int | 4 |\n\n* **TranRedoLog** ï¼š`TranStateTable` é‡æ”¾æ—¥å¿—ï¼Œæ¯æ¬¡**å†™æ“ä½œ** `TranStateTable` è®°å½•é‡æ”¾æ—¥å¿—ã€‚å½“ `Broker` å¼‚å¸¸å…³é—­æ—¶ï¼Œä½¿ç”¨ `TranRedoLog` æ¢å¤ `TranStateTable`ã€‚åŸºäº `ConsumeQueue` å®ç°ï¼Œ`Topic` ä¸º `TRANSACTION_REDOLOG_TOPIC_XXXX`ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º `~/store/transaction/redolog`ã€‚\n\n-------\n\nç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š\n\n![Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ.jpeg)\n\n#### 3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog\n\n* ğŸ¦…å­˜å‚¨ã€halfæ¶ˆæ¯ã€‘åˆ° `CommitLog` æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ`queueOffset`ï¼‰ä½¿ç”¨ `TranStateTable` æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ã€‚è¿™æ ·ï¼Œæ¶ˆæ¯å¯ä»¥ç´¢å¼•åˆ°è‡ªå·±å¯¹åº”çš„ `TranStateTable` çš„ä½ç½®å’Œè®°å½•ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultAppendMessageCallback.javaã€‘\n  2: class DefaultAppendMessageCallback implements AppendMessageCallback {\n  3:     public AppendMessageResult doAppend(final long fileFromOffset, final ByteBuffer byteBuffer,  final int maxBlank, final Object msg) {\n  4:         // ...çœç•¥ä»£ç \n  5: \n  6:         // äº‹åŠ¡æ¶ˆæ¯éœ€è¦ç‰¹æ®Šå¤„ç† \n  7:         final int tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());\n  8:         switch (tranType) {\n  9:         case MessageSysFlag.TransactionPreparedType: // æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆqueueOffsetï¼‰ä½¿ç”¨ TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ \n 10:             queueOffset = CommitLog.this.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().get();\n 11:             break;\n 12:         case MessageSysFlag.TransactionRollbackType:\n 13:             queueOffset = msgInner.getQueueOffset();\n 14:             break;\n 15:         case MessageSysFlag.TransactionNotType:\n 16:         case MessageSysFlag.TransactionCommitType:\n 17:         default:\n 18:             break;\n 19:         }\n 20: \n 21:         // ...çœç•¥ä»£ç \n 22: \n 23:         switch (tranType) {\n 24:         case MessageSysFlag.TransactionPreparedType:\n 25:             // æ›´æ–° TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ \n 26:             CommitLog.this.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().incrementAndGet();\n 27:             break;\n 28:         case MessageSysFlag.TransactionRollbackType:\n 29:             break;\n 30:         case MessageSysFlag.TransactionNotType:\n 31:         case MessageSysFlag.TransactionCommitType:\n 32:             // æ›´æ–°ä¸‹ä¸€æ¬¡çš„ConsumeQueueä¿¡æ¯\n 33:             CommitLog.this.topicQueueTable.put(key, ++queueOffset);\n 34:             break;\n 35:         default:\n 36:             break;\n 37:         }\n 38: \n 39:         // è¿”å›ç»“æœ\n 40:         return result;\n 41:     }\n 42: }\n```\n\n#### 3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\n\n* ğŸ¦…å¤„ç†ã€Halfæ¶ˆæ¯ã€‘æ—¶ï¼Œæ–°å¢ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ`TranStateTable`ï¼‰ã€‚\n* ğŸ¦…å¤„ç†ã€Commit / Rollbackæ¶ˆæ¯ã€‘æ—¶ï¼Œæ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ`TranStateTable`ï¼‰ COMMIT / ROLLBACKã€‚\n* ğŸ¦…æ¯æ¬¡**å†™æ“ä½œã€**äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ`TranStateTable`ï¼‰ï¼Œè®°å½•é‡æ”¾æ—¥å¿—ï¼ˆ`TranRedoLog`ï¼‰ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DispatchMessageService.javaã€‘\n  2: private void doDispatch() {\n  3:     if (!this.requestsRead.isEmpty()) {\n  4:         for (DispatchRequest req : this.requestsRead) {\n  5: \n  6:             // ...çœç•¥ä»£ç \n  7: \n  8:             // 2ã€å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\n  9:             if (req.getProducerGroup() != null) {\n 10:                 switch (tranType) {\n 11:                 case MessageSysFlag.TransactionNotType:\n 12:                     break;\n 13:                 case MessageSysFlag.TransactionPreparedType:\n 14:                     // æ–°å¢ ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\n 15:                     DefaultMessageStore.this.getTransactionStateService().appendPreparedTransaction(\n 16:                         req.getCommitLogOffset(), req.getMsgSize(), (int) (req.getStoreTimestamp() / 1000), req.getProducerGroup().hashCode());\n 17:                     break;\n 18:                 case MessageSysFlag.TransactionCommitType:\n 19:                 case MessageSysFlag.TransactionRollbackType:\n 20:                     // æ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰ COMMIT / ROLLBACK\n 21:                     DefaultMessageStore.this.getTransactionStateService().updateTransactionState(\n 22:                         req.getTranStateTableOffset(), req.getPreparedTransactionOffset(), req.getProducerGroup().hashCode(), tranType);\n 23:                     break;\n 24:                 }\n 25:             }\n 26:             // 3ã€è®°å½• TranRedoLog\n 27:             switch (tranType) {\n 28:             case MessageSysFlag.TransactionNotType:\n 29:                 break;\n 30:             case MessageSysFlag.TransactionPreparedType:\n 31:                 // è®°å½• TranRedoLog\n 32:                 DefaultMessageStore.this.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(\n 33:                         req.getCommitLogOffset(), req.getMsgSize(), TransactionStateService.PreparedMessageTagsCode,\n 34:                         req.getStoreTimestamp(), 0L);\n 35:                 break;\n 36:             case MessageSysFlag.TransactionCommitType:\n 37:             case MessageSysFlag.TransactionRollbackType:\n 38:                 // è®°å½• TranRedoLog\n 39:                 DefaultMessageStore.this.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(\n 40:                         req.getCommitLogOffset(), req.getMsgSize(), req.getPreparedTransactionOffset(),\n 41:                         req.getStoreTimestamp(), 0L);\n 42:                 break;\n 43:             }\n 44:         }\n 45: \n 46:         // ...çœç•¥ä»£ç \n 47:     }\n 48: }\n 49: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘\n 50: /**\n 51:  * æ–°å¢äº‹åŠ¡çŠ¶æ€\n 52:  *\n 53:  * @param clOffset commitLog ç‰©ç†ä½ç½®\n 54:  * @param size æ¶ˆæ¯é•¿åº¦\n 55:  * @param timestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´\n 56:  * @param groupHashCode groupHashCode\n 57:  * @return æ˜¯å¦æˆåŠŸ\n 58:  */\n 59: public boolean appendPreparedTransaction(//\n 60:         final long clOffset,//\n 61:         final int size,//\n 62:         final int timestamp,//\n 63:         final int groupHashCode//\n 64: ) {\n 65:     MapedFile mapedFile = this.tranStateTable.getLastMapedFile();\n 66:     if (null == mapedFile) {\n 67:         log.error(\"appendPreparedTransaction: create mapedfile error.\");\n 68:         return false;\n 69:     }\n 70: \n 71:     // é¦–æ¬¡åˆ›å»ºï¼ŒåŠ å…¥å®šæ—¶ä»»åŠ¡ä¸­\n 72:     if (0 == mapedFile.getWrotePostion()) {\n 73:         this.addTimerTask(mapedFile);\n 74:     }\n 75: \n 76:     this.byteBufferAppend.position(0);\n 77:     this.byteBufferAppend.limit(TSStoreUnitSize);\n 78: \n 79:     // Commit Log Offset\n 80:     this.byteBufferAppend.putLong(clOffset);\n 81:     // Message Size\n 82:     this.byteBufferAppend.putInt(size);\n 83:     // Timestamp\n 84:     this.byteBufferAppend.putInt(timestamp);\n 85:     // Producer Group Hashcode\n 86:     this.byteBufferAppend.putInt(groupHashCode);\n 87:     // Transaction State\n 88:     this.byteBufferAppend.putInt(MessageSysFlag.TransactionPreparedType);\n 89: \n 90:     return mapedFile.appendMessage(this.byteBufferAppend.array());\n 91: }\n 92: \n 93: /**\n 94:  * æ›´æ–°äº‹åŠ¡çŠ¶æ€\n 95:  *\n 96:  * @param tsOffset tranStateTable ç‰©ç†ä½ç½®\n 97:  * @param clOffset commitLog ç‰©ç†ä½ç½®\n 98:  * @param groupHashCode groupHashCode\n 99:  * @param state äº‹åŠ¡çŠ¶æ€\n100:  * @return æ˜¯å¦æˆåŠŸ\n101:  */\n102: public boolean updateTransactionState(\n103:         final long tsOffset,\n104:         final long clOffset,\n105:         final int groupHashCode,\n106:         final int state) {\n107:     SelectMapedBufferResult selectMapedBufferResult = this.findTransactionBuffer(tsOffset);\n108:     if (selectMapedBufferResult != null) {\n109:         try {\n110: \n111:             // ....çœç•¥ä»£ç ï¼šæ ¡éªŒæ˜¯å¦èƒ½å¤Ÿæ›´æ–°\n112: \n113:             // æ›´æ–°äº‹åŠ¡çŠ¶æ€\n114:             selectMapedBufferResult.getByteBuffer().putInt(TS_STATE_POS, state);\n115:         }\n116:         catch (Exception e) {\n117:             log.error(\"updateTransactionState exception\", e);\n118:         }\n119:         finally {\n120:             selectMapedBufferResult.release();\n121:         }\n122:     }\n123: \n124:     return false;\n125: }\n```\n\n#### 3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥\n\n* ğŸ¦…`TranStateTable` æ¯ä¸ª `MappedFile` éƒ½å¯¹åº”ä¸€ä¸ª `Timer`ã€‚`Timer` å›ºå®šå‘¨æœŸï¼ˆé»˜è®¤ï¼š60sï¼‰éå† `MappedFile`ï¼ŒæŸ¥æ‰¾ã€halfæ¶ˆæ¯ã€‘ï¼Œå‘ `Producer` å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥è¯·æ±‚ã€‚ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥ç»“æœçš„é€»è¾‘ä¸åœ¨æ­¤å¤„è¿›è¡Œï¼Œåœ¨ [CommitLog dispatch](#3112-å†™äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€å­˜å‚¨transtatetable)æ—¶æ‰§è¡Œã€‚\n\nå®ç°ä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘\n  2: /**\n  3:  * åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡\n  4:  */\n  5: private void initTimerTask() {\n  6:     //\n  7:     final List<MapedFile> mapedFiles = this.tranStateTable.getMapedFiles();\n  8:     for (MapedFile mf : mapedFiles) {\n  9:         this.addTimerTask(mf);\n 10:     }\n 11: }\n 12: \n 13: /**\n 14:  * æ¯ä¸ªæ–‡ä»¶åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡\n 15:  * @param mf æ–‡ä»¶\n 16:  */\n 17: private void addTimerTask(final MapedFile mf) {\n 18:     this.timer.scheduleAtFixedRate(new TimerTask() {\n 19:         private final MapedFile mapedFile = mf;\n 20:         private final TransactionCheckExecuter transactionCheckExecuter = TransactionStateService.this.defaultMessageStore.getTransactionCheckExecuter();\n 21:         private final long checkTransactionMessageAtleastInterval = TransactionStateService.this.defaultMessageStore.getMessageStoreConfig()\n 22:                     .getCheckTransactionMessageAtleastInterval();\n 23:         private final boolean slave = TransactionStateService.this.defaultMessageStore.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE;\n 24: \n 25:         @Override\n 26:         public void run() {\n 27:             // Slaveä¸éœ€è¦å›æŸ¥äº‹åŠ¡çŠ¶æ€\n 28:             if (slave) {\n 29:                 return;\n 30:             }\n 31:             // CheckåŠŸèƒ½æ˜¯å¦å¼€å¯\n 32:             if (!TransactionStateService.this.defaultMessageStore.getMessageStoreConfig()\n 33:                 .isCheckTransactionMessageEnable()) {\n 34:                 return;\n 35:             }\n 36: \n 37:             try {\n 38:                 SelectMapedBufferResult selectMapedBufferResult = mapedFile.selectMapedBuffer(0);\n 39:                 if (selectMapedBufferResult != null) {\n 40:                     long preparedMessageCountInThisMapedFile = 0; // å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡\n 41:                     int i = 0;\n 42:                     try {\n 43:                         // å¾ªç¯æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€ï¼Œå¯¹ã€halfæ¶ˆæ¯ã€‘è¿›è¡Œå›æŸ¥\n 44:                         for (; i < selectMapedBufferResult.getSize(); i += TSStoreUnitSize) {\n 45:                             selectMapedBufferResult.getByteBuffer().position(i);\n 46: \n 47:                             // Commit Log Offset\n 48:                             long clOffset = selectMapedBufferResult.getByteBuffer().getLong();\n 49:                             // Message Size\n 50:                             int msgSize = selectMapedBufferResult.getByteBuffer().getInt();\n 51:                             // Timestamp\n 52:                             int timestamp = selectMapedBufferResult.getByteBuffer().getInt();\n 53:                             // Producer Group Hashcode\n 54:                             int groupHashCode = selectMapedBufferResult.getByteBuffer().getInt();\n 55:                             // Transaction State\n 56:                             int tranType = selectMapedBufferResult.getByteBuffer().getInt();\n 57: \n 58:                             // å·²ç»æäº¤æˆ–è€…å›æ»šçš„æ¶ˆæ¯è·³è¿‡\n 59:                             if (tranType != MessageSysFlag.TransactionPreparedType) {\n 60:                                 continue;\n 61:                             }\n 62: \n 63:                             // é‡åˆ°æ—¶é—´ä¸ç¬¦åˆæœ€å°è½®è¯¢é—´éš”ï¼Œç»ˆæ­¢\n 64:                             long timestampLong = timestamp * 1000;\n 65:                             long diff = System.currentTimeMillis() - timestampLong;\n 66:                             if (diff < checkTransactionMessageAtleastInterval) {\n 67:                                 break;\n 68:                             }\n 69: \n 70:                             preparedMessageCountInThisMapedFile++;\n 71: \n 72:                             // å›æŸ¥Producer\n 73:                             try {\n 74:                                 this.transactionCheckExecuter.gotoCheck(groupHashCode, getTranStateOffset(i), clOffset, msgSize);\n 75:                             } catch (Exception e) {\n 76:                                 tranlog.warn(\"gotoCheck Exception\", e);\n 77:                             }\n 78:                         }\n 79: \n 80:                         // æ— å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡ï¼Œä¸”éå†å®Œï¼Œåˆ™ç»ˆæ­¢å®šæ—¶ä»»åŠ¡\n 81:                         if (0 == preparedMessageCountInThisMapedFile //\n 82:                                 && i == mapedFile.getFileSize()) {\n 83:                             tranlog.info(\"remove the transaction timer task, because no prepared message in this mapedfile[{}]\", mapedFile.getFileName());\n 84:                             this.cancel();\n 85:                         }\n 86:                     } finally {\n 87:                         selectMapedBufferResult.release();\n 88:                     }\n 89: \n 90:                     tranlog.info(\"the transaction timer task execute over in this period, {} Prepared Message: {} Check Progress: {}/{}\", mapedFile.getFileName(),//\n 91:                             preparedMessageCountInThisMapedFile, i / TSStoreUnitSize, mapedFile.getFileSize() / TSStoreUnitSize);\n 92:                 } else if (mapedFile.isFull()) {\n 93:                     tranlog.info(\"the mapedfile[{}] maybe deleted, cancel check transaction timer task\", mapedFile.getFileName());\n 94:                     this.cancel();\n 95:                     return;\n 96:                 }\n 97:             } catch (Exception e) {\n 98:                 log.error(\"check transaction timer task Exception\", e);\n 99:             }\n100:         }\n101: \n102: \n103:         private long getTranStateOffset(final long currentIndex) {\n104:             long offset = (this.mapedFile.getFileFromOffset() + currentIndex) / TransactionStateService.TSStoreUnitSize;\n105:             return offset;\n106:         }\n107:     }, 1000 * 60, this.defaultMessageStore.getMessageStoreConfig().getCheckTransactionMessageTimerInterval());\n108: }\n109: \n110: // ã€DefaultTransactionCheckExecuter.javaã€‘\n111: @Override\n112: public void gotoCheck(int producerGroupHashCode, long tranStateTableOffset, long commitLogOffset,\n113:         int msgSize) {\n114:     // ç¬¬ä¸€æ­¥ã€æŸ¥è¯¢Producer\n115:     final ClientChannelInfo clientChannelInfo = this.brokerController.getProducerManager().pickProducerChannelRandomly(producerGroupHashCode);\n116:     if (null == clientChannelInfo) {\n117:         log.warn(\"check a producer transaction state, but not find any channel of this group[{}]\", producerGroupHashCode);\n118:         return;\n119:     }\n120: \n121:     // ç¬¬äºŒæ­¥ã€æŸ¥è¯¢æ¶ˆæ¯\n122:     SelectMapedBufferResult selectMapedBufferResult = this.brokerController.getMessageStore().selectOneMessageByOffset(commitLogOffset, msgSize);\n123:     if (null == selectMapedBufferResult) {\n124:         log.warn(\"check a producer transaction state, but not find message by commitLogOffset: {}, msgSize: \", commitLogOffset, msgSize);\n125:         return;\n126:     }\n127: \n128:     // ç¬¬ä¸‰æ­¥ã€å‘Producerå‘èµ·è¯·æ±‚\n129:     final CheckTransactionStateRequestHeader requestHeader = new CheckTransactionStateRequestHeader();\n130:     requestHeader.setCommitLogOffset(commitLogOffset);\n131:     requestHeader.setTranStateTableOffset(tranStateTableOffset);\n132:     this.brokerController.getBroker2Client().checkProducerTransactionState(clientChannelInfo.getChannel(), requestHeader, selectMapedBufferResult);\n133: }\n```\n\n#### 3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\n\n* ğŸ¦…æ ¹æ®æœ€å Broker å…³é—­æ˜¯å¦æ­£å¸¸ï¼Œä¼šæœ‰ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼ã€‚\n\næ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘\n  2: /**\n  3:  * åˆå§‹åŒ– TranRedoLog\n  4:  * @param lastExitOK æ˜¯å¦æ­£å¸¸é€€å‡º\n  5:  */\n  6: public void recoverStateTable(final boolean lastExitOK) {\n  7:     if (lastExitOK) {\n  8:         this.recoverStateTableNormal();\n  9:     } else {\n 10:         // ç¬¬ä¸€æ­¥ï¼Œåˆ é™¤State Table\n 11:         this.tranStateTable.destroy();\n 12:         // ç¬¬äºŒæ­¥ï¼Œé€šè¿‡RedoLogå…¨é‡æ¢å¤StateTable\n 13:         this.recreateStateTable();\n 14:     }\n 15: }\n 16: \n 17: /**\n 18:  * æ‰«æ TranRedoLog é‡å»º StateTable\n 19:  */\n 20: private void recreateStateTable() {\n 21:     this.tranStateTable = new MapedFileQueue(StorePathConfigHelper.getTranStateTableStorePath(defaultMessageStore\n 22:                 .getMessageStoreConfig().getStorePathRootDir()), defaultMessageStore\n 23:                 .getMessageStoreConfig().getTranStateTableMapedFileSize(), null);\n 24: \n 25:     final TreeSet<Long> preparedItemSet = new TreeSet<Long>();\n 26: \n 27:     // ç¬¬ä¸€æ­¥ï¼Œä»å¤´æ‰«æRedoLog\n 28:     final long minOffset = this.tranRedoLog.getMinOffsetInQuque();\n 29:     long processOffset = minOffset;\n 30:     while (true) {\n 31:         SelectMapedBufferResult bufferConsumeQueue = this.tranRedoLog.getIndexBuffer(processOffset);\n 32:         if (bufferConsumeQueue != null) {\n 33:             try {\n 34:                 long i = 0;\n 35:                 for (; i < bufferConsumeQueue.getSize(); i += ConsumeQueue.CQStoreUnitSize) {\n 36:                     long offsetMsg = bufferConsumeQueue.getByteBuffer().getLong();\n 37:                     int sizeMsg = bufferConsumeQueue.getByteBuffer().getInt();\n 38:                     long tagsCode = bufferConsumeQueue.getByteBuffer().getLong();\n 39: \n 40:                     if (TransactionStateService.PreparedMessageTagsCode == tagsCode) { // Prepared\n 41:                         preparedItemSet.add(offsetMsg);\n 42:                     } else { // Commit/Rollback\n 43:                         preparedItemSet.remove(tagsCode);\n 44:                     }\n 45:                 }\n 46: \n 47:                 processOffset += i;\n 48:             } finally { // å¿…é¡»é‡Šæ”¾èµ„æº\n 49:                 bufferConsumeQueue.release();\n 50:             }\n 51:         } else {\n 52:             break;\n 53:         }\n 54:     }\n 55:     log.info(\"scan transaction redolog over, End offset: {},  Prepared Transaction Count: {}\", processOffset, preparedItemSet.size());\n 56: \n 57:     // ç¬¬äºŒæ­¥ï¼Œé‡å»ºStateTable\n 58:     Iterator<Long> it = preparedItemSet.iterator();\n 59:     while (it.hasNext()) {\n 60:         Long offset = it.next();\n 61:         MessageExt msgExt = this.defaultMessageStore.lookMessageByOffset(offset);\n 62:         if (msgExt != null) {\n 63:             this.appendPreparedTransaction(msgExt.getCommitLogOffset(), msgExt.getStoreSize(),\n 64:                 (int) (msgExt.getStoreTimestamp() / 1000),\n 65:                 msgExt.getProperty(MessageConst.PROPERTY_PRODUCER_GROUP).hashCode());\n 66:             this.tranStateTableOffset.incrementAndGet();\n 67:         }\n 68:     }\n 69: }\n 70: \n 71: /**\n 72:  * åŠ è½½ï¼ˆè§£æï¼‰TranStateTable çš„ MappedFile\n 73:  * 1. æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position\n 74:  * 2. è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰\n 75:  */\n 76: private void recoverStateTableNormal() {\n 77:     final List<MapedFile> mapedFiles = this.tranStateTable.getMapedFiles();\n 78:     if (!mapedFiles.isEmpty()) {\n 79:         // ä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹æ¢å¤\n 80:         int index = mapedFiles.size() - 3;\n 81:         if (index < 0) {\n 82:             index = 0;\n 83:         }\n 84: \n 85:         int mapedFileSizeLogics = this.tranStateTable.getMapedFileSize();\n 86:         MapedFile mapedFile = mapedFiles.get(index);\n 87:         ByteBuffer byteBuffer = mapedFile.sliceByteBuffer();\n 88:         long processOffset = mapedFile.getFileFromOffset();\n 89:         long mapedFileOffset = 0;\n 90:         while (true) {\n 91:             for (int i = 0; i < mapedFileSizeLogics; i += TSStoreUnitSize) {\n 92: \n 93:                 final long clOffset_read = byteBuffer.getLong();\n 94:                 final int size_read = byteBuffer.getInt();\n 95:                 final int timestamp_read = byteBuffer.getInt();\n 96:                 final int groupHashCode_read = byteBuffer.getInt();\n 97:                 final int state_read = byteBuffer.getInt();\n 98: \n 99:                 boolean stateOK = false;\n100:                 switch (state_read) {\n101:                 case MessageSysFlag.TransactionPreparedType:\n102:                 case MessageSysFlag.TransactionCommitType:\n103:                 case MessageSysFlag.TransactionRollbackType:\n104:                     stateOK = true;\n105:                     break;\n106:                 default:\n107:                     break;\n108:                 }\n109: \n110:                 // è¯´æ˜å½“å‰å­˜å‚¨å•å…ƒæœ‰æ•ˆ\n111:                 if (clOffset_read >= 0 && size_read > 0 && stateOK) {\n112:                     mapedFileOffset = i + TSStoreUnitSize;\n113:                 } else {\n114:                     log.info(\"recover current transaction state table file over,  \" + mapedFile.getFileName() + \" \"\n115:                             + clOffset_read + \" \" + size_read + \" \" + timestamp_read);\n116:                     break;\n117:                 }\n118:             }\n119: \n120:             // èµ°åˆ°æ–‡ä»¶æœ«å°¾ï¼Œåˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªæ–‡ä»¶\n121:             if (mapedFileOffset == mapedFileSizeLogics) {\n122:                 index++;\n123:                 if (index >= mapedFiles.size()) { // å¾ªç¯whileç»“æŸ\n124:                     log.info(\"recover last transaction state table file over, last maped file \" + mapedFile.getFileName());\n125:                     break;\n126:                 } else { // åˆ‡æ¢ä¸‹ä¸€ä¸ªæ–‡ä»¶\n127:                     mapedFile = mapedFiles.get(index);\n128:                     byteBuffer = mapedFile.sliceByteBuffer();\n129:                     processOffset = mapedFile.getFileFromOffset();\n130:                     mapedFileOffset = 0;\n131:                     log.info(\"recover next transaction state table file, \" + mapedFile.getFileName());\n132:                 }\n133:             } else {\n134:                 log.info(\"recover current transaction state table queue over \" + mapedFile.getFileName() + \" \" + (processOffset + mapedFileOffset));\n135:                 break;\n136:             }\n137:         }\n138: \n139:         // æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position\n140:         processOffset += mapedFileOffset;\n141:         this.tranStateTable.truncateDirtyFiles(processOffset);\n142: \n143:         // è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰\n144:         this.tranStateTableOffset.set(this.tranStateTable.getMaxOffset() / TSStoreUnitSize);\n145:         log.info(\"recover normal over, transaction state table max offset: {}\", this.tranStateTableOffset.get());\n146:     }\n147: }\n```\n\n#### 3.1.1.5 è¡¥å……\n\n* ä¸ºä»€ä¹ˆ V3.1.5 å¼€å§‹ï¼Œä½¿ç”¨ æ•°æ®åº“ å®ç°ã€äº‹åŠ¡çŠ¶æ€ã€‘çš„å­˜å‚¨ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼Œå¯èƒ½æ˜¯ä¸€éƒ¨åˆ†åŸå› ï¼š\n\n> RocketMQ è¿™ç§å®ç°äº‹åŠ¡æ–¹å¼ï¼Œæ²¡æœ‰é€šè¿‡ KV å­˜å‚¨åšï¼Œè€Œæ˜¯é€šè¿‡ Offset æ–¹å¼ï¼Œå­˜åœ¨ä¸€ä¸ªæ˜¾è‘—ç¼ºé™·ï¼Œå³é€šè¿‡ Offset æ›´æ”¹æ•°æ®ï¼Œä¼šä»¤ç³»ç»Ÿçš„è„é¡µè¿‡å¤šï¼Œéœ€è¦ç‰¹åˆ«å…³æ³¨ã€‚\n\n### 3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“\n\n> ä»“åº“åœ°å€ï¼šhttps://github.com/apache/incubator-rocketmq\n\nå®˜æ–¹V4.0.0 æš‚æ—¶æœª**å®Œå…¨**å¼€æºã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½ï¼Œ**So æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›çŒœæƒ³ï¼Œå¯èƒ½ä¸ä¸€å®šæ­£ç¡®ğŸ˜ˆ**ã€‚\n\nğŸ˜†æˆ‘ä»¬æ¥å¯¹æ¯”ã€å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ã€‘çš„å®ç°ã€‚\n\n* TransactionRecord ï¼šè®°å½•æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘ã€‚ç±»ä¼¼ `TranStateTable`ã€‚\n\n| TranStateTable | TransactionRecord |  |\n| --- | --- | --- |\n| offset | offset |  |\n| producerGroupHash | producerGroup |  |\n| size | æ—  | éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚ |\n| timestamp | æ—  | éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚ |\n| state | æ—  | éå¿…é¡»å­—æ®µï¼š äº‹åŠ¡å¼€å§‹ï¼Œå¢åŠ è®°å½•ï¼›äº‹åŠ¡ç»“æŸï¼Œåˆ é™¤è®°å½•ã€‚|\n\nå¦å¤–ï¼Œæ•°æ®åº“æœ¬èº«ä¿è¯äº†æ•°æ®å­˜å‚¨çš„å¯é æ€§ï¼Œæ— éœ€ `TranRedoLog`ã€‚\n\n-------\n\nç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š\n\n![Broker_V4.0.0_åŸºäºæ•°æ®åº“](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Broker_V4.0.0_åŸºäºæ•°æ®åº“.jpeg)\n\n## 3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\n\n* é¡ºåºå›¾å¦‚ä¸‹ï¼š\n\n![Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘](https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘.png)\n\n* æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n\n```Java\n  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘\n  2: /**\n  3:  * æ£€æŸ¥ã€äº‹åŠ¡çŠ¶æ€ã€‘çŠ¶æ€\n  4:  *\n  5:  * @param addr brokeråœ°å€\n  6:  * @param msg æ¶ˆæ¯\n  7:  * @param header è¯·æ±‚\n  8:  */\n  9: @Override\n 10: public void checkTransactionState(final String addr, final MessageExt msg, final CheckTransactionStateRequestHeader header) {\n 11:     Runnable request = new Runnable() {\n 12:         private final String brokerAddr = addr;\n 13:         private final MessageExt message = msg;\n 14:         private final CheckTransactionStateRequestHeader checkRequestHeader = header;\n 15:         private final String group = DefaultMQProducerImpl.this.defaultMQProducer.getProducerGroup();\n 16: \n 17:         @Override\n 18:         public void run() {\n 19:             TransactionCheckListener transactionCheckListener = DefaultMQProducerImpl.this.checkListener();\n 20:             if (transactionCheckListener != null) {\n 21:                 // è·å–äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€\n 22:                 LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;\n 23:                 Throwable exception = null;\n 24:                 try {\n 25:                     localTransactionState = transactionCheckListener.checkLocalTransactionState(message);\n 26:                 } catch (Throwable e) {\n 27:                     log.error(\"Broker call checkTransactionState, but checkLocalTransactionState exception\", e);\n 28:                     exception = e;\n 29:                 }\n 30: \n 31:                 // å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 32:                 this.processTransactionState(//\n 33:                     localTransactionState, //\n 34:                     group, //\n 35:                     exception);\n 36:             } else {\n 37:                 log.warn(\"checkTransactionState, pick transactionCheckListener by group[{}] failed\", group);\n 38:             }\n 39:         }\n 40: \n 41:         /**\n 42:          * å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 43:          *\n 44:          * @param localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€\n 45:          * @param producerGroup producerGroup\n 46:          * @param exception æ£€æŸ¥ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€å‘ç”Ÿçš„å¼‚å¸¸\n 47:          */\n 48:         private void processTransactionState(//\n 49:             final LocalTransactionState localTransactionState, //\n 50:             final String producerGroup, //\n 51:             final Throwable exception) {\n 52:             final EndTransactionRequestHeader thisHeader = new EndTransactionRequestHeader();\n 53:             thisHeader.setCommitLogOffset(checkRequestHeader.getCommitLogOffset());\n 54:             thisHeader.setProducerGroup(producerGroup);\n 55:             thisHeader.setTranStateTableOffset(checkRequestHeader.getTranStateTableOffset());\n 56:             thisHeader.setFromTransactionCheck(true);\n 57: \n 58:             // è®¾ç½®æ¶ˆæ¯ç¼–å·\n 59:             String uniqueKey = message.getProperties().get(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);\n 60:             if (uniqueKey == null) {\n 61:                 uniqueKey = message.getMsgId();\n 62:             }\n 63:             thisHeader.setMsgId(uniqueKey);\n 64: \n 65:             thisHeader.setTransactionId(checkRequestHeader.getTransactionId());\n 66:             switch (localTransactionState) {\n 67:                 case COMMIT_MESSAGE:\n 68:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);\n 69:                     break;\n 70:                 case ROLLBACK_MESSAGE:\n 71:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);\n 72:                     log.warn(\"when broker check, client rollback this transaction, {}\", thisHeader);\n 73:                     break;\n 74:                 case UNKNOW:\n 75:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);\n 76:                     log.warn(\"when broker check, client does not know this transaction state, {}\", thisHeader);\n 77:                     break;\n 78:                 default:\n 79:                     break;\n 80:             }\n 81: \n 82:             String remark = null;\n 83:             if (exception != null) {\n 84:                 remark = \"checkLocalTransactionState Exception: \" + RemotingHelper.exceptionSimpleDesc(exception);\n 85:             }\n 86: \n 87:             try {\n 88:                 // æäº¤æ¶ˆæ¯ COMMIT / ROLLBACK\n 89:                 DefaultMQProducerImpl.this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, thisHeader, remark,\n 90:                     3000);\n 91:             } catch (Exception e) {\n 92:                 log.error(\"endTransactionOneway exception\", e);\n 93:             }\n 94:         }\n 95:     };\n 96: \n 97:     // æäº¤æ‰§è¡Œ\n 98:     this.checkExecutor.submit(request);\n 99: }\n100: \n101: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘\n102: /**\n103:  * ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘æ£€æŸ¥ç›‘å¬å™¨\n104:  */\n105: public interface TransactionCheckListener {\n106: \n107:     /**\n108:      * è·å–ï¼ˆæ£€æŸ¥ï¼‰ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€\n109:      *\n110:      * @param msg æ¶ˆæ¯\n111:      * @return äº‹åŠ¡çŠ¶æ€\n112:      */\n113:     LocalTransactionState checkLocalTransactionState(final MessageExt msg);\n114: \n115: }\n```\n\n","slug":"RocketMQ/message-transaction","published":1,"updated":"2017-06-07T18:42:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj3ndswzp0015ak5dhn54abq7","content":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1011-RocketMQæºç è§£æï¼šäº‹åŠ¡æ¶ˆæ¯.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šäº‹åŠ¡æ¶ˆæ¯</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. äº‹åŠ¡æ¶ˆæ¯å‘é€</a><ul>\n<li><a href=\"#\">2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯</a></li>\n<li><a href=\"#\">2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚</a></li>\n<li><a href=\"#\">2.3 Broker ç”Ÿæˆ ConsumeQueue</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥</a><ul>\n<li><a href=\"#\">3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</a><ul>\n<li><a href=\"#\">3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ</a><ul>\n<li><a href=\"#\">3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog</a></li>\n<li><a href=\"#\">3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</a></li>\n<li><a href=\"#\">3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥</a></li>\n<li><a href=\"#\">3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</a></li>\n<li><a href=\"#\">3.1.1.5 è¡¥å……</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</a></li>\n</ul>\n</li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p><strong>å¿…é¡»å¿…é¡»å¿…é¡»</strong> å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>\n<ul>\n<li><a href=\"https://help.aliyun.com/document_detail/43348.html?spm=5176.doc43490.6.566.Zd5Bl7\" target=\"_blank\" rel=\"external\">ã€Šäº‹åŠ¡æ¶ˆæ¯ï¼ˆé˜¿é‡Œäº‘ï¼‰ã€‹</a></li>\n</ul>\n<h1 id=\"2-äº‹åŠ¡æ¶ˆæ¯å‘é€\"><a href=\"#2-äº‹åŠ¡æ¶ˆæ¯å‘é€\" class=\"headerlink\" title=\"2. äº‹åŠ¡æ¶ˆæ¯å‘é€\"></a>2. äº‹åŠ¡æ¶ˆæ¯å‘é€</h1><h2 id=\"2-1-Producer-å‘é€äº‹åŠ¡æ¶ˆæ¯\"><a href=\"#2-1-Producer-å‘é€äº‹åŠ¡æ¶ˆæ¯\" class=\"headerlink\" title=\"2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯\"></a>2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯</h2><ul>\n<li>æ´»åŠ¨å›¾å¦‚ä¸‹ï¼ˆç»“åˆ <code>æ ¸å¿ƒä»£ç </code> ç†è§£ï¼‰ï¼š</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Producerå‘é€äº‹åŠ¡æ¶ˆæ¯.png\" alt=\"Producerå‘é€äº‹åŠ¡æ¶ˆæ¯\"></p>\n<ul>\n<li>å®ç°ä»£ç å¦‚ä¸‹ï¼š</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * å‘é€äº‹åŠ¡æ¶ˆæ¯</div><div class=\"line\">  4:  *</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> tranExecuter ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> arg ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨å‚æ•°</div><div class=\"line\">  8:  * <span class=\"doctag\">@return</span> äº‹åŠ¡å‘é€ç»“æœ</div><div class=\"line\">  9:  * <span class=\"doctag\">@throws</span> MQClientException å½“ Client å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\"> 10:  */</div><div class=\"line\"> <span class=\"number\">11</span>: <span class=\"function\"><span class=\"keyword\">public</span> TransactionSendResult <span class=\"title\">sendMessageInTransaction</span><span class=\"params\">(<span class=\"keyword\">final</span> Message msg, <span class=\"keyword\">final</span> LocalTransactionExecuter tranExecuter, <span class=\"keyword\">final</span> Object arg)</span></span></div><div class=\"line\"> 12:     <span class=\"keyword\">throws</span> MQClientException &#123;</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == tranExecuter) &#123;</div><div class=\"line\"> <span class=\"number\">14</span>:         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"tranExecutor is null\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">15</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">16</span>:     Validators.checkMessage(msg, <span class=\"keyword\">this</span>.defaultMQProducer);</div><div class=\"line\"> <span class=\"number\">17</span>: </div><div class=\"line\"> <span class=\"number\">18</span>:     <span class=\"comment\">// å‘é€ã€Halfæ¶ˆæ¯ã€‘</span></div><div class=\"line\"> <span class=\"number\">19</span>:     SendResult sendResult;</div><div class=\"line\"> <span class=\"number\">20</span>:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, <span class=\"string\">\"true\"</span>);</div><div class=\"line\"> <span class=\"number\">21</span>:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_PRODUCER_GROUP, <span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">23</span>:         sendResult = <span class=\"keyword\">this</span>.send(msg);</div><div class=\"line\"> <span class=\"number\">24</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"send message Exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">26</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">27</span>: </div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"comment\">// å¤„ç†å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ</span></div><div class=\"line\"> <span class=\"number\">29</span>:     LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;</div><div class=\"line\"> <span class=\"number\">30</span>:     Throwable localException = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">31</span>:     <span class=\"keyword\">switch</span> (sendResult.getSendStatus()) &#123;</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"comment\">// å‘é€ã€Halfæ¶ˆæ¯ã€‘æˆåŠŸï¼Œæ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"keyword\">case</span> SEND_OK: &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"keyword\">if</span> (sendResult.getTransactionId() != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// äº‹åŠ¡ç¼–å·ã€‚ç›®å‰å¼€æºç‰ˆæœ¬æš‚æ—¶æ²¡ç”¨åˆ°ï¼ŒçŒœæƒ³ONSåœ¨ä½¿ç”¨ã€‚</span></div><div class=\"line\"> <span class=\"number\">36</span>:                     msg.putUserProperty(<span class=\"string\">\"__transactionId__\"</span>, sendResult.getTransactionId());</div><div class=\"line\"> <span class=\"number\">37</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">38</span>: </div><div class=\"line\"> <span class=\"number\">39</span>:                 <span class=\"comment\">// æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">40</span>:                 localTransactionState = tranExecuter.executeLocalTransactionBranch(msg, arg);</div><div class=\"line\"> <span class=\"number\">41</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == localTransactionState) &#123;</div><div class=\"line\"> <span class=\"number\">42</span>:                     localTransactionState = LocalTransactionState.UNKNOW;</div><div class=\"line\"> <span class=\"number\">43</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">44</span>: </div><div class=\"line\"> <span class=\"number\">45</span>:                 <span class=\"keyword\">if</span> (localTransactionState != LocalTransactionState.COMMIT_MESSAGE) &#123;</div><div class=\"line\"> <span class=\"number\">46</span>:                     log.info(<span class=\"string\">\"executeLocalTransactionBranch return &#123;&#125;\"</span>, localTransactionState);</div><div class=\"line\"> <span class=\"number\">47</span>:                     log.info(msg.toString());</div><div class=\"line\"> <span class=\"number\">48</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">49</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">50</span>:                 log.info(<span class=\"string\">\"executeLocalTransactionBranch exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">51</span>:                 log.info(msg.toString());</div><div class=\"line\"> <span class=\"number\">52</span>:                 localException = e;</div><div class=\"line\"> <span class=\"number\">53</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">54</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">55</span>:         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">56</span>:         <span class=\"comment\">// å‘é€ã€Halfæ¶ˆæ¯ã€‘å¤±è´¥ï¼Œæ ‡è®°ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€ä¸ºå›æ»š</span></div><div class=\"line\"> <span class=\"number\">57</span>:         <span class=\"keyword\">case</span> FLUSH_DISK_TIMEOUT:</div><div class=\"line\"> <span class=\"number\">58</span>:         <span class=\"keyword\">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class=\"line\"> <span class=\"number\">59</span>:         <span class=\"keyword\">case</span> SLAVE_NOT_AVAILABLE:</div><div class=\"line\"> <span class=\"number\">60</span>:             localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE;</div><div class=\"line\"> <span class=\"number\">61</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">62</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">63</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">64</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:     <span class=\"comment\">// ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class=\"line\"> <span class=\"number\">67</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">68</span>:         <span class=\"keyword\">this</span>.endTransaction(sendResult, localTransactionState, localException);</div><div class=\"line\"> <span class=\"number\">69</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">70</span>:         log.warn(<span class=\"string\">\"local transaction execute \"</span> + localTransactionState + <span class=\"string\">\", but end broker transaction failed\"</span>, e);</div><div class=\"line\"> <span class=\"number\">71</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">72</span>: </div><div class=\"line\"> <span class=\"number\">73</span>:     <span class=\"comment\">// è¿”å›ã€äº‹åŠ¡å‘é€ç»“æœã€‘</span></div><div class=\"line\"> <span class=\"number\">74</span>:     TransactionSendResult transactionSendResult = <span class=\"keyword\">new</span> TransactionSendResult();</div><div class=\"line\"> <span class=\"number\">75</span>:     transactionSendResult.setSendStatus(sendResult.getSendStatus());</div><div class=\"line\"> <span class=\"number\">76</span>:     transactionSendResult.setMessageQueue(sendResult.getMessageQueue());</div><div class=\"line\"> <span class=\"number\">77</span>:     transactionSendResult.setMsgId(sendResult.getMsgId());</div><div class=\"line\"> <span class=\"number\">78</span>:     transactionSendResult.setQueueOffset(sendResult.getQueueOffset());</div><div class=\"line\"> <span class=\"number\">79</span>:     transactionSendResult.setTransactionId(sendResult.getTransactionId());</div><div class=\"line\"> <span class=\"number\">80</span>:     transactionSendResult.setLocalTransactionState(localTransactionState);</div><div class=\"line\"> <span class=\"number\">81</span>:     <span class=\"keyword\">return</span> transactionSendResult;</div><div class=\"line\"> <span class=\"number\">82</span>: &#125;</div><div class=\"line\"> <span class=\"number\">83</span>: </div><div class=\"line\"> <span class=\"number\">84</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 85:  * ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</div><div class=\"line\"> 86:  *</div><div class=\"line\"> 87:  * <span class=\"doctag\">@param</span> sendResult å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ</div><div class=\"line\"> 88:  * <span class=\"doctag\">@param</span> localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class=\"line\"> 89:  * <span class=\"doctag\">@param</span> localException æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘äº§ç”Ÿçš„å¼‚å¸¸</div><div class=\"line\"> 90:  * <span class=\"doctag\">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\"> 91:  * <span class=\"doctag\">@throws</span> MQBrokerException å½“ Broker å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\"> 92:  * <span class=\"doctag\">@throws</span> InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶</div><div class=\"line\"> 93:  * <span class=\"doctag\">@throws</span> UnknownHostException å½“è§£ç æ¶ˆæ¯ç¼–å·å¤±è´¥æ˜¯</div><div class=\"line\"> 94:  */</div><div class=\"line\"> <span class=\"number\">95</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">endTransaction</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">96</span>:     <span class=\"keyword\">final</span> SendResult sendResult, //</div><div class=\"line\"> <span class=\"number\">97</span>:     <span class=\"keyword\">final</span> LocalTransactionState localTransactionState, //</div><div class=\"line\"> <span class=\"number\">98</span>:     <span class=\"keyword\">final</span> Throwable localException) <span class=\"keyword\">throws</span> RemotingException, MQBrokerException, InterruptedException, UnknownHostException &#123;</div><div class=\"line\"> <span class=\"number\">99</span>:     <span class=\"comment\">// è§£ç æ¶ˆæ¯ç¼–å·</span></div><div class=\"line\"><span class=\"number\">100</span>:     <span class=\"keyword\">final</span> MessageId id;</div><div class=\"line\"><span class=\"number\">101</span>:     <span class=\"keyword\">if</span> (sendResult.getOffsetMsgId() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">102</span>:         id = MessageDecoder.decodeMessageId(sendResult.getOffsetMsgId());</div><div class=\"line\"><span class=\"number\">103</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">104</span>:         id = MessageDecoder.decodeMessageId(sendResult.getMsgId());</div><div class=\"line\"><span class=\"number\">105</span>:     &#125;</div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:     <span class=\"comment\">// åˆ›å»ºè¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">108</span>:     String transactionId = sendResult.getTransactionId();</div><div class=\"line\"><span class=\"number\">109</span>:     <span class=\"keyword\">final</span> String brokerAddr = <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInPublish(sendResult.getMessageQueue().getBrokerName());</div><div class=\"line\"><span class=\"number\">110</span>:     EndTransactionRequestHeader requestHeader = <span class=\"keyword\">new</span> EndTransactionRequestHeader();</div><div class=\"line\"><span class=\"number\">111</span>:     requestHeader.setTransactionId(transactionId);</div><div class=\"line\"><span class=\"number\">112</span>:     requestHeader.setCommitLogOffset(id.getOffset());</div><div class=\"line\"><span class=\"number\">113</span>:     <span class=\"keyword\">switch</span> (localTransactionState) &#123;</div><div class=\"line\"><span class=\"number\">114</span>:         <span class=\"keyword\">case</span> COMMIT_MESSAGE:</div><div class=\"line\"><span class=\"number\">115</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);</div><div class=\"line\"><span class=\"number\">116</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">117</span>:         <span class=\"keyword\">case</span> ROLLBACK_MESSAGE:</div><div class=\"line\"><span class=\"number\">118</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);</div><div class=\"line\"><span class=\"number\">119</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">120</span>:         <span class=\"keyword\">case</span> UNKNOW:</div><div class=\"line\"><span class=\"number\">121</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);</div><div class=\"line\"><span class=\"number\">122</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">123</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">124</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">125</span>:     &#125;</div><div class=\"line\"><span class=\"number\">126</span>:     requestHeader.setProducerGroup(<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"><span class=\"number\">127</span>:     requestHeader.setTranStateTableOffset(sendResult.getQueueOffset());</div><div class=\"line\"><span class=\"number\">128</span>:     requestHeader.setMsgId(sendResult.getMsgId());</div><div class=\"line\"><span class=\"number\">129</span>:     String remark = localException != <span class=\"keyword\">null</span> ? (<span class=\"string\">\"executeLocalTransactionBranch exception: \"</span> + localException.toString()) : <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">130</span>: </div><div class=\"line\"><span class=\"number\">131</span>:     <span class=\"comment\">// æäº¤æ¶ˆæ¯ COMMIT / ROLLBACKã€‚ï¼ï¼ï¼é€šä¿¡æ–¹å¼ä¸ºï¼šOnewayï¼ï¼ï¼</span></div><div class=\"line\"><span class=\"number\">132</span>:     <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, requestHeader, remark, <span class=\"keyword\">this</span>.defaultMQProducer.getSendMsgTimeout());</div><div class=\"line\"><span class=\"number\">133</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-2-Broker-å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚\"><a href=\"#2-2-Broker-å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚\" class=\"headerlink\" title=\"2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚\"></a>2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚</h2><ul>\n<li>ğŸ¦… æŸ¥è¯¢è¯·æ±‚çš„æ¶ˆæ¯ï¼Œè¿›è¡Œ<strong>æäº¤ / å›æ»š</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€EndTransactionProcessor.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RemotingCommand <span class=\"title\">processRequest</span><span class=\"params\">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class=\"keyword\">throws</span> RemotingCommandException </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> EndTransactionRequestHeader requestHeader = (EndTransactionRequestHeader) request.decodeCommandCustomHeader(EndTransactionRequestHeader.class);</div><div class=\"line\"> <span class=\"number\">5</span>: </div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">// çœç•¥ä»£ç  =ã€‹æ‰“å°æ—¥å¿—ï¼ˆåªå¤„ç† COMMIT / ROLLBACKï¼‰</span></div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"comment\">// æŸ¥è¯¢æäº¤çš„æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">final</span> MessageExt msgExt = <span class=\"keyword\">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getCommitLogOffset());</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">if</span> (msgExt != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"comment\">// çœç•¥ä»£ç  =ã€‹æ ¡éªŒæ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"comment\">// ç”Ÿæˆæ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">14</span>:         MessageExtBrokerInner msgInner = <span class=\"keyword\">this</span>.endMessageTransaction(msgExt);</div><div class=\"line\"><span class=\"number\">15</span>:         msgInner.setSysFlag(MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), requestHeader.getCommitOrRollback()));</div><div class=\"line\"><span class=\"number\">16</span>:         msgInner.setQueueOffset(requestHeader.getTranStateTableOffset());</div><div class=\"line\"><span class=\"number\">17</span>:         msgInner.setPreparedTransactionOffset(requestHeader.getCommitLogOffset());</div><div class=\"line\"><span class=\"number\">18</span>:         msgInner.setStoreTimestamp(msgExt.getStoreTimestamp());</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (MessageSysFlag.TRANSACTION_ROLLBACK_TYPE == requestHeader.getCommitOrRollback()) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             msgInner.setBody(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">21</span>:         &#125;</div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>:         <span class=\"comment\">// å­˜å‚¨ç”Ÿæˆæ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">final</span> MessageStore messageStore = <span class=\"keyword\">this</span>.brokerController.getMessageStore();</div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">final</span> PutMessageResult putMessageResult = messageStore.putMessage(msgInner);</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"comment\">// å¤„ç†å­˜å‚¨ç»“æœ</span></div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">if</span> (putMessageResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"comment\">// Success</span></div><div class=\"line\"><span class=\"number\">31</span>:                 <span class=\"keyword\">case</span> PUT_OK:</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"keyword\">case</span> FLUSH_DISK_TIMEOUT:</div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"keyword\">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class=\"line\"><span class=\"number\">34</span>:                 <span class=\"keyword\">case</span> SLAVE_NOT_AVAILABLE:</div><div class=\"line\"><span class=\"number\">35</span>:                     response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"><span class=\"number\">36</span>:                     response.setRemark(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">37</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"comment\">// Failed</span></div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">case</span> CREATE_MAPEDFILE_FAILED:</div><div class=\"line\"><span class=\"number\">40</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">41</span>:                     response.setRemark(<span class=\"string\">\"create maped file failed.\"</span>);</div><div class=\"line\"><span class=\"number\">42</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">43</span>:                 <span class=\"keyword\">case</span> MESSAGE_ILLEGAL:</div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"keyword\">case</span> PROPERTIES_SIZE_EXCEEDED:</div><div class=\"line\"><span class=\"number\">45</span>:                     response.setCode(ResponseCode.MESSAGE_ILLEGAL);</div><div class=\"line\"><span class=\"number\">46</span>:                     response.setRemark(<span class=\"string\">\"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.\"</span>);</div><div class=\"line\"><span class=\"number\">47</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">48</span>:                 <span class=\"keyword\">case</span> SERVICE_NOT_AVAILABLE:</div><div class=\"line\"><span class=\"number\">49</span>:                     response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">50</span>:                     response.setRemark(<span class=\"string\">\"service not available now.\"</span>);</div><div class=\"line\"><span class=\"number\">51</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">52</span>:                 <span class=\"keyword\">case</span> OS_PAGECACHE_BUSY:</div><div class=\"line\"><span class=\"number\">53</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">54</span>:                     response.setRemark(<span class=\"string\">\"OS page cache busy, please try another machine\"</span>);</div><div class=\"line\"><span class=\"number\">55</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">56</span>:                 <span class=\"keyword\">case</span> UNKNOWN_ERROR:</div><div class=\"line\"><span class=\"number\">57</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">58</span>:                     response.setRemark(<span class=\"string\">\"UNKNOWN_ERROR\"</span>);</div><div class=\"line\"><span class=\"number\">59</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">60</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">61</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">62</span>:                     response.setRemark(<span class=\"string\">\"UNKNOWN_ERROR DEFAULT\"</span>);</div><div class=\"line\"><span class=\"number\">63</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">64</span>:             &#125;</div><div class=\"line\"><span class=\"number\">65</span>: </div><div class=\"line\"><span class=\"number\">66</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">67</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">68</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">69</span>:             response.setRemark(<span class=\"string\">\"store putMessage return null\"</span>);</div><div class=\"line\"><span class=\"number\">70</span>:         &#125;</div><div class=\"line\"><span class=\"number\">71</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">72</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">73</span>:         response.setRemark(<span class=\"string\">\"find prepared transaction message failed\"</span>);</div><div class=\"line\"><span class=\"number\">74</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">75</span>:     &#125;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">78</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-3-Broker-ç”Ÿæˆ-ConsumeQueue\"><a href=\"#2-3-Broker-ç”Ÿæˆ-ConsumeQueue\" class=\"headerlink\" title=\"2.3 Broker ç”Ÿæˆ ConsumeQueue\"></a>2.3 Broker ç”Ÿæˆ ConsumeQueue</h2><ul>\n<li>ğŸ¦… äº‹åŠ¡æ¶ˆæ¯ï¼Œæäº¤ï¼ˆ<code>COMMIT</code>ï¼‰åæ‰ç”Ÿæˆ <code>ConsumeQueue</code>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMessageStore.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">(DispatchRequest req)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE: <span class=\"comment\">// éäº‹åŠ¡æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE: <span class=\"comment\">// äº‹åŠ¡æ¶ˆæ¯COMMIT</span></div><div class=\"line\"> <span class=\"number\">8</span>:             DefaultMessageStore.<span class=\"keyword\">this</span>.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),</div><div class=\"line\"> <span class=\"number\">9</span>:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE: <span class=\"comment\">// äº‹åŠ¡æ¶ˆæ¯PREPARED</span></div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE: <span class=\"comment\">// äº‹åŠ¡æ¶ˆæ¯ROLLBACK</span></div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">14</span>:     &#125;</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"comment\">// çœç•¥ä»£ç  =ã€‹ å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</span></div><div class=\"line\"><span class=\"number\">16</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-äº‹åŠ¡æ¶ˆæ¯å›æŸ¥\"><a href=\"#3-äº‹åŠ¡æ¶ˆæ¯å›æŸ¥\" class=\"headerlink\" title=\"3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥\"></a>3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥</h1><ul>\n<li>ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½æ›¾ç»å¼€æºè¿‡ï¼Œç›®å‰ï¼ˆV4.0.0ï¼‰æš‚æœªå¼€æºã€‚å¦‚ä¸‹æ˜¯è¯¥åŠŸèƒ½çš„å¼€æºæƒ…å†µï¼š</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰ˆæœ¬</th>\n<th>ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>å®˜æ–¹V3.0.4 ~ V3.1.4</td>\n<td>åŸºäº æ–‡ä»¶ç³»ç»Ÿ å®ç°</td>\n<td>å·²å¼€æº</td>\n</tr>\n<tr>\n<td>å®˜æ–¹V3.1.5 ~ V4.0.0</td>\n<td>åŸºäº æ•°æ®åº“ å®ç°</td>\n<td>æœªå®Œå…¨å¼€æº</td>\n</tr>\n</tbody>\n</table>\n<p>æˆ‘ä»¬æ¥çœ‹çœ‹ä¸¤ç§æƒ…å†µä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>\n<h2 id=\"3-1-Broker-å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"><a href=\"#3-1-Broker-å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\" class=\"headerlink\" title=\"3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"></a>3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</h2><h3 id=\"3-1-1-å®˜æ–¹V3-1-4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ\"><a href=\"#3-1-1-å®˜æ–¹V3-1-4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ\" class=\"headerlink\" title=\"3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ\"></a>3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ</h3><blockquote>\n<p>ä»“åº“åœ°å€ï¼š<a href=\"https://github.com/YunaiV/rocketmq-3.1.9/tree/release_3.1.4\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/rocketmq-3.1.9/tree/release_3.1.4</a></p>\n</blockquote>\n<p>ç›¸è¾ƒäºæ™®é€šæ¶ˆæ¯ï¼Œã€äº‹åŠ¡æ¶ˆæ¯ã€‘å¤šä¾èµ–å¦‚ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š</p>\n<ul>\n<li><strong>TransactionStateService</strong> ï¼šäº‹åŠ¡çŠ¶æ€æœåŠ¡ï¼Œè´Ÿè´£å¯¹ã€äº‹åŠ¡æ¶ˆæ¯ã€‘è¿›è¡Œç®¡ç†ï¼ŒåŒ…æ‹¬å­˜å‚¨ä¸æ›´æ–°äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ã€å›æŸ¥äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ç­‰ç­‰ã€‚</li>\n<li><strong>TranStateTable</strong> ï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ã€‚åŸºäº <code>MappedFileQueue</code> å®ç°ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º <code>~/store/transaction/statetable</code>ï¼Œæ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">offset</td>\n<td style=\"text-align:left\">CommitLog ç‰©ç†å­˜å‚¨ä½ç½®</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">size</td>\n<td style=\"text-align:left\">æ¶ˆæ¯é•¿åº¦</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">timestamp</td>\n<td style=\"text-align:left\">æ¶ˆæ¯å­˜å‚¨æ—¶é—´ï¼Œå•ä½ï¼šç§’</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">producerGroupHash</td>\n<td style=\"text-align:left\">producerGroup æ±‚ HashCode</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">5</td>\n<td style=\"text-align:left\">state</td>\n<td style=\"text-align:left\">äº‹åŠ¡çŠ¶æ€</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>TranRedoLog</strong> ï¼š<code>TranStateTable</code> é‡æ”¾æ—¥å¿—ï¼Œæ¯æ¬¡<strong>å†™æ“ä½œ</strong> <code>TranStateTable</code> è®°å½•é‡æ”¾æ—¥å¿—ã€‚å½“ <code>Broker</code> å¼‚å¸¸å…³é—­æ—¶ï¼Œä½¿ç”¨ <code>TranRedoLog</code> æ¢å¤ <code>TranStateTable</code>ã€‚åŸºäº <code>ConsumeQueue</code> å®ç°ï¼Œ<code>Topic</code> ä¸º <code>TRANSACTION_REDOLOG_TOPIC_XXXX</code>ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º <code>~/store/transaction/redolog</code>ã€‚</li>\n</ul>\n<hr>\n<p>ç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ.jpeg\" alt=\"Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ\"></p>\n<h4 id=\"3-1-1-1-å­˜å‚¨æ¶ˆæ¯åˆ°-CommitLog\"><a href=\"#3-1-1-1-å­˜å‚¨æ¶ˆæ¯åˆ°-CommitLog\" class=\"headerlink\" title=\"3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog\"></a>3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog</h4><ul>\n<li>ğŸ¦…å­˜å‚¨ã€halfæ¶ˆæ¯ã€‘åˆ° <code>CommitLog</code> æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>queueOffset</code>ï¼‰ä½¿ç”¨ <code>TranStateTable</code> æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ã€‚è¿™æ ·ï¼Œæ¶ˆæ¯å¯ä»¥ç´¢å¼•åˆ°è‡ªå·±å¯¹åº”çš„ <code>TranStateTable</code> çš„ä½ç½®å’Œè®°å½•ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultAppendMessageCallback.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultAppendMessageCallback</span> <span class=\"keyword\">implements</span> <span class=\"title\">AppendMessageCallback</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"function\"><span class=\"keyword\">public</span> AppendMessageResult <span class=\"title\">doAppend</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> fileFromOffset, <span class=\"keyword\">final</span> ByteBuffer byteBuffer,  <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxBlank, <span class=\"keyword\">final</span> Object msg)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"comment\">// ...çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">5</span>: </div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"comment\">// äº‹åŠ¡æ¶ˆæ¯éœ€è¦ç‰¹æ®Šå¤„ç† </span></div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());</div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType: <span class=\"comment\">// æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆqueueOffsetï¼‰ä½¿ç”¨ TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ </span></div><div class=\"line\"><span class=\"number\">10</span>:             queueOffset = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().get();</div><div class=\"line\"><span class=\"number\">11</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"><span class=\"number\">13</span>:             queueOffset = msgInner.getQueueOffset();</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionNotType:</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"comment\">// ...çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>:         <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType:</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"comment\">// æ›´æ–° TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ </span></div><div class=\"line\"><span class=\"number\">26</span>:             CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().incrementAndGet();</div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionNotType:</div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"comment\">// æ›´æ–°ä¸‹ä¸€æ¬¡çš„ConsumeQueueä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">33</span>:             CommitLog.<span class=\"keyword\">this</span>.topicQueueTable.put(key, ++queueOffset);</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">36</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">37</span>:         &#125;</div><div class=\"line\"><span class=\"number\">38</span>: </div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"comment\">// è¿”å›ç»“æœ</span></div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">41</span>:     &#125;</div><div class=\"line\"><span class=\"number\">42</span>: &#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-1-1-2-å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\"><a href=\"#3-1-1-2-å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\" class=\"headerlink\" title=\"3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\"></a>3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</h4><ul>\n<li>ğŸ¦…å¤„ç†ã€Halfæ¶ˆæ¯ã€‘æ—¶ï¼Œæ–°å¢ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ã€‚</li>\n<li>ğŸ¦…å¤„ç†ã€Commit / Rollbackæ¶ˆæ¯ã€‘æ—¶ï¼Œæ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ COMMIT / ROLLBACKã€‚</li>\n<li>ğŸ¦…æ¯æ¬¡<strong>å†™æ“ä½œã€</strong>äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ï¼Œè®°å½•é‡æ”¾æ—¥å¿—ï¼ˆ<code>TranRedoLog</code>ï¼‰ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DispatchMessageService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.requestsRead.isEmpty()) &#123;</div><div class=\"line\">  <span class=\"number\">4</span>:         <span class=\"keyword\">for</span> (DispatchRequest req : <span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\">  <span class=\"number\">5</span>: </div><div class=\"line\">  <span class=\"number\">6</span>:             <span class=\"comment\">// ...çœç•¥ä»£ç </span></div><div class=\"line\">  <span class=\"number\">7</span>: </div><div class=\"line\">  <span class=\"number\">8</span>:             <span class=\"comment\">// 2ã€å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</span></div><div class=\"line\">  <span class=\"number\">9</span>:             <span class=\"keyword\">if</span> (req.getProducerGroup() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">10</span>:                 <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">11</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionNotType:</div><div class=\"line\"> <span class=\"number\">12</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">13</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType:</div><div class=\"line\"> <span class=\"number\">14</span>:                     <span class=\"comment\">// æ–°å¢ ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</span></div><div class=\"line\"> <span class=\"number\">15</span>:                     DefaultMessageStore.<span class=\"keyword\">this</span>.getTransactionStateService().appendPreparedTransaction(</div><div class=\"line\"> <span class=\"number\">16</span>:                         req.getCommitLogOffset(), req.getMsgSize(), (<span class=\"keyword\">int</span>) (req.getStoreTimestamp() / <span class=\"number\">1000</span>), req.getProducerGroup().hashCode());</div><div class=\"line\"> <span class=\"number\">17</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"> <span class=\"number\">19</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"> <span class=\"number\">20</span>:                     <span class=\"comment\">// æ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰ COMMIT / ROLLBACK</span></div><div class=\"line\"> <span class=\"number\">21</span>:                     DefaultMessageStore.<span class=\"keyword\">this</span>.getTransactionStateService().updateTransactionState(</div><div class=\"line\"> <span class=\"number\">22</span>:                         req.getTranStateTableOffset(), req.getPreparedTransactionOffset(), req.getProducerGroup().hashCode(), tranType);</div><div class=\"line\"> <span class=\"number\">23</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">24</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">25</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">26</span>:             <span class=\"comment\">// 3ã€è®°å½• TranRedoLog</span></div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">28</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TransactionNotType:</div><div class=\"line\"> <span class=\"number\">29</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">30</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType:</div><div class=\"line\"> <span class=\"number\">31</span>:                 <span class=\"comment\">// è®°å½• TranRedoLog</span></div><div class=\"line\"> <span class=\"number\">32</span>:                 DefaultMessageStore.<span class=\"keyword\">this</span>.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(</div><div class=\"line\"> <span class=\"number\">33</span>:                         req.getCommitLogOffset(), req.getMsgSize(), TransactionStateService.PreparedMessageTagsCode,</div><div class=\"line\"> <span class=\"number\">34</span>:                         req.getStoreTimestamp(), <span class=\"number\">0L</span>);</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">36</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"> <span class=\"number\">37</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"> <span class=\"number\">38</span>:                 <span class=\"comment\">// è®°å½• TranRedoLog</span></div><div class=\"line\"> <span class=\"number\">39</span>:                 DefaultMessageStore.<span class=\"keyword\">this</span>.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(</div><div class=\"line\"> <span class=\"number\">40</span>:                         req.getCommitLogOffset(), req.getMsgSize(), req.getPreparedTransactionOffset(),</div><div class=\"line\"> <span class=\"number\">41</span>:                         req.getStoreTimestamp(), <span class=\"number\">0L</span>);</div><div class=\"line\"> <span class=\"number\">42</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">43</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">44</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">45</span>: </div><div class=\"line\"> <span class=\"number\">46</span>:         <span class=\"comment\">// ...çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">47</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">48</span>: &#125;</div><div class=\"line\"> <span class=\"number\">49</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">50</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 51:  * æ–°å¢äº‹åŠ¡çŠ¶æ€</div><div class=\"line\"> 52:  *</div><div class=\"line\"> 53:  * <span class=\"doctag\">@param</span> clOffset commitLog ç‰©ç†ä½ç½®</div><div class=\"line\"> 54:  * <span class=\"doctag\">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class=\"line\"> 55:  * <span class=\"doctag\">@param</span> timestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´</div><div class=\"line\"> 56:  * <span class=\"doctag\">@param</span> groupHashCode groupHashCode</div><div class=\"line\"> 57:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\"> 58:  */</div><div class=\"line\"> <span class=\"number\">59</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">appendPreparedTransaction</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">60</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> clOffset,//</div><div class=\"line\"> <span class=\"number\">61</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size,//</div><div class=\"line\"> <span class=\"number\">62</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> timestamp,//</div><div class=\"line\"> <span class=\"number\">63</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> groupHashCode//</div><div class=\"line\"> <span class=\"number\">64</span>: ) &#123;</div><div class=\"line\"> <span class=\"number\">65</span>:     MapedFile mapedFile = <span class=\"keyword\">this</span>.tranStateTable.getLastMapedFile();</div><div class=\"line\"> <span class=\"number\">66</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mapedFile) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:         log.error(<span class=\"string\">\"appendPreparedTransaction: create mapedfile error.\"</span>);</div><div class=\"line\"> <span class=\"number\">68</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">70</span>: </div><div class=\"line\"> <span class=\"number\">71</span>:     <span class=\"comment\">// é¦–æ¬¡åˆ›å»ºï¼ŒåŠ å…¥å®šæ—¶ä»»åŠ¡ä¸­</span></div><div class=\"line\"> <span class=\"number\">72</span>:     <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == mapedFile.getWrotePostion()) &#123;</div><div class=\"line\"> <span class=\"number\">73</span>:         <span class=\"keyword\">this</span>.addTimerTask(mapedFile);</div><div class=\"line\"> <span class=\"number\">74</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">75</span>: </div><div class=\"line\"> <span class=\"number\">76</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.position(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">77</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.limit(TSStoreUnitSize);</div><div class=\"line\"> <span class=\"number\">78</span>: </div><div class=\"line\"> <span class=\"number\">79</span>:     <span class=\"comment\">// Commit Log Offset</span></div><div class=\"line\"> <span class=\"number\">80</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putLong(clOffset);</div><div class=\"line\"> <span class=\"number\">81</span>:     <span class=\"comment\">// Message Size</span></div><div class=\"line\"> <span class=\"number\">82</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putInt(size);</div><div class=\"line\"> <span class=\"number\">83</span>:     <span class=\"comment\">// Timestamp</span></div><div class=\"line\"> <span class=\"number\">84</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putInt(timestamp);</div><div class=\"line\"> <span class=\"number\">85</span>:     <span class=\"comment\">// Producer Group Hashcode</span></div><div class=\"line\"> <span class=\"number\">86</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putInt(groupHashCode);</div><div class=\"line\"> <span class=\"number\">87</span>:     <span class=\"comment\">// Transaction State</span></div><div class=\"line\"> <span class=\"number\">88</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putInt(MessageSysFlag.TransactionPreparedType);</div><div class=\"line\"> <span class=\"number\">89</span>: </div><div class=\"line\"> <span class=\"number\">90</span>:     <span class=\"keyword\">return</span> mapedFile.appendMessage(<span class=\"keyword\">this</span>.byteBufferAppend.array());</div><div class=\"line\"> <span class=\"number\">91</span>: &#125;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 94:  * æ›´æ–°äº‹åŠ¡çŠ¶æ€</div><div class=\"line\"> 95:  *</div><div class=\"line\"> 96:  * <span class=\"doctag\">@param</span> tsOffset tranStateTable ç‰©ç†ä½ç½®</div><div class=\"line\"> 97:  * <span class=\"doctag\">@param</span> clOffset commitLog ç‰©ç†ä½ç½®</div><div class=\"line\"> 98:  * <span class=\"doctag\">@param</span> groupHashCode groupHashCode</div><div class=\"line\"> 99:  * <span class=\"doctag\">@param</span> state äº‹åŠ¡çŠ¶æ€</div><div class=\"line\">100:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\">101:  */</div><div class=\"line\"><span class=\"number\">102</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">updateTransactionState</span><span class=\"params\">(</span></span></div><div class=\"line\"><span class=\"number\">103</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> tsOffset,</div><div class=\"line\"><span class=\"number\">104</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> clOffset,</div><div class=\"line\"><span class=\"number\">105</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> groupHashCode,</div><div class=\"line\"><span class=\"number\">106</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> state) &#123;</div><div class=\"line\"><span class=\"number\">107</span>:     SelectMapedBufferResult selectMapedBufferResult = <span class=\"keyword\">this</span>.findTransactionBuffer(tsOffset);</div><div class=\"line\"><span class=\"number\">108</span>:     <span class=\"keyword\">if</span> (selectMapedBufferResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">109</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">110</span>: </div><div class=\"line\"><span class=\"number\">111</span>:             <span class=\"comment\">// ....çœç•¥ä»£ç ï¼šæ ¡éªŒæ˜¯å¦èƒ½å¤Ÿæ›´æ–°</span></div><div class=\"line\"><span class=\"number\">112</span>: </div><div class=\"line\"><span class=\"number\">113</span>:             <span class=\"comment\">// æ›´æ–°äº‹åŠ¡çŠ¶æ€</span></div><div class=\"line\"><span class=\"number\">114</span>:             selectMapedBufferResult.getByteBuffer().putInt(TS_STATE_POS, state);</div><div class=\"line\"><span class=\"number\">115</span>:         &#125;</div><div class=\"line\"><span class=\"number\">116</span>:         <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">117</span>:             log.error(<span class=\"string\">\"updateTransactionState exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">118</span>:         &#125;</div><div class=\"line\"><span class=\"number\">119</span>:         <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">120</span>:             selectMapedBufferResult.release();</div><div class=\"line\"><span class=\"number\">121</span>:         &#125;</div><div class=\"line\"><span class=\"number\">122</span>:     &#125;</div><div class=\"line\"><span class=\"number\">123</span>: </div><div class=\"line\"><span class=\"number\">124</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">125</span>: &#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-1-1-3-ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥\"><a href=\"#3-1-1-3-ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥\" class=\"headerlink\" title=\"3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥\"></a>3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥</h4><ul>\n<li>ğŸ¦…<code>TranStateTable</code> æ¯ä¸ª <code>MappedFile</code> éƒ½å¯¹åº”ä¸€ä¸ª <code>Timer</code>ã€‚<code>Timer</code> å›ºå®šå‘¨æœŸï¼ˆé»˜è®¤ï¼š60sï¼‰éå† <code>MappedFile</code>ï¼ŒæŸ¥æ‰¾ã€halfæ¶ˆæ¯ã€‘ï¼Œå‘ <code>Producer</code> å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥è¯·æ±‚ã€‚ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥ç»“æœçš„é€»è¾‘ä¸åœ¨æ­¤å¤„è¿›è¡Œï¼Œåœ¨ <a href=\"#3112-å†™äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€å­˜å‚¨transtatetable\">CommitLog dispatch</a>æ—¶æ‰§è¡Œã€‚</li>\n</ul>\n<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</div><div class=\"line\">  4:  */</div><div class=\"line\">  <span class=\"number\">5</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initTimerTask</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">final</span> List&lt;MapedFile&gt; mapedFiles = <span class=\"keyword\">this</span>.tranStateTable.getMapedFiles();</div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"keyword\">for</span> (MapedFile mf : mapedFiles) &#123;</div><div class=\"line\">  <span class=\"number\">9</span>:         <span class=\"keyword\">this</span>.addTimerTask(mf);</div><div class=\"line\"> <span class=\"number\">10</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">11</span>: &#125;</div><div class=\"line\"> <span class=\"number\">12</span>: </div><div class=\"line\"> <span class=\"number\">13</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 14:  * æ¯ä¸ªæ–‡ä»¶åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</div><div class=\"line\"> 15:  * <span class=\"doctag\">@param</span> mf æ–‡ä»¶</div><div class=\"line\"> 16:  */</div><div class=\"line\"> <span class=\"number\">17</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">addTimerTask</span><span class=\"params\">(<span class=\"keyword\">final</span> MapedFile mf)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">18</span>:     <span class=\"keyword\">this</span>.timer.scheduleAtFixedRate(<span class=\"keyword\">new</span> TimerTask() &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MapedFile mapedFile = mf;</div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TransactionCheckExecuter transactionCheckExecuter = TransactionStateService.<span class=\"keyword\">this</span>.defaultMessageStore.getTransactionCheckExecuter();</div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> checkTransactionMessageAtleastInterval = TransactionStateService.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig()</div><div class=\"line\"> <span class=\"number\">22</span>:                     .getCheckTransactionMessageAtleastInterval();</div><div class=\"line\"> <span class=\"number\">23</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> slave = TransactionStateService.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">26</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"comment\">// Slaveä¸éœ€è¦å›æŸ¥äº‹åŠ¡çŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">28</span>:             <span class=\"keyword\">if</span> (slave) &#123;</div><div class=\"line\"> <span class=\"number\">29</span>:                 <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">30</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">31</span>:             <span class=\"comment\">// CheckåŠŸèƒ½æ˜¯å¦å¼€å¯</span></div><div class=\"line\"> <span class=\"number\">32</span>:             <span class=\"keyword\">if</span> (!TransactionStateService.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig()</div><div class=\"line\"> <span class=\"number\">33</span>:                 .isCheckTransactionMessageEnable()) &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:                 <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">35</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">36</span>: </div><div class=\"line\"> <span class=\"number\">37</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:                 SelectMapedBufferResult selectMapedBufferResult = mapedFile.selectMapedBuffer(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">39</span>:                 <span class=\"keyword\">if</span> (selectMapedBufferResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">40</span>:                     <span class=\"keyword\">long</span> preparedMessageCountInThisMapedFile = <span class=\"number\">0</span>; <span class=\"comment\">// å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡</span></div><div class=\"line\"> <span class=\"number\">41</span>:                     <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">43</span>:                         <span class=\"comment\">// å¾ªç¯æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€ï¼Œå¯¹ã€halfæ¶ˆæ¯ã€‘è¿›è¡Œå›æŸ¥</span></div><div class=\"line\"> <span class=\"number\">44</span>:                         <span class=\"keyword\">for</span> (; i &lt; selectMapedBufferResult.getSize(); i += TSStoreUnitSize) &#123;</div><div class=\"line\"> <span class=\"number\">45</span>:                             selectMapedBufferResult.getByteBuffer().position(i);</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:                             <span class=\"comment\">// Commit Log Offset</span></div><div class=\"line\"> <span class=\"number\">48</span>:                             <span class=\"keyword\">long</span> clOffset = selectMapedBufferResult.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">49</span>:                             <span class=\"comment\">// Message Size</span></div><div class=\"line\"> <span class=\"number\">50</span>:                             <span class=\"keyword\">int</span> msgSize = selectMapedBufferResult.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">51</span>:                             <span class=\"comment\">// Timestamp</span></div><div class=\"line\"> <span class=\"number\">52</span>:                             <span class=\"keyword\">int</span> timestamp = selectMapedBufferResult.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">53</span>:                             <span class=\"comment\">// Producer Group Hashcode</span></div><div class=\"line\"> <span class=\"number\">54</span>:                             <span class=\"keyword\">int</span> groupHashCode = selectMapedBufferResult.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">55</span>:                             <span class=\"comment\">// Transaction State</span></div><div class=\"line\"> <span class=\"number\">56</span>:                             <span class=\"keyword\">int</span> tranType = selectMapedBufferResult.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:                             <span class=\"comment\">// å·²ç»æäº¤æˆ–è€…å›æ»šçš„æ¶ˆæ¯è·³è¿‡</span></div><div class=\"line\"> <span class=\"number\">59</span>:                             <span class=\"keyword\">if</span> (tranType != MessageSysFlag.TransactionPreparedType) &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:                                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">61</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">62</span>: </div><div class=\"line\"> <span class=\"number\">63</span>:                             <span class=\"comment\">// é‡åˆ°æ—¶é—´ä¸ç¬¦åˆæœ€å°è½®è¯¢é—´éš”ï¼Œç»ˆæ­¢</span></div><div class=\"line\"> <span class=\"number\">64</span>:                             <span class=\"keyword\">long</span> timestampLong = timestamp * <span class=\"number\">1000</span>;</div><div class=\"line\"> <span class=\"number\">65</span>:                             <span class=\"keyword\">long</span> diff = System.currentTimeMillis() - timestampLong;</div><div class=\"line\"> <span class=\"number\">66</span>:                             <span class=\"keyword\">if</span> (diff &lt; checkTransactionMessageAtleastInterval) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:                                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">68</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">69</span>: </div><div class=\"line\"> <span class=\"number\">70</span>:                             preparedMessageCountInThisMapedFile++;</div><div class=\"line\"> <span class=\"number\">71</span>: </div><div class=\"line\"> <span class=\"number\">72</span>:                             <span class=\"comment\">// å›æŸ¥Producer</span></div><div class=\"line\"> <span class=\"number\">73</span>:                             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:                                 <span class=\"keyword\">this</span>.transactionCheckExecuter.gotoCheck(groupHashCode, getTranStateOffset(i), clOffset, msgSize);</div><div class=\"line\"> <span class=\"number\">75</span>:                             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:                                 tranlog.warn(<span class=\"string\">\"gotoCheck Exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">77</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">78</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">79</span>: </div><div class=\"line\"> <span class=\"number\">80</span>:                         <span class=\"comment\">// æ— å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡ï¼Œä¸”éå†å®Œï¼Œåˆ™ç»ˆæ­¢å®šæ—¶ä»»åŠ¡</span></div><div class=\"line\"> <span class=\"number\">81</span>:                         <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == preparedMessageCountInThisMapedFile <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">82</span>:                                 &amp;&amp; i == mapedFile.getFileSize()) &#123;</div><div class=\"line\"> <span class=\"number\">83</span>:                             tranlog.info(<span class=\"string\">\"remove the transaction timer task, because no prepared message in this mapedfile[&#123;&#125;]\"</span>, mapedFile.getFileName());</div><div class=\"line\"> <span class=\"number\">84</span>:                             <span class=\"keyword\">this</span>.cancel();</div><div class=\"line\"> <span class=\"number\">85</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>:                     &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:                         selectMapedBufferResult.release();</div><div class=\"line\"> <span class=\"number\">88</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">89</span>: </div><div class=\"line\"> <span class=\"number\">90</span>:                     tranlog.info(<span class=\"string\">\"the transaction timer task execute over in this period, &#123;&#125; Prepared Message: &#123;&#125; Check Progress: &#123;&#125;/&#123;&#125;\"</span>, mapedFile.getFileName(),<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">91</span>:                             preparedMessageCountInThisMapedFile, i / TSStoreUnitSize, mapedFile.getFileSize() / TSStoreUnitSize);</div><div class=\"line\"> <span class=\"number\">92</span>:                 &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mapedFile.isFull()) &#123;</div><div class=\"line\"> <span class=\"number\">93</span>:                     tranlog.info(<span class=\"string\">\"the mapedfile[&#123;&#125;] maybe deleted, cancel check transaction timer task\"</span>, mapedFile.getFileName());</div><div class=\"line\"> <span class=\"number\">94</span>:                     <span class=\"keyword\">this</span>.cancel();</div><div class=\"line\"> <span class=\"number\">95</span>:                     <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">96</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">97</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:                 log.error(<span class=\"string\">\"check transaction timer task Exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">99</span>:             &#125;</div><div class=\"line\"><span class=\"number\">100</span>:         &#125;</div><div class=\"line\"><span class=\"number\">101</span>: </div><div class=\"line\"><span class=\"number\">102</span>: </div><div class=\"line\"><span class=\"number\">103</span>:         <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">getTranStateOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentIndex)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">104</span>:             <span class=\"keyword\">long</span> offset = (<span class=\"keyword\">this</span>.mapedFile.getFileFromOffset() + currentIndex) / TransactionStateService.TSStoreUnitSize;</div><div class=\"line\"><span class=\"number\">105</span>:             <span class=\"keyword\">return</span> offset;</div><div class=\"line\"><span class=\"number\">106</span>:         &#125;</div><div class=\"line\"><span class=\"number\">107</span>:     &#125;, <span class=\"number\">1000</span> * <span class=\"number\">60</span>, <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getCheckTransactionMessageTimerInterval());</div><div class=\"line\"><span class=\"number\">108</span>: &#125;</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>: <span class=\"comment\">// ã€DefaultTransactionCheckExecuter.javaã€‘</span></div><div class=\"line\"><span class=\"number\">111</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">112</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">gotoCheck</span><span class=\"params\">(<span class=\"keyword\">int</span> producerGroupHashCode, <span class=\"keyword\">long</span> tranStateTableOffset, <span class=\"keyword\">long</span> commitLogOffset,</span></span></div><div class=\"line\"><span class=\"number\">113</span>:         <span class=\"keyword\">int</span> msgSize) &#123;</div><div class=\"line\"><span class=\"number\">114</span>:     <span class=\"comment\">// ç¬¬ä¸€æ­¥ã€æŸ¥è¯¢Producer</span></div><div class=\"line\"><span class=\"number\">115</span>:     <span class=\"keyword\">final</span> ClientChannelInfo clientChannelInfo = <span class=\"keyword\">this</span>.brokerController.getProducerManager().pickProducerChannelRandomly(producerGroupHashCode);</div><div class=\"line\"><span class=\"number\">116</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == clientChannelInfo) &#123;</div><div class=\"line\"><span class=\"number\">117</span>:         log.warn(<span class=\"string\">\"check a producer transaction state, but not find any channel of this group[&#123;&#125;]\"</span>, producerGroupHashCode);</div><div class=\"line\"><span class=\"number\">118</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">119</span>:     &#125;</div><div class=\"line\"><span class=\"number\">120</span>: </div><div class=\"line\"><span class=\"number\">121</span>:     <span class=\"comment\">// ç¬¬äºŒæ­¥ã€æŸ¥è¯¢æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">122</span>:     SelectMapedBufferResult selectMapedBufferResult = <span class=\"keyword\">this</span>.brokerController.getMessageStore().selectOneMessageByOffset(commitLogOffset, msgSize);</div><div class=\"line\"><span class=\"number\">123</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == selectMapedBufferResult) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:         log.warn(<span class=\"string\">\"check a producer transaction state, but not find message by commitLogOffset: &#123;&#125;, msgSize: \"</span>, commitLogOffset, msgSize);</div><div class=\"line\"><span class=\"number\">125</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">126</span>:     &#125;</div><div class=\"line\"><span class=\"number\">127</span>: </div><div class=\"line\"><span class=\"number\">128</span>:     <span class=\"comment\">// ç¬¬ä¸‰æ­¥ã€å‘Producerå‘èµ·è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">129</span>:     <span class=\"keyword\">final</span> CheckTransactionStateRequestHeader requestHeader = <span class=\"keyword\">new</span> CheckTransactionStateRequestHeader();</div><div class=\"line\"><span class=\"number\">130</span>:     requestHeader.setCommitLogOffset(commitLogOffset);</div><div class=\"line\"><span class=\"number\">131</span>:     requestHeader.setTranStateTableOffset(tranStateTableOffset);</div><div class=\"line\"><span class=\"number\">132</span>:     <span class=\"keyword\">this</span>.brokerController.getBroker2Client().checkProducerTransactionState(clientChannelInfo.getChannel(), requestHeader, selectMapedBufferResult);</div><div class=\"line\"><span class=\"number\">133</span>: &#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-1-1-4-åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\"><a href=\"#3-1-1-4-åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\" class=\"headerlink\" title=\"3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\"></a>3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</h4><ul>\n<li>ğŸ¦…æ ¹æ®æœ€å Broker å…³é—­æ˜¯å¦æ­£å¸¸ï¼Œä¼šæœ‰ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * åˆå§‹åŒ– TranRedoLog</div><div class=\"line\">  4:  * <span class=\"doctag\">@param</span> lastExitOK æ˜¯å¦æ­£å¸¸é€€å‡º</div><div class=\"line\">  5:  */</div><div class=\"line\">  <span class=\"number\">6</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">recoverStateTable</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> lastExitOK)</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">if</span> (lastExitOK) &#123;</div><div class=\"line\">  <span class=\"number\">8</span>:         <span class=\"keyword\">this</span>.recoverStateTableNormal();</div><div class=\"line\">  <span class=\"number\">9</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">10</span>:         <span class=\"comment\">// ç¬¬ä¸€æ­¥ï¼Œåˆ é™¤State Table</span></div><div class=\"line\"> <span class=\"number\">11</span>:         <span class=\"keyword\">this</span>.tranStateTable.destroy();</div><div class=\"line\"> <span class=\"number\">12</span>:         <span class=\"comment\">// ç¬¬äºŒæ­¥ï¼Œé€šè¿‡RedoLogå…¨é‡æ¢å¤StateTable</span></div><div class=\"line\"> <span class=\"number\">13</span>:         <span class=\"keyword\">this</span>.recreateStateTable();</div><div class=\"line\"> <span class=\"number\">14</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">15</span>: &#125;</div><div class=\"line\"> <span class=\"number\">16</span>: </div><div class=\"line\"> <span class=\"number\">17</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 18:  * æ‰«æ TranRedoLog é‡å»º StateTable</div><div class=\"line\"> 19:  */</div><div class=\"line\"> <span class=\"number\">20</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">recreateStateTable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">21</span>:     <span class=\"keyword\">this</span>.tranStateTable = <span class=\"keyword\">new</span> MapedFileQueue(StorePathConfigHelper.getTranStateTableStorePath(defaultMessageStore</div><div class=\"line\"> <span class=\"number\">22</span>:                 .getMessageStoreConfig().getStorePathRootDir()), defaultMessageStore</div><div class=\"line\"> <span class=\"number\">23</span>:                 .getMessageStoreConfig().getTranStateTableMapedFileSize(), <span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:     <span class=\"keyword\">final</span> TreeSet&lt;Long&gt; preparedItemSet = <span class=\"keyword\">new</span> TreeSet&lt;Long&gt;();</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:     <span class=\"comment\">// ç¬¬ä¸€æ­¥ï¼Œä»å¤´æ‰«æRedoLog</span></div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> minOffset = <span class=\"keyword\">this</span>.tranRedoLog.getMinOffsetInQuque();</div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">long</span> processOffset = minOffset;</div><div class=\"line\"> <span class=\"number\">30</span>:     <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\"> <span class=\"number\">31</span>:         SelectMapedBufferResult bufferConsumeQueue = <span class=\"keyword\">this</span>.tranRedoLog.getIndexBuffer(processOffset);</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"keyword\">if</span> (bufferConsumeQueue != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">33</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:                 <span class=\"keyword\">long</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"keyword\">for</span> (; i &lt; bufferConsumeQueue.getSize(); i += ConsumeQueue.CQStoreUnitSize) &#123;</div><div class=\"line\"> <span class=\"number\">36</span>:                     <span class=\"keyword\">long</span> offsetMsg = bufferConsumeQueue.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">37</span>:                     <span class=\"keyword\">int</span> sizeMsg = bufferConsumeQueue.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">38</span>:                     <span class=\"keyword\">long</span> tagsCode = bufferConsumeQueue.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">39</span>: </div><div class=\"line\"> <span class=\"number\">40</span>:                     <span class=\"keyword\">if</span> (TransactionStateService.PreparedMessageTagsCode == tagsCode) &#123; <span class=\"comment\">// Prepared</span></div><div class=\"line\"> <span class=\"number\">41</span>:                         preparedItemSet.add(offsetMsg);</div><div class=\"line\"> <span class=\"number\">42</span>:                     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// Commit/Rollback</span></div><div class=\"line\"> <span class=\"number\">43</span>:                         preparedItemSet.remove(tagsCode);</div><div class=\"line\"> <span class=\"number\">44</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">45</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:                 processOffset += i;</div><div class=\"line\"> <span class=\"number\">48</span>:             &#125; <span class=\"keyword\">finally</span> &#123; <span class=\"comment\">// å¿…é¡»é‡Šæ”¾èµ„æº</span></div><div class=\"line\"> <span class=\"number\">49</span>:                 bufferConsumeQueue.release();</div><div class=\"line\"> <span class=\"number\">50</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">51</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">53</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">54</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">55</span>:     log.info(<span class=\"string\">\"scan transaction redolog over, End offset: &#123;&#125;,  Prepared Transaction Count: &#123;&#125;\"</span>, processOffset, preparedItemSet.size());</div><div class=\"line\"> <span class=\"number\">56</span>: </div><div class=\"line\"> <span class=\"number\">57</span>:     <span class=\"comment\">// ç¬¬äºŒæ­¥ï¼Œé‡å»ºStateTable</span></div><div class=\"line\"> <span class=\"number\">58</span>:     Iterator&lt;Long&gt; it = preparedItemSet.iterator();</div><div class=\"line\"> <span class=\"number\">59</span>:     <span class=\"keyword\">while</span> (it.hasNext()) &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:         Long offset = it.next();</div><div class=\"line\"> <span class=\"number\">61</span>:         MessageExt msgExt = <span class=\"keyword\">this</span>.defaultMessageStore.lookMessageByOffset(offset);</div><div class=\"line\"> <span class=\"number\">62</span>:         <span class=\"keyword\">if</span> (msgExt != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:             <span class=\"keyword\">this</span>.appendPreparedTransaction(msgExt.getCommitLogOffset(), msgExt.getStoreSize(),</div><div class=\"line\"> <span class=\"number\">64</span>:                 (<span class=\"keyword\">int</span>) (msgExt.getStoreTimestamp() / <span class=\"number\">1000</span>),</div><div class=\"line\"> <span class=\"number\">65</span>:                 msgExt.getProperty(MessageConst.PROPERTY_PRODUCER_GROUP).hashCode());</div><div class=\"line\"> <span class=\"number\">66</span>:             <span class=\"keyword\">this</span>.tranStateTableOffset.incrementAndGet();</div><div class=\"line\"> <span class=\"number\">67</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">68</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">69</span>: &#125;</div><div class=\"line\"> <span class=\"number\">70</span>: </div><div class=\"line\"> <span class=\"number\">71</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 72:  * åŠ è½½ï¼ˆè§£æï¼‰TranStateTable çš„ MappedFile</div><div class=\"line\"> 73:  * 1. æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position</div><div class=\"line\"> 74:  * 2. è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰</div><div class=\"line\"> 75:  */</div><div class=\"line\"> <span class=\"number\">76</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">recoverStateTableNormal</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">77</span>:     <span class=\"keyword\">final</span> List&lt;MapedFile&gt; mapedFiles = <span class=\"keyword\">this</span>.tranStateTable.getMapedFiles();</div><div class=\"line\"> <span class=\"number\">78</span>:     <span class=\"keyword\">if</span> (!mapedFiles.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">79</span>:         <span class=\"comment\">// ä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹æ¢å¤</span></div><div class=\"line\"> <span class=\"number\">80</span>:         <span class=\"keyword\">int</span> index = mapedFiles.size() - <span class=\"number\">3</span>;</div><div class=\"line\"> <span class=\"number\">81</span>:         <span class=\"keyword\">if</span> (index &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">82</span>:             index = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">83</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">84</span>: </div><div class=\"line\"> <span class=\"number\">85</span>:         <span class=\"keyword\">int</span> mapedFileSizeLogics = <span class=\"keyword\">this</span>.tranStateTable.getMapedFileSize();</div><div class=\"line\"> <span class=\"number\">86</span>:         MapedFile mapedFile = mapedFiles.get(index);</div><div class=\"line\"> <span class=\"number\">87</span>:         ByteBuffer byteBuffer = mapedFile.sliceByteBuffer();</div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">long</span> processOffset = mapedFile.getFileFromOffset();</div><div class=\"line\"> <span class=\"number\">89</span>:         <span class=\"keyword\">long</span> mapedFileOffset = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\"> <span class=\"number\">91</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; mapedFileSizeLogics; i += TSStoreUnitSize) &#123;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> clOffset_read = byteBuffer.getLong();</div><div class=\"line\"> <span class=\"number\">94</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size_read = byteBuffer.getInt();</div><div class=\"line\"> <span class=\"number\">95</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> timestamp_read = byteBuffer.getInt();</div><div class=\"line\"> <span class=\"number\">96</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> groupHashCode_read = byteBuffer.getInt();</div><div class=\"line\"> <span class=\"number\">97</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> state_read = byteBuffer.getInt();</div><div class=\"line\"> <span class=\"number\">98</span>: </div><div class=\"line\"> <span class=\"number\">99</span>:                 <span class=\"keyword\">boolean</span> stateOK = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">100</span>:                 <span class=\"keyword\">switch</span> (state_read) &#123;</div><div class=\"line\"><span class=\"number\">101</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType:</div><div class=\"line\"><span class=\"number\">102</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"><span class=\"number\">103</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"><span class=\"number\">104</span>:                     stateOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">105</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">106</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">107</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">108</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>:                 <span class=\"comment\">// è¯´æ˜å½“å‰å­˜å‚¨å•å…ƒæœ‰æ•ˆ</span></div><div class=\"line\"><span class=\"number\">111</span>:                 <span class=\"keyword\">if</span> (clOffset_read &gt;= <span class=\"number\">0</span> &amp;&amp; size_read &gt; <span class=\"number\">0</span> &amp;&amp; stateOK) &#123;</div><div class=\"line\"><span class=\"number\">112</span>:                     mapedFileOffset = i + TSStoreUnitSize;</div><div class=\"line\"><span class=\"number\">113</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">114</span>:                     log.info(<span class=\"string\">\"recover current transaction state table file over,  \"</span> + mapedFile.getFileName() + <span class=\"string\">\" \"</span></div><div class=\"line\"><span class=\"number\">115</span>:                             + clOffset_read + <span class=\"string\">\" \"</span> + size_read + <span class=\"string\">\" \"</span> + timestamp_read);</div><div class=\"line\"><span class=\"number\">116</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">117</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">118</span>:             &#125;</div><div class=\"line\"><span class=\"number\">119</span>: </div><div class=\"line\"><span class=\"number\">120</span>:             <span class=\"comment\">// èµ°åˆ°æ–‡ä»¶æœ«å°¾ï¼Œåˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªæ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">121</span>:             <span class=\"keyword\">if</span> (mapedFileOffset == mapedFileSizeLogics) &#123;</div><div class=\"line\"><span class=\"number\">122</span>:                 index++;</div><div class=\"line\"><span class=\"number\">123</span>:                 <span class=\"keyword\">if</span> (index &gt;= mapedFiles.size()) &#123; <span class=\"comment\">// å¾ªç¯whileç»“æŸ</span></div><div class=\"line\"><span class=\"number\">124</span>:                     log.info(<span class=\"string\">\"recover last transaction state table file over, last maped file \"</span> + mapedFile.getFileName());</div><div class=\"line\"><span class=\"number\">125</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">126</span>:                 &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// åˆ‡æ¢ä¸‹ä¸€ä¸ªæ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">127</span>:                     mapedFile = mapedFiles.get(index);</div><div class=\"line\"><span class=\"number\">128</span>:                     byteBuffer = mapedFile.sliceByteBuffer();</div><div class=\"line\"><span class=\"number\">129</span>:                     processOffset = mapedFile.getFileFromOffset();</div><div class=\"line\"><span class=\"number\">130</span>:                     mapedFileOffset = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">131</span>:                     log.info(<span class=\"string\">\"recover next transaction state table file, \"</span> + mapedFile.getFileName());</div><div class=\"line\"><span class=\"number\">132</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">133</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">134</span>:                 log.info(<span class=\"string\">\"recover current transaction state table queue over \"</span> + mapedFile.getFileName() + <span class=\"string\">\" \"</span> + (processOffset + mapedFileOffset));</div><div class=\"line\"><span class=\"number\">135</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">136</span>:             &#125;</div><div class=\"line\"><span class=\"number\">137</span>:         &#125;</div><div class=\"line\"><span class=\"number\">138</span>: </div><div class=\"line\"><span class=\"number\">139</span>:         <span class=\"comment\">// æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position</span></div><div class=\"line\"><span class=\"number\">140</span>:         processOffset += mapedFileOffset;</div><div class=\"line\"><span class=\"number\">141</span>:         <span class=\"keyword\">this</span>.tranStateTable.truncateDirtyFiles(processOffset);</div><div class=\"line\"><span class=\"number\">142</span>: </div><div class=\"line\"><span class=\"number\">143</span>:         <span class=\"comment\">// è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰</span></div><div class=\"line\"><span class=\"number\">144</span>:         <span class=\"keyword\">this</span>.tranStateTableOffset.set(<span class=\"keyword\">this</span>.tranStateTable.getMaxOffset() / TSStoreUnitSize);</div><div class=\"line\"><span class=\"number\">145</span>:         log.info(<span class=\"string\">\"recover normal over, transaction state table max offset: &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.tranStateTableOffset.get());</div><div class=\"line\"><span class=\"number\">146</span>:     &#125;</div><div class=\"line\"><span class=\"number\">147</span>: &#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-1-1-5-è¡¥å……\"><a href=\"#3-1-1-5-è¡¥å……\" class=\"headerlink\" title=\"3.1.1.5 è¡¥å……\"></a>3.1.1.5 è¡¥å……</h4><ul>\n<li>ä¸ºä»€ä¹ˆ V3.1.5 å¼€å§‹ï¼Œä½¿ç”¨ æ•°æ®åº“ å®ç°ã€äº‹åŠ¡çŠ¶æ€ã€‘çš„å­˜å‚¨ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼Œå¯èƒ½æ˜¯ä¸€éƒ¨åˆ†åŸå› ï¼š</li>\n</ul>\n<blockquote>\n<p>RocketMQ è¿™ç§å®ç°äº‹åŠ¡æ–¹å¼ï¼Œæ²¡æœ‰é€šè¿‡ KV å­˜å‚¨åšï¼Œè€Œæ˜¯é€šè¿‡ Offset æ–¹å¼ï¼Œå­˜åœ¨ä¸€ä¸ªæ˜¾è‘—ç¼ºé™·ï¼Œå³é€šè¿‡ Offset æ›´æ”¹æ•°æ®ï¼Œä¼šä»¤ç³»ç»Ÿçš„è„é¡µè¿‡å¤šï¼Œéœ€è¦ç‰¹åˆ«å…³æ³¨ã€‚</p>\n</blockquote>\n<h3 id=\"3-1-2-å®˜æ–¹V4-0-0ï¼šåŸºäºæ•°æ®åº“\"><a href=\"#3-1-2-å®˜æ–¹V4-0-0ï¼šåŸºäºæ•°æ®åº“\" class=\"headerlink\" title=\"3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“\"></a>3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“</h3><blockquote>\n<p>ä»“åº“åœ°å€ï¼š<a href=\"https://github.com/apache/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/apache/incubator-rocketmq</a></p>\n</blockquote>\n<p>å®˜æ–¹V4.0.0 æš‚æ—¶æœª<strong>å®Œå…¨</strong>å¼€æºã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½ï¼Œ<strong>So æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›çŒœæƒ³ï¼Œå¯èƒ½ä¸ä¸€å®šæ­£ç¡®ğŸ˜ˆ</strong>ã€‚</p>\n<p>ğŸ˜†æˆ‘ä»¬æ¥å¯¹æ¯”ã€å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ã€‘çš„å®ç°ã€‚</p>\n<ul>\n<li>TransactionRecord ï¼šè®°å½•æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘ã€‚ç±»ä¼¼ <code>TranStateTable</code>ã€‚</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>TranStateTable</th>\n<th>TransactionRecord</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>offset</td>\n<td>offset</td>\n<td></td>\n</tr>\n<tr>\n<td>producerGroupHash</td>\n<td>producerGroup</td>\n<td></td>\n</tr>\n<tr>\n<td>size</td>\n<td>æ— </td>\n<td>éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚</td>\n</tr>\n<tr>\n<td>timestamp</td>\n<td>æ— </td>\n<td>éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚</td>\n</tr>\n<tr>\n<td>state</td>\n<td>æ— </td>\n<td>éå¿…é¡»å­—æ®µï¼š äº‹åŠ¡å¼€å§‹ï¼Œå¢åŠ è®°å½•ï¼›äº‹åŠ¡ç»“æŸï¼Œåˆ é™¤è®°å½•ã€‚</td>\n</tr>\n</tbody>\n</table>\n<p>å¦å¤–ï¼Œæ•°æ®åº“æœ¬èº«ä¿è¯äº†æ•°æ®å­˜å‚¨çš„å¯é æ€§ï¼Œæ— éœ€ <code>TranRedoLog</code>ã€‚</p>\n<hr>\n<p>ç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Broker_V4.0.0_åŸºäºæ•°æ®åº“.jpeg\" alt=\"Broker_V4.0.0_åŸºäºæ•°æ®åº“\"></p>\n<h2 id=\"3-2-Producer-æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"><a href=\"#3-2-Producer-æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\" class=\"headerlink\" title=\"3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"></a>3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</h2><ul>\n<li>é¡ºåºå›¾å¦‚ä¸‹ï¼š</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘.png\" alt=\"Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"></p>\n<ul>\n<li>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * æ£€æŸ¥ã€äº‹åŠ¡çŠ¶æ€ã€‘çŠ¶æ€</div><div class=\"line\">  4:  *</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> addr brokeråœ°å€</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> header è¯·æ±‚</div><div class=\"line\">  8:  */</div><div class=\"line\">  <span class=\"number\">9</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">checkTransactionState</span><span class=\"params\">(<span class=\"keyword\">final</span> String addr, <span class=\"keyword\">final</span> MessageExt msg, <span class=\"keyword\">final</span> CheckTransactionStateRequestHeader header)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">11</span>:     Runnable request = <span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">12</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String brokerAddr = addr;</div><div class=\"line\"> <span class=\"number\">13</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MessageExt message = msg;</div><div class=\"line\"> <span class=\"number\">14</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> CheckTransactionStateRequestHeader checkRequestHeader = header;</div><div class=\"line\"> <span class=\"number\">15</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String group = DefaultMQProducerImpl.<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup();</div><div class=\"line\"> <span class=\"number\">16</span>: </div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             TransactionCheckListener transactionCheckListener = DefaultMQProducerImpl.<span class=\"keyword\">this</span>.checkListener();</div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"keyword\">if</span> (transactionCheckListener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:                 <span class=\"comment\">// è·å–äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">22</span>:                 LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;</div><div class=\"line\"> <span class=\"number\">23</span>:                 Throwable exception = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">24</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:                     localTransactionState = transactionCheckListener.checkLocalTransactionState(message);</div><div class=\"line\"> <span class=\"number\">26</span>:                 &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">27</span>:                     log.error(<span class=\"string\">\"Broker call checkTransactionState, but checkLocalTransactionState exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">28</span>:                     exception = e;</div><div class=\"line\"> <span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">30</span>: </div><div class=\"line\"> <span class=\"number\">31</span>:                 <span class=\"comment\">// å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class=\"line\"> <span class=\"number\">32</span>:                 <span class=\"keyword\">this</span>.processTransactionState(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">33</span>:                     localTransactionState, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">34</span>:                     group, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">35</span>:                     exception);</div><div class=\"line\"> <span class=\"number\">36</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">37</span>:                 log.warn(<span class=\"string\">\"checkTransactionState, pick transactionCheckListener by group[&#123;&#125;] failed\"</span>, group);</div><div class=\"line\"> <span class=\"number\">38</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">39</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">40</span>: </div><div class=\"line\"> <span class=\"number\">41</span>:         <span class=\"comment\">/**</span></div><div class=\"line\"> 42:          * å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</div><div class=\"line\"> 43:          *</div><div class=\"line\"> 44:          * <span class=\"doctag\">@param</span> localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class=\"line\"> 45:          * <span class=\"doctag\">@param</span> producerGroup producerGroup</div><div class=\"line\"> 46:          * <span class=\"doctag\">@param</span> exception æ£€æŸ¥ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€å‘ç”Ÿçš„å¼‚å¸¸</div><div class=\"line\"> 47:          */</div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">processTransactionState</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">49</span>:             <span class=\"keyword\">final</span> LocalTransactionState localTransactionState, //</div><div class=\"line\"> <span class=\"number\">50</span>:             <span class=\"keyword\">final</span> String producerGroup, //</div><div class=\"line\"> <span class=\"number\">51</span>:             <span class=\"keyword\">final</span> Throwable exception) &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:             <span class=\"keyword\">final</span> EndTransactionRequestHeader thisHeader = <span class=\"keyword\">new</span> EndTransactionRequestHeader();</div><div class=\"line\"> <span class=\"number\">53</span>:             thisHeader.setCommitLogOffset(checkRequestHeader.getCommitLogOffset());</div><div class=\"line\"> <span class=\"number\">54</span>:             thisHeader.setProducerGroup(producerGroup);</div><div class=\"line\"> <span class=\"number\">55</span>:             thisHeader.setTranStateTableOffset(checkRequestHeader.getTranStateTableOffset());</div><div class=\"line\"> <span class=\"number\">56</span>:             thisHeader.setFromTransactionCheck(<span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:             <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯ç¼–å·</span></div><div class=\"line\"> <span class=\"number\">59</span>:             String uniqueKey = message.getProperties().get(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);</div><div class=\"line\"> <span class=\"number\">60</span>:             <span class=\"keyword\">if</span> (uniqueKey == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">61</span>:                 uniqueKey = message.getMsgId();</div><div class=\"line\"> <span class=\"number\">62</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">63</span>:             thisHeader.setMsgId(uniqueKey);</div><div class=\"line\"> <span class=\"number\">64</span>: </div><div class=\"line\"> <span class=\"number\">65</span>:             thisHeader.setTransactionId(checkRequestHeader.getTransactionId());</div><div class=\"line\"> <span class=\"number\">66</span>:             <span class=\"keyword\">switch</span> (localTransactionState) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:                 <span class=\"keyword\">case</span> COMMIT_MESSAGE:</div><div class=\"line\"> <span class=\"number\">68</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);</div><div class=\"line\"> <span class=\"number\">69</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">70</span>:                 <span class=\"keyword\">case</span> ROLLBACK_MESSAGE:</div><div class=\"line\"> <span class=\"number\">71</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);</div><div class=\"line\"> <span class=\"number\">72</span>:                     log.warn(<span class=\"string\">\"when broker check, client rollback this transaction, &#123;&#125;\"</span>, thisHeader);</div><div class=\"line\"> <span class=\"number\">73</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">74</span>:                 <span class=\"keyword\">case</span> UNKNOW:</div><div class=\"line\"> <span class=\"number\">75</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);</div><div class=\"line\"> <span class=\"number\">76</span>:                     log.warn(<span class=\"string\">\"when broker check, client does not know this transaction state, &#123;&#125;\"</span>, thisHeader);</div><div class=\"line\"> <span class=\"number\">77</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">78</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">79</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">80</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">81</span>: </div><div class=\"line\"> <span class=\"number\">82</span>:             String remark = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">83</span>:             <span class=\"keyword\">if</span> (exception != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">84</span>:                 remark = <span class=\"string\">\"checkLocalTransactionState Exception: \"</span> + RemotingHelper.exceptionSimpleDesc(exception);</div><div class=\"line\"> <span class=\"number\">85</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">86</span>: </div><div class=\"line\"> <span class=\"number\">87</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">88</span>:                 <span class=\"comment\">// æäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class=\"line\"> <span class=\"number\">89</span>:                 DefaultMQProducerImpl.<span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, thisHeader, remark,</div><div class=\"line\"> <span class=\"number\">90</span>:                     <span class=\"number\">3000</span>);</div><div class=\"line\"> <span class=\"number\">91</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">92</span>:                 log.error(<span class=\"string\">\"endTransactionOneway exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">93</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">94</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">95</span>:     &#125;;</div><div class=\"line\"> <span class=\"number\">96</span>: </div><div class=\"line\"> <span class=\"number\">97</span>:     <span class=\"comment\">// æäº¤æ‰§è¡Œ</span></div><div class=\"line\"> <span class=\"number\">98</span>:     <span class=\"keyword\">this</span>.checkExecutor.submit(request);</div><div class=\"line\"> <span class=\"number\">99</span>: &#125;</div><div class=\"line\"><span class=\"number\">100</span>: </div><div class=\"line\"><span class=\"number\">101</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class=\"line\"><span class=\"number\">102</span>: <span class=\"comment\">/**</span></div><div class=\"line\">103:  * ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘æ£€æŸ¥ç›‘å¬å™¨</div><div class=\"line\">104:  */</div><div class=\"line\"><span class=\"number\">105</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">TransactionCheckListener</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">108:      * è·å–ï¼ˆæ£€æŸ¥ï¼‰ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class=\"line\">109:      *</div><div class=\"line\">110:      * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\">111:      * <span class=\"doctag\">@return</span> äº‹åŠ¡çŠ¶æ€</div><div class=\"line\">112:      */</div><div class=\"line\"><span class=\"number\">113</span>:     <span class=\"function\">LocalTransactionState <span class=\"title\">checkLocalTransactionState</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExt msg)</span></span>;</div><div class=\"line\"><span class=\"number\">114</span>: </div><div class=\"line\"><span class=\"number\">115</span>: &#125;</div></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> åŸæ–‡åœ°å€ï¼š<a href=\"https://github.com/YunaiV/Blog/blob/master/RocketMQ/1011-RocketMQæºç è§£æï¼šäº‹åŠ¡æ¶ˆæ¯.md\" target=\"_blank\" rel=\"external\">RocketMQæºç è§£æï¼šäº‹åŠ¡æ¶ˆæ¯</a><br><code>RocketMQ</code> <strong>å¸¦æ³¨é‡Š</strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">YunaiV/incubator-rocketmq</a><br><strong>ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— GitHubï¼š<a href=\"https://github.com/YunaiV/Blogã€‚\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/Blogã€‚</a></strong>  </p>\n</blockquote>\n<hr>\n<ul>\n<li><a href=\"#\">1. æ¦‚è¿°</a></li>\n<li><a href=\"#\">2. äº‹åŠ¡æ¶ˆæ¯å‘é€</a><ul>\n<li><a href=\"#\">2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯</a></li>\n<li><a href=\"#\">2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚</a></li>\n<li><a href=\"#\">2.3 Broker ç”Ÿæˆ ConsumeQueue</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥</a><ul>\n<li><a href=\"#\">3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</a><ul>\n<li><a href=\"#\">3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ</a><ul>\n<li><a href=\"#\">3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog</a></li>\n<li><a href=\"#\">3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</a></li>\n<li><a href=\"#\">3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥</a></li>\n<li><a href=\"#\">3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</a></li>\n<li><a href=\"#\">3.1.1.5 è¡¥å……</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“</a></li>\n</ul>\n</li>\n<li><a href=\"#\">3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</a></li>\n</ul>\n</li>\n</ul>\n<h1 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h1><p><strong>å¿…é¡»å¿…é¡»å¿…é¡»</strong> å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>\n<ul>\n<li><a href=\"https://help.aliyun.com/document_detail/43348.html?spm=5176.doc43490.6.566.Zd5Bl7\" target=\"_blank\" rel=\"external\">ã€Šäº‹åŠ¡æ¶ˆæ¯ï¼ˆé˜¿é‡Œäº‘ï¼‰ã€‹</a></li>\n</ul>\n<h1 id=\"2-äº‹åŠ¡æ¶ˆæ¯å‘é€\"><a href=\"#2-äº‹åŠ¡æ¶ˆæ¯å‘é€\" class=\"headerlink\" title=\"2. äº‹åŠ¡æ¶ˆæ¯å‘é€\"></a>2. äº‹åŠ¡æ¶ˆæ¯å‘é€</h1><h2 id=\"2-1-Producer-å‘é€äº‹åŠ¡æ¶ˆæ¯\"><a href=\"#2-1-Producer-å‘é€äº‹åŠ¡æ¶ˆæ¯\" class=\"headerlink\" title=\"2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯\"></a>2.1 Producer å‘é€äº‹åŠ¡æ¶ˆæ¯</h2><ul>\n<li>æ´»åŠ¨å›¾å¦‚ä¸‹ï¼ˆç»“åˆ <code>æ ¸å¿ƒä»£ç </code> ç†è§£ï¼‰ï¼š</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Producerå‘é€äº‹åŠ¡æ¶ˆæ¯.png\" alt=\"Producerå‘é€äº‹åŠ¡æ¶ˆæ¯\"></p>\n<ul>\n<li>å®ç°ä»£ç å¦‚ä¸‹ï¼š</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * å‘é€äº‹åŠ¡æ¶ˆæ¯</div><div class=\"line\">  4:  *</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> tranExecuter ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> arg ã€æœ¬åœ°äº‹åŠ¡ã€‘æ‰§è¡Œå™¨å‚æ•°</div><div class=\"line\">  8:  * <span class=\"doctag\">@return</span> äº‹åŠ¡å‘é€ç»“æœ</div><div class=\"line\">  9:  * <span class=\"doctag\">@throws</span> MQClientException å½“ Client å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\"> 10:  */</div><div class=\"line\"> <span class=\"number\">11</span>: <span class=\"function\"><span class=\"keyword\">public</span> TransactionSendResult <span class=\"title\">sendMessageInTransaction</span><span class=\"params\">(<span class=\"keyword\">final</span> Message msg, <span class=\"keyword\">final</span> LocalTransactionExecuter tranExecuter, <span class=\"keyword\">final</span> Object arg)</span></span></div><div class=\"line\"> 12:     <span class=\"keyword\">throws</span> MQClientException &#123;</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == tranExecuter) &#123;</div><div class=\"line\"> <span class=\"number\">14</span>:         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"tranExecutor is null\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">15</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">16</span>:     Validators.checkMessage(msg, <span class=\"keyword\">this</span>.defaultMQProducer);</div><div class=\"line\"> <span class=\"number\">17</span>: </div><div class=\"line\"> <span class=\"number\">18</span>:     <span class=\"comment\">// å‘é€ã€Halfæ¶ˆæ¯ã€‘</span></div><div class=\"line\"> <span class=\"number\">19</span>:     SendResult sendResult;</div><div class=\"line\"> <span class=\"number\">20</span>:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, <span class=\"string\">\"true\"</span>);</div><div class=\"line\"> <span class=\"number\">21</span>:     MessageAccessor.putProperty(msg, MessageConst.PROPERTY_PRODUCER_GROUP, <span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">23</span>:         sendResult = <span class=\"keyword\">this</span>.send(msg);</div><div class=\"line\"> <span class=\"number\">24</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"send message Exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">26</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">27</span>: </div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"comment\">// å¤„ç†å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ</span></div><div class=\"line\"> <span class=\"number\">29</span>:     LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;</div><div class=\"line\"> <span class=\"number\">30</span>:     Throwable localException = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">31</span>:     <span class=\"keyword\">switch</span> (sendResult.getSendStatus()) &#123;</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"comment\">// å‘é€ã€Halfæ¶ˆæ¯ã€‘æˆåŠŸï¼Œæ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"keyword\">case</span> SEND_OK: &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"keyword\">if</span> (sendResult.getTransactionId() != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// äº‹åŠ¡ç¼–å·ã€‚ç›®å‰å¼€æºç‰ˆæœ¬æš‚æ—¶æ²¡ç”¨åˆ°ï¼ŒçŒœæƒ³ONSåœ¨ä½¿ç”¨ã€‚</span></div><div class=\"line\"> <span class=\"number\">36</span>:                     msg.putUserProperty(<span class=\"string\">\"__transactionId__\"</span>, sendResult.getTransactionId());</div><div class=\"line\"> <span class=\"number\">37</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">38</span>: </div><div class=\"line\"> <span class=\"number\">39</span>:                 <span class=\"comment\">// æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘</span></div><div class=\"line\"> <span class=\"number\">40</span>:                 localTransactionState = tranExecuter.executeLocalTransactionBranch(msg, arg);</div><div class=\"line\"> <span class=\"number\">41</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == localTransactionState) &#123;</div><div class=\"line\"> <span class=\"number\">42</span>:                     localTransactionState = LocalTransactionState.UNKNOW;</div><div class=\"line\"> <span class=\"number\">43</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">44</span>: </div><div class=\"line\"> <span class=\"number\">45</span>:                 <span class=\"keyword\">if</span> (localTransactionState != LocalTransactionState.COMMIT_MESSAGE) &#123;</div><div class=\"line\"> <span class=\"number\">46</span>:                     log.info(<span class=\"string\">\"executeLocalTransactionBranch return &#123;&#125;\"</span>, localTransactionState);</div><div class=\"line\"> <span class=\"number\">47</span>:                     log.info(msg.toString());</div><div class=\"line\"> <span class=\"number\">48</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">49</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">50</span>:                 log.info(<span class=\"string\">\"executeLocalTransactionBranch exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">51</span>:                 log.info(msg.toString());</div><div class=\"line\"> <span class=\"number\">52</span>:                 localException = e;</div><div class=\"line\"> <span class=\"number\">53</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">54</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">55</span>:         <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">56</span>:         <span class=\"comment\">// å‘é€ã€Halfæ¶ˆæ¯ã€‘å¤±è´¥ï¼Œæ ‡è®°ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€ä¸ºå›æ»š</span></div><div class=\"line\"> <span class=\"number\">57</span>:         <span class=\"keyword\">case</span> FLUSH_DISK_TIMEOUT:</div><div class=\"line\"> <span class=\"number\">58</span>:         <span class=\"keyword\">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class=\"line\"> <span class=\"number\">59</span>:         <span class=\"keyword\">case</span> SLAVE_NOT_AVAILABLE:</div><div class=\"line\"> <span class=\"number\">60</span>:             localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE;</div><div class=\"line\"> <span class=\"number\">61</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">62</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">63</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">64</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:     <span class=\"comment\">// ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class=\"line\"> <span class=\"number\">67</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">68</span>:         <span class=\"keyword\">this</span>.endTransaction(sendResult, localTransactionState, localException);</div><div class=\"line\"> <span class=\"number\">69</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">70</span>:         log.warn(<span class=\"string\">\"local transaction execute \"</span> + localTransactionState + <span class=\"string\">\", but end broker transaction failed\"</span>, e);</div><div class=\"line\"> <span class=\"number\">71</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">72</span>: </div><div class=\"line\"> <span class=\"number\">73</span>:     <span class=\"comment\">// è¿”å›ã€äº‹åŠ¡å‘é€ç»“æœã€‘</span></div><div class=\"line\"> <span class=\"number\">74</span>:     TransactionSendResult transactionSendResult = <span class=\"keyword\">new</span> TransactionSendResult();</div><div class=\"line\"> <span class=\"number\">75</span>:     transactionSendResult.setSendStatus(sendResult.getSendStatus());</div><div class=\"line\"> <span class=\"number\">76</span>:     transactionSendResult.setMessageQueue(sendResult.getMessageQueue());</div><div class=\"line\"> <span class=\"number\">77</span>:     transactionSendResult.setMsgId(sendResult.getMsgId());</div><div class=\"line\"> <span class=\"number\">78</span>:     transactionSendResult.setQueueOffset(sendResult.getQueueOffset());</div><div class=\"line\"> <span class=\"number\">79</span>:     transactionSendResult.setTransactionId(sendResult.getTransactionId());</div><div class=\"line\"> <span class=\"number\">80</span>:     transactionSendResult.setLocalTransactionState(localTransactionState);</div><div class=\"line\"> <span class=\"number\">81</span>:     <span class=\"keyword\">return</span> transactionSendResult;</div><div class=\"line\"> <span class=\"number\">82</span>: &#125;</div><div class=\"line\"> <span class=\"number\">83</span>: </div><div class=\"line\"> <span class=\"number\">84</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 85:  * ç»“æŸäº‹åŠ¡ï¼šæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</div><div class=\"line\"> 86:  *</div><div class=\"line\"> 87:  * <span class=\"doctag\">@param</span> sendResult å‘é€ã€Halfæ¶ˆæ¯ã€‘ç»“æœ</div><div class=\"line\"> 88:  * <span class=\"doctag\">@param</span> localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class=\"line\"> 89:  * <span class=\"doctag\">@param</span> localException æ‰§è¡Œã€æœ¬åœ°äº‹åŠ¡ã€‘é€»è¾‘äº§ç”Ÿçš„å¼‚å¸¸</div><div class=\"line\"> 90:  * <span class=\"doctag\">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\"> 91:  * <span class=\"doctag\">@throws</span> MQBrokerException å½“ Broker å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\"> 92:  * <span class=\"doctag\">@throws</span> InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶</div><div class=\"line\"> 93:  * <span class=\"doctag\">@throws</span> UnknownHostException å½“è§£ç æ¶ˆæ¯ç¼–å·å¤±è´¥æ˜¯</div><div class=\"line\"> 94:  */</div><div class=\"line\"> <span class=\"number\">95</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">endTransaction</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">96</span>:     <span class=\"keyword\">final</span> SendResult sendResult, //</div><div class=\"line\"> <span class=\"number\">97</span>:     <span class=\"keyword\">final</span> LocalTransactionState localTransactionState, //</div><div class=\"line\"> <span class=\"number\">98</span>:     <span class=\"keyword\">final</span> Throwable localException) <span class=\"keyword\">throws</span> RemotingException, MQBrokerException, InterruptedException, UnknownHostException &#123;</div><div class=\"line\"> <span class=\"number\">99</span>:     <span class=\"comment\">// è§£ç æ¶ˆæ¯ç¼–å·</span></div><div class=\"line\"><span class=\"number\">100</span>:     <span class=\"keyword\">final</span> MessageId id;</div><div class=\"line\"><span class=\"number\">101</span>:     <span class=\"keyword\">if</span> (sendResult.getOffsetMsgId() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">102</span>:         id = MessageDecoder.decodeMessageId(sendResult.getOffsetMsgId());</div><div class=\"line\"><span class=\"number\">103</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">104</span>:         id = MessageDecoder.decodeMessageId(sendResult.getMsgId());</div><div class=\"line\"><span class=\"number\">105</span>:     &#125;</div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:     <span class=\"comment\">// åˆ›å»ºè¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">108</span>:     String transactionId = sendResult.getTransactionId();</div><div class=\"line\"><span class=\"number\">109</span>:     <span class=\"keyword\">final</span> String brokerAddr = <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInPublish(sendResult.getMessageQueue().getBrokerName());</div><div class=\"line\"><span class=\"number\">110</span>:     EndTransactionRequestHeader requestHeader = <span class=\"keyword\">new</span> EndTransactionRequestHeader();</div><div class=\"line\"><span class=\"number\">111</span>:     requestHeader.setTransactionId(transactionId);</div><div class=\"line\"><span class=\"number\">112</span>:     requestHeader.setCommitLogOffset(id.getOffset());</div><div class=\"line\"><span class=\"number\">113</span>:     <span class=\"keyword\">switch</span> (localTransactionState) &#123;</div><div class=\"line\"><span class=\"number\">114</span>:         <span class=\"keyword\">case</span> COMMIT_MESSAGE:</div><div class=\"line\"><span class=\"number\">115</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);</div><div class=\"line\"><span class=\"number\">116</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">117</span>:         <span class=\"keyword\">case</span> ROLLBACK_MESSAGE:</div><div class=\"line\"><span class=\"number\">118</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);</div><div class=\"line\"><span class=\"number\">119</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">120</span>:         <span class=\"keyword\">case</span> UNKNOW:</div><div class=\"line\"><span class=\"number\">121</span>:             requestHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);</div><div class=\"line\"><span class=\"number\">122</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">123</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">124</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">125</span>:     &#125;</div><div class=\"line\"><span class=\"number\">126</span>:     requestHeader.setProducerGroup(<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup());</div><div class=\"line\"><span class=\"number\">127</span>:     requestHeader.setTranStateTableOffset(sendResult.getQueueOffset());</div><div class=\"line\"><span class=\"number\">128</span>:     requestHeader.setMsgId(sendResult.getMsgId());</div><div class=\"line\"><span class=\"number\">129</span>:     String remark = localException != <span class=\"keyword\">null</span> ? (<span class=\"string\">\"executeLocalTransactionBranch exception: \"</span> + localException.toString()) : <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">130</span>: </div><div class=\"line\"><span class=\"number\">131</span>:     <span class=\"comment\">// æäº¤æ¶ˆæ¯ COMMIT / ROLLBACKã€‚ï¼ï¼ï¼é€šä¿¡æ–¹å¼ä¸ºï¼šOnewayï¼ï¼ï¼</span></div><div class=\"line\"><span class=\"number\">132</span>:     <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, requestHeader, remark, <span class=\"keyword\">this</span>.defaultMQProducer.getSendMsgTimeout());</div><div class=\"line\"><span class=\"number\">133</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-2-Broker-å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚\"><a href=\"#2-2-Broker-å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚\" class=\"headerlink\" title=\"2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚\"></a>2.2 Broker å¤„ç†ç»“æŸäº‹åŠ¡è¯·æ±‚</h2><ul>\n<li>ğŸ¦… æŸ¥è¯¢è¯·æ±‚çš„æ¶ˆæ¯ï¼Œè¿›è¡Œ<strong>æäº¤ / å›æ»š</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€EndTransactionProcessor.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> RemotingCommand <span class=\"title\">processRequest</span><span class=\"params\">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class=\"keyword\">throws</span> RemotingCommandException </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> EndTransactionRequestHeader requestHeader = (EndTransactionRequestHeader) request.decodeCommandCustomHeader(EndTransactionRequestHeader.class);</div><div class=\"line\"> <span class=\"number\">5</span>: </div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">// çœç•¥ä»£ç  =ã€‹æ‰“å°æ—¥å¿—ï¼ˆåªå¤„ç† COMMIT / ROLLBACKï¼‰</span></div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"comment\">// æŸ¥è¯¢æäº¤çš„æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">final</span> MessageExt msgExt = <span class=\"keyword\">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getCommitLogOffset());</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">if</span> (msgExt != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"comment\">// çœç•¥ä»£ç  =ã€‹æ ¡éªŒæ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"comment\">// ç”Ÿæˆæ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">14</span>:         MessageExtBrokerInner msgInner = <span class=\"keyword\">this</span>.endMessageTransaction(msgExt);</div><div class=\"line\"><span class=\"number\">15</span>:         msgInner.setSysFlag(MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), requestHeader.getCommitOrRollback()));</div><div class=\"line\"><span class=\"number\">16</span>:         msgInner.setQueueOffset(requestHeader.getTranStateTableOffset());</div><div class=\"line\"><span class=\"number\">17</span>:         msgInner.setPreparedTransactionOffset(requestHeader.getCommitLogOffset());</div><div class=\"line\"><span class=\"number\">18</span>:         msgInner.setStoreTimestamp(msgExt.getStoreTimestamp());</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (MessageSysFlag.TRANSACTION_ROLLBACK_TYPE == requestHeader.getCommitOrRollback()) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             msgInner.setBody(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">21</span>:         &#125;</div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>:         <span class=\"comment\">// å­˜å‚¨ç”Ÿæˆæ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">final</span> MessageStore messageStore = <span class=\"keyword\">this</span>.brokerController.getMessageStore();</div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">final</span> PutMessageResult putMessageResult = messageStore.putMessage(msgInner);</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"comment\">// å¤„ç†å­˜å‚¨ç»“æœ</span></div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">if</span> (putMessageResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"comment\">// Success</span></div><div class=\"line\"><span class=\"number\">31</span>:                 <span class=\"keyword\">case</span> PUT_OK:</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"keyword\">case</span> FLUSH_DISK_TIMEOUT:</div><div class=\"line\"><span class=\"number\">33</span>:                 <span class=\"keyword\">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class=\"line\"><span class=\"number\">34</span>:                 <span class=\"keyword\">case</span> SLAVE_NOT_AVAILABLE:</div><div class=\"line\"><span class=\"number\">35</span>:                     response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"><span class=\"number\">36</span>:                     response.setRemark(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">37</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"comment\">// Failed</span></div><div class=\"line\"><span class=\"number\">39</span>:                 <span class=\"keyword\">case</span> CREATE_MAPEDFILE_FAILED:</div><div class=\"line\"><span class=\"number\">40</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">41</span>:                     response.setRemark(<span class=\"string\">\"create maped file failed.\"</span>);</div><div class=\"line\"><span class=\"number\">42</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">43</span>:                 <span class=\"keyword\">case</span> MESSAGE_ILLEGAL:</div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"keyword\">case</span> PROPERTIES_SIZE_EXCEEDED:</div><div class=\"line\"><span class=\"number\">45</span>:                     response.setCode(ResponseCode.MESSAGE_ILLEGAL);</div><div class=\"line\"><span class=\"number\">46</span>:                     response.setRemark(<span class=\"string\">\"the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.\"</span>);</div><div class=\"line\"><span class=\"number\">47</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">48</span>:                 <span class=\"keyword\">case</span> SERVICE_NOT_AVAILABLE:</div><div class=\"line\"><span class=\"number\">49</span>:                     response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);</div><div class=\"line\"><span class=\"number\">50</span>:                     response.setRemark(<span class=\"string\">\"service not available now.\"</span>);</div><div class=\"line\"><span class=\"number\">51</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">52</span>:                 <span class=\"keyword\">case</span> OS_PAGECACHE_BUSY:</div><div class=\"line\"><span class=\"number\">53</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">54</span>:                     response.setRemark(<span class=\"string\">\"OS page cache busy, please try another machine\"</span>);</div><div class=\"line\"><span class=\"number\">55</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">56</span>:                 <span class=\"keyword\">case</span> UNKNOWN_ERROR:</div><div class=\"line\"><span class=\"number\">57</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">58</span>:                     response.setRemark(<span class=\"string\">\"UNKNOWN_ERROR\"</span>);</div><div class=\"line\"><span class=\"number\">59</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">60</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">61</span>:                     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">62</span>:                     response.setRemark(<span class=\"string\">\"UNKNOWN_ERROR DEFAULT\"</span>);</div><div class=\"line\"><span class=\"number\">63</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">64</span>:             &#125;</div><div class=\"line\"><span class=\"number\">65</span>: </div><div class=\"line\"><span class=\"number\">66</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">67</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">68</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">69</span>:             response.setRemark(<span class=\"string\">\"store putMessage return null\"</span>);</div><div class=\"line\"><span class=\"number\">70</span>:         &#125;</div><div class=\"line\"><span class=\"number\">71</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">72</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">73</span>:         response.setRemark(<span class=\"string\">\"find prepared transaction message failed\"</span>);</div><div class=\"line\"><span class=\"number\">74</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">75</span>:     &#125;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">78</span>: &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"2-3-Broker-ç”Ÿæˆ-ConsumeQueue\"><a href=\"#2-3-Broker-ç”Ÿæˆ-ConsumeQueue\" class=\"headerlink\" title=\"2.3 Broker ç”Ÿæˆ ConsumeQueue\"></a>2.3 Broker ç”Ÿæˆ ConsumeQueue</h2><ul>\n<li>ğŸ¦… äº‹åŠ¡æ¶ˆæ¯ï¼Œæäº¤ï¼ˆ<code>COMMIT</code>ï¼‰åæ‰ç”Ÿæˆ <code>ConsumeQueue</code>ã€‚</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMessageStore.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">(DispatchRequest req)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE: <span class=\"comment\">// éäº‹åŠ¡æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE: <span class=\"comment\">// äº‹åŠ¡æ¶ˆæ¯COMMIT</span></div><div class=\"line\"> <span class=\"number\">8</span>:             DefaultMessageStore.<span class=\"keyword\">this</span>.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),</div><div class=\"line\"> <span class=\"number\">9</span>:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE: <span class=\"comment\">// äº‹åŠ¡æ¶ˆæ¯PREPARED</span></div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE: <span class=\"comment\">// äº‹åŠ¡æ¶ˆæ¯ROLLBACK</span></div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">14</span>:     &#125;</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"comment\">// çœç•¥ä»£ç  =ã€‹ å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</span></div><div class=\"line\"><span class=\"number\">16</span>: &#125;</div></pre></td></tr></table></figure>\n<h1 id=\"3-äº‹åŠ¡æ¶ˆæ¯å›æŸ¥\"><a href=\"#3-äº‹åŠ¡æ¶ˆæ¯å›æŸ¥\" class=\"headerlink\" title=\"3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥\"></a>3. äº‹åŠ¡æ¶ˆæ¯å›æŸ¥</h1><ul>\n<li>ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½æ›¾ç»å¼€æºè¿‡ï¼Œç›®å‰ï¼ˆV4.0.0ï¼‰æš‚æœªå¼€æºã€‚å¦‚ä¸‹æ˜¯è¯¥åŠŸèƒ½çš„å¼€æºæƒ…å†µï¼š</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>ç‰ˆæœ¬</th>\n<th>ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>å®˜æ–¹V3.0.4 ~ V3.1.4</td>\n<td>åŸºäº æ–‡ä»¶ç³»ç»Ÿ å®ç°</td>\n<td>å·²å¼€æº</td>\n</tr>\n<tr>\n<td>å®˜æ–¹V3.1.5 ~ V4.0.0</td>\n<td>åŸºäº æ•°æ®åº“ å®ç°</td>\n<td>æœªå®Œå…¨å¼€æº</td>\n</tr>\n</tbody>\n</table>\n<p>æˆ‘ä»¬æ¥çœ‹çœ‹ä¸¤ç§æƒ…å†µä¸‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>\n<h2 id=\"3-1-Broker-å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"><a href=\"#3-1-Broker-å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\" class=\"headerlink\" title=\"3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"></a>3.1 Broker å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</h2><h3 id=\"3-1-1-å®˜æ–¹V3-1-4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ\"><a href=\"#3-1-1-å®˜æ–¹V3-1-4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ\" class=\"headerlink\" title=\"3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ\"></a>3.1.1 å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿ</h3><blockquote>\n<p>ä»“åº“åœ°å€ï¼š<a href=\"https://github.com/YunaiV/rocketmq-3.1.9/tree/release_3.1.4\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/rocketmq-3.1.9/tree/release_3.1.4</a></p>\n</blockquote>\n<p>ç›¸è¾ƒäºæ™®é€šæ¶ˆæ¯ï¼Œã€äº‹åŠ¡æ¶ˆæ¯ã€‘å¤šä¾èµ–å¦‚ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š</p>\n<ul>\n<li><strong>TransactionStateService</strong> ï¼šäº‹åŠ¡çŠ¶æ€æœåŠ¡ï¼Œè´Ÿè´£å¯¹ã€äº‹åŠ¡æ¶ˆæ¯ã€‘è¿›è¡Œç®¡ç†ï¼ŒåŒ…æ‹¬å­˜å‚¨ä¸æ›´æ–°äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ã€å›æŸ¥äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ç­‰ç­‰ã€‚</li>\n<li><strong>TranStateTable</strong> ï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ã€‚åŸºäº <code>MappedFileQueue</code> å®ç°ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º <code>~/store/transaction/statetable</code>ï¼Œæ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">offset</td>\n<td style=\"text-align:left\">CommitLog ç‰©ç†å­˜å‚¨ä½ç½®</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">size</td>\n<td style=\"text-align:left\">æ¶ˆæ¯é•¿åº¦</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">timestamp</td>\n<td style=\"text-align:left\">æ¶ˆæ¯å­˜å‚¨æ—¶é—´ï¼Œå•ä½ï¼šç§’</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">producerGroupHash</td>\n<td style=\"text-align:left\">producerGroup æ±‚ HashCode</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">5</td>\n<td style=\"text-align:left\">state</td>\n<td style=\"text-align:left\">äº‹åŠ¡çŠ¶æ€</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>TranRedoLog</strong> ï¼š<code>TranStateTable</code> é‡æ”¾æ—¥å¿—ï¼Œæ¯æ¬¡<strong>å†™æ“ä½œ</strong> <code>TranStateTable</code> è®°å½•é‡æ”¾æ—¥å¿—ã€‚å½“ <code>Broker</code> å¼‚å¸¸å…³é—­æ—¶ï¼Œä½¿ç”¨ <code>TranRedoLog</code> æ¢å¤ <code>TranStateTable</code>ã€‚åŸºäº <code>ConsumeQueue</code> å®ç°ï¼Œ<code>Topic</code> ä¸º <code>TRANSACTION_REDOLOG_TOPIC_XXXX</code>ï¼Œé»˜è®¤å­˜å‚¨è·¯å¾„ä¸º <code>~/store/transaction/redolog</code>ã€‚</li>\n</ul>\n<hr>\n<p>ç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ.jpeg\" alt=\"Broker_V3.1.4_åŸºäºæ–‡ä»¶ç³»ç»Ÿ\"></p>\n<h4 id=\"3-1-1-1-å­˜å‚¨æ¶ˆæ¯åˆ°-CommitLog\"><a href=\"#3-1-1-1-å­˜å‚¨æ¶ˆæ¯åˆ°-CommitLog\" class=\"headerlink\" title=\"3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog\"></a>3.1.1.1 å­˜å‚¨æ¶ˆæ¯åˆ° CommitLog</h4><ul>\n<li>ğŸ¦…å­˜å‚¨ã€halfæ¶ˆæ¯ã€‘åˆ° <code>CommitLog</code> æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>queueOffset</code>ï¼‰ä½¿ç”¨ <code>TranStateTable</code> æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ã€‚è¿™æ ·ï¼Œæ¶ˆæ¯å¯ä»¥ç´¢å¼•åˆ°è‡ªå·±å¯¹åº”çš„ <code>TranStateTable</code> çš„ä½ç½®å’Œè®°å½•ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultAppendMessageCallback.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultAppendMessageCallback</span> <span class=\"keyword\">implements</span> <span class=\"title\">AppendMessageCallback</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"function\"><span class=\"keyword\">public</span> AppendMessageResult <span class=\"title\">doAppend</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> fileFromOffset, <span class=\"keyword\">final</span> ByteBuffer byteBuffer,  <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxBlank, <span class=\"keyword\">final</span> Object msg)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"comment\">// ...çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">5</span>: </div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"comment\">// äº‹åŠ¡æ¶ˆæ¯éœ€è¦ç‰¹æ®Šå¤„ç† </span></div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());</div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType: <span class=\"comment\">// æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆqueueOffsetï¼‰ä½¿ç”¨ TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ </span></div><div class=\"line\"><span class=\"number\">10</span>:             queueOffset = CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().get();</div><div class=\"line\"><span class=\"number\">11</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"><span class=\"number\">13</span>:             queueOffset = msgInner.getQueueOffset();</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionNotType:</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>: </div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"comment\">// ...çœç•¥ä»£ç </span></div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>:         <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType:</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"comment\">// æ›´æ–° TranStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ç‰©ç†ä½ç½®ï¼‰ </span></div><div class=\"line\"><span class=\"number\">26</span>:             CommitLog.<span class=\"keyword\">this</span>.defaultMessageStore.getTransactionStateService().getTranStateTableOffset().incrementAndGet();</div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionNotType:</div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"comment\">// æ›´æ–°ä¸‹ä¸€æ¬¡çš„ConsumeQueueä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">33</span>:             CommitLog.<span class=\"keyword\">this</span>.topicQueueTable.put(key, ++queueOffset);</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">36</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">37</span>:         &#125;</div><div class=\"line\"><span class=\"number\">38</span>: </div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"comment\">// è¿”å›ç»“æœ</span></div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">41</span>:     &#125;</div><div class=\"line\"><span class=\"number\">42</span>: &#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-1-1-2-å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\"><a href=\"#3-1-1-2-å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\" class=\"headerlink\" title=\"3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\"></a>3.1.1.2 å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</h4><ul>\n<li>ğŸ¦…å¤„ç†ã€Halfæ¶ˆæ¯ã€‘æ—¶ï¼Œæ–°å¢ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ã€‚</li>\n<li>ğŸ¦…å¤„ç†ã€Commit / Rollbackæ¶ˆæ¯ã€‘æ—¶ï¼Œæ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ COMMIT / ROLLBACKã€‚</li>\n<li>ğŸ¦…æ¯æ¬¡<strong>å†™æ“ä½œã€</strong>äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆ<code>TranStateTable</code>ï¼‰ï¼Œè®°å½•é‡æ”¾æ—¥å¿—ï¼ˆ<code>TranRedoLog</code>ï¼‰ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DispatchMessageService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.requestsRead.isEmpty()) &#123;</div><div class=\"line\">  <span class=\"number\">4</span>:         <span class=\"keyword\">for</span> (DispatchRequest req : <span class=\"keyword\">this</span>.requestsRead) &#123;</div><div class=\"line\">  <span class=\"number\">5</span>: </div><div class=\"line\">  <span class=\"number\">6</span>:             <span class=\"comment\">// ...çœç•¥ä»£ç </span></div><div class=\"line\">  <span class=\"number\">7</span>: </div><div class=\"line\">  <span class=\"number\">8</span>:             <span class=\"comment\">// 2ã€å†™ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</span></div><div class=\"line\">  <span class=\"number\">9</span>:             <span class=\"keyword\">if</span> (req.getProducerGroup() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">10</span>:                 <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">11</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionNotType:</div><div class=\"line\"> <span class=\"number\">12</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">13</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType:</div><div class=\"line\"> <span class=\"number\">14</span>:                     <span class=\"comment\">// æ–°å¢ ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</span></div><div class=\"line\"> <span class=\"number\">15</span>:                     DefaultMessageStore.<span class=\"keyword\">this</span>.getTransactionStateService().appendPreparedTransaction(</div><div class=\"line\"> <span class=\"number\">16</span>:                         req.getCommitLogOffset(), req.getMsgSize(), (<span class=\"keyword\">int</span>) (req.getStoreTimestamp() / <span class=\"number\">1000</span>), req.getProducerGroup().hashCode());</div><div class=\"line\"> <span class=\"number\">17</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"> <span class=\"number\">19</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"> <span class=\"number\">20</span>:                     <span class=\"comment\">// æ›´æ–° ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰ COMMIT / ROLLBACK</span></div><div class=\"line\"> <span class=\"number\">21</span>:                     DefaultMessageStore.<span class=\"keyword\">this</span>.getTransactionStateService().updateTransactionState(</div><div class=\"line\"> <span class=\"number\">22</span>:                         req.getTranStateTableOffset(), req.getPreparedTransactionOffset(), req.getProducerGroup().hashCode(), tranType);</div><div class=\"line\"> <span class=\"number\">23</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">24</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">25</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">26</span>:             <span class=\"comment\">// 3ã€è®°å½• TranRedoLog</span></div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"> <span class=\"number\">28</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TransactionNotType:</div><div class=\"line\"> <span class=\"number\">29</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">30</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType:</div><div class=\"line\"> <span class=\"number\">31</span>:                 <span class=\"comment\">// è®°å½• TranRedoLog</span></div><div class=\"line\"> <span class=\"number\">32</span>:                 DefaultMessageStore.<span class=\"keyword\">this</span>.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(</div><div class=\"line\"> <span class=\"number\">33</span>:                         req.getCommitLogOffset(), req.getMsgSize(), TransactionStateService.PreparedMessageTagsCode,</div><div class=\"line\"> <span class=\"number\">34</span>:                         req.getStoreTimestamp(), <span class=\"number\">0L</span>);</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">36</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"> <span class=\"number\">37</span>:             <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"> <span class=\"number\">38</span>:                 <span class=\"comment\">// è®°å½• TranRedoLog</span></div><div class=\"line\"> <span class=\"number\">39</span>:                 DefaultMessageStore.<span class=\"keyword\">this</span>.getTransactionStateService().getTranRedoLog().putMessagePostionInfoWrapper(</div><div class=\"line\"> <span class=\"number\">40</span>:                         req.getCommitLogOffset(), req.getMsgSize(), req.getPreparedTransactionOffset(),</div><div class=\"line\"> <span class=\"number\">41</span>:                         req.getStoreTimestamp(), <span class=\"number\">0L</span>);</div><div class=\"line\"> <span class=\"number\">42</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">43</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">44</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">45</span>: </div><div class=\"line\"> <span class=\"number\">46</span>:         <span class=\"comment\">// ...çœç•¥ä»£ç </span></div><div class=\"line\"> <span class=\"number\">47</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">48</span>: &#125;</div><div class=\"line\"> <span class=\"number\">49</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class=\"line\"> <span class=\"number\">50</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 51:  * æ–°å¢äº‹åŠ¡çŠ¶æ€</div><div class=\"line\"> 52:  *</div><div class=\"line\"> 53:  * <span class=\"doctag\">@param</span> clOffset commitLog ç‰©ç†ä½ç½®</div><div class=\"line\"> 54:  * <span class=\"doctag\">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class=\"line\"> 55:  * <span class=\"doctag\">@param</span> timestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´</div><div class=\"line\"> 56:  * <span class=\"doctag\">@param</span> groupHashCode groupHashCode</div><div class=\"line\"> 57:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\"> 58:  */</div><div class=\"line\"> <span class=\"number\">59</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">appendPreparedTransaction</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">60</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> clOffset,//</div><div class=\"line\"> <span class=\"number\">61</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size,//</div><div class=\"line\"> <span class=\"number\">62</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> timestamp,//</div><div class=\"line\"> <span class=\"number\">63</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> groupHashCode//</div><div class=\"line\"> <span class=\"number\">64</span>: ) &#123;</div><div class=\"line\"> <span class=\"number\">65</span>:     MapedFile mapedFile = <span class=\"keyword\">this</span>.tranStateTable.getLastMapedFile();</div><div class=\"line\"> <span class=\"number\">66</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mapedFile) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:         log.error(<span class=\"string\">\"appendPreparedTransaction: create mapedfile error.\"</span>);</div><div class=\"line\"> <span class=\"number\">68</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">70</span>: </div><div class=\"line\"> <span class=\"number\">71</span>:     <span class=\"comment\">// é¦–æ¬¡åˆ›å»ºï¼ŒåŠ å…¥å®šæ—¶ä»»åŠ¡ä¸­</span></div><div class=\"line\"> <span class=\"number\">72</span>:     <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == mapedFile.getWrotePostion()) &#123;</div><div class=\"line\"> <span class=\"number\">73</span>:         <span class=\"keyword\">this</span>.addTimerTask(mapedFile);</div><div class=\"line\"> <span class=\"number\">74</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">75</span>: </div><div class=\"line\"> <span class=\"number\">76</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.position(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">77</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.limit(TSStoreUnitSize);</div><div class=\"line\"> <span class=\"number\">78</span>: </div><div class=\"line\"> <span class=\"number\">79</span>:     <span class=\"comment\">// Commit Log Offset</span></div><div class=\"line\"> <span class=\"number\">80</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putLong(clOffset);</div><div class=\"line\"> <span class=\"number\">81</span>:     <span class=\"comment\">// Message Size</span></div><div class=\"line\"> <span class=\"number\">82</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putInt(size);</div><div class=\"line\"> <span class=\"number\">83</span>:     <span class=\"comment\">// Timestamp</span></div><div class=\"line\"> <span class=\"number\">84</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putInt(timestamp);</div><div class=\"line\"> <span class=\"number\">85</span>:     <span class=\"comment\">// Producer Group Hashcode</span></div><div class=\"line\"> <span class=\"number\">86</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putInt(groupHashCode);</div><div class=\"line\"> <span class=\"number\">87</span>:     <span class=\"comment\">// Transaction State</span></div><div class=\"line\"> <span class=\"number\">88</span>:     <span class=\"keyword\">this</span>.byteBufferAppend.putInt(MessageSysFlag.TransactionPreparedType);</div><div class=\"line\"> <span class=\"number\">89</span>: </div><div class=\"line\"> <span class=\"number\">90</span>:     <span class=\"keyword\">return</span> mapedFile.appendMessage(<span class=\"keyword\">this</span>.byteBufferAppend.array());</div><div class=\"line\"> <span class=\"number\">91</span>: &#125;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 94:  * æ›´æ–°äº‹åŠ¡çŠ¶æ€</div><div class=\"line\"> 95:  *</div><div class=\"line\"> 96:  * <span class=\"doctag\">@param</span> tsOffset tranStateTable ç‰©ç†ä½ç½®</div><div class=\"line\"> 97:  * <span class=\"doctag\">@param</span> clOffset commitLog ç‰©ç†ä½ç½®</div><div class=\"line\"> 98:  * <span class=\"doctag\">@param</span> groupHashCode groupHashCode</div><div class=\"line\"> 99:  * <span class=\"doctag\">@param</span> state äº‹åŠ¡çŠ¶æ€</div><div class=\"line\">100:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\">101:  */</div><div class=\"line\"><span class=\"number\">102</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">updateTransactionState</span><span class=\"params\">(</span></span></div><div class=\"line\"><span class=\"number\">103</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> tsOffset,</div><div class=\"line\"><span class=\"number\">104</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> clOffset,</div><div class=\"line\"><span class=\"number\">105</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> groupHashCode,</div><div class=\"line\"><span class=\"number\">106</span>:         <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> state) &#123;</div><div class=\"line\"><span class=\"number\">107</span>:     SelectMapedBufferResult selectMapedBufferResult = <span class=\"keyword\">this</span>.findTransactionBuffer(tsOffset);</div><div class=\"line\"><span class=\"number\">108</span>:     <span class=\"keyword\">if</span> (selectMapedBufferResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">109</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">110</span>: </div><div class=\"line\"><span class=\"number\">111</span>:             <span class=\"comment\">// ....çœç•¥ä»£ç ï¼šæ ¡éªŒæ˜¯å¦èƒ½å¤Ÿæ›´æ–°</span></div><div class=\"line\"><span class=\"number\">112</span>: </div><div class=\"line\"><span class=\"number\">113</span>:             <span class=\"comment\">// æ›´æ–°äº‹åŠ¡çŠ¶æ€</span></div><div class=\"line\"><span class=\"number\">114</span>:             selectMapedBufferResult.getByteBuffer().putInt(TS_STATE_POS, state);</div><div class=\"line\"><span class=\"number\">115</span>:         &#125;</div><div class=\"line\"><span class=\"number\">116</span>:         <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">117</span>:             log.error(<span class=\"string\">\"updateTransactionState exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">118</span>:         &#125;</div><div class=\"line\"><span class=\"number\">119</span>:         <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">120</span>:             selectMapedBufferResult.release();</div><div class=\"line\"><span class=\"number\">121</span>:         &#125;</div><div class=\"line\"><span class=\"number\">122</span>:     &#125;</div><div class=\"line\"><span class=\"number\">123</span>: </div><div class=\"line\"><span class=\"number\">124</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">125</span>: &#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-1-1-3-ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥\"><a href=\"#3-1-1-3-ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥\" class=\"headerlink\" title=\"3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥\"></a>3.1.1.3 ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥</h4><ul>\n<li>ğŸ¦…<code>TranStateTable</code> æ¯ä¸ª <code>MappedFile</code> éƒ½å¯¹åº”ä¸€ä¸ª <code>Timer</code>ã€‚<code>Timer</code> å›ºå®šå‘¨æœŸï¼ˆé»˜è®¤ï¼š60sï¼‰éå† <code>MappedFile</code>ï¼ŒæŸ¥æ‰¾ã€halfæ¶ˆæ¯ã€‘ï¼Œå‘ <code>Producer</code> å‘èµ·ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥è¯·æ±‚ã€‚ã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥ç»“æœçš„é€»è¾‘ä¸åœ¨æ­¤å¤„è¿›è¡Œï¼Œåœ¨ <a href=\"#3112-å†™äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€å­˜å‚¨transtatetable\">CommitLog dispatch</a>æ—¶æ‰§è¡Œã€‚</li>\n</ul>\n<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</div><div class=\"line\">  4:  */</div><div class=\"line\">  <span class=\"number\">5</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initTimerTask</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">final</span> List&lt;MapedFile&gt; mapedFiles = <span class=\"keyword\">this</span>.tranStateTable.getMapedFiles();</div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"keyword\">for</span> (MapedFile mf : mapedFiles) &#123;</div><div class=\"line\">  <span class=\"number\">9</span>:         <span class=\"keyword\">this</span>.addTimerTask(mf);</div><div class=\"line\"> <span class=\"number\">10</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">11</span>: &#125;</div><div class=\"line\"> <span class=\"number\">12</span>: </div><div class=\"line\"> <span class=\"number\">13</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 14:  * æ¯ä¸ªæ–‡ä»¶åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</div><div class=\"line\"> 15:  * <span class=\"doctag\">@param</span> mf æ–‡ä»¶</div><div class=\"line\"> 16:  */</div><div class=\"line\"> <span class=\"number\">17</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">addTimerTask</span><span class=\"params\">(<span class=\"keyword\">final</span> MapedFile mf)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">18</span>:     <span class=\"keyword\">this</span>.timer.scheduleAtFixedRate(<span class=\"keyword\">new</span> TimerTask() &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MapedFile mapedFile = mf;</div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TransactionCheckExecuter transactionCheckExecuter = TransactionStateService.<span class=\"keyword\">this</span>.defaultMessageStore.getTransactionCheckExecuter();</div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> checkTransactionMessageAtleastInterval = TransactionStateService.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig()</div><div class=\"line\"> <span class=\"number\">22</span>:                     .getCheckTransactionMessageAtleastInterval();</div><div class=\"line\"> <span class=\"number\">23</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> slave = TransactionStateService.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">26</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"comment\">// Slaveä¸éœ€è¦å›æŸ¥äº‹åŠ¡çŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">28</span>:             <span class=\"keyword\">if</span> (slave) &#123;</div><div class=\"line\"> <span class=\"number\">29</span>:                 <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">30</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">31</span>:             <span class=\"comment\">// CheckåŠŸèƒ½æ˜¯å¦å¼€å¯</span></div><div class=\"line\"> <span class=\"number\">32</span>:             <span class=\"keyword\">if</span> (!TransactionStateService.<span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig()</div><div class=\"line\"> <span class=\"number\">33</span>:                 .isCheckTransactionMessageEnable()) &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:                 <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">35</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">36</span>: </div><div class=\"line\"> <span class=\"number\">37</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:                 SelectMapedBufferResult selectMapedBufferResult = mapedFile.selectMapedBuffer(<span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">39</span>:                 <span class=\"keyword\">if</span> (selectMapedBufferResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">40</span>:                     <span class=\"keyword\">long</span> preparedMessageCountInThisMapedFile = <span class=\"number\">0</span>; <span class=\"comment\">// å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡</span></div><div class=\"line\"> <span class=\"number\">41</span>:                     <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">42</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">43</span>:                         <span class=\"comment\">// å¾ªç¯æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€ï¼Œå¯¹ã€halfæ¶ˆæ¯ã€‘è¿›è¡Œå›æŸ¥</span></div><div class=\"line\"> <span class=\"number\">44</span>:                         <span class=\"keyword\">for</span> (; i &lt; selectMapedBufferResult.getSize(); i += TSStoreUnitSize) &#123;</div><div class=\"line\"> <span class=\"number\">45</span>:                             selectMapedBufferResult.getByteBuffer().position(i);</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:                             <span class=\"comment\">// Commit Log Offset</span></div><div class=\"line\"> <span class=\"number\">48</span>:                             <span class=\"keyword\">long</span> clOffset = selectMapedBufferResult.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">49</span>:                             <span class=\"comment\">// Message Size</span></div><div class=\"line\"> <span class=\"number\">50</span>:                             <span class=\"keyword\">int</span> msgSize = selectMapedBufferResult.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">51</span>:                             <span class=\"comment\">// Timestamp</span></div><div class=\"line\"> <span class=\"number\">52</span>:                             <span class=\"keyword\">int</span> timestamp = selectMapedBufferResult.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">53</span>:                             <span class=\"comment\">// Producer Group Hashcode</span></div><div class=\"line\"> <span class=\"number\">54</span>:                             <span class=\"keyword\">int</span> groupHashCode = selectMapedBufferResult.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">55</span>:                             <span class=\"comment\">// Transaction State</span></div><div class=\"line\"> <span class=\"number\">56</span>:                             <span class=\"keyword\">int</span> tranType = selectMapedBufferResult.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:                             <span class=\"comment\">// å·²ç»æäº¤æˆ–è€…å›æ»šçš„æ¶ˆæ¯è·³è¿‡</span></div><div class=\"line\"> <span class=\"number\">59</span>:                             <span class=\"keyword\">if</span> (tranType != MessageSysFlag.TransactionPreparedType) &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:                                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">61</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">62</span>: </div><div class=\"line\"> <span class=\"number\">63</span>:                             <span class=\"comment\">// é‡åˆ°æ—¶é—´ä¸ç¬¦åˆæœ€å°è½®è¯¢é—´éš”ï¼Œç»ˆæ­¢</span></div><div class=\"line\"> <span class=\"number\">64</span>:                             <span class=\"keyword\">long</span> timestampLong = timestamp * <span class=\"number\">1000</span>;</div><div class=\"line\"> <span class=\"number\">65</span>:                             <span class=\"keyword\">long</span> diff = System.currentTimeMillis() - timestampLong;</div><div class=\"line\"> <span class=\"number\">66</span>:                             <span class=\"keyword\">if</span> (diff &lt; checkTransactionMessageAtleastInterval) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:                                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">68</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">69</span>: </div><div class=\"line\"> <span class=\"number\">70</span>:                             preparedMessageCountInThisMapedFile++;</div><div class=\"line\"> <span class=\"number\">71</span>: </div><div class=\"line\"> <span class=\"number\">72</span>:                             <span class=\"comment\">// å›æŸ¥Producer</span></div><div class=\"line\"> <span class=\"number\">73</span>:                             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:                                 <span class=\"keyword\">this</span>.transactionCheckExecuter.gotoCheck(groupHashCode, getTranStateOffset(i), clOffset, msgSize);</div><div class=\"line\"> <span class=\"number\">75</span>:                             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:                                 tranlog.warn(<span class=\"string\">\"gotoCheck Exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">77</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">78</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">79</span>: </div><div class=\"line\"> <span class=\"number\">80</span>:                         <span class=\"comment\">// æ— å›æŸ¥çš„ã€halfæ¶ˆæ¯ã€‘æ•°é‡ï¼Œä¸”éå†å®Œï¼Œåˆ™ç»ˆæ­¢å®šæ—¶ä»»åŠ¡</span></div><div class=\"line\"> <span class=\"number\">81</span>:                         <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == preparedMessageCountInThisMapedFile <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">82</span>:                                 &amp;&amp; i == mapedFile.getFileSize()) &#123;</div><div class=\"line\"> <span class=\"number\">83</span>:                             tranlog.info(<span class=\"string\">\"remove the transaction timer task, because no prepared message in this mapedfile[&#123;&#125;]\"</span>, mapedFile.getFileName());</div><div class=\"line\"> <span class=\"number\">84</span>:                             <span class=\"keyword\">this</span>.cancel();</div><div class=\"line\"> <span class=\"number\">85</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>:                     &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:                         selectMapedBufferResult.release();</div><div class=\"line\"> <span class=\"number\">88</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">89</span>: </div><div class=\"line\"> <span class=\"number\">90</span>:                     tranlog.info(<span class=\"string\">\"the transaction timer task execute over in this period, &#123;&#125; Prepared Message: &#123;&#125; Check Progress: &#123;&#125;/&#123;&#125;\"</span>, mapedFile.getFileName(),<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">91</span>:                             preparedMessageCountInThisMapedFile, i / TSStoreUnitSize, mapedFile.getFileSize() / TSStoreUnitSize);</div><div class=\"line\"> <span class=\"number\">92</span>:                 &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mapedFile.isFull()) &#123;</div><div class=\"line\"> <span class=\"number\">93</span>:                     tranlog.info(<span class=\"string\">\"the mapedfile[&#123;&#125;] maybe deleted, cancel check transaction timer task\"</span>, mapedFile.getFileName());</div><div class=\"line\"> <span class=\"number\">94</span>:                     <span class=\"keyword\">this</span>.cancel();</div><div class=\"line\"> <span class=\"number\">95</span>:                     <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">96</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">97</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:                 log.error(<span class=\"string\">\"check transaction timer task Exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">99</span>:             &#125;</div><div class=\"line\"><span class=\"number\">100</span>:         &#125;</div><div class=\"line\"><span class=\"number\">101</span>: </div><div class=\"line\"><span class=\"number\">102</span>: </div><div class=\"line\"><span class=\"number\">103</span>:         <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">getTranStateOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentIndex)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">104</span>:             <span class=\"keyword\">long</span> offset = (<span class=\"keyword\">this</span>.mapedFile.getFileFromOffset() + currentIndex) / TransactionStateService.TSStoreUnitSize;</div><div class=\"line\"><span class=\"number\">105</span>:             <span class=\"keyword\">return</span> offset;</div><div class=\"line\"><span class=\"number\">106</span>:         &#125;</div><div class=\"line\"><span class=\"number\">107</span>:     &#125;, <span class=\"number\">1000</span> * <span class=\"number\">60</span>, <span class=\"keyword\">this</span>.defaultMessageStore.getMessageStoreConfig().getCheckTransactionMessageTimerInterval());</div><div class=\"line\"><span class=\"number\">108</span>: &#125;</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>: <span class=\"comment\">// ã€DefaultTransactionCheckExecuter.javaã€‘</span></div><div class=\"line\"><span class=\"number\">111</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">112</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">gotoCheck</span><span class=\"params\">(<span class=\"keyword\">int</span> producerGroupHashCode, <span class=\"keyword\">long</span> tranStateTableOffset, <span class=\"keyword\">long</span> commitLogOffset,</span></span></div><div class=\"line\"><span class=\"number\">113</span>:         <span class=\"keyword\">int</span> msgSize) &#123;</div><div class=\"line\"><span class=\"number\">114</span>:     <span class=\"comment\">// ç¬¬ä¸€æ­¥ã€æŸ¥è¯¢Producer</span></div><div class=\"line\"><span class=\"number\">115</span>:     <span class=\"keyword\">final</span> ClientChannelInfo clientChannelInfo = <span class=\"keyword\">this</span>.brokerController.getProducerManager().pickProducerChannelRandomly(producerGroupHashCode);</div><div class=\"line\"><span class=\"number\">116</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == clientChannelInfo) &#123;</div><div class=\"line\"><span class=\"number\">117</span>:         log.warn(<span class=\"string\">\"check a producer transaction state, but not find any channel of this group[&#123;&#125;]\"</span>, producerGroupHashCode);</div><div class=\"line\"><span class=\"number\">118</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">119</span>:     &#125;</div><div class=\"line\"><span class=\"number\">120</span>: </div><div class=\"line\"><span class=\"number\">121</span>:     <span class=\"comment\">// ç¬¬äºŒæ­¥ã€æŸ¥è¯¢æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">122</span>:     SelectMapedBufferResult selectMapedBufferResult = <span class=\"keyword\">this</span>.brokerController.getMessageStore().selectOneMessageByOffset(commitLogOffset, msgSize);</div><div class=\"line\"><span class=\"number\">123</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == selectMapedBufferResult) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:         log.warn(<span class=\"string\">\"check a producer transaction state, but not find message by commitLogOffset: &#123;&#125;, msgSize: \"</span>, commitLogOffset, msgSize);</div><div class=\"line\"><span class=\"number\">125</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">126</span>:     &#125;</div><div class=\"line\"><span class=\"number\">127</span>: </div><div class=\"line\"><span class=\"number\">128</span>:     <span class=\"comment\">// ç¬¬ä¸‰æ­¥ã€å‘Producerå‘èµ·è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">129</span>:     <span class=\"keyword\">final</span> CheckTransactionStateRequestHeader requestHeader = <span class=\"keyword\">new</span> CheckTransactionStateRequestHeader();</div><div class=\"line\"><span class=\"number\">130</span>:     requestHeader.setCommitLogOffset(commitLogOffset);</div><div class=\"line\"><span class=\"number\">131</span>:     requestHeader.setTranStateTableOffset(tranStateTableOffset);</div><div class=\"line\"><span class=\"number\">132</span>:     <span class=\"keyword\">this</span>.brokerController.getBroker2Client().checkProducerTransactionState(clientChannelInfo.getChannel(), requestHeader, selectMapedBufferResult);</div><div class=\"line\"><span class=\"number\">133</span>: &#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-1-1-4-åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\"><a href=\"#3-1-1-4-åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\" class=\"headerlink\" title=\"3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰\"></a>3.1.1.4 åˆå§‹åŒ–ã€äº‹åŠ¡æ¶ˆæ¯ã€‘çŠ¶æ€å­˜å‚¨ï¼ˆTranStateTableï¼‰</h4><ul>\n<li>ğŸ¦…æ ¹æ®æœ€å Broker å…³é—­æ˜¯å¦æ­£å¸¸ï¼Œä¼šæœ‰ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼ã€‚</li>\n</ul>\n<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€TransactionStateService.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * åˆå§‹åŒ– TranRedoLog</div><div class=\"line\">  4:  * <span class=\"doctag\">@param</span> lastExitOK æ˜¯å¦æ­£å¸¸é€€å‡º</div><div class=\"line\">  5:  */</div><div class=\"line\">  <span class=\"number\">6</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">recoverStateTable</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> lastExitOK)</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">if</span> (lastExitOK) &#123;</div><div class=\"line\">  <span class=\"number\">8</span>:         <span class=\"keyword\">this</span>.recoverStateTableNormal();</div><div class=\"line\">  <span class=\"number\">9</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">10</span>:         <span class=\"comment\">// ç¬¬ä¸€æ­¥ï¼Œåˆ é™¤State Table</span></div><div class=\"line\"> <span class=\"number\">11</span>:         <span class=\"keyword\">this</span>.tranStateTable.destroy();</div><div class=\"line\"> <span class=\"number\">12</span>:         <span class=\"comment\">// ç¬¬äºŒæ­¥ï¼Œé€šè¿‡RedoLogå…¨é‡æ¢å¤StateTable</span></div><div class=\"line\"> <span class=\"number\">13</span>:         <span class=\"keyword\">this</span>.recreateStateTable();</div><div class=\"line\"> <span class=\"number\">14</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">15</span>: &#125;</div><div class=\"line\"> <span class=\"number\">16</span>: </div><div class=\"line\"> <span class=\"number\">17</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 18:  * æ‰«æ TranRedoLog é‡å»º StateTable</div><div class=\"line\"> 19:  */</div><div class=\"line\"> <span class=\"number\">20</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">recreateStateTable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">21</span>:     <span class=\"keyword\">this</span>.tranStateTable = <span class=\"keyword\">new</span> MapedFileQueue(StorePathConfigHelper.getTranStateTableStorePath(defaultMessageStore</div><div class=\"line\"> <span class=\"number\">22</span>:                 .getMessageStoreConfig().getStorePathRootDir()), defaultMessageStore</div><div class=\"line\"> <span class=\"number\">23</span>:                 .getMessageStoreConfig().getTranStateTableMapedFileSize(), <span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:     <span class=\"keyword\">final</span> TreeSet&lt;Long&gt; preparedItemSet = <span class=\"keyword\">new</span> TreeSet&lt;Long&gt;();</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:     <span class=\"comment\">// ç¬¬ä¸€æ­¥ï¼Œä»å¤´æ‰«æRedoLog</span></div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> minOffset = <span class=\"keyword\">this</span>.tranRedoLog.getMinOffsetInQuque();</div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">long</span> processOffset = minOffset;</div><div class=\"line\"> <span class=\"number\">30</span>:     <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\"> <span class=\"number\">31</span>:         SelectMapedBufferResult bufferConsumeQueue = <span class=\"keyword\">this</span>.tranRedoLog.getIndexBuffer(processOffset);</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"keyword\">if</span> (bufferConsumeQueue != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">33</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:                 <span class=\"keyword\">long</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"keyword\">for</span> (; i &lt; bufferConsumeQueue.getSize(); i += ConsumeQueue.CQStoreUnitSize) &#123;</div><div class=\"line\"> <span class=\"number\">36</span>:                     <span class=\"keyword\">long</span> offsetMsg = bufferConsumeQueue.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">37</span>:                     <span class=\"keyword\">int</span> sizeMsg = bufferConsumeQueue.getByteBuffer().getInt();</div><div class=\"line\"> <span class=\"number\">38</span>:                     <span class=\"keyword\">long</span> tagsCode = bufferConsumeQueue.getByteBuffer().getLong();</div><div class=\"line\"> <span class=\"number\">39</span>: </div><div class=\"line\"> <span class=\"number\">40</span>:                     <span class=\"keyword\">if</span> (TransactionStateService.PreparedMessageTagsCode == tagsCode) &#123; <span class=\"comment\">// Prepared</span></div><div class=\"line\"> <span class=\"number\">41</span>:                         preparedItemSet.add(offsetMsg);</div><div class=\"line\"> <span class=\"number\">42</span>:                     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// Commit/Rollback</span></div><div class=\"line\"> <span class=\"number\">43</span>:                         preparedItemSet.remove(tagsCode);</div><div class=\"line\"> <span class=\"number\">44</span>:                     &#125;</div><div class=\"line\"> <span class=\"number\">45</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">46</span>: </div><div class=\"line\"> <span class=\"number\">47</span>:                 processOffset += i;</div><div class=\"line\"> <span class=\"number\">48</span>:             &#125; <span class=\"keyword\">finally</span> &#123; <span class=\"comment\">// å¿…é¡»é‡Šæ”¾èµ„æº</span></div><div class=\"line\"> <span class=\"number\">49</span>:                 bufferConsumeQueue.release();</div><div class=\"line\"> <span class=\"number\">50</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">51</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">53</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">54</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">55</span>:     log.info(<span class=\"string\">\"scan transaction redolog over, End offset: &#123;&#125;,  Prepared Transaction Count: &#123;&#125;\"</span>, processOffset, preparedItemSet.size());</div><div class=\"line\"> <span class=\"number\">56</span>: </div><div class=\"line\"> <span class=\"number\">57</span>:     <span class=\"comment\">// ç¬¬äºŒæ­¥ï¼Œé‡å»ºStateTable</span></div><div class=\"line\"> <span class=\"number\">58</span>:     Iterator&lt;Long&gt; it = preparedItemSet.iterator();</div><div class=\"line\"> <span class=\"number\">59</span>:     <span class=\"keyword\">while</span> (it.hasNext()) &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:         Long offset = it.next();</div><div class=\"line\"> <span class=\"number\">61</span>:         MessageExt msgExt = <span class=\"keyword\">this</span>.defaultMessageStore.lookMessageByOffset(offset);</div><div class=\"line\"> <span class=\"number\">62</span>:         <span class=\"keyword\">if</span> (msgExt != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:             <span class=\"keyword\">this</span>.appendPreparedTransaction(msgExt.getCommitLogOffset(), msgExt.getStoreSize(),</div><div class=\"line\"> <span class=\"number\">64</span>:                 (<span class=\"keyword\">int</span>) (msgExt.getStoreTimestamp() / <span class=\"number\">1000</span>),</div><div class=\"line\"> <span class=\"number\">65</span>:                 msgExt.getProperty(MessageConst.PROPERTY_PRODUCER_GROUP).hashCode());</div><div class=\"line\"> <span class=\"number\">66</span>:             <span class=\"keyword\">this</span>.tranStateTableOffset.incrementAndGet();</div><div class=\"line\"> <span class=\"number\">67</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">68</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">69</span>: &#125;</div><div class=\"line\"> <span class=\"number\">70</span>: </div><div class=\"line\"> <span class=\"number\">71</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 72:  * åŠ è½½ï¼ˆè§£æï¼‰TranStateTable çš„ MappedFile</div><div class=\"line\"> 73:  * 1. æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position</div><div class=\"line\"> 74:  * 2. è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰</div><div class=\"line\"> 75:  */</div><div class=\"line\"> <span class=\"number\">76</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">recoverStateTableNormal</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">77</span>:     <span class=\"keyword\">final</span> List&lt;MapedFile&gt; mapedFiles = <span class=\"keyword\">this</span>.tranStateTable.getMapedFiles();</div><div class=\"line\"> <span class=\"number\">78</span>:     <span class=\"keyword\">if</span> (!mapedFiles.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">79</span>:         <span class=\"comment\">// ä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹æ¢å¤</span></div><div class=\"line\"> <span class=\"number\">80</span>:         <span class=\"keyword\">int</span> index = mapedFiles.size() - <span class=\"number\">3</span>;</div><div class=\"line\"> <span class=\"number\">81</span>:         <span class=\"keyword\">if</span> (index &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">82</span>:             index = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">83</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">84</span>: </div><div class=\"line\"> <span class=\"number\">85</span>:         <span class=\"keyword\">int</span> mapedFileSizeLogics = <span class=\"keyword\">this</span>.tranStateTable.getMapedFileSize();</div><div class=\"line\"> <span class=\"number\">86</span>:         MapedFile mapedFile = mapedFiles.get(index);</div><div class=\"line\"> <span class=\"number\">87</span>:         ByteBuffer byteBuffer = mapedFile.sliceByteBuffer();</div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">long</span> processOffset = mapedFile.getFileFromOffset();</div><div class=\"line\"> <span class=\"number\">89</span>:         <span class=\"keyword\">long</span> mapedFileOffset = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\"> <span class=\"number\">91</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; mapedFileSizeLogics; i += TSStoreUnitSize) &#123;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> clOffset_read = byteBuffer.getLong();</div><div class=\"line\"> <span class=\"number\">94</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size_read = byteBuffer.getInt();</div><div class=\"line\"> <span class=\"number\">95</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> timestamp_read = byteBuffer.getInt();</div><div class=\"line\"> <span class=\"number\">96</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> groupHashCode_read = byteBuffer.getInt();</div><div class=\"line\"> <span class=\"number\">97</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> state_read = byteBuffer.getInt();</div><div class=\"line\"> <span class=\"number\">98</span>: </div><div class=\"line\"> <span class=\"number\">99</span>:                 <span class=\"keyword\">boolean</span> stateOK = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">100</span>:                 <span class=\"keyword\">switch</span> (state_read) &#123;</div><div class=\"line\"><span class=\"number\">101</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionPreparedType:</div><div class=\"line\"><span class=\"number\">102</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionCommitType:</div><div class=\"line\"><span class=\"number\">103</span>:                 <span class=\"keyword\">case</span> MessageSysFlag.TransactionRollbackType:</div><div class=\"line\"><span class=\"number\">104</span>:                     stateOK = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">105</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">106</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">107</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">108</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>:                 <span class=\"comment\">// è¯´æ˜å½“å‰å­˜å‚¨å•å…ƒæœ‰æ•ˆ</span></div><div class=\"line\"><span class=\"number\">111</span>:                 <span class=\"keyword\">if</span> (clOffset_read &gt;= <span class=\"number\">0</span> &amp;&amp; size_read &gt; <span class=\"number\">0</span> &amp;&amp; stateOK) &#123;</div><div class=\"line\"><span class=\"number\">112</span>:                     mapedFileOffset = i + TSStoreUnitSize;</div><div class=\"line\"><span class=\"number\">113</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">114</span>:                     log.info(<span class=\"string\">\"recover current transaction state table file over,  \"</span> + mapedFile.getFileName() + <span class=\"string\">\" \"</span></div><div class=\"line\"><span class=\"number\">115</span>:                             + clOffset_read + <span class=\"string\">\" \"</span> + size_read + <span class=\"string\">\" \"</span> + timestamp_read);</div><div class=\"line\"><span class=\"number\">116</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">117</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">118</span>:             &#125;</div><div class=\"line\"><span class=\"number\">119</span>: </div><div class=\"line\"><span class=\"number\">120</span>:             <span class=\"comment\">// èµ°åˆ°æ–‡ä»¶æœ«å°¾ï¼Œåˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªæ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">121</span>:             <span class=\"keyword\">if</span> (mapedFileOffset == mapedFileSizeLogics) &#123;</div><div class=\"line\"><span class=\"number\">122</span>:                 index++;</div><div class=\"line\"><span class=\"number\">123</span>:                 <span class=\"keyword\">if</span> (index &gt;= mapedFiles.size()) &#123; <span class=\"comment\">// å¾ªç¯whileç»“æŸ</span></div><div class=\"line\"><span class=\"number\">124</span>:                     log.info(<span class=\"string\">\"recover last transaction state table file over, last maped file \"</span> + mapedFile.getFileName());</div><div class=\"line\"><span class=\"number\">125</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">126</span>:                 &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// åˆ‡æ¢ä¸‹ä¸€ä¸ªæ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">127</span>:                     mapedFile = mapedFiles.get(index);</div><div class=\"line\"><span class=\"number\">128</span>:                     byteBuffer = mapedFile.sliceByteBuffer();</div><div class=\"line\"><span class=\"number\">129</span>:                     processOffset = mapedFile.getFileFromOffset();</div><div class=\"line\"><span class=\"number\">130</span>:                     mapedFileOffset = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">131</span>:                     log.info(<span class=\"string\">\"recover next transaction state table file, \"</span> + mapedFile.getFileName());</div><div class=\"line\"><span class=\"number\">132</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">133</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">134</span>:                 log.info(<span class=\"string\">\"recover current transaction state table queue over \"</span> + mapedFile.getFileName() + <span class=\"string\">\" \"</span> + (processOffset + mapedFileOffset));</div><div class=\"line\"><span class=\"number\">135</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">136</span>:             &#125;</div><div class=\"line\"><span class=\"number\">137</span>:         &#125;</div><div class=\"line\"><span class=\"number\">138</span>: </div><div class=\"line\"><span class=\"number\">139</span>:         <span class=\"comment\">// æ¸…ç†å¤šä½™ MappedFileï¼Œè®¾ç½®æœ€åä¸€ä¸ª MappedFileçš„å†™å…¥ä½ç½®(position</span></div><div class=\"line\"><span class=\"number\">140</span>:         processOffset += mapedFileOffset;</div><div class=\"line\"><span class=\"number\">141</span>:         <span class=\"keyword\">this</span>.tranStateTable.truncateDirtyFiles(processOffset);</div><div class=\"line\"><span class=\"number\">142</span>: </div><div class=\"line\"><span class=\"number\">143</span>:         <span class=\"comment\">// è®¾ç½® TanStateTable æœ€å¤§ç‰©ç†ä½ç½®ï¼ˆå¯å†™å…¥ä½ç½®ï¼‰</span></div><div class=\"line\"><span class=\"number\">144</span>:         <span class=\"keyword\">this</span>.tranStateTableOffset.set(<span class=\"keyword\">this</span>.tranStateTable.getMaxOffset() / TSStoreUnitSize);</div><div class=\"line\"><span class=\"number\">145</span>:         log.info(<span class=\"string\">\"recover normal over, transaction state table max offset: &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.tranStateTableOffset.get());</div><div class=\"line\"><span class=\"number\">146</span>:     &#125;</div><div class=\"line\"><span class=\"number\">147</span>: &#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-1-1-5-è¡¥å……\"><a href=\"#3-1-1-5-è¡¥å……\" class=\"headerlink\" title=\"3.1.1.5 è¡¥å……\"></a>3.1.1.5 è¡¥å……</h4><ul>\n<li>ä¸ºä»€ä¹ˆ V3.1.5 å¼€å§‹ï¼Œä½¿ç”¨ æ•°æ®åº“ å®ç°ã€äº‹åŠ¡çŠ¶æ€ã€‘çš„å­˜å‚¨ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼Œå¯èƒ½æ˜¯ä¸€éƒ¨åˆ†åŸå› ï¼š</li>\n</ul>\n<blockquote>\n<p>RocketMQ è¿™ç§å®ç°äº‹åŠ¡æ–¹å¼ï¼Œæ²¡æœ‰é€šè¿‡ KV å­˜å‚¨åšï¼Œè€Œæ˜¯é€šè¿‡ Offset æ–¹å¼ï¼Œå­˜åœ¨ä¸€ä¸ªæ˜¾è‘—ç¼ºé™·ï¼Œå³é€šè¿‡ Offset æ›´æ”¹æ•°æ®ï¼Œä¼šä»¤ç³»ç»Ÿçš„è„é¡µè¿‡å¤šï¼Œéœ€è¦ç‰¹åˆ«å…³æ³¨ã€‚</p>\n</blockquote>\n<h3 id=\"3-1-2-å®˜æ–¹V4-0-0ï¼šåŸºäºæ•°æ®åº“\"><a href=\"#3-1-2-å®˜æ–¹V4-0-0ï¼šåŸºäºæ•°æ®åº“\" class=\"headerlink\" title=\"3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“\"></a>3.1.2 å®˜æ–¹V4.0.0ï¼šåŸºäºæ•°æ®åº“</h3><blockquote>\n<p>ä»“åº“åœ°å€ï¼š<a href=\"https://github.com/apache/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/apache/incubator-rocketmq</a></p>\n</blockquote>\n<p>å®˜æ–¹V4.0.0 æš‚æ—¶æœª<strong>å®Œå…¨</strong>å¼€æºã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘åŠŸèƒ½ï¼Œ<strong>So æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›çŒœæƒ³ï¼Œå¯èƒ½ä¸ä¸€å®šæ­£ç¡®ğŸ˜ˆ</strong>ã€‚</p>\n<p>ğŸ˜†æˆ‘ä»¬æ¥å¯¹æ¯”ã€å®˜æ–¹V3.1.4ï¼šåŸºäºæ–‡ä»¶ã€‘çš„å®ç°ã€‚</p>\n<ul>\n<li>TransactionRecord ï¼šè®°å½•æ¯æ¡ã€äº‹åŠ¡æ¶ˆæ¯ã€‘ã€‚ç±»ä¼¼ <code>TranStateTable</code>ã€‚</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>TranStateTable</th>\n<th>TransactionRecord</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>offset</td>\n<td>offset</td>\n<td></td>\n</tr>\n<tr>\n<td>producerGroupHash</td>\n<td>producerGroup</td>\n<td></td>\n</tr>\n<tr>\n<td>size</td>\n<td>æ— </td>\n<td>éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚</td>\n</tr>\n<tr>\n<td>timestamp</td>\n<td>æ— </td>\n<td>éå¿…é¡»å­—æ®µï¼šã€äº‹åŠ¡æ¶ˆæ¯ã€‘å›æŸ¥æ—¶ï¼Œä½¿ç”¨ offset è¯»å– CommitLog è·å¾—ã€‚</td>\n</tr>\n<tr>\n<td>state</td>\n<td>æ— </td>\n<td>éå¿…é¡»å­—æ®µï¼š äº‹åŠ¡å¼€å§‹ï¼Œå¢åŠ è®°å½•ï¼›äº‹åŠ¡ç»“æŸï¼Œåˆ é™¤è®°å½•ã€‚</td>\n</tr>\n</tbody>\n</table>\n<p>å¦å¤–ï¼Œæ•°æ®åº“æœ¬èº«ä¿è¯äº†æ•°æ®å­˜å‚¨çš„å¯é æ€§ï¼Œæ— éœ€ <code>TranRedoLog</code>ã€‚</p>\n<hr>\n<p>ç®€å•æ‰‹ç»˜é€»è¾‘å›¾å¦‚ä¸‹ğŸ˜ˆï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Broker_V4.0.0_åŸºäºæ•°æ®åº“.jpeg\" alt=\"Broker_V4.0.0_åŸºäºæ•°æ®åº“\"></p>\n<h2 id=\"3-2-Producer-æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"><a href=\"#3-2-Producer-æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\" class=\"headerlink\" title=\"3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"></a>3.2 Producer æ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘</h2><ul>\n<li>é¡ºåºå›¾å¦‚ä¸‹ï¼š</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/YunaiV/Blog/master/RocketMQ/images/1011/Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘.png\" alt=\"Produceræ¥æ”¶ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘\"></p>\n<ul>\n<li>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class=\"line\">  <span class=\"number\">2</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  3:  * æ£€æŸ¥ã€äº‹åŠ¡çŠ¶æ€ã€‘çŠ¶æ€</div><div class=\"line\">  4:  *</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> addr brokeråœ°å€</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> header è¯·æ±‚</div><div class=\"line\">  8:  */</div><div class=\"line\">  <span class=\"number\">9</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">checkTransactionState</span><span class=\"params\">(<span class=\"keyword\">final</span> String addr, <span class=\"keyword\">final</span> MessageExt msg, <span class=\"keyword\">final</span> CheckTransactionStateRequestHeader header)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">11</span>:     Runnable request = <span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">12</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String brokerAddr = addr;</div><div class=\"line\"> <span class=\"number\">13</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MessageExt message = msg;</div><div class=\"line\"> <span class=\"number\">14</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> CheckTransactionStateRequestHeader checkRequestHeader = header;</div><div class=\"line\"> <span class=\"number\">15</span>:         <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String group = DefaultMQProducerImpl.<span class=\"keyword\">this</span>.defaultMQProducer.getProducerGroup();</div><div class=\"line\"> <span class=\"number\">16</span>: </div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             TransactionCheckListener transactionCheckListener = DefaultMQProducerImpl.<span class=\"keyword\">this</span>.checkListener();</div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"keyword\">if</span> (transactionCheckListener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:                 <span class=\"comment\">// è·å–äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">22</span>:                 LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;</div><div class=\"line\"> <span class=\"number\">23</span>:                 Throwable exception = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">24</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:                     localTransactionState = transactionCheckListener.checkLocalTransactionState(message);</div><div class=\"line\"> <span class=\"number\">26</span>:                 &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">27</span>:                     log.error(<span class=\"string\">\"Broker call checkTransactionState, but checkLocalTransactionState exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">28</span>:                     exception = e;</div><div class=\"line\"> <span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">30</span>: </div><div class=\"line\"> <span class=\"number\">31</span>:                 <span class=\"comment\">// å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class=\"line\"> <span class=\"number\">32</span>:                 <span class=\"keyword\">this</span>.processTransactionState(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">33</span>:                     localTransactionState, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">34</span>:                     group, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">35</span>:                     exception);</div><div class=\"line\"> <span class=\"number\">36</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">37</span>:                 log.warn(<span class=\"string\">\"checkTransactionState, pick transactionCheckListener by group[&#123;&#125;] failed\"</span>, group);</div><div class=\"line\"> <span class=\"number\">38</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">39</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">40</span>: </div><div class=\"line\"> <span class=\"number\">41</span>:         <span class=\"comment\">/**</span></div><div class=\"line\"> 42:          * å¤„ç†äº‹åŠ¡ç»“æœï¼Œæäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</div><div class=\"line\"> 43:          *</div><div class=\"line\"> 44:          * <span class=\"doctag\">@param</span> localTransactionState ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class=\"line\"> 45:          * <span class=\"doctag\">@param</span> producerGroup producerGroup</div><div class=\"line\"> 46:          * <span class=\"doctag\">@param</span> exception æ£€æŸ¥ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€å‘ç”Ÿçš„å¼‚å¸¸</div><div class=\"line\"> 47:          */</div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">processTransactionState</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">49</span>:             <span class=\"keyword\">final</span> LocalTransactionState localTransactionState, //</div><div class=\"line\"> <span class=\"number\">50</span>:             <span class=\"keyword\">final</span> String producerGroup, //</div><div class=\"line\"> <span class=\"number\">51</span>:             <span class=\"keyword\">final</span> Throwable exception) &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:             <span class=\"keyword\">final</span> EndTransactionRequestHeader thisHeader = <span class=\"keyword\">new</span> EndTransactionRequestHeader();</div><div class=\"line\"> <span class=\"number\">53</span>:             thisHeader.setCommitLogOffset(checkRequestHeader.getCommitLogOffset());</div><div class=\"line\"> <span class=\"number\">54</span>:             thisHeader.setProducerGroup(producerGroup);</div><div class=\"line\"> <span class=\"number\">55</span>:             thisHeader.setTranStateTableOffset(checkRequestHeader.getTranStateTableOffset());</div><div class=\"line\"> <span class=\"number\">56</span>:             thisHeader.setFromTransactionCheck(<span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:             <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯ç¼–å·</span></div><div class=\"line\"> <span class=\"number\">59</span>:             String uniqueKey = message.getProperties().get(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX);</div><div class=\"line\"> <span class=\"number\">60</span>:             <span class=\"keyword\">if</span> (uniqueKey == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">61</span>:                 uniqueKey = message.getMsgId();</div><div class=\"line\"> <span class=\"number\">62</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">63</span>:             thisHeader.setMsgId(uniqueKey);</div><div class=\"line\"> <span class=\"number\">64</span>: </div><div class=\"line\"> <span class=\"number\">65</span>:             thisHeader.setTransactionId(checkRequestHeader.getTransactionId());</div><div class=\"line\"> <span class=\"number\">66</span>:             <span class=\"keyword\">switch</span> (localTransactionState) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:                 <span class=\"keyword\">case</span> COMMIT_MESSAGE:</div><div class=\"line\"> <span class=\"number\">68</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_COMMIT_TYPE);</div><div class=\"line\"> <span class=\"number\">69</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">70</span>:                 <span class=\"keyword\">case</span> ROLLBACK_MESSAGE:</div><div class=\"line\"> <span class=\"number\">71</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_ROLLBACK_TYPE);</div><div class=\"line\"> <span class=\"number\">72</span>:                     log.warn(<span class=\"string\">\"when broker check, client rollback this transaction, &#123;&#125;\"</span>, thisHeader);</div><div class=\"line\"> <span class=\"number\">73</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">74</span>:                 <span class=\"keyword\">case</span> UNKNOW:</div><div class=\"line\"> <span class=\"number\">75</span>:                     thisHeader.setCommitOrRollback(MessageSysFlag.TRANSACTION_NOT_TYPE);</div><div class=\"line\"> <span class=\"number\">76</span>:                     log.warn(<span class=\"string\">\"when broker check, client does not know this transaction state, &#123;&#125;\"</span>, thisHeader);</div><div class=\"line\"> <span class=\"number\">77</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">78</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">79</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">80</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">81</span>: </div><div class=\"line\"> <span class=\"number\">82</span>:             String remark = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">83</span>:             <span class=\"keyword\">if</span> (exception != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">84</span>:                 remark = <span class=\"string\">\"checkLocalTransactionState Exception: \"</span> + RemotingHelper.exceptionSimpleDesc(exception);</div><div class=\"line\"> <span class=\"number\">85</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">86</span>: </div><div class=\"line\"> <span class=\"number\">87</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">88</span>:                 <span class=\"comment\">// æäº¤æ¶ˆæ¯ COMMIT / ROLLBACK</span></div><div class=\"line\"> <span class=\"number\">89</span>:                 DefaultMQProducerImpl.<span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, thisHeader, remark,</div><div class=\"line\"> <span class=\"number\">90</span>:                     <span class=\"number\">3000</span>);</div><div class=\"line\"> <span class=\"number\">91</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">92</span>:                 log.error(<span class=\"string\">\"endTransactionOneway exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">93</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">94</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">95</span>:     &#125;;</div><div class=\"line\"> <span class=\"number\">96</span>: </div><div class=\"line\"> <span class=\"number\">97</span>:     <span class=\"comment\">// æäº¤æ‰§è¡Œ</span></div><div class=\"line\"> <span class=\"number\">98</span>:     <span class=\"keyword\">this</span>.checkExecutor.submit(request);</div><div class=\"line\"> <span class=\"number\">99</span>: &#125;</div><div class=\"line\"><span class=\"number\">100</span>: </div><div class=\"line\"><span class=\"number\">101</span>: <span class=\"comment\">// â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span></div><div class=\"line\"><span class=\"number\">102</span>: <span class=\"comment\">/**</span></div><div class=\"line\">103:  * ã€äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‘æ£€æŸ¥ç›‘å¬å™¨</div><div class=\"line\">104:  */</div><div class=\"line\"><span class=\"number\">105</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">TransactionCheckListener</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">108:      * è·å–ï¼ˆæ£€æŸ¥ï¼‰ã€æœ¬åœ°äº‹åŠ¡ã€‘çŠ¶æ€</div><div class=\"line\">109:      *</div><div class=\"line\">110:      * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\">111:      * <span class=\"doctag\">@return</span> äº‹åŠ¡çŠ¶æ€</div><div class=\"line\">112:      */</div><div class=\"line\"><span class=\"number\">113</span>:     <span class=\"function\">LocalTransactionState <span class=\"title\">checkLocalTransactionState</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageExt msg)</span></span>;</div><div class=\"line\"><span class=\"number\">114</span>: </div><div class=\"line\"><span class=\"number\">115</span>: &#125;</div></pre></td></tr></table></figure>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰","date":"2017-05-03T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[http://www.yunai.me/RocketMQ/message-pull-and-consume-first/](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/)  \n> `RocketMQ` **å¸¦æ³¨é‡Šæºç **åœ°å€ ï¼š[https://github.com/YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **  \n\n![wechat_mp](http://www.yunai.me/images/common/wechat_mp.jpeg)\n\n-------\n\n- [1ã€æ¦‚è¿°](#)\n- [2ã€ConsumeQueue ç»“æ„](#)\n- [3ã€ConsumeQueue å­˜å‚¨](#)\n\t- [ReputMessageService](#)\n\t\t- [DefaultMessageStore#doDispatch(...)](#)\n\t\t- [ConsumeQueue#putMessagePositionInfoWrapper(...)](#)\n\t- [FlushConsumeQueueService](#)\n- [4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£](#)\n\t- [PullMessageRequestHeader](#)\n\t- [PullMessageProcessor#processRequest(...)](#)\n\t- [MessageStore#getMessage(...)](#)\n\t- [DefaultMessageFilter#isMessageMatched(...)](#)\n\t- [PullRequestHoldService](#)\n\t- [PullMessageProcessor#executeRequestWhenWakeup(...)](#)\n- [5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£](#)\n\t- [BrokerController#initialize(...)](#)\n\t- [ConfigManager](#)\n\t\t- [MixAll#string2File(...)](#)\n\t- [ConsumerOffsetManager](#)\n- [6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£](#)\n\t- [SendMessageProcessor#consumerSendMsgBack(...)](#)\n- [7ã€ç»“å°¾](#)\n\n# 1ã€æ¦‚è¿°\n\næœ¬ç« ä¸»è¦è§£æ **æ¶ˆè´¹** é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚\nå› ä¸ºç¯‡å¹…è¾ƒé•¿ï¼Œåˆ†æˆä¸Šä¸‹ä¸¤ç¯‡ï¼š\n\n1. ä¸Šç¯‡ï¼š`Broker` ç›¸å…³æºç ã€‚\n2. ä¸‹ç¯‡ï¼š`Consumer` ç›¸å…³æºç ã€‚\n\n*æœ¬æ–‡å³æ˜¯ä¸Šç¯‡ã€‚*\n\n-------\n\nokï¼Œå…ˆçœ‹ç¬¬ä¸€å¼ å…³äºæ¶ˆè´¹é€»è¾‘çš„å›¾ï¼š\n\n> ![æ¶ˆè´¹é€»è¾‘å›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/13.png)\n\nå†çœ‹æ¶ˆè´¹é€»è¾‘ç²¾ç®€çš„é¡ºåºå›¾ï¼ˆå®é™…æƒ…å†µä¼šç•¥æœ‰å·®åˆ«ï¼‰ï¼š\n\n> ![Consumer&Brokeræ¶ˆè´¹ç²¾ç®€å›¾.png](http://www.yunai.me/images/RocketMQ/2017_05_04/04.png)\n\n# 2ã€ConsumeQueue ç»“æ„\n\n`ConsumeQueue`ã€`MappedFileQueue`ã€`MappedFile` çš„å…³ç³»å¦‚ä¸‹ï¼š\n\n> ![ConsumeQueueã€MappedFileQueueã€MappedFileçš„å…³ç³»](http://www.yunai.me/images/RocketMQ/2017_05_04/03.png)\n`ConsumeQueue` : `MappedFileQueue` : `MappedFile` = 1 : 1 : Nã€‚\n\nååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š\n\n```bash\nYunai-MacdeMacBook-Pro-2:consumequeue yunai$ pwd\n/Users/yunai/store/consumequeue\nYunai-MacdeMacBook-Pro-2:consumequeue yunai$ cd TopicRead3/\nYunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ ls -ls\ntotal 0\n0 drwxr-xr-x  3 yunai  staff  102  4 27 21:52 0\n0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 1\n0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 2\n0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 3\nYunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ cd 0/\nYunai-MacdeMacBook-Pro-2:0 yunai$ ls -ls\ntotal 11720\n11720 -rw-r--r--  1 yunai  staff  6000000  4 27 21:55 00000000000000000000\n```\n\n-------\n\n`ConsumeQueue`ã€`MappedFileQueue`ã€`MappedFile` çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n* `MappedFile` ï¼š00000000000000000000ç­‰æ–‡ä»¶ã€‚\n* `MappedFileQueue` ï¼š`MappedFile` æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ `MappedFile` è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚\n    * æ¯ä¸ª `MappedFile` ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚\n    * æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ `ConsumeQueue` é‡Œé»˜è®¤ä¸º 6000000Bã€‚\n* `ConsumeQueue` ï¼šé’ˆå¯¹ `MappedFileQueue` çš„å°è£…ä½¿ç”¨ã€‚\n    * `Store : ConsumeQueue = ConcurrentHashMap<String/* topic */, ConcurrentHashMap<Integer/* queueId */, ConsumeQueue>>`ã€‚\n\n`ConsumeQueue` å­˜å‚¨åœ¨ `MappedFile` çš„å†…å®¹**å¿…é¡»**å¤§å°æ˜¯ 20B( `ConsumeQueue.CQ_STORE_UNIT_SIZE` )ï¼Œæœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š\n\n1. `MESSAGE_POSITION_INFO` ï¼šæ¶ˆæ¯ä½ç½®ä¿¡æ¯ã€‚\n2. `BLANK` : æ–‡ä»¶å‰ç½®ç©ºç™½å ä½ã€‚å½“å†å² `Message` è¢«åˆ é™¤æ—¶ï¼Œéœ€è¦ç”¨ `BLANK`å ä½è¢«åˆ é™¤çš„æ¶ˆæ¯ã€‚\n\n`MESSAGE_POSITION_INFO` åœ¨ `ConsumeQueue` å­˜å‚¨ç»“æ„ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | offset | æ¶ˆæ¯ `CommitLog` å­˜å‚¨ä½ç½® | Long | 8 |\n| 2 | size | æ¶ˆæ¯é•¿åº¦ | Int | 4 |\n| 3 | tagsCode | æ¶ˆæ¯tagsCode | Long | 8 |\n\n`BLANK` åœ¨ `ConsumeQueue` å­˜å‚¨ç»“æ„ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | | 0 | Long | 8 |\n| 2 | | Integer.MAX_VALUE | Int | 4 |\n| 3 | | 0 | Long | 8 |\n\n# 3ã€ConsumeQueue å­˜å‚¨\n\n![CommitLogé‡æ”¾ConsumeQueueå›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/02.png)\n\nä¸»è¦æœ‰ä¸¤ä¸ªç»„ä»¶ï¼š\n\n* `ReputMessageService` ï¼šwrite ConsumeQueueã€‚\n* `FlushConsumeQueueService` ï¼šflush ConsumeQueueã€‚\n\n## ReputMessageService\n\n![ReputMessageServiceé¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/12.png)\n\n```Java\n  1: class ReputMessageService extends ServiceThread {\n  2: \n  3:     /**\n  4:      * å¼€å§‹é‡æ”¾æ¶ˆæ¯çš„CommitLogç‰©ç†ä½ç½®\n  5:      */\n  6:     private volatile long reputFromOffset = 0;\n  7: \n  8:     public long getReputFromOffset() {\n  9:         return reputFromOffset;\n 10:     }\n 11: \n 12:     public void setReputFromOffset(long reputFromOffset) {\n 13:         this.reputFromOffset = reputFromOffset;\n 14:     }\n 15: \n 16:     @Override\n 17:     public void shutdown() {\n 18:         for (int i = 0; i < 50 && this.isCommitLogAvailable(); i++) {\n 19:             try {\n 20:                 Thread.sleep(100);\n 21:             } catch (InterruptedException ignored) {\n 22:             }\n 23:         }\n 24: \n 25:         if (this.isCommitLogAvailable()) {\n 26:             log.warn(\"shutdown ReputMessageService, but commitlog have not finish to be dispatched, CL: {} reputFromOffset: {}\",\n 27:                 DefaultMessageStore.this.commitLog.getMaxOffset(), this.reputFromOffset);\n 28:         }\n 29: \n 30:         super.shutdown();\n 31:     }\n 32: \n 33:     /**\n 34:      * å‰©ä½™éœ€è¦é‡æ”¾æ¶ˆæ¯å­—èŠ‚æ•°\n 35:      *\n 36:      * @return å­—èŠ‚æ•°\n 37:      */\n 38:     public long behind() {\n 39:         return DefaultMessageStore.this.commitLog.getMaxOffset() - this.reputFromOffset;\n 40:     }\n 41: \n 42:     /**\n 43:      * æ˜¯å¦commitLogéœ€è¦é‡æ”¾æ¶ˆæ¯\n 44:      *\n 45:      * @return æ˜¯å¦\n 46:      */\n 47:     private boolean isCommitLogAvailable() {\n 48:         return this.reputFromOffset < DefaultMessageStore.this.commitLog.getMaxOffset();\n 49:     }\n 50: \n 51:     private void doReput() {\n 52:         for (boolean doNext = true; this.isCommitLogAvailable() && doNext; ) {\n 53: \n 54:             // TODO ç–‘é—®ï¼šè¿™ä¸ªæ˜¯å•¥\n 55:             if (DefaultMessageStore.this.getMessageStoreConfig().isDuplicationEnable() //\n 56:                 && this.reputFromOffset >= DefaultMessageStore.this.getConfirmOffset()) {\n 57:                 break;\n 58:             }\n 59: \n 60:             // è·å–ä»reputFromOffsetå¼€å§‹çš„commitLogå¯¹åº”çš„MappeFileå¯¹åº”çš„MappedByteBuffer\n 61:             SelectMappedBufferResult result = DefaultMessageStore.this.commitLog.getData(reputFromOffset);\n 62:             if (result != null) {\n 63:                 try {\n 64:                     this.reputFromOffset = result.getStartOffset();\n 65: \n 66:                     // éå†MappedByteBuffer\n 67:                     for (int readSize = 0; readSize < result.getSize() && doNext; ) {\n 68:                         // ç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚\n 69:                         DispatchRequest dispatchRequest = DefaultMessageStore.this.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), false, false);\n 70:                         int size = dispatchRequest.getMsgSize(); // æ¶ˆæ¯é•¿åº¦\n 71:                         // æ ¹æ®è¯·æ±‚çš„ç»“æœå¤„ç†\n 72:                         if (dispatchRequest.isSuccess()) { // è¯»å–æˆåŠŸ\n 73:                             if (size > 0) { // è¯»å–Message\n 74:                                 DefaultMessageStore.this.doDispatch(dispatchRequest);\n 75:                                 // é€šçŸ¥æœ‰æ–°æ¶ˆæ¯\n 76:                                 if (BrokerRole.SLAVE != DefaultMessageStore.this.getMessageStoreConfig().getBrokerRole()\n 77:                                     && DefaultMessageStore.this.brokerConfig.isLongPollingEnable()) {\n 78:                                     DefaultMessageStore.this.messageArrivingListener.arriving(dispatchRequest.getTopic(),\n 79:                                         dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + 1,\n 80:                                         dispatchRequest.getTagsCode());\n 81:                                 }\n 82:                                 // FIXED BUG By shijia\n 83:                                 this.reputFromOffset += size;\n 84:                                 readSize += size;\n 85:                                 // ç»Ÿè®¡\n 86:                                 if (DefaultMessageStore.this.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE) {\n 87:                                     DefaultMessageStore.this.storeStatsService\n 88:                                         .getSinglePutMessageTopicTimesTotal(dispatchRequest.getTopic()).incrementAndGet();\n 89:                                     DefaultMessageStore.this.storeStatsService\n 90:                                         .getSinglePutMessageTopicSizeTotal(dispatchRequest.getTopic())\n 91:                                         .addAndGet(dispatchRequest.getMsgSize());\n 92:                                 }\n 93:                             } else if (size == 0) { // è¯»å–åˆ°MappedFileæ–‡ä»¶å°¾\n 94:                                 this.reputFromOffset = DefaultMessageStore.this.commitLog.rollNextFile(this.reputFromOffset);\n 95:                                 readSize = result.getSize();\n 96:                             }\n 97:                         } else if (!dispatchRequest.isSuccess()) { // è¯»å–å¤±è´¥\n 98:                             if (size > 0) { // è¯»å–åˆ°Messageå´ä¸æ˜¯Message\n 99:                                 log.error(\"[BUG]read total count not equals msg total size. reputFromOffset={}\", reputFromOffset);\n100:                                 this.reputFromOffset += size;\n101:                             } else { // è¯»å–åˆ°Blankå´ä¸æ˜¯Blank\n102:                                 doNext = false;\n103:                                 if (DefaultMessageStore.this.brokerConfig.getBrokerId() == MixAll.MASTER_ID) {\n104:                                     log.error(\"[BUG]the master dispatch message to consume queue error, COMMITLOG OFFSET: {}\",\n105:                                         this.reputFromOffset);\n106: \n107:                                     this.reputFromOffset += result.getSize() - readSize;\n108:                                 }\n109:                             }\n110:                         }\n111:                     }\n112:                 } finally {\n113:                     result.release();\n114:                 }\n115:             } else {\n116:                 doNext = false;\n117:             }\n118:         }\n119:     }\n120: \n121:     @Override\n122:     public void run() {\n123:         DefaultMessageStore.log.info(this.getServiceName() + \" service started\");\n124: \n125:         while (!this.isStopped()) {\n126:             try {\n127:                 Thread.sleep(1);\n128:                 this.doReput();\n129:             } catch (Exception e) {\n130:                 DefaultMessageStore.log.warn(this.getServiceName() + \" service has exception. \", e);\n131:             }\n132:         }\n133: \n134:         DefaultMessageStore.log.info(this.getServiceName() + \" service end\");\n135:     }\n136: \n137:     @Override\n138:     public String getServiceName() {\n139:         return ReputMessageService.class.getSimpleName();\n140:     }\n141: \n142: }\n```\n\n* è¯´æ˜ï¼šé‡æ”¾æ¶ˆæ¯çº¿ç¨‹æœåŠ¡ã€‚\n    * è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° æ¶ˆè´¹é˜Ÿåˆ—(ConsumeQueue)\n    * è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ç´¢å¼• åˆ° ç´¢å¼•æ–‡ä»¶(IndexFile)    \n* ![ReputMessageServiceç”¨ä¾‹å›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/11.png)\n    * ç¬¬ 61 è¡Œ ï¼šè·å– `reputFromOffset` å¼€å§‹çš„ `CommitLog` å¯¹åº”çš„ `MappedFile` å¯¹åº”çš„ `MappedByteBuffer`ã€‚\n    * ç¬¬ 67 è¡Œ ï¼šéå† `MappedByteBuffer`ã€‚\n    * ç¬¬ 69 è¡Œ ï¼šç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚ (`DispatchRequest`) ã€‚è¯·æ±‚é‡Œä¸»è¦åŒ…å«ä¸€æ¡æ¶ˆæ¯ (`Message`) æˆ–è€… æ–‡ä»¶å°¾ (`BLANK`) çš„åŸºæœ¬ä¿¡æ¯ã€‚\n    * ç¬¬ 72 è‡³ 96 è¡Œ ï¼šè¯·æ±‚æ˜¯æœ‰æ•ˆè¯·æ±‚ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†ã€‚\n        * ç¬¬ 75 è‡³ 81 è¡Œ ï¼šå½“ `Broker` æ˜¯ä¸»èŠ‚ç‚¹ && `Broker` å¼€å¯çš„æ˜¯é•¿è½®è¯¢ï¼Œé€šçŸ¥æ¶ˆè´¹é˜Ÿåˆ—æœ‰æ–°çš„æ¶ˆæ¯ã€‚`NotifyMessageArrivingListener` ä¼š è°ƒç”¨ `PullRequestHoldService#notifyMessageArriving(...)` æ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š[PullRequestHoldService](#pullrequestholdservice)\n    * ç¬¬ 73 è‡³ 92 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ `Message`ï¼Œè¿›è¡Œè°ƒåº¦ï¼Œç”Ÿæˆ `ConsumeQueue` å’Œ `IndexFile` å¯¹åº”çš„å†…å®¹ã€‚è¯¦ç»†è§£æè§ï¼š\n    * ç¬¬ 93 è‡³ 96 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ `Blank`ï¼Œå³æ–‡ä»¶å°¾ï¼Œè·³è½¬æŒ‡å‘ä¸‹ä¸€ä¸ª `MappedFile`ã€‚\n    * ç¬¬ 97 è‡³ 110 è¡Œ ï¼šè¯·æ±‚æ˜¯æ— æ•ˆè¯·æ±‚ã€‚å‡ºç°è¯¥æƒ…å†µï¼ŒåŸºæœ¬æ˜¯ä¸€ä¸ª**BUG**ã€‚\n* ç¬¬ 127 è‡³ 128 è¡Œ ï¼šæ¯ 1ms å¾ªç¯æ‰§è¡Œé‡æ”¾é€»è¾‘ã€‚\n* ç¬¬ 18 è‡³ 30 è¡Œ ï¼š`shutdown`æ—¶ï¼Œå¤šæ¬¡ `sleep(100)` ç›´åˆ° `CommitLog` å›æ”¾åˆ°æœ€æ–°ä½ç½®ã€‚æ©ï¼Œå¦‚æœæœªå›æ”¾å®Œï¼Œä¼šè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚\n\n### DefaultMessageStore#doDispatch(...)\n\n```Java\n  1: /**\n  2:  * æ‰§è¡Œè°ƒåº¦è¯·æ±‚\n  3:  * 1. éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue\n  4:  * 2. å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile\n  5:  *\n  6:  * @param req è°ƒåº¦è¯·æ±‚\n  7:  */\n  8: public void doDispatch(DispatchRequest req) {\n  9:     // éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue\n 10:     final int tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());\n 11:     switch (tranType) {\n 12:         case MessageSysFlag.TRANSACTION_NOT_TYPE:\n 13:         case MessageSysFlag.TRANSACTION_COMMIT_TYPE:\n 14:             DefaultMessageStore.this.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),\n 15:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());\n 16:             break;\n 17:         case MessageSysFlag.TRANSACTION_PREPARED_TYPE:\n 18:         case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:\n 19:             break;\n 20:     }\n 21:     // å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile\n 22:     if (DefaultMessageStore.this.getMessageStoreConfig().isMessageIndexEnable()) {\n 23:         DefaultMessageStore.this.indexService.buildIndex(req);\n 24:     }\n 25: }\n 26: \n 27: /**\n 28:  * å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue\n 29:  *\n 30:  * @param topic ä¸»é¢˜\n 31:  * @param queueId é˜Ÿåˆ—ç¼–å·\n 32:  * @param offset commitLogå­˜å‚¨ä½ç½®\n 33:  * @param size æ¶ˆæ¯é•¿åº¦\n 34:  * @param tagsCode æ¶ˆæ¯tagsCode\n 35:  * @param storeTimestamp å­˜å‚¨æ—¶é—´\n 36:  * @param logicOffset é˜Ÿåˆ—ä½ç½®\n 37:  */\n 38: public void putMessagePositionInfo(String topic, int queueId, long offset, int size, long tagsCode, long storeTimestamp,\n 39:     long logicOffset) {\n 40:     ConsumeQueue cq = this.findConsumeQueue(topic, queueId);\n 41:     cq.putMessagePositionInfoWrapper(offset, size, tagsCode, storeTimestamp, logicOffset);\n 42: }\n```\n\n### ConsumeQueue#putMessagePositionInfoWrapper(...)\n\n```Java\n  1: /**\n  2:  * æ·»åŠ ä½ç½®ä¿¡æ¯å°è£…\n  3:  *\n  4:  * @param offset commitLogå­˜å‚¨ä½ç½®\n  5:  * @param size æ¶ˆæ¯é•¿åº¦\n  6:  * @param tagsCode æ¶ˆæ¯tagsCode\n  7:  * @param storeTimestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´\n  8:  * @param logicOffset é˜Ÿåˆ—ä½ç½®\n  9:  */\n 10: public void putMessagePositionInfoWrapper(long offset, int size, long tagsCode, long storeTimestamp,\n 11:     long logicOffset) {\n 12:     final int maxRetries = 30;\n 13:     boolean canWrite = this.defaultMessageStore.getRunningFlags().isWriteable();\n 14:     // å¤šæ¬¡å¾ªç¯å†™ï¼Œç›´åˆ°æˆåŠŸ\n 15:     for (int i = 0; i < maxRetries && canWrite; i++) {\n 16:         // è°ƒç”¨æ·»åŠ ä½ç½®ä¿¡æ¯\n 17:         boolean result = this.putMessagePositionInfo(offset, size, tagsCode, logicOffset);\n 18:         if (result) {\n 19:             // æ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨check pointã€‚\n 20:             this.defaultMessageStore.getStoreCheckpoint().setLogicsMsgTimestamp(storeTimestamp);\n 21:             return;\n 22:         } else {\n 23:             // XXX: warn and notify me\n 24:             log.warn(\"[BUG]put commit log position info to \" + topic + \":\" + queueId + \" \" + offset\n 25:                 + \" failed, retry \" + i + \" times\");\n 26: \n 27:             try {\n 28:                 Thread.sleep(1000);\n 29:             } catch (InterruptedException e) {\n 30:                 log.warn(\"\", e);\n 31:             }\n 32:         }\n 33:     }\n 34: \n 35:     // XXX: warn and notify me è®¾ç½®å¼‚å¸¸ä¸å¯å†™å…¥\n 36:     log.error(\"[BUG]consume queue can not write, {} {}\", this.topic, this.queueId);\n 37:     this.defaultMessageStore.getRunningFlags().makeLogicsQueueError();\n 38: }\n 39: \n 40: /**\n 41:  * æ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸ\n 42:  *\n 43:  * @param offset commitLogå­˜å‚¨ä½ç½®\n 44:  * @param size æ¶ˆæ¯é•¿åº¦\n 45:  * @param tagsCode æ¶ˆæ¯tagsCode\n 46:  * @param cqOffset é˜Ÿåˆ—ä½ç½®\n 47:  * @return æ˜¯å¦æˆåŠŸ\n 48:  */\n 49: private boolean putMessagePositionInfo(final long offset, final int size, final long tagsCode,\n 50:     final long cqOffset) {\n 51:     // å¦‚æœå·²ç»é‡æ”¾è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ\n 52:     if (offset <= this.maxPhysicOffset) {\n 53:         return true;\n 54:     }\n 55:     // å†™å…¥ä½ç½®ä¿¡æ¯åˆ°byteBuffer\n 56:     this.byteBufferIndex.flip();\n 57:     this.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);\n 58:     this.byteBufferIndex.putLong(offset);\n 59:     this.byteBufferIndex.putInt(size);\n 60:     this.byteBufferIndex.putLong(tagsCode);\n 61:     // è®¡ç®—consumeQueueå­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFile\n 62:     final long expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;\n 63:     MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile(expectLogicOffset);\n 64:     if (mappedFile != null) {\n 65:         // å½“æ˜¯ConsumeQueueç¬¬ä¸€ä¸ªMappedFile && é˜Ÿåˆ—ä½ç½®éç¬¬ä¸€ä¸ª && MappedFileæœªå†™å…¥å†…å®¹ï¼Œåˆ™å¡«å……å‰ç½®ç©ºç™½å ä½\n 66:         if (mappedFile.isFirstCreateInQueue() && cqOffset != 0 && mappedFile.getWrotePosition() == 0) { // TODO ç–‘é—®ï¼šä¸ºå•¥è¿™ä¸ªæ“ä½œã€‚ç›®å‰èƒ½å¤Ÿæƒ³è±¡åˆ°çš„æ˜¯ï¼Œä¸€äº›è€çš„æ¶ˆæ¯å¾ˆä¹…æ²¡å‘é€ï¼Œçªç„¶å‘é€ï¼Œè¿™ä¸ªæ—¶å€™åˆšå¥½æ»¡è¶³ã€‚\n 67:             this.minLogicOffset = expectLogicOffset;\n 68:             this.mappedFileQueue.setFlushedWhere(expectLogicOffset);\n 69:             this.mappedFileQueue.setCommittedWhere(expectLogicOffset);\n 70:             this.fillPreBlank(mappedFile, expectLogicOffset);\n 71:             log.info(\"fill pre blank space \" + mappedFile.getFileName() + \" \" + expectLogicOffset + \" \"\n 72:                 + mappedFile.getWrotePosition());\n 73:         }\n 74:         // æ ¡éªŒconsumeQueueå­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ã€‚TODO å¦‚æœä¸åˆæ³•ï¼Œç»§ç»­å†™å…¥ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ\n 75:         if (cqOffset != 0) {\n 76:             long currentLogicOffset = mappedFile.getWrotePosition() + mappedFile.getFileFromOffset();\n 77:             if (expectLogicOffset != currentLogicOffset) {\n 78:                 LOG_ERROR.warn(\n 79:                     \"[BUG]logic queue order maybe wrong, expectLogicOffset: {} currentLogicOffset: {} Topic: {} QID: {} Diff: {}\",\n 80:                     expectLogicOffset,\n 81:                     currentLogicOffset,\n 82:                     this.topic,\n 83:                     this.queueId,\n 84:                     expectLogicOffset - currentLogicOffset\n 85:                 );\n 86:             }\n 87:         }\n 88:         // è®¾ç½®commitLogé‡æ”¾æ¶ˆæ¯åˆ°ConsumeQueueä½ç½®ã€‚\n 89:         this.maxPhysicOffset = offset;\n 90:         // æ’å…¥mappedFile\n 91:         return mappedFile.appendMessage(this.byteBufferIndex.array());\n 92:     }\n 93:     return false;\n 94: }\n 95: \n 96: /**\n 97:  * å¡«å……å‰ç½®ç©ºç™½å ä½\n 98:  *\n 99:  * @param mappedFile MappedFile\n100:  * @param untilWhere consumeQueueå­˜å‚¨ä½ç½®\n101:  */\n102: private void fillPreBlank(final MappedFile mappedFile, final long untilWhere) {\n103:     // å†™å…¥å‰ç½®ç©ºç™½å ä½åˆ°byteBuffer\n104:     ByteBuffer byteBuffer = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);\n105:     byteBuffer.putLong(0L);\n106:     byteBuffer.putInt(Integer.MAX_VALUE);\n107:     byteBuffer.putLong(0L);\n108:     // å¾ªç¯å¡«ç©º\n109:     int until = (int) (untilWhere % this.mappedFileQueue.getMappedFileSize());\n110:     for (int i = 0; i < until; i += CQ_STORE_UNIT_SIZE) {\n111:         mappedFile.appendMessage(byteBuffer.array());\n112:     }\n113: }\n```\n\n* `#putMessagePositionInfoWrapper(...)` è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° `ConsumeQueue` çš„å°è£…ï¼Œå®é™…éœ€è¦è°ƒç”¨ `#putMessagePositionInfo(...)` æ–¹æ³•ã€‚\n    * ç¬¬ 13 è¡Œ ï¼šåˆ¤æ–­ `ConsumeQueue` æ˜¯å¦å…è®¸å†™å…¥ã€‚å½“å‘ç”ŸBugæ—¶ï¼Œä¸å…è®¸å†™å…¥ã€‚\n    * ç¬¬ 17 è¡Œ ï¼šè°ƒç”¨ `#putMessagePositionInfo(...)` æ–¹æ³•ï¼Œæ·»åŠ ä½ç½®ä¿¡æ¯ã€‚\n    * ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨æ£€æŸ¥ç‚¹ã€‚`StoreCheckpoint` çš„è¯¦ç»†è§£æè§ï¼š[Storeåˆå§‹åŒ–ä¸å…³é—­](http://www.yunai.me/RocketMQ/store-init-and-shutdown/)ã€‚\n    * ç¬¬ 22 è‡³ 32 è¡Œ ï¼šæ·»åŠ å¤±è´¥ï¼Œç›®å‰åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯BUGã€‚\n    * ç¬¬ 35 è‡³ 37 è¡Œ ï¼šå†™å…¥å¤±è´¥æ—¶ï¼Œæ ‡è®° `ConsumeQueue` å†™å…¥å¼‚å¸¸ï¼Œä¸å…è®¸ç»§ç»­å†™å…¥ã€‚\n* `#putMessagePositionInfo(...)` è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° `ConsumeQueue`ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸã€‚\n    * ç¬¬ 51 è‡³ 54 è¡Œ ï¼šå¦‚æœ `offset`(å­˜å‚¨ä½ç½®) å°äºç­‰äº  `maxPhysicOffset`(`CommitLog` æ¶ˆæ¯é‡æ”¾åˆ° `ConsumeQueue` æœ€å¤§çš„ `CommitLog` å­˜å‚¨ä½ç½®)ï¼Œè¡¨ç¤ºå·²ç»é‡æ”¾è¿‡ï¼Œæ­¤æ—¶ï¼Œä¸å†é‡å¤å†™å…¥ï¼Œç›´æ¥è¿”å›å†™å…¥æˆåŠŸã€‚\n    * ç¬¬ 55 è‡³ 60 è¡Œ ï¼šå†™ ä½ç½®ä¿¡æ¯åˆ°byteBufferã€‚\n    * ç¬¬ 62 è‡³ 63 è¡Œ ï¼šè®¡ç®— `ConsumeQueue`å­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFileã€‚\n    * ç¬¬ 65 è‡³ 73 è¡Œ ï¼šå½“ `MappedFile` æ˜¯ `ConsumeQueue` å½“å‰ç¬¬ä¸€ä¸ªæ–‡ä»¶ && `MappedFile` æœªå†™å…¥å†…å®¹ && é‡æ”¾æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å¤§äº0ï¼Œåˆ™éœ€è¦è¿›è¡Œ `MappedFile` å¡«å……å‰ç½®  `BLANK`ã€‚\n       * *è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä¼šéœ€è¦ã€‚çŒœæµ‹äº§ç”Ÿçš„åŸå› ï¼šä¸€ä¸ª `Topic` é•¿æœŸæ— æ¶ˆæ¯äº§ç”Ÿï¼Œçªç„¶Nå¤©åè¿›è¡Œå‘é€ï¼Œ`Topic` å¯¹åº”çš„å†å²æ¶ˆæ¯ä»¥åŠå’Œæ¶ˆè´¹é˜Ÿåˆ—æ•°æ®å·²ç»è¢«æ¸…ç†ï¼Œæ–°ç”Ÿæˆçš„`MappedFile`éœ€è¦å‰ç½®å ä½ã€‚*\n    * ç¬¬ 74 è‡³ 87 è¡Œ ï¼šæ ¡éªŒ `ConsumeQueue` å­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™è¾“å‡ºæ—¥å¿—ã€‚\n        * *è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œå¦‚æœè®¡ç®—å‡ºæ¥çš„å­˜å‚¨ä½ç½®ä¸åˆæ³•ï¼Œä¸è¿”å›æ·»åŠ å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œæ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿ*\n    * ç¬¬ 89 è¡Œ ï¼šè®¾ç½® `CommitLog` é‡æ”¾æ¶ˆæ¯åˆ° `ConsumeQueue` çš„æœ€å¤§ä½ç½®ã€‚\n    * ç¬¬ 91 è¡Œ ï¼šæ’å…¥æ¶ˆæ¯ä½ç½®åˆ° `MappedFile`ã€‚\n\n## FlushConsumeQueueService\n\n```Java\n  1: class FlushConsumeQueueService extends ServiceThread {\n  2:     private static final int RETRY_TIMES_OVER = 3;\n  3:     /**\n  4:      * æœ€åflushæ—¶é—´æˆ³\n  5:      */\n  6:     private long lastFlushTimestamp = 0;\n  7: \n  8:     private void doFlush(int retryTimes) {\n  9:         int flushConsumeQueueLeastPages = DefaultMessageStore.this.getMessageStoreConfig().getFlushConsumeQueueLeastPages();\n 10: \n 11:         // retryTimes == RETRY_TIMES_OVERæ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ä¸»è¦ç”¨äºshutdownæ—¶ã€‚\n 12:         if (retryTimes == RETRY_TIMES_OVER) {\n 13:             flushConsumeQueueLeastPages = 0;\n 14:         }\n 15:         // å½“æ—¶é—´æ»¡è¶³flushConsumeQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushConsumeQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush\n 16:         long logicsMsgTimestamp = 0;\n 17:         int flushConsumeQueueThoroughInterval = DefaultMessageStore.this.getMessageStoreConfig().getFlushConsumeQueueThoroughInterval();\n 18:         long currentTimeMillis = System.currentTimeMillis();\n 19:         if (currentTimeMillis >= (this.lastFlushTimestamp + flushConsumeQueueThoroughInterval)) {\n 20:             this.lastFlushTimestamp = currentTimeMillis;\n 21:             flushConsumeQueueLeastPages = 0;\n 22:             logicsMsgTimestamp = DefaultMessageStore.this.getStoreCheckpoint().getLogicsMsgTimestamp();\n 23:         }\n 24:         // flushæ¶ˆè´¹é˜Ÿåˆ—\n 25:         ConcurrentHashMap<String, ConcurrentHashMap<Integer, ConsumeQueue>> tables = DefaultMessageStore.this.consumeQueueTable;\n 26:         for (ConcurrentHashMap<Integer, ConsumeQueue> maps : tables.values()) {\n 27:             for (ConsumeQueue cq : maps.values()) {\n 28:                 boolean result = false;\n 29:                 for (int i = 0; i < retryTimes && !result; i++) {\n 30:                     result = cq.flush(flushConsumeQueueLeastPages);\n 31:                 }\n 32:             }\n 33:         }\n 34:         // flush å­˜å‚¨ check point\n 35:         if (0 == flushConsumeQueueLeastPages) {\n 36:             if (logicsMsgTimestamp > 0) {\n 37:                 DefaultMessageStore.this.getStoreCheckpoint().setLogicsMsgTimestamp(logicsMsgTimestamp);\n 38:             }\n 39:             DefaultMessageStore.this.getStoreCheckpoint().flush();\n 40:         }\n 41:     }\n 42: \n 43:     public void run() {\n 44:         DefaultMessageStore.log.info(this.getServiceName() + \" service started\");\n 45: \n 46:         while (!this.isStopped()) {\n 47:             try {\n 48:                 int interval = DefaultMessageStore.this.getMessageStoreConfig().getFlushIntervalConsumeQueue();\n 49:                 this.waitForRunning(interval);\n 50:                 this.doFlush(1);\n 51:             } catch (Exception e) {\n 52:                 DefaultMessageStore.log.warn(this.getServiceName() + \" service has exception. \", e);\n 53:             }\n 54:         }\n 55: \n 56:         this.doFlush(RETRY_TIMES_OVER);\n 57: \n 58:         DefaultMessageStore.log.info(this.getServiceName() + \" service end\");\n 59:     }\n 60: \n 61:     @Override\n 62:     public String getServiceName() {\n 63:         return FlushConsumeQueueService.class.getSimpleName();\n 64:     }\n 65: \n 66:     @Override\n 67:     public long getJointime() {\n 68:         return 1000 * 60;\n 69:     }\n 70: }\n```\n\n* è¯´æ˜ ï¼šflush `ConsumeQueue`(æ¶ˆè´¹é˜Ÿåˆ—) çº¿ç¨‹æœåŠ¡ã€‚\n* ç¬¬ 11 è‡³ 14 è¡Œ ï¼šå½“ `retryTimes == RETRY_TIMES_OVER` æ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ç”¨äº `shutdown` æ—¶ã€‚\n* ç¬¬ 15 è‡³ 23 è¡Œ ï¼šæ¯ flushConsumeQueueThoroughInterval å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ flush ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ flushConsumeQueueLeastPages å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ flush ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ flushï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚\n* ç¬¬ 24 è‡³ 33 è¡Œ ï¼šflush `ConsumeQueue`(æ¶ˆè´¹é˜Ÿåˆ—)ã€‚\n    * flush é€»è¾‘ï¼š[MappedFile#è½ç›˜](http://www.yunai.me/RocketMQ/message-store/#MappedFile-è½ç›˜)ã€‚\n* ç¬¬ 34 è‡³ 40 è¡Œ ï¼šflush `StoreCheckpoint`ã€‚`StoreCheckpoint` çš„è¯¦ç»†è§£æè§ï¼š[Storeåˆå§‹åŒ–ä¸å…³é—­](http://www.yunai.me/RocketMQ/store-init-and-shutdown/)ã€‚\n* ç¬¬ 43 è‡³ 59 è¡Œ ï¼šæ¯ 1000ms æ‰§è¡Œä¸€æ¬¡ `flush`ã€‚å¦‚æœ wakeup() æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡ `flush`ã€‚ç›®å‰ï¼Œæš‚æ—¶ä¸å­˜åœ¨ wakeup() çš„è°ƒç”¨ã€‚\n\n# 4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£\n\n## PullMessageRequestHeader\n\n```Java\n  1: public class PullMessageRequestHeader implements CommandCustomHeader {\n  2:     /**\n  3:      * æ¶ˆè´¹è€…åˆ†ç»„\n  4:      */\n  5:     @CFNotNull\n  6:     private String consumerGroup;\n  7:     /**\n  8:      * Topic\n  9:      */\n 10:     @CFNotNull\n 11:     private String topic;\n 12:     /**\n 13:      * é˜Ÿåˆ—ç¼–å·\n 14:      */\n 15:     @CFNotNull\n 16:     private Integer queueId;\n 17:     /**\n 18:      * é˜Ÿåˆ—å¼€å§‹ä½ç½®\n 19:      */\n 20:     @CFNotNull\n 21:     private Long queueOffset;\n 22:     /**\n 23:      * æ¶ˆæ¯æ•°é‡\n 24:      */\n 25:     @CFNotNull\n 26:     private Integer maxMsgNums;\n 27:     /**\n 28:      * ç³»ç»Ÿæ ‡è¯†\n 29:      */\n 30:     @CFNotNull\n 31:     private Integer sysFlag;\n 32:     /**\n 33:      * æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®\n 34:      */\n 35:     @CFNotNull\n 36:     private Long commitOffset;\n 37:     /**\n 38:      * æŒ‚èµ·è¶…æ—¶æ—¶é—´\n 39:      */\n 40:     @CFNotNull\n 41:     private Long suspendTimeoutMillis;\n 42:     /**\n 43:      * è®¢é˜…è¡¨è¾¾å¼\n 44:      */\n 45:     @CFNullable\n 46:     private String subscription;\n 47:     /**\n 48:      * è®¢é˜…ç‰ˆæœ¬å·\n 49:      */\n 50:     @CFNotNull\n 51:     private Long subVersion;\n 52: }\n```\n\n* è¯´æ˜ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚Header\n* topic +  queueId + queueOffset + maxMsgNums\n* sysFlag ï¼šç³»ç»Ÿæ ‡è¯†ã€‚\n    * ç¬¬ 0 ä½ `FLAG_COMMIT_OFFSET` ï¼šæ ‡è®°è¯·æ±‚æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®ï¼Œå’Œ `commitOffset` é…åˆã€‚\n    * ç¬¬ 1 ä½ `FLAG_SUSPEND` ï¼šæ ‡è®°è¯·æ±‚æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå’Œ `suspendTimeoutMillis` é…åˆã€‚å½“æ‹‰å–ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œ `Broker` ä¼šæŒ‚èµ·è¯·æ±‚ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ã€‚æœ€å¤§æŒ‚èµ·æ—¶é—´ï¼š`suspendTimeoutMillis` æ¯«ç§’ã€‚\n    * ç¬¬ 2 ä½ `FLAG_SUBSCRIPTION` ï¼šæ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼ï¼Œå’Œ `subscription` é…ç½®ã€‚\n* subVersion ï¼šè®¢é˜…ç‰ˆæœ¬å·ã€‚è¯·æ±‚æ—¶ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸å¯¹ï¼Œåˆ™æ— æ³•æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°è·å–è®¢é˜…ä¿¡æ¯ï¼Œä½¿ç”¨æœ€æ–°çš„è®¢é˜…ç‰ˆæœ¬å·ã€‚\n\n## PullMessageProcessor#processRequest(...)\n\n```Java\n  1: private RemotingCommand processRequest(final Channel channel, RemotingCommand request, boolean brokerAllowSuspend)\n  2:     throws RemotingCommandException {\n  3:     RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);\n  4:     final PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();\n  5:     final PullMessageRequestHeader requestHeader =\n  6:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);\n  7: \n  8:     response.setOpaque(request.getOpaque());\n  9: \n 10:     if (LOG.isDebugEnabled()) {\n 11:         LOG.debug(\"receive PullMessage request command, {}\", request);\n 12:     }\n 13: \n 14:     // æ ¡éªŒ broker æ˜¯å¦å¯è¯»\n 15:     if (!PermName.isReadable(this.brokerController.getBrokerConfig().getBrokerPermission())) {\n 16:         response.setCode(ResponseCode.NO_PERMISSION);\n 17:         response.setRemark(String.format(\"the broker[%s] pulling message is forbidden\", this.brokerController.getBrokerConfig().getBrokerIP1()));\n 18:         return response;\n 19:     }\n 20: \n 21:     // æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å­˜åœ¨\n 22:     SubscriptionGroupConfig subscriptionGroupConfig = this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());\n 23:     if (null == subscriptionGroupConfig) {\n 24:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);\n 25:         response.setRemark(String.format(\"subscription group [%s] does not exist, %s\", requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));\n 26:         return response;\n 27:     }\n 28:     // æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å¯æ¶ˆè´¹\n 29:     if (!subscriptionGroupConfig.isConsumeEnable()) {\n 30:         response.setCode(ResponseCode.NO_PERMISSION);\n 31:         response.setRemark(\"subscription group no permission, \" + requestHeader.getConsumerGroup());\n 32:         return response;\n 33:     }\n 34: \n 35:     final boolean hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag()); // æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå½“æ²¡æœ‰æ¶ˆæ¯æ—¶\n 36:     final boolean hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag()); // æ˜¯å¦æäº¤æ¶ˆè´¹è¿›åº¦\n 37:     final boolean hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag()); // æ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼(subscription)\n 38:     final long suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : 0; // æŒ‚èµ·è¯·æ±‚è¶…æ—¶æ—¶é•¿\n 39: \n 40:     // æ ¡éªŒ topicé…ç½® å­˜åœ¨\n 41:     TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());\n 42:     if (null == topicConfig) {\n 43:         LOG.error(\"The topic {} not exist, consumer: {} \", requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));\n 44:         response.setCode(ResponseCode.TOPIC_NOT_EXIST);\n 45:         response.setRemark(String.format(\"topic[%s] not exist, apply first please! %s\", requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));\n 46:         return response;\n 47:     }\n 48:     // æ ¡éªŒ topicé…ç½® æƒé™å¯è¯»\n 49:     if (!PermName.isReadable(topicConfig.getPerm())) {\n 50:         response.setCode(ResponseCode.NO_PERMISSION);\n 51:         response.setRemark(\"the topic[\" + requestHeader.getTopic() + \"] pulling message is forbidden\");\n 52:         return response;\n 53:     }\n 54:     // æ ¡éªŒ è¯»å–é˜Ÿåˆ— åœ¨ topicé…ç½® é˜Ÿåˆ—èŒƒå›´å†…\n 55:     if (requestHeader.getQueueId() < 0 || requestHeader.getQueueId() >= topicConfig.getReadQueueNums()) {\n 56:         String errorInfo = String.format(\"queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]\",\n 57:                 requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());\n 58:         LOG.warn(errorInfo);\n 59:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 60:         response.setRemark(errorInfo);\n 61:         return response;\n 62:     }\n 63: \n 64:     // æ ¡éªŒ è®¢é˜…å…³ç³»\n 65:     SubscriptionData subscriptionData;\n 66:     if (hasSubscriptionFlag) {\n 67:         try {\n 68:             subscriptionData = FilterAPI.buildSubscriptionData(requestHeader.getConsumerGroup(), requestHeader.getTopic(),\n 69:                 requestHeader.getSubscription());\n 70:         } catch (Exception e) {\n 71:             LOG.warn(\"Parse the consumer's subscription[{}] failed, group: {}\", requestHeader.getSubscription(), //\n 72:                     requestHeader.getConsumerGroup());\n 73:             response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);\n 74:             response.setRemark(\"parse the consumer's subscription failed\");\n 75:             return response;\n 76:         }\n 77:     } else {\n 78:         // æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ˜¯å¦å­˜åœ¨\n 79:         ConsumerGroupInfo consumerGroupInfo = this.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());\n 80:         if (null == consumerGroupInfo) {\n 81:             LOG.warn(\"The consumer's group info not exist, group: {}\", requestHeader.getConsumerGroup());\n 82:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);\n 83:             response.setRemark(\"the consumer's group info not exist\" + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));\n 84:             return response;\n 85:         }\n 86:         // æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ¶ˆæ¯æ¨¡å‹æ˜¯å¦åŒ¹é…\n 87:         if (!subscriptionGroupConfig.isConsumeBroadcastEnable() //\n 88:             && consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) {\n 89:             response.setCode(ResponseCode.NO_PERMISSION);\n 90:             response.setRemark(\"the consumer group[\" + requestHeader.getConsumerGroup() + \"] can not consume by broadcast way\");\n 91:             return response;\n 92:         }\n 93: \n 94:         // æ ¡éªŒ è®¢é˜…ä¿¡æ¯ æ˜¯å¦å­˜åœ¨\n 95:         subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());\n 96:         if (null == subscriptionData) {\n 97:             LOG.warn(\"The consumer's subscription not exist, group: {}, topic:{}\", requestHeader.getConsumerGroup(), requestHeader.getTopic());\n 98:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);\n 99:             response.setRemark(\"the consumer's subscription not exist\" + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));\n100:             return response;\n101:         }\n102:         // æ ¡éªŒ è®¢é˜…ä¿¡æ¯ç‰ˆæœ¬ æ˜¯å¦åˆæ³•\n103:         if (subscriptionData.getSubVersion() < requestHeader.getSubVersion()) {\n104:             LOG.warn(\"The broker's subscription is not latest, group: {} {}\", requestHeader.getConsumerGroup(),\n105:                     subscriptionData.getSubString());\n106:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);\n107:             response.setRemark(\"the consumer's subscription not latest\");\n108:             return response;\n109:         }\n110:     }\n111: \n112:     // è·å–æ¶ˆæ¯\n113:     final GetMessageResult getMessageResult = this.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),\n114:             requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), subscriptionData);\n115:     if (getMessageResult != null) {\n116:         response.setRemark(getMessageResult.getStatus().name());\n117:         responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());\n118:         responseHeader.setMinOffset(getMessageResult.getMinOffset());\n119:         responseHeader.setMaxOffset(getMessageResult.getMaxOffset());\n120: \n121:         // TODO å¾…è¯»\n122:         // è®¡ç®—å»ºè®®è¯»å–brokerId\n123:         if (getMessageResult.isSuggestPullingFromSlave()) {\n124:             responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());\n125:         } else {\n126:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n127:         }\n128: \n129:         switch (this.brokerController.getMessageStoreConfig().getBrokerRole()) {\n130:             case ASYNC_MASTER:\n131:             case SYNC_MASTER:\n132:                 break;\n133:             case SLAVE:\n134:                 if (!this.brokerController.getBrokerConfig().isSlaveReadEnable()) { // ä»èŠ‚ç‚¹ä¸å…è®¸è¯»å–ï¼Œå‘Šè¯‰consumerè¯»å–ä¸»èŠ‚ç‚¹ã€‚\n135:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n136:                     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n137:                 }\n138:                 break;\n139:         }\n140: \n141:         if (this.brokerController.getBrokerConfig().isSlaveReadEnable()) {\n142:             // consume too slow ,redirect to another machine\n143:             if (getMessageResult.isSuggestPullingFromSlave()) {\n144:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());\n145:             }\n146:             // consume ok\n147:             else {\n148:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());\n149:             }\n150:         } else {\n151:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n152:         }\n153: \n154:         switch (getMessageResult.getStatus()) {\n155:             case FOUND:\n156:                 response.setCode(ResponseCode.SUCCESS);\n157:                 break;\n158:             case MESSAGE_WAS_REMOVING:\n159:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n160:                 break;\n161:             case NO_MATCHED_LOGIC_QUEUE:\n162:             case NO_MESSAGE_IN_QUEUE:\n163:                 if (0 != requestHeader.getQueueOffset()) {\n164:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n165: \n166:                     // XXX: warn and notify me\n167:                     LOG.info(\"the broker store no queue data, fix the request offset {} to {}, Topic: {} QueueId: {} Consumer Group: {}\", //\n168:                         requestHeader.getQueueOffset(), //\n169:                         getMessageResult.getNextBeginOffset(), //\n170:                         requestHeader.getTopic(), //\n171:                         requestHeader.getQueueId(), //\n172:                         requestHeader.getConsumerGroup()//\n173:                     );\n174:                 } else {\n175:                     response.setCode(ResponseCode.PULL_NOT_FOUND);\n176:                 }\n177:                 break;\n178:             case NO_MATCHED_MESSAGE:\n179:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n180:                 break;\n181:             case OFFSET_FOUND_NULL:\n182:                 response.setCode(ResponseCode.PULL_NOT_FOUND);\n183:                 break;\n184:             case OFFSET_OVERFLOW_BADLY:\n185:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n186:                 // XXX: warn and notify me\n187:                 LOG.info(\"The request offset:{} over flow badly, broker max offset:{} , consumer: {}\", requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());\n188:                 break;\n189:             case OFFSET_OVERFLOW_ONE:\n190:                 response.setCode(ResponseCode.PULL_NOT_FOUND);\n191:                 break;\n192:             case OFFSET_TOO_SMALL:\n193:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n194:                 LOG.info(\"The request offset is too small. group={}, topic={}, requestOffset={}, brokerMinOffset={}, clientIp={}\",\n195:                     requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),\n196:                     getMessageResult.getMinOffset(), channel.remoteAddress());\n197:                 break;\n198:             default:\n199:                 assert false;\n200:                 break;\n201:         }\n202: \n203:         // hookï¼šbefore\n204:         if (this.hasConsumeMessageHook()) {\n205:             ConsumeMessageContext context = new ConsumeMessageContext();\n206:             context.setConsumerGroup(requestHeader.getConsumerGroup());\n207:             context.setTopic(requestHeader.getTopic());\n208:             context.setQueueId(requestHeader.getQueueId());\n209: \n210:             String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);\n211: \n212:             switch (response.getCode()) {\n213:                 case ResponseCode.SUCCESS:\n214:                     int commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();\n215:                     int incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;\n216: \n217:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);\n218:                     context.setCommercialRcvTimes(incValue);\n219:                     context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());\n220:                     context.setCommercialOwner(owner);\n221: \n222:                     break;\n223:                 case ResponseCode.PULL_NOT_FOUND:\n224:                     if (!brokerAllowSuspend) {\n225: \n226:                         context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);\n227:                         context.setCommercialRcvTimes(1);\n228:                         context.setCommercialOwner(owner);\n229: \n230:                     }\n231:                     break;\n232:                 case ResponseCode.PULL_RETRY_IMMEDIATELY:\n233:                 case ResponseCode.PULL_OFFSET_MOVED:\n234:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);\n235:                     context.setCommercialRcvTimes(1);\n236:                     context.setCommercialOwner(owner);\n237:                     break;\n238:                 default:\n239:                     assert false;\n240:                     break;\n241:             }\n242: \n243:             this.executeConsumeMessageHookBefore(context);\n244:         }\n245: \n246:         switch (response.getCode()) {\n247:             case ResponseCode.SUCCESS:\n248: \n249:                 this.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),\n250:                     getMessageResult.getMessageCount());\n251:                 this.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),\n252:                     getMessageResult.getBufferTotalSize());\n253:                 this.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());\n254:                 // è¯»å–æ¶ˆæ¯\n255:                 if (this.brokerController.getBrokerConfig().isTransferMsgByHeap()) { // å†…å­˜ä¸­\n256:                     final long beginTimeMills = this.brokerController.getMessageStore().now();\n257: \n258:                     final byte[] r = this.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());\n259: \n260:                     this.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),\n261:                         requestHeader.getTopic(), requestHeader.getQueueId(),\n262:                         (int) (this.brokerController.getMessageStore().now() - beginTimeMills));\n263:                     response.setBody(r);\n264:                 } else { // zero-copy\n265:                     try {\n266:                         FileRegion fileRegion = new ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);\n267:                         channel.writeAndFlush(fileRegion).addListener(new ChannelFutureListener() {\n268:                             @Override\n269:                             public void operationComplete(ChannelFuture future) throws Exception {\n270:                                 getMessageResult.release();\n271:                                 if (!future.isSuccess()) {\n272:                                     LOG.error(\"Fail to transfer messages from page cache to {}\", channel.remoteAddress(), future.cause());\n273:                                 }\n274:                             }\n275:                         });\n276:                     } catch (Throwable e) {\n277:                         LOG.error(\"Error occurred when transferring messages from page cache\", e);\n278:                         getMessageResult.release();\n279:                     }\n280: \n281:                     response = null;\n282:                 }\n283:                 break;\n284:             case ResponseCode.PULL_NOT_FOUND:\n285:                 // æ¶ˆæ¯æœªæŸ¥è¯¢åˆ° && brokerå…è®¸æŒ‚èµ·è¯·æ±‚ && è¯·æ±‚å…è®¸æŒ‚èµ·\n286:                 if (brokerAllowSuspend && hasSuspendFlag) {\n287:                     long pollingTimeMills = suspendTimeoutMillisLong;\n288:                     if (!this.brokerController.getBrokerConfig().isLongPollingEnable()) {\n289:                         pollingTimeMills = this.brokerController.getBrokerConfig().getShortPollingTimeMills();\n290:                     }\n291: \n292:                     String topic = requestHeader.getTopic();\n293:                     long offset = requestHeader.getQueueOffset();\n294:                     int queueId = requestHeader.getQueueId();\n295:                     PullRequest pullRequest = new PullRequest(request, channel, pollingTimeMills,\n296:                         this.brokerController.getMessageStore().now(), offset, subscriptionData);\n297:                     this.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);\n298:                     response = null;\n299:                     break;\n300:                 }\n301: \n302:             case ResponseCode.PULL_RETRY_IMMEDIATELY:\n303:                 break;\n304:             case ResponseCode.PULL_OFFSET_MOVED:\n305:                 if (this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE\n306:                     || this.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) { // TODO å¾…åšå®¢è¡¥å……\n307:                     MessageQueue mq = new MessageQueue();\n308:                     mq.setTopic(requestHeader.getTopic());\n309:                     mq.setQueueId(requestHeader.getQueueId());\n310:                     mq.setBrokerName(this.brokerController.getBrokerConfig().getBrokerName());\n311: \n312:                     OffsetMovedEvent event = new OffsetMovedEvent();\n313:                     event.setConsumerGroup(requestHeader.getConsumerGroup());\n314:                     event.setMessageQueue(mq);\n315:                     event.setOffsetRequest(requestHeader.getQueueOffset());\n316:                     event.setOffsetNew(getMessageResult.getNextBeginOffset());\n317:                     this.generateOffsetMovedEvent(event);\n318:                     LOG.warn(\n319:                         \"PULL_OFFSET_MOVED:correction offset. topic={}, groupId={}, requestOffset={}, newOffset={}, suggestBrokerId={}\",\n320:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),\n321:                         responseHeader.getSuggestWhichBrokerId());\n322:                 } else {\n323:                     responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());\n324:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n325:                     LOG.warn(\"PULL_OFFSET_MOVED:none correction. topic={}, groupId={}, requestOffset={}, suggestBrokerId={}\",\n326:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),\n327:                         responseHeader.getSuggestWhichBrokerId());\n328:                 }\n329: \n330:                 break;\n331:             default:\n332:                 assert false;\n333:         }\n334:     } else {\n335:         response.setCode(ResponseCode.SYSTEM_ERROR);\n336:         response.setRemark(\"store getMessage return null\");\n337:     }\n338: \n339:     // è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦ && brokeréä¸»ï¼Œè¿›è¡ŒæŒä¹…åŒ–è¿›åº¦ã€‚\n340:     boolean storeOffsetEnable = brokerAllowSuspend;\n341:     storeOffsetEnable = storeOffsetEnable && hasCommitOffsetFlag;\n342:     storeOffsetEnable = storeOffsetEnable && this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;\n343:     if (storeOffsetEnable) {\n344:         this.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),\n345:             requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());\n346:     }\n347:     return response;\n348: }\n```\n\n* è¯´æ˜ï¼šå¤„ç†æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œè¿”å›å“åº”ã€‚\n* ç¬¬ 14 è‡³ 19 è¡Œ ï¼šæ ¡éªŒ `Broker` æ˜¯å¦å¯è¯»ã€‚\n* ç¬¬ 21 è‡³ 33 è¡Œ ï¼šæ ¡éªŒ `SubscriptionGroupConfig`(è®¢é˜…åˆ†ç»„é…ç½®) æ˜¯å¦å­˜åœ¨ && å¯ä»¥æ¶ˆè´¹ã€‚\n* ç¬¬ 35 è‡³ 38 è¡Œ ï¼šå¤„ç† `PullMessageRequestHeader.sysFlag` å¯¹åº”çš„æ ‡å¿—ä½ã€‚\n* ç¬¬ 40 è‡³ 62 è¡Œ ï¼šæ ¡éªŒ `TopicConfig`(ä¸»é¢˜é…ç½®) æ˜¯å¦å­˜åœ¨ && å¯è¯» && é˜Ÿåˆ—ç¼–å·æ­£ç¡®ã€‚\n* ç¬¬ 64 è‡³ 110 è¡Œ ï¼šæ ¡éªŒ `SubscriptionData`(è®¢é˜…ä¿¡æ¯) æ˜¯å¦æ­£ç¡®ã€‚\n* ç¬¬ 113 è¡Œ ï¼šè°ƒç”¨ `MessageStore#getMessage(...)` è·å– `GetMessageResult`(æ¶ˆæ¯)ã€‚è¯¦ç»†è§£æè§ï¼š[MessageStore#getMessage(...)](#messagestoregetmessage)ã€‚\n* ç¬¬ 122 è‡³ 152 è¡Œ ï¼šè®¡ç®—å»ºè®®æ‹‰å–æ¶ˆæ¯ `brokerId` ã€‚\n* ç¬¬ 154 è‡³ 201 è¡Œ ï¼š![PullMessageProcessoræ‹‰å–æ¶ˆæ¯çŠ¶æ€å›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/08.png)\n* ç¬¬ 204 è‡³ 244 è¡Œ ï¼š`Hook` é€»è¾‘ï¼Œ`#executeConsumeMessageHookBefore(...)` ã€‚\n* ç¬¬ 247 è‡³ 283 è¡Œ ï¼šæ‹‰å–æ¶ˆæ¯æˆåŠŸï¼Œå³æ‹‰å–åˆ°æ¶ˆæ¯ã€‚\n    * ç¬¬ 255 è‡³ 263 è¡Œ ï¼šæ–¹å¼ä¸€ ï¼šè°ƒç”¨ `readGetMessageResult(...)` è·å–æ¶ˆæ¯å†…å®¹åˆ°å †å†…å†…å­˜ï¼Œè®¾ç½®åˆ° å“åº”`body`ã€‚\n    * ç¬¬ 265 è‡³ 281 è¡Œ ï¼šæ–¹å¼äºŒ ï¼šåŸºäº `zero-copy` å®ç°ï¼Œç›´æ¥å“åº”ï¼Œæ— éœ€å †å†…å†…å­˜ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚*TODO ï¼šæ­¤å¤„ç­‰å¯¹zero-copyæœ‰ç ”ç©¶ï¼Œå†è¡¥å……ä¸€äº›*ã€‚\n* ç¬¬ 284 è‡³ 300 è¡Œ ï¼šæ‹‰å–ä¸åˆ°æ¶ˆæ¯ï¼Œå½“æ»¡è¶³æ¡ä»¶ (`Broker` å…è®¸æŒ‚èµ· && è¯·æ±‚è¦æ±‚æŒ‚èµ·)ï¼Œæ‰§è¡ŒæŒ‚èµ·è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š[PullRequestHoldService](#pullrequestholdservice)ã€‚\n* ç¬¬ 304 è‡³ 328 è¡Œ ï¼š*TODO ï¼šæ­¤å¤„ç­‰å¯¹`tools`æ¨¡å—ç ”ç©¶åå†è¡¥å……*ã€‚\n* ç¬¬ 339 è‡³ 346 ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå½“æ»¡è¶³ (`Broker` éä¸» && è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦)ã€‚è¯¦ç»†è§£æè§ï¼š[æ›´æ–°æ¶ˆè´¹è¿›åº¦](#3broker-æä¾›æ›´æ–°æ¶ˆè´¹è¿›åº¦æ¥å£)ã€‚\n\n## MessageStore#getMessage(...)\n\n```Java\n  1: /**\n  2:  * è·å–æ¶ˆæ¯ç»“æœ\n  3:  *\n  4:  * @param group æ¶ˆè´¹åˆ†ç»„\n  5:  * @param topic ä¸»é¢˜\n  6:  * @param queueId é˜Ÿåˆ—ç¼–å·\n  7:  * @param offset é˜Ÿåˆ—ä½ç½®\n  8:  * @param maxMsgNums æ¶ˆæ¯æ•°é‡\n  9:  * @param subscriptionData è®¢é˜…ä¿¡æ¯\n 10:  * @return æ¶ˆæ¯ç»“æœ\n 11:  */\n 12: public GetMessageResult getMessage(final String group, final String topic, final int queueId, final long offset, final int maxMsgNums,\n 13:     final SubscriptionData subscriptionData) {\n 14:     // æ˜¯å¦å…³é—­\n 15:     if (this.shutdown) {\n 16:         log.warn(\"message store has shutdown, so getMessage is forbidden\");\n 17:         return null;\n 18:     }\n 19:     // æ˜¯å¦å¯è¯»\n 20:     if (!this.runningFlags.isReadable()) {\n 21:         log.warn(\"message store is not readable, so getMessage is forbidden \" + this.runningFlags.getFlagBits());\n 22:         return null;\n 23:     }\n 24: \n 25:     long beginTime = this.getSystemClock().now();\n 26: \n 27:     GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;\n 28:     long nextBeginOffset = offset;\n 29:     long minOffset = 0;\n 30:     long maxOffset = 0;\n 31: \n 32:     GetMessageResult getResult = new GetMessageResult();\n 33: \n 34:     final long maxOffsetPy = this.commitLog.getMaxOffset();\n 35: \n 36:     // è·å–æ¶ˆè´¹é˜Ÿåˆ—\n 37:     ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);\n 38:     if (consumeQueue != null) {\n 39:         minOffset = consumeQueue.getMinOffsetInQueue(); // æ¶ˆè´¹é˜Ÿåˆ— æœ€å°é˜Ÿåˆ—ç¼–å·\n 40:         maxOffset = consumeQueue.getMaxOffsetInQueue(); // æ¶ˆè´¹é˜Ÿåˆ— æœ€å¤§é˜Ÿåˆ—ç¼–å·\n 41: \n 42:         // åˆ¤æ–­ é˜Ÿåˆ—ä½ç½®(offset)\n 43:         if (maxOffset == 0) { // æ¶ˆè´¹é˜Ÿåˆ—æ— æ¶ˆæ¯\n 44:             status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;\n 45:             nextBeginOffset = nextOffsetCorrection(offset, 0);\n 46:         } else if (offset < minOffset) { // æŸ¥è¯¢offset å¤ªå°\n 47:             status = GetMessageStatus.OFFSET_TOO_SMALL;\n 48:             nextBeginOffset = nextOffsetCorrection(offset, minOffset);\n 49:         } else if (offset == maxOffset) { // æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— ä¸€ä¸ªä½ç½®\n 50:             status = GetMessageStatus.OFFSET_OVERFLOW_ONE;\n 51:             nextBeginOffset = nextOffsetCorrection(offset, offset);\n 52:         } else if (offset > maxOffset) { // æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— å¤ªå¤š(å¤§äºä¸€ä¸ªä½ç½®)\n 53:             status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;\n 54:             if (0 == minOffset) { // TODO blog è¿™é‡Œæ˜¯ï¼Ÿï¼Ÿä¸ºå•¥0 == minOffsetåšäº†ç‰¹æ®Šåˆ¤æ–­\n 55:                 nextBeginOffset = nextOffsetCorrection(offset, minOffset);\n 56:             } else {\n 57:                 nextBeginOffset = nextOffsetCorrection(offset, maxOffset);\n 58:             }\n 59:         } else {\n 60:             // è·å¾— æ˜ å°„Bufferç»“æœ(MappedFile)\n 61:             SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);\n 62:             if (bufferConsumeQueue != null) {\n 63:                 try {\n 64:                     status = GetMessageStatus.NO_MATCHED_MESSAGE;\n 65: \n 66:                     long nextPhyFileStartOffset = Long.MIN_VALUE; // commitLogä¸‹ä¸€ä¸ªæ–‡ä»¶(MappedFile)å¯¹åº”çš„å¼€å§‹offsetã€‚\n 67:                     long maxPhyOffsetPulling = 0; // æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset\n 68: \n 69:                     int i = 0;\n 70:                     final int maxFilterMessageCount = 16000;\n 71:                     final boolean diskFallRecorded = this.messageStoreConfig.isDiskFallRecorded();\n 72:                     // å¾ªç¯è·å– æ¶ˆæ¯ä½ç½®ä¿¡æ¯\n 73:                     for (; i < bufferConsumeQueue.getSize() && i < maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) {\n 74:                         long offsetPy = bufferConsumeQueue.getByteBuffer().getLong(); // æ¶ˆæ¯ç‰©ç†ä½ç½®offset\n 75:                         int sizePy = bufferConsumeQueue.getByteBuffer().getInt(); // æ¶ˆæ¯é•¿åº¦\n 76:                         long tagsCode = bufferConsumeQueue.getByteBuffer().getLong(); // æ¶ˆæ¯tagsCode\n 77:                         // è®¾ç½®æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset\n 78:                         maxPhyOffsetPulling = offsetPy;\n 79:                         // å½“ offsetPy å°äº nextPhyFileStartOffset æ—¶ï¼Œæ„å‘³ç€å¯¹åº”çš„ Message å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„Messageã€‚\n 80:                         if (nextPhyFileStartOffset != Long.MIN_VALUE) {\n 81:                             if (offsetPy < nextPhyFileStartOffset)\n 82:                                 continue;\n 83:                         }\n 84:                         // æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜\n 85:                         boolean isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);\n 86:                         // æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿæ¶ˆæ¯\n 87:                         if (this.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),\n 88:                             isInDisk)) {\n 89:                             break;\n 90:                         }\n 91:                         // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶\n 92:                         if (this.messageFilter.isMessageMatched(subscriptionData, tagsCode)) {\n 93:                             // ä»commitLogè·å–å¯¹åº”æ¶ˆæ¯ByteBuffer\n 94:                             SelectMappedBufferResult selectResult = this.commitLog.getMessage(offsetPy, sizePy);\n 95:                             if (selectResult != null) {\n 96:                                 this.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();\n 97:                                 getResult.addMessage(selectResult);\n 98:                                 status = GetMessageStatus.FOUND;\n 99:                                 nextPhyFileStartOffset = Long.MIN_VALUE;\n100:                             } else {\n101:                                 // ä»commitLogæ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶ï¼ˆMappedFileï¼‰å·²ç»åˆ é™¤ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªMappedFileçš„èµ·å§‹ä½ç½®\n102:                                 if (getResult.getBufferTotalSize() == 0) {\n103:                                     status = GetMessageStatus.MESSAGE_WAS_REMOVING;\n104:                                 }\n105:                                 nextPhyFileStartOffset = this.commitLog.rollNextFile(offsetPy);\n106:                             }\n107:                         } else {\n108:                             if (getResult.getBufferTotalSize() == 0) {\n109:                                 status = GetMessageStatus.NO_MATCHED_MESSAGE;\n110:                             }\n111: \n112:                             if (log.isDebugEnabled()) {\n113:                                 log.debug(\"message type not matched, client: \" + subscriptionData + \" server: \" + tagsCode);\n114:                             }\n115:                         }\n116:                     }\n117:                     // ç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°\n118:                     if (diskFallRecorded) {\n119:                         long fallBehind = maxOffsetPy - maxPhyOffsetPulling;\n120:                         brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);\n121:                     }\n122:                     // è®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·\n123:                     nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);\n124:                     // æ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹\n125:                     long diff = maxOffsetPy - maxPhyOffsetPulling;\n126:                     long memory = (long) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE\n127:                             * (this.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / 100.0));\n128:                     getResult.setSuggestPullingFromSlave(diff > memory);\n129:                 } finally {\n130:                     bufferConsumeQueue.release();\n131:                 }\n132:             } else {\n133:                 status = GetMessageStatus.OFFSET_FOUND_NULL;\n134:                 nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));\n135:                 log.warn(\"consumer request topic: \" + topic + \"offset: \" + offset + \" minOffset: \" + minOffset + \" maxOffset: \"\n136:                     + maxOffset + \", but access logic queue failed.\");\n137:             }\n138:         }\n139:     } else {\n140:         status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;\n141:         nextBeginOffset = nextOffsetCorrection(offset, 0);\n142:     }\n143:     // ç»Ÿè®¡\n144:     if (GetMessageStatus.FOUND == status) {\n145:         this.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();\n146:     } else {\n147:         this.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();\n148:     }\n149:     long eclipseTime = this.getSystemClock().now() - beginTime;\n150:     this.storeStatsService.setGetMessageEntireTimeMax(eclipseTime);\n151:     // è®¾ç½®è¿”å›ç»“æœ\n152:     getResult.setStatus(status);\n153:     getResult.setNextBeginOffset(nextBeginOffset);\n154:     getResult.setMaxOffset(maxOffset);\n155:     getResult.setMinOffset(minOffset);\n156:     return getResult;\n157: }\n158: \n159: /**\n160:  * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· è·å– æ¶ˆè´¹é˜Ÿåˆ—\n161:  *\n162:  * @param topic ä¸»é¢˜\n163:  * @param queueId é˜Ÿåˆ—ç¼–å·\n164:  * @return æ¶ˆè´¹é˜Ÿåˆ—\n165:  */\n166: public ConsumeQueue findConsumeQueue(String topic, int queueId) {\n167:     // è·å– topic å¯¹åº”çš„ æ‰€æœ‰æ¶ˆè´¹é˜Ÿåˆ—\n168:     ConcurrentHashMap<Integer, ConsumeQueue> map = consumeQueueTable.get(topic);\n169:     if (null == map) {\n170:         ConcurrentHashMap<Integer, ConsumeQueue> newMap = new ConcurrentHashMap<>(128);\n171:         ConcurrentHashMap<Integer, ConsumeQueue> oldMap = consumeQueueTable.putIfAbsent(topic, newMap);\n172:         if (oldMap != null) {\n173:             map = oldMap;\n174:         } else {\n175:             map = newMap;\n176:         }\n177:     }\n178:     // è·å– queueId å¯¹åº”çš„ æ¶ˆè´¹é˜Ÿåˆ—\n179:     ConsumeQueue logic = map.get(queueId);\n180:     if (null == logic) {\n181:         ConsumeQueue newLogic = new ConsumeQueue(//\n182:             topic, //\n183:             queueId, //\n184:             StorePathConfigHelper.getStorePathConsumeQueue(this.messageStoreConfig.getStorePathRootDir()), //\n185:             this.getMessageStoreConfig().getMapedFileSizeConsumeQueue(), //\n186:             this);\n187:         ConsumeQueue oldLogic = map.putIfAbsent(queueId, newLogic);\n188:         if (oldLogic != null) {\n189:             logic = oldLogic;\n190:         } else {\n191:             logic = newLogic;\n192:         }\n193:     }\n194: \n195:     return logic;\n196: }\n197: \n198: /**\n199:  * ä¸‹ä¸€ä¸ªè·å–é˜Ÿåˆ—offsetä¿®æ­£\n200:  * ä¿®æ­£æ¡ä»¶ï¼šä¸»èŠ‚ç‚¹ æˆ–è€… ä»èŠ‚ç‚¹å¼€å¯æ ¡éªŒoffsetå¼€å…³\n201:  *\n202:  * @param oldOffset è€é˜Ÿåˆ—offset\n203:  * @param newOffset æ–°é˜Ÿåˆ—offset\n204:  * @return ä¿®æ­£åçš„é˜Ÿåˆ—offset\n205:  */\n206: private long nextOffsetCorrection(long oldOffset, long newOffset) {\n207:     long nextOffset = oldOffset;\n208:     if (this.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE || this.getMessageStoreConfig().isOffsetCheckInSlave()) {\n209:         nextOffset = newOffset;\n210:     }\n211:     return nextOffset;\n212: }\n213: \n214: /**\n215:  * æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜\n216:  *\n217:  * @param offsetPy commitLog æŒ‡å®šoffset\n218:  * @param maxOffsetPy commitLog æœ€å¤§offset\n219:  * @return æ˜¯å¦éœ€è¦ç¡¬ç›˜\n220:  */\n221: private boolean checkInDiskByCommitOffset(long offsetPy, long maxOffsetPy) {\n222:     long memory = (long) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE * (this.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / 100.0));\n223:     return (maxOffsetPy - offsetPy) > memory;\n224: }\n225: \n226: /**\n227:  * åˆ¤æ–­è·å–æ¶ˆæ¯æ˜¯å¦å·²ç»æ»¡\n228:  *\n229:  * @param sizePy å­—èŠ‚æ•°\n230:  * @param maxMsgNums æœ€å¤§æ¶ˆæ¯æ•°\n231:  * @param bufferTotal ç›®å‰å·²ç»è®¡ç®—å­—èŠ‚æ•°\n232:  * @param messageTotal ç›®å‰å·²ç»è®¡ç®—æ¶ˆæ¯æ•°\n233:  * @param isInDisk æ˜¯å¦åœ¨ç¡¬ç›˜ä¸­\n234:  * @return æ˜¯å¦å·²æ»¡\n235:  */\n236: private boolean isTheBatchFull(int sizePy, int maxMsgNums, int bufferTotal, int messageTotal, boolean isInDisk) {\n237:     if (0 == bufferTotal || 0 == messageTotal) {\n238:         return false;\n239:     }\n240:     // æ¶ˆæ¯æ•°é‡å·²ç»æ»¡è¶³è¯·æ±‚æ•°é‡(maxMsgNums)\n241:     if ((messageTotal + 1) >= maxMsgNums) {\n242:         return true;\n243:     }\n244:     // æ ¹æ®æ¶ˆæ¯å­˜å‚¨é…ç½®çš„æœ€å¤§ä¼ è¾“å­—èŠ‚æ•°ã€æœ€å¤§ä¼ è¾“æ¶ˆæ¯æ•°æ˜¯å¦å·²æ»¡\n245:     if (isInDisk) {\n246:         if ((bufferTotal + sizePy) > this.messageStoreConfig.getMaxTransferBytesOnMessageInDisk()) {\n247:             return true;\n248:         }\n249: \n250:         if ((messageTotal + 1) > this.messageStoreConfig.getMaxTransferCountOnMessageInDisk()) {\n251:             return true;\n252:         }\n253:     } else {\n254:         if ((bufferTotal + sizePy) > this.messageStoreConfig.getMaxTransferBytesOnMessageInMemory()) {\n255:             return true;\n256:         }\n257: \n258:         if ((messageTotal + 1) > this.messageStoreConfig.getMaxTransferCountOnMessageInMemory()) {\n259:             return true;\n260:         }\n261:     }\n262: \n263:     return false;\n264: }\n```\n\n* è¯´æ˜ ï¼šæ ¹æ® æ¶ˆæ¯åˆ†ç»„(`group`) + ä¸»é¢˜(`Topic`) + é˜Ÿåˆ—ç¼–å·(`queueId`) + é˜Ÿåˆ—ä½ç½®(`offset`) + è®¢é˜…ä¿¡æ¯(`subscriptionData`) è·å– æŒ‡å®šæ¡æ•°(`maxMsgNums`) æ¶ˆæ¯(`Message`)ã€‚\n* ç¬¬ 14 è‡³ 18 è¡Œ ï¼šåˆ¤æ–­ `Store` æ˜¯å¦å¤„äºå…³é—­çŠ¶æ€ï¼Œè‹¥å…³é—­ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚\n* ç¬¬ 19 è‡³ 23 è¡Œ ï¼šåˆ¤æ–­å½“å‰è¿è¡ŒçŠ¶æ€æ˜¯å¦å¯è¯»ï¼Œè‹¥ä¸å¯è¯»ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚\n* ç¬¬ 37 è¡Œ ï¼šæ ¹æ® ä¸»é¢˜(`Topic`) + é˜Ÿåˆ—ç¼–å·(`queueId`) è·å– æ¶ˆæ¯é˜Ÿåˆ—(`ConsumeQueue`)ã€‚\n    * `#findConsumeQueue(...)` ï¼šç¬¬ 159 è‡³ 196 è¡Œã€‚\n* ç¬¬ 43 è‡³ 58 è¡Œ ï¼šå„ç§é˜Ÿåˆ—ä½ç½®(`offset`) æ— æ³•è¯»å–æ¶ˆæ¯ï¼Œå¹¶é’ˆå¯¹å¯¹åº”çš„æƒ…å†µï¼Œè®¡ç®—ä¸‹ä¸€æ¬¡ `Client` é˜Ÿåˆ—æ‹‰å–ä½ç½®ã€‚\n    * ç¬¬ 43 è‡³ 45 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯ã€‚\n    * ç¬¬ 46 è‡³ 48 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ`offset`ï¼‰ å¤ªå°ã€‚\n    * ç¬¬ 49 è‡³ 51 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ`offset`ï¼‰ æ°å¥½ç­‰äº æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§çš„é˜Ÿåˆ—ä½ç½®ã€‚è¯¥æƒ…å†µæ˜¯æ­£å¸¸ç°è±¡ï¼Œç›¸å½“äºæŸ¥è¯¢æœ€æ–°çš„æ¶ˆæ¯ã€‚\n    * ç¬¬ 52 è‡³ 58 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ`offset`ï¼‰ è¶…è¿‡è¿‡å¤šã€‚\n    * `#nextOffsetCorrection(...)` ï¼šç¬¬ 198 è‡³ 212 è¡Œã€‚\n* ç¬¬ 61 è¡Œ ï¼šæ ¹æ® æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(`offset`) è·å– å¯¹åº”çš„`MappedFile`ã€‚\n* ç¬¬ 72 è‡³ 128 è¡Œ ï¼š**å¾ªç¯**è·å– `æ¶ˆæ¯ä½ç½®ä¿¡æ¯`ã€‚\n    * ç¬¬ 74 è‡³ 76 è¡Œ ï¼šè¯»å–æ¯ä¸€ä¸ª `æ¶ˆæ¯ä½ç½®ä¿¡æ¯`ã€‚\n    * ç¬¬ 79 è‡³ 83 è¡Œ ï¼šå½“ `offsetPy` å°äº `nextPhyFileStartOffset` æ—¶ï¼Œæ„å‘³ç€å¯¹\nåº”çš„ `Message` å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„ `Message`ã€‚\n    * ç¬¬ 84 è‡³ 90 è¡Œ ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿçš„æ¶ˆæ¯ã€‚\n        * `#checkInDiskByCommitOffset(...)` ï¼šç¬¬ 214 è‡³ 224 è¡Œã€‚\n        * `#isTheBatchFull(...)` ï¼šç¬¬ 226 è‡³ 264 è¡Œã€‚\n* ç¬¬ 92 è¡Œ ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚è¯¦ç»†è§£æè§ï¼š[DefaultMessageFilter#isMessageMatched(...)](defaultmessagefilterismessagematched)ã€‚\n* ç¬¬ 94 è¡Œ ï¼šä» `CommitLog` è·å–å¯¹åº” æ¶ˆæ¯çš„`MappedByteBuffer`ã€‚\n* ç¬¬ 95 è‡³ 99 è¡Œ ï¼šè·å– `æ¶ˆæ¯MappedByteBuffer` æˆåŠŸã€‚\n* ç¬¬ 100 è‡³ 106 è¡Œ ï¼šè·å– `æ¶ˆæ¯MappedByteBuffer` å¤±è´¥ã€‚ä» `CommitLog` æ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜ è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶(`MappedFile`) å·²ç»åˆ é™¤ï¼Œæ­¤æ—¶è®¡ç®—ä¸‹ä¸€ä¸ª`MappedFile`çš„èµ·å§‹ä½ç½®ã€‚**è¯¥é€»è¾‘éœ€è¦é…åˆï¼ˆç¬¬ 79 è‡³ 83 è¡Œï¼‰ä¸€èµ·ç†è§£ã€‚**\n* ç¬¬ 117 è‡³ 120 è¡Œ ï¼šç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ã€‚\n* ç¬¬ 123 è¡Œ ï¼šè®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·ã€‚\n* ç¬¬ 124 è‡³ 128 è¡Œ ï¼šæ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹ã€‚\n* ç¬¬ 130 è¡Œ ï¼šé‡Šæ”¾ `bufferConsumeQueue` å¯¹ `MappedFile` çš„æŒ‡å‘ã€‚æ­¤å¤„ `MappedFile` æ˜¯ `ConsumeQueue` é‡Œçš„æ–‡ä»¶ï¼Œä¸æ˜¯ `CommitLog` ä¸‹çš„æ–‡ä»¶ã€‚\n* ç¬¬ 133 è‡³ 136 è¡Œ ï¼šè·å¾—æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(`offset`) è·å– å¯¹åº”çš„`MappedFile` ä¸º**ç©º**ï¼Œè®¡ç®—`ConsumeQueue` ä» `offset` å¼€å§‹çš„ä¸‹ä¸€ä¸ª `MappedFile` å¯¹åº”çš„ä½ç½®ã€‚\n* ç¬¬ 143 è‡³ 150 è¡Œ ï¼šè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼šæ¶ˆè€—æ—¶é—´ã€æ‹‰å–åˆ°æ¶ˆæ¯/æœªæ‹‰å–åˆ°æ¶ˆæ¯æ¬¡æ•°ã€‚\n* ç¬¬ 151 è‡³ 156 è¡Œ ï¼šè®¾ç½®è¿”å›ç»“æœå¹¶è¿”å›ã€‚ \n\n## DefaultMessageFilter#isMessageMatched(...)\n\n```Java\n  1: public class DefaultMessageFilter implements MessageFilter {\n  2: \n  3:     @Override\n  4:     public boolean isMessageMatched(SubscriptionData subscriptionData, Long tagsCode) {\n  5:         // æ¶ˆæ¯tagsCode ç©º\n  6:         if (tagsCode == null) {\n  7:             return true;\n  8:         }\n  9:         // è®¢é˜…æ•°æ® ç©º\n 10:         if (null == subscriptionData) {\n 11:             return true;\n 12:         }\n 13:         // classFilter\n 14:         if (subscriptionData.isClassFilterMode())\n 15:             return true;\n 16:         // è®¢é˜…è¡¨è¾¾å¼ å…¨åŒ¹é…\n 17:         if (subscriptionData.getSubString().equals(SubscriptionData.SUB_ALL)) {\n 18:             return true;\n 19:         }\n 20:         // è®¢é˜…æ•°æ®codeæ•°ç»„ æ˜¯å¦åŒ…å« æ¶ˆæ¯tagsCode\n 21:         return subscriptionData.getCodeSet().contains(tagsCode.intValue());\n 22:     }\n 23: \n 24: }\n```\n\n* è¯´æ˜ ï¼šæ¶ˆæ¯è¿‡æ»¤å™¨é»˜è®¤å®ç°ã€‚\n\n## PullRequestHoldService\n\n```Java\n  1: public class PullRequestHoldService extends ServiceThread {\n  2: \n  3:     private static final Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);\n  4: \n  5:     private static final String TOPIC_QUEUEID_SEPARATOR = \"@\";\n  6: \n  7:     private final BrokerController brokerController;\n  8: \n  9:     private final SystemClock systemClock = new SystemClock();\n 10:     /**\n 11:      * æ¶ˆæ¯è¿‡æ»¤å™¨\n 12:      */\n 13:     private final MessageFilter messageFilter = new DefaultMessageFilter();\n 14:     /**\n 15:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é›†åˆ\n 16:      */\n 17:     private ConcurrentHashMap<String/* topic@queueId */, ManyPullRequest> pullRequestTable =\n 18:             new ConcurrentHashMap<>(1024);\n 19: \n 20:     public PullRequestHoldService(final BrokerController brokerController) {\n 21:         this.brokerController = brokerController;\n 22:     }\n 23: \n 24:     /**\n 25:      * æ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚\n 26:      *\n 27:      * @param topic ä¸»é¢˜\n 28:      * @param queueId é˜Ÿåˆ—ç¼–å·\n 29:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 30:      */\n 31:     public void suspendPullRequest(final String topic, final int queueId, final PullRequest pullRequest) {\n 32:         String key = this.buildKey(topic, queueId);\n 33:         ManyPullRequest mpr = this.pullRequestTable.get(key);\n 34:         if (null == mpr) {\n 35:             mpr = new ManyPullRequest();\n 36:             ManyPullRequest prev = this.pullRequestTable.putIfAbsent(key, mpr);\n 37:             if (prev != null) {\n 38:                 mpr = prev;\n 39:             }\n 40:         }\n 41: \n 42:         mpr.addPullRequest(pullRequest);\n 43:     }\n 44: \n 45:     /**\n 46:      * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· åˆ›å»ºå”¯ä¸€æ ‡è¯†\n 47:      *\n 48:      * @param topic ä¸»é¢˜\n 49:      * @param queueId é˜Ÿåˆ—ç¼–å·\n 50:      * @return key\n 51:      */\n 52:     private String buildKey(final String topic, final int queueId) {\n 53:         StringBuilder sb = new StringBuilder();\n 54:         sb.append(topic);\n 55:         sb.append(TOPIC_QUEUEID_SEPARATOR);\n 56:         sb.append(queueId);\n 57:         return sb.toString();\n 58:     }\n 59: \n 60:     @Override\n 61:     public void run() {\n 62:         log.info(\"{} service started\", this.getServiceName());\n 63:         while (!this.isStopped()) {\n 64:             try {\n 65:                 // æ ¹æ® é•¿è½®è®­ è¿˜æ˜¯ çŸ­è½®è®­ è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´\n 66:                 if (this.brokerController.getBrokerConfig().isLongPollingEnable()) {\n 67:                     this.waitForRunning(5 * 1000);\n 68:                 } else {\n 69:                     this.waitForRunning(this.brokerController.getBrokerConfig().getShortPollingTimeMills());\n 70:                 }\n 71:                 // æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„\n 72:                 long beginLockTimestamp = this.systemClock.now();\n 73:                 this.checkHoldRequest();\n 74:                 long costTime = this.systemClock.now() - beginLockTimestamp;\n 75:                 if (costTime > 5 * 1000) {\n 76:                     log.info(\"[NOTIFYME] check hold request cost {} ms.\", costTime);\n 77:                 }\n 78:             } catch (Throwable e) {\n 79:                 log.warn(this.getServiceName() + \" service has exception. \", e);\n 80:             }\n 81:         }\n 82: \n 83:         log.info(\"{} service end\", this.getServiceName());\n 84:     }\n 85: \n 86:     @Override\n 87:     public String getServiceName() {\n 88:         return PullRequestHoldService.class.getSimpleName();\n 89:     }\n 90: \n 91:     /**\n 92:      * éå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚\n 93:      */\n 94:     private void checkHoldRequest() {\n 95:         for (String key : this.pullRequestTable.keySet()) {\n 96:             String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);\n 97:             if (2 == kArray.length) {\n 98:                 String topic = kArray[0];\n 99:                 int queueId = Integer.parseInt(kArray[1]);\n100:                 final long offset = this.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);\n101:                 try {\n102:                     this.notifyMessageArriving(topic, queueId, offset);\n103:                 } catch (Throwable e) {\n104:                     log.error(\"check hold request failed. topic={}, queueId={}\", topic, queueId, e);\n105:                 }\n106:             }\n107:         }\n108:     }\n109: \n110:     /**\n111:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚\n112:      *\n113:      * @param topic ä¸»é¢˜\n114:      * @param queueId é˜Ÿåˆ—ç¼–å·\n115:      * @param maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset\n116:      */\n117:     public void notifyMessageArriving(final String topic, final int queueId, final long maxOffset) {\n118:         notifyMessageArriving(topic, queueId, maxOffset, null);\n119:     }\n120: \n121:     /**\n122:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚\n123:      *\n124:      * @param topic ä¸»é¢˜\n125:      * @param queueId é˜Ÿåˆ—ç¼–å·\n126:      * @param maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset\n127:      * @param tagsCode è¿‡æ»¤tagsCode\n128:      */\n129:     public void notifyMessageArriving(final String topic, final int queueId, final long maxOffset, final Long tagsCode) {\n130:         String key = this.buildKey(topic, queueId);\n131:         ManyPullRequest mpr = this.pullRequestTable.get(key);\n132:         if (mpr != null) {\n133:             //\n134:             List<PullRequest> requestList = mpr.cloneListAndClear();\n135:             if (requestList != null) {\n136:                 List<PullRequest> replayList = new ArrayList<>(); // ä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚æ•°ç»„\n137: \n138:                 for (PullRequest request : requestList) {\n139:                     // å¦‚æœ maxOffset è¿‡å°ï¼Œåˆ™é‡æ–°è¯»å–ä¸€æ¬¡ã€‚\n140:                     long newestOffset = maxOffset;\n141:                     if (newestOffset <= request.getPullFromThisOffset()) {\n142:                         newestOffset = this.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);\n143:                     }\n144:                     // æœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚\n145:                     if (newestOffset > request.getPullFromThisOffset()) {\n146:                         if (this.messageFilter.isMessageMatched(request.getSubscriptionData(), tagsCode)) {\n147:                             try {\n148:                                 this.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),\n149:                                     request.getRequestCommand());\n150:                             } catch (Throwable e) {\n151:                                 log.error(\"execute request when wakeup failed.\", e);\n152:                             }\n153:                             continue;\n154:                         }\n155:                     }\n156:                     // è¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚\n157:                     if (System.currentTimeMillis() >= (request.getSuspendTimestamp() + request.getTimeoutMillis())) {\n158:                         try {\n159:                             this.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),\n160:                                 request.getRequestCommand());\n161:                         } catch (Throwable e) {\n162:                             log.error(\"execute request when wakeup failed.\", e);\n163:                         }\n164:                         continue;\n165:                     }\n166:                     // ä¸ç¬¦åˆå†æ¬¡æ‹‰å–çš„è¯·æ±‚ï¼Œå†æ¬¡æ·»åŠ å›å»\n167:                     replayList.add(request);\n168:                 }\n169:                 // æ·»åŠ å›å»\n170:                 if (!replayList.isEmpty()) {\n171:                     mpr.addPullRequest(replayList);\n172:                 }\n173:             }\n174:         }\n175:     }\n176: }\n```\n\n* `PullRequestHoldService` è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚æŒ‚èµ·ç»´æŠ¤çº¿ç¨‹æœåŠ¡ã€‚\n    * å½“æ‹‰å–æ¶ˆæ¯è¯·æ±‚è·å¾—ä¸äº†æ¶ˆæ¯æ—¶ï¼Œåˆ™ä¼šå°†è¯·æ±‚è¿›è¡ŒæŒ‚èµ·ï¼Œæ·»åŠ åˆ°è¯¥æœåŠ¡ã€‚\n    * å½“æœ‰ç¬¦åˆæ¡ä»¶ä¿¡æ¯æ—¶ æˆ– æŒ‚èµ·è¶…æ—¶æ—¶ï¼Œé‡æ–°æ‰§è¡Œè·å–æ¶ˆæ¯é€»è¾‘ã€‚\n* `#suspendPullRequest(...)` è¯´æ˜ ï¼šæ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚åˆ°é›†åˆ( `pullRequestTable` )ã€‚\n* `#run(...)` è¯´æ˜ ï¼š**å®šæ—¶**æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥é‡æ–°æ‹‰å–æ¶ˆæ¯å¹¶è¿›è¡Œé€šçŸ¥ã€‚\n    * ç¬¬ 65 è‡³ 70 è¡Œ ï¼šæ ¹æ®`é•¿è½®è®­`or`çŸ­è½®è®­`è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´ã€‚\n    * ç¬¬ 71 è‡³ 77 è¡Œ ï¼šæ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚\n* `#checkHoldRequest(...)` è¯´æ˜ ï¼šéå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚\n* `#notifyMessageArriving(...)` è¯´æ˜ ï¼šæ£€æŸ¥**æŒ‡å®šé˜Ÿåˆ—**æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚\n    * ç¬¬ 139 è‡³ 143 è¡Œ ï¼šå¦‚æœ `maxOffset` è¿‡å°ï¼Œé‡æ–°è·å–ä¸€æ¬¡æœ€æ–°çš„ã€‚\n    * ç¬¬ 144 è‡³ 155 è¡Œ ï¼šæœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚\n    * ç¬¬ 156 è‡³ 165 è¡Œ ï¼šè¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚\n    * ç¬¬ 148 || 159 è¡Œ ï¼šå”¤é†’è¯·æ±‚ï¼Œå†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚åŸå…ˆæ‹…å¿ƒæ‹‰å–æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´å½±å“æ•´ä¸ªæŒ‚èµ·è¯·æ±‚çš„éå†ï¼Œåé¢æŸ¥çœ‹`#executeRequestWhenWakeup(...)`ï¼Œå®é™…æ˜¯ä¸¢åˆ°çº¿ç¨‹æ± è¿›è¡Œä¸€æ­¥çš„æ¶ˆæ¯æ‹‰å–ï¼Œä¸ä¼šæœ‰æ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚è¯¦ç»†è§£æè§ï¼š[PullMessageProcessor#executeRequestWhenWakeup(...)](pullmessageprocessorexecuterequestwhenwakeup)ã€‚\n    * ç¬¬ 166 è‡³ 172 è¡Œ ï¼šä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚é‡æ–°æ·»åŠ åˆ°é›†åˆ(`pullRequestTable`)ã€‚\n\n## PullMessageProcessor#executeRequestWhenWakeup(...)\n\n```Java\n  1: public void executeRequestWhenWakeup(final Channel channel, final RemotingCommand request) throws RemotingCommandException {\n  2:     Runnable run = new Runnable() {\n  3:         @Override\n  4:         public void run() {\n  5:             try {\n  6:                 // è°ƒç”¨æ‹‰å–è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®ä¸æŒ‚èµ·è¯·æ±‚ã€‚\n  7:                 final RemotingCommand response = PullMessageProcessor.this.processRequest(channel, request, false);\n  8: \n  9:                 if (response != null) {\n 10:                     response.setOpaque(request.getOpaque());\n 11:                     response.markResponseType();\n 12:                     try {\n 13:                         channel.writeAndFlush(response).addListener(new ChannelFutureListener() {\n 14:                             @Override\n 15:                             public void operationComplete(ChannelFuture future) throws Exception {\n 16:                                 if (!future.isSuccess()) {\n 17:                                     LOG.error(\"ProcessRequestWrapper response to {} failed\", future.channel().remoteAddress(), future.cause());\n 18:                                     LOG.error(request.toString());\n 19:                                     LOG.error(response.toString());\n 20:                                 }\n 21:                             }\n 22:                         });\n 23:                     } catch (Throwable e) {\n 24:                         LOG.error(\"ProcessRequestWrapper process request over, but response failed\", e);\n 25:                         LOG.error(request.toString());\n 26:                         LOG.error(response.toString());\n 27:                     }\n 28:                 }\n 29:             } catch (RemotingCommandException e1) {\n 30:                 LOG.error(\"ExecuteRequestWhenWakeup run\", e1);\n 31:             }\n 32:         }\n 33:     };\n 34:     // æäº¤æ‹‰å–è¯·æ±‚åˆ°çº¿ç¨‹æ± \n 35:     this.brokerController.getPullMessageExecutor().submit(new RequestTask(run, channel, request));\n 36: }\n```\n\n* è¯´æ˜ ï¼šæ‰§è¡Œè¯·æ±‚å”¤é†’ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚è¯¥æ–¹æ³•è°ƒç”¨çº¿ç¨‹æ± ï¼Œå› æ­¤ï¼Œä¸ä¼šé˜»å¡ã€‚\n* ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®å³ä½¿è¯·æ±‚ä¸åˆ°æ¶ˆæ¯ï¼Œä¹Ÿä¸æŒ‚èµ·è¯·æ±‚ã€‚å¦‚æœä¸è®¾ç½®ï¼Œè¯·æ±‚å¯èƒ½è¢«æ— é™æŒ‚èµ·ï¼Œè¢« `Broker` æ— é™å¾ªç¯ã€‚\n* ç¬¬ 35 è¡Œ ï¼š**æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚åˆ°çº¿ç¨‹æ± **ã€‚\n\n# 5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£\n\n```bash\nYunai-MacdeMacBook-Pro-2:config yunai$ pwd\n/Users/yunai/store/config\nYunai-MacdeMacBook-Pro-2:config yunai$ ls -ls\ntotal 40\n8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json\n8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json.bak\n8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json\n8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json.bak\n8 -rw-r--r--  1 yunai  staff  1401  4 27 21:51 topics.json\nYunai-MacdeMacBook-Pro-2:config yunai$ cat consumerOffset.json\n{\n\t\"offsetTable\":{\n\t\t\"%RETRY%please_rename_unique_group_name_4@please_rename_unique_group_name_4\":{0:0\n\t\t},\n\t\t\"TopicRead3@please_rename_unique_group_name_4\":{1:5\n\t\t}\n\t}\n}\n```\n\n* `consumerOffset.json` ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶ã€‚\n* `consumerOffset.json.bak` ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶å¤‡ä»½ã€‚\n* æ¯æ¬¡å†™å…¥ `consumerOffset.json`ï¼Œå°†åŸå†…å®¹å¤‡ä»½åˆ° `consumerOffset.json.bak`ã€‚å®ç°è§ï¼š[MixAll#string2File(...)](mixallstring2file)ã€‚\n\n## BrokerController#initialize(...)\n\n```Java\n  1:this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n  2:    @Override\n  3:    public void run() {\n  4:        try {\n  5:            BrokerController.this.consumerOffsetManager.persist();\n  6:        } catch (Throwable e) {\n  7:            log.error(\"schedule persist consumerOffset error.\", e);\n  8:        }\n  9:    }\n 10:}, 1000 * 10, this.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);\n```\n\n* è¯´æ˜ ï¼šæ¯ 5s æ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–é€»è¾‘ã€‚\n\n## ConfigManager\n\n```Java\n  1: public abstract class ConfigManager {\n  2: private static final Logger PLOG = LoggerFactory.getLogger(LoggerName.COMMON_LOGGER_NAME);\n  3: \n  4: /**\n  5:  * ç¼–ç å†…å®¹\n  6:  * @return ç¼–ç åçš„å†…å®¹\n  7:  */\n  8: public abstract String encode();\n  9: \n 10: /**\n 11:  * åŠ è½½æ–‡ä»¶\n 12:  *\n 13:  * @return åŠ è½½æ˜¯å¦æˆåŠŸ\n 14:  */\n 15: public boolean load() {\n 16:     String fileName = null;\n 17:     try {\n 18:         fileName = this.configFilePath();\n 19:         String jsonString = MixAll.file2String(fileName);\n 20:         // å¦‚æœå†…å®¹ä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½å¤‡ä»½æ–‡ä»¶\n 21:         if (null == jsonString || jsonString.length() == 0) {\n 22:             return this.loadBak();\n 23:         } else {\n 24:             this.decode(jsonString);\n 25:             PLOG.info(\"load {} OK\", fileName);\n 26:             return true;\n 27:         }\n 28:     } catch (Exception e) {\n 29:         PLOG.error(\"load \" + fileName + \" Failed, and try to load backup file\", e);\n 30:         return this.loadBak();\n 31:     }\n 32: }\n 33: \n 34: /**\n 35:  * é…ç½®æ–‡ä»¶åœ°å€\n 36:  *\n 37:  * @return é…ç½®æ–‡ä»¶åœ°å€\n 38:  */\n 39: public abstract String configFilePath();\n 40: \n 41: /**\n 42:  * åŠ è½½å¤‡ä»½æ–‡ä»¶\n 43:  *\n 44:  * @return æ˜¯å¦æˆåŠŸ\n 45:  */\n 46: private boolean loadBak() {\n 47:     String fileName = null;\n 48:     try {\n 49:         fileName = this.configFilePath();\n 50:         String jsonString = MixAll.file2String(fileName + \".bak\");\n 51:         if (jsonString != null && jsonString.length() > 0) {\n 52:             this.decode(jsonString);\n 53:             PLOG.info(\"load \" + fileName + \" OK\");\n 54:             return true;\n 55:         }\n 56:     } catch (Exception e) {\n 57:         PLOG.error(\"load \" + fileName + \" Failed\", e);\n 58:         return false;\n 59:     }\n 60: \n 61:     return true;\n 62: }\n 63: \n 64: /**\n 65:  * è§£ç å†…å®¹\n 66:  *\n 67:  * @param jsonString å†…å®¹\n 68:  */\n 69: public abstract void decode(final String jsonString);\n 70: \n 71: /**\n 72:  * æŒä¹…åŒ–\n 73:  */\n 74: public synchronized void persist() {\n 75:     String jsonString = this.encode(true);\n 76:     if (jsonString != null) {\n 77:         String fileName = this.configFilePath();\n 78:         try {\n 79:             MixAll.string2File(jsonString, fileName);\n 80:         } catch (IOException e) {\n 81:             PLOG.error(\"persist file Exception, \" + fileName, e);\n 82:         }\n 83:     }\n 84: }\n 85: \n 86: /**\n 87:  * ç¼–ç å­˜å‚¨å†…å®¹\n 88:  *\n 89:  * @param prettyFormat æ˜¯å¦æ ¼å¼åŒ–\n 90:  * @return å†…å®¹\n 91:  */\n 92: public abstract String encode(final boolean prettyFormat);\n 93: }\n```\n\n### MixAll#string2File(...)\n\n```Java\n  1: /**\n  2:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶\n  3:  * å®‰å…¨å†™\n  4:  * 1. å†™åˆ°.tmpæ–‡ä»¶\n  5:  * 2. å¤‡ä»½å‡†å¤‡å†™å…¥æ–‡ä»¶åˆ°.bakæ–‡ä»¶\n  6:  * 3. åˆ é™¤åŸæ–‡ä»¶ï¼Œå°†.tmpä¿®æ”¹æˆæ–‡ä»¶\n  7:  *\n  8:  * @param str å†…å®¹\n  9:  * @param fileName æ–‡ä»¶å\n 10:  * @throws IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶\n 11:  */\n 12: public static void string2File(final String str, final String fileName) throws IOException {\n 13:     // å†™åˆ° tmpæ–‡ä»¶\n 14:     String tmpFile = fileName + \".tmp\";\n 15:     string2FileNotSafe(str, tmpFile);\n 16:     //\n 17:     String bakFile = fileName + \".bak\";\n 18:     String prevContent = file2String(fileName);\n 19:     if (prevContent != null) {\n 20:         string2FileNotSafe(prevContent, bakFile);\n 21:     }\n 22: \n 23:     File file = new File(fileName);\n 24:     file.delete();\n 25: \n 26:     file = new File(tmpFile);\n 27:     file.renameTo(new File(fileName));\n 28: }\n 29: \n 30: /**\n 31:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶\n 32:  * éå®‰å…¨å†™\n 33:  *\n 34:  * @param str å†…å®¹\n 35:  * @param fileName æ–‡ä»¶å†…å®¹\n 36:  * @throws IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶\n 37:  */\n 38: public static void string2FileNotSafe(final String str, final String fileName) throws IOException {\n 39:     File file = new File(fileName);\n 40:     // åˆ›å»ºä¸Šçº§ç›®å½•\n 41:     File fileParent = file.getParentFile();\n 42:     if (fileParent != null) {\n 43:         fileParent.mkdirs();\n 44:     }\n 45:     // å†™å†…å®¹\n 46:     FileWriter fileWriter = null;\n 47:     try {\n 48:         fileWriter = new FileWriter(file);\n 49:         fileWriter.write(str);\n 50:     } catch (IOException e) {\n 51:         throw e;\n 52:     } finally {\n 53:         if (fileWriter != null) {\n 54:             fileWriter.close();\n 55:         }\n 56:     }\n 57: }\n```\n\n## ConsumerOffsetManager\n\n```Java\n  1: public class ConsumerOffsetManager extends ConfigManager {\n  2:     private static final Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);\n  3:     private static final String TOPIC_GROUP_SEPARATOR = \"@\";\n  4: \n  5:     /**\n  6:      * æ¶ˆè´¹è¿›åº¦é›†åˆ\n  7:      */\n  8:     private ConcurrentHashMap<String/* topic@group */, ConcurrentHashMap<Integer, Long>> offsetTable = new ConcurrentHashMap<>(512);\n  9: \n 10:     private transient BrokerController brokerController;\n 11: \n 12:     public ConsumerOffsetManager() {\n 13:     }\n 14: \n 15:     public ConsumerOffsetManager(BrokerController brokerController) {\n 16:         this.brokerController = brokerController;\n 17:     }\n 18: \n 19:     /**\n 20:      * æäº¤æ¶ˆè´¹è¿›åº¦\n 21:      *\n 22:      * @param clientHost æäº¤clientåœ°å€\n 23:      * @param group æ¶ˆè´¹åˆ†ç»„\n 24:      * @param topic ä¸»é¢˜\n 25:      * @param queueId é˜Ÿåˆ—ç¼–å·\n 26:      * @param offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰\n 27:      */\n 28:     public void commitOffset(final String clientHost, final String group, final String topic, final int queueId, final long offset) {\n 29:         // topic@group\n 30:         String key = topic + TOPIC_GROUP_SEPARATOR + group;\n 31:         this.commitOffset(clientHost, key, queueId, offset);\n 32:     }\n 33: \n 34:     /**\n 35:      * æäº¤æ¶ˆè´¹è¿›åº¦\n 36:      *\n 37:      * @param clientHost æäº¤clientåœ°å€\n 38:      * @param key ä¸»é¢˜@æ¶ˆè´¹åˆ†ç»„\n 39:      * @param queueId é˜Ÿåˆ—ç¼–å·\n 40:      * @param offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰\n 41:      */\n 42:     private void commitOffset(final String clientHost, final String key, final int queueId, final long offset) {\n 43:         ConcurrentHashMap<Integer, Long> map = this.offsetTable.get(key);\n 44:         if (null == map) {\n 45:             map = new ConcurrentHashMap<>(32);\n 46:             map.put(queueId, offset);\n 47:             this.offsetTable.put(key, map);\n 48:         } else {\n 49:             Long storeOffset = map.put(queueId, offset);\n 50:             if (storeOffset != null && offset < storeOffset) {\n 51:                 log.warn(\"[NOTIFYME]update consumer offset less than store. clientHost={}, key={}, queueId={}, requestOffset={}, storeOffset={}\", clientHost, key, queueId, offset, storeOffset);\n 52:             }\n 53:         }\n 54:     }\n 55: \n 56:     public String encode() {\n 57:         return this.encode(false);\n 58:     }\n 59: \n 60:     @Override\n 61:     public String configFilePath() {\n 62:         return BrokerPathConfigHelper.getConsumerOffsetPath(this.brokerController.getMessageStoreConfig().getStorePathRootDir());\n 63:     }\n 64: \n 65:     /**\n 66:      * è§£ç å†…å®¹\n 67:      * æ ¼å¼:JSON\n 68:      *\n 69:      * @param jsonString å†…å®¹\n 70:      */\n 71:     @Override\n 72:     public void decode(String jsonString) {\n 73:         if (jsonString != null) {\n 74:             ConsumerOffsetManager obj = RemotingSerializable.fromJson(jsonString, ConsumerOffsetManager.class);\n 75:             if (obj != null) {\n 76:                 this.offsetTable = obj.offsetTable;\n 77:             }\n 78:         }\n 79:     }\n 80: \n 81:     /**\n 82:      * ç¼–ç å†…å®¹\n 83:      * æ ¼å¼ä¸ºJSON\n 84:      *\n 85:      * @param prettyFormat æ˜¯å¦æ ¼å¼åŒ–\n 86:      * @return ç¼–ç åçš„å†…å®¹\n 87:      */\n 88:     public String encode(final boolean prettyFormat) {\n 89:         return RemotingSerializable.toJson(this, prettyFormat);\n 90:     }\n 91: \n 92: }\n```\n\n* è¯´æ˜ ï¼šæ¶ˆè´¹è¿›åº¦ç®¡ç†å™¨ã€‚\n\n# 6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£\n\nå¤§éƒ¨åˆ†é€»è¾‘å’Œ [`Broker` æä¾›[æ¥æ”¶æ¶ˆæ¯]æ¥å£](http://www.yunai.me/RocketMQ/message-send-and-receive/#3ã€Broker-æ¥æ”¶æ¶ˆæ¯) ç±»ä¼¼ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ç›¸å…³å†…å®¹ã€‚\n\n## SendMessageProcessor#consumerSendMsgBack(...)\n\n```Java\n  1: private RemotingCommand consumerSendMsgBack(final ChannelHandlerContext ctx, final RemotingCommand request)\n  2:     throws RemotingCommandException {\n  3: \n  4:     // åˆå§‹åŒ–å“åº”\n  5:     final RemotingCommand response = RemotingCommand.createResponseCommand(null);\n  6:     final ConsumerSendMsgBackRequestHeader requestHeader =\n  7:         (ConsumerSendMsgBackRequestHeader) request.decodeCommandCustomHeader(ConsumerSendMsgBackRequestHeader.class);\n  8: \n  9:     // hookï¼ˆç‹¬æœ‰ï¼‰\n 10:     if (this.hasConsumeMessageHook() && !UtilAll.isBlank(requestHeader.getOriginMsgId())) {\n 11: \n 12:         ConsumeMessageContext context = new ConsumeMessageContext();\n 13:         context.setConsumerGroup(requestHeader.getGroup());\n 14:         context.setTopic(requestHeader.getOriginTopic());\n 15:         context.setCommercialRcvStats(BrokerStatsManager.StatsType.SEND_BACK);\n 16:         context.setCommercialRcvTimes(1);\n 17:         context.setCommercialOwner(request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER));\n 18: \n 19:         this.executeConsumeMessageHookAfter(context);\n 20:     }\n 21: \n 22:     // åˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ï¼ˆç‹¬æœ‰ï¼‰\n 23:     SubscriptionGroupConfig subscriptionGroupConfig =\n 24:         this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getGroup());\n 25:     if (null == subscriptionGroupConfig) {\n 26:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);\n 27:         response.setRemark(\"subscription group not exist, \" + requestHeader.getGroup() + \" \"\n 28:             + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));\n 29:         return response;\n 30:     }\n 31: \n 32:     // æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™\n 33:     if (!PermName.isWriteable(this.brokerController.getBrokerConfig().getBrokerPermission())) {\n 34:         response.setCode(ResponseCode.NO_PERMISSION);\n 35:         response.setRemark(\"the broker[\" + this.brokerController.getBrokerConfig().getBrokerIP1() + \"] sending message is forbidden\");\n 36:         return response;\n 37:     }\n 38: \n 39:     // æ£€æŸ¥ é‡è¯•é˜Ÿåˆ—æ•° æ˜¯å¦å¤§äº0ï¼ˆç‹¬æœ‰ï¼‰\n 40:     if (subscriptionGroupConfig.getRetryQueueNums() <= 0) {\n 41:         response.setCode(ResponseCode.SUCCESS);\n 42:         response.setRemark(null);\n 43:         return response;\n 44:     }\n 45: \n 46:     // è®¡ç®—retry Topic\n 47:     String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());\n 48: \n 49:     // è®¡ç®—é˜Ÿåˆ—ç¼–å·ï¼ˆç‹¬æœ‰ï¼‰\n 50:     int queueIdInt = Math.abs(this.random.nextInt() % 99999999) % subscriptionGroupConfig.getRetryQueueNums();\n 51: \n 52:     // è®¡ç®—sysFlagï¼ˆç‹¬æœ‰ï¼‰\n 53:     int topicSysFlag = 0;\n 54:     if (requestHeader.isUnitMode()) {\n 55:         topicSysFlag = TopicSysFlag.buildSysFlag(false, true);\n 56:     }\n 57: \n 58:     // è·å–topicConfigã€‚å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è¿›è¡Œåˆ›å»º\n 59:     TopicConfig topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(//\n 60:         newTopic, //\n 61:         subscriptionGroupConfig.getRetryQueueNums(), //\n 62:         PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);\n 63:     if (null == topicConfig) { // æ²¡æœ‰é…ç½®\n 64:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 65:         response.setRemark(\"topic[\" + newTopic + \"] not exist\");\n 66:         return response;\n 67:     }\n 68:     if (!PermName.isWriteable(topicConfig.getPerm())) { // ä¸å…è®¸å†™å…¥\n 69:         response.setCode(ResponseCode.NO_PERMISSION);\n 70:         response.setRemark(String.format(\"the topic[%s] sending message is forbidden\", newTopic));\n 71:         return response;\n 72:     }\n 73: \n 74:     // æŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚ï¼ˆç‹¬æœ‰ï¼‰\n 75:     MessageExt msgExt = this.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());\n 76:     if (null == msgExt) {\n 77:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 78:         response.setRemark(\"look message by offset failed, \" + requestHeader.getOffset());\n 79:         return response;\n 80:     }\n 81: \n 82:     // è®¾ç½®retryTopicåˆ°æ‹“å±•å±æ€§ï¼ˆç‹¬æœ‰ï¼‰\n 83:     final String retryTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);\n 84:     if (null == retryTopic) {\n 85:         MessageAccessor.putProperty(msgExt, MessageConst.PROPERTY_RETRY_TOPIC, msgExt.getTopic());\n 86:     }\n 87: \n 88:     // è®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆï¼ˆç‹¬æœ‰ï¼‰ TODO ç–‘é—®ï¼šå¦‚æœè®¾ç½®æˆä¸ç­‰å¾…å­˜å‚¨ï¼Œbrokerè®¾ç½®æˆåŒæ­¥è½ç›˜ï¼Œå²‚ä¸æ˜¯ä¸èƒ½æ‰¹é‡æäº¤äº†ï¼Ÿ\n 89:     msgExt.setWaitStoreMsgOK(false);\n 90: \n 91:     // å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚\n 92:     int delayLevel = requestHeader.getDelayLevel();\n 93:     int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();\n 94:     if (request.getVersion() >= MQVersion.Version.V3_4_9.ordinal()) {\n 95:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();\n 96:     }\n 97:     if (msgExt.getReconsumeTimes() >= maxReconsumeTimes//\n 98:         || delayLevel < 0) { // å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)\n 99:         newTopic = MixAll.getDLQTopic(requestHeader.getGroup());\n100:         queueIdInt = Math.abs(this.random.nextInt() % 99999999) % DLQ_NUMS_PER_GROUP;\n101: \n102:         topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, //\n103:             DLQ_NUMS_PER_GROUP, //\n104:             PermName.PERM_WRITE, 0\n105:         );\n106:         if (null == topicConfig) {\n107:             response.setCode(ResponseCode.SYSTEM_ERROR);\n108:             response.setRemark(\"topic[\" + newTopic + \"] not exist\");\n109:             return response;\n110:         }\n111:     } else {\n112:         if (0 == delayLevel) {\n113:             delayLevel = 3 + msgExt.getReconsumeTimes();\n114:         }\n115:         msgExt.setDelayTimeLevel(delayLevel);\n116:     }\n117: \n118:     // åˆ›å»ºMessageExtBrokerInner\n119:     MessageExtBrokerInner msgInner = new MessageExtBrokerInner();\n120:     msgInner.setTopic(newTopic);\n121:     msgInner.setBody(msgExt.getBody());\n122:     msgInner.setFlag(msgExt.getFlag());\n123:     MessageAccessor.setProperties(msgInner, msgExt.getProperties());\n124:     msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));\n125:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(null, msgExt.getTags()));\n126:     msgInner.setQueueId(queueIdInt);\n127:     msgInner.setSysFlag(msgExt.getSysFlag());\n128:     msgInner.setBornTimestamp(msgExt.getBornTimestamp());\n129:     msgInner.setBornHost(msgExt.getBornHost());\n130:     msgInner.setStoreHost(this.getStoreHost());\n131:     msgInner.setReconsumeTimes(msgExt.getReconsumeTimes() + 1);\n132: \n133:     // è®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å­—æ®µï¼ˆç‹¬æœ‰ï¼‰\n134:     String originMsgId = MessageAccessor.getOriginMessageId(msgExt);\n135:     MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);\n136: \n137:     // æ·»åŠ æ¶ˆæ¯\n138:     PutMessageResult putMessageResult = this.brokerController.getMessageStore().putMessage(msgInner);\n139:     if (putMessageResult != null) {\n140:         switch (putMessageResult.getPutMessageStatus()) {\n141:             case PUT_OK:\n142:                 String backTopic = msgExt.getTopic();\n143:                 String correctTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);\n144:                 if (correctTopic != null) {\n145:                     backTopic = correctTopic;\n146:                 }\n147: \n148:                 this.brokerController.getBrokerStatsManager().incSendBackNums(requestHeader.getGroup(), backTopic);\n149: \n150:                 response.setCode(ResponseCode.SUCCESS);\n151:                 response.setRemark(null);\n152: \n153:                 return response;\n154:             default:\n155:                 break;\n156:         }\n157: \n158:         response.setCode(ResponseCode.SYSTEM_ERROR);\n159:         response.setRemark(putMessageResult.getPutMessageStatus().name());\n160:         return response;\n161:     }\n162: \n163:     response.setCode(ResponseCode.SYSTEM_ERROR);\n164:     response.setRemark(\"putMessageResult is null\");\n165:     return response;\n166: }\n```\n\n* è¯´æ˜ ï¼šå½“ `Consumer` æ¶ˆè´¹æŸæ¡æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ¥å£å‘å›æ¶ˆæ¯ã€‚`Broker` ä¼šå­˜å‚¨å‘å›çš„æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œä¸‹æ¬¡ `Consumer` æ‹‰å–è¯¥æ¶ˆæ¯ï¼Œèƒ½å¤Ÿä» `CommitLog` å’Œ `ConsumeQueue` é¡ºåºè¯»å–ã€‚\n* [x] å› ä¸ºå¤§å¤šæ•°é€»è¾‘å’Œ **`Broker` æ¥æ”¶æ™®é€šæ¶ˆæ¯** å¾ˆç›¸ä¼¼ï¼Œæ—¶å€™ `TODO` æ ‡è®°æˆç‹¬æœ‰çš„é€»è¾‘ã€‚\n* ç¬¬ 4 è‡³ 7 è¡Œ ï¼šåˆå§‹åŒ–å“åº”ã€‚\n* [x] ç¬¬ 9 è‡³ 20 è¡Œ ï¼šHooké€»è¾‘ã€‚\n* [x] ç¬¬22 è‡³ 30 è¡Œ ï¼šåˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ã€‚\n* ç¬¬ 32 è‡³ 37 è¡Œ ï¼šæ£€æŸ¥ `Broker` æ˜¯å¦æœ‰å†™å…¥æƒé™ã€‚\n* [x] ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæ£€æŸ¥é‡è¯•é˜Ÿåˆ—æ•°æ˜¯å¦å¤§äº0ã€‚\n* ç¬¬ 47 è¡Œ ï¼šè®¡ç®— retry topicã€‚\n* [x] ç¬¬ 50 è¡Œ ï¼šéšæœºåˆ†é…é˜Ÿåˆ—ç¼–å·ï¼Œä¾èµ– `retryQueueNums`ã€‚\n* [x] ç¬¬ 52 è‡³ 56 è¡Œ ï¼šè®¡ç®— `sysFlag`ã€‚\n* ç¬¬ 58 è‡³ 72 è¡Œ ï¼šè·å– `TopicConfig`ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚\n* [x] ç¬¬ 74 è‡³ 80 è¡Œ ï¼šæŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚\n* [x] ç¬¬ 82 è‡³ 86 è¡Œ ï¼šè®¾ç½® `retryTopic` åˆ°æ¶ˆæ¯æ‹“å±•å±æ€§ã€‚\n* [x] ç¬¬ 89 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆã€‚\n    * å½“ `Broker` åˆ·ç›˜æ–¹å¼ä¸ºåŒæ­¥ï¼Œä¼šå¯¼è‡´åŒæ­¥è½ç›˜ä¸èƒ½æ‰¹é‡æäº¤ï¼Œè¿™æ ·ä¼šä¸ä¼šå­˜åœ¨é—®é¢˜ï¼Ÿæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚ğŸ˜ˆã€‚\n* [x] ç¬¬ 91 è‡³ 116 è¡Œ ï¼šå¤„ç† `delayLevel` ã€‚\n* ç¬¬ 118 è‡³ 131 è¡Œ ï¼šåˆ›å»º `MessageExtBrokerInner` ã€‚\n* [x] ç¬¬ 133 è‡³ 135 è¡Œ ï¼šè®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å±æ€§ã€‚\n* ç¬¬ 137 è‡³ 161 è¡Œ ï¼šæ·»åŠ æ¶ˆæ¯ã€‚\n\n# 7ã€ç»“å°¾\n\næ„Ÿè°¢åŒå­¦ä»¬å¯¹æœ¬æ–‡çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€‚\n\nğŸ˜ˆå¦‚æœè§£æå­˜åœ¨é—®é¢˜æˆ–è€…è¡¨è¾¾è¯¯è§£çš„ï¼Œè¡¨ç¤ºæŠ±æ­‰ã€‚å¦‚æœæ–¹ä¾¿çš„è¯ï¼Œå¯ä»¥åŠ ä¸‹ **QQï¼š7685413**ã€‚è®©æˆ‘ä»¬æ¥ä¸€åœº 1 ï¼š1 äº¤æµï¼ˆæåŸºï¼‰ã€‚\n\nå†æ¬¡è¡¨ç¤ºååˆ†æ„Ÿè°¢ã€‚\n\n\n","source":"_posts/RocketMQ/2017_05_04_RocketMQæºç åˆ†æâ€”â€”Messageæ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰\ndate: 2017-05-04\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/message-pull-and-consume-first\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[http://www.yunai.me/RocketMQ/message-pull-and-consume-first/](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/)  \n> `RocketMQ` **å¸¦æ³¨é‡Šæºç **åœ°å€ ï¼š[https://github.com/YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **  \n\n![wechat_mp](http://www.yunai.me/images/common/wechat_mp.jpeg)\n\n-------\n\n- [1ã€æ¦‚è¿°](#)\n- [2ã€ConsumeQueue ç»“æ„](#)\n- [3ã€ConsumeQueue å­˜å‚¨](#)\n\t- [ReputMessageService](#)\n\t\t- [DefaultMessageStore#doDispatch(...)](#)\n\t\t- [ConsumeQueue#putMessagePositionInfoWrapper(...)](#)\n\t- [FlushConsumeQueueService](#)\n- [4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£](#)\n\t- [PullMessageRequestHeader](#)\n\t- [PullMessageProcessor#processRequest(...)](#)\n\t- [MessageStore#getMessage(...)](#)\n\t- [DefaultMessageFilter#isMessageMatched(...)](#)\n\t- [PullRequestHoldService](#)\n\t- [PullMessageProcessor#executeRequestWhenWakeup(...)](#)\n- [5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£](#)\n\t- [BrokerController#initialize(...)](#)\n\t- [ConfigManager](#)\n\t\t- [MixAll#string2File(...)](#)\n\t- [ConsumerOffsetManager](#)\n- [6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£](#)\n\t- [SendMessageProcessor#consumerSendMsgBack(...)](#)\n- [7ã€ç»“å°¾](#)\n\n# 1ã€æ¦‚è¿°\n\næœ¬ç« ä¸»è¦è§£æ **æ¶ˆè´¹** é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚\nå› ä¸ºç¯‡å¹…è¾ƒé•¿ï¼Œåˆ†æˆä¸Šä¸‹ä¸¤ç¯‡ï¼š\n\n1. ä¸Šç¯‡ï¼š`Broker` ç›¸å…³æºç ã€‚\n2. ä¸‹ç¯‡ï¼š`Consumer` ç›¸å…³æºç ã€‚\n\n*æœ¬æ–‡å³æ˜¯ä¸Šç¯‡ã€‚*\n\n-------\n\nokï¼Œå…ˆçœ‹ç¬¬ä¸€å¼ å…³äºæ¶ˆè´¹é€»è¾‘çš„å›¾ï¼š\n\n> ![æ¶ˆè´¹é€»è¾‘å›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/13.png)\n\nå†çœ‹æ¶ˆè´¹é€»è¾‘ç²¾ç®€çš„é¡ºåºå›¾ï¼ˆå®é™…æƒ…å†µä¼šç•¥æœ‰å·®åˆ«ï¼‰ï¼š\n\n> ![Consumer&Brokeræ¶ˆè´¹ç²¾ç®€å›¾.png](http://www.yunai.me/images/RocketMQ/2017_05_04/04.png)\n\n# 2ã€ConsumeQueue ç»“æ„\n\n`ConsumeQueue`ã€`MappedFileQueue`ã€`MappedFile` çš„å…³ç³»å¦‚ä¸‹ï¼š\n\n> ![ConsumeQueueã€MappedFileQueueã€MappedFileçš„å…³ç³»](http://www.yunai.me/images/RocketMQ/2017_05_04/03.png)\n`ConsumeQueue` : `MappedFileQueue` : `MappedFile` = 1 : 1 : Nã€‚\n\nååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š\n\n```bash\nYunai-MacdeMacBook-Pro-2:consumequeue yunai$ pwd\n/Users/yunai/store/consumequeue\nYunai-MacdeMacBook-Pro-2:consumequeue yunai$ cd TopicRead3/\nYunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ ls -ls\ntotal 0\n0 drwxr-xr-x  3 yunai  staff  102  4 27 21:52 0\n0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 1\n0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 2\n0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 3\nYunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ cd 0/\nYunai-MacdeMacBook-Pro-2:0 yunai$ ls -ls\ntotal 11720\n11720 -rw-r--r--  1 yunai  staff  6000000  4 27 21:55 00000000000000000000\n```\n\n-------\n\n`ConsumeQueue`ã€`MappedFileQueue`ã€`MappedFile` çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n* `MappedFile` ï¼š00000000000000000000ç­‰æ–‡ä»¶ã€‚\n* `MappedFileQueue` ï¼š`MappedFile` æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ `MappedFile` è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚\n    * æ¯ä¸ª `MappedFile` ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚\n    * æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ `ConsumeQueue` é‡Œé»˜è®¤ä¸º 6000000Bã€‚\n* `ConsumeQueue` ï¼šé’ˆå¯¹ `MappedFileQueue` çš„å°è£…ä½¿ç”¨ã€‚\n    * `Store : ConsumeQueue = ConcurrentHashMap<String/* topic */, ConcurrentHashMap<Integer/* queueId */, ConsumeQueue>>`ã€‚\n\n`ConsumeQueue` å­˜å‚¨åœ¨ `MappedFile` çš„å†…å®¹**å¿…é¡»**å¤§å°æ˜¯ 20B( `ConsumeQueue.CQ_STORE_UNIT_SIZE` )ï¼Œæœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š\n\n1. `MESSAGE_POSITION_INFO` ï¼šæ¶ˆæ¯ä½ç½®ä¿¡æ¯ã€‚\n2. `BLANK` : æ–‡ä»¶å‰ç½®ç©ºç™½å ä½ã€‚å½“å†å² `Message` è¢«åˆ é™¤æ—¶ï¼Œéœ€è¦ç”¨ `BLANK`å ä½è¢«åˆ é™¤çš„æ¶ˆæ¯ã€‚\n\n`MESSAGE_POSITION_INFO` åœ¨ `ConsumeQueue` å­˜å‚¨ç»“æ„ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | offset | æ¶ˆæ¯ `CommitLog` å­˜å‚¨ä½ç½® | Long | 8 |\n| 2 | size | æ¶ˆæ¯é•¿åº¦ | Int | 4 |\n| 3 | tagsCode | æ¶ˆæ¯tagsCode | Long | 8 |\n\n`BLANK` åœ¨ `ConsumeQueue` å­˜å‚¨ç»“æ„ï¼š\n\n| ç¬¬å‡ ä½ | å­—æ®µ | è¯´æ˜ | æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |\n| :-- | :-- | :-- | :-- | :-- |\n| 1 | | 0 | Long | 8 |\n| 2 | | Integer.MAX_VALUE | Int | 4 |\n| 3 | | 0 | Long | 8 |\n\n# 3ã€ConsumeQueue å­˜å‚¨\n\n![CommitLogé‡æ”¾ConsumeQueueå›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/02.png)\n\nä¸»è¦æœ‰ä¸¤ä¸ªç»„ä»¶ï¼š\n\n* `ReputMessageService` ï¼šwrite ConsumeQueueã€‚\n* `FlushConsumeQueueService` ï¼šflush ConsumeQueueã€‚\n\n## ReputMessageService\n\n![ReputMessageServiceé¡ºåºå›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/12.png)\n\n```Java\n  1: class ReputMessageService extends ServiceThread {\n  2: \n  3:     /**\n  4:      * å¼€å§‹é‡æ”¾æ¶ˆæ¯çš„CommitLogç‰©ç†ä½ç½®\n  5:      */\n  6:     private volatile long reputFromOffset = 0;\n  7: \n  8:     public long getReputFromOffset() {\n  9:         return reputFromOffset;\n 10:     }\n 11: \n 12:     public void setReputFromOffset(long reputFromOffset) {\n 13:         this.reputFromOffset = reputFromOffset;\n 14:     }\n 15: \n 16:     @Override\n 17:     public void shutdown() {\n 18:         for (int i = 0; i < 50 && this.isCommitLogAvailable(); i++) {\n 19:             try {\n 20:                 Thread.sleep(100);\n 21:             } catch (InterruptedException ignored) {\n 22:             }\n 23:         }\n 24: \n 25:         if (this.isCommitLogAvailable()) {\n 26:             log.warn(\"shutdown ReputMessageService, but commitlog have not finish to be dispatched, CL: {} reputFromOffset: {}\",\n 27:                 DefaultMessageStore.this.commitLog.getMaxOffset(), this.reputFromOffset);\n 28:         }\n 29: \n 30:         super.shutdown();\n 31:     }\n 32: \n 33:     /**\n 34:      * å‰©ä½™éœ€è¦é‡æ”¾æ¶ˆæ¯å­—èŠ‚æ•°\n 35:      *\n 36:      * @return å­—èŠ‚æ•°\n 37:      */\n 38:     public long behind() {\n 39:         return DefaultMessageStore.this.commitLog.getMaxOffset() - this.reputFromOffset;\n 40:     }\n 41: \n 42:     /**\n 43:      * æ˜¯å¦commitLogéœ€è¦é‡æ”¾æ¶ˆæ¯\n 44:      *\n 45:      * @return æ˜¯å¦\n 46:      */\n 47:     private boolean isCommitLogAvailable() {\n 48:         return this.reputFromOffset < DefaultMessageStore.this.commitLog.getMaxOffset();\n 49:     }\n 50: \n 51:     private void doReput() {\n 52:         for (boolean doNext = true; this.isCommitLogAvailable() && doNext; ) {\n 53: \n 54:             // TODO ç–‘é—®ï¼šè¿™ä¸ªæ˜¯å•¥\n 55:             if (DefaultMessageStore.this.getMessageStoreConfig().isDuplicationEnable() //\n 56:                 && this.reputFromOffset >= DefaultMessageStore.this.getConfirmOffset()) {\n 57:                 break;\n 58:             }\n 59: \n 60:             // è·å–ä»reputFromOffsetå¼€å§‹çš„commitLogå¯¹åº”çš„MappeFileå¯¹åº”çš„MappedByteBuffer\n 61:             SelectMappedBufferResult result = DefaultMessageStore.this.commitLog.getData(reputFromOffset);\n 62:             if (result != null) {\n 63:                 try {\n 64:                     this.reputFromOffset = result.getStartOffset();\n 65: \n 66:                     // éå†MappedByteBuffer\n 67:                     for (int readSize = 0; readSize < result.getSize() && doNext; ) {\n 68:                         // ç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚\n 69:                         DispatchRequest dispatchRequest = DefaultMessageStore.this.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), false, false);\n 70:                         int size = dispatchRequest.getMsgSize(); // æ¶ˆæ¯é•¿åº¦\n 71:                         // æ ¹æ®è¯·æ±‚çš„ç»“æœå¤„ç†\n 72:                         if (dispatchRequest.isSuccess()) { // è¯»å–æˆåŠŸ\n 73:                             if (size > 0) { // è¯»å–Message\n 74:                                 DefaultMessageStore.this.doDispatch(dispatchRequest);\n 75:                                 // é€šçŸ¥æœ‰æ–°æ¶ˆæ¯\n 76:                                 if (BrokerRole.SLAVE != DefaultMessageStore.this.getMessageStoreConfig().getBrokerRole()\n 77:                                     && DefaultMessageStore.this.brokerConfig.isLongPollingEnable()) {\n 78:                                     DefaultMessageStore.this.messageArrivingListener.arriving(dispatchRequest.getTopic(),\n 79:                                         dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + 1,\n 80:                                         dispatchRequest.getTagsCode());\n 81:                                 }\n 82:                                 // FIXED BUG By shijia\n 83:                                 this.reputFromOffset += size;\n 84:                                 readSize += size;\n 85:                                 // ç»Ÿè®¡\n 86:                                 if (DefaultMessageStore.this.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE) {\n 87:                                     DefaultMessageStore.this.storeStatsService\n 88:                                         .getSinglePutMessageTopicTimesTotal(dispatchRequest.getTopic()).incrementAndGet();\n 89:                                     DefaultMessageStore.this.storeStatsService\n 90:                                         .getSinglePutMessageTopicSizeTotal(dispatchRequest.getTopic())\n 91:                                         .addAndGet(dispatchRequest.getMsgSize());\n 92:                                 }\n 93:                             } else if (size == 0) { // è¯»å–åˆ°MappedFileæ–‡ä»¶å°¾\n 94:                                 this.reputFromOffset = DefaultMessageStore.this.commitLog.rollNextFile(this.reputFromOffset);\n 95:                                 readSize = result.getSize();\n 96:                             }\n 97:                         } else if (!dispatchRequest.isSuccess()) { // è¯»å–å¤±è´¥\n 98:                             if (size > 0) { // è¯»å–åˆ°Messageå´ä¸æ˜¯Message\n 99:                                 log.error(\"[BUG]read total count not equals msg total size. reputFromOffset={}\", reputFromOffset);\n100:                                 this.reputFromOffset += size;\n101:                             } else { // è¯»å–åˆ°Blankå´ä¸æ˜¯Blank\n102:                                 doNext = false;\n103:                                 if (DefaultMessageStore.this.brokerConfig.getBrokerId() == MixAll.MASTER_ID) {\n104:                                     log.error(\"[BUG]the master dispatch message to consume queue error, COMMITLOG OFFSET: {}\",\n105:                                         this.reputFromOffset);\n106: \n107:                                     this.reputFromOffset += result.getSize() - readSize;\n108:                                 }\n109:                             }\n110:                         }\n111:                     }\n112:                 } finally {\n113:                     result.release();\n114:                 }\n115:             } else {\n116:                 doNext = false;\n117:             }\n118:         }\n119:     }\n120: \n121:     @Override\n122:     public void run() {\n123:         DefaultMessageStore.log.info(this.getServiceName() + \" service started\");\n124: \n125:         while (!this.isStopped()) {\n126:             try {\n127:                 Thread.sleep(1);\n128:                 this.doReput();\n129:             } catch (Exception e) {\n130:                 DefaultMessageStore.log.warn(this.getServiceName() + \" service has exception. \", e);\n131:             }\n132:         }\n133: \n134:         DefaultMessageStore.log.info(this.getServiceName() + \" service end\");\n135:     }\n136: \n137:     @Override\n138:     public String getServiceName() {\n139:         return ReputMessageService.class.getSimpleName();\n140:     }\n141: \n142: }\n```\n\n* è¯´æ˜ï¼šé‡æ”¾æ¶ˆæ¯çº¿ç¨‹æœåŠ¡ã€‚\n    * è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° æ¶ˆè´¹é˜Ÿåˆ—(ConsumeQueue)\n    * è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ç´¢å¼• åˆ° ç´¢å¼•æ–‡ä»¶(IndexFile)    \n* ![ReputMessageServiceç”¨ä¾‹å›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/11.png)\n    * ç¬¬ 61 è¡Œ ï¼šè·å– `reputFromOffset` å¼€å§‹çš„ `CommitLog` å¯¹åº”çš„ `MappedFile` å¯¹åº”çš„ `MappedByteBuffer`ã€‚\n    * ç¬¬ 67 è¡Œ ï¼šéå† `MappedByteBuffer`ã€‚\n    * ç¬¬ 69 è¡Œ ï¼šç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚ (`DispatchRequest`) ã€‚è¯·æ±‚é‡Œä¸»è¦åŒ…å«ä¸€æ¡æ¶ˆæ¯ (`Message`) æˆ–è€… æ–‡ä»¶å°¾ (`BLANK`) çš„åŸºæœ¬ä¿¡æ¯ã€‚\n    * ç¬¬ 72 è‡³ 96 è¡Œ ï¼šè¯·æ±‚æ˜¯æœ‰æ•ˆè¯·æ±‚ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†ã€‚\n        * ç¬¬ 75 è‡³ 81 è¡Œ ï¼šå½“ `Broker` æ˜¯ä¸»èŠ‚ç‚¹ && `Broker` å¼€å¯çš„æ˜¯é•¿è½®è¯¢ï¼Œé€šçŸ¥æ¶ˆè´¹é˜Ÿåˆ—æœ‰æ–°çš„æ¶ˆæ¯ã€‚`NotifyMessageArrivingListener` ä¼š è°ƒç”¨ `PullRequestHoldService#notifyMessageArriving(...)` æ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š[PullRequestHoldService](#pullrequestholdservice)\n    * ç¬¬ 73 è‡³ 92 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ `Message`ï¼Œè¿›è¡Œè°ƒåº¦ï¼Œç”Ÿæˆ `ConsumeQueue` å’Œ `IndexFile` å¯¹åº”çš„å†…å®¹ã€‚è¯¦ç»†è§£æè§ï¼š\n    * ç¬¬ 93 è‡³ 96 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ `Blank`ï¼Œå³æ–‡ä»¶å°¾ï¼Œè·³è½¬æŒ‡å‘ä¸‹ä¸€ä¸ª `MappedFile`ã€‚\n    * ç¬¬ 97 è‡³ 110 è¡Œ ï¼šè¯·æ±‚æ˜¯æ— æ•ˆè¯·æ±‚ã€‚å‡ºç°è¯¥æƒ…å†µï¼ŒåŸºæœ¬æ˜¯ä¸€ä¸ª**BUG**ã€‚\n* ç¬¬ 127 è‡³ 128 è¡Œ ï¼šæ¯ 1ms å¾ªç¯æ‰§è¡Œé‡æ”¾é€»è¾‘ã€‚\n* ç¬¬ 18 è‡³ 30 è¡Œ ï¼š`shutdown`æ—¶ï¼Œå¤šæ¬¡ `sleep(100)` ç›´åˆ° `CommitLog` å›æ”¾åˆ°æœ€æ–°ä½ç½®ã€‚æ©ï¼Œå¦‚æœæœªå›æ”¾å®Œï¼Œä¼šè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚\n\n### DefaultMessageStore#doDispatch(...)\n\n```Java\n  1: /**\n  2:  * æ‰§è¡Œè°ƒåº¦è¯·æ±‚\n  3:  * 1. éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue\n  4:  * 2. å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile\n  5:  *\n  6:  * @param req è°ƒåº¦è¯·æ±‚\n  7:  */\n  8: public void doDispatch(DispatchRequest req) {\n  9:     // éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue\n 10:     final int tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());\n 11:     switch (tranType) {\n 12:         case MessageSysFlag.TRANSACTION_NOT_TYPE:\n 13:         case MessageSysFlag.TRANSACTION_COMMIT_TYPE:\n 14:             DefaultMessageStore.this.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),\n 15:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());\n 16:             break;\n 17:         case MessageSysFlag.TRANSACTION_PREPARED_TYPE:\n 18:         case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:\n 19:             break;\n 20:     }\n 21:     // å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile\n 22:     if (DefaultMessageStore.this.getMessageStoreConfig().isMessageIndexEnable()) {\n 23:         DefaultMessageStore.this.indexService.buildIndex(req);\n 24:     }\n 25: }\n 26: \n 27: /**\n 28:  * å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue\n 29:  *\n 30:  * @param topic ä¸»é¢˜\n 31:  * @param queueId é˜Ÿåˆ—ç¼–å·\n 32:  * @param offset commitLogå­˜å‚¨ä½ç½®\n 33:  * @param size æ¶ˆæ¯é•¿åº¦\n 34:  * @param tagsCode æ¶ˆæ¯tagsCode\n 35:  * @param storeTimestamp å­˜å‚¨æ—¶é—´\n 36:  * @param logicOffset é˜Ÿåˆ—ä½ç½®\n 37:  */\n 38: public void putMessagePositionInfo(String topic, int queueId, long offset, int size, long tagsCode, long storeTimestamp,\n 39:     long logicOffset) {\n 40:     ConsumeQueue cq = this.findConsumeQueue(topic, queueId);\n 41:     cq.putMessagePositionInfoWrapper(offset, size, tagsCode, storeTimestamp, logicOffset);\n 42: }\n```\n\n### ConsumeQueue#putMessagePositionInfoWrapper(...)\n\n```Java\n  1: /**\n  2:  * æ·»åŠ ä½ç½®ä¿¡æ¯å°è£…\n  3:  *\n  4:  * @param offset commitLogå­˜å‚¨ä½ç½®\n  5:  * @param size æ¶ˆæ¯é•¿åº¦\n  6:  * @param tagsCode æ¶ˆæ¯tagsCode\n  7:  * @param storeTimestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´\n  8:  * @param logicOffset é˜Ÿåˆ—ä½ç½®\n  9:  */\n 10: public void putMessagePositionInfoWrapper(long offset, int size, long tagsCode, long storeTimestamp,\n 11:     long logicOffset) {\n 12:     final int maxRetries = 30;\n 13:     boolean canWrite = this.defaultMessageStore.getRunningFlags().isWriteable();\n 14:     // å¤šæ¬¡å¾ªç¯å†™ï¼Œç›´åˆ°æˆåŠŸ\n 15:     for (int i = 0; i < maxRetries && canWrite; i++) {\n 16:         // è°ƒç”¨æ·»åŠ ä½ç½®ä¿¡æ¯\n 17:         boolean result = this.putMessagePositionInfo(offset, size, tagsCode, logicOffset);\n 18:         if (result) {\n 19:             // æ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨check pointã€‚\n 20:             this.defaultMessageStore.getStoreCheckpoint().setLogicsMsgTimestamp(storeTimestamp);\n 21:             return;\n 22:         } else {\n 23:             // XXX: warn and notify me\n 24:             log.warn(\"[BUG]put commit log position info to \" + topic + \":\" + queueId + \" \" + offset\n 25:                 + \" failed, retry \" + i + \" times\");\n 26: \n 27:             try {\n 28:                 Thread.sleep(1000);\n 29:             } catch (InterruptedException e) {\n 30:                 log.warn(\"\", e);\n 31:             }\n 32:         }\n 33:     }\n 34: \n 35:     // XXX: warn and notify me è®¾ç½®å¼‚å¸¸ä¸å¯å†™å…¥\n 36:     log.error(\"[BUG]consume queue can not write, {} {}\", this.topic, this.queueId);\n 37:     this.defaultMessageStore.getRunningFlags().makeLogicsQueueError();\n 38: }\n 39: \n 40: /**\n 41:  * æ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸ\n 42:  *\n 43:  * @param offset commitLogå­˜å‚¨ä½ç½®\n 44:  * @param size æ¶ˆæ¯é•¿åº¦\n 45:  * @param tagsCode æ¶ˆæ¯tagsCode\n 46:  * @param cqOffset é˜Ÿåˆ—ä½ç½®\n 47:  * @return æ˜¯å¦æˆåŠŸ\n 48:  */\n 49: private boolean putMessagePositionInfo(final long offset, final int size, final long tagsCode,\n 50:     final long cqOffset) {\n 51:     // å¦‚æœå·²ç»é‡æ”¾è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ\n 52:     if (offset <= this.maxPhysicOffset) {\n 53:         return true;\n 54:     }\n 55:     // å†™å…¥ä½ç½®ä¿¡æ¯åˆ°byteBuffer\n 56:     this.byteBufferIndex.flip();\n 57:     this.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);\n 58:     this.byteBufferIndex.putLong(offset);\n 59:     this.byteBufferIndex.putInt(size);\n 60:     this.byteBufferIndex.putLong(tagsCode);\n 61:     // è®¡ç®—consumeQueueå­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFile\n 62:     final long expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;\n 63:     MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile(expectLogicOffset);\n 64:     if (mappedFile != null) {\n 65:         // å½“æ˜¯ConsumeQueueç¬¬ä¸€ä¸ªMappedFile && é˜Ÿåˆ—ä½ç½®éç¬¬ä¸€ä¸ª && MappedFileæœªå†™å…¥å†…å®¹ï¼Œåˆ™å¡«å……å‰ç½®ç©ºç™½å ä½\n 66:         if (mappedFile.isFirstCreateInQueue() && cqOffset != 0 && mappedFile.getWrotePosition() == 0) { // TODO ç–‘é—®ï¼šä¸ºå•¥è¿™ä¸ªæ“ä½œã€‚ç›®å‰èƒ½å¤Ÿæƒ³è±¡åˆ°çš„æ˜¯ï¼Œä¸€äº›è€çš„æ¶ˆæ¯å¾ˆä¹…æ²¡å‘é€ï¼Œçªç„¶å‘é€ï¼Œè¿™ä¸ªæ—¶å€™åˆšå¥½æ»¡è¶³ã€‚\n 67:             this.minLogicOffset = expectLogicOffset;\n 68:             this.mappedFileQueue.setFlushedWhere(expectLogicOffset);\n 69:             this.mappedFileQueue.setCommittedWhere(expectLogicOffset);\n 70:             this.fillPreBlank(mappedFile, expectLogicOffset);\n 71:             log.info(\"fill pre blank space \" + mappedFile.getFileName() + \" \" + expectLogicOffset + \" \"\n 72:                 + mappedFile.getWrotePosition());\n 73:         }\n 74:         // æ ¡éªŒconsumeQueueå­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ã€‚TODO å¦‚æœä¸åˆæ³•ï¼Œç»§ç»­å†™å…¥ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ\n 75:         if (cqOffset != 0) {\n 76:             long currentLogicOffset = mappedFile.getWrotePosition() + mappedFile.getFileFromOffset();\n 77:             if (expectLogicOffset != currentLogicOffset) {\n 78:                 LOG_ERROR.warn(\n 79:                     \"[BUG]logic queue order maybe wrong, expectLogicOffset: {} currentLogicOffset: {} Topic: {} QID: {} Diff: {}\",\n 80:                     expectLogicOffset,\n 81:                     currentLogicOffset,\n 82:                     this.topic,\n 83:                     this.queueId,\n 84:                     expectLogicOffset - currentLogicOffset\n 85:                 );\n 86:             }\n 87:         }\n 88:         // è®¾ç½®commitLogé‡æ”¾æ¶ˆæ¯åˆ°ConsumeQueueä½ç½®ã€‚\n 89:         this.maxPhysicOffset = offset;\n 90:         // æ’å…¥mappedFile\n 91:         return mappedFile.appendMessage(this.byteBufferIndex.array());\n 92:     }\n 93:     return false;\n 94: }\n 95: \n 96: /**\n 97:  * å¡«å……å‰ç½®ç©ºç™½å ä½\n 98:  *\n 99:  * @param mappedFile MappedFile\n100:  * @param untilWhere consumeQueueå­˜å‚¨ä½ç½®\n101:  */\n102: private void fillPreBlank(final MappedFile mappedFile, final long untilWhere) {\n103:     // å†™å…¥å‰ç½®ç©ºç™½å ä½åˆ°byteBuffer\n104:     ByteBuffer byteBuffer = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);\n105:     byteBuffer.putLong(0L);\n106:     byteBuffer.putInt(Integer.MAX_VALUE);\n107:     byteBuffer.putLong(0L);\n108:     // å¾ªç¯å¡«ç©º\n109:     int until = (int) (untilWhere % this.mappedFileQueue.getMappedFileSize());\n110:     for (int i = 0; i < until; i += CQ_STORE_UNIT_SIZE) {\n111:         mappedFile.appendMessage(byteBuffer.array());\n112:     }\n113: }\n```\n\n* `#putMessagePositionInfoWrapper(...)` è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° `ConsumeQueue` çš„å°è£…ï¼Œå®é™…éœ€è¦è°ƒç”¨ `#putMessagePositionInfo(...)` æ–¹æ³•ã€‚\n    * ç¬¬ 13 è¡Œ ï¼šåˆ¤æ–­ `ConsumeQueue` æ˜¯å¦å…è®¸å†™å…¥ã€‚å½“å‘ç”ŸBugæ—¶ï¼Œä¸å…è®¸å†™å…¥ã€‚\n    * ç¬¬ 17 è¡Œ ï¼šè°ƒç”¨ `#putMessagePositionInfo(...)` æ–¹æ³•ï¼Œæ·»åŠ ä½ç½®ä¿¡æ¯ã€‚\n    * ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨æ£€æŸ¥ç‚¹ã€‚`StoreCheckpoint` çš„è¯¦ç»†è§£æè§ï¼š[Storeåˆå§‹åŒ–ä¸å…³é—­](http://www.yunai.me/RocketMQ/store-init-and-shutdown/)ã€‚\n    * ç¬¬ 22 è‡³ 32 è¡Œ ï¼šæ·»åŠ å¤±è´¥ï¼Œç›®å‰åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯BUGã€‚\n    * ç¬¬ 35 è‡³ 37 è¡Œ ï¼šå†™å…¥å¤±è´¥æ—¶ï¼Œæ ‡è®° `ConsumeQueue` å†™å…¥å¼‚å¸¸ï¼Œä¸å…è®¸ç»§ç»­å†™å…¥ã€‚\n* `#putMessagePositionInfo(...)` è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° `ConsumeQueue`ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸã€‚\n    * ç¬¬ 51 è‡³ 54 è¡Œ ï¼šå¦‚æœ `offset`(å­˜å‚¨ä½ç½®) å°äºç­‰äº  `maxPhysicOffset`(`CommitLog` æ¶ˆæ¯é‡æ”¾åˆ° `ConsumeQueue` æœ€å¤§çš„ `CommitLog` å­˜å‚¨ä½ç½®)ï¼Œè¡¨ç¤ºå·²ç»é‡æ”¾è¿‡ï¼Œæ­¤æ—¶ï¼Œä¸å†é‡å¤å†™å…¥ï¼Œç›´æ¥è¿”å›å†™å…¥æˆåŠŸã€‚\n    * ç¬¬ 55 è‡³ 60 è¡Œ ï¼šå†™ ä½ç½®ä¿¡æ¯åˆ°byteBufferã€‚\n    * ç¬¬ 62 è‡³ 63 è¡Œ ï¼šè®¡ç®— `ConsumeQueue`å­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFileã€‚\n    * ç¬¬ 65 è‡³ 73 è¡Œ ï¼šå½“ `MappedFile` æ˜¯ `ConsumeQueue` å½“å‰ç¬¬ä¸€ä¸ªæ–‡ä»¶ && `MappedFile` æœªå†™å…¥å†…å®¹ && é‡æ”¾æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å¤§äº0ï¼Œåˆ™éœ€è¦è¿›è¡Œ `MappedFile` å¡«å……å‰ç½®  `BLANK`ã€‚\n       * *è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä¼šéœ€è¦ã€‚çŒœæµ‹äº§ç”Ÿçš„åŸå› ï¼šä¸€ä¸ª `Topic` é•¿æœŸæ— æ¶ˆæ¯äº§ç”Ÿï¼Œçªç„¶Nå¤©åè¿›è¡Œå‘é€ï¼Œ`Topic` å¯¹åº”çš„å†å²æ¶ˆæ¯ä»¥åŠå’Œæ¶ˆè´¹é˜Ÿåˆ—æ•°æ®å·²ç»è¢«æ¸…ç†ï¼Œæ–°ç”Ÿæˆçš„`MappedFile`éœ€è¦å‰ç½®å ä½ã€‚*\n    * ç¬¬ 74 è‡³ 87 è¡Œ ï¼šæ ¡éªŒ `ConsumeQueue` å­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™è¾“å‡ºæ—¥å¿—ã€‚\n        * *è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œå¦‚æœè®¡ç®—å‡ºæ¥çš„å­˜å‚¨ä½ç½®ä¸åˆæ³•ï¼Œä¸è¿”å›æ·»åŠ å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œæ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿ*\n    * ç¬¬ 89 è¡Œ ï¼šè®¾ç½® `CommitLog` é‡æ”¾æ¶ˆæ¯åˆ° `ConsumeQueue` çš„æœ€å¤§ä½ç½®ã€‚\n    * ç¬¬ 91 è¡Œ ï¼šæ’å…¥æ¶ˆæ¯ä½ç½®åˆ° `MappedFile`ã€‚\n\n## FlushConsumeQueueService\n\n```Java\n  1: class FlushConsumeQueueService extends ServiceThread {\n  2:     private static final int RETRY_TIMES_OVER = 3;\n  3:     /**\n  4:      * æœ€åflushæ—¶é—´æˆ³\n  5:      */\n  6:     private long lastFlushTimestamp = 0;\n  7: \n  8:     private void doFlush(int retryTimes) {\n  9:         int flushConsumeQueueLeastPages = DefaultMessageStore.this.getMessageStoreConfig().getFlushConsumeQueueLeastPages();\n 10: \n 11:         // retryTimes == RETRY_TIMES_OVERæ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ä¸»è¦ç”¨äºshutdownæ—¶ã€‚\n 12:         if (retryTimes == RETRY_TIMES_OVER) {\n 13:             flushConsumeQueueLeastPages = 0;\n 14:         }\n 15:         // å½“æ—¶é—´æ»¡è¶³flushConsumeQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushConsumeQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush\n 16:         long logicsMsgTimestamp = 0;\n 17:         int flushConsumeQueueThoroughInterval = DefaultMessageStore.this.getMessageStoreConfig().getFlushConsumeQueueThoroughInterval();\n 18:         long currentTimeMillis = System.currentTimeMillis();\n 19:         if (currentTimeMillis >= (this.lastFlushTimestamp + flushConsumeQueueThoroughInterval)) {\n 20:             this.lastFlushTimestamp = currentTimeMillis;\n 21:             flushConsumeQueueLeastPages = 0;\n 22:             logicsMsgTimestamp = DefaultMessageStore.this.getStoreCheckpoint().getLogicsMsgTimestamp();\n 23:         }\n 24:         // flushæ¶ˆè´¹é˜Ÿåˆ—\n 25:         ConcurrentHashMap<String, ConcurrentHashMap<Integer, ConsumeQueue>> tables = DefaultMessageStore.this.consumeQueueTable;\n 26:         for (ConcurrentHashMap<Integer, ConsumeQueue> maps : tables.values()) {\n 27:             for (ConsumeQueue cq : maps.values()) {\n 28:                 boolean result = false;\n 29:                 for (int i = 0; i < retryTimes && !result; i++) {\n 30:                     result = cq.flush(flushConsumeQueueLeastPages);\n 31:                 }\n 32:             }\n 33:         }\n 34:         // flush å­˜å‚¨ check point\n 35:         if (0 == flushConsumeQueueLeastPages) {\n 36:             if (logicsMsgTimestamp > 0) {\n 37:                 DefaultMessageStore.this.getStoreCheckpoint().setLogicsMsgTimestamp(logicsMsgTimestamp);\n 38:             }\n 39:             DefaultMessageStore.this.getStoreCheckpoint().flush();\n 40:         }\n 41:     }\n 42: \n 43:     public void run() {\n 44:         DefaultMessageStore.log.info(this.getServiceName() + \" service started\");\n 45: \n 46:         while (!this.isStopped()) {\n 47:             try {\n 48:                 int interval = DefaultMessageStore.this.getMessageStoreConfig().getFlushIntervalConsumeQueue();\n 49:                 this.waitForRunning(interval);\n 50:                 this.doFlush(1);\n 51:             } catch (Exception e) {\n 52:                 DefaultMessageStore.log.warn(this.getServiceName() + \" service has exception. \", e);\n 53:             }\n 54:         }\n 55: \n 56:         this.doFlush(RETRY_TIMES_OVER);\n 57: \n 58:         DefaultMessageStore.log.info(this.getServiceName() + \" service end\");\n 59:     }\n 60: \n 61:     @Override\n 62:     public String getServiceName() {\n 63:         return FlushConsumeQueueService.class.getSimpleName();\n 64:     }\n 65: \n 66:     @Override\n 67:     public long getJointime() {\n 68:         return 1000 * 60;\n 69:     }\n 70: }\n```\n\n* è¯´æ˜ ï¼šflush `ConsumeQueue`(æ¶ˆè´¹é˜Ÿåˆ—) çº¿ç¨‹æœåŠ¡ã€‚\n* ç¬¬ 11 è‡³ 14 è¡Œ ï¼šå½“ `retryTimes == RETRY_TIMES_OVER` æ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ç”¨äº `shutdown` æ—¶ã€‚\n* ç¬¬ 15 è‡³ 23 è¡Œ ï¼šæ¯ flushConsumeQueueThoroughInterval å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ flush ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ flushConsumeQueueLeastPages å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ flush ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ flushï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚\n* ç¬¬ 24 è‡³ 33 è¡Œ ï¼šflush `ConsumeQueue`(æ¶ˆè´¹é˜Ÿåˆ—)ã€‚\n    * flush é€»è¾‘ï¼š[MappedFile#è½ç›˜](http://www.yunai.me/RocketMQ/message-store/#MappedFile-è½ç›˜)ã€‚\n* ç¬¬ 34 è‡³ 40 è¡Œ ï¼šflush `StoreCheckpoint`ã€‚`StoreCheckpoint` çš„è¯¦ç»†è§£æè§ï¼š[Storeåˆå§‹åŒ–ä¸å…³é—­](http://www.yunai.me/RocketMQ/store-init-and-shutdown/)ã€‚\n* ç¬¬ 43 è‡³ 59 è¡Œ ï¼šæ¯ 1000ms æ‰§è¡Œä¸€æ¬¡ `flush`ã€‚å¦‚æœ wakeup() æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡ `flush`ã€‚ç›®å‰ï¼Œæš‚æ—¶ä¸å­˜åœ¨ wakeup() çš„è°ƒç”¨ã€‚\n\n# 4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£\n\n## PullMessageRequestHeader\n\n```Java\n  1: public class PullMessageRequestHeader implements CommandCustomHeader {\n  2:     /**\n  3:      * æ¶ˆè´¹è€…åˆ†ç»„\n  4:      */\n  5:     @CFNotNull\n  6:     private String consumerGroup;\n  7:     /**\n  8:      * Topic\n  9:      */\n 10:     @CFNotNull\n 11:     private String topic;\n 12:     /**\n 13:      * é˜Ÿåˆ—ç¼–å·\n 14:      */\n 15:     @CFNotNull\n 16:     private Integer queueId;\n 17:     /**\n 18:      * é˜Ÿåˆ—å¼€å§‹ä½ç½®\n 19:      */\n 20:     @CFNotNull\n 21:     private Long queueOffset;\n 22:     /**\n 23:      * æ¶ˆæ¯æ•°é‡\n 24:      */\n 25:     @CFNotNull\n 26:     private Integer maxMsgNums;\n 27:     /**\n 28:      * ç³»ç»Ÿæ ‡è¯†\n 29:      */\n 30:     @CFNotNull\n 31:     private Integer sysFlag;\n 32:     /**\n 33:      * æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®\n 34:      */\n 35:     @CFNotNull\n 36:     private Long commitOffset;\n 37:     /**\n 38:      * æŒ‚èµ·è¶…æ—¶æ—¶é—´\n 39:      */\n 40:     @CFNotNull\n 41:     private Long suspendTimeoutMillis;\n 42:     /**\n 43:      * è®¢é˜…è¡¨è¾¾å¼\n 44:      */\n 45:     @CFNullable\n 46:     private String subscription;\n 47:     /**\n 48:      * è®¢é˜…ç‰ˆæœ¬å·\n 49:      */\n 50:     @CFNotNull\n 51:     private Long subVersion;\n 52: }\n```\n\n* è¯´æ˜ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚Header\n* topic +  queueId + queueOffset + maxMsgNums\n* sysFlag ï¼šç³»ç»Ÿæ ‡è¯†ã€‚\n    * ç¬¬ 0 ä½ `FLAG_COMMIT_OFFSET` ï¼šæ ‡è®°è¯·æ±‚æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®ï¼Œå’Œ `commitOffset` é…åˆã€‚\n    * ç¬¬ 1 ä½ `FLAG_SUSPEND` ï¼šæ ‡è®°è¯·æ±‚æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå’Œ `suspendTimeoutMillis` é…åˆã€‚å½“æ‹‰å–ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œ `Broker` ä¼šæŒ‚èµ·è¯·æ±‚ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ã€‚æœ€å¤§æŒ‚èµ·æ—¶é—´ï¼š`suspendTimeoutMillis` æ¯«ç§’ã€‚\n    * ç¬¬ 2 ä½ `FLAG_SUBSCRIPTION` ï¼šæ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼ï¼Œå’Œ `subscription` é…ç½®ã€‚\n* subVersion ï¼šè®¢é˜…ç‰ˆæœ¬å·ã€‚è¯·æ±‚æ—¶ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸å¯¹ï¼Œåˆ™æ— æ³•æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°è·å–è®¢é˜…ä¿¡æ¯ï¼Œä½¿ç”¨æœ€æ–°çš„è®¢é˜…ç‰ˆæœ¬å·ã€‚\n\n## PullMessageProcessor#processRequest(...)\n\n```Java\n  1: private RemotingCommand processRequest(final Channel channel, RemotingCommand request, boolean brokerAllowSuspend)\n  2:     throws RemotingCommandException {\n  3:     RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);\n  4:     final PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();\n  5:     final PullMessageRequestHeader requestHeader =\n  6:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);\n  7: \n  8:     response.setOpaque(request.getOpaque());\n  9: \n 10:     if (LOG.isDebugEnabled()) {\n 11:         LOG.debug(\"receive PullMessage request command, {}\", request);\n 12:     }\n 13: \n 14:     // æ ¡éªŒ broker æ˜¯å¦å¯è¯»\n 15:     if (!PermName.isReadable(this.brokerController.getBrokerConfig().getBrokerPermission())) {\n 16:         response.setCode(ResponseCode.NO_PERMISSION);\n 17:         response.setRemark(String.format(\"the broker[%s] pulling message is forbidden\", this.brokerController.getBrokerConfig().getBrokerIP1()));\n 18:         return response;\n 19:     }\n 20: \n 21:     // æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å­˜åœ¨\n 22:     SubscriptionGroupConfig subscriptionGroupConfig = this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());\n 23:     if (null == subscriptionGroupConfig) {\n 24:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);\n 25:         response.setRemark(String.format(\"subscription group [%s] does not exist, %s\", requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));\n 26:         return response;\n 27:     }\n 28:     // æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å¯æ¶ˆè´¹\n 29:     if (!subscriptionGroupConfig.isConsumeEnable()) {\n 30:         response.setCode(ResponseCode.NO_PERMISSION);\n 31:         response.setRemark(\"subscription group no permission, \" + requestHeader.getConsumerGroup());\n 32:         return response;\n 33:     }\n 34: \n 35:     final boolean hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag()); // æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå½“æ²¡æœ‰æ¶ˆæ¯æ—¶\n 36:     final boolean hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag()); // æ˜¯å¦æäº¤æ¶ˆè´¹è¿›åº¦\n 37:     final boolean hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag()); // æ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼(subscription)\n 38:     final long suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : 0; // æŒ‚èµ·è¯·æ±‚è¶…æ—¶æ—¶é•¿\n 39: \n 40:     // æ ¡éªŒ topicé…ç½® å­˜åœ¨\n 41:     TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());\n 42:     if (null == topicConfig) {\n 43:         LOG.error(\"The topic {} not exist, consumer: {} \", requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));\n 44:         response.setCode(ResponseCode.TOPIC_NOT_EXIST);\n 45:         response.setRemark(String.format(\"topic[%s] not exist, apply first please! %s\", requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));\n 46:         return response;\n 47:     }\n 48:     // æ ¡éªŒ topicé…ç½® æƒé™å¯è¯»\n 49:     if (!PermName.isReadable(topicConfig.getPerm())) {\n 50:         response.setCode(ResponseCode.NO_PERMISSION);\n 51:         response.setRemark(\"the topic[\" + requestHeader.getTopic() + \"] pulling message is forbidden\");\n 52:         return response;\n 53:     }\n 54:     // æ ¡éªŒ è¯»å–é˜Ÿåˆ— åœ¨ topicé…ç½® é˜Ÿåˆ—èŒƒå›´å†…\n 55:     if (requestHeader.getQueueId() < 0 || requestHeader.getQueueId() >= topicConfig.getReadQueueNums()) {\n 56:         String errorInfo = String.format(\"queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]\",\n 57:                 requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());\n 58:         LOG.warn(errorInfo);\n 59:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 60:         response.setRemark(errorInfo);\n 61:         return response;\n 62:     }\n 63: \n 64:     // æ ¡éªŒ è®¢é˜…å…³ç³»\n 65:     SubscriptionData subscriptionData;\n 66:     if (hasSubscriptionFlag) {\n 67:         try {\n 68:             subscriptionData = FilterAPI.buildSubscriptionData(requestHeader.getConsumerGroup(), requestHeader.getTopic(),\n 69:                 requestHeader.getSubscription());\n 70:         } catch (Exception e) {\n 71:             LOG.warn(\"Parse the consumer's subscription[{}] failed, group: {}\", requestHeader.getSubscription(), //\n 72:                     requestHeader.getConsumerGroup());\n 73:             response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);\n 74:             response.setRemark(\"parse the consumer's subscription failed\");\n 75:             return response;\n 76:         }\n 77:     } else {\n 78:         // æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ˜¯å¦å­˜åœ¨\n 79:         ConsumerGroupInfo consumerGroupInfo = this.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());\n 80:         if (null == consumerGroupInfo) {\n 81:             LOG.warn(\"The consumer's group info not exist, group: {}\", requestHeader.getConsumerGroup());\n 82:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);\n 83:             response.setRemark(\"the consumer's group info not exist\" + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));\n 84:             return response;\n 85:         }\n 86:         // æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ¶ˆæ¯æ¨¡å‹æ˜¯å¦åŒ¹é…\n 87:         if (!subscriptionGroupConfig.isConsumeBroadcastEnable() //\n 88:             && consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) {\n 89:             response.setCode(ResponseCode.NO_PERMISSION);\n 90:             response.setRemark(\"the consumer group[\" + requestHeader.getConsumerGroup() + \"] can not consume by broadcast way\");\n 91:             return response;\n 92:         }\n 93: \n 94:         // æ ¡éªŒ è®¢é˜…ä¿¡æ¯ æ˜¯å¦å­˜åœ¨\n 95:         subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());\n 96:         if (null == subscriptionData) {\n 97:             LOG.warn(\"The consumer's subscription not exist, group: {}, topic:{}\", requestHeader.getConsumerGroup(), requestHeader.getTopic());\n 98:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);\n 99:             response.setRemark(\"the consumer's subscription not exist\" + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));\n100:             return response;\n101:         }\n102:         // æ ¡éªŒ è®¢é˜…ä¿¡æ¯ç‰ˆæœ¬ æ˜¯å¦åˆæ³•\n103:         if (subscriptionData.getSubVersion() < requestHeader.getSubVersion()) {\n104:             LOG.warn(\"The broker's subscription is not latest, group: {} {}\", requestHeader.getConsumerGroup(),\n105:                     subscriptionData.getSubString());\n106:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);\n107:             response.setRemark(\"the consumer's subscription not latest\");\n108:             return response;\n109:         }\n110:     }\n111: \n112:     // è·å–æ¶ˆæ¯\n113:     final GetMessageResult getMessageResult = this.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),\n114:             requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), subscriptionData);\n115:     if (getMessageResult != null) {\n116:         response.setRemark(getMessageResult.getStatus().name());\n117:         responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());\n118:         responseHeader.setMinOffset(getMessageResult.getMinOffset());\n119:         responseHeader.setMaxOffset(getMessageResult.getMaxOffset());\n120: \n121:         // TODO å¾…è¯»\n122:         // è®¡ç®—å»ºè®®è¯»å–brokerId\n123:         if (getMessageResult.isSuggestPullingFromSlave()) {\n124:             responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());\n125:         } else {\n126:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n127:         }\n128: \n129:         switch (this.brokerController.getMessageStoreConfig().getBrokerRole()) {\n130:             case ASYNC_MASTER:\n131:             case SYNC_MASTER:\n132:                 break;\n133:             case SLAVE:\n134:                 if (!this.brokerController.getBrokerConfig().isSlaveReadEnable()) { // ä»èŠ‚ç‚¹ä¸å…è®¸è¯»å–ï¼Œå‘Šè¯‰consumerè¯»å–ä¸»èŠ‚ç‚¹ã€‚\n135:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n136:                     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n137:                 }\n138:                 break;\n139:         }\n140: \n141:         if (this.brokerController.getBrokerConfig().isSlaveReadEnable()) {\n142:             // consume too slow ,redirect to another machine\n143:             if (getMessageResult.isSuggestPullingFromSlave()) {\n144:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());\n145:             }\n146:             // consume ok\n147:             else {\n148:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());\n149:             }\n150:         } else {\n151:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);\n152:         }\n153: \n154:         switch (getMessageResult.getStatus()) {\n155:             case FOUND:\n156:                 response.setCode(ResponseCode.SUCCESS);\n157:                 break;\n158:             case MESSAGE_WAS_REMOVING:\n159:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n160:                 break;\n161:             case NO_MATCHED_LOGIC_QUEUE:\n162:             case NO_MESSAGE_IN_QUEUE:\n163:                 if (0 != requestHeader.getQueueOffset()) {\n164:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n165: \n166:                     // XXX: warn and notify me\n167:                     LOG.info(\"the broker store no queue data, fix the request offset {} to {}, Topic: {} QueueId: {} Consumer Group: {}\", //\n168:                         requestHeader.getQueueOffset(), //\n169:                         getMessageResult.getNextBeginOffset(), //\n170:                         requestHeader.getTopic(), //\n171:                         requestHeader.getQueueId(), //\n172:                         requestHeader.getConsumerGroup()//\n173:                     );\n174:                 } else {\n175:                     response.setCode(ResponseCode.PULL_NOT_FOUND);\n176:                 }\n177:                 break;\n178:             case NO_MATCHED_MESSAGE:\n179:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n180:                 break;\n181:             case OFFSET_FOUND_NULL:\n182:                 response.setCode(ResponseCode.PULL_NOT_FOUND);\n183:                 break;\n184:             case OFFSET_OVERFLOW_BADLY:\n185:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n186:                 // XXX: warn and notify me\n187:                 LOG.info(\"The request offset:{} over flow badly, broker max offset:{} , consumer: {}\", requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());\n188:                 break;\n189:             case OFFSET_OVERFLOW_ONE:\n190:                 response.setCode(ResponseCode.PULL_NOT_FOUND);\n191:                 break;\n192:             case OFFSET_TOO_SMALL:\n193:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);\n194:                 LOG.info(\"The request offset is too small. group={}, topic={}, requestOffset={}, brokerMinOffset={}, clientIp={}\",\n195:                     requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),\n196:                     getMessageResult.getMinOffset(), channel.remoteAddress());\n197:                 break;\n198:             default:\n199:                 assert false;\n200:                 break;\n201:         }\n202: \n203:         // hookï¼šbefore\n204:         if (this.hasConsumeMessageHook()) {\n205:             ConsumeMessageContext context = new ConsumeMessageContext();\n206:             context.setConsumerGroup(requestHeader.getConsumerGroup());\n207:             context.setTopic(requestHeader.getTopic());\n208:             context.setQueueId(requestHeader.getQueueId());\n209: \n210:             String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);\n211: \n212:             switch (response.getCode()) {\n213:                 case ResponseCode.SUCCESS:\n214:                     int commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();\n215:                     int incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;\n216: \n217:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);\n218:                     context.setCommercialRcvTimes(incValue);\n219:                     context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());\n220:                     context.setCommercialOwner(owner);\n221: \n222:                     break;\n223:                 case ResponseCode.PULL_NOT_FOUND:\n224:                     if (!brokerAllowSuspend) {\n225: \n226:                         context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);\n227:                         context.setCommercialRcvTimes(1);\n228:                         context.setCommercialOwner(owner);\n229: \n230:                     }\n231:                     break;\n232:                 case ResponseCode.PULL_RETRY_IMMEDIATELY:\n233:                 case ResponseCode.PULL_OFFSET_MOVED:\n234:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);\n235:                     context.setCommercialRcvTimes(1);\n236:                     context.setCommercialOwner(owner);\n237:                     break;\n238:                 default:\n239:                     assert false;\n240:                     break;\n241:             }\n242: \n243:             this.executeConsumeMessageHookBefore(context);\n244:         }\n245: \n246:         switch (response.getCode()) {\n247:             case ResponseCode.SUCCESS:\n248: \n249:                 this.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),\n250:                     getMessageResult.getMessageCount());\n251:                 this.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),\n252:                     getMessageResult.getBufferTotalSize());\n253:                 this.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());\n254:                 // è¯»å–æ¶ˆæ¯\n255:                 if (this.brokerController.getBrokerConfig().isTransferMsgByHeap()) { // å†…å­˜ä¸­\n256:                     final long beginTimeMills = this.brokerController.getMessageStore().now();\n257: \n258:                     final byte[] r = this.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());\n259: \n260:                     this.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),\n261:                         requestHeader.getTopic(), requestHeader.getQueueId(),\n262:                         (int) (this.brokerController.getMessageStore().now() - beginTimeMills));\n263:                     response.setBody(r);\n264:                 } else { // zero-copy\n265:                     try {\n266:                         FileRegion fileRegion = new ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);\n267:                         channel.writeAndFlush(fileRegion).addListener(new ChannelFutureListener() {\n268:                             @Override\n269:                             public void operationComplete(ChannelFuture future) throws Exception {\n270:                                 getMessageResult.release();\n271:                                 if (!future.isSuccess()) {\n272:                                     LOG.error(\"Fail to transfer messages from page cache to {}\", channel.remoteAddress(), future.cause());\n273:                                 }\n274:                             }\n275:                         });\n276:                     } catch (Throwable e) {\n277:                         LOG.error(\"Error occurred when transferring messages from page cache\", e);\n278:                         getMessageResult.release();\n279:                     }\n280: \n281:                     response = null;\n282:                 }\n283:                 break;\n284:             case ResponseCode.PULL_NOT_FOUND:\n285:                 // æ¶ˆæ¯æœªæŸ¥è¯¢åˆ° && brokerå…è®¸æŒ‚èµ·è¯·æ±‚ && è¯·æ±‚å…è®¸æŒ‚èµ·\n286:                 if (brokerAllowSuspend && hasSuspendFlag) {\n287:                     long pollingTimeMills = suspendTimeoutMillisLong;\n288:                     if (!this.brokerController.getBrokerConfig().isLongPollingEnable()) {\n289:                         pollingTimeMills = this.brokerController.getBrokerConfig().getShortPollingTimeMills();\n290:                     }\n291: \n292:                     String topic = requestHeader.getTopic();\n293:                     long offset = requestHeader.getQueueOffset();\n294:                     int queueId = requestHeader.getQueueId();\n295:                     PullRequest pullRequest = new PullRequest(request, channel, pollingTimeMills,\n296:                         this.brokerController.getMessageStore().now(), offset, subscriptionData);\n297:                     this.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);\n298:                     response = null;\n299:                     break;\n300:                 }\n301: \n302:             case ResponseCode.PULL_RETRY_IMMEDIATELY:\n303:                 break;\n304:             case ResponseCode.PULL_OFFSET_MOVED:\n305:                 if (this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE\n306:                     || this.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) { // TODO å¾…åšå®¢è¡¥å……\n307:                     MessageQueue mq = new MessageQueue();\n308:                     mq.setTopic(requestHeader.getTopic());\n309:                     mq.setQueueId(requestHeader.getQueueId());\n310:                     mq.setBrokerName(this.brokerController.getBrokerConfig().getBrokerName());\n311: \n312:                     OffsetMovedEvent event = new OffsetMovedEvent();\n313:                     event.setConsumerGroup(requestHeader.getConsumerGroup());\n314:                     event.setMessageQueue(mq);\n315:                     event.setOffsetRequest(requestHeader.getQueueOffset());\n316:                     event.setOffsetNew(getMessageResult.getNextBeginOffset());\n317:                     this.generateOffsetMovedEvent(event);\n318:                     LOG.warn(\n319:                         \"PULL_OFFSET_MOVED:correction offset. topic={}, groupId={}, requestOffset={}, newOffset={}, suggestBrokerId={}\",\n320:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),\n321:                         responseHeader.getSuggestWhichBrokerId());\n322:                 } else {\n323:                     responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());\n324:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);\n325:                     LOG.warn(\"PULL_OFFSET_MOVED:none correction. topic={}, groupId={}, requestOffset={}, suggestBrokerId={}\",\n326:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),\n327:                         responseHeader.getSuggestWhichBrokerId());\n328:                 }\n329: \n330:                 break;\n331:             default:\n332:                 assert false;\n333:         }\n334:     } else {\n335:         response.setCode(ResponseCode.SYSTEM_ERROR);\n336:         response.setRemark(\"store getMessage return null\");\n337:     }\n338: \n339:     // è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦ && brokeréä¸»ï¼Œè¿›è¡ŒæŒä¹…åŒ–è¿›åº¦ã€‚\n340:     boolean storeOffsetEnable = brokerAllowSuspend;\n341:     storeOffsetEnable = storeOffsetEnable && hasCommitOffsetFlag;\n342:     storeOffsetEnable = storeOffsetEnable && this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;\n343:     if (storeOffsetEnable) {\n344:         this.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),\n345:             requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());\n346:     }\n347:     return response;\n348: }\n```\n\n* è¯´æ˜ï¼šå¤„ç†æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œè¿”å›å“åº”ã€‚\n* ç¬¬ 14 è‡³ 19 è¡Œ ï¼šæ ¡éªŒ `Broker` æ˜¯å¦å¯è¯»ã€‚\n* ç¬¬ 21 è‡³ 33 è¡Œ ï¼šæ ¡éªŒ `SubscriptionGroupConfig`(è®¢é˜…åˆ†ç»„é…ç½®) æ˜¯å¦å­˜åœ¨ && å¯ä»¥æ¶ˆè´¹ã€‚\n* ç¬¬ 35 è‡³ 38 è¡Œ ï¼šå¤„ç† `PullMessageRequestHeader.sysFlag` å¯¹åº”çš„æ ‡å¿—ä½ã€‚\n* ç¬¬ 40 è‡³ 62 è¡Œ ï¼šæ ¡éªŒ `TopicConfig`(ä¸»é¢˜é…ç½®) æ˜¯å¦å­˜åœ¨ && å¯è¯» && é˜Ÿåˆ—ç¼–å·æ­£ç¡®ã€‚\n* ç¬¬ 64 è‡³ 110 è¡Œ ï¼šæ ¡éªŒ `SubscriptionData`(è®¢é˜…ä¿¡æ¯) æ˜¯å¦æ­£ç¡®ã€‚\n* ç¬¬ 113 è¡Œ ï¼šè°ƒç”¨ `MessageStore#getMessage(...)` è·å– `GetMessageResult`(æ¶ˆæ¯)ã€‚è¯¦ç»†è§£æè§ï¼š[MessageStore#getMessage(...)](#messagestoregetmessage)ã€‚\n* ç¬¬ 122 è‡³ 152 è¡Œ ï¼šè®¡ç®—å»ºè®®æ‹‰å–æ¶ˆæ¯ `brokerId` ã€‚\n* ç¬¬ 154 è‡³ 201 è¡Œ ï¼š![PullMessageProcessoræ‹‰å–æ¶ˆæ¯çŠ¶æ€å›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/08.png)\n* ç¬¬ 204 è‡³ 244 è¡Œ ï¼š`Hook` é€»è¾‘ï¼Œ`#executeConsumeMessageHookBefore(...)` ã€‚\n* ç¬¬ 247 è‡³ 283 è¡Œ ï¼šæ‹‰å–æ¶ˆæ¯æˆåŠŸï¼Œå³æ‹‰å–åˆ°æ¶ˆæ¯ã€‚\n    * ç¬¬ 255 è‡³ 263 è¡Œ ï¼šæ–¹å¼ä¸€ ï¼šè°ƒç”¨ `readGetMessageResult(...)` è·å–æ¶ˆæ¯å†…å®¹åˆ°å †å†…å†…å­˜ï¼Œè®¾ç½®åˆ° å“åº”`body`ã€‚\n    * ç¬¬ 265 è‡³ 281 è¡Œ ï¼šæ–¹å¼äºŒ ï¼šåŸºäº `zero-copy` å®ç°ï¼Œç›´æ¥å“åº”ï¼Œæ— éœ€å †å†…å†…å­˜ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚*TODO ï¼šæ­¤å¤„ç­‰å¯¹zero-copyæœ‰ç ”ç©¶ï¼Œå†è¡¥å……ä¸€äº›*ã€‚\n* ç¬¬ 284 è‡³ 300 è¡Œ ï¼šæ‹‰å–ä¸åˆ°æ¶ˆæ¯ï¼Œå½“æ»¡è¶³æ¡ä»¶ (`Broker` å…è®¸æŒ‚èµ· && è¯·æ±‚è¦æ±‚æŒ‚èµ·)ï¼Œæ‰§è¡ŒæŒ‚èµ·è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š[PullRequestHoldService](#pullrequestholdservice)ã€‚\n* ç¬¬ 304 è‡³ 328 è¡Œ ï¼š*TODO ï¼šæ­¤å¤„ç­‰å¯¹`tools`æ¨¡å—ç ”ç©¶åå†è¡¥å……*ã€‚\n* ç¬¬ 339 è‡³ 346 ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå½“æ»¡è¶³ (`Broker` éä¸» && è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦)ã€‚è¯¦ç»†è§£æè§ï¼š[æ›´æ–°æ¶ˆè´¹è¿›åº¦](#3broker-æä¾›æ›´æ–°æ¶ˆè´¹è¿›åº¦æ¥å£)ã€‚\n\n## MessageStore#getMessage(...)\n\n```Java\n  1: /**\n  2:  * è·å–æ¶ˆæ¯ç»“æœ\n  3:  *\n  4:  * @param group æ¶ˆè´¹åˆ†ç»„\n  5:  * @param topic ä¸»é¢˜\n  6:  * @param queueId é˜Ÿåˆ—ç¼–å·\n  7:  * @param offset é˜Ÿåˆ—ä½ç½®\n  8:  * @param maxMsgNums æ¶ˆæ¯æ•°é‡\n  9:  * @param subscriptionData è®¢é˜…ä¿¡æ¯\n 10:  * @return æ¶ˆæ¯ç»“æœ\n 11:  */\n 12: public GetMessageResult getMessage(final String group, final String topic, final int queueId, final long offset, final int maxMsgNums,\n 13:     final SubscriptionData subscriptionData) {\n 14:     // æ˜¯å¦å…³é—­\n 15:     if (this.shutdown) {\n 16:         log.warn(\"message store has shutdown, so getMessage is forbidden\");\n 17:         return null;\n 18:     }\n 19:     // æ˜¯å¦å¯è¯»\n 20:     if (!this.runningFlags.isReadable()) {\n 21:         log.warn(\"message store is not readable, so getMessage is forbidden \" + this.runningFlags.getFlagBits());\n 22:         return null;\n 23:     }\n 24: \n 25:     long beginTime = this.getSystemClock().now();\n 26: \n 27:     GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;\n 28:     long nextBeginOffset = offset;\n 29:     long minOffset = 0;\n 30:     long maxOffset = 0;\n 31: \n 32:     GetMessageResult getResult = new GetMessageResult();\n 33: \n 34:     final long maxOffsetPy = this.commitLog.getMaxOffset();\n 35: \n 36:     // è·å–æ¶ˆè´¹é˜Ÿåˆ—\n 37:     ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);\n 38:     if (consumeQueue != null) {\n 39:         minOffset = consumeQueue.getMinOffsetInQueue(); // æ¶ˆè´¹é˜Ÿåˆ— æœ€å°é˜Ÿåˆ—ç¼–å·\n 40:         maxOffset = consumeQueue.getMaxOffsetInQueue(); // æ¶ˆè´¹é˜Ÿåˆ— æœ€å¤§é˜Ÿåˆ—ç¼–å·\n 41: \n 42:         // åˆ¤æ–­ é˜Ÿåˆ—ä½ç½®(offset)\n 43:         if (maxOffset == 0) { // æ¶ˆè´¹é˜Ÿåˆ—æ— æ¶ˆæ¯\n 44:             status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;\n 45:             nextBeginOffset = nextOffsetCorrection(offset, 0);\n 46:         } else if (offset < minOffset) { // æŸ¥è¯¢offset å¤ªå°\n 47:             status = GetMessageStatus.OFFSET_TOO_SMALL;\n 48:             nextBeginOffset = nextOffsetCorrection(offset, minOffset);\n 49:         } else if (offset == maxOffset) { // æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— ä¸€ä¸ªä½ç½®\n 50:             status = GetMessageStatus.OFFSET_OVERFLOW_ONE;\n 51:             nextBeginOffset = nextOffsetCorrection(offset, offset);\n 52:         } else if (offset > maxOffset) { // æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— å¤ªå¤š(å¤§äºä¸€ä¸ªä½ç½®)\n 53:             status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;\n 54:             if (0 == minOffset) { // TODO blog è¿™é‡Œæ˜¯ï¼Ÿï¼Ÿä¸ºå•¥0 == minOffsetåšäº†ç‰¹æ®Šåˆ¤æ–­\n 55:                 nextBeginOffset = nextOffsetCorrection(offset, minOffset);\n 56:             } else {\n 57:                 nextBeginOffset = nextOffsetCorrection(offset, maxOffset);\n 58:             }\n 59:         } else {\n 60:             // è·å¾— æ˜ å°„Bufferç»“æœ(MappedFile)\n 61:             SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);\n 62:             if (bufferConsumeQueue != null) {\n 63:                 try {\n 64:                     status = GetMessageStatus.NO_MATCHED_MESSAGE;\n 65: \n 66:                     long nextPhyFileStartOffset = Long.MIN_VALUE; // commitLogä¸‹ä¸€ä¸ªæ–‡ä»¶(MappedFile)å¯¹åº”çš„å¼€å§‹offsetã€‚\n 67:                     long maxPhyOffsetPulling = 0; // æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset\n 68: \n 69:                     int i = 0;\n 70:                     final int maxFilterMessageCount = 16000;\n 71:                     final boolean diskFallRecorded = this.messageStoreConfig.isDiskFallRecorded();\n 72:                     // å¾ªç¯è·å– æ¶ˆæ¯ä½ç½®ä¿¡æ¯\n 73:                     for (; i < bufferConsumeQueue.getSize() && i < maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) {\n 74:                         long offsetPy = bufferConsumeQueue.getByteBuffer().getLong(); // æ¶ˆæ¯ç‰©ç†ä½ç½®offset\n 75:                         int sizePy = bufferConsumeQueue.getByteBuffer().getInt(); // æ¶ˆæ¯é•¿åº¦\n 76:                         long tagsCode = bufferConsumeQueue.getByteBuffer().getLong(); // æ¶ˆæ¯tagsCode\n 77:                         // è®¾ç½®æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset\n 78:                         maxPhyOffsetPulling = offsetPy;\n 79:                         // å½“ offsetPy å°äº nextPhyFileStartOffset æ—¶ï¼Œæ„å‘³ç€å¯¹åº”çš„ Message å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„Messageã€‚\n 80:                         if (nextPhyFileStartOffset != Long.MIN_VALUE) {\n 81:                             if (offsetPy < nextPhyFileStartOffset)\n 82:                                 continue;\n 83:                         }\n 84:                         // æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜\n 85:                         boolean isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);\n 86:                         // æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿæ¶ˆæ¯\n 87:                         if (this.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),\n 88:                             isInDisk)) {\n 89:                             break;\n 90:                         }\n 91:                         // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶\n 92:                         if (this.messageFilter.isMessageMatched(subscriptionData, tagsCode)) {\n 93:                             // ä»commitLogè·å–å¯¹åº”æ¶ˆæ¯ByteBuffer\n 94:                             SelectMappedBufferResult selectResult = this.commitLog.getMessage(offsetPy, sizePy);\n 95:                             if (selectResult != null) {\n 96:                                 this.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();\n 97:                                 getResult.addMessage(selectResult);\n 98:                                 status = GetMessageStatus.FOUND;\n 99:                                 nextPhyFileStartOffset = Long.MIN_VALUE;\n100:                             } else {\n101:                                 // ä»commitLogæ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶ï¼ˆMappedFileï¼‰å·²ç»åˆ é™¤ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªMappedFileçš„èµ·å§‹ä½ç½®\n102:                                 if (getResult.getBufferTotalSize() == 0) {\n103:                                     status = GetMessageStatus.MESSAGE_WAS_REMOVING;\n104:                                 }\n105:                                 nextPhyFileStartOffset = this.commitLog.rollNextFile(offsetPy);\n106:                             }\n107:                         } else {\n108:                             if (getResult.getBufferTotalSize() == 0) {\n109:                                 status = GetMessageStatus.NO_MATCHED_MESSAGE;\n110:                             }\n111: \n112:                             if (log.isDebugEnabled()) {\n113:                                 log.debug(\"message type not matched, client: \" + subscriptionData + \" server: \" + tagsCode);\n114:                             }\n115:                         }\n116:                     }\n117:                     // ç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°\n118:                     if (diskFallRecorded) {\n119:                         long fallBehind = maxOffsetPy - maxPhyOffsetPulling;\n120:                         brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);\n121:                     }\n122:                     // è®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·\n123:                     nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);\n124:                     // æ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹\n125:                     long diff = maxOffsetPy - maxPhyOffsetPulling;\n126:                     long memory = (long) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE\n127:                             * (this.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / 100.0));\n128:                     getResult.setSuggestPullingFromSlave(diff > memory);\n129:                 } finally {\n130:                     bufferConsumeQueue.release();\n131:                 }\n132:             } else {\n133:                 status = GetMessageStatus.OFFSET_FOUND_NULL;\n134:                 nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));\n135:                 log.warn(\"consumer request topic: \" + topic + \"offset: \" + offset + \" minOffset: \" + minOffset + \" maxOffset: \"\n136:                     + maxOffset + \", but access logic queue failed.\");\n137:             }\n138:         }\n139:     } else {\n140:         status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;\n141:         nextBeginOffset = nextOffsetCorrection(offset, 0);\n142:     }\n143:     // ç»Ÿè®¡\n144:     if (GetMessageStatus.FOUND == status) {\n145:         this.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();\n146:     } else {\n147:         this.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();\n148:     }\n149:     long eclipseTime = this.getSystemClock().now() - beginTime;\n150:     this.storeStatsService.setGetMessageEntireTimeMax(eclipseTime);\n151:     // è®¾ç½®è¿”å›ç»“æœ\n152:     getResult.setStatus(status);\n153:     getResult.setNextBeginOffset(nextBeginOffset);\n154:     getResult.setMaxOffset(maxOffset);\n155:     getResult.setMinOffset(minOffset);\n156:     return getResult;\n157: }\n158: \n159: /**\n160:  * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· è·å– æ¶ˆè´¹é˜Ÿåˆ—\n161:  *\n162:  * @param topic ä¸»é¢˜\n163:  * @param queueId é˜Ÿåˆ—ç¼–å·\n164:  * @return æ¶ˆè´¹é˜Ÿåˆ—\n165:  */\n166: public ConsumeQueue findConsumeQueue(String topic, int queueId) {\n167:     // è·å– topic å¯¹åº”çš„ æ‰€æœ‰æ¶ˆè´¹é˜Ÿåˆ—\n168:     ConcurrentHashMap<Integer, ConsumeQueue> map = consumeQueueTable.get(topic);\n169:     if (null == map) {\n170:         ConcurrentHashMap<Integer, ConsumeQueue> newMap = new ConcurrentHashMap<>(128);\n171:         ConcurrentHashMap<Integer, ConsumeQueue> oldMap = consumeQueueTable.putIfAbsent(topic, newMap);\n172:         if (oldMap != null) {\n173:             map = oldMap;\n174:         } else {\n175:             map = newMap;\n176:         }\n177:     }\n178:     // è·å– queueId å¯¹åº”çš„ æ¶ˆè´¹é˜Ÿåˆ—\n179:     ConsumeQueue logic = map.get(queueId);\n180:     if (null == logic) {\n181:         ConsumeQueue newLogic = new ConsumeQueue(//\n182:             topic, //\n183:             queueId, //\n184:             StorePathConfigHelper.getStorePathConsumeQueue(this.messageStoreConfig.getStorePathRootDir()), //\n185:             this.getMessageStoreConfig().getMapedFileSizeConsumeQueue(), //\n186:             this);\n187:         ConsumeQueue oldLogic = map.putIfAbsent(queueId, newLogic);\n188:         if (oldLogic != null) {\n189:             logic = oldLogic;\n190:         } else {\n191:             logic = newLogic;\n192:         }\n193:     }\n194: \n195:     return logic;\n196: }\n197: \n198: /**\n199:  * ä¸‹ä¸€ä¸ªè·å–é˜Ÿåˆ—offsetä¿®æ­£\n200:  * ä¿®æ­£æ¡ä»¶ï¼šä¸»èŠ‚ç‚¹ æˆ–è€… ä»èŠ‚ç‚¹å¼€å¯æ ¡éªŒoffsetå¼€å…³\n201:  *\n202:  * @param oldOffset è€é˜Ÿåˆ—offset\n203:  * @param newOffset æ–°é˜Ÿåˆ—offset\n204:  * @return ä¿®æ­£åçš„é˜Ÿåˆ—offset\n205:  */\n206: private long nextOffsetCorrection(long oldOffset, long newOffset) {\n207:     long nextOffset = oldOffset;\n208:     if (this.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE || this.getMessageStoreConfig().isOffsetCheckInSlave()) {\n209:         nextOffset = newOffset;\n210:     }\n211:     return nextOffset;\n212: }\n213: \n214: /**\n215:  * æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜\n216:  *\n217:  * @param offsetPy commitLog æŒ‡å®šoffset\n218:  * @param maxOffsetPy commitLog æœ€å¤§offset\n219:  * @return æ˜¯å¦éœ€è¦ç¡¬ç›˜\n220:  */\n221: private boolean checkInDiskByCommitOffset(long offsetPy, long maxOffsetPy) {\n222:     long memory = (long) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE * (this.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / 100.0));\n223:     return (maxOffsetPy - offsetPy) > memory;\n224: }\n225: \n226: /**\n227:  * åˆ¤æ–­è·å–æ¶ˆæ¯æ˜¯å¦å·²ç»æ»¡\n228:  *\n229:  * @param sizePy å­—èŠ‚æ•°\n230:  * @param maxMsgNums æœ€å¤§æ¶ˆæ¯æ•°\n231:  * @param bufferTotal ç›®å‰å·²ç»è®¡ç®—å­—èŠ‚æ•°\n232:  * @param messageTotal ç›®å‰å·²ç»è®¡ç®—æ¶ˆæ¯æ•°\n233:  * @param isInDisk æ˜¯å¦åœ¨ç¡¬ç›˜ä¸­\n234:  * @return æ˜¯å¦å·²æ»¡\n235:  */\n236: private boolean isTheBatchFull(int sizePy, int maxMsgNums, int bufferTotal, int messageTotal, boolean isInDisk) {\n237:     if (0 == bufferTotal || 0 == messageTotal) {\n238:         return false;\n239:     }\n240:     // æ¶ˆæ¯æ•°é‡å·²ç»æ»¡è¶³è¯·æ±‚æ•°é‡(maxMsgNums)\n241:     if ((messageTotal + 1) >= maxMsgNums) {\n242:         return true;\n243:     }\n244:     // æ ¹æ®æ¶ˆæ¯å­˜å‚¨é…ç½®çš„æœ€å¤§ä¼ è¾“å­—èŠ‚æ•°ã€æœ€å¤§ä¼ è¾“æ¶ˆæ¯æ•°æ˜¯å¦å·²æ»¡\n245:     if (isInDisk) {\n246:         if ((bufferTotal + sizePy) > this.messageStoreConfig.getMaxTransferBytesOnMessageInDisk()) {\n247:             return true;\n248:         }\n249: \n250:         if ((messageTotal + 1) > this.messageStoreConfig.getMaxTransferCountOnMessageInDisk()) {\n251:             return true;\n252:         }\n253:     } else {\n254:         if ((bufferTotal + sizePy) > this.messageStoreConfig.getMaxTransferBytesOnMessageInMemory()) {\n255:             return true;\n256:         }\n257: \n258:         if ((messageTotal + 1) > this.messageStoreConfig.getMaxTransferCountOnMessageInMemory()) {\n259:             return true;\n260:         }\n261:     }\n262: \n263:     return false;\n264: }\n```\n\n* è¯´æ˜ ï¼šæ ¹æ® æ¶ˆæ¯åˆ†ç»„(`group`) + ä¸»é¢˜(`Topic`) + é˜Ÿåˆ—ç¼–å·(`queueId`) + é˜Ÿåˆ—ä½ç½®(`offset`) + è®¢é˜…ä¿¡æ¯(`subscriptionData`) è·å– æŒ‡å®šæ¡æ•°(`maxMsgNums`) æ¶ˆæ¯(`Message`)ã€‚\n* ç¬¬ 14 è‡³ 18 è¡Œ ï¼šåˆ¤æ–­ `Store` æ˜¯å¦å¤„äºå…³é—­çŠ¶æ€ï¼Œè‹¥å…³é—­ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚\n* ç¬¬ 19 è‡³ 23 è¡Œ ï¼šåˆ¤æ–­å½“å‰è¿è¡ŒçŠ¶æ€æ˜¯å¦å¯è¯»ï¼Œè‹¥ä¸å¯è¯»ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚\n* ç¬¬ 37 è¡Œ ï¼šæ ¹æ® ä¸»é¢˜(`Topic`) + é˜Ÿåˆ—ç¼–å·(`queueId`) è·å– æ¶ˆæ¯é˜Ÿåˆ—(`ConsumeQueue`)ã€‚\n    * `#findConsumeQueue(...)` ï¼šç¬¬ 159 è‡³ 196 è¡Œã€‚\n* ç¬¬ 43 è‡³ 58 è¡Œ ï¼šå„ç§é˜Ÿåˆ—ä½ç½®(`offset`) æ— æ³•è¯»å–æ¶ˆæ¯ï¼Œå¹¶é’ˆå¯¹å¯¹åº”çš„æƒ…å†µï¼Œè®¡ç®—ä¸‹ä¸€æ¬¡ `Client` é˜Ÿåˆ—æ‹‰å–ä½ç½®ã€‚\n    * ç¬¬ 43 è‡³ 45 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯ã€‚\n    * ç¬¬ 46 è‡³ 48 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ`offset`ï¼‰ å¤ªå°ã€‚\n    * ç¬¬ 49 è‡³ 51 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ`offset`ï¼‰ æ°å¥½ç­‰äº æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§çš„é˜Ÿåˆ—ä½ç½®ã€‚è¯¥æƒ…å†µæ˜¯æ­£å¸¸ç°è±¡ï¼Œç›¸å½“äºæŸ¥è¯¢æœ€æ–°çš„æ¶ˆæ¯ã€‚\n    * ç¬¬ 52 è‡³ 58 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ`offset`ï¼‰ è¶…è¿‡è¿‡å¤šã€‚\n    * `#nextOffsetCorrection(...)` ï¼šç¬¬ 198 è‡³ 212 è¡Œã€‚\n* ç¬¬ 61 è¡Œ ï¼šæ ¹æ® æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(`offset`) è·å– å¯¹åº”çš„`MappedFile`ã€‚\n* ç¬¬ 72 è‡³ 128 è¡Œ ï¼š**å¾ªç¯**è·å– `æ¶ˆæ¯ä½ç½®ä¿¡æ¯`ã€‚\n    * ç¬¬ 74 è‡³ 76 è¡Œ ï¼šè¯»å–æ¯ä¸€ä¸ª `æ¶ˆæ¯ä½ç½®ä¿¡æ¯`ã€‚\n    * ç¬¬ 79 è‡³ 83 è¡Œ ï¼šå½“ `offsetPy` å°äº `nextPhyFileStartOffset` æ—¶ï¼Œæ„å‘³ç€å¯¹\nåº”çš„ `Message` å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„ `Message`ã€‚\n    * ç¬¬ 84 è‡³ 90 è¡Œ ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿçš„æ¶ˆæ¯ã€‚\n        * `#checkInDiskByCommitOffset(...)` ï¼šç¬¬ 214 è‡³ 224 è¡Œã€‚\n        * `#isTheBatchFull(...)` ï¼šç¬¬ 226 è‡³ 264 è¡Œã€‚\n* ç¬¬ 92 è¡Œ ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚è¯¦ç»†è§£æè§ï¼š[DefaultMessageFilter#isMessageMatched(...)](defaultmessagefilterismessagematched)ã€‚\n* ç¬¬ 94 è¡Œ ï¼šä» `CommitLog` è·å–å¯¹åº” æ¶ˆæ¯çš„`MappedByteBuffer`ã€‚\n* ç¬¬ 95 è‡³ 99 è¡Œ ï¼šè·å– `æ¶ˆæ¯MappedByteBuffer` æˆåŠŸã€‚\n* ç¬¬ 100 è‡³ 106 è¡Œ ï¼šè·å– `æ¶ˆæ¯MappedByteBuffer` å¤±è´¥ã€‚ä» `CommitLog` æ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜ è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶(`MappedFile`) å·²ç»åˆ é™¤ï¼Œæ­¤æ—¶è®¡ç®—ä¸‹ä¸€ä¸ª`MappedFile`çš„èµ·å§‹ä½ç½®ã€‚**è¯¥é€»è¾‘éœ€è¦é…åˆï¼ˆç¬¬ 79 è‡³ 83 è¡Œï¼‰ä¸€èµ·ç†è§£ã€‚**\n* ç¬¬ 117 è‡³ 120 è¡Œ ï¼šç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ã€‚\n* ç¬¬ 123 è¡Œ ï¼šè®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·ã€‚\n* ç¬¬ 124 è‡³ 128 è¡Œ ï¼šæ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹ã€‚\n* ç¬¬ 130 è¡Œ ï¼šé‡Šæ”¾ `bufferConsumeQueue` å¯¹ `MappedFile` çš„æŒ‡å‘ã€‚æ­¤å¤„ `MappedFile` æ˜¯ `ConsumeQueue` é‡Œçš„æ–‡ä»¶ï¼Œä¸æ˜¯ `CommitLog` ä¸‹çš„æ–‡ä»¶ã€‚\n* ç¬¬ 133 è‡³ 136 è¡Œ ï¼šè·å¾—æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(`offset`) è·å– å¯¹åº”çš„`MappedFile` ä¸º**ç©º**ï¼Œè®¡ç®—`ConsumeQueue` ä» `offset` å¼€å§‹çš„ä¸‹ä¸€ä¸ª `MappedFile` å¯¹åº”çš„ä½ç½®ã€‚\n* ç¬¬ 143 è‡³ 150 è¡Œ ï¼šè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼šæ¶ˆè€—æ—¶é—´ã€æ‹‰å–åˆ°æ¶ˆæ¯/æœªæ‹‰å–åˆ°æ¶ˆæ¯æ¬¡æ•°ã€‚\n* ç¬¬ 151 è‡³ 156 è¡Œ ï¼šè®¾ç½®è¿”å›ç»“æœå¹¶è¿”å›ã€‚ \n\n## DefaultMessageFilter#isMessageMatched(...)\n\n```Java\n  1: public class DefaultMessageFilter implements MessageFilter {\n  2: \n  3:     @Override\n  4:     public boolean isMessageMatched(SubscriptionData subscriptionData, Long tagsCode) {\n  5:         // æ¶ˆæ¯tagsCode ç©º\n  6:         if (tagsCode == null) {\n  7:             return true;\n  8:         }\n  9:         // è®¢é˜…æ•°æ® ç©º\n 10:         if (null == subscriptionData) {\n 11:             return true;\n 12:         }\n 13:         // classFilter\n 14:         if (subscriptionData.isClassFilterMode())\n 15:             return true;\n 16:         // è®¢é˜…è¡¨è¾¾å¼ å…¨åŒ¹é…\n 17:         if (subscriptionData.getSubString().equals(SubscriptionData.SUB_ALL)) {\n 18:             return true;\n 19:         }\n 20:         // è®¢é˜…æ•°æ®codeæ•°ç»„ æ˜¯å¦åŒ…å« æ¶ˆæ¯tagsCode\n 21:         return subscriptionData.getCodeSet().contains(tagsCode.intValue());\n 22:     }\n 23: \n 24: }\n```\n\n* è¯´æ˜ ï¼šæ¶ˆæ¯è¿‡æ»¤å™¨é»˜è®¤å®ç°ã€‚\n\n## PullRequestHoldService\n\n```Java\n  1: public class PullRequestHoldService extends ServiceThread {\n  2: \n  3:     private static final Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);\n  4: \n  5:     private static final String TOPIC_QUEUEID_SEPARATOR = \"@\";\n  6: \n  7:     private final BrokerController brokerController;\n  8: \n  9:     private final SystemClock systemClock = new SystemClock();\n 10:     /**\n 11:      * æ¶ˆæ¯è¿‡æ»¤å™¨\n 12:      */\n 13:     private final MessageFilter messageFilter = new DefaultMessageFilter();\n 14:     /**\n 15:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é›†åˆ\n 16:      */\n 17:     private ConcurrentHashMap<String/* topic@queueId */, ManyPullRequest> pullRequestTable =\n 18:             new ConcurrentHashMap<>(1024);\n 19: \n 20:     public PullRequestHoldService(final BrokerController brokerController) {\n 21:         this.brokerController = brokerController;\n 22:     }\n 23: \n 24:     /**\n 25:      * æ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚\n 26:      *\n 27:      * @param topic ä¸»é¢˜\n 28:      * @param queueId é˜Ÿåˆ—ç¼–å·\n 29:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 30:      */\n 31:     public void suspendPullRequest(final String topic, final int queueId, final PullRequest pullRequest) {\n 32:         String key = this.buildKey(topic, queueId);\n 33:         ManyPullRequest mpr = this.pullRequestTable.get(key);\n 34:         if (null == mpr) {\n 35:             mpr = new ManyPullRequest();\n 36:             ManyPullRequest prev = this.pullRequestTable.putIfAbsent(key, mpr);\n 37:             if (prev != null) {\n 38:                 mpr = prev;\n 39:             }\n 40:         }\n 41: \n 42:         mpr.addPullRequest(pullRequest);\n 43:     }\n 44: \n 45:     /**\n 46:      * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· åˆ›å»ºå”¯ä¸€æ ‡è¯†\n 47:      *\n 48:      * @param topic ä¸»é¢˜\n 49:      * @param queueId é˜Ÿåˆ—ç¼–å·\n 50:      * @return key\n 51:      */\n 52:     private String buildKey(final String topic, final int queueId) {\n 53:         StringBuilder sb = new StringBuilder();\n 54:         sb.append(topic);\n 55:         sb.append(TOPIC_QUEUEID_SEPARATOR);\n 56:         sb.append(queueId);\n 57:         return sb.toString();\n 58:     }\n 59: \n 60:     @Override\n 61:     public void run() {\n 62:         log.info(\"{} service started\", this.getServiceName());\n 63:         while (!this.isStopped()) {\n 64:             try {\n 65:                 // æ ¹æ® é•¿è½®è®­ è¿˜æ˜¯ çŸ­è½®è®­ è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´\n 66:                 if (this.brokerController.getBrokerConfig().isLongPollingEnable()) {\n 67:                     this.waitForRunning(5 * 1000);\n 68:                 } else {\n 69:                     this.waitForRunning(this.brokerController.getBrokerConfig().getShortPollingTimeMills());\n 70:                 }\n 71:                 // æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„\n 72:                 long beginLockTimestamp = this.systemClock.now();\n 73:                 this.checkHoldRequest();\n 74:                 long costTime = this.systemClock.now() - beginLockTimestamp;\n 75:                 if (costTime > 5 * 1000) {\n 76:                     log.info(\"[NOTIFYME] check hold request cost {} ms.\", costTime);\n 77:                 }\n 78:             } catch (Throwable e) {\n 79:                 log.warn(this.getServiceName() + \" service has exception. \", e);\n 80:             }\n 81:         }\n 82: \n 83:         log.info(\"{} service end\", this.getServiceName());\n 84:     }\n 85: \n 86:     @Override\n 87:     public String getServiceName() {\n 88:         return PullRequestHoldService.class.getSimpleName();\n 89:     }\n 90: \n 91:     /**\n 92:      * éå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚\n 93:      */\n 94:     private void checkHoldRequest() {\n 95:         for (String key : this.pullRequestTable.keySet()) {\n 96:             String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);\n 97:             if (2 == kArray.length) {\n 98:                 String topic = kArray[0];\n 99:                 int queueId = Integer.parseInt(kArray[1]);\n100:                 final long offset = this.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);\n101:                 try {\n102:                     this.notifyMessageArriving(topic, queueId, offset);\n103:                 } catch (Throwable e) {\n104:                     log.error(\"check hold request failed. topic={}, queueId={}\", topic, queueId, e);\n105:                 }\n106:             }\n107:         }\n108:     }\n109: \n110:     /**\n111:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚\n112:      *\n113:      * @param topic ä¸»é¢˜\n114:      * @param queueId é˜Ÿåˆ—ç¼–å·\n115:      * @param maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset\n116:      */\n117:     public void notifyMessageArriving(final String topic, final int queueId, final long maxOffset) {\n118:         notifyMessageArriving(topic, queueId, maxOffset, null);\n119:     }\n120: \n121:     /**\n122:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚\n123:      *\n124:      * @param topic ä¸»é¢˜\n125:      * @param queueId é˜Ÿåˆ—ç¼–å·\n126:      * @param maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset\n127:      * @param tagsCode è¿‡æ»¤tagsCode\n128:      */\n129:     public void notifyMessageArriving(final String topic, final int queueId, final long maxOffset, final Long tagsCode) {\n130:         String key = this.buildKey(topic, queueId);\n131:         ManyPullRequest mpr = this.pullRequestTable.get(key);\n132:         if (mpr != null) {\n133:             //\n134:             List<PullRequest> requestList = mpr.cloneListAndClear();\n135:             if (requestList != null) {\n136:                 List<PullRequest> replayList = new ArrayList<>(); // ä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚æ•°ç»„\n137: \n138:                 for (PullRequest request : requestList) {\n139:                     // å¦‚æœ maxOffset è¿‡å°ï¼Œåˆ™é‡æ–°è¯»å–ä¸€æ¬¡ã€‚\n140:                     long newestOffset = maxOffset;\n141:                     if (newestOffset <= request.getPullFromThisOffset()) {\n142:                         newestOffset = this.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);\n143:                     }\n144:                     // æœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚\n145:                     if (newestOffset > request.getPullFromThisOffset()) {\n146:                         if (this.messageFilter.isMessageMatched(request.getSubscriptionData(), tagsCode)) {\n147:                             try {\n148:                                 this.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),\n149:                                     request.getRequestCommand());\n150:                             } catch (Throwable e) {\n151:                                 log.error(\"execute request when wakeup failed.\", e);\n152:                             }\n153:                             continue;\n154:                         }\n155:                     }\n156:                     // è¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚\n157:                     if (System.currentTimeMillis() >= (request.getSuspendTimestamp() + request.getTimeoutMillis())) {\n158:                         try {\n159:                             this.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),\n160:                                 request.getRequestCommand());\n161:                         } catch (Throwable e) {\n162:                             log.error(\"execute request when wakeup failed.\", e);\n163:                         }\n164:                         continue;\n165:                     }\n166:                     // ä¸ç¬¦åˆå†æ¬¡æ‹‰å–çš„è¯·æ±‚ï¼Œå†æ¬¡æ·»åŠ å›å»\n167:                     replayList.add(request);\n168:                 }\n169:                 // æ·»åŠ å›å»\n170:                 if (!replayList.isEmpty()) {\n171:                     mpr.addPullRequest(replayList);\n172:                 }\n173:             }\n174:         }\n175:     }\n176: }\n```\n\n* `PullRequestHoldService` è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚æŒ‚èµ·ç»´æŠ¤çº¿ç¨‹æœåŠ¡ã€‚\n    * å½“æ‹‰å–æ¶ˆæ¯è¯·æ±‚è·å¾—ä¸äº†æ¶ˆæ¯æ—¶ï¼Œåˆ™ä¼šå°†è¯·æ±‚è¿›è¡ŒæŒ‚èµ·ï¼Œæ·»åŠ åˆ°è¯¥æœåŠ¡ã€‚\n    * å½“æœ‰ç¬¦åˆæ¡ä»¶ä¿¡æ¯æ—¶ æˆ– æŒ‚èµ·è¶…æ—¶æ—¶ï¼Œé‡æ–°æ‰§è¡Œè·å–æ¶ˆæ¯é€»è¾‘ã€‚\n* `#suspendPullRequest(...)` è¯´æ˜ ï¼šæ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚åˆ°é›†åˆ( `pullRequestTable` )ã€‚\n* `#run(...)` è¯´æ˜ ï¼š**å®šæ—¶**æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥é‡æ–°æ‹‰å–æ¶ˆæ¯å¹¶è¿›è¡Œé€šçŸ¥ã€‚\n    * ç¬¬ 65 è‡³ 70 è¡Œ ï¼šæ ¹æ®`é•¿è½®è®­`or`çŸ­è½®è®­`è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´ã€‚\n    * ç¬¬ 71 è‡³ 77 è¡Œ ï¼šæ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚\n* `#checkHoldRequest(...)` è¯´æ˜ ï¼šéå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚\n* `#notifyMessageArriving(...)` è¯´æ˜ ï¼šæ£€æŸ¥**æŒ‡å®šé˜Ÿåˆ—**æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚\n    * ç¬¬ 139 è‡³ 143 è¡Œ ï¼šå¦‚æœ `maxOffset` è¿‡å°ï¼Œé‡æ–°è·å–ä¸€æ¬¡æœ€æ–°çš„ã€‚\n    * ç¬¬ 144 è‡³ 155 è¡Œ ï¼šæœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚\n    * ç¬¬ 156 è‡³ 165 è¡Œ ï¼šè¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚\n    * ç¬¬ 148 || 159 è¡Œ ï¼šå”¤é†’è¯·æ±‚ï¼Œå†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚åŸå…ˆæ‹…å¿ƒæ‹‰å–æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´å½±å“æ•´ä¸ªæŒ‚èµ·è¯·æ±‚çš„éå†ï¼Œåé¢æŸ¥çœ‹`#executeRequestWhenWakeup(...)`ï¼Œå®é™…æ˜¯ä¸¢åˆ°çº¿ç¨‹æ± è¿›è¡Œä¸€æ­¥çš„æ¶ˆæ¯æ‹‰å–ï¼Œä¸ä¼šæœ‰æ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚è¯¦ç»†è§£æè§ï¼š[PullMessageProcessor#executeRequestWhenWakeup(...)](pullmessageprocessorexecuterequestwhenwakeup)ã€‚\n    * ç¬¬ 166 è‡³ 172 è¡Œ ï¼šä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚é‡æ–°æ·»åŠ åˆ°é›†åˆ(`pullRequestTable`)ã€‚\n\n## PullMessageProcessor#executeRequestWhenWakeup(...)\n\n```Java\n  1: public void executeRequestWhenWakeup(final Channel channel, final RemotingCommand request) throws RemotingCommandException {\n  2:     Runnable run = new Runnable() {\n  3:         @Override\n  4:         public void run() {\n  5:             try {\n  6:                 // è°ƒç”¨æ‹‰å–è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®ä¸æŒ‚èµ·è¯·æ±‚ã€‚\n  7:                 final RemotingCommand response = PullMessageProcessor.this.processRequest(channel, request, false);\n  8: \n  9:                 if (response != null) {\n 10:                     response.setOpaque(request.getOpaque());\n 11:                     response.markResponseType();\n 12:                     try {\n 13:                         channel.writeAndFlush(response).addListener(new ChannelFutureListener() {\n 14:                             @Override\n 15:                             public void operationComplete(ChannelFuture future) throws Exception {\n 16:                                 if (!future.isSuccess()) {\n 17:                                     LOG.error(\"ProcessRequestWrapper response to {} failed\", future.channel().remoteAddress(), future.cause());\n 18:                                     LOG.error(request.toString());\n 19:                                     LOG.error(response.toString());\n 20:                                 }\n 21:                             }\n 22:                         });\n 23:                     } catch (Throwable e) {\n 24:                         LOG.error(\"ProcessRequestWrapper process request over, but response failed\", e);\n 25:                         LOG.error(request.toString());\n 26:                         LOG.error(response.toString());\n 27:                     }\n 28:                 }\n 29:             } catch (RemotingCommandException e1) {\n 30:                 LOG.error(\"ExecuteRequestWhenWakeup run\", e1);\n 31:             }\n 32:         }\n 33:     };\n 34:     // æäº¤æ‹‰å–è¯·æ±‚åˆ°çº¿ç¨‹æ± \n 35:     this.brokerController.getPullMessageExecutor().submit(new RequestTask(run, channel, request));\n 36: }\n```\n\n* è¯´æ˜ ï¼šæ‰§è¡Œè¯·æ±‚å”¤é†’ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚è¯¥æ–¹æ³•è°ƒç”¨çº¿ç¨‹æ± ï¼Œå› æ­¤ï¼Œä¸ä¼šé˜»å¡ã€‚\n* ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®å³ä½¿è¯·æ±‚ä¸åˆ°æ¶ˆæ¯ï¼Œä¹Ÿä¸æŒ‚èµ·è¯·æ±‚ã€‚å¦‚æœä¸è®¾ç½®ï¼Œè¯·æ±‚å¯èƒ½è¢«æ— é™æŒ‚èµ·ï¼Œè¢« `Broker` æ— é™å¾ªç¯ã€‚\n* ç¬¬ 35 è¡Œ ï¼š**æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚åˆ°çº¿ç¨‹æ± **ã€‚\n\n# 5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£\n\n```bash\nYunai-MacdeMacBook-Pro-2:config yunai$ pwd\n/Users/yunai/store/config\nYunai-MacdeMacBook-Pro-2:config yunai$ ls -ls\ntotal 40\n8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json\n8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json.bak\n8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json\n8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json.bak\n8 -rw-r--r--  1 yunai  staff  1401  4 27 21:51 topics.json\nYunai-MacdeMacBook-Pro-2:config yunai$ cat consumerOffset.json\n{\n\t\"offsetTable\":{\n\t\t\"%RETRY%please_rename_unique_group_name_4@please_rename_unique_group_name_4\":{0:0\n\t\t},\n\t\t\"TopicRead3@please_rename_unique_group_name_4\":{1:5\n\t\t}\n\t}\n}\n```\n\n* `consumerOffset.json` ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶ã€‚\n* `consumerOffset.json.bak` ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶å¤‡ä»½ã€‚\n* æ¯æ¬¡å†™å…¥ `consumerOffset.json`ï¼Œå°†åŸå†…å®¹å¤‡ä»½åˆ° `consumerOffset.json.bak`ã€‚å®ç°è§ï¼š[MixAll#string2File(...)](mixallstring2file)ã€‚\n\n## BrokerController#initialize(...)\n\n```Java\n  1:this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n  2:    @Override\n  3:    public void run() {\n  4:        try {\n  5:            BrokerController.this.consumerOffsetManager.persist();\n  6:        } catch (Throwable e) {\n  7:            log.error(\"schedule persist consumerOffset error.\", e);\n  8:        }\n  9:    }\n 10:}, 1000 * 10, this.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);\n```\n\n* è¯´æ˜ ï¼šæ¯ 5s æ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–é€»è¾‘ã€‚\n\n## ConfigManager\n\n```Java\n  1: public abstract class ConfigManager {\n  2: private static final Logger PLOG = LoggerFactory.getLogger(LoggerName.COMMON_LOGGER_NAME);\n  3: \n  4: /**\n  5:  * ç¼–ç å†…å®¹\n  6:  * @return ç¼–ç åçš„å†…å®¹\n  7:  */\n  8: public abstract String encode();\n  9: \n 10: /**\n 11:  * åŠ è½½æ–‡ä»¶\n 12:  *\n 13:  * @return åŠ è½½æ˜¯å¦æˆåŠŸ\n 14:  */\n 15: public boolean load() {\n 16:     String fileName = null;\n 17:     try {\n 18:         fileName = this.configFilePath();\n 19:         String jsonString = MixAll.file2String(fileName);\n 20:         // å¦‚æœå†…å®¹ä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½å¤‡ä»½æ–‡ä»¶\n 21:         if (null == jsonString || jsonString.length() == 0) {\n 22:             return this.loadBak();\n 23:         } else {\n 24:             this.decode(jsonString);\n 25:             PLOG.info(\"load {} OK\", fileName);\n 26:             return true;\n 27:         }\n 28:     } catch (Exception e) {\n 29:         PLOG.error(\"load \" + fileName + \" Failed, and try to load backup file\", e);\n 30:         return this.loadBak();\n 31:     }\n 32: }\n 33: \n 34: /**\n 35:  * é…ç½®æ–‡ä»¶åœ°å€\n 36:  *\n 37:  * @return é…ç½®æ–‡ä»¶åœ°å€\n 38:  */\n 39: public abstract String configFilePath();\n 40: \n 41: /**\n 42:  * åŠ è½½å¤‡ä»½æ–‡ä»¶\n 43:  *\n 44:  * @return æ˜¯å¦æˆåŠŸ\n 45:  */\n 46: private boolean loadBak() {\n 47:     String fileName = null;\n 48:     try {\n 49:         fileName = this.configFilePath();\n 50:         String jsonString = MixAll.file2String(fileName + \".bak\");\n 51:         if (jsonString != null && jsonString.length() > 0) {\n 52:             this.decode(jsonString);\n 53:             PLOG.info(\"load \" + fileName + \" OK\");\n 54:             return true;\n 55:         }\n 56:     } catch (Exception e) {\n 57:         PLOG.error(\"load \" + fileName + \" Failed\", e);\n 58:         return false;\n 59:     }\n 60: \n 61:     return true;\n 62: }\n 63: \n 64: /**\n 65:  * è§£ç å†…å®¹\n 66:  *\n 67:  * @param jsonString å†…å®¹\n 68:  */\n 69: public abstract void decode(final String jsonString);\n 70: \n 71: /**\n 72:  * æŒä¹…åŒ–\n 73:  */\n 74: public synchronized void persist() {\n 75:     String jsonString = this.encode(true);\n 76:     if (jsonString != null) {\n 77:         String fileName = this.configFilePath();\n 78:         try {\n 79:             MixAll.string2File(jsonString, fileName);\n 80:         } catch (IOException e) {\n 81:             PLOG.error(\"persist file Exception, \" + fileName, e);\n 82:         }\n 83:     }\n 84: }\n 85: \n 86: /**\n 87:  * ç¼–ç å­˜å‚¨å†…å®¹\n 88:  *\n 89:  * @param prettyFormat æ˜¯å¦æ ¼å¼åŒ–\n 90:  * @return å†…å®¹\n 91:  */\n 92: public abstract String encode(final boolean prettyFormat);\n 93: }\n```\n\n### MixAll#string2File(...)\n\n```Java\n  1: /**\n  2:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶\n  3:  * å®‰å…¨å†™\n  4:  * 1. å†™åˆ°.tmpæ–‡ä»¶\n  5:  * 2. å¤‡ä»½å‡†å¤‡å†™å…¥æ–‡ä»¶åˆ°.bakæ–‡ä»¶\n  6:  * 3. åˆ é™¤åŸæ–‡ä»¶ï¼Œå°†.tmpä¿®æ”¹æˆæ–‡ä»¶\n  7:  *\n  8:  * @param str å†…å®¹\n  9:  * @param fileName æ–‡ä»¶å\n 10:  * @throws IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶\n 11:  */\n 12: public static void string2File(final String str, final String fileName) throws IOException {\n 13:     // å†™åˆ° tmpæ–‡ä»¶\n 14:     String tmpFile = fileName + \".tmp\";\n 15:     string2FileNotSafe(str, tmpFile);\n 16:     //\n 17:     String bakFile = fileName + \".bak\";\n 18:     String prevContent = file2String(fileName);\n 19:     if (prevContent != null) {\n 20:         string2FileNotSafe(prevContent, bakFile);\n 21:     }\n 22: \n 23:     File file = new File(fileName);\n 24:     file.delete();\n 25: \n 26:     file = new File(tmpFile);\n 27:     file.renameTo(new File(fileName));\n 28: }\n 29: \n 30: /**\n 31:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶\n 32:  * éå®‰å…¨å†™\n 33:  *\n 34:  * @param str å†…å®¹\n 35:  * @param fileName æ–‡ä»¶å†…å®¹\n 36:  * @throws IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶\n 37:  */\n 38: public static void string2FileNotSafe(final String str, final String fileName) throws IOException {\n 39:     File file = new File(fileName);\n 40:     // åˆ›å»ºä¸Šçº§ç›®å½•\n 41:     File fileParent = file.getParentFile();\n 42:     if (fileParent != null) {\n 43:         fileParent.mkdirs();\n 44:     }\n 45:     // å†™å†…å®¹\n 46:     FileWriter fileWriter = null;\n 47:     try {\n 48:         fileWriter = new FileWriter(file);\n 49:         fileWriter.write(str);\n 50:     } catch (IOException e) {\n 51:         throw e;\n 52:     } finally {\n 53:         if (fileWriter != null) {\n 54:             fileWriter.close();\n 55:         }\n 56:     }\n 57: }\n```\n\n## ConsumerOffsetManager\n\n```Java\n  1: public class ConsumerOffsetManager extends ConfigManager {\n  2:     private static final Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);\n  3:     private static final String TOPIC_GROUP_SEPARATOR = \"@\";\n  4: \n  5:     /**\n  6:      * æ¶ˆè´¹è¿›åº¦é›†åˆ\n  7:      */\n  8:     private ConcurrentHashMap<String/* topic@group */, ConcurrentHashMap<Integer, Long>> offsetTable = new ConcurrentHashMap<>(512);\n  9: \n 10:     private transient BrokerController brokerController;\n 11: \n 12:     public ConsumerOffsetManager() {\n 13:     }\n 14: \n 15:     public ConsumerOffsetManager(BrokerController brokerController) {\n 16:         this.brokerController = brokerController;\n 17:     }\n 18: \n 19:     /**\n 20:      * æäº¤æ¶ˆè´¹è¿›åº¦\n 21:      *\n 22:      * @param clientHost æäº¤clientåœ°å€\n 23:      * @param group æ¶ˆè´¹åˆ†ç»„\n 24:      * @param topic ä¸»é¢˜\n 25:      * @param queueId é˜Ÿåˆ—ç¼–å·\n 26:      * @param offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰\n 27:      */\n 28:     public void commitOffset(final String clientHost, final String group, final String topic, final int queueId, final long offset) {\n 29:         // topic@group\n 30:         String key = topic + TOPIC_GROUP_SEPARATOR + group;\n 31:         this.commitOffset(clientHost, key, queueId, offset);\n 32:     }\n 33: \n 34:     /**\n 35:      * æäº¤æ¶ˆè´¹è¿›åº¦\n 36:      *\n 37:      * @param clientHost æäº¤clientåœ°å€\n 38:      * @param key ä¸»é¢˜@æ¶ˆè´¹åˆ†ç»„\n 39:      * @param queueId é˜Ÿåˆ—ç¼–å·\n 40:      * @param offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰\n 41:      */\n 42:     private void commitOffset(final String clientHost, final String key, final int queueId, final long offset) {\n 43:         ConcurrentHashMap<Integer, Long> map = this.offsetTable.get(key);\n 44:         if (null == map) {\n 45:             map = new ConcurrentHashMap<>(32);\n 46:             map.put(queueId, offset);\n 47:             this.offsetTable.put(key, map);\n 48:         } else {\n 49:             Long storeOffset = map.put(queueId, offset);\n 50:             if (storeOffset != null && offset < storeOffset) {\n 51:                 log.warn(\"[NOTIFYME]update consumer offset less than store. clientHost={}, key={}, queueId={}, requestOffset={}, storeOffset={}\", clientHost, key, queueId, offset, storeOffset);\n 52:             }\n 53:         }\n 54:     }\n 55: \n 56:     public String encode() {\n 57:         return this.encode(false);\n 58:     }\n 59: \n 60:     @Override\n 61:     public String configFilePath() {\n 62:         return BrokerPathConfigHelper.getConsumerOffsetPath(this.brokerController.getMessageStoreConfig().getStorePathRootDir());\n 63:     }\n 64: \n 65:     /**\n 66:      * è§£ç å†…å®¹\n 67:      * æ ¼å¼:JSON\n 68:      *\n 69:      * @param jsonString å†…å®¹\n 70:      */\n 71:     @Override\n 72:     public void decode(String jsonString) {\n 73:         if (jsonString != null) {\n 74:             ConsumerOffsetManager obj = RemotingSerializable.fromJson(jsonString, ConsumerOffsetManager.class);\n 75:             if (obj != null) {\n 76:                 this.offsetTable = obj.offsetTable;\n 77:             }\n 78:         }\n 79:     }\n 80: \n 81:     /**\n 82:      * ç¼–ç å†…å®¹\n 83:      * æ ¼å¼ä¸ºJSON\n 84:      *\n 85:      * @param prettyFormat æ˜¯å¦æ ¼å¼åŒ–\n 86:      * @return ç¼–ç åçš„å†…å®¹\n 87:      */\n 88:     public String encode(final boolean prettyFormat) {\n 89:         return RemotingSerializable.toJson(this, prettyFormat);\n 90:     }\n 91: \n 92: }\n```\n\n* è¯´æ˜ ï¼šæ¶ˆè´¹è¿›åº¦ç®¡ç†å™¨ã€‚\n\n# 6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£\n\nå¤§éƒ¨åˆ†é€»è¾‘å’Œ [`Broker` æä¾›[æ¥æ”¶æ¶ˆæ¯]æ¥å£](http://www.yunai.me/RocketMQ/message-send-and-receive/#3ã€Broker-æ¥æ”¶æ¶ˆæ¯) ç±»ä¼¼ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ç›¸å…³å†…å®¹ã€‚\n\n## SendMessageProcessor#consumerSendMsgBack(...)\n\n```Java\n  1: private RemotingCommand consumerSendMsgBack(final ChannelHandlerContext ctx, final RemotingCommand request)\n  2:     throws RemotingCommandException {\n  3: \n  4:     // åˆå§‹åŒ–å“åº”\n  5:     final RemotingCommand response = RemotingCommand.createResponseCommand(null);\n  6:     final ConsumerSendMsgBackRequestHeader requestHeader =\n  7:         (ConsumerSendMsgBackRequestHeader) request.decodeCommandCustomHeader(ConsumerSendMsgBackRequestHeader.class);\n  8: \n  9:     // hookï¼ˆç‹¬æœ‰ï¼‰\n 10:     if (this.hasConsumeMessageHook() && !UtilAll.isBlank(requestHeader.getOriginMsgId())) {\n 11: \n 12:         ConsumeMessageContext context = new ConsumeMessageContext();\n 13:         context.setConsumerGroup(requestHeader.getGroup());\n 14:         context.setTopic(requestHeader.getOriginTopic());\n 15:         context.setCommercialRcvStats(BrokerStatsManager.StatsType.SEND_BACK);\n 16:         context.setCommercialRcvTimes(1);\n 17:         context.setCommercialOwner(request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER));\n 18: \n 19:         this.executeConsumeMessageHookAfter(context);\n 20:     }\n 21: \n 22:     // åˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ï¼ˆç‹¬æœ‰ï¼‰\n 23:     SubscriptionGroupConfig subscriptionGroupConfig =\n 24:         this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getGroup());\n 25:     if (null == subscriptionGroupConfig) {\n 26:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);\n 27:         response.setRemark(\"subscription group not exist, \" + requestHeader.getGroup() + \" \"\n 28:             + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));\n 29:         return response;\n 30:     }\n 31: \n 32:     // æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™\n 33:     if (!PermName.isWriteable(this.brokerController.getBrokerConfig().getBrokerPermission())) {\n 34:         response.setCode(ResponseCode.NO_PERMISSION);\n 35:         response.setRemark(\"the broker[\" + this.brokerController.getBrokerConfig().getBrokerIP1() + \"] sending message is forbidden\");\n 36:         return response;\n 37:     }\n 38: \n 39:     // æ£€æŸ¥ é‡è¯•é˜Ÿåˆ—æ•° æ˜¯å¦å¤§äº0ï¼ˆç‹¬æœ‰ï¼‰\n 40:     if (subscriptionGroupConfig.getRetryQueueNums() <= 0) {\n 41:         response.setCode(ResponseCode.SUCCESS);\n 42:         response.setRemark(null);\n 43:         return response;\n 44:     }\n 45: \n 46:     // è®¡ç®—retry Topic\n 47:     String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());\n 48: \n 49:     // è®¡ç®—é˜Ÿåˆ—ç¼–å·ï¼ˆç‹¬æœ‰ï¼‰\n 50:     int queueIdInt = Math.abs(this.random.nextInt() % 99999999) % subscriptionGroupConfig.getRetryQueueNums();\n 51: \n 52:     // è®¡ç®—sysFlagï¼ˆç‹¬æœ‰ï¼‰\n 53:     int topicSysFlag = 0;\n 54:     if (requestHeader.isUnitMode()) {\n 55:         topicSysFlag = TopicSysFlag.buildSysFlag(false, true);\n 56:     }\n 57: \n 58:     // è·å–topicConfigã€‚å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è¿›è¡Œåˆ›å»º\n 59:     TopicConfig topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(//\n 60:         newTopic, //\n 61:         subscriptionGroupConfig.getRetryQueueNums(), //\n 62:         PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);\n 63:     if (null == topicConfig) { // æ²¡æœ‰é…ç½®\n 64:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 65:         response.setRemark(\"topic[\" + newTopic + \"] not exist\");\n 66:         return response;\n 67:     }\n 68:     if (!PermName.isWriteable(topicConfig.getPerm())) { // ä¸å…è®¸å†™å…¥\n 69:         response.setCode(ResponseCode.NO_PERMISSION);\n 70:         response.setRemark(String.format(\"the topic[%s] sending message is forbidden\", newTopic));\n 71:         return response;\n 72:     }\n 73: \n 74:     // æŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚ï¼ˆç‹¬æœ‰ï¼‰\n 75:     MessageExt msgExt = this.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());\n 76:     if (null == msgExt) {\n 77:         response.setCode(ResponseCode.SYSTEM_ERROR);\n 78:         response.setRemark(\"look message by offset failed, \" + requestHeader.getOffset());\n 79:         return response;\n 80:     }\n 81: \n 82:     // è®¾ç½®retryTopicåˆ°æ‹“å±•å±æ€§ï¼ˆç‹¬æœ‰ï¼‰\n 83:     final String retryTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);\n 84:     if (null == retryTopic) {\n 85:         MessageAccessor.putProperty(msgExt, MessageConst.PROPERTY_RETRY_TOPIC, msgExt.getTopic());\n 86:     }\n 87: \n 88:     // è®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆï¼ˆç‹¬æœ‰ï¼‰ TODO ç–‘é—®ï¼šå¦‚æœè®¾ç½®æˆä¸ç­‰å¾…å­˜å‚¨ï¼Œbrokerè®¾ç½®æˆåŒæ­¥è½ç›˜ï¼Œå²‚ä¸æ˜¯ä¸èƒ½æ‰¹é‡æäº¤äº†ï¼Ÿ\n 89:     msgExt.setWaitStoreMsgOK(false);\n 90: \n 91:     // å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚\n 92:     int delayLevel = requestHeader.getDelayLevel();\n 93:     int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();\n 94:     if (request.getVersion() >= MQVersion.Version.V3_4_9.ordinal()) {\n 95:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();\n 96:     }\n 97:     if (msgExt.getReconsumeTimes() >= maxReconsumeTimes//\n 98:         || delayLevel < 0) { // å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)\n 99:         newTopic = MixAll.getDLQTopic(requestHeader.getGroup());\n100:         queueIdInt = Math.abs(this.random.nextInt() % 99999999) % DLQ_NUMS_PER_GROUP;\n101: \n102:         topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, //\n103:             DLQ_NUMS_PER_GROUP, //\n104:             PermName.PERM_WRITE, 0\n105:         );\n106:         if (null == topicConfig) {\n107:             response.setCode(ResponseCode.SYSTEM_ERROR);\n108:             response.setRemark(\"topic[\" + newTopic + \"] not exist\");\n109:             return response;\n110:         }\n111:     } else {\n112:         if (0 == delayLevel) {\n113:             delayLevel = 3 + msgExt.getReconsumeTimes();\n114:         }\n115:         msgExt.setDelayTimeLevel(delayLevel);\n116:     }\n117: \n118:     // åˆ›å»ºMessageExtBrokerInner\n119:     MessageExtBrokerInner msgInner = new MessageExtBrokerInner();\n120:     msgInner.setTopic(newTopic);\n121:     msgInner.setBody(msgExt.getBody());\n122:     msgInner.setFlag(msgExt.getFlag());\n123:     MessageAccessor.setProperties(msgInner, msgExt.getProperties());\n124:     msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));\n125:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(null, msgExt.getTags()));\n126:     msgInner.setQueueId(queueIdInt);\n127:     msgInner.setSysFlag(msgExt.getSysFlag());\n128:     msgInner.setBornTimestamp(msgExt.getBornTimestamp());\n129:     msgInner.setBornHost(msgExt.getBornHost());\n130:     msgInner.setStoreHost(this.getStoreHost());\n131:     msgInner.setReconsumeTimes(msgExt.getReconsumeTimes() + 1);\n132: \n133:     // è®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å­—æ®µï¼ˆç‹¬æœ‰ï¼‰\n134:     String originMsgId = MessageAccessor.getOriginMessageId(msgExt);\n135:     MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);\n136: \n137:     // æ·»åŠ æ¶ˆæ¯\n138:     PutMessageResult putMessageResult = this.brokerController.getMessageStore().putMessage(msgInner);\n139:     if (putMessageResult != null) {\n140:         switch (putMessageResult.getPutMessageStatus()) {\n141:             case PUT_OK:\n142:                 String backTopic = msgExt.getTopic();\n143:                 String correctTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);\n144:                 if (correctTopic != null) {\n145:                     backTopic = correctTopic;\n146:                 }\n147: \n148:                 this.brokerController.getBrokerStatsManager().incSendBackNums(requestHeader.getGroup(), backTopic);\n149: \n150:                 response.setCode(ResponseCode.SUCCESS);\n151:                 response.setRemark(null);\n152: \n153:                 return response;\n154:             default:\n155:                 break;\n156:         }\n157: \n158:         response.setCode(ResponseCode.SYSTEM_ERROR);\n159:         response.setRemark(putMessageResult.getPutMessageStatus().name());\n160:         return response;\n161:     }\n162: \n163:     response.setCode(ResponseCode.SYSTEM_ERROR);\n164:     response.setRemark(\"putMessageResult is null\");\n165:     return response;\n166: }\n```\n\n* è¯´æ˜ ï¼šå½“ `Consumer` æ¶ˆè´¹æŸæ¡æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ¥å£å‘å›æ¶ˆæ¯ã€‚`Broker` ä¼šå­˜å‚¨å‘å›çš„æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œä¸‹æ¬¡ `Consumer` æ‹‰å–è¯¥æ¶ˆæ¯ï¼Œèƒ½å¤Ÿä» `CommitLog` å’Œ `ConsumeQueue` é¡ºåºè¯»å–ã€‚\n* [x] å› ä¸ºå¤§å¤šæ•°é€»è¾‘å’Œ **`Broker` æ¥æ”¶æ™®é€šæ¶ˆæ¯** å¾ˆç›¸ä¼¼ï¼Œæ—¶å€™ `TODO` æ ‡è®°æˆç‹¬æœ‰çš„é€»è¾‘ã€‚\n* ç¬¬ 4 è‡³ 7 è¡Œ ï¼šåˆå§‹åŒ–å“åº”ã€‚\n* [x] ç¬¬ 9 è‡³ 20 è¡Œ ï¼šHooké€»è¾‘ã€‚\n* [x] ç¬¬22 è‡³ 30 è¡Œ ï¼šåˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ã€‚\n* ç¬¬ 32 è‡³ 37 è¡Œ ï¼šæ£€æŸ¥ `Broker` æ˜¯å¦æœ‰å†™å…¥æƒé™ã€‚\n* [x] ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæ£€æŸ¥é‡è¯•é˜Ÿåˆ—æ•°æ˜¯å¦å¤§äº0ã€‚\n* ç¬¬ 47 è¡Œ ï¼šè®¡ç®— retry topicã€‚\n* [x] ç¬¬ 50 è¡Œ ï¼šéšæœºåˆ†é…é˜Ÿåˆ—ç¼–å·ï¼Œä¾èµ– `retryQueueNums`ã€‚\n* [x] ç¬¬ 52 è‡³ 56 è¡Œ ï¼šè®¡ç®— `sysFlag`ã€‚\n* ç¬¬ 58 è‡³ 72 è¡Œ ï¼šè·å– `TopicConfig`ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚\n* [x] ç¬¬ 74 è‡³ 80 è¡Œ ï¼šæŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚\n* [x] ç¬¬ 82 è‡³ 86 è¡Œ ï¼šè®¾ç½® `retryTopic` åˆ°æ¶ˆæ¯æ‹“å±•å±æ€§ã€‚\n* [x] ç¬¬ 89 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆã€‚\n    * å½“ `Broker` åˆ·ç›˜æ–¹å¼ä¸ºåŒæ­¥ï¼Œä¼šå¯¼è‡´åŒæ­¥è½ç›˜ä¸èƒ½æ‰¹é‡æäº¤ï¼Œè¿™æ ·ä¼šä¸ä¼šå­˜åœ¨é—®é¢˜ï¼Ÿæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚ğŸ˜ˆã€‚\n* [x] ç¬¬ 91 è‡³ 116 è¡Œ ï¼šå¤„ç† `delayLevel` ã€‚\n* ç¬¬ 118 è‡³ 131 è¡Œ ï¼šåˆ›å»º `MessageExtBrokerInner` ã€‚\n* [x] ç¬¬ 133 è‡³ 135 è¡Œ ï¼šè®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å±æ€§ã€‚\n* ç¬¬ 137 è‡³ 161 è¡Œ ï¼šæ·»åŠ æ¶ˆæ¯ã€‚\n\n# 7ã€ç»“å°¾\n\næ„Ÿè°¢åŒå­¦ä»¬å¯¹æœ¬æ–‡çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€‚\n\nğŸ˜ˆå¦‚æœè§£æå­˜åœ¨é—®é¢˜æˆ–è€…è¡¨è¾¾è¯¯è§£çš„ï¼Œè¡¨ç¤ºæŠ±æ­‰ã€‚å¦‚æœæ–¹ä¾¿çš„è¯ï¼Œå¯ä»¥åŠ ä¸‹ **QQï¼š7685413**ã€‚è®©æˆ‘ä»¬æ¥ä¸€åœº 1 ï¼š1 äº¤æµï¼ˆæåŸºï¼‰ã€‚\n\nå†æ¬¡è¡¨ç¤ºååˆ†æ„Ÿè°¢ã€‚\n\n\n","slug":"RocketMQ/message-pull-and-consume-first","published":1,"updated":"2017-06-08T13:09:59.000Z","_id":"cj3ndswzt001cak5df0zlrv6s","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>åŸæ–‡åœ°å€ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/\">http://www.yunai.me/RocketMQ/message-pull-and-consume-first/</a><br>\n<code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/incubator-rocketmq</a><br>\n**ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **</p>\n</blockquote>\n<p><img src=\"http://www.yunai.me/images/common/wechat_mp.jpeg\" alt=\"wechat_mp\"></p>\n<hr>\n<ul>\n<li><a href=\"#\">1ã€æ¦‚è¿°</a></li>\n<li><a href=\"#\">2ã€ConsumeQueue ç»“æ„</a></li>\n<li><a href=\"#\">3ã€ConsumeQueue å­˜å‚¨</a>\n<ul>\n<li><a href=\"#\">ReputMessageService</a>\n<ul>\n<li><a href=\"#\">DefaultMessageStore#doDispatch(...)</a></li>\n<li><a href=\"#\">ConsumeQueue#putMessagePositionInfoWrapper(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">FlushConsumeQueueService</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</a>\n<ul>\n<li><a href=\"#\">PullMessageRequestHeader</a></li>\n<li><a href=\"#\">PullMessageProcessor#processRequest(...)</a></li>\n<li><a href=\"#\">MessageStore#getMessage(...)</a></li>\n<li><a href=\"#\">DefaultMessageFilter#isMessageMatched(...)</a></li>\n<li><a href=\"#\">PullRequestHoldService</a></li>\n<li><a href=\"#\">PullMessageProcessor#executeRequestWhenWakeup(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</a>\n<ul>\n<li><a href=\"#\">BrokerController#initialize(...)</a></li>\n<li><a href=\"#\">ConfigManager</a>\n<ul>\n<li><a href=\"#\">MixAll#string2File(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">ConsumerOffsetManager</a></li>\n</ul>\n</li>\n<li><a href=\"#\">6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</a>\n<ul>\n<li><a href=\"#\">SendMessageProcessor#consumerSendMsgBack(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">7ã€ç»“å°¾</a></li>\n</ul>\n<h1>1ã€æ¦‚è¿°</h1>\n<p>æœ¬ç« ä¸»è¦è§£æ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚\nå› ä¸ºç¯‡å¹…è¾ƒé•¿ï¼Œåˆ†æˆä¸Šä¸‹ä¸¤ç¯‡ï¼š</p>\n<ol>\n<li>ä¸Šç¯‡ï¼š<code>Broker</code> ç›¸å…³æºç ã€‚</li>\n<li>ä¸‹ç¯‡ï¼š<code>Consumer</code> ç›¸å…³æºç ã€‚</li>\n</ol>\n<p><em>æœ¬æ–‡å³æ˜¯ä¸Šç¯‡ã€‚</em></p>\n<hr>\n<p>okï¼Œå…ˆçœ‹ç¬¬ä¸€å¼ å…³äºæ¶ˆè´¹é€»è¾‘çš„å›¾ï¼š</p>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/13.png\" alt=\"æ¶ˆè´¹é€»è¾‘å›¾\"></p>\n</blockquote>\n<p>å†çœ‹æ¶ˆè´¹é€»è¾‘ç²¾ç®€çš„é¡ºåºå›¾ï¼ˆå®é™…æƒ…å†µä¼šç•¥æœ‰å·®åˆ«ï¼‰ï¼š</p>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/04.png\" alt=\"Consumer&amp;amp;Brokeræ¶ˆè´¹ç²¾ç®€å›¾.png\"></p>\n</blockquote>\n<h1>2ã€ConsumeQueue ç»“æ„</h1>\n<p><code>ConsumeQueue</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å…³ç³»å¦‚ä¸‹ï¼š</p>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/03.png\" alt=\"ConsumeQueueã€MappedFileQueueã€MappedFileçš„å…³ç³»\">\n<code>ConsumeQueue</code> : <code>MappedFileQueue</code> : <code>MappedFile</code> = 1 : 1 : Nã€‚</p>\n</blockquote>\n<p>ååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š</p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><div class=\"line\">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class=\"built_in\">pwd</span></div><div class=\"line\">/Users/yunai/store/consumequeue</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class=\"built_in\">cd</span> TopicRead3/</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ ls -ls</div><div class=\"line\">total 0</div><div class=\"line\">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:52 0</div><div class=\"line\">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 1</div><div class=\"line\">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 2</div><div class=\"line\">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 3</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ <span class=\"built_in\">cd</span> 0/</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:0 yunai$ ls -ls</div><div class=\"line\">total 11720</div><div class=\"line\">11720 -rw-r--r--  1 yunai  staff  6000000  4 27 21:55 00000000000000000000</div></pre></td></tr></table></figure></p>\n<hr>\n<p><code>ConsumeQueue</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>\n<ul>\n<li><code>MappedFile</code> ï¼š00000000000000000000ç­‰æ–‡ä»¶ã€‚</li>\n<li><code>MappedFileQueue</code> ï¼š<code>MappedFile</code> æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ <code>MappedFile</code> è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚\n<ul>\n<li>æ¯ä¸ª <code>MappedFile</code> ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚</li>\n<li>æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ <code>ConsumeQueue</code> é‡Œé»˜è®¤ä¸º 6000000Bã€‚</li>\n</ul>\n</li>\n<li><code>ConsumeQueue</code> ï¼šé’ˆå¯¹ <code>MappedFileQueue</code> çš„å°è£…ä½¿ç”¨ã€‚\n<ul>\n<li><code>Store : ConsumeQueue = ConcurrentHashMap&lt;String/* topic */, ConcurrentHashMap&lt;Integer/* queueId */, ConsumeQueue&gt;&gt;</code>ã€‚</li>\n</ul>\n</li>\n</ul>\n<p><code>ConsumeQueue</code> å­˜å‚¨åœ¨ <code>MappedFile</code> çš„å†…å®¹<strong>å¿…é¡»</strong>å¤§å°æ˜¯ 20B( <code>ConsumeQueue.CQ_STORE_UNIT_SIZE</code> )ï¼Œæœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š</p>\n<ol>\n<li><code>MESSAGE_POSITION_INFO</code> ï¼šæ¶ˆæ¯ä½ç½®ä¿¡æ¯ã€‚</li>\n<li><code>BLANK</code> : æ–‡ä»¶å‰ç½®ç©ºç™½å ä½ã€‚å½“å†å² <code>Message</code> è¢«åˆ é™¤æ—¶ï¼Œéœ€è¦ç”¨ <code>BLANK</code>å ä½è¢«åˆ é™¤çš„æ¶ˆæ¯ã€‚</li>\n</ol>\n<p><code>MESSAGE_POSITION_INFO</code> åœ¨ <code>ConsumeQueue</code> å­˜å‚¨ç»“æ„ï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">offset</td>\n<td style=\"text-align:left\">æ¶ˆæ¯ <code>CommitLog</code> å­˜å‚¨ä½ç½®</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">size</td>\n<td style=\"text-align:left\">æ¶ˆæ¯é•¿åº¦</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">tagsCode</td>\n<td style=\"text-align:left\">æ¶ˆæ¯tagsCode</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n</tbody>\n</table>\n<p><code>BLANK</code> åœ¨ <code>ConsumeQueue</code> å­˜å‚¨ç»“æ„ï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">Integer.MAX_VALUE</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n</tbody>\n</table>\n<h1>3ã€ConsumeQueue å­˜å‚¨</h1>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/02.png\" alt=\"CommitLogé‡æ”¾ConsumeQueueå›¾\"></p>\n<p>ä¸»è¦æœ‰ä¸¤ä¸ªç»„ä»¶ï¼š</p>\n<ul>\n<li><code>ReputMessageService</code> ï¼šwrite ConsumeQueueã€‚</li>\n<li><code>FlushConsumeQueueService</code> ï¼šflush ConsumeQueueã€‚</li>\n</ul>\n<h2>ReputMessageService</h2>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/12.png\" alt=\"ReputMessageServiceé¡ºåºå›¾\"></p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReputMessageService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>: </div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  4:      * å¼€å§‹é‡æ”¾æ¶ˆæ¯çš„CommitLogç‰©ç†ä½ç½®</div><div class=\"line\">  5:      */</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> reputFromOffset = <span class=\"number\">0</span>;</div><div class=\"line\">  <span class=\"number\">7</span>: </div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getReputFromOffset</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">9</span>:         <span class=\"keyword\">return</span> reputFromOffset;</div><div class=\"line\"> <span class=\"number\">10</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">11</span>: </div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setReputFromOffset</span><span class=\"params\">(<span class=\"keyword\">long</span> reputFromOffset)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">13</span>:         <span class=\"keyword\">this</span>.reputFromOffset = reputFromOffset;</div><div class=\"line\"> <span class=\"number\">14</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">15</span>: </div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">shutdown</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">50</span> &amp;&amp; <span class=\"keyword\">this</span>.isCommitLogAvailable(); i++) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">20</span>:                 Thread.sleep(<span class=\"number\">100</span>);</div><div class=\"line\"> <span class=\"number\">21</span>:             &#125; <span class=\"keyword\">catch</span> (InterruptedException ignored) &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">23</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isCommitLogAvailable()) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:             log.warn(<span class=\"string\">\"shutdown ReputMessageService, but commitlog have not finish to be dispatched, CL: &#123;&#125; reputFromOffset: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">27</span>:                 DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.getMaxOffset(), <span class=\"keyword\">this</span>.reputFromOffset);</div><div class=\"line\"> <span class=\"number\">28</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:         <span class=\"keyword\">super</span>.shutdown();</div><div class=\"line\"> <span class=\"number\">31</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">32</span>: </div><div class=\"line\"> <span class=\"number\">33</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 34:      * å‰©ä½™éœ€è¦é‡æ”¾æ¶ˆæ¯å­—èŠ‚æ•°</div><div class=\"line\"> 35:      *</div><div class=\"line\"> 36:      * <span class=\"doctag\">@return</span> å­—èŠ‚æ•°</div><div class=\"line\"> 37:      */</div><div class=\"line\"> <span class=\"number\">38</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">behind</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">39</span>:         <span class=\"keyword\">return</span> DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.getMaxOffset() - <span class=\"keyword\">this</span>.reputFromOffset;</div><div class=\"line\"> <span class=\"number\">40</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 43:      * æ˜¯å¦commitLogéœ€è¦é‡æ”¾æ¶ˆæ¯</div><div class=\"line\"> 44:      *</div><div class=\"line\"> 45:      * <span class=\"doctag\">@return</span> æ˜¯å¦</div><div class=\"line\"> 46:      */</div><div class=\"line\"> <span class=\"number\">47</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isCommitLogAvailable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.reputFromOffset &lt; DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.getMaxOffset();</div><div class=\"line\"> <span class=\"number\">49</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">50</span>: </div><div class=\"line\"> <span class=\"number\">51</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doReput</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">52</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">boolean</span> doNext = <span class=\"keyword\">true</span>; <span class=\"keyword\">this</span>.isCommitLogAvailable() &amp;&amp; doNext; ) &#123;</div><div class=\"line\"> <span class=\"number\">53</span>: </div><div class=\"line\"> <span class=\"number\">54</span>:             <span class=\"comment\">// TODO ç–‘é—®ï¼šè¿™ä¸ªæ˜¯å•¥</span></div><div class=\"line\"> <span class=\"number\">55</span>:             <span class=\"keyword\">if</span> (DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().isDuplicationEnable() <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">56</span>:                 &amp;&amp; <span class=\"keyword\">this</span>.reputFromOffset &gt;= DefaultMessageStore.<span class=\"keyword\">this</span>.getConfirmOffset()) &#123;</div><div class=\"line\"> <span class=\"number\">57</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">58</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">59</span>: </div><div class=\"line\"> <span class=\"number\">60</span>:             <span class=\"comment\">// è·å–ä»reputFromOffsetå¼€å§‹çš„commitLogå¯¹åº”çš„MappeFileå¯¹åº”çš„MappedByteBuffer</span></div><div class=\"line\"> <span class=\"number\">61</span>:             SelectMappedBufferResult result = DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.getData(reputFromOffset);</div><div class=\"line\"> <span class=\"number\">62</span>:             <span class=\"keyword\">if</span> (result != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">64</span>:                     <span class=\"keyword\">this</span>.reputFromOffset = result.getStartOffset();</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:                     <span class=\"comment\">// éå†MappedByteBuffer</span></div><div class=\"line\"> <span class=\"number\">67</span>:                     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> readSize = <span class=\"number\">0</span>; readSize &lt; result.getSize() &amp;&amp; doNext; ) &#123;</div><div class=\"line\"> <span class=\"number\">68</span>:                         <span class=\"comment\">// ç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">69</span>:                         DispatchRequest dispatchRequest = DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">70</span>:                         <span class=\"keyword\">int</span> size = dispatchRequest.getMsgSize(); <span class=\"comment\">// æ¶ˆæ¯é•¿åº¦</span></div><div class=\"line\"> <span class=\"number\">71</span>:                         <span class=\"comment\">// æ ¹æ®è¯·æ±‚çš„ç»“æœå¤„ç†</span></div><div class=\"line\"> <span class=\"number\">72</span>:                         <span class=\"keyword\">if</span> (dispatchRequest.isSuccess()) &#123; <span class=\"comment\">// è¯»å–æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">73</span>:                             <span class=\"keyword\">if</span> (size &gt; <span class=\"number\">0</span>) &#123; <span class=\"comment\">// è¯»å–Message</span></div><div class=\"line\"> <span class=\"number\">74</span>:                                 DefaultMessageStore.<span class=\"keyword\">this</span>.doDispatch(dispatchRequest);</div><div class=\"line\"> <span class=\"number\">75</span>:                                 <span class=\"comment\">// é€šçŸ¥æœ‰æ–°æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">76</span>:                                 <span class=\"keyword\">if</span> (BrokerRole.SLAVE != DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getBrokerRole()</div><div class=\"line\"> <span class=\"number\">77</span>:                                     &amp;&amp; DefaultMessageStore.<span class=\"keyword\">this</span>.brokerConfig.isLongPollingEnable()) &#123;</div><div class=\"line\"> <span class=\"number\">78</span>:                                     DefaultMessageStore.<span class=\"keyword\">this</span>.messageArrivingListener.arriving(dispatchRequest.getTopic(),</div><div class=\"line\"> <span class=\"number\">79</span>:                                         dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + <span class=\"number\">1</span>,</div><div class=\"line\"> <span class=\"number\">80</span>:                                         dispatchRequest.getTagsCode());</div><div class=\"line\"> <span class=\"number\">81</span>:                                 &#125;</div><div class=\"line\"> <span class=\"number\">82</span>:                                 <span class=\"comment\">// FIXED BUG By shijia</span></div><div class=\"line\"> <span class=\"number\">83</span>:                                 <span class=\"keyword\">this</span>.reputFromOffset += size;</div><div class=\"line\"> <span class=\"number\">84</span>:                                 readSize += size;</div><div class=\"line\"> <span class=\"number\">85</span>:                                 <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"> <span class=\"number\">86</span>:                                 <span class=\"keyword\">if</span> (DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE) &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:                                     DefaultMessageStore.<span class=\"keyword\">this</span>.storeStatsService</div><div class=\"line\"> <span class=\"number\">88</span>:                                         .getSinglePutMessageTopicTimesTotal(dispatchRequest.getTopic()).incrementAndGet();</div><div class=\"line\"> <span class=\"number\">89</span>:                                     DefaultMessageStore.<span class=\"keyword\">this</span>.storeStatsService</div><div class=\"line\"> <span class=\"number\">90</span>:                                         .getSinglePutMessageTopicSizeTotal(dispatchRequest.getTopic())</div><div class=\"line\"> <span class=\"number\">91</span>:                                         .addAndGet(dispatchRequest.getMsgSize());</div><div class=\"line\"> <span class=\"number\">92</span>:                                 &#125;</div><div class=\"line\"> <span class=\"number\">93</span>:                             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (size == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// è¯»å–åˆ°MappedFileæ–‡ä»¶å°¾</span></div><div class=\"line\"> <span class=\"number\">94</span>:                                 <span class=\"keyword\">this</span>.reputFromOffset = DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.rollNextFile(<span class=\"keyword\">this</span>.reputFromOffset);</div><div class=\"line\"> <span class=\"number\">95</span>:                                 readSize = result.getSize();</div><div class=\"line\"> <span class=\"number\">96</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">97</span>:                         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!dispatchRequest.isSuccess()) &#123; <span class=\"comment\">// è¯»å–å¤±è´¥</span></div><div class=\"line\"> <span class=\"number\">98</span>:                             <span class=\"keyword\">if</span> (size &gt; <span class=\"number\">0</span>) &#123; <span class=\"comment\">// è¯»å–åˆ°Messageå´ä¸æ˜¯Message</span></div><div class=\"line\"> <span class=\"number\">99</span>:                                 log.error(<span class=\"string\">\"[BUG]read total count not equals msg total size. reputFromOffset=&#123;&#125;\"</span>, reputFromOffset);</div><div class=\"line\"><span class=\"number\">100</span>:                                 <span class=\"keyword\">this</span>.reputFromOffset += size;</div><div class=\"line\"><span class=\"number\">101</span>:                             &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// è¯»å–åˆ°Blankå´ä¸æ˜¯Blank</span></div><div class=\"line\"><span class=\"number\">102</span>:                                 doNext = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">103</span>:                                 <span class=\"keyword\">if</span> (DefaultMessageStore.<span class=\"keyword\">this</span>.brokerConfig.getBrokerId() == MixAll.MASTER_ID) &#123;</div><div class=\"line\"><span class=\"number\">104</span>:                                     log.error(<span class=\"string\">\"[BUG]the master dispatch message to consume queue error, COMMITLOG OFFSET: &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">105</span>:                                         <span class=\"keyword\">this</span>.reputFromOffset);</div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:                                     <span class=\"keyword\">this</span>.reputFromOffset += result.getSize() - readSize;</div><div class=\"line\"><span class=\"number\">108</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">109</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">110</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">111</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">112</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">113</span>:                     result.release();</div><div class=\"line\"><span class=\"number\">114</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">115</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">116</span>:                 doNext = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">117</span>:             &#125;</div><div class=\"line\"><span class=\"number\">118</span>:         &#125;</div><div class=\"line\"><span class=\"number\">119</span>:     &#125;</div><div class=\"line\"><span class=\"number\">120</span>: </div><div class=\"line\"><span class=\"number\">121</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">122</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">123</span>:         DefaultMessageStore.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">124</span>: </div><div class=\"line\"><span class=\"number\">125</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">126</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">127</span>:                 Thread.sleep(<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">128</span>:                 <span class=\"keyword\">this</span>.doReput();</div><div class=\"line\"><span class=\"number\">129</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">130</span>:                 DefaultMessageStore.log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">131</span>:             &#125;</div><div class=\"line\"><span class=\"number\">132</span>:         &#125;</div><div class=\"line\"><span class=\"number\">133</span>: </div><div class=\"line\"><span class=\"number\">134</span>:         DefaultMessageStore.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">135</span>:     &#125;</div><div class=\"line\"><span class=\"number\">136</span>: </div><div class=\"line\"><span class=\"number\">137</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">138</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">139</span>:         <span class=\"keyword\">return</span> ReputMessageService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">140</span>:     &#125;</div><div class=\"line\"><span class=\"number\">141</span>: </div><div class=\"line\"><span class=\"number\">142</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šé‡æ”¾æ¶ˆæ¯çº¿ç¨‹æœåŠ¡ã€‚\n<ul>\n<li>è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° æ¶ˆè´¹é˜Ÿåˆ—(ConsumeQueue)</li>\n<li>è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ç´¢å¼• åˆ° ç´¢å¼•æ–‡ä»¶(IndexFile)</li>\n</ul>\n</li>\n<li><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/11.png\" alt=\"ReputMessageServiceç”¨ä¾‹å›¾\">\n<ul>\n<li>ç¬¬ 61 è¡Œ ï¼šè·å– <code>reputFromOffset</code> å¼€å§‹çš„ <code>CommitLog</code> å¯¹åº”çš„ <code>MappedFile</code> å¯¹åº”çš„ <code>MappedByteBuffer</code>ã€‚</li>\n<li>ç¬¬ 67 è¡Œ ï¼šéå† <code>MappedByteBuffer</code>ã€‚</li>\n<li>ç¬¬ 69 è¡Œ ï¼šç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚ (<code>DispatchRequest</code>) ã€‚è¯·æ±‚é‡Œä¸»è¦åŒ…å«ä¸€æ¡æ¶ˆæ¯ (<code>Message</code>) æˆ–è€… æ–‡ä»¶å°¾ (<code>BLANK</code>) çš„åŸºæœ¬ä¿¡æ¯ã€‚</li>\n<li>ç¬¬ 72 è‡³ 96 è¡Œ ï¼šè¯·æ±‚æ˜¯æœ‰æ•ˆè¯·æ±‚ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†ã€‚\n<ul>\n<li>ç¬¬ 75 è‡³ 81 è¡Œ ï¼šå½“ <code>Broker</code> æ˜¯ä¸»èŠ‚ç‚¹ &amp;&amp; <code>Broker</code> å¼€å¯çš„æ˜¯é•¿è½®è¯¢ï¼Œé€šçŸ¥æ¶ˆè´¹é˜Ÿåˆ—æœ‰æ–°çš„æ¶ˆæ¯ã€‚<code>NotifyMessageArrivingListener</code> ä¼š è°ƒç”¨ <code>PullRequestHoldService#notifyMessageArriving(...)</code> æ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#pullrequestholdservice\">PullRequestHoldService</a></li>\n</ul>\n</li>\n<li>ç¬¬ 73 è‡³ 92 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ <code>Message</code>ï¼Œè¿›è¡Œè°ƒåº¦ï¼Œç”Ÿæˆ <code>ConsumeQueue</code> å’Œ <code>IndexFile</code> å¯¹åº”çš„å†…å®¹ã€‚è¯¦ç»†è§£æè§ï¼š</li>\n<li>ç¬¬ 93 è‡³ 96 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ <code>Blank</code>ï¼Œå³æ–‡ä»¶å°¾ï¼Œè·³è½¬æŒ‡å‘ä¸‹ä¸€ä¸ª <code>MappedFile</code>ã€‚</li>\n<li>ç¬¬ 97 è‡³ 110 è¡Œ ï¼šè¯·æ±‚æ˜¯æ— æ•ˆè¯·æ±‚ã€‚å‡ºç°è¯¥æƒ…å†µï¼ŒåŸºæœ¬æ˜¯ä¸€ä¸ª<strong>BUG</strong>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 127 è‡³ 128 è¡Œ ï¼šæ¯ 1ms å¾ªç¯æ‰§è¡Œé‡æ”¾é€»è¾‘ã€‚</li>\n<li>ç¬¬ 18 è‡³ 30 è¡Œ ï¼š<code>shutdown</code>æ—¶ï¼Œå¤šæ¬¡ <code>sleep(100)</code> ç›´åˆ° <code>CommitLog</code> å›æ”¾åˆ°æœ€æ–°ä½ç½®ã€‚æ©ï¼Œå¦‚æœæœªå›æ”¾å®Œï¼Œä¼šè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚</li>\n</ul>\n<h3>DefaultMessageStore#doDispatch(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ‰§è¡Œè°ƒåº¦è¯·æ±‚</div><div class=\"line\"> 3:  * 1. éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</div><div class=\"line\"> 4:  * 2. å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</div><div class=\"line\"> 5:  *</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> req è°ƒåº¦è¯·æ±‚</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">(DispatchRequest req)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"comment\">// éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</span></div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class=\"line\"><span class=\"number\">14</span>:             DefaultMessageStore.<span class=\"keyword\">this</span>.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),</div><div class=\"line\"><span class=\"number\">15</span>:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125;</div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"comment\">// å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</span></div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">if</span> (DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().isMessageIndexEnable()) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:         DefaultMessageStore.<span class=\"keyword\">this</span>.indexService.buildIndex(req);</div><div class=\"line\"><span class=\"number\">24</span>:     &#125;</div><div class=\"line\"><span class=\"number\">25</span>: &#125;</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>: <span class=\"comment\">/**</span></div><div class=\"line\">28:  * å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</div><div class=\"line\">29:  *</div><div class=\"line\">30:  * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">31:  * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">32:  * <span class=\"doctag\">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class=\"line\">33:  * <span class=\"doctag\">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class=\"line\">34:  * <span class=\"doctag\">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class=\"line\">35:  * <span class=\"doctag\">@param</span> storeTimestamp å­˜å‚¨æ—¶é—´</div><div class=\"line\">36:  * <span class=\"doctag\">@param</span> logicOffset é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">37:  */</div><div class=\"line\"><span class=\"number\">38</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putMessagePositionInfo</span><span class=\"params\">(String topic, <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">long</span> offset, <span class=\"keyword\">int</span> size, <span class=\"keyword\">long</span> tagsCode, <span class=\"keyword\">long</span> storeTimestamp,</span></span></div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"keyword\">long</span> logicOffset) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:     ConsumeQueue cq = <span class=\"keyword\">this</span>.findConsumeQueue(topic, queueId);</div><div class=\"line\"><span class=\"number\">41</span>:     cq.putMessagePositionInfoWrapper(offset, size, tagsCode, storeTimestamp, logicOffset);</div><div class=\"line\"><span class=\"number\">42</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>ConsumeQueue#putMessagePositionInfoWrapper(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  2:  * æ·»åŠ ä½ç½®ä¿¡æ¯å°è£…</div><div class=\"line\">  3:  *</div><div class=\"line\">  4:  * <span class=\"doctag\">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> storeTimestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´</div><div class=\"line\">  8:  * <span class=\"doctag\">@param</span> logicOffset é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">  9:  */</div><div class=\"line\"> <span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putMessagePositionInfoWrapper</span><span class=\"params\">(<span class=\"keyword\">long</span> offset, <span class=\"keyword\">int</span> size, <span class=\"keyword\">long</span> tagsCode, <span class=\"keyword\">long</span> storeTimestamp,</span></span></div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"keyword\">long</span> logicOffset) &#123;</div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxRetries = <span class=\"number\">30</span>;</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">boolean</span> canWrite = <span class=\"keyword\">this</span>.defaultMessageStore.getRunningFlags().isWriteable();</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">// å¤šæ¬¡å¾ªç¯å†™ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; maxRetries &amp;&amp; canWrite; i++) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:         <span class=\"comment\">// è°ƒç”¨æ·»åŠ ä½ç½®ä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">this</span>.putMessagePositionInfo(offset, size, tagsCode, logicOffset);</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">if</span> (result) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"comment\">// æ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨check pointã€‚</span></div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"keyword\">this</span>.defaultMessageStore.getStoreCheckpoint().setLogicsMsgTimestamp(storeTimestamp);</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">22</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">23</span>:             <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">24</span>:             log.warn(<span class=\"string\">\"[BUG]put commit log position info to \"</span> + topic + <span class=\"string\">\":\"</span> + queueId + <span class=\"string\">\" \"</span> + offset</div><div class=\"line\"> <span class=\"number\">25</span>:                 + <span class=\"string\">\" failed, retry \"</span> + i + <span class=\"string\">\" times\"</span>);</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">28</span>:                 Thread.sleep(<span class=\"number\">1000</span>);</div><div class=\"line\"> <span class=\"number\">29</span>:             &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:                 log.warn(<span class=\"string\">\"\"</span>, e);</div><div class=\"line\"> <span class=\"number\">31</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">32</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">33</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">34</span>: </div><div class=\"line\"> <span class=\"number\">35</span>:     <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me è®¾ç½®å¼‚å¸¸ä¸å¯å†™å…¥</span></div><div class=\"line\"> <span class=\"number\">36</span>:     log.error(<span class=\"string\">\"[BUG]consume queue can not write, &#123;&#125; &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.topic, <span class=\"keyword\">this</span>.queueId);</div><div class=\"line\"> <span class=\"number\">37</span>:     <span class=\"keyword\">this</span>.defaultMessageStore.getRunningFlags().makeLogicsQueueError();</div><div class=\"line\"> <span class=\"number\">38</span>: &#125;</div><div class=\"line\"> <span class=\"number\">39</span>: </div><div class=\"line\"> <span class=\"number\">40</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 41:  * æ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸ</div><div class=\"line\"> 42:  *</div><div class=\"line\"> 43:  * <span class=\"doctag\">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class=\"line\"> 44:  * <span class=\"doctag\">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class=\"line\"> 45:  * <span class=\"doctag\">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class=\"line\"> 46:  * <span class=\"doctag\">@param</span> cqOffset é˜Ÿåˆ—ä½ç½®</div><div class=\"line\"> 47:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\"> 48:  */</div><div class=\"line\"> <span class=\"number\">49</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">putMessagePositionInfo</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> tagsCode,</span></span></div><div class=\"line\"> <span class=\"number\">50</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> cqOffset) &#123;</div><div class=\"line\"> <span class=\"number\">51</span>:     <span class=\"comment\">// å¦‚æœå·²ç»é‡æ”¾è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">52</span>:     <span class=\"keyword\">if</span> (offset &lt;= <span class=\"keyword\">this</span>.maxPhysicOffset) &#123;</div><div class=\"line\"> <span class=\"number\">53</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">54</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">55</span>:     <span class=\"comment\">// å†™å…¥ä½ç½®ä¿¡æ¯åˆ°byteBuffer</span></div><div class=\"line\"> <span class=\"number\">56</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.flip();</div><div class=\"line\"> <span class=\"number\">57</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);</div><div class=\"line\"> <span class=\"number\">58</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.putLong(offset);</div><div class=\"line\"> <span class=\"number\">59</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.putInt(size);</div><div class=\"line\"> <span class=\"number\">60</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.putLong(tagsCode);</div><div class=\"line\"> <span class=\"number\">61</span>:     <span class=\"comment\">// è®¡ç®—consumeQueueå­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFile</span></div><div class=\"line\"> <span class=\"number\">62</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;</div><div class=\"line\"> <span class=\"number\">63</span>:     MappedFile mappedFile = <span class=\"keyword\">this</span>.mappedFileQueue.getLastMappedFile(expectLogicOffset);</div><div class=\"line\"> <span class=\"number\">64</span>:     <span class=\"keyword\">if</span> (mappedFile != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">65</span>:         <span class=\"comment\">// å½“æ˜¯ConsumeQueueç¬¬ä¸€ä¸ªMappedFile &amp;&amp; é˜Ÿåˆ—ä½ç½®éç¬¬ä¸€ä¸ª &amp;&amp; MappedFileæœªå†™å…¥å†…å®¹ï¼Œåˆ™å¡«å……å‰ç½®ç©ºç™½å ä½</span></div><div class=\"line\"> <span class=\"number\">66</span>:         <span class=\"keyword\">if</span> (mappedFile.isFirstCreateInQueue() &amp;&amp; cqOffset != <span class=\"number\">0</span> &amp;&amp; mappedFile.getWrotePosition() == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// TODO ç–‘é—®ï¼šä¸ºå•¥è¿™ä¸ªæ“ä½œã€‚ç›®å‰èƒ½å¤Ÿæƒ³è±¡åˆ°çš„æ˜¯ï¼Œä¸€äº›è€çš„æ¶ˆæ¯å¾ˆä¹…æ²¡å‘é€ï¼Œçªç„¶å‘é€ï¼Œè¿™ä¸ªæ—¶å€™åˆšå¥½æ»¡è¶³ã€‚</span></div><div class=\"line\"> <span class=\"number\">67</span>:             <span class=\"keyword\">this</span>.minLogicOffset = expectLogicOffset;</div><div class=\"line\"> <span class=\"number\">68</span>:             <span class=\"keyword\">this</span>.mappedFileQueue.setFlushedWhere(expectLogicOffset);</div><div class=\"line\"> <span class=\"number\">69</span>:             <span class=\"keyword\">this</span>.mappedFileQueue.setCommittedWhere(expectLogicOffset);</div><div class=\"line\"> <span class=\"number\">70</span>:             <span class=\"keyword\">this</span>.fillPreBlank(mappedFile, expectLogicOffset);</div><div class=\"line\"> <span class=\"number\">71</span>:             log.info(<span class=\"string\">\"fill pre blank space \"</span> + mappedFile.getFileName() + <span class=\"string\">\" \"</span> + expectLogicOffset + <span class=\"string\">\" \"</span></div><div class=\"line\"> <span class=\"number\">72</span>:                 + mappedFile.getWrotePosition());</div><div class=\"line\"> <span class=\"number\">73</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">74</span>:         <span class=\"comment\">// æ ¡éªŒconsumeQueueå­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ã€‚TODO å¦‚æœä¸åˆæ³•ï¼Œç»§ç»­å†™å…¥ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ</span></div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"keyword\">if</span> (cqOffset != <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:             <span class=\"keyword\">long</span> currentLogicOffset = mappedFile.getWrotePosition() + mappedFile.getFileFromOffset();</div><div class=\"line\"> <span class=\"number\">77</span>:             <span class=\"keyword\">if</span> (expectLogicOffset != currentLogicOffset) &#123;</div><div class=\"line\"> <span class=\"number\">78</span>:                 LOG_ERROR.warn(</div><div class=\"line\"> <span class=\"number\">79</span>:                     <span class=\"string\">\"[BUG]logic queue order maybe wrong, expectLogicOffset: &#123;&#125; currentLogicOffset: &#123;&#125; Topic: &#123;&#125; QID: &#123;&#125; Diff: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">80</span>:                     expectLogicOffset,</div><div class=\"line\"> <span class=\"number\">81</span>:                     currentLogicOffset,</div><div class=\"line\"> <span class=\"number\">82</span>:                     <span class=\"keyword\">this</span>.topic,</div><div class=\"line\"> <span class=\"number\">83</span>:                     <span class=\"keyword\">this</span>.queueId,</div><div class=\"line\"> <span class=\"number\">84</span>:                     expectLogicOffset - currentLogicOffset</div><div class=\"line\"> <span class=\"number\">85</span>:                 );</div><div class=\"line\"> <span class=\"number\">86</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">87</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"comment\">// è®¾ç½®commitLogé‡æ”¾æ¶ˆæ¯åˆ°ConsumeQueueä½ç½®ã€‚</span></div><div class=\"line\"> <span class=\"number\">89</span>:         <span class=\"keyword\">this</span>.maxPhysicOffset = offset;</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"comment\">// æ’å…¥mappedFile</span></div><div class=\"line\"> <span class=\"number\">91</span>:         <span class=\"keyword\">return</span> mappedFile.appendMessage(<span class=\"keyword\">this</span>.byteBufferIndex.array());</div><div class=\"line\"> <span class=\"number\">92</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">93</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">94</span>: &#125;</div><div class=\"line\"> <span class=\"number\">95</span>: </div><div class=\"line\"> <span class=\"number\">96</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 97:  * å¡«å……å‰ç½®ç©ºç™½å ä½</div><div class=\"line\"> 98:  *</div><div class=\"line\"> 99:  * <span class=\"doctag\">@param</span> mappedFile MappedFile</div><div class=\"line\">100:  * <span class=\"doctag\">@param</span> untilWhere consumeQueueå­˜å‚¨ä½ç½®</div><div class=\"line\">101:  */</div><div class=\"line\"><span class=\"number\">102</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">fillPreBlank</span><span class=\"params\">(<span class=\"keyword\">final</span> MappedFile mappedFile, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> untilWhere)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">103</span>:     <span class=\"comment\">// å†™å…¥å‰ç½®ç©ºç™½å ä½åˆ°byteBuffer</span></div><div class=\"line\"><span class=\"number\">104</span>:     ByteBuffer byteBuffer = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);</div><div class=\"line\"><span class=\"number\">105</span>:     byteBuffer.putLong(<span class=\"number\">0L</span>);</div><div class=\"line\"><span class=\"number\">106</span>:     byteBuffer.putInt(Integer.MAX_VALUE);</div><div class=\"line\"><span class=\"number\">107</span>:     byteBuffer.putLong(<span class=\"number\">0L</span>);</div><div class=\"line\"><span class=\"number\">108</span>:     <span class=\"comment\">// å¾ªç¯å¡«ç©º</span></div><div class=\"line\"><span class=\"number\">109</span>:     <span class=\"keyword\">int</span> until = (<span class=\"keyword\">int</span>) (untilWhere % <span class=\"keyword\">this</span>.mappedFileQueue.getMappedFileSize());</div><div class=\"line\"><span class=\"number\">110</span>:     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; until; i += CQ_STORE_UNIT_SIZE) &#123;</div><div class=\"line\"><span class=\"number\">111</span>:         mappedFile.appendMessage(byteBuffer.array());</div><div class=\"line\"><span class=\"number\">112</span>:     &#125;</div><div class=\"line\"><span class=\"number\">113</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>#putMessagePositionInfoWrapper(...)</code> è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° <code>ConsumeQueue</code> çš„å°è£…ï¼Œå®é™…éœ€è¦è°ƒç”¨ <code>#putMessagePositionInfo(...)</code> æ–¹æ³•ã€‚\n<ul>\n<li>ç¬¬ 13 è¡Œ ï¼šåˆ¤æ–­ <code>ConsumeQueue</code> æ˜¯å¦å…è®¸å†™å…¥ã€‚å½“å‘ç”ŸBugæ—¶ï¼Œä¸å…è®¸å†™å…¥ã€‚</li>\n<li>ç¬¬ 17 è¡Œ ï¼šè°ƒç”¨ <code>#putMessagePositionInfo(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä½ç½®ä¿¡æ¯ã€‚</li>\n<li>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨æ£€æŸ¥ç‚¹ã€‚<code>StoreCheckpoint</code> çš„è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/store-init-and-shutdown/\">Storeåˆå§‹åŒ–ä¸å…³é—­</a>ã€‚</li>\n<li>ç¬¬ 22 è‡³ 32 è¡Œ ï¼šæ·»åŠ å¤±è´¥ï¼Œç›®å‰åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯BUGã€‚</li>\n<li>ç¬¬ 35 è‡³ 37 è¡Œ ï¼šå†™å…¥å¤±è´¥æ—¶ï¼Œæ ‡è®° <code>ConsumeQueue</code> å†™å…¥å¼‚å¸¸ï¼Œä¸å…è®¸ç»§ç»­å†™å…¥ã€‚</li>\n</ul>\n</li>\n<li><code>#putMessagePositionInfo(...)</code> è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° <code>ConsumeQueue</code>ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸã€‚\n<ul>\n<li>ç¬¬ 51 è‡³ 54 è¡Œ ï¼šå¦‚æœ <code>offset</code>(å­˜å‚¨ä½ç½®) å°äºç­‰äº  <code>maxPhysicOffset</code>(<code>CommitLog</code> æ¶ˆæ¯é‡æ”¾åˆ° <code>ConsumeQueue</code> æœ€å¤§çš„ <code>CommitLog</code> å­˜å‚¨ä½ç½®)ï¼Œè¡¨ç¤ºå·²ç»é‡æ”¾è¿‡ï¼Œæ­¤æ—¶ï¼Œä¸å†é‡å¤å†™å…¥ï¼Œç›´æ¥è¿”å›å†™å…¥æˆåŠŸã€‚</li>\n<li>ç¬¬ 55 è‡³ 60 è¡Œ ï¼šå†™ ä½ç½®ä¿¡æ¯åˆ°byteBufferã€‚</li>\n<li>ç¬¬ 62 è‡³ 63 è¡Œ ï¼šè®¡ç®— <code>ConsumeQueue</code>å­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFileã€‚</li>\n<li>ç¬¬ 65 è‡³ 73 è¡Œ ï¼šå½“ <code>MappedFile</code> æ˜¯ <code>ConsumeQueue</code> å½“å‰ç¬¬ä¸€ä¸ªæ–‡ä»¶ &amp;&amp; <code>MappedFile</code> æœªå†™å…¥å†…å®¹ &amp;&amp; é‡æ”¾æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å¤§äº0ï¼Œåˆ™éœ€è¦è¿›è¡Œ <code>MappedFile</code> å¡«å……å‰ç½®  <code>BLANK</code>ã€‚\n<ul>\n<li><em>è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä¼šéœ€è¦ã€‚çŒœæµ‹äº§ç”Ÿçš„åŸå› ï¼šä¸€ä¸ª <code>Topic</code> é•¿æœŸæ— æ¶ˆæ¯äº§ç”Ÿï¼Œçªç„¶Nå¤©åè¿›è¡Œå‘é€ï¼Œ<code>Topic</code> å¯¹åº”çš„å†å²æ¶ˆæ¯ä»¥åŠå’Œæ¶ˆè´¹é˜Ÿåˆ—æ•°æ®å·²ç»è¢«æ¸…ç†ï¼Œæ–°ç”Ÿæˆçš„<code>MappedFile</code>éœ€è¦å‰ç½®å ä½ã€‚</em></li>\n</ul>\n</li>\n<li>ç¬¬ 74 è‡³ 87 è¡Œ ï¼šæ ¡éªŒ <code>ConsumeQueue</code> å­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™è¾“å‡ºæ—¥å¿—ã€‚\n<ul>\n<li><em>è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œå¦‚æœè®¡ç®—å‡ºæ¥çš„å­˜å‚¨ä½ç½®ä¸åˆæ³•ï¼Œä¸è¿”å›æ·»åŠ å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œæ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿ</em></li>\n</ul>\n</li>\n<li>ç¬¬ 89 è¡Œ ï¼šè®¾ç½® <code>CommitLog</code> é‡æ”¾æ¶ˆæ¯åˆ° <code>ConsumeQueue</code> çš„æœ€å¤§ä½ç½®ã€‚</li>\n<li>ç¬¬ 91 è¡Œ ï¼šæ’å…¥æ¶ˆæ¯ä½ç½®åˆ° <code>MappedFile</code>ã€‚</li>\n</ul>\n</li>\n</ul>\n<h2>FlushConsumeQueueService</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FlushConsumeQueueService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> RETRY_TIMES_OVER = <span class=\"number\">3</span>;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * æœ€åflushæ—¶é—´æˆ³</div><div class=\"line\"> 5:      */</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> lastFlushTimestamp = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doFlush</span><span class=\"params\">(<span class=\"keyword\">int</span> retryTimes)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">int</span> flushConsumeQueueLeastPages = DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getFlushConsumeQueueLeastPages();</div><div class=\"line\"><span class=\"number\">10</span>: </div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"comment\">// retryTimes == RETRY_TIMES_OVERæ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ä¸»è¦ç”¨äºshutdownæ—¶ã€‚</span></div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">if</span> (retryTimes == RETRY_TIMES_OVER) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:             flushConsumeQueueLeastPages = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">14</span>:         &#125;</div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"comment\">// å½“æ—¶é—´æ»¡è¶³flushConsumeQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushConsumeQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush</span></div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">long</span> logicsMsgTimestamp = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">int</span> flushConsumeQueueThoroughInterval = DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getFlushConsumeQueueThoroughInterval();</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">long</span> currentTimeMillis = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (currentTimeMillis &gt;= (<span class=\"keyword\">this</span>.lastFlushTimestamp + flushConsumeQueueThoroughInterval)) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">this</span>.lastFlushTimestamp = currentTimeMillis;</div><div class=\"line\"><span class=\"number\">21</span>:             flushConsumeQueueLeastPages = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">22</span>:             logicsMsgTimestamp = DefaultMessageStore.<span class=\"keyword\">this</span>.getStoreCheckpoint().getLogicsMsgTimestamp();</div><div class=\"line\"><span class=\"number\">23</span>:         &#125;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"comment\">// flushæ¶ˆè´¹é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">25</span>:         ConcurrentHashMap&lt;String, ConcurrentHashMap&lt;Integer, ConsumeQueue&gt;&gt; tables = DefaultMessageStore.<span class=\"keyword\">this</span>.consumeQueueTable;</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">for</span> (ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; maps : tables.values()) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">for</span> (ConsumeQueue cq : maps.values()) &#123;</div><div class=\"line\"><span class=\"number\">28</span>:                 <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">29</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; retryTimes &amp;&amp; !result; i++) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                     result = cq.flush(flushConsumeQueueLeastPages);</div><div class=\"line\"><span class=\"number\">31</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">32</span>:             &#125;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:         <span class=\"comment\">// flush å­˜å‚¨ check point</span></div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == flushConsumeQueueLeastPages) &#123;</div><div class=\"line\"><span class=\"number\">36</span>:             <span class=\"keyword\">if</span> (logicsMsgTimestamp &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:                 DefaultMessageStore.<span class=\"keyword\">this</span>.getStoreCheckpoint().setLogicsMsgTimestamp(logicsMsgTimestamp);</div><div class=\"line\"><span class=\"number\">38</span>:             &#125;</div><div class=\"line\"><span class=\"number\">39</span>:             DefaultMessageStore.<span class=\"keyword\">this</span>.getStoreCheckpoint().flush();</div><div class=\"line\"><span class=\"number\">40</span>:         &#125;</div><div class=\"line\"><span class=\"number\">41</span>:     &#125;</div><div class=\"line\"><span class=\"number\">42</span>: </div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">44</span>:         DefaultMessageStore.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">45</span>: </div><div class=\"line\"><span class=\"number\">46</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">48</span>:                 <span class=\"keyword\">int</span> interval = DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getFlushIntervalConsumeQueue();</div><div class=\"line\"><span class=\"number\">49</span>:                 <span class=\"keyword\">this</span>.waitForRunning(interval);</div><div class=\"line\"><span class=\"number\">50</span>:                 <span class=\"keyword\">this</span>.doFlush(<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">51</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:                 DefaultMessageStore.log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">53</span>:             &#125;</div><div class=\"line\"><span class=\"number\">54</span>:         &#125;</div><div class=\"line\"><span class=\"number\">55</span>: </div><div class=\"line\"><span class=\"number\">56</span>:         <span class=\"keyword\">this</span>.doFlush(RETRY_TIMES_OVER);</div><div class=\"line\"><span class=\"number\">57</span>: </div><div class=\"line\"><span class=\"number\">58</span>:         DefaultMessageStore.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">59</span>:     &#125;</div><div class=\"line\"><span class=\"number\">60</span>: </div><div class=\"line\"><span class=\"number\">61</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">62</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">63</span>:         <span class=\"keyword\">return</span> FlushConsumeQueueService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">64</span>:     &#125;</div><div class=\"line\"><span class=\"number\">65</span>: </div><div class=\"line\"><span class=\"number\">66</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">67</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getJointime</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">68</span>:         <span class=\"keyword\">return</span> <span class=\"number\">1000</span> * <span class=\"number\">60</span>;</div><div class=\"line\"><span class=\"number\">69</span>:     &#125;</div><div class=\"line\"><span class=\"number\">70</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šflush <code>ConsumeQueue</code>(æ¶ˆè´¹é˜Ÿåˆ—) çº¿ç¨‹æœåŠ¡ã€‚</li>\n<li>ç¬¬ 11 è‡³ 14 è¡Œ ï¼šå½“ <code>retryTimes == RETRY_TIMES_OVER</code> æ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ç”¨äº <code>shutdown</code> æ—¶ã€‚</li>\n<li>ç¬¬ 15 è‡³ 23 è¡Œ ï¼šæ¯ flushConsumeQueueThoroughInterval å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ flush ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ flushConsumeQueueLeastPages å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ flush ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ flushï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚</li>\n<li>ç¬¬ 24 è‡³ 33 è¡Œ ï¼šflush <code>ConsumeQueue</code>(æ¶ˆè´¹é˜Ÿåˆ—)ã€‚\n<ul>\n<li>flush é€»è¾‘ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-store/#MappedFile-%E8%90%BD%E7%9B%98\">MappedFile#è½ç›˜</a>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 34 è‡³ 40 è¡Œ ï¼šflush <code>StoreCheckpoint</code>ã€‚<code>StoreCheckpoint</code> çš„è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/store-init-and-shutdown/\">Storeåˆå§‹åŒ–ä¸å…³é—­</a>ã€‚</li>\n<li>ç¬¬ 43 è‡³ 59 è¡Œ ï¼šæ¯ 1000ms æ‰§è¡Œä¸€æ¬¡ <code>flush</code>ã€‚å¦‚æœ wakeup() æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡ <code>flush</code>ã€‚ç›®å‰ï¼Œæš‚æ—¶ä¸å­˜åœ¨ wakeup() çš„è°ƒç”¨ã€‚</li>\n</ul>\n<h1>4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</h1>\n<h2>PullMessageRequestHeader</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PullMessageRequestHeader</span> <span class=\"keyword\">implements</span> <span class=\"title\">CommandCustomHeader</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 3:      * æ¶ˆè´¹è€…åˆ†ç»„</div><div class=\"line\"> 4:      */</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> String consumerGroup;</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 8:      * Topic</div><div class=\"line\"> 9:      */</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">private</span> String topic;</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">13:      * é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">14:      */</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">private</span> Integer queueId;</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">18:      * é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class=\"line\">19:      */</div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"keyword\">private</span> Long queueOffset;</div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">23:      * æ¶ˆæ¯æ•°é‡</div><div class=\"line\">24:      */</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">private</span> Integer maxMsgNums;</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">28:      * ç³»ç»Ÿæ ‡è¯†</div><div class=\"line\">29:      */</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"keyword\">private</span> Integer sysFlag;</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">33:      * æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®</div><div class=\"line\">34:      */</div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"keyword\">private</span> Long commitOffset;</div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">38:      * æŒ‚èµ·è¶…æ—¶æ—¶é—´</div><div class=\"line\">39:      */</div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">41</span>:     <span class=\"keyword\">private</span> Long suspendTimeoutMillis;</div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">43:      * è®¢é˜…è¡¨è¾¾å¼</div><div class=\"line\">44:      */</div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"meta\">@CFNullable</span></div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">private</span> String subscription;</div><div class=\"line\"><span class=\"number\">47</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">48:      * è®¢é˜…ç‰ˆæœ¬å·</div><div class=\"line\">49:      */</div><div class=\"line\"><span class=\"number\">50</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">51</span>:     <span class=\"keyword\">private</span> Long subVersion;</div><div class=\"line\"><span class=\"number\">52</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚Header</li>\n<li>topic +  queueId + queueOffset + maxMsgNums</li>\n<li>sysFlag ï¼šç³»ç»Ÿæ ‡è¯†ã€‚\n<ul>\n<li>ç¬¬ 0 ä½ <code>FLAG_COMMIT_OFFSET</code> ï¼šæ ‡è®°è¯·æ±‚æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®ï¼Œå’Œ <code>commitOffset</code> é…åˆã€‚</li>\n<li>ç¬¬ 1 ä½ <code>FLAG_SUSPEND</code> ï¼šæ ‡è®°è¯·æ±‚æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå’Œ <code>suspendTimeoutMillis</code> é…åˆã€‚å½“æ‹‰å–ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œ <code>Broker</code> ä¼šæŒ‚èµ·è¯·æ±‚ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ã€‚æœ€å¤§æŒ‚èµ·æ—¶é—´ï¼š<code>suspendTimeoutMillis</code> æ¯«ç§’ã€‚</li>\n<li>ç¬¬ 2 ä½ <code>FLAG_SUBSCRIPTION</code> ï¼šæ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼ï¼Œå’Œ <code>subscription</code> é…ç½®ã€‚</li>\n</ul>\n</li>\n<li>subVersion ï¼šè®¢é˜…ç‰ˆæœ¬å·ã€‚è¯·æ±‚æ—¶ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸å¯¹ï¼Œåˆ™æ— æ³•æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°è·å–è®¢é˜…ä¿¡æ¯ï¼Œä½¿ç”¨æœ€æ–°çš„è®¢é˜…ç‰ˆæœ¬å·ã€‚</li>\n</ul>\n<h2>PullMessageProcessor#processRequest(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">processRequest</span><span class=\"params\">(<span class=\"keyword\">final</span> Channel channel, RemotingCommand request, <span class=\"keyword\">boolean</span> brokerAllowSuspend)</span></span></div><div class=\"line\">  2:     <span class=\"keyword\">throws</span> RemotingCommandException &#123;</div><div class=\"line\">  <span class=\"number\">3</span>:     RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();</div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> PullMessageRequestHeader requestHeader =</div><div class=\"line\">  <span class=\"number\">6</span>:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);</div><div class=\"line\">  <span class=\"number\">7</span>: </div><div class=\"line\">  <span class=\"number\">8</span>:     response.setOpaque(request.getOpaque());</div><div class=\"line\">  <span class=\"number\">9</span>: </div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"keyword\">if</span> (LOG.isDebugEnabled()) &#123;</div><div class=\"line\"> <span class=\"number\">11</span>:         LOG.debug(<span class=\"string\">\"receive PullMessage request command, &#123;&#125;\"</span>, request);</div><div class=\"line\"> <span class=\"number\">12</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">13</span>: </div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">// æ ¡éªŒ broker æ˜¯å¦å¯è¯»</span></div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (!PermName.isReadable(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">17</span>:         response.setRemark(String.format(<span class=\"string\">\"the broker[%s] pulling message is forbidden\"</span>, <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerIP1()));</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">19</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">20</span>: </div><div class=\"line\"> <span class=\"number\">21</span>:     <span class=\"comment\">// æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">22</span>:     SubscriptionGroupConfig subscriptionGroupConfig = <span class=\"keyword\">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">23</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionGroupConfig) &#123;</div><div class=\"line\"> <span class=\"number\">24</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">25</span>:         response.setRemark(String.format(<span class=\"string\">\"subscription group [%s] does not exist, %s\"</span>, requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));</div><div class=\"line\"> <span class=\"number\">26</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">27</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"comment\">// æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å¯æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">if</span> (!subscriptionGroupConfig.isConsumeEnable()) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">31</span>:         response.setRemark(<span class=\"string\">\"subscription group no permission, \"</span> + requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">33</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">34</span>: </div><div class=\"line\"> <span class=\"number\">35</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag()); <span class=\"comment\">// æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå½“æ²¡æœ‰æ¶ˆæ¯æ—¶</span></div><div class=\"line\"> <span class=\"number\">36</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag()); <span class=\"comment\">// æ˜¯å¦æäº¤æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">37</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag()); <span class=\"comment\">// æ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼(subscription)</span></div><div class=\"line\"> <span class=\"number\">38</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : <span class=\"number\">0</span>; <span class=\"comment\">// æŒ‚èµ·è¯·æ±‚è¶…æ—¶æ—¶é•¿</span></div><div class=\"line\"> <span class=\"number\">39</span>: </div><div class=\"line\"> <span class=\"number\">40</span>:     <span class=\"comment\">// æ ¡éªŒ topicé…ç½® å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">41</span>:     TopicConfig topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class=\"line\"> <span class=\"number\">42</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"> <span class=\"number\">43</span>:         LOG.error(<span class=\"string\">\"The topic &#123;&#125; not exist, consumer: &#123;&#125; \"</span>, requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));</div><div class=\"line\"> <span class=\"number\">44</span>:         response.setCode(ResponseCode.TOPIC_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">45</span>:         response.setRemark(String.format(<span class=\"string\">\"topic[%s] not exist, apply first please! %s\"</span>, requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));</div><div class=\"line\"> <span class=\"number\">46</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">47</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">48</span>:     <span class=\"comment\">// æ ¡éªŒ topicé…ç½® æƒé™å¯è¯»</span></div><div class=\"line\"> <span class=\"number\">49</span>:     <span class=\"keyword\">if</span> (!PermName.isReadable(topicConfig.getPerm())) &#123;</div><div class=\"line\"> <span class=\"number\">50</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">51</span>:         response.setRemark(<span class=\"string\">\"the topic[\"</span> + requestHeader.getTopic() + <span class=\"string\">\"] pulling message is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">52</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">53</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">54</span>:     <span class=\"comment\">// æ ¡éªŒ è¯»å–é˜Ÿåˆ— åœ¨ topicé…ç½® é˜Ÿåˆ—èŒƒå›´å†…</span></div><div class=\"line\"> <span class=\"number\">55</span>:     <span class=\"keyword\">if</span> (requestHeader.getQueueId() &lt; <span class=\"number\">0</span> || requestHeader.getQueueId() &gt;= topicConfig.getReadQueueNums()) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:         String errorInfo = String.format(<span class=\"string\">\"queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]\"</span>,</div><div class=\"line\"> <span class=\"number\">57</span>:                 requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());</div><div class=\"line\"> <span class=\"number\">58</span>:         LOG.warn(errorInfo);</div><div class=\"line\"> <span class=\"number\">59</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">60</span>:         response.setRemark(errorInfo);</div><div class=\"line\"> <span class=\"number\">61</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">62</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">63</span>: </div><div class=\"line\"> <span class=\"number\">64</span>:     <span class=\"comment\">// æ ¡éªŒ è®¢é˜…å…³ç³»</span></div><div class=\"line\"> <span class=\"number\">65</span>:     SubscriptionData subscriptionData;</div><div class=\"line\"> <span class=\"number\">66</span>:     <span class=\"keyword\">if</span> (hasSubscriptionFlag) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">68</span>:             subscriptionData = FilterAPI.buildSubscriptionData(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class=\"line\"> <span class=\"number\">69</span>:                 requestHeader.getSubscription());</div><div class=\"line\"> <span class=\"number\">70</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">71</span>:             LOG.warn(<span class=\"string\">\"Parse the consumer's subscription[&#123;&#125;] failed, group: &#123;&#125;\"</span>, requestHeader.getSubscription(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">72</span>:                     requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">73</span>:             response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);</div><div class=\"line\"> <span class=\"number\">74</span>:             response.setRemark(<span class=\"string\">\"parse the consumer's subscription failed\"</span>);</div><div class=\"line\"> <span class=\"number\">75</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">76</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">77</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">78</span>:         <span class=\"comment\">// æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ˜¯å¦å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">79</span>:         ConsumerGroupInfo consumerGroupInfo = <span class=\"keyword\">this</span>.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">80</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == consumerGroupInfo) &#123;</div><div class=\"line\"> <span class=\"number\">81</span>:             LOG.warn(<span class=\"string\">\"The consumer's group info not exist, group: &#123;&#125;\"</span>, requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">82</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">83</span>:             response.setRemark(<span class=\"string\">\"the consumer's group info not exist\"</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class=\"line\"> <span class=\"number\">84</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">85</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>:         <span class=\"comment\">// æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ¶ˆæ¯æ¨¡å‹æ˜¯å¦åŒ¹é…</span></div><div class=\"line\"> <span class=\"number\">87</span>:         <span class=\"keyword\">if</span> (!subscriptionGroupConfig.isConsumeBroadcastEnable() <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">88</span>:             &amp;&amp; consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) &#123;</div><div class=\"line\"> <span class=\"number\">89</span>:             response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">90</span>:             response.setRemark(<span class=\"string\">\"the consumer group[\"</span> + requestHeader.getConsumerGroup() + <span class=\"string\">\"] can not consume by broadcast way\"</span>);</div><div class=\"line\"> <span class=\"number\">91</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">92</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">93</span>: </div><div class=\"line\"> <span class=\"number\">94</span>:         <span class=\"comment\">// æ ¡éªŒ è®¢é˜…ä¿¡æ¯ æ˜¯å¦å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">95</span>:         subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());</div><div class=\"line\"> <span class=\"number\">96</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionData) &#123;</div><div class=\"line\"> <span class=\"number\">97</span>:             LOG.warn(<span class=\"string\">\"The consumer's subscription not exist, group: &#123;&#125;, topic:&#123;&#125;\"</span>, requestHeader.getConsumerGroup(), requestHeader.getTopic());</div><div class=\"line\"> <span class=\"number\">98</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">99</span>:             response.setRemark(<span class=\"string\">\"the consumer's subscription not exist\"</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class=\"line\"><span class=\"number\">100</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">101</span>:         &#125;</div><div class=\"line\"><span class=\"number\">102</span>:         <span class=\"comment\">// æ ¡éªŒ è®¢é˜…ä¿¡æ¯ç‰ˆæœ¬ æ˜¯å¦åˆæ³•</span></div><div class=\"line\"><span class=\"number\">103</span>:         <span class=\"keyword\">if</span> (subscriptionData.getSubVersion() &lt; requestHeader.getSubVersion()) &#123;</div><div class=\"line\"><span class=\"number\">104</span>:             LOG.warn(<span class=\"string\">\"The broker's subscription is not latest, group: &#123;&#125; &#123;&#125;\"</span>, requestHeader.getConsumerGroup(),</div><div class=\"line\"><span class=\"number\">105</span>:                     subscriptionData.getSubString());</div><div class=\"line\"><span class=\"number\">106</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);</div><div class=\"line\"><span class=\"number\">107</span>:             response.setRemark(<span class=\"string\">\"the consumer's subscription not latest\"</span>);</div><div class=\"line\"><span class=\"number\">108</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">109</span>:         &#125;</div><div class=\"line\"><span class=\"number\">110</span>:     &#125;</div><div class=\"line\"><span class=\"number\">111</span>: </div><div class=\"line\"><span class=\"number\">112</span>:     <span class=\"comment\">// è·å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">113</span>:     <span class=\"keyword\">final</span> GetMessageResult getMessageResult = <span class=\"keyword\">this</span>.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class=\"line\"><span class=\"number\">114</span>:             requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), subscriptionData);</div><div class=\"line\"><span class=\"number\">115</span>:     <span class=\"keyword\">if</span> (getMessageResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">116</span>:         response.setRemark(getMessageResult.getStatus().name());</div><div class=\"line\"><span class=\"number\">117</span>:         responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">118</span>:         responseHeader.setMinOffset(getMessageResult.getMinOffset());</div><div class=\"line\"><span class=\"number\">119</span>:         responseHeader.setMaxOffset(getMessageResult.getMaxOffset());</div><div class=\"line\"><span class=\"number\">120</span>: </div><div class=\"line\"><span class=\"number\">121</span>:         <span class=\"comment\">// TODO å¾…è¯»</span></div><div class=\"line\"><span class=\"number\">122</span>:         <span class=\"comment\">// è®¡ç®—å»ºè®®è¯»å–brokerId</span></div><div class=\"line\"><span class=\"number\">123</span>:         <span class=\"keyword\">if</span> (getMessageResult.isSuggestPullingFromSlave()) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:             responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class=\"line\"><span class=\"number\">125</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">126</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class=\"line\"><span class=\"number\">127</span>:         &#125;</div><div class=\"line\"><span class=\"number\">128</span>: </div><div class=\"line\"><span class=\"number\">129</span>:         <span class=\"keyword\">switch</span> (<span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class=\"line\"><span class=\"number\">130</span>:             <span class=\"keyword\">case</span> ASYNC_MASTER:</div><div class=\"line\"><span class=\"number\">131</span>:             <span class=\"keyword\">case</span> SYNC_MASTER:</div><div class=\"line\"><span class=\"number\">132</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">133</span>:             <span class=\"keyword\">case</span> SLAVE:</div><div class=\"line\"><span class=\"number\">134</span>:                 <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123; <span class=\"comment\">// ä»èŠ‚ç‚¹ä¸å…è®¸è¯»å–ï¼Œå‘Šè¯‰consumerè¯»å–ä¸»èŠ‚ç‚¹ã€‚</span></div><div class=\"line\"><span class=\"number\">135</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class=\"line\"><span class=\"number\">136</span>:                     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class=\"line\"><span class=\"number\">137</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">138</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">139</span>:         &#125;</div><div class=\"line\"><span class=\"number\">140</span>: </div><div class=\"line\"><span class=\"number\">141</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123;</div><div class=\"line\"><span class=\"number\">142</span>:             <span class=\"comment\">// consume too slow ,redirect to another machine</span></div><div class=\"line\"><span class=\"number\">143</span>:             <span class=\"keyword\">if</span> (getMessageResult.isSuggestPullingFromSlave()) &#123;</div><div class=\"line\"><span class=\"number\">144</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class=\"line\"><span class=\"number\">145</span>:             &#125;</div><div class=\"line\"><span class=\"number\">146</span>:             <span class=\"comment\">// consume ok</span></div><div class=\"line\"><span class=\"number\">147</span>:             <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">148</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class=\"line\"><span class=\"number\">149</span>:             &#125;</div><div class=\"line\"><span class=\"number\">150</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">151</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class=\"line\"><span class=\"number\">152</span>:         &#125;</div><div class=\"line\"><span class=\"number\">153</span>: </div><div class=\"line\"><span class=\"number\">154</span>:         <span class=\"keyword\">switch</span> (getMessageResult.getStatus()) &#123;</div><div class=\"line\"><span class=\"number\">155</span>:             <span class=\"keyword\">case</span> FOUND:</div><div class=\"line\"><span class=\"number\">156</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"><span class=\"number\">157</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">158</span>:             <span class=\"keyword\">case</span> MESSAGE_WAS_REMOVING:</div><div class=\"line\"><span class=\"number\">159</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class=\"line\"><span class=\"number\">160</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">161</span>:             <span class=\"keyword\">case</span> NO_MATCHED_LOGIC_QUEUE:</div><div class=\"line\"><span class=\"number\">162</span>:             <span class=\"keyword\">case</span> NO_MESSAGE_IN_QUEUE:</div><div class=\"line\"><span class=\"number\">163</span>:                 <span class=\"keyword\">if</span> (<span class=\"number\">0</span> != requestHeader.getQueueOffset()) &#123;</div><div class=\"line\"><span class=\"number\">164</span>:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class=\"line\"><span class=\"number\">165</span>: </div><div class=\"line\"><span class=\"number\">166</span>:                     <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"><span class=\"number\">167</span>:                     LOG.info(<span class=\"string\">\"the broker store no queue data, fix the request offset &#123;&#125; to &#123;&#125;, Topic: &#123;&#125; QueueId: &#123;&#125; Consumer Group: &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">168</span>:                         requestHeader.getQueueOffset(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">169</span>:                         getMessageResult.getNextBeginOffset(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">170</span>:                         requestHeader.getTopic(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">171</span>:                         requestHeader.getQueueId(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">172</span>:                         requestHeader.getConsumerGroup()<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">173</span>:                     );</div><div class=\"line\"><span class=\"number\">174</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">175</span>:                     response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class=\"line\"><span class=\"number\">176</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">177</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">178</span>:             <span class=\"keyword\">case</span> NO_MATCHED_MESSAGE:</div><div class=\"line\"><span class=\"number\">179</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class=\"line\"><span class=\"number\">180</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">181</span>:             <span class=\"keyword\">case</span> OFFSET_FOUND_NULL:</div><div class=\"line\"><span class=\"number\">182</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class=\"line\"><span class=\"number\">183</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">184</span>:             <span class=\"keyword\">case</span> OFFSET_OVERFLOW_BADLY:</div><div class=\"line\"><span class=\"number\">185</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class=\"line\"><span class=\"number\">186</span>:                 <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"><span class=\"number\">187</span>:                 LOG.info(<span class=\"string\">\"The request offset:&#123;&#125; over flow badly, broker max offset:&#123;&#125; , consumer: &#123;&#125;\"</span>, requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());</div><div class=\"line\"><span class=\"number\">188</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">189</span>:             <span class=\"keyword\">case</span> OFFSET_OVERFLOW_ONE:</div><div class=\"line\"><span class=\"number\">190</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class=\"line\"><span class=\"number\">191</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">192</span>:             <span class=\"keyword\">case</span> OFFSET_TOO_SMALL:</div><div class=\"line\"><span class=\"number\">193</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class=\"line\"><span class=\"number\">194</span>:                 LOG.info(<span class=\"string\">\"The request offset is too small. group=&#123;&#125;, topic=&#123;&#125;, requestOffset=&#123;&#125;, brokerMinOffset=&#123;&#125;, clientIp=&#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">195</span>:                     requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),</div><div class=\"line\"><span class=\"number\">196</span>:                     getMessageResult.getMinOffset(), channel.remoteAddress());</div><div class=\"line\"><span class=\"number\">197</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">198</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">199</span>:                 <span class=\"keyword\">assert</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">200</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">201</span>:         &#125;</div><div class=\"line\"><span class=\"number\">202</span>: </div><div class=\"line\"><span class=\"number\">203</span>:         <span class=\"comment\">// hookï¼šbefore</span></div><div class=\"line\"><span class=\"number\">204</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasConsumeMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">205</span>:             ConsumeMessageContext context = <span class=\"keyword\">new</span> ConsumeMessageContext();</div><div class=\"line\"><span class=\"number\">206</span>:             context.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class=\"line\"><span class=\"number\">207</span>:             context.setTopic(requestHeader.getTopic());</div><div class=\"line\"><span class=\"number\">208</span>:             context.setQueueId(requestHeader.getQueueId());</div><div class=\"line\"><span class=\"number\">209</span>: </div><div class=\"line\"><span class=\"number\">210</span>:             String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</div><div class=\"line\"><span class=\"number\">211</span>: </div><div class=\"line\"><span class=\"number\">212</span>:             <span class=\"keyword\">switch</span> (response.getCode()) &#123;</div><div class=\"line\"><span class=\"number\">213</span>:                 <span class=\"keyword\">case</span> ResponseCode.SUCCESS:</div><div class=\"line\"><span class=\"number\">214</span>:                     <span class=\"keyword\">int</span> commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</div><div class=\"line\"><span class=\"number\">215</span>:                     <span class=\"keyword\">int</span> incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;</div><div class=\"line\"><span class=\"number\">216</span>: </div><div class=\"line\"><span class=\"number\">217</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);</div><div class=\"line\"><span class=\"number\">218</span>:                     context.setCommercialRcvTimes(incValue);</div><div class=\"line\"><span class=\"number\">219</span>:                     context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());</div><div class=\"line\"><span class=\"number\">220</span>:                     context.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">221</span>: </div><div class=\"line\"><span class=\"number\">222</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">223</span>:                 <span class=\"keyword\">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class=\"line\"><span class=\"number\">224</span>:                     <span class=\"keyword\">if</span> (!brokerAllowSuspend) &#123;</div><div class=\"line\"><span class=\"number\">225</span>: </div><div class=\"line\"><span class=\"number\">226</span>:                         context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class=\"line\"><span class=\"number\">227</span>:                         context.setCommercialRcvTimes(<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">228</span>:                         context.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">229</span>: </div><div class=\"line\"><span class=\"number\">230</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">231</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">232</span>:                 <span class=\"keyword\">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class=\"line\"><span class=\"number\">233</span>:                 <span class=\"keyword\">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class=\"line\"><span class=\"number\">234</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class=\"line\"><span class=\"number\">235</span>:                     context.setCommercialRcvTimes(<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">236</span>:                     context.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">237</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">238</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">239</span>:                     <span class=\"keyword\">assert</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">240</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">241</span>:             &#125;</div><div class=\"line\"><span class=\"number\">242</span>: </div><div class=\"line\"><span class=\"number\">243</span>:             <span class=\"keyword\">this</span>.executeConsumeMessageHookBefore(context);</div><div class=\"line\"><span class=\"number\">244</span>:         &#125;</div><div class=\"line\"><span class=\"number\">245</span>: </div><div class=\"line\"><span class=\"number\">246</span>:         <span class=\"keyword\">switch</span> (response.getCode()) &#123;</div><div class=\"line\"><span class=\"number\">247</span>:             <span class=\"keyword\">case</span> ResponseCode.SUCCESS:</div><div class=\"line\"><span class=\"number\">248</span>: </div><div class=\"line\"><span class=\"number\">249</span>:                 <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class=\"line\"><span class=\"number\">250</span>:                     getMessageResult.getMessageCount());</div><div class=\"line\"><span class=\"number\">251</span>:                 <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class=\"line\"><span class=\"number\">252</span>:                     getMessageResult.getBufferTotalSize());</div><div class=\"line\"><span class=\"number\">253</span>:                 <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());</div><div class=\"line\"><span class=\"number\">254</span>:                 <span class=\"comment\">// è¯»å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">255</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isTransferMsgByHeap()) &#123; <span class=\"comment\">// å†…å­˜ä¸­</span></div><div class=\"line\"><span class=\"number\">256</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTimeMills = <span class=\"keyword\">this</span>.brokerController.getMessageStore().now();</div><div class=\"line\"><span class=\"number\">257</span>: </div><div class=\"line\"><span class=\"number\">258</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] r = <span class=\"keyword\">this</span>.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());</div><div class=\"line\"><span class=\"number\">259</span>: </div><div class=\"line\"><span class=\"number\">260</span>:                     <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),</div><div class=\"line\"><span class=\"number\">261</span>:                         requestHeader.getTopic(), requestHeader.getQueueId(),</div><div class=\"line\"><span class=\"number\">262</span>:                         (<span class=\"keyword\">int</span>) (<span class=\"keyword\">this</span>.brokerController.getMessageStore().now() - beginTimeMills));</div><div class=\"line\"><span class=\"number\">263</span>:                     response.setBody(r);</div><div class=\"line\"><span class=\"number\">264</span>:                 &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// zero-copy</span></div><div class=\"line\"><span class=\"number\">265</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">266</span>:                         FileRegion fileRegion = <span class=\"keyword\">new</span> ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);</div><div class=\"line\"><span class=\"number\">267</span>:                         channel.writeAndFlush(fileRegion).addListener(<span class=\"keyword\">new</span> ChannelFutureListener() &#123;</div><div class=\"line\"><span class=\"number\">268</span>:                             <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">269</span>:                             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">operationComplete</span><span class=\"params\">(ChannelFuture future)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</div><div class=\"line\"><span class=\"number\">270</span>:                                 getMessageResult.release();</div><div class=\"line\"><span class=\"number\">271</span>:                                 <span class=\"keyword\">if</span> (!future.isSuccess()) &#123;</div><div class=\"line\"><span class=\"number\">272</span>:                                     LOG.error(<span class=\"string\">\"Fail to transfer messages from page cache to &#123;&#125;\"</span>, channel.remoteAddress(), future.cause());</div><div class=\"line\"><span class=\"number\">273</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">274</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">275</span>:                         &#125;);</div><div class=\"line\"><span class=\"number\">276</span>:                     &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">277</span>:                         LOG.error(<span class=\"string\">\"Error occurred when transferring messages from page cache\"</span>, e);</div><div class=\"line\"><span class=\"number\">278</span>:                         getMessageResult.release();</div><div class=\"line\"><span class=\"number\">279</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">280</span>: </div><div class=\"line\"><span class=\"number\">281</span>:                     response = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">282</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">283</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">284</span>:             <span class=\"keyword\">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class=\"line\"><span class=\"number\">285</span>:                 <span class=\"comment\">// æ¶ˆæ¯æœªæŸ¥è¯¢åˆ° &amp;&amp; brokerå…è®¸æŒ‚èµ·è¯·æ±‚ &amp;&amp; è¯·æ±‚å…è®¸æŒ‚èµ·</span></div><div class=\"line\"><span class=\"number\">286</span>:                 <span class=\"keyword\">if</span> (brokerAllowSuspend &amp;&amp; hasSuspendFlag) &#123;</div><div class=\"line\"><span class=\"number\">287</span>:                     <span class=\"keyword\">long</span> pollingTimeMills = suspendTimeoutMillisLong;</div><div class=\"line\"><span class=\"number\">288</span>:                     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</div><div class=\"line\"><span class=\"number\">289</span>:                         pollingTimeMills = <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills();</div><div class=\"line\"><span class=\"number\">290</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">291</span>: </div><div class=\"line\"><span class=\"number\">292</span>:                     String topic = requestHeader.getTopic();</div><div class=\"line\"><span class=\"number\">293</span>:                     <span class=\"keyword\">long</span> offset = requestHeader.getQueueOffset();</div><div class=\"line\"><span class=\"number\">294</span>:                     <span class=\"keyword\">int</span> queueId = requestHeader.getQueueId();</div><div class=\"line\"><span class=\"number\">295</span>:                     PullRequest pullRequest = <span class=\"keyword\">new</span> PullRequest(request, channel, pollingTimeMills,</div><div class=\"line\"><span class=\"number\">296</span>:                         <span class=\"keyword\">this</span>.brokerController.getMessageStore().now(), offset, subscriptionData);</div><div class=\"line\"><span class=\"number\">297</span>:                     <span class=\"keyword\">this</span>.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);</div><div class=\"line\"><span class=\"number\">298</span>:                     response = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">299</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">300</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">301</span>: </div><div class=\"line\"><span class=\"number\">302</span>:             <span class=\"keyword\">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class=\"line\"><span class=\"number\">303</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">304</span>:             <span class=\"keyword\">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class=\"line\"><span class=\"number\">305</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE</div><div class=\"line\"><span class=\"number\">306</span>:                     || <span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) &#123; <span class=\"comment\">// TODO å¾…åšå®¢è¡¥å……</span></div><div class=\"line\"><span class=\"number\">307</span>:                     MessageQueue mq = <span class=\"keyword\">new</span> MessageQueue();</div><div class=\"line\"><span class=\"number\">308</span>:                     mq.setTopic(requestHeader.getTopic());</div><div class=\"line\"><span class=\"number\">309</span>:                     mq.setQueueId(requestHeader.getQueueId());</div><div class=\"line\"><span class=\"number\">310</span>:                     mq.setBrokerName(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerName());</div><div class=\"line\"><span class=\"number\">311</span>: </div><div class=\"line\"><span class=\"number\">312</span>:                     OffsetMovedEvent event = <span class=\"keyword\">new</span> OffsetMovedEvent();</div><div class=\"line\"><span class=\"number\">313</span>:                     event.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class=\"line\"><span class=\"number\">314</span>:                     event.setMessageQueue(mq);</div><div class=\"line\"><span class=\"number\">315</span>:                     event.setOffsetRequest(requestHeader.getQueueOffset());</div><div class=\"line\"><span class=\"number\">316</span>:                     event.setOffsetNew(getMessageResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">317</span>:                     <span class=\"keyword\">this</span>.generateOffsetMovedEvent(event);</div><div class=\"line\"><span class=\"number\">318</span>:                     LOG.warn(</div><div class=\"line\"><span class=\"number\">319</span>:                         <span class=\"string\">\"PULL_OFFSET_MOVED:correction offset. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, newOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">320</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),</div><div class=\"line\"><span class=\"number\">321</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class=\"line\"><span class=\"number\">322</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">323</span>:                     responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class=\"line\"><span class=\"number\">324</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class=\"line\"><span class=\"number\">325</span>:                     LOG.warn(<span class=\"string\">\"PULL_OFFSET_MOVED:none correction. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">326</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),</div><div class=\"line\"><span class=\"number\">327</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class=\"line\"><span class=\"number\">328</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">329</span>: </div><div class=\"line\"><span class=\"number\">330</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">331</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">332</span>:                 <span class=\"keyword\">assert</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">333</span>:         &#125;</div><div class=\"line\"><span class=\"number\">334</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">335</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">336</span>:         response.setRemark(<span class=\"string\">\"store getMessage return null\"</span>);</div><div class=\"line\"><span class=\"number\">337</span>:     &#125;</div><div class=\"line\"><span class=\"number\">338</span>: </div><div class=\"line\"><span class=\"number\">339</span>:     <span class=\"comment\">// è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦ &amp;&amp; brokeréä¸»ï¼Œè¿›è¡ŒæŒä¹…åŒ–è¿›åº¦ã€‚</span></div><div class=\"line\"><span class=\"number\">340</span>:     <span class=\"keyword\">boolean</span> storeOffsetEnable = brokerAllowSuspend;</div><div class=\"line\"><span class=\"number\">341</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; hasCommitOffsetFlag;</div><div class=\"line\"><span class=\"number\">342</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; <span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;</div><div class=\"line\"><span class=\"number\">343</span>:     <span class=\"keyword\">if</span> (storeOffsetEnable) &#123;</div><div class=\"line\"><span class=\"number\">344</span>:         <span class=\"keyword\">this</span>.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),</div><div class=\"line\"><span class=\"number\">345</span>:             requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());</div><div class=\"line\"><span class=\"number\">346</span>:     &#125;</div><div class=\"line\"><span class=\"number\">347</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">348</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šå¤„ç†æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œè¿”å›å“åº”ã€‚</li>\n<li>ç¬¬ 14 è‡³ 19 è¡Œ ï¼šæ ¡éªŒ <code>Broker</code> æ˜¯å¦å¯è¯»ã€‚</li>\n<li>ç¬¬ 21 è‡³ 33 è¡Œ ï¼šæ ¡éªŒ <code>SubscriptionGroupConfig</code>(è®¢é˜…åˆ†ç»„é…ç½®) æ˜¯å¦å­˜åœ¨ &amp;&amp; å¯ä»¥æ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šå¤„ç† <code>PullMessageRequestHeader.sysFlag</code> å¯¹åº”çš„æ ‡å¿—ä½ã€‚</li>\n<li>ç¬¬ 40 è‡³ 62 è¡Œ ï¼šæ ¡éªŒ <code>TopicConfig</code>(ä¸»é¢˜é…ç½®) æ˜¯å¦å­˜åœ¨ &amp;&amp; å¯è¯» &amp;&amp; é˜Ÿåˆ—ç¼–å·æ­£ç¡®ã€‚</li>\n<li>ç¬¬ 64 è‡³ 110 è¡Œ ï¼šæ ¡éªŒ <code>SubscriptionData</code>(è®¢é˜…ä¿¡æ¯) æ˜¯å¦æ­£ç¡®ã€‚</li>\n<li>ç¬¬ 113 è¡Œ ï¼šè°ƒç”¨ <code>MessageStore#getMessage(...)</code> è·å– <code>GetMessageResult</code>(æ¶ˆæ¯)ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#messagestoregetmessage\">MessageStore#getMessage(...)</a>ã€‚</li>\n<li>ç¬¬ 122 è‡³ 152 è¡Œ ï¼šè®¡ç®—å»ºè®®æ‹‰å–æ¶ˆæ¯ <code>brokerId</code> ã€‚</li>\n<li>ç¬¬ 154 è‡³ 201 è¡Œ ï¼š<img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/08.png\" alt=\"PullMessageProcessoræ‹‰å–æ¶ˆæ¯çŠ¶æ€å›¾\"></li>\n<li>ç¬¬ 204 è‡³ 244 è¡Œ ï¼š<code>Hook</code> é€»è¾‘ï¼Œ<code>#executeConsumeMessageHookBefore(...)</code> ã€‚</li>\n<li>ç¬¬ 247 è‡³ 283 è¡Œ ï¼šæ‹‰å–æ¶ˆæ¯æˆåŠŸï¼Œå³æ‹‰å–åˆ°æ¶ˆæ¯ã€‚\n<ul>\n<li>ç¬¬ 255 è‡³ 263 è¡Œ ï¼šæ–¹å¼ä¸€ ï¼šè°ƒç”¨ <code>readGetMessageResult(...)</code> è·å–æ¶ˆæ¯å†…å®¹åˆ°å †å†…å†…å­˜ï¼Œè®¾ç½®åˆ° å“åº”<code>body</code>ã€‚</li>\n<li>ç¬¬ 265 è‡³ 281 è¡Œ ï¼šæ–¹å¼äºŒ ï¼šåŸºäº <code>zero-copy</code> å®ç°ï¼Œç›´æ¥å“åº”ï¼Œæ— éœ€å †å†…å†…å­˜ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚<em>TODO ï¼šæ­¤å¤„ç­‰å¯¹zero-copyæœ‰ç ”ç©¶ï¼Œå†è¡¥å……ä¸€äº›</em>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 284 è‡³ 300 è¡Œ ï¼šæ‹‰å–ä¸åˆ°æ¶ˆæ¯ï¼Œå½“æ»¡è¶³æ¡ä»¶ (<code>Broker</code> å…è®¸æŒ‚èµ· &amp;&amp; è¯·æ±‚è¦æ±‚æŒ‚èµ·)ï¼Œæ‰§è¡ŒæŒ‚èµ·è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#pullrequestholdservice\">PullRequestHoldService</a>ã€‚</li>\n<li>ç¬¬ 304 è‡³ 328 è¡Œ ï¼š<em>TODO ï¼šæ­¤å¤„ç­‰å¯¹<code>tools</code>æ¨¡å—ç ”ç©¶åå†è¡¥å……</em>ã€‚</li>\n<li>ç¬¬ 339 è‡³ 346 ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå½“æ»¡è¶³ (<code>Broker</code> éä¸» &amp;&amp; è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦)ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#3broker-%E6%8F%90%E4%BE%9B%E6%9B%B4%E6%96%B0%E6%B6%88%E8%B4%B9%E8%BF%9B%E5%BA%A6%E6%8E%A5%E5%8F%A3\">æ›´æ–°æ¶ˆè´¹è¿›åº¦</a>ã€‚</li>\n</ul>\n<h2>MessageStore#getMessage(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  2:  * è·å–æ¶ˆæ¯ç»“æœ</div><div class=\"line\">  3:  *</div><div class=\"line\">  4:  * <span class=\"doctag\">@param</span> group æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> offset é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">  8:  * <span class=\"doctag\">@param</span> maxMsgNums æ¶ˆæ¯æ•°é‡</div><div class=\"line\">  9:  * <span class=\"doctag\">@param</span> subscriptionData è®¢é˜…ä¿¡æ¯</div><div class=\"line\"> 10:  * <span class=\"doctag\">@return</span> æ¶ˆæ¯ç»“æœ</div><div class=\"line\"> 11:  */</div><div class=\"line\"> <span class=\"number\">12</span>: <span class=\"function\"><span class=\"keyword\">public</span> GetMessageResult <span class=\"title\">getMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> String group, <span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxMsgNums,</span></span></div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">final</span> SubscriptionData subscriptionData) &#123;</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">// æ˜¯å¦å…³é—­</span></div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.shutdown) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:         log.warn(<span class=\"string\">\"message store has shutdown, so getMessage is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"comment\">// æ˜¯å¦å¯è¯»</span></div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.runningFlags.isReadable()) &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:         log.warn(<span class=\"string\">\"message store is not readable, so getMessage is forbidden \"</span> + <span class=\"keyword\">this</span>.runningFlags.getFlagBits());</div><div class=\"line\"> <span class=\"number\">22</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">23</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:     <span class=\"keyword\">long</span> beginTime = <span class=\"keyword\">this</span>.getSystemClock().now();</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:     GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"keyword\">long</span> nextBeginOffset = offset;</div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">long</span> minOffset = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">30</span>:     <span class=\"keyword\">long</span> maxOffset = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">31</span>: </div><div class=\"line\"> <span class=\"number\">32</span>:     GetMessageResult getResult = <span class=\"keyword\">new</span> GetMessageResult();</div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> maxOffsetPy = <span class=\"keyword\">this</span>.commitLog.getMaxOffset();</div><div class=\"line\"> <span class=\"number\">35</span>: </div><div class=\"line\"> <span class=\"number\">36</span>:     <span class=\"comment\">// è·å–æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">37</span>:     ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);</div><div class=\"line\"> <span class=\"number\">38</span>:     <span class=\"keyword\">if</span> (consumeQueue != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">39</span>:         minOffset = consumeQueue.getMinOffsetInQueue(); <span class=\"comment\">// æ¶ˆè´¹é˜Ÿåˆ— æœ€å°é˜Ÿåˆ—ç¼–å·</span></div><div class=\"line\"> <span class=\"number\">40</span>:         maxOffset = consumeQueue.getMaxOffsetInQueue(); <span class=\"comment\">// æ¶ˆè´¹é˜Ÿåˆ— æœ€å¤§é˜Ÿåˆ—ç¼–å·</span></div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:         <span class=\"comment\">// åˆ¤æ–­ é˜Ÿåˆ—ä½ç½®(offset)</span></div><div class=\"line\"> <span class=\"number\">43</span>:         <span class=\"keyword\">if</span> (maxOffset == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// æ¶ˆè´¹é˜Ÿåˆ—æ— æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">44</span>:             status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class=\"line\"> <span class=\"number\">45</span>:             nextBeginOffset = nextOffsetCorrection(offset, <span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">46</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offset &lt; minOffset) &#123; <span class=\"comment\">// æŸ¥è¯¢offset å¤ªå°</span></div><div class=\"line\"> <span class=\"number\">47</span>:             status = GetMessageStatus.OFFSET_TOO_SMALL;</div><div class=\"line\"> <span class=\"number\">48</span>:             nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class=\"line\"> <span class=\"number\">49</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offset == maxOffset) &#123; <span class=\"comment\">// æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— ä¸€ä¸ªä½ç½®</span></div><div class=\"line\"> <span class=\"number\">50</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_ONE;</div><div class=\"line\"> <span class=\"number\">51</span>:             nextBeginOffset = nextOffsetCorrection(offset, offset);</div><div class=\"line\"> <span class=\"number\">52</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offset &gt; maxOffset) &#123; <span class=\"comment\">// æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— å¤ªå¤š(å¤§äºä¸€ä¸ªä½ç½®)</span></div><div class=\"line\"> <span class=\"number\">53</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;</div><div class=\"line\"> <span class=\"number\">54</span>:             <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == minOffset) &#123; <span class=\"comment\">// TODO blog è¿™é‡Œæ˜¯ï¼Ÿï¼Ÿä¸ºå•¥0 == minOffsetåšäº†ç‰¹æ®Šåˆ¤æ–­</span></div><div class=\"line\"> <span class=\"number\">55</span>:                 nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class=\"line\"> <span class=\"number\">56</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">57</span>:                 nextBeginOffset = nextOffsetCorrection(offset, maxOffset);</div><div class=\"line\"> <span class=\"number\">58</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">59</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:             <span class=\"comment\">// è·å¾— æ˜ å°„Bufferç»“æœ(MappedFile)</span></div><div class=\"line\"> <span class=\"number\">61</span>:             SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);</div><div class=\"line\"> <span class=\"number\">62</span>:             <span class=\"keyword\">if</span> (bufferConsumeQueue != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">64</span>:                     status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:                     <span class=\"keyword\">long</span> nextPhyFileStartOffset = Long.MIN_VALUE; <span class=\"comment\">// commitLogä¸‹ä¸€ä¸ªæ–‡ä»¶(MappedFile)å¯¹åº”çš„å¼€å§‹offsetã€‚</span></div><div class=\"line\"> <span class=\"number\">67</span>:                     <span class=\"keyword\">long</span> maxPhyOffsetPulling = <span class=\"number\">0</span>; <span class=\"comment\">// æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset</span></div><div class=\"line\"> <span class=\"number\">68</span>: </div><div class=\"line\"> <span class=\"number\">69</span>:                     <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">70</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxFilterMessageCount = <span class=\"number\">16000</span>;</div><div class=\"line\"> <span class=\"number\">71</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> diskFallRecorded = <span class=\"keyword\">this</span>.messageStoreConfig.isDiskFallRecorded();</div><div class=\"line\"> <span class=\"number\">72</span>:                     <span class=\"comment\">// å¾ªç¯è·å– æ¶ˆæ¯ä½ç½®ä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">73</span>:                     <span class=\"keyword\">for</span> (; i &lt; bufferConsumeQueue.getSize() &amp;&amp; i &lt; maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:                         <span class=\"keyword\">long</span> offsetPy = bufferConsumeQueue.getByteBuffer().getLong(); <span class=\"comment\">// æ¶ˆæ¯ç‰©ç†ä½ç½®offset</span></div><div class=\"line\"> <span class=\"number\">75</span>:                         <span class=\"keyword\">int</span> sizePy = bufferConsumeQueue.getByteBuffer().getInt(); <span class=\"comment\">// æ¶ˆæ¯é•¿åº¦</span></div><div class=\"line\"> <span class=\"number\">76</span>:                         <span class=\"keyword\">long</span> tagsCode = bufferConsumeQueue.getByteBuffer().getLong(); <span class=\"comment\">// æ¶ˆæ¯tagsCode</span></div><div class=\"line\"> <span class=\"number\">77</span>:                         <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset</span></div><div class=\"line\"> <span class=\"number\">78</span>:                         maxPhyOffsetPulling = offsetPy;</div><div class=\"line\"> <span class=\"number\">79</span>:                         <span class=\"comment\">// å½“ offsetPy å°äº nextPhyFileStartOffset æ—¶ï¼Œæ„å‘³ç€å¯¹åº”çš„ Message å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„Messageã€‚</span></div><div class=\"line\"> <span class=\"number\">80</span>:                         <span class=\"keyword\">if</span> (nextPhyFileStartOffset != Long.MIN_VALUE) &#123;</div><div class=\"line\"> <span class=\"number\">81</span>:                             <span class=\"keyword\">if</span> (offsetPy &lt; nextPhyFileStartOffset)</div><div class=\"line\"> <span class=\"number\">82</span>:                                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">83</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">84</span>:                         <span class=\"comment\">// æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜</span></div><div class=\"line\"> <span class=\"number\">85</span>:                         <span class=\"keyword\">boolean</span> isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);</div><div class=\"line\"> <span class=\"number\">86</span>:                         <span class=\"comment\">// æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿæ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">87</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),</div><div class=\"line\"> <span class=\"number\">88</span>:                             isInDisk)) &#123;</div><div class=\"line\"> <span class=\"number\">89</span>:                             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">90</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">91</span>:                         <span class=\"comment\">// åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶</span></div><div class=\"line\"> <span class=\"number\">92</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.messageFilter.isMessageMatched(subscriptionData, tagsCode)) &#123;</div><div class=\"line\"> <span class=\"number\">93</span>:                             <span class=\"comment\">// ä»commitLogè·å–å¯¹åº”æ¶ˆæ¯ByteBuffer</span></div><div class=\"line\"> <span class=\"number\">94</span>:                             SelectMappedBufferResult selectResult = <span class=\"keyword\">this</span>.commitLog.getMessage(offsetPy, sizePy);</div><div class=\"line\"> <span class=\"number\">95</span>:                             <span class=\"keyword\">if</span> (selectResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:                                 <span class=\"keyword\">this</span>.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();</div><div class=\"line\"> <span class=\"number\">97</span>:                                 getResult.addMessage(selectResult);</div><div class=\"line\"> <span class=\"number\">98</span>:                                 status = GetMessageStatus.FOUND;</div><div class=\"line\"> <span class=\"number\">99</span>:                                 nextPhyFileStartOffset = Long.MIN_VALUE;</div><div class=\"line\"><span class=\"number\">100</span>:                             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">101</span>:                                 <span class=\"comment\">// ä»commitLogæ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶ï¼ˆMappedFileï¼‰å·²ç»åˆ é™¤ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªMappedFileçš„èµ·å§‹ä½ç½®</span></div><div class=\"line\"><span class=\"number\">102</span>:                                 <span class=\"keyword\">if</span> (getResult.getBufferTotalSize() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">103</span>:                                     status = GetMessageStatus.MESSAGE_WAS_REMOVING;</div><div class=\"line\"><span class=\"number\">104</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">105</span>:                                 nextPhyFileStartOffset = <span class=\"keyword\">this</span>.commitLog.rollNextFile(offsetPy);</div><div class=\"line\"><span class=\"number\">106</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">107</span>:                         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">108</span>:                             <span class=\"keyword\">if</span> (getResult.getBufferTotalSize() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">109</span>:                                 status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class=\"line\"><span class=\"number\">110</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">111</span>: </div><div class=\"line\"><span class=\"number\">112</span>:                             <span class=\"keyword\">if</span> (log.isDebugEnabled()) &#123;</div><div class=\"line\"><span class=\"number\">113</span>:                                 log.debug(<span class=\"string\">\"message type not matched, client: \"</span> + subscriptionData + <span class=\"string\">\" server: \"</span> + tagsCode);</div><div class=\"line\"><span class=\"number\">114</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">115</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">116</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">117</span>:                     <span class=\"comment\">// ç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°</span></div><div class=\"line\"><span class=\"number\">118</span>:                     <span class=\"keyword\">if</span> (diskFallRecorded) &#123;</div><div class=\"line\"><span class=\"number\">119</span>:                         <span class=\"keyword\">long</span> fallBehind = maxOffsetPy - maxPhyOffsetPulling;</div><div class=\"line\"><span class=\"number\">120</span>:                         brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);</div><div class=\"line\"><span class=\"number\">121</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">122</span>:                     <span class=\"comment\">// è®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</span></div><div class=\"line\"><span class=\"number\">123</span>:                     nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class=\"line\"><span class=\"number\">124</span>:                     <span class=\"comment\">// æ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹</span></div><div class=\"line\"><span class=\"number\">125</span>:                     <span class=\"keyword\">long</span> diff = maxOffsetPy - maxPhyOffsetPulling;</div><div class=\"line\"><span class=\"number\">126</span>:                     <span class=\"keyword\">long</span> memory = (<span class=\"keyword\">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE</div><div class=\"line\"><span class=\"number\">127</span>:                             * (<span class=\"keyword\">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class=\"number\">100.0</span>));</div><div class=\"line\"><span class=\"number\">128</span>:                     getResult.setSuggestPullingFromSlave(diff &gt; memory);</div><div class=\"line\"><span class=\"number\">129</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">130</span>:                     bufferConsumeQueue.release();</div><div class=\"line\"><span class=\"number\">131</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">132</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">133</span>:                 status = GetMessageStatus.OFFSET_FOUND_NULL;</div><div class=\"line\"><span class=\"number\">134</span>:                 nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));</div><div class=\"line\"><span class=\"number\">135</span>:                 log.warn(<span class=\"string\">\"consumer request topic: \"</span> + topic + <span class=\"string\">\"offset: \"</span> + offset + <span class=\"string\">\" minOffset: \"</span> + minOffset + <span class=\"string\">\" maxOffset: \"</span></div><div class=\"line\"><span class=\"number\">136</span>:                     + maxOffset + <span class=\"string\">\", but access logic queue failed.\"</span>);</div><div class=\"line\"><span class=\"number\">137</span>:             &#125;</div><div class=\"line\"><span class=\"number\">138</span>:         &#125;</div><div class=\"line\"><span class=\"number\">139</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">140</span>:         status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;</div><div class=\"line\"><span class=\"number\">141</span>:         nextBeginOffset = nextOffsetCorrection(offset, <span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">142</span>:     &#125;</div><div class=\"line\"><span class=\"number\">143</span>:     <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"><span class=\"number\">144</span>:     <span class=\"keyword\">if</span> (GetMessageStatus.FOUND == status) &#123;</div><div class=\"line\"><span class=\"number\">145</span>:         <span class=\"keyword\">this</span>.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();</div><div class=\"line\"><span class=\"number\">146</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">147</span>:         <span class=\"keyword\">this</span>.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();</div><div class=\"line\"><span class=\"number\">148</span>:     &#125;</div><div class=\"line\"><span class=\"number\">149</span>:     <span class=\"keyword\">long</span> eclipseTime = <span class=\"keyword\">this</span>.getSystemClock().now() - beginTime;</div><div class=\"line\"><span class=\"number\">150</span>:     <span class=\"keyword\">this</span>.storeStatsService.setGetMessageEntireTimeMax(eclipseTime);</div><div class=\"line\"><span class=\"number\">151</span>:     <span class=\"comment\">// è®¾ç½®è¿”å›ç»“æœ</span></div><div class=\"line\"><span class=\"number\">152</span>:     getResult.setStatus(status);</div><div class=\"line\"><span class=\"number\">153</span>:     getResult.setNextBeginOffset(nextBeginOffset);</div><div class=\"line\"><span class=\"number\">154</span>:     getResult.setMaxOffset(maxOffset);</div><div class=\"line\"><span class=\"number\">155</span>:     getResult.setMinOffset(minOffset);</div><div class=\"line\"><span class=\"number\">156</span>:     <span class=\"keyword\">return</span> getResult;</div><div class=\"line\"><span class=\"number\">157</span>: &#125;</div><div class=\"line\"><span class=\"number\">158</span>: </div><div class=\"line\"><span class=\"number\">159</span>: <span class=\"comment\">/**</span></div><div class=\"line\">160:  * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· è·å– æ¶ˆè´¹é˜Ÿåˆ—</div><div class=\"line\">161:  *</div><div class=\"line\">162:  * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">163:  * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">164:  * <span class=\"doctag\">@return</span> æ¶ˆè´¹é˜Ÿåˆ—</div><div class=\"line\">165:  */</div><div class=\"line\"><span class=\"number\">166</span>: <span class=\"function\"><span class=\"keyword\">public</span> ConsumeQueue <span class=\"title\">findConsumeQueue</span><span class=\"params\">(String topic, <span class=\"keyword\">int</span> queueId)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">167</span>:     <span class=\"comment\">// è·å– topic å¯¹åº”çš„ æ‰€æœ‰æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">168</span>:     ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; map = consumeQueueTable.get(topic);</div><div class=\"line\"><span class=\"number\">169</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == map) &#123;</div><div class=\"line\"><span class=\"number\">170</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; newMap = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">128</span>);</div><div class=\"line\"><span class=\"number\">171</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; oldMap = consumeQueueTable.putIfAbsent(topic, newMap);</div><div class=\"line\"><span class=\"number\">172</span>:         <span class=\"keyword\">if</span> (oldMap != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">173</span>:             map = oldMap;</div><div class=\"line\"><span class=\"number\">174</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">175</span>:             map = newMap;</div><div class=\"line\"><span class=\"number\">176</span>:         &#125;</div><div class=\"line\"><span class=\"number\">177</span>:     &#125;</div><div class=\"line\"><span class=\"number\">178</span>:     <span class=\"comment\">// è·å– queueId å¯¹åº”çš„ æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">179</span>:     ConsumeQueue logic = map.get(queueId);</div><div class=\"line\"><span class=\"number\">180</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == logic) &#123;</div><div class=\"line\"><span class=\"number\">181</span>:         ConsumeQueue newLogic = <span class=\"keyword\">new</span> ConsumeQueue(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">182</span>:             topic, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">183</span>:             queueId, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">184</span>:             StorePathConfigHelper.getStorePathConsumeQueue(<span class=\"keyword\">this</span>.messageStoreConfig.getStorePathRootDir()), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">185</span>:             <span class=\"keyword\">this</span>.getMessageStoreConfig().getMapedFileSizeConsumeQueue(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">186</span>:             <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">187</span>:         ConsumeQueue oldLogic = map.putIfAbsent(queueId, newLogic);</div><div class=\"line\"><span class=\"number\">188</span>:         <span class=\"keyword\">if</span> (oldLogic != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">189</span>:             logic = oldLogic;</div><div class=\"line\"><span class=\"number\">190</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">191</span>:             logic = newLogic;</div><div class=\"line\"><span class=\"number\">192</span>:         &#125;</div><div class=\"line\"><span class=\"number\">193</span>:     &#125;</div><div class=\"line\"><span class=\"number\">194</span>: </div><div class=\"line\"><span class=\"number\">195</span>:     <span class=\"keyword\">return</span> logic;</div><div class=\"line\"><span class=\"number\">196</span>: &#125;</div><div class=\"line\"><span class=\"number\">197</span>: </div><div class=\"line\"><span class=\"number\">198</span>: <span class=\"comment\">/**</span></div><div class=\"line\">199:  * ä¸‹ä¸€ä¸ªè·å–é˜Ÿåˆ—offsetä¿®æ­£</div><div class=\"line\">200:  * ä¿®æ­£æ¡ä»¶ï¼šä¸»èŠ‚ç‚¹ æˆ–è€… ä»èŠ‚ç‚¹å¼€å¯æ ¡éªŒoffsetå¼€å…³</div><div class=\"line\">201:  *</div><div class=\"line\">202:  * <span class=\"doctag\">@param</span> oldOffset è€é˜Ÿåˆ—offset</div><div class=\"line\">203:  * <span class=\"doctag\">@param</span> newOffset æ–°é˜Ÿåˆ—offset</div><div class=\"line\">204:  * <span class=\"doctag\">@return</span> ä¿®æ­£åçš„é˜Ÿåˆ—offset</div><div class=\"line\">205:  */</div><div class=\"line\"><span class=\"number\">206</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">nextOffsetCorrection</span><span class=\"params\">(<span class=\"keyword\">long</span> oldOffset, <span class=\"keyword\">long</span> newOffset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">207</span>:     <span class=\"keyword\">long</span> nextOffset = oldOffset;</div><div class=\"line\"><span class=\"number\">208</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE || <span class=\"keyword\">this</span>.getMessageStoreConfig().isOffsetCheckInSlave()) &#123;</div><div class=\"line\"><span class=\"number\">209</span>:         nextOffset = newOffset;</div><div class=\"line\"><span class=\"number\">210</span>:     &#125;</div><div class=\"line\"><span class=\"number\">211</span>:     <span class=\"keyword\">return</span> nextOffset;</div><div class=\"line\"><span class=\"number\">212</span>: &#125;</div><div class=\"line\"><span class=\"number\">213</span>: </div><div class=\"line\"><span class=\"number\">214</span>: <span class=\"comment\">/**</span></div><div class=\"line\">215:  * æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜</div><div class=\"line\">216:  *</div><div class=\"line\">217:  * <span class=\"doctag\">@param</span> offsetPy commitLog æŒ‡å®šoffset</div><div class=\"line\">218:  * <span class=\"doctag\">@param</span> maxOffsetPy commitLog æœ€å¤§offset</div><div class=\"line\">219:  * <span class=\"doctag\">@return</span> æ˜¯å¦éœ€è¦ç¡¬ç›˜</div><div class=\"line\">220:  */</div><div class=\"line\"><span class=\"number\">221</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">checkInDiskByCommitOffset</span><span class=\"params\">(<span class=\"keyword\">long</span> offsetPy, <span class=\"keyword\">long</span> maxOffsetPy)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">222</span>:     <span class=\"keyword\">long</span> memory = (<span class=\"keyword\">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE * (<span class=\"keyword\">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class=\"number\">100.0</span>));</div><div class=\"line\"><span class=\"number\">223</span>:     <span class=\"keyword\">return</span> (maxOffsetPy - offsetPy) &gt; memory;</div><div class=\"line\"><span class=\"number\">224</span>: &#125;</div><div class=\"line\"><span class=\"number\">225</span>: </div><div class=\"line\"><span class=\"number\">226</span>: <span class=\"comment\">/**</span></div><div class=\"line\">227:  * åˆ¤æ–­è·å–æ¶ˆæ¯æ˜¯å¦å·²ç»æ»¡</div><div class=\"line\">228:  *</div><div class=\"line\">229:  * <span class=\"doctag\">@param</span> sizePy å­—èŠ‚æ•°</div><div class=\"line\">230:  * <span class=\"doctag\">@param</span> maxMsgNums æœ€å¤§æ¶ˆæ¯æ•°</div><div class=\"line\">231:  * <span class=\"doctag\">@param</span> bufferTotal ç›®å‰å·²ç»è®¡ç®—å­—èŠ‚æ•°</div><div class=\"line\">232:  * <span class=\"doctag\">@param</span> messageTotal ç›®å‰å·²ç»è®¡ç®—æ¶ˆæ¯æ•°</div><div class=\"line\">233:  * <span class=\"doctag\">@param</span> isInDisk æ˜¯å¦åœ¨ç¡¬ç›˜ä¸­</div><div class=\"line\">234:  * <span class=\"doctag\">@return</span> æ˜¯å¦å·²æ»¡</div><div class=\"line\">235:  */</div><div class=\"line\"><span class=\"number\">236</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isTheBatchFull</span><span class=\"params\">(<span class=\"keyword\">int</span> sizePy, <span class=\"keyword\">int</span> maxMsgNums, <span class=\"keyword\">int</span> bufferTotal, <span class=\"keyword\">int</span> messageTotal, <span class=\"keyword\">boolean</span> isInDisk)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">237</span>:     <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == bufferTotal || <span class=\"number\">0</span> == messageTotal) &#123;</div><div class=\"line\"><span class=\"number\">238</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">239</span>:     &#125;</div><div class=\"line\"><span class=\"number\">240</span>:     <span class=\"comment\">// æ¶ˆæ¯æ•°é‡å·²ç»æ»¡è¶³è¯·æ±‚æ•°é‡(maxMsgNums)</span></div><div class=\"line\"><span class=\"number\">241</span>:     <span class=\"keyword\">if</span> ((messageTotal + <span class=\"number\">1</span>) &gt;= maxMsgNums) &#123;</div><div class=\"line\"><span class=\"number\">242</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">243</span>:     &#125;</div><div class=\"line\"><span class=\"number\">244</span>:     <span class=\"comment\">// æ ¹æ®æ¶ˆæ¯å­˜å‚¨é…ç½®çš„æœ€å¤§ä¼ è¾“å­—èŠ‚æ•°ã€æœ€å¤§ä¼ è¾“æ¶ˆæ¯æ•°æ˜¯å¦å·²æ»¡</span></div><div class=\"line\"><span class=\"number\">245</span>:     <span class=\"keyword\">if</span> (isInDisk) &#123;</div><div class=\"line\"><span class=\"number\">246</span>:         <span class=\"keyword\">if</span> ((bufferTotal + sizePy) &gt; <span class=\"keyword\">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInDisk()) &#123;</div><div class=\"line\"><span class=\"number\">247</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">248</span>:         &#125;</div><div class=\"line\"><span class=\"number\">249</span>: </div><div class=\"line\"><span class=\"number\">250</span>:         <span class=\"keyword\">if</span> ((messageTotal + <span class=\"number\">1</span>) &gt; <span class=\"keyword\">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInDisk()) &#123;</div><div class=\"line\"><span class=\"number\">251</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">252</span>:         &#125;</div><div class=\"line\"><span class=\"number\">253</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">254</span>:         <span class=\"keyword\">if</span> ((bufferTotal + sizePy) &gt; <span class=\"keyword\">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInMemory()) &#123;</div><div class=\"line\"><span class=\"number\">255</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">256</span>:         &#125;</div><div class=\"line\"><span class=\"number\">257</span>: </div><div class=\"line\"><span class=\"number\">258</span>:         <span class=\"keyword\">if</span> ((messageTotal + <span class=\"number\">1</span>) &gt; <span class=\"keyword\">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInMemory()) &#123;</div><div class=\"line\"><span class=\"number\">259</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">260</span>:         &#125;</div><div class=\"line\"><span class=\"number\">261</span>:     &#125;</div><div class=\"line\"><span class=\"number\">262</span>: </div><div class=\"line\"><span class=\"number\">263</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">264</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ ¹æ® æ¶ˆæ¯åˆ†ç»„(<code>group</code>) + ä¸»é¢˜(<code>Topic</code>) + é˜Ÿåˆ—ç¼–å·(<code>queueId</code>) + é˜Ÿåˆ—ä½ç½®(<code>offset</code>) + è®¢é˜…ä¿¡æ¯(<code>subscriptionData</code>) è·å– æŒ‡å®šæ¡æ•°(<code>maxMsgNums</code>) æ¶ˆæ¯(<code>Message</code>)ã€‚</li>\n<li>ç¬¬ 14 è‡³ 18 è¡Œ ï¼šåˆ¤æ–­ <code>Store</code> æ˜¯å¦å¤„äºå…³é—­çŠ¶æ€ï¼Œè‹¥å…³é—­ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 19 è‡³ 23 è¡Œ ï¼šåˆ¤æ–­å½“å‰è¿è¡ŒçŠ¶æ€æ˜¯å¦å¯è¯»ï¼Œè‹¥ä¸å¯è¯»ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 37 è¡Œ ï¼šæ ¹æ® ä¸»é¢˜(<code>Topic</code>) + é˜Ÿåˆ—ç¼–å·(<code>queueId</code>) è·å– æ¶ˆæ¯é˜Ÿåˆ—(<code>ConsumeQueue</code>)ã€‚\n<ul>\n<li><code>#findConsumeQueue(...)</code> ï¼šç¬¬ 159 è‡³ 196 è¡Œã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 43 è‡³ 58 è¡Œ ï¼šå„ç§é˜Ÿåˆ—ä½ç½®(<code>offset</code>) æ— æ³•è¯»å–æ¶ˆæ¯ï¼Œå¹¶é’ˆå¯¹å¯¹åº”çš„æƒ…å†µï¼Œè®¡ç®—ä¸‹ä¸€æ¬¡ <code>Client</code> é˜Ÿåˆ—æ‹‰å–ä½ç½®ã€‚\n<ul>\n<li>ç¬¬ 43 è‡³ 45 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 46 è‡³ 48 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ å¤ªå°ã€‚</li>\n<li>ç¬¬ 49 è‡³ 51 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ æ°å¥½ç­‰äº æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§çš„é˜Ÿåˆ—ä½ç½®ã€‚è¯¥æƒ…å†µæ˜¯æ­£å¸¸ç°è±¡ï¼Œç›¸å½“äºæŸ¥è¯¢æœ€æ–°çš„æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 52 è‡³ 58 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ è¶…è¿‡è¿‡å¤šã€‚</li>\n<li><code>#nextOffsetCorrection(...)</code> ï¼šç¬¬ 198 è‡³ 212 è¡Œã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 61 è¡Œ ï¼šæ ¹æ® æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(<code>offset</code>) è·å– å¯¹åº”çš„<code>MappedFile</code>ã€‚</li>\n<li>ç¬¬ 72 è‡³ 128 è¡Œ ï¼š<strong>å¾ªç¯</strong>è·å– <code>æ¶ˆæ¯ä½ç½®ä¿¡æ¯</code>ã€‚\n<ul>\n<li>ç¬¬ 74 è‡³ 76 è¡Œ ï¼šè¯»å–æ¯ä¸€ä¸ª <code>æ¶ˆæ¯ä½ç½®ä¿¡æ¯</code>ã€‚</li>\n<li>ç¬¬ 79 è‡³ 83 è¡Œ ï¼šå½“ <code>offsetPy</code> å°äº <code>nextPhyFileStartOffset</code> æ—¶ï¼Œæ„å‘³ç€å¯¹\nåº”çš„ <code>Message</code> å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„ <code>Message</code>ã€‚</li>\n<li>ç¬¬ 84 è‡³ 90 è¡Œ ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿçš„æ¶ˆæ¯ã€‚\n<ul>\n<li><code>#checkInDiskByCommitOffset(...)</code> ï¼šç¬¬ 214 è‡³ 224 è¡Œã€‚</li>\n<li><code>#isTheBatchFull(...)</code> ï¼šç¬¬ 226 è‡³ 264 è¡Œã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ç¬¬ 92 è¡Œ ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"defaultmessagefilterismessagematched\">DefaultMessageFilter#isMessageMatched(...)</a>ã€‚</li>\n<li>ç¬¬ 94 è¡Œ ï¼šä» <code>CommitLog</code> è·å–å¯¹åº” æ¶ˆæ¯çš„<code>MappedByteBuffer</code>ã€‚</li>\n<li>ç¬¬ 95 è‡³ 99 è¡Œ ï¼šè·å– <code>æ¶ˆæ¯MappedByteBuffer</code> æˆåŠŸã€‚</li>\n<li>ç¬¬ 100 è‡³ 106 è¡Œ ï¼šè·å– <code>æ¶ˆæ¯MappedByteBuffer</code> å¤±è´¥ã€‚ä» <code>CommitLog</code> æ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜ è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶(<code>MappedFile</code>) å·²ç»åˆ é™¤ï¼Œæ­¤æ—¶è®¡ç®—ä¸‹ä¸€ä¸ª<code>MappedFile</code>çš„èµ·å§‹ä½ç½®ã€‚<strong>è¯¥é€»è¾‘éœ€è¦é…åˆï¼ˆç¬¬ 79 è‡³ 83 è¡Œï¼‰ä¸€èµ·ç†è§£ã€‚</strong></li>\n<li>ç¬¬ 117 è‡³ 120 è¡Œ ï¼šç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ã€‚</li>\n<li>ç¬¬ 123 è¡Œ ï¼šè®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·ã€‚</li>\n<li>ç¬¬ 124 è‡³ 128 è¡Œ ï¼šæ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹ã€‚</li>\n<li>ç¬¬ 130 è¡Œ ï¼šé‡Šæ”¾ <code>bufferConsumeQueue</code> å¯¹ <code>MappedFile</code> çš„æŒ‡å‘ã€‚æ­¤å¤„ <code>MappedFile</code> æ˜¯ <code>ConsumeQueue</code> é‡Œçš„æ–‡ä»¶ï¼Œä¸æ˜¯ <code>CommitLog</code> ä¸‹çš„æ–‡ä»¶ã€‚</li>\n<li>ç¬¬ 133 è‡³ 136 è¡Œ ï¼šè·å¾—æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(<code>offset</code>) è·å– å¯¹åº”çš„<code>MappedFile</code> ä¸º<strong>ç©º</strong>ï¼Œè®¡ç®—<code>ConsumeQueue</code> ä» <code>offset</code> å¼€å§‹çš„ä¸‹ä¸€ä¸ª <code>MappedFile</code> å¯¹åº”çš„ä½ç½®ã€‚</li>\n<li>ç¬¬ 143 è‡³ 150 è¡Œ ï¼šè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼šæ¶ˆè€—æ—¶é—´ã€æ‹‰å–åˆ°æ¶ˆæ¯/æœªæ‹‰å–åˆ°æ¶ˆæ¯æ¬¡æ•°ã€‚</li>\n<li>ç¬¬ 151 è‡³ 156 è¡Œ ï¼šè®¾ç½®è¿”å›ç»“æœå¹¶è¿”å›ã€‚</li>\n</ul>\n<h2>DefaultMessageFilter#isMessageMatched(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultMessageFilter</span> <span class=\"keyword\">implements</span> <span class=\"title\">MessageFilter</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isMessageMatched</span><span class=\"params\">(SubscriptionData subscriptionData, Long tagsCode)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"comment\">// æ¶ˆæ¯tagsCode ç©º</span></div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">if</span> (tagsCode == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">8</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"comment\">// è®¢é˜…æ•°æ® ç©º</span></div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionData) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">12</span>:         &#125;</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"comment\">// classFilter</span></div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">if</span> (subscriptionData.isClassFilterMode())</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"comment\">// è®¢é˜…è¡¨è¾¾å¼ å…¨åŒ¹é…</span></div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">if</span> (subscriptionData.getSubString().equals(SubscriptionData.SUB_ALL)) &#123;</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"comment\">// è®¢é˜…æ•°æ®codeæ•°ç»„ æ˜¯å¦åŒ…å« æ¶ˆæ¯tagsCode</span></div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"keyword\">return</span> subscriptionData.getCodeSet().contains(tagsCode.intValue());</div><div class=\"line\"><span class=\"number\">22</span>:     &#125;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ¶ˆæ¯è¿‡æ»¤å™¨é»˜è®¤å®ç°ã€‚</li>\n</ul>\n<h2>PullRequestHoldService</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PullRequestHoldService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>: </div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class=\"line\">  <span class=\"number\">4</span>: </div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_QUEUEID_SEPARATOR = <span class=\"string\">\"@\"</span>;</div><div class=\"line\">  <span class=\"number\">6</span>: </div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> BrokerController brokerController;</div><div class=\"line\">  <span class=\"number\">8</span>: </div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SystemClock systemClock = <span class=\"keyword\">new</span> SystemClock();</div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 11:      * æ¶ˆæ¯è¿‡æ»¤å™¨</div><div class=\"line\"> 12:      */</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MessageFilter messageFilter = <span class=\"keyword\">new</span> DefaultMessageFilter();</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 15:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é›†åˆ</div><div class=\"line\"> 16:      */</div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"keyword\">private</span> ConcurrentHashMap&lt;String<span class=\"comment\">/* topic@queueId */</span>, ManyPullRequest&gt; pullRequestTable =</div><div class=\"line\"> <span class=\"number\">18</span>:             <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">1024</span>);</div><div class=\"line\"> <span class=\"number\">19</span>: </div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PullRequestHoldService</span><span class=\"params\">(<span class=\"keyword\">final</span> BrokerController brokerController)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"keyword\">this</span>.brokerController = brokerController;</div><div class=\"line\"> <span class=\"number\">22</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">23</span>: </div><div class=\"line\"> <span class=\"number\">24</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 25:      * æ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚</div><div class=\"line\"> 26:      *</div><div class=\"line\"> 27:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\"> 28:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\"> 29:      * <span class=\"doctag\">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 30:      */</div><div class=\"line\"> <span class=\"number\">31</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">suspendPullRequest</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">32</span>:         String key = <span class=\"keyword\">this</span>.buildKey(topic, queueId);</div><div class=\"line\"> <span class=\"number\">33</span>:         ManyPullRequest mpr = <span class=\"keyword\">this</span>.pullRequestTable.get(key);</div><div class=\"line\"> <span class=\"number\">34</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mpr) &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:             mpr = <span class=\"keyword\">new</span> ManyPullRequest();</div><div class=\"line\"> <span class=\"number\">36</span>:             ManyPullRequest prev = <span class=\"keyword\">this</span>.pullRequestTable.putIfAbsent(key, mpr);</div><div class=\"line\"> <span class=\"number\">37</span>:             <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:                 mpr = prev;</div><div class=\"line\"> <span class=\"number\">39</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">40</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:         mpr.addPullRequest(pullRequest);</div><div class=\"line\"> <span class=\"number\">43</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">44</span>: </div><div class=\"line\"> <span class=\"number\">45</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 46:      * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· åˆ›å»ºå”¯ä¸€æ ‡è¯†</div><div class=\"line\"> 47:      *</div><div class=\"line\"> 48:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\"> 49:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\"> 50:      * <span class=\"doctag\">@return</span> key</div><div class=\"line\"> 51:      */</div><div class=\"line\"> <span class=\"number\">52</span>:     <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">buildKey</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">53</span>:         StringBuilder sb = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\"> <span class=\"number\">54</span>:         sb.append(topic);</div><div class=\"line\"> <span class=\"number\">55</span>:         sb.append(TOPIC_QUEUEID_SEPARATOR);</div><div class=\"line\"> <span class=\"number\">56</span>:         sb.append(queueId);</div><div class=\"line\"> <span class=\"number\">57</span>:         <span class=\"keyword\">return</span> sb.toString();</div><div class=\"line\"> <span class=\"number\">58</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">59</span>: </div><div class=\"line\"> <span class=\"number\">60</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">61</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">62</span>:         log.info(<span class=\"string\">\"&#123;&#125; service started\"</span>, <span class=\"keyword\">this</span>.getServiceName());</div><div class=\"line\"> <span class=\"number\">63</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"> <span class=\"number\">64</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">65</span>:                 <span class=\"comment\">// æ ¹æ® é•¿è½®è®­ è¿˜æ˜¯ çŸ­è½®è®­ è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´</span></div><div class=\"line\"> <span class=\"number\">66</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:                     <span class=\"keyword\">this</span>.waitForRunning(<span class=\"number\">5</span> * <span class=\"number\">1000</span>);</div><div class=\"line\"> <span class=\"number\">68</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">69</span>:                     <span class=\"keyword\">this</span>.waitForRunning(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills());</div><div class=\"line\"> <span class=\"number\">70</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">71</span>:                 <span class=\"comment\">// æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„</span></div><div class=\"line\"> <span class=\"number\">72</span>:                 <span class=\"keyword\">long</span> beginLockTimestamp = <span class=\"keyword\">this</span>.systemClock.now();</div><div class=\"line\"> <span class=\"number\">73</span>:                 <span class=\"keyword\">this</span>.checkHoldRequest();</div><div class=\"line\"> <span class=\"number\">74</span>:                 <span class=\"keyword\">long</span> costTime = <span class=\"keyword\">this</span>.systemClock.now() - beginLockTimestamp;</div><div class=\"line\"> <span class=\"number\">75</span>:                 <span class=\"keyword\">if</span> (costTime &gt; <span class=\"number\">5</span> * <span class=\"number\">1000</span>) &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:                     log.info(<span class=\"string\">\"[NOTIFYME] check hold request cost &#123;&#125; ms.\"</span>, costTime);</div><div class=\"line\"> <span class=\"number\">77</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">78</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">79</span>:                 log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"> <span class=\"number\">80</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">81</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">82</span>: </div><div class=\"line\"> <span class=\"number\">83</span>:         log.info(<span class=\"string\">\"&#123;&#125; service end\"</span>, <span class=\"keyword\">this</span>.getServiceName());</div><div class=\"line\"> <span class=\"number\">84</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">85</span>: </div><div class=\"line\"> <span class=\"number\">86</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">87</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">return</span> PullRequestHoldService.class.getSimpleName();</div><div class=\"line\"> <span class=\"number\">89</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">90</span>: </div><div class=\"line\"> <span class=\"number\">91</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 92:      * éå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚</div><div class=\"line\"> 93:      */</div><div class=\"line\"> <span class=\"number\">94</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">checkHoldRequest</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">95</span>:         <span class=\"keyword\">for</span> (String key : <span class=\"keyword\">this</span>.pullRequestTable.keySet()) &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:             String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);</div><div class=\"line\"> <span class=\"number\">97</span>:             <span class=\"keyword\">if</span> (<span class=\"number\">2</span> == kArray.length) &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:                 String topic = kArray[<span class=\"number\">0</span>];</div><div class=\"line\"> <span class=\"number\">99</span>:                 <span class=\"keyword\">int</span> queueId = Integer.parseInt(kArray[<span class=\"number\">1</span>]);</div><div class=\"line\"><span class=\"number\">100</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset = <span class=\"keyword\">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class=\"line\"><span class=\"number\">101</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">102</span>:                     <span class=\"keyword\">this</span>.notifyMessageArriving(topic, queueId, offset);</div><div class=\"line\"><span class=\"number\">103</span>:                 &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">104</span>:                     log.error(<span class=\"string\">\"check hold request failed. topic=&#123;&#125;, queueId=&#123;&#125;\"</span>, topic, queueId, e);</div><div class=\"line\"><span class=\"number\">105</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">106</span>:             &#125;</div><div class=\"line\"><span class=\"number\">107</span>:         &#125;</div><div class=\"line\"><span class=\"number\">108</span>:     &#125;</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">111:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚</div><div class=\"line\">112:      *</div><div class=\"line\">113:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">114:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">115:      * <span class=\"doctag\">@param</span> maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset</div><div class=\"line\">116:      */</div><div class=\"line\"><span class=\"number\">117</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">notifyMessageArriving</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> maxOffset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">118</span>:         notifyMessageArriving(topic, queueId, maxOffset, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">119</span>:     &#125;</div><div class=\"line\"><span class=\"number\">120</span>: </div><div class=\"line\"><span class=\"number\">121</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">122:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚</div><div class=\"line\">123:      *</div><div class=\"line\">124:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">125:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">126:      * <span class=\"doctag\">@param</span> maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset</div><div class=\"line\">127:      * <span class=\"doctag\">@param</span> tagsCode è¿‡æ»¤tagsCode</div><div class=\"line\">128:      */</div><div class=\"line\"><span class=\"number\">129</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">notifyMessageArriving</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> maxOffset, <span class=\"keyword\">final</span> Long tagsCode)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">130</span>:         String key = <span class=\"keyword\">this</span>.buildKey(topic, queueId);</div><div class=\"line\"><span class=\"number\">131</span>:         ManyPullRequest mpr = <span class=\"keyword\">this</span>.pullRequestTable.get(key);</div><div class=\"line\"><span class=\"number\">132</span>:         <span class=\"keyword\">if</span> (mpr != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">133</span>:             <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">134</span>:             List&lt;PullRequest&gt; requestList = mpr.cloneListAndClear();</div><div class=\"line\"><span class=\"number\">135</span>:             <span class=\"keyword\">if</span> (requestList != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">136</span>:                 List&lt;PullRequest&gt; replayList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(); <span class=\"comment\">// ä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚æ•°ç»„</span></div><div class=\"line\"><span class=\"number\">137</span>: </div><div class=\"line\"><span class=\"number\">138</span>:                 <span class=\"keyword\">for</span> (PullRequest request : requestList) &#123;</div><div class=\"line\"><span class=\"number\">139</span>:                     <span class=\"comment\">// å¦‚æœ maxOffset è¿‡å°ï¼Œåˆ™é‡æ–°è¯»å–ä¸€æ¬¡ã€‚</span></div><div class=\"line\"><span class=\"number\">140</span>:                     <span class=\"keyword\">long</span> newestOffset = maxOffset;</div><div class=\"line\"><span class=\"number\">141</span>:                     <span class=\"keyword\">if</span> (newestOffset &lt;= request.getPullFromThisOffset()) &#123;</div><div class=\"line\"><span class=\"number\">142</span>:                         newestOffset = <span class=\"keyword\">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class=\"line\"><span class=\"number\">143</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">144</span>:                     <span class=\"comment\">// æœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class=\"line\"><span class=\"number\">145</span>:                     <span class=\"keyword\">if</span> (newestOffset &gt; request.getPullFromThisOffset()) &#123;</div><div class=\"line\"><span class=\"number\">146</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.messageFilter.isMessageMatched(request.getSubscriptionData(), tagsCode)) &#123;</div><div class=\"line\"><span class=\"number\">147</span>:                             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">148</span>:                                 <span class=\"keyword\">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class=\"line\"><span class=\"number\">149</span>:                                     request.getRequestCommand());</div><div class=\"line\"><span class=\"number\">150</span>:                             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">151</span>:                                 log.error(<span class=\"string\">\"execute request when wakeup failed.\"</span>, e);</div><div class=\"line\"><span class=\"number\">152</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">153</span>:                             <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">154</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">155</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">156</span>:                     <span class=\"comment\">// è¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class=\"line\"><span class=\"number\">157</span>:                     <span class=\"keyword\">if</span> (System.currentTimeMillis() &gt;= (request.getSuspendTimestamp() + request.getTimeoutMillis())) &#123;</div><div class=\"line\"><span class=\"number\">158</span>:                         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">159</span>:                             <span class=\"keyword\">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class=\"line\"><span class=\"number\">160</span>:                                 request.getRequestCommand());</div><div class=\"line\"><span class=\"number\">161</span>:                         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">162</span>:                             log.error(<span class=\"string\">\"execute request when wakeup failed.\"</span>, e);</div><div class=\"line\"><span class=\"number\">163</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">164</span>:                         <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">165</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">166</span>:                     <span class=\"comment\">// ä¸ç¬¦åˆå†æ¬¡æ‹‰å–çš„è¯·æ±‚ï¼Œå†æ¬¡æ·»åŠ å›å»</span></div><div class=\"line\"><span class=\"number\">167</span>:                     replayList.add(request);</div><div class=\"line\"><span class=\"number\">168</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">169</span>:                 <span class=\"comment\">// æ·»åŠ å›å»</span></div><div class=\"line\"><span class=\"number\">170</span>:                 <span class=\"keyword\">if</span> (!replayList.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">171</span>:                     mpr.addPullRequest(replayList);</div><div class=\"line\"><span class=\"number\">172</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">173</span>:             &#125;</div><div class=\"line\"><span class=\"number\">174</span>:         &#125;</div><div class=\"line\"><span class=\"number\">175</span>:     &#125;</div><div class=\"line\"><span class=\"number\">176</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>PullRequestHoldService</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚æŒ‚èµ·ç»´æŠ¤çº¿ç¨‹æœåŠ¡ã€‚\n<ul>\n<li>å½“æ‹‰å–æ¶ˆæ¯è¯·æ±‚è·å¾—ä¸äº†æ¶ˆæ¯æ—¶ï¼Œåˆ™ä¼šå°†è¯·æ±‚è¿›è¡ŒæŒ‚èµ·ï¼Œæ·»åŠ åˆ°è¯¥æœåŠ¡ã€‚</li>\n<li>å½“æœ‰ç¬¦åˆæ¡ä»¶ä¿¡æ¯æ—¶ æˆ– æŒ‚èµ·è¶…æ—¶æ—¶ï¼Œé‡æ–°æ‰§è¡Œè·å–æ¶ˆæ¯é€»è¾‘ã€‚</li>\n</ul>\n</li>\n<li><code>#suspendPullRequest(...)</code> è¯´æ˜ ï¼šæ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚åˆ°é›†åˆ( <code>pullRequestTable</code> )ã€‚</li>\n<li><code>#run(...)</code> è¯´æ˜ ï¼š<strong>å®šæ—¶</strong>æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥é‡æ–°æ‹‰å–æ¶ˆæ¯å¹¶è¿›è¡Œé€šçŸ¥ã€‚\n<ul>\n<li>ç¬¬ 65 è‡³ 70 è¡Œ ï¼šæ ¹æ®<code>é•¿è½®è®­</code>or<code>çŸ­è½®è®­</code>è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´ã€‚</li>\n<li>ç¬¬ 71 è‡³ 77 è¡Œ ï¼šæ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚</li>\n</ul>\n</li>\n<li><code>#checkHoldRequest(...)</code> è¯´æ˜ ï¼šéå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚</li>\n<li><code>#notifyMessageArriving(...)</code> è¯´æ˜ ï¼šæ£€æŸ¥<strong>æŒ‡å®šé˜Ÿåˆ—</strong>æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚\n<ul>\n<li>ç¬¬ 139 è‡³ 143 è¡Œ ï¼šå¦‚æœ <code>maxOffset</code> è¿‡å°ï¼Œé‡æ–°è·å–ä¸€æ¬¡æœ€æ–°çš„ã€‚</li>\n<li>ç¬¬ 144 è‡³ 155 è¡Œ ï¼šæœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 156 è‡³ 165 è¡Œ ï¼šè¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 148 || 159 è¡Œ ï¼šå”¤é†’è¯·æ±‚ï¼Œå†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚åŸå…ˆæ‹…å¿ƒæ‹‰å–æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´å½±å“æ•´ä¸ªæŒ‚èµ·è¯·æ±‚çš„éå†ï¼Œåé¢æŸ¥çœ‹<code>#executeRequestWhenWakeup(...)</code>ï¼Œå®é™…æ˜¯ä¸¢åˆ°çº¿ç¨‹æ± è¿›è¡Œä¸€æ­¥çš„æ¶ˆæ¯æ‹‰å–ï¼Œä¸ä¼šæœ‰æ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"pullmessageprocessorexecuterequestwhenwakeup\">PullMessageProcessor#executeRequestWhenWakeup(...)</a>ã€‚</li>\n<li>ç¬¬ 166 è‡³ 172 è¡Œ ï¼šä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚é‡æ–°æ·»åŠ åˆ°é›†åˆ(<code>pullRequestTable</code>)ã€‚</li>\n</ul>\n</li>\n</ul>\n<h2>PullMessageProcessor#executeRequestWhenWakeup(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executeRequestWhenWakeup</span><span class=\"params\">(<span class=\"keyword\">final</span> Channel channel, <span class=\"keyword\">final</span> RemotingCommand request)</span> <span class=\"keyword\">throws</span> RemotingCommandException </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     Runnable run = <span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:                 <span class=\"comment\">// è°ƒç”¨æ‹‰å–è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®ä¸æŒ‚èµ·è¯·æ±‚ã€‚</span></div><div class=\"line\"> <span class=\"number\">7</span>:                 <span class=\"keyword\">final</span> RemotingCommand response = PullMessageProcessor.<span class=\"keyword\">this</span>.processRequest(channel, request, <span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:                 <span class=\"keyword\">if</span> (response != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:                     response.setOpaque(request.getOpaque());</div><div class=\"line\"><span class=\"number\">11</span>:                     response.markResponseType();</div><div class=\"line\"><span class=\"number\">12</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                         channel.writeAndFlush(response).addListener(<span class=\"keyword\">new</span> ChannelFutureListener() &#123;</div><div class=\"line\"><span class=\"number\">14</span>:                             <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">15</span>:                             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">operationComplete</span><span class=\"params\">(ChannelFuture future)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:                                 <span class=\"keyword\">if</span> (!future.isSuccess()) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                                     LOG.error(<span class=\"string\">\"ProcessRequestWrapper response to &#123;&#125; failed\"</span>, future.channel().remoteAddress(), future.cause());</div><div class=\"line\"><span class=\"number\">18</span>:                                     LOG.error(request.toString());</div><div class=\"line\"><span class=\"number\">19</span>:                                     LOG.error(response.toString());</div><div class=\"line\"><span class=\"number\">20</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">21</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">22</span>:                         &#125;);</div><div class=\"line\"><span class=\"number\">23</span>:                     &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                         LOG.error(<span class=\"string\">\"ProcessRequestWrapper process request over, but response failed\"</span>, e);</div><div class=\"line\"><span class=\"number\">25</span>:                         LOG.error(request.toString());</div><div class=\"line\"><span class=\"number\">26</span>:                         LOG.error(response.toString());</div><div class=\"line\"><span class=\"number\">27</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">28</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">29</span>:             &#125; <span class=\"keyword\">catch</span> (RemotingCommandException e1) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                 LOG.error(<span class=\"string\">\"ExecuteRequestWhenWakeup run\"</span>, e1);</div><div class=\"line\"><span class=\"number\">31</span>:             &#125;</div><div class=\"line\"><span class=\"number\">32</span>:         &#125;</div><div class=\"line\"><span class=\"number\">33</span>:     &#125;;</div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">// æäº¤æ‹‰å–è¯·æ±‚åˆ°çº¿ç¨‹æ± </span></div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"keyword\">this</span>.brokerController.getPullMessageExecutor().submit(<span class=\"keyword\">new</span> RequestTask(run, channel, request));</div><div class=\"line\"><span class=\"number\">36</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ‰§è¡Œè¯·æ±‚å”¤é†’ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚è¯¥æ–¹æ³•è°ƒç”¨çº¿ç¨‹æ± ï¼Œå› æ­¤ï¼Œä¸ä¼šé˜»å¡ã€‚</li>\n<li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®å³ä½¿è¯·æ±‚ä¸åˆ°æ¶ˆæ¯ï¼Œä¹Ÿä¸æŒ‚èµ·è¯·æ±‚ã€‚å¦‚æœä¸è®¾ç½®ï¼Œè¯·æ±‚å¯èƒ½è¢«æ— é™æŒ‚èµ·ï¼Œè¢« <code>Broker</code> æ— é™å¾ªç¯ã€‚</li>\n<li>ç¬¬ 35 è¡Œ ï¼š<strong>æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚åˆ°çº¿ç¨‹æ± </strong>ã€‚</li>\n</ul>\n<h1>5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</h1>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><div class=\"line\">Yunai-MacdeMacBook-Pro-2:config yunai$ <span class=\"built_in\">pwd</span></div><div class=\"line\">/Users/yunai/store/config</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:config yunai$ ls -ls</div><div class=\"line\">total 40</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json.bak</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json.bak</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff  1401  4 27 21:51 topics.json</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:config yunai$ cat consumerOffset.json</div><div class=\"line\">&#123;</div><div class=\"line\">\t<span class=\"string\">\"offsetTable\"</span>:&#123;</div><div class=\"line\">\t\t<span class=\"string\">\"%RETRY%please_rename_unique_group_name_4@please_rename_unique_group_name_4\"</span>:&#123;0:0</div><div class=\"line\">\t\t&#125;,</div><div class=\"line\">\t\t<span class=\"string\">\"TopicRead3@please_rename_unique_group_name_4\"</span>:&#123;1:5</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>consumerOffset.json</code> ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶ã€‚</li>\n<li><code>consumerOffset.json.bak</code> ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶å¤‡ä»½ã€‚</li>\n<li>æ¯æ¬¡å†™å…¥ <code>consumerOffset.json</code>ï¼Œå°†åŸå†…å®¹å¤‡ä»½åˆ° <code>consumerOffset.json.bak</code>ã€‚å®ç°è§ï¼š<a href=\"mixallstring2file\">MixAll#string2File(...)</a>ã€‚</li>\n</ul>\n<h2>BrokerController#initialize(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>:<span class=\"keyword\">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">2</span>:    <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">3</span>:    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>:        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:            BrokerController.<span class=\"keyword\">this</span>.consumerOffsetManager.persist();</div><div class=\"line\"> <span class=\"number\">6</span>:        &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:            log.error(<span class=\"string\">\"schedule persist consumerOffset error.\"</span>, e);</div><div class=\"line\"> <span class=\"number\">8</span>:        &#125;</div><div class=\"line\"> <span class=\"number\">9</span>:    &#125;</div><div class=\"line\"><span class=\"number\">10</span>:&#125;, <span class=\"number\">1000</span> * <span class=\"number\">10</span>, <span class=\"keyword\">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ¯ 5s æ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–é€»è¾‘ã€‚</li>\n</ul>\n<h2>ConfigManager</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConfigManager</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger PLOG = LoggerFactory.getLogger(LoggerName.COMMON_LOGGER_NAME);</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 5:  * ç¼–ç å†…å®¹</div><div class=\"line\"> 6:  * <span class=\"doctag\">@return</span> ç¼–ç åçš„å†…å®¹</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> String <span class=\"title\">encode</span><span class=\"params\">()</span></span>;</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"comment\">/**</span></div><div class=\"line\">11:  * åŠ è½½æ–‡ä»¶</div><div class=\"line\">12:  *</div><div class=\"line\">13:  * <span class=\"doctag\">@return</span> åŠ è½½æ˜¯å¦æˆåŠŸ</div><div class=\"line\">14:  */</div><div class=\"line\"><span class=\"number\">15</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">load</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:     String fileName = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">18</span>:         fileName = <span class=\"keyword\">this</span>.configFilePath();</div><div class=\"line\"><span class=\"number\">19</span>:         String jsonString = MixAll.file2String(fileName);</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"comment\">// å¦‚æœå†…å®¹ä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½å¤‡ä»½æ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == jsonString || jsonString.length() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.loadBak();</div><div class=\"line\"><span class=\"number\">23</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">this</span>.decode(jsonString);</div><div class=\"line\"><span class=\"number\">25</span>:             PLOG.info(<span class=\"string\">\"load &#123;&#125; OK\"</span>, fileName);</div><div class=\"line\"><span class=\"number\">26</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">27</span>:         &#125;</div><div class=\"line\"><span class=\"number\">28</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:         PLOG.error(<span class=\"string\">\"load \"</span> + fileName + <span class=\"string\">\" Failed, and try to load backup file\"</span>, e);</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.loadBak();</div><div class=\"line\"><span class=\"number\">31</span>:     &#125;</div><div class=\"line\"><span class=\"number\">32</span>: &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>: <span class=\"comment\">/**</span></div><div class=\"line\">35:  * é…ç½®æ–‡ä»¶åœ°å€</div><div class=\"line\">36:  *</div><div class=\"line\">37:  * <span class=\"doctag\">@return</span> é…ç½®æ–‡ä»¶åœ°å€</div><div class=\"line\">38:  */</div><div class=\"line\"><span class=\"number\">39</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> String <span class=\"title\">configFilePath</span><span class=\"params\">()</span></span>;</div><div class=\"line\"><span class=\"number\">40</span>: </div><div class=\"line\"><span class=\"number\">41</span>: <span class=\"comment\">/**</span></div><div class=\"line\">42:  * åŠ è½½å¤‡ä»½æ–‡ä»¶</div><div class=\"line\">43:  *</div><div class=\"line\">44:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\">45:  */</div><div class=\"line\"><span class=\"number\">46</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">loadBak</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">47</span>:     String fileName = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">48</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">49</span>:         fileName = <span class=\"keyword\">this</span>.configFilePath();</div><div class=\"line\"><span class=\"number\">50</span>:         String jsonString = MixAll.file2String(fileName + <span class=\"string\">\".bak\"</span>);</div><div class=\"line\"><span class=\"number\">51</span>:         <span class=\"keyword\">if</span> (jsonString != <span class=\"keyword\">null</span> &amp;&amp; jsonString.length() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:             <span class=\"keyword\">this</span>.decode(jsonString);</div><div class=\"line\"><span class=\"number\">53</span>:             PLOG.info(<span class=\"string\">\"load \"</span> + fileName + <span class=\"string\">\" OK\"</span>);</div><div class=\"line\"><span class=\"number\">54</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">55</span>:         &#125;</div><div class=\"line\"><span class=\"number\">56</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">57</span>:         PLOG.error(<span class=\"string\">\"load \"</span> + fileName + <span class=\"string\">\" Failed\"</span>, e);</div><div class=\"line\"><span class=\"number\">58</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">59</span>:     &#125;</div><div class=\"line\"><span class=\"number\">60</span>: </div><div class=\"line\"><span class=\"number\">61</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">62</span>: &#125;</div><div class=\"line\"><span class=\"number\">63</span>: </div><div class=\"line\"><span class=\"number\">64</span>: <span class=\"comment\">/**</span></div><div class=\"line\">65:  * è§£ç å†…å®¹</div><div class=\"line\">66:  *</div><div class=\"line\">67:  * <span class=\"doctag\">@param</span> jsonString å†…å®¹</div><div class=\"line\">68:  */</div><div class=\"line\"><span class=\"number\">69</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">decode</span><span class=\"params\">(<span class=\"keyword\">final</span> String jsonString)</span></span>;</div><div class=\"line\"><span class=\"number\">70</span>: </div><div class=\"line\"><span class=\"number\">71</span>: <span class=\"comment\">/**</span></div><div class=\"line\">72:  * æŒä¹…åŒ–</div><div class=\"line\">73:  */</div><div class=\"line\"><span class=\"number\">74</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">persist</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">75</span>:     String jsonString = <span class=\"keyword\">this</span>.encode(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">76</span>:     <span class=\"keyword\">if</span> (jsonString != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">77</span>:         String fileName = <span class=\"keyword\">this</span>.configFilePath();</div><div class=\"line\"><span class=\"number\">78</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">79</span>:             MixAll.string2File(jsonString, fileName);</div><div class=\"line\"><span class=\"number\">80</span>:         &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">81</span>:             PLOG.error(<span class=\"string\">\"persist file Exception, \"</span> + fileName, e);</div><div class=\"line\"><span class=\"number\">82</span>:         &#125;</div><div class=\"line\"><span class=\"number\">83</span>:     &#125;</div><div class=\"line\"><span class=\"number\">84</span>: &#125;</div><div class=\"line\"><span class=\"number\">85</span>: </div><div class=\"line\"><span class=\"number\">86</span>: <span class=\"comment\">/**</span></div><div class=\"line\">87:  * ç¼–ç å­˜å‚¨å†…å®¹</div><div class=\"line\">88:  *</div><div class=\"line\">89:  * <span class=\"doctag\">@param</span> prettyFormat æ˜¯å¦æ ¼å¼åŒ–</div><div class=\"line\">90:  * <span class=\"doctag\">@return</span> å†…å®¹</div><div class=\"line\">91:  */</div><div class=\"line\"><span class=\"number\">92</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> String <span class=\"title\">encode</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> prettyFormat)</span></span>;</div><div class=\"line\"><span class=\"number\">93</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>MixAll#string2File(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶</div><div class=\"line\"> 3:  * å®‰å…¨å†™</div><div class=\"line\"> 4:  * 1. å†™åˆ°.tmpæ–‡ä»¶</div><div class=\"line\"> 5:  * 2. å¤‡ä»½å‡†å¤‡å†™å…¥æ–‡ä»¶åˆ°.bakæ–‡ä»¶</div><div class=\"line\"> 6:  * 3. åˆ é™¤åŸæ–‡ä»¶ï¼Œå°†.tmpä¿®æ”¹æˆæ–‡ä»¶</div><div class=\"line\"> 7:  *</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> str å†…å®¹</div><div class=\"line\"> 9:  * <span class=\"doctag\">@param</span> fileName æ–‡ä»¶å</div><div class=\"line\">10:  * <span class=\"doctag\">@throws</span> IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">11:  */</div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">string2File</span><span class=\"params\">(<span class=\"keyword\">final</span> String str, <span class=\"keyword\">final</span> String fileName)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"comment\">// å†™åˆ° tmpæ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">14</span>:     String tmpFile = fileName + <span class=\"string\">\".tmp\"</span>;</div><div class=\"line\"><span class=\"number\">15</span>:     string2FileNotSafe(str, tmpFile);</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">17</span>:     String bakFile = fileName + <span class=\"string\">\".bak\"</span>;</div><div class=\"line\"><span class=\"number\">18</span>:     String prevContent = file2String(fileName);</div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">if</span> (prevContent != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:         string2FileNotSafe(prevContent, bakFile);</div><div class=\"line\"><span class=\"number\">21</span>:     &#125;</div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>:     File file = <span class=\"keyword\">new</span> File(fileName);</div><div class=\"line\"><span class=\"number\">24</span>:     file.delete();</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:     file = <span class=\"keyword\">new</span> File(tmpFile);</div><div class=\"line\"><span class=\"number\">27</span>:     file.renameTo(<span class=\"keyword\">new</span> File(fileName));</div><div class=\"line\"><span class=\"number\">28</span>: &#125;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>: <span class=\"comment\">/**</span></div><div class=\"line\">31:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶</div><div class=\"line\">32:  * éå®‰å…¨å†™</div><div class=\"line\">33:  *</div><div class=\"line\">34:  * <span class=\"doctag\">@param</span> str å†…å®¹</div><div class=\"line\">35:  * <span class=\"doctag\">@param</span> fileName æ–‡ä»¶å†…å®¹</div><div class=\"line\">36:  * <span class=\"doctag\">@throws</span> IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">37:  */</div><div class=\"line\"><span class=\"number\">38</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">string2FileNotSafe</span><span class=\"params\">(<span class=\"keyword\">final</span> String str, <span class=\"keyword\">final</span> String fileName)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</div><div class=\"line\"><span class=\"number\">39</span>:     File file = <span class=\"keyword\">new</span> File(fileName);</div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"comment\">// åˆ›å»ºä¸Šçº§ç›®å½•</span></div><div class=\"line\"><span class=\"number\">41</span>:     File fileParent = file.getParentFile();</div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"keyword\">if</span> (fileParent != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">43</span>:         fileParent.mkdirs();</div><div class=\"line\"><span class=\"number\">44</span>:     &#125;</div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"comment\">// å†™å†…å®¹</span></div><div class=\"line\"><span class=\"number\">46</span>:     FileWriter fileWriter = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">47</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">48</span>:         fileWriter = <span class=\"keyword\">new</span> FileWriter(file);</div><div class=\"line\"><span class=\"number\">49</span>:         fileWriter.write(str);</div><div class=\"line\"><span class=\"number\">50</span>:     &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:         <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">52</span>:     &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">53</span>:         <span class=\"keyword\">if</span> (fileWriter != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">54</span>:             fileWriter.close();</div><div class=\"line\"><span class=\"number\">55</span>:         &#125;</div><div class=\"line\"><span class=\"number\">56</span>:     &#125;</div><div class=\"line\"><span class=\"number\">57</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h2>ConsumerOffsetManager</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConsumerOffsetManager</span> <span class=\"keyword\">extends</span> <span class=\"title\">ConfigManager</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_GROUP_SEPARATOR = <span class=\"string\">\"@\"</span>;</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 6:      * æ¶ˆè´¹è¿›åº¦é›†åˆ</div><div class=\"line\"> 7:      */</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">private</span> ConcurrentHashMap&lt;String<span class=\"comment\">/* topic@group */</span>, ConcurrentHashMap&lt;Integer, Long&gt;&gt; offsetTable = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">512</span>);</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> BrokerController brokerController;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConsumerOffsetManager</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">13</span>:     &#125;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConsumerOffsetManager</span><span class=\"params\">(BrokerController brokerController)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">this</span>.brokerController = brokerController;</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: </div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">20:      * æäº¤æ¶ˆè´¹è¿›åº¦</div><div class=\"line\">21:      *</div><div class=\"line\">22:      * <span class=\"doctag\">@param</span> clientHost æäº¤clientåœ°å€</div><div class=\"line\">23:      * <span class=\"doctag\">@param</span> group æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\">24:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">25:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">26:      * <span class=\"doctag\">@param</span> offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰</div><div class=\"line\">27:      */</div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">commitOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> String clientHost, <span class=\"keyword\">final</span> String group, <span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"comment\">// topic@group</span></div><div class=\"line\"><span class=\"number\">30</span>:         String key = topic + TOPIC_GROUP_SEPARATOR + group;</div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"keyword\">this</span>.commitOffset(clientHost, key, queueId, offset);</div><div class=\"line\"><span class=\"number\">32</span>:     &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">35:      * æäº¤æ¶ˆè´¹è¿›åº¦</div><div class=\"line\">36:      *</div><div class=\"line\">37:      * <span class=\"doctag\">@param</span> clientHost æäº¤clientåœ°å€</div><div class=\"line\">38:      * <span class=\"doctag\">@param</span> key ä¸»é¢˜@æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\">39:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">40:      * <span class=\"doctag\">@param</span> offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰</div><div class=\"line\">41:      */</div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">commitOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> String clientHost, <span class=\"keyword\">final</span> String key, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">43</span>:         ConcurrentHashMap&lt;Integer, Long&gt; map = <span class=\"keyword\">this</span>.offsetTable.get(key);</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == map) &#123;</div><div class=\"line\"><span class=\"number\">45</span>:             map = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">32</span>);</div><div class=\"line\"><span class=\"number\">46</span>:             map.put(queueId, offset);</div><div class=\"line\"><span class=\"number\">47</span>:             <span class=\"keyword\">this</span>.offsetTable.put(key, map);</div><div class=\"line\"><span class=\"number\">48</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">49</span>:             Long storeOffset = map.put(queueId, offset);</div><div class=\"line\"><span class=\"number\">50</span>:             <span class=\"keyword\">if</span> (storeOffset != <span class=\"keyword\">null</span> &amp;&amp; offset &lt; storeOffset) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:                 log.warn(<span class=\"string\">\"[NOTIFYME]update consumer offset less than store. clientHost=&#123;&#125;, key=&#123;&#125;, queueId=&#123;&#125;, requestOffset=&#123;&#125;, storeOffset=&#123;&#125;\"</span>, clientHost, key, queueId, offset, storeOffset);</div><div class=\"line\"><span class=\"number\">52</span>:             &#125;</div><div class=\"line\"><span class=\"number\">53</span>:         &#125;</div><div class=\"line\"><span class=\"number\">54</span>:     &#125;</div><div class=\"line\"><span class=\"number\">55</span>: </div><div class=\"line\"><span class=\"number\">56</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">encode</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">57</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.encode(<span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">58</span>:     &#125;</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">61</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">configFilePath</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">return</span> BrokerPathConfigHelper.getConsumerOffsetPath(<span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().getStorePathRootDir());</div><div class=\"line\"><span class=\"number\">63</span>:     &#125;</div><div class=\"line\"><span class=\"number\">64</span>: </div><div class=\"line\"><span class=\"number\">65</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">66:      * è§£ç å†…å®¹</div><div class=\"line\">67:      * æ ¼å¼:JSON</div><div class=\"line\">68:      *</div><div class=\"line\">69:      * <span class=\"doctag\">@param</span> jsonString å†…å®¹</div><div class=\"line\">70:      */</div><div class=\"line\"><span class=\"number\">71</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">72</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">decode</span><span class=\"params\">(String jsonString)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">73</span>:         <span class=\"keyword\">if</span> (jsonString != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">74</span>:             ConsumerOffsetManager obj = RemotingSerializable.fromJson(jsonString, ConsumerOffsetManager.class);</div><div class=\"line\"><span class=\"number\">75</span>:             <span class=\"keyword\">if</span> (obj != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">76</span>:                 <span class=\"keyword\">this</span>.offsetTable = obj.offsetTable;</div><div class=\"line\"><span class=\"number\">77</span>:             &#125;</div><div class=\"line\"><span class=\"number\">78</span>:         &#125;</div><div class=\"line\"><span class=\"number\">79</span>:     &#125;</div><div class=\"line\"><span class=\"number\">80</span>: </div><div class=\"line\"><span class=\"number\">81</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">82:      * ç¼–ç å†…å®¹</div><div class=\"line\">83:      * æ ¼å¼ä¸ºJSON</div><div class=\"line\">84:      *</div><div class=\"line\">85:      * <span class=\"doctag\">@param</span> prettyFormat æ˜¯å¦æ ¼å¼åŒ–</div><div class=\"line\">86:      * <span class=\"doctag\">@return</span> ç¼–ç åçš„å†…å®¹</div><div class=\"line\">87:      */</div><div class=\"line\"><span class=\"number\">88</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">encode</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> prettyFormat)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">89</span>:         <span class=\"keyword\">return</span> RemotingSerializable.toJson(<span class=\"keyword\">this</span>, prettyFormat);</div><div class=\"line\"><span class=\"number\">90</span>:     &#125;</div><div class=\"line\"><span class=\"number\">91</span>: </div><div class=\"line\"><span class=\"number\">92</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ¶ˆè´¹è¿›åº¦ç®¡ç†å™¨ã€‚</li>\n</ul>\n<h1>6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</h1>\n<p>å¤§éƒ¨åˆ†é€»è¾‘å’Œ <a href=\"http://www.yunai.me/RocketMQ/message-send-and-receive/#3%E3%80%81Broker-%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF\"><code>Broker</code> æä¾›[æ¥æ”¶æ¶ˆæ¯]æ¥å£</a> ç±»ä¼¼ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ç›¸å…³å†…å®¹ã€‚</p>\n<h2>SendMessageProcessor#consumerSendMsgBack(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">consumerSendMsgBack</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx, <span class=\"keyword\">final</span> RemotingCommand request)</span></span></div><div class=\"line\">  2:     <span class=\"keyword\">throws</span> RemotingCommandException &#123;</div><div class=\"line\">  <span class=\"number\">3</span>: </div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"comment\">// åˆå§‹åŒ–å“åº”</span></div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class=\"keyword\">null</span>);</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">final</span> ConsumerSendMsgBackRequestHeader requestHeader =</div><div class=\"line\">  <span class=\"number\">7</span>:         (ConsumerSendMsgBackRequestHeader) request.decodeCommandCustomHeader(ConsumerSendMsgBackRequestHeader.class);</div><div class=\"line\">  <span class=\"number\">8</span>: </div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"comment\">// hookï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasConsumeMessageHook() &amp;&amp; !UtilAll.isBlank(requestHeader.getOriginMsgId())) &#123;</div><div class=\"line\"> <span class=\"number\">11</span>: </div><div class=\"line\"> <span class=\"number\">12</span>:         ConsumeMessageContext context = <span class=\"keyword\">new</span> ConsumeMessageContext();</div><div class=\"line\"> <span class=\"number\">13</span>:         context.setConsumerGroup(requestHeader.getGroup());</div><div class=\"line\"> <span class=\"number\">14</span>:         context.setTopic(requestHeader.getOriginTopic());</div><div class=\"line\"> <span class=\"number\">15</span>:         context.setCommercialRcvStats(BrokerStatsManager.StatsType.SEND_BACK);</div><div class=\"line\"> <span class=\"number\">16</span>:         context.setCommercialRcvTimes(<span class=\"number\">1</span>);</div><div class=\"line\"> <span class=\"number\">17</span>:         context.setCommercialOwner(request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER));</div><div class=\"line\"> <span class=\"number\">18</span>: </div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"keyword\">this</span>.executeConsumeMessageHookAfter(context);</div><div class=\"line\"> <span class=\"number\">20</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">21</span>: </div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"comment\">// åˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">23</span>:     SubscriptionGroupConfig subscriptionGroupConfig =</div><div class=\"line\"> <span class=\"number\">24</span>:         <span class=\"keyword\">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getGroup());</div><div class=\"line\"> <span class=\"number\">25</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionGroupConfig) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">27</span>:         response.setRemark(<span class=\"string\">\"subscription group not exist, \"</span> + requestHeader.getGroup() + <span class=\"string\">\" \"</span></div><div class=\"line\"> <span class=\"number\">28</span>:             + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</div><div class=\"line\"> <span class=\"number\">29</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">30</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">31</span>: </div><div class=\"line\"> <span class=\"number\">32</span>:     <span class=\"comment\">// æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™</span></div><div class=\"line\"> <span class=\"number\">33</span>:     <span class=\"keyword\">if</span> (!PermName.isWriteable(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">35</span>:         response.setRemark(<span class=\"string\">\"the broker[\"</span> + <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerIP1() + <span class=\"string\">\"] sending message is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">36</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">37</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">38</span>: </div><div class=\"line\"> <span class=\"number\">39</span>:     <span class=\"comment\">// æ£€æŸ¥ é‡è¯•é˜Ÿåˆ—æ•° æ˜¯å¦å¤§äº0ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">40</span>:     <span class=\"keyword\">if</span> (subscriptionGroupConfig.getRetryQueueNums() &lt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">41</span>:         response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"> <span class=\"number\">42</span>:         response.setRemark(<span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">43</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">44</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">45</span>: </div><div class=\"line\"> <span class=\"number\">46</span>:     <span class=\"comment\">// è®¡ç®—retry Topic</span></div><div class=\"line\"> <span class=\"number\">47</span>:     String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());</div><div class=\"line\"> <span class=\"number\">48</span>: </div><div class=\"line\"> <span class=\"number\">49</span>:     <span class=\"comment\">// è®¡ç®—é˜Ÿåˆ—ç¼–å·ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">50</span>:     <span class=\"keyword\">int</span> queueIdInt = Math.abs(<span class=\"keyword\">this</span>.random.nextInt() % <span class=\"number\">99999999</span>) % subscriptionGroupConfig.getRetryQueueNums();</div><div class=\"line\"> <span class=\"number\">51</span>: </div><div class=\"line\"> <span class=\"number\">52</span>:     <span class=\"comment\">// è®¡ç®—sysFlagï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">53</span>:     <span class=\"keyword\">int</span> topicSysFlag = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">54</span>:     <span class=\"keyword\">if</span> (requestHeader.isUnitMode()) &#123;</div><div class=\"line\"> <span class=\"number\">55</span>:         topicSysFlag = TopicSysFlag.buildSysFlag(<span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">56</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:     <span class=\"comment\">// è·å–topicConfigã€‚å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è¿›è¡Œåˆ›å»º</span></div><div class=\"line\"> <span class=\"number\">59</span>:     TopicConfig topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">60</span>:         newTopic, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">61</span>:         subscriptionGroupConfig.getRetryQueueNums(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">62</span>:         PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);</div><div class=\"line\"> <span class=\"number\">63</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123; <span class=\"comment\">// æ²¡æœ‰é…ç½®</span></div><div class=\"line\"> <span class=\"number\">64</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">65</span>:         response.setRemark(<span class=\"string\">\"topic[\"</span> + newTopic + <span class=\"string\">\"] not exist\"</span>);</div><div class=\"line\"> <span class=\"number\">66</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">67</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">68</span>:     <span class=\"keyword\">if</span> (!PermName.isWriteable(topicConfig.getPerm())) &#123; <span class=\"comment\">// ä¸å…è®¸å†™å…¥</span></div><div class=\"line\"> <span class=\"number\">69</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">70</span>:         response.setRemark(String.format(<span class=\"string\">\"the topic[%s] sending message is forbidden\"</span>, newTopic));</div><div class=\"line\"> <span class=\"number\">71</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">72</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">73</span>: </div><div class=\"line\"> <span class=\"number\">74</span>:     <span class=\"comment\">// æŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">75</span>:     MessageExt msgExt = <span class=\"keyword\">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());</div><div class=\"line\"> <span class=\"number\">76</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == msgExt) &#123;</div><div class=\"line\"> <span class=\"number\">77</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">78</span>:         response.setRemark(<span class=\"string\">\"look message by offset failed, \"</span> + requestHeader.getOffset());</div><div class=\"line\"> <span class=\"number\">79</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">80</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">81</span>: </div><div class=\"line\"> <span class=\"number\">82</span>:     <span class=\"comment\">// è®¾ç½®retryTopicåˆ°æ‹“å±•å±æ€§ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">83</span>:     <span class=\"keyword\">final</span> String retryTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class=\"line\"> <span class=\"number\">84</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == retryTopic) &#123;</div><div class=\"line\"> <span class=\"number\">85</span>:         MessageAccessor.putProperty(msgExt, MessageConst.PROPERTY_RETRY_TOPIC, msgExt.getTopic());</div><div class=\"line\"> <span class=\"number\">86</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">87</span>: </div><div class=\"line\"> <span class=\"number\">88</span>:     <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆï¼ˆç‹¬æœ‰ï¼‰ TODO ç–‘é—®ï¼šå¦‚æœè®¾ç½®æˆä¸ç­‰å¾…å­˜å‚¨ï¼Œbrokerè®¾ç½®æˆåŒæ­¥è½ç›˜ï¼Œå²‚ä¸æ˜¯ä¸èƒ½æ‰¹é‡æäº¤äº†ï¼Ÿ</span></div><div class=\"line\"> <span class=\"number\">89</span>:     msgExt.setWaitStoreMsgOK(<span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">90</span>: </div><div class=\"line\"> <span class=\"number\">91</span>:     <span class=\"comment\">// å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚</span></div><div class=\"line\"> <span class=\"number\">92</span>:     <span class=\"keyword\">int</span> delayLevel = requestHeader.getDelayLevel();</div><div class=\"line\"> <span class=\"number\">93</span>:     <span class=\"keyword\">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class=\"line\"> <span class=\"number\">94</span>:     <span class=\"keyword\">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class=\"line\"> <span class=\"number\">95</span>:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class=\"line\"> <span class=\"number\">96</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">97</span>:     <span class=\"keyword\">if</span> (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">98</span>:         || delayLevel &lt; <span class=\"number\">0</span>) &#123; <span class=\"comment\">// å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)</span></div><div class=\"line\"> <span class=\"number\">99</span>:         newTopic = MixAll.getDLQTopic(requestHeader.getGroup());</div><div class=\"line\"><span class=\"number\">100</span>:         queueIdInt = Math.abs(<span class=\"keyword\">this</span>.random.nextInt() % <span class=\"number\">99999999</span>) % DLQ_NUMS_PER_GROUP;</div><div class=\"line\"><span class=\"number\">101</span>: </div><div class=\"line\"><span class=\"number\">102</span>:         topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">103</span>:             DLQ_NUMS_PER_GROUP, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">104</span>:             PermName.PERM_WRITE, <span class=\"number\">0</span></div><div class=\"line\"><span class=\"number\">105</span>:         );</div><div class=\"line\"><span class=\"number\">106</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"><span class=\"number\">107</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">108</span>:             response.setRemark(<span class=\"string\">\"topic[\"</span> + newTopic + <span class=\"string\">\"] not exist\"</span>);</div><div class=\"line\"><span class=\"number\">109</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">110</span>:         &#125;</div><div class=\"line\"><span class=\"number\">111</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">112</span>:         <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == delayLevel) &#123;</div><div class=\"line\"><span class=\"number\">113</span>:             delayLevel = <span class=\"number\">3</span> + msgExt.getReconsumeTimes();</div><div class=\"line\"><span class=\"number\">114</span>:         &#125;</div><div class=\"line\"><span class=\"number\">115</span>:         msgExt.setDelayTimeLevel(delayLevel);</div><div class=\"line\"><span class=\"number\">116</span>:     &#125;</div><div class=\"line\"><span class=\"number\">117</span>: </div><div class=\"line\"><span class=\"number\">118</span>:     <span class=\"comment\">// åˆ›å»ºMessageExtBrokerInner</span></div><div class=\"line\"><span class=\"number\">119</span>:     MessageExtBrokerInner msgInner = <span class=\"keyword\">new</span> MessageExtBrokerInner();</div><div class=\"line\"><span class=\"number\">120</span>:     msgInner.setTopic(newTopic);</div><div class=\"line\"><span class=\"number\">121</span>:     msgInner.setBody(msgExt.getBody());</div><div class=\"line\"><span class=\"number\">122</span>:     msgInner.setFlag(msgExt.getFlag());</div><div class=\"line\"><span class=\"number\">123</span>:     MessageAccessor.setProperties(msgInner, msgExt.getProperties());</div><div class=\"line\"><span class=\"number\">124</span>:     msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</div><div class=\"line\"><span class=\"number\">125</span>:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(<span class=\"keyword\">null</span>, msgExt.getTags()));</div><div class=\"line\"><span class=\"number\">126</span>:     msgInner.setQueueId(queueIdInt);</div><div class=\"line\"><span class=\"number\">127</span>:     msgInner.setSysFlag(msgExt.getSysFlag());</div><div class=\"line\"><span class=\"number\">128</span>:     msgInner.setBornTimestamp(msgExt.getBornTimestamp());</div><div class=\"line\"><span class=\"number\">129</span>:     msgInner.setBornHost(msgExt.getBornHost());</div><div class=\"line\"><span class=\"number\">130</span>:     msgInner.setStoreHost(<span class=\"keyword\">this</span>.getStoreHost());</div><div class=\"line\"><span class=\"number\">131</span>:     msgInner.setReconsumeTimes(msgExt.getReconsumeTimes() + <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">132</span>: </div><div class=\"line\"><span class=\"number\">133</span>:     <span class=\"comment\">// è®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å­—æ®µï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"><span class=\"number\">134</span>:     String originMsgId = MessageAccessor.getOriginMessageId(msgExt);</div><div class=\"line\"><span class=\"number\">135</span>:     MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);</div><div class=\"line\"><span class=\"number\">136</span>: </div><div class=\"line\"><span class=\"number\">137</span>:     <span class=\"comment\">// æ·»åŠ æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">138</span>:     PutMessageResult putMessageResult = <span class=\"keyword\">this</span>.brokerController.getMessageStore().putMessage(msgInner);</div><div class=\"line\"><span class=\"number\">139</span>:     <span class=\"keyword\">if</span> (putMessageResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">140</span>:         <span class=\"keyword\">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class=\"line\"><span class=\"number\">141</span>:             <span class=\"keyword\">case</span> PUT_OK:</div><div class=\"line\"><span class=\"number\">142</span>:                 String backTopic = msgExt.getTopic();</div><div class=\"line\"><span class=\"number\">143</span>:                 String correctTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class=\"line\"><span class=\"number\">144</span>:                 <span class=\"keyword\">if</span> (correctTopic != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">145</span>:                     backTopic = correctTopic;</div><div class=\"line\"><span class=\"number\">146</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">147</span>: </div><div class=\"line\"><span class=\"number\">148</span>:                 <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incSendBackNums(requestHeader.getGroup(), backTopic);</div><div class=\"line\"><span class=\"number\">149</span>: </div><div class=\"line\"><span class=\"number\">150</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"><span class=\"number\">151</span>:                 response.setRemark(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">152</span>: </div><div class=\"line\"><span class=\"number\">153</span>:                 <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">154</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">155</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">156</span>:         &#125;</div><div class=\"line\"><span class=\"number\">157</span>: </div><div class=\"line\"><span class=\"number\">158</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">159</span>:         response.setRemark(putMessageResult.getPutMessageStatus().name());</div><div class=\"line\"><span class=\"number\">160</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">161</span>:     &#125;</div><div class=\"line\"><span class=\"number\">162</span>: </div><div class=\"line\"><span class=\"number\">163</span>:     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">164</span>:     response.setRemark(<span class=\"string\">\"putMessageResult is null\"</span>);</div><div class=\"line\"><span class=\"number\">165</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">166</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå½“ <code>Consumer</code> æ¶ˆè´¹æŸæ¡æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ¥å£å‘å›æ¶ˆæ¯ã€‚<code>Broker</code> ä¼šå­˜å‚¨å‘å›çš„æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œä¸‹æ¬¡ <code>Consumer</code> æ‹‰å–è¯¥æ¶ˆæ¯ï¼Œèƒ½å¤Ÿä» <code>CommitLog</code> å’Œ <code>ConsumeQueue</code> é¡ºåºè¯»å–ã€‚</li>\n<li>[x] å› ä¸ºå¤§å¤šæ•°é€»è¾‘å’Œ <strong><code>Broker</code> æ¥æ”¶æ™®é€šæ¶ˆæ¯</strong> å¾ˆç›¸ä¼¼ï¼Œæ—¶å€™ <code>TODO</code> æ ‡è®°æˆç‹¬æœ‰çš„é€»è¾‘ã€‚</li>\n<li>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šåˆå§‹åŒ–å“åº”ã€‚</li>\n<li>[x] ç¬¬ 9 è‡³ 20 è¡Œ ï¼šHooké€»è¾‘ã€‚</li>\n<li>[x] ç¬¬22 è‡³ 30 è¡Œ ï¼šåˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ã€‚</li>\n<li>ç¬¬ 32 è‡³ 37 è¡Œ ï¼šæ£€æŸ¥ <code>Broker</code> æ˜¯å¦æœ‰å†™å…¥æƒé™ã€‚</li>\n<li>[x] ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæ£€æŸ¥é‡è¯•é˜Ÿåˆ—æ•°æ˜¯å¦å¤§äº0ã€‚</li>\n<li>ç¬¬ 47 è¡Œ ï¼šè®¡ç®— retry topicã€‚</li>\n<li>[x] ç¬¬ 50 è¡Œ ï¼šéšæœºåˆ†é…é˜Ÿåˆ—ç¼–å·ï¼Œä¾èµ– <code>retryQueueNums</code>ã€‚</li>\n<li>[x] ç¬¬ 52 è‡³ 56 è¡Œ ï¼šè®¡ç®— <code>sysFlag</code>ã€‚</li>\n<li>ç¬¬ 58 è‡³ 72 è¡Œ ï¼šè·å– <code>TopicConfig</code>ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚</li>\n<li>[x] ç¬¬ 74 è‡³ 80 è¡Œ ï¼šæŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚</li>\n<li>[x] ç¬¬ 82 è‡³ 86 è¡Œ ï¼šè®¾ç½® <code>retryTopic</code> åˆ°æ¶ˆæ¯æ‹“å±•å±æ€§ã€‚</li>\n<li>[x] ç¬¬ 89 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆã€‚\n<ul>\n<li>å½“ <code>Broker</code> åˆ·ç›˜æ–¹å¼ä¸ºåŒæ­¥ï¼Œä¼šå¯¼è‡´åŒæ­¥è½ç›˜ä¸èƒ½æ‰¹é‡æäº¤ï¼Œè¿™æ ·ä¼šä¸ä¼šå­˜åœ¨é—®é¢˜ï¼Ÿæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚ğŸ˜ˆã€‚</li>\n</ul>\n</li>\n<li>[x] ç¬¬ 91 è‡³ 116 è¡Œ ï¼šå¤„ç† <code>delayLevel</code> ã€‚</li>\n<li>ç¬¬ 118 è‡³ 131 è¡Œ ï¼šåˆ›å»º <code>MessageExtBrokerInner</code> ã€‚</li>\n<li>[x] ç¬¬ 133 è‡³ 135 è¡Œ ï¼šè®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å±æ€§ã€‚</li>\n<li>ç¬¬ 137 è‡³ 161 è¡Œ ï¼šæ·»åŠ æ¶ˆæ¯ã€‚</li>\n</ul>\n<h1>7ã€ç»“å°¾</h1>\n<p>æ„Ÿè°¢åŒå­¦ä»¬å¯¹æœ¬æ–‡çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€‚</p>\n<p>ğŸ˜ˆå¦‚æœè§£æå­˜åœ¨é—®é¢˜æˆ–è€…è¡¨è¾¾è¯¯è§£çš„ï¼Œè¡¨ç¤ºæŠ±æ­‰ã€‚å¦‚æœæ–¹ä¾¿çš„è¯ï¼Œå¯ä»¥åŠ ä¸‹ <strong>QQï¼š7685413</strong>ã€‚è®©æˆ‘ä»¬æ¥ä¸€åœº 1 ï¼š1 äº¤æµï¼ˆæåŸºï¼‰ã€‚</p>\n<p>å†æ¬¡è¡¨ç¤ºååˆ†æ„Ÿè°¢ã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>åŸæ–‡åœ°å€ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/\">http://www.yunai.me/RocketMQ/message-pull-and-consume-first/</a><br>\n<code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/incubator-rocketmq</a><br>\n**ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **</p>\n</blockquote>\n<p><img src=\"http://www.yunai.me/images/common/wechat_mp.jpeg\" alt=\"wechat_mp\"></p>\n<hr>\n<ul>\n<li><a href=\"#\">1ã€æ¦‚è¿°</a></li>\n<li><a href=\"#\">2ã€ConsumeQueue ç»“æ„</a></li>\n<li><a href=\"#\">3ã€ConsumeQueue å­˜å‚¨</a>\n<ul>\n<li><a href=\"#\">ReputMessageService</a>\n<ul>\n<li><a href=\"#\">DefaultMessageStore#doDispatch(...)</a></li>\n<li><a href=\"#\">ConsumeQueue#putMessagePositionInfoWrapper(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">FlushConsumeQueueService</a></li>\n</ul>\n</li>\n<li><a href=\"#\">4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</a>\n<ul>\n<li><a href=\"#\">PullMessageRequestHeader</a></li>\n<li><a href=\"#\">PullMessageProcessor#processRequest(...)</a></li>\n<li><a href=\"#\">MessageStore#getMessage(...)</a></li>\n<li><a href=\"#\">DefaultMessageFilter#isMessageMatched(...)</a></li>\n<li><a href=\"#\">PullRequestHoldService</a></li>\n<li><a href=\"#\">PullMessageProcessor#executeRequestWhenWakeup(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</a>\n<ul>\n<li><a href=\"#\">BrokerController#initialize(...)</a></li>\n<li><a href=\"#\">ConfigManager</a>\n<ul>\n<li><a href=\"#\">MixAll#string2File(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">ConsumerOffsetManager</a></li>\n</ul>\n</li>\n<li><a href=\"#\">6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</a>\n<ul>\n<li><a href=\"#\">SendMessageProcessor#consumerSendMsgBack(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">7ã€ç»“å°¾</a></li>\n</ul>\n<h1>1ã€æ¦‚è¿°</h1>\n<p>æœ¬ç« ä¸»è¦è§£æ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚\nå› ä¸ºç¯‡å¹…è¾ƒé•¿ï¼Œåˆ†æˆä¸Šä¸‹ä¸¤ç¯‡ï¼š</p>\n<ol>\n<li>ä¸Šç¯‡ï¼š<code>Broker</code> ç›¸å…³æºç ã€‚</li>\n<li>ä¸‹ç¯‡ï¼š<code>Consumer</code> ç›¸å…³æºç ã€‚</li>\n</ol>\n<p><em>æœ¬æ–‡å³æ˜¯ä¸Šç¯‡ã€‚</em></p>\n<hr>\n<p>okï¼Œå…ˆçœ‹ç¬¬ä¸€å¼ å…³äºæ¶ˆè´¹é€»è¾‘çš„å›¾ï¼š</p>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/13.png\" alt=\"æ¶ˆè´¹é€»è¾‘å›¾\"></p>\n</blockquote>\n<p>å†çœ‹æ¶ˆè´¹é€»è¾‘ç²¾ç®€çš„é¡ºåºå›¾ï¼ˆå®é™…æƒ…å†µä¼šç•¥æœ‰å·®åˆ«ï¼‰ï¼š</p>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/04.png\" alt=\"Consumer&amp;amp;Brokeræ¶ˆè´¹ç²¾ç®€å›¾.png\"></p>\n</blockquote>\n<h1>2ã€ConsumeQueue ç»“æ„</h1>\n<p><code>ConsumeQueue</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å…³ç³»å¦‚ä¸‹ï¼š</p>\n<blockquote>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/03.png\" alt=\"ConsumeQueueã€MappedFileQueueã€MappedFileçš„å…³ç³»\">\n<code>ConsumeQueue</code> : <code>MappedFileQueue</code> : <code>MappedFile</code> = 1 : 1 : Nã€‚</p>\n</blockquote>\n<p>ååº”åˆ°ç³»ç»Ÿæ–‡ä»¶å¦‚ä¸‹ï¼š</p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><div class=\"line\">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class=\"built_in\">pwd</span></div><div class=\"line\">/Users/yunai/store/consumequeue</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class=\"built_in\">cd</span> TopicRead3/</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ ls -ls</div><div class=\"line\">total 0</div><div class=\"line\">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:52 0</div><div class=\"line\">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 1</div><div class=\"line\">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 2</div><div class=\"line\">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 3</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ <span class=\"built_in\">cd</span> 0/</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:0 yunai$ ls -ls</div><div class=\"line\">total 11720</div><div class=\"line\">11720 -rw-r--r--  1 yunai  staff  6000000  4 27 21:55 00000000000000000000</div></pre></td></tr></table></figure></p>\n<hr>\n<p><code>ConsumeQueue</code>ã€<code>MappedFileQueue</code>ã€<code>MappedFile</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>\n<ul>\n<li><code>MappedFile</code> ï¼š00000000000000000000ç­‰æ–‡ä»¶ã€‚</li>\n<li><code>MappedFileQueue</code> ï¼š<code>MappedFile</code> æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œå¯¹ <code>MappedFile</code> è¿›è¡Œå°è£…æˆæ–‡ä»¶é˜Ÿåˆ—ï¼Œå¯¹ä¸Šå±‚æä¾›å¯æ— é™ä½¿ç”¨çš„æ–‡ä»¶å®¹é‡ã€‚\n<ul>\n<li>æ¯ä¸ª <code>MappedFile</code> ç»Ÿä¸€æ–‡ä»¶å¤§å°ã€‚</li>\n<li>æ–‡ä»¶å‘½åæ–¹å¼ï¼šfileName[n] = fileName[n - 1] + mappedFileSizeã€‚åœ¨ <code>ConsumeQueue</code> é‡Œé»˜è®¤ä¸º 6000000Bã€‚</li>\n</ul>\n</li>\n<li><code>ConsumeQueue</code> ï¼šé’ˆå¯¹ <code>MappedFileQueue</code> çš„å°è£…ä½¿ç”¨ã€‚\n<ul>\n<li><code>Store : ConsumeQueue = ConcurrentHashMap&lt;String/* topic */, ConcurrentHashMap&lt;Integer/* queueId */, ConsumeQueue&gt;&gt;</code>ã€‚</li>\n</ul>\n</li>\n</ul>\n<p><code>ConsumeQueue</code> å­˜å‚¨åœ¨ <code>MappedFile</code> çš„å†…å®¹<strong>å¿…é¡»</strong>å¤§å°æ˜¯ 20B( <code>ConsumeQueue.CQ_STORE_UNIT_SIZE</code> )ï¼Œæœ‰ä¸¤ç§å†…å®¹ç±»å‹ï¼š</p>\n<ol>\n<li><code>MESSAGE_POSITION_INFO</code> ï¼šæ¶ˆæ¯ä½ç½®ä¿¡æ¯ã€‚</li>\n<li><code>BLANK</code> : æ–‡ä»¶å‰ç½®ç©ºç™½å ä½ã€‚å½“å†å² <code>Message</code> è¢«åˆ é™¤æ—¶ï¼Œéœ€è¦ç”¨ <code>BLANK</code>å ä½è¢«åˆ é™¤çš„æ¶ˆæ¯ã€‚</li>\n</ol>\n<p><code>MESSAGE_POSITION_INFO</code> åœ¨ <code>ConsumeQueue</code> å­˜å‚¨ç»“æ„ï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">offset</td>\n<td style=\"text-align:left\">æ¶ˆæ¯ <code>CommitLog</code> å­˜å‚¨ä½ç½®</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">size</td>\n<td style=\"text-align:left\">æ¶ˆæ¯é•¿åº¦</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">tagsCode</td>\n<td style=\"text-align:left\">æ¶ˆæ¯tagsCode</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n</tbody>\n</table>\n<p><code>BLANK</code> åœ¨ <code>ConsumeQueue</code> å­˜å‚¨ç»“æ„ï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ç¬¬å‡ ä½</th>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">å­—èŠ‚æ•°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">Integer.MAX_VALUE</td>\n<td style=\"text-align:left\">Int</td>\n<td style=\"text-align:left\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\"></td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">Long</td>\n<td style=\"text-align:left\">8</td>\n</tr>\n</tbody>\n</table>\n<h1>3ã€ConsumeQueue å­˜å‚¨</h1>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/02.png\" alt=\"CommitLogé‡æ”¾ConsumeQueueå›¾\"></p>\n<p>ä¸»è¦æœ‰ä¸¤ä¸ªç»„ä»¶ï¼š</p>\n<ul>\n<li><code>ReputMessageService</code> ï¼šwrite ConsumeQueueã€‚</li>\n<li><code>FlushConsumeQueueService</code> ï¼šflush ConsumeQueueã€‚</li>\n</ul>\n<h2>ReputMessageService</h2>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/12.png\" alt=\"ReputMessageServiceé¡ºåºå›¾\"></p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReputMessageService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>: </div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  4:      * å¼€å§‹é‡æ”¾æ¶ˆæ¯çš„CommitLogç‰©ç†ä½ç½®</div><div class=\"line\">  5:      */</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> reputFromOffset = <span class=\"number\">0</span>;</div><div class=\"line\">  <span class=\"number\">7</span>: </div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getReputFromOffset</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">9</span>:         <span class=\"keyword\">return</span> reputFromOffset;</div><div class=\"line\"> <span class=\"number\">10</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">11</span>: </div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setReputFromOffset</span><span class=\"params\">(<span class=\"keyword\">long</span> reputFromOffset)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">13</span>:         <span class=\"keyword\">this</span>.reputFromOffset = reputFromOffset;</div><div class=\"line\"> <span class=\"number\">14</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">15</span>: </div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">shutdown</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">50</span> &amp;&amp; <span class=\"keyword\">this</span>.isCommitLogAvailable(); i++) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">20</span>:                 Thread.sleep(<span class=\"number\">100</span>);</div><div class=\"line\"> <span class=\"number\">21</span>:             &#125; <span class=\"keyword\">catch</span> (InterruptedException ignored) &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">23</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isCommitLogAvailable()) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:             log.warn(<span class=\"string\">\"shutdown ReputMessageService, but commitlog have not finish to be dispatched, CL: &#123;&#125; reputFromOffset: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">27</span>:                 DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.getMaxOffset(), <span class=\"keyword\">this</span>.reputFromOffset);</div><div class=\"line\"> <span class=\"number\">28</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:         <span class=\"keyword\">super</span>.shutdown();</div><div class=\"line\"> <span class=\"number\">31</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">32</span>: </div><div class=\"line\"> <span class=\"number\">33</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 34:      * å‰©ä½™éœ€è¦é‡æ”¾æ¶ˆæ¯å­—èŠ‚æ•°</div><div class=\"line\"> 35:      *</div><div class=\"line\"> 36:      * <span class=\"doctag\">@return</span> å­—èŠ‚æ•°</div><div class=\"line\"> 37:      */</div><div class=\"line\"> <span class=\"number\">38</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">behind</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">39</span>:         <span class=\"keyword\">return</span> DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.getMaxOffset() - <span class=\"keyword\">this</span>.reputFromOffset;</div><div class=\"line\"> <span class=\"number\">40</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 43:      * æ˜¯å¦commitLogéœ€è¦é‡æ”¾æ¶ˆæ¯</div><div class=\"line\"> 44:      *</div><div class=\"line\"> 45:      * <span class=\"doctag\">@return</span> æ˜¯å¦</div><div class=\"line\"> 46:      */</div><div class=\"line\"> <span class=\"number\">47</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isCommitLogAvailable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.reputFromOffset &lt; DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.getMaxOffset();</div><div class=\"line\"> <span class=\"number\">49</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">50</span>: </div><div class=\"line\"> <span class=\"number\">51</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doReput</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">52</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">boolean</span> doNext = <span class=\"keyword\">true</span>; <span class=\"keyword\">this</span>.isCommitLogAvailable() &amp;&amp; doNext; ) &#123;</div><div class=\"line\"> <span class=\"number\">53</span>: </div><div class=\"line\"> <span class=\"number\">54</span>:             <span class=\"comment\">// TODO ç–‘é—®ï¼šè¿™ä¸ªæ˜¯å•¥</span></div><div class=\"line\"> <span class=\"number\">55</span>:             <span class=\"keyword\">if</span> (DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().isDuplicationEnable() <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">56</span>:                 &amp;&amp; <span class=\"keyword\">this</span>.reputFromOffset &gt;= DefaultMessageStore.<span class=\"keyword\">this</span>.getConfirmOffset()) &#123;</div><div class=\"line\"> <span class=\"number\">57</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">58</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">59</span>: </div><div class=\"line\"> <span class=\"number\">60</span>:             <span class=\"comment\">// è·å–ä»reputFromOffsetå¼€å§‹çš„commitLogå¯¹åº”çš„MappeFileå¯¹åº”çš„MappedByteBuffer</span></div><div class=\"line\"> <span class=\"number\">61</span>:             SelectMappedBufferResult result = DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.getData(reputFromOffset);</div><div class=\"line\"> <span class=\"number\">62</span>:             <span class=\"keyword\">if</span> (result != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">64</span>:                     <span class=\"keyword\">this</span>.reputFromOffset = result.getStartOffset();</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:                     <span class=\"comment\">// éå†MappedByteBuffer</span></div><div class=\"line\"> <span class=\"number\">67</span>:                     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> readSize = <span class=\"number\">0</span>; readSize &lt; result.getSize() &amp;&amp; doNext; ) &#123;</div><div class=\"line\"> <span class=\"number\">68</span>:                         <span class=\"comment\">// ç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚</span></div><div class=\"line\"> <span class=\"number\">69</span>:                         DispatchRequest dispatchRequest = DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">70</span>:                         <span class=\"keyword\">int</span> size = dispatchRequest.getMsgSize(); <span class=\"comment\">// æ¶ˆæ¯é•¿åº¦</span></div><div class=\"line\"> <span class=\"number\">71</span>:                         <span class=\"comment\">// æ ¹æ®è¯·æ±‚çš„ç»“æœå¤„ç†</span></div><div class=\"line\"> <span class=\"number\">72</span>:                         <span class=\"keyword\">if</span> (dispatchRequest.isSuccess()) &#123; <span class=\"comment\">// è¯»å–æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">73</span>:                             <span class=\"keyword\">if</span> (size &gt; <span class=\"number\">0</span>) &#123; <span class=\"comment\">// è¯»å–Message</span></div><div class=\"line\"> <span class=\"number\">74</span>:                                 DefaultMessageStore.<span class=\"keyword\">this</span>.doDispatch(dispatchRequest);</div><div class=\"line\"> <span class=\"number\">75</span>:                                 <span class=\"comment\">// é€šçŸ¥æœ‰æ–°æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">76</span>:                                 <span class=\"keyword\">if</span> (BrokerRole.SLAVE != DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getBrokerRole()</div><div class=\"line\"> <span class=\"number\">77</span>:                                     &amp;&amp; DefaultMessageStore.<span class=\"keyword\">this</span>.brokerConfig.isLongPollingEnable()) &#123;</div><div class=\"line\"> <span class=\"number\">78</span>:                                     DefaultMessageStore.<span class=\"keyword\">this</span>.messageArrivingListener.arriving(dispatchRequest.getTopic(),</div><div class=\"line\"> <span class=\"number\">79</span>:                                         dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + <span class=\"number\">1</span>,</div><div class=\"line\"> <span class=\"number\">80</span>:                                         dispatchRequest.getTagsCode());</div><div class=\"line\"> <span class=\"number\">81</span>:                                 &#125;</div><div class=\"line\"> <span class=\"number\">82</span>:                                 <span class=\"comment\">// FIXED BUG By shijia</span></div><div class=\"line\"> <span class=\"number\">83</span>:                                 <span class=\"keyword\">this</span>.reputFromOffset += size;</div><div class=\"line\"> <span class=\"number\">84</span>:                                 readSize += size;</div><div class=\"line\"> <span class=\"number\">85</span>:                                 <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"> <span class=\"number\">86</span>:                                 <span class=\"keyword\">if</span> (DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE) &#123;</div><div class=\"line\"> <span class=\"number\">87</span>:                                     DefaultMessageStore.<span class=\"keyword\">this</span>.storeStatsService</div><div class=\"line\"> <span class=\"number\">88</span>:                                         .getSinglePutMessageTopicTimesTotal(dispatchRequest.getTopic()).incrementAndGet();</div><div class=\"line\"> <span class=\"number\">89</span>:                                     DefaultMessageStore.<span class=\"keyword\">this</span>.storeStatsService</div><div class=\"line\"> <span class=\"number\">90</span>:                                         .getSinglePutMessageTopicSizeTotal(dispatchRequest.getTopic())</div><div class=\"line\"> <span class=\"number\">91</span>:                                         .addAndGet(dispatchRequest.getMsgSize());</div><div class=\"line\"> <span class=\"number\">92</span>:                                 &#125;</div><div class=\"line\"> <span class=\"number\">93</span>:                             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (size == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// è¯»å–åˆ°MappedFileæ–‡ä»¶å°¾</span></div><div class=\"line\"> <span class=\"number\">94</span>:                                 <span class=\"keyword\">this</span>.reputFromOffset = DefaultMessageStore.<span class=\"keyword\">this</span>.commitLog.rollNextFile(<span class=\"keyword\">this</span>.reputFromOffset);</div><div class=\"line\"> <span class=\"number\">95</span>:                                 readSize = result.getSize();</div><div class=\"line\"> <span class=\"number\">96</span>:                             &#125;</div><div class=\"line\"> <span class=\"number\">97</span>:                         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!dispatchRequest.isSuccess()) &#123; <span class=\"comment\">// è¯»å–å¤±è´¥</span></div><div class=\"line\"> <span class=\"number\">98</span>:                             <span class=\"keyword\">if</span> (size &gt; <span class=\"number\">0</span>) &#123; <span class=\"comment\">// è¯»å–åˆ°Messageå´ä¸æ˜¯Message</span></div><div class=\"line\"> <span class=\"number\">99</span>:                                 log.error(<span class=\"string\">\"[BUG]read total count not equals msg total size. reputFromOffset=&#123;&#125;\"</span>, reputFromOffset);</div><div class=\"line\"><span class=\"number\">100</span>:                                 <span class=\"keyword\">this</span>.reputFromOffset += size;</div><div class=\"line\"><span class=\"number\">101</span>:                             &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// è¯»å–åˆ°Blankå´ä¸æ˜¯Blank</span></div><div class=\"line\"><span class=\"number\">102</span>:                                 doNext = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">103</span>:                                 <span class=\"keyword\">if</span> (DefaultMessageStore.<span class=\"keyword\">this</span>.brokerConfig.getBrokerId() == MixAll.MASTER_ID) &#123;</div><div class=\"line\"><span class=\"number\">104</span>:                                     log.error(<span class=\"string\">\"[BUG]the master dispatch message to consume queue error, COMMITLOG OFFSET: &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">105</span>:                                         <span class=\"keyword\">this</span>.reputFromOffset);</div><div class=\"line\"><span class=\"number\">106</span>: </div><div class=\"line\"><span class=\"number\">107</span>:                                     <span class=\"keyword\">this</span>.reputFromOffset += result.getSize() - readSize;</div><div class=\"line\"><span class=\"number\">108</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">109</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">110</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">111</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">112</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">113</span>:                     result.release();</div><div class=\"line\"><span class=\"number\">114</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">115</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">116</span>:                 doNext = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">117</span>:             &#125;</div><div class=\"line\"><span class=\"number\">118</span>:         &#125;</div><div class=\"line\"><span class=\"number\">119</span>:     &#125;</div><div class=\"line\"><span class=\"number\">120</span>: </div><div class=\"line\"><span class=\"number\">121</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">122</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">123</span>:         DefaultMessageStore.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">124</span>: </div><div class=\"line\"><span class=\"number\">125</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">126</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">127</span>:                 Thread.sleep(<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">128</span>:                 <span class=\"keyword\">this</span>.doReput();</div><div class=\"line\"><span class=\"number\">129</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">130</span>:                 DefaultMessageStore.log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">131</span>:             &#125;</div><div class=\"line\"><span class=\"number\">132</span>:         &#125;</div><div class=\"line\"><span class=\"number\">133</span>: </div><div class=\"line\"><span class=\"number\">134</span>:         DefaultMessageStore.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">135</span>:     &#125;</div><div class=\"line\"><span class=\"number\">136</span>: </div><div class=\"line\"><span class=\"number\">137</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">138</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">139</span>:         <span class=\"keyword\">return</span> ReputMessageService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">140</span>:     &#125;</div><div class=\"line\"><span class=\"number\">141</span>: </div><div class=\"line\"><span class=\"number\">142</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šé‡æ”¾æ¶ˆæ¯çº¿ç¨‹æœåŠ¡ã€‚\n<ul>\n<li>è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° æ¶ˆè´¹é˜Ÿåˆ—(ConsumeQueue)</li>\n<li>è¯¥æœåŠ¡ä¸æ–­ç”Ÿæˆ æ¶ˆæ¯ç´¢å¼• åˆ° ç´¢å¼•æ–‡ä»¶(IndexFile)</li>\n</ul>\n</li>\n<li><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/11.png\" alt=\"ReputMessageServiceç”¨ä¾‹å›¾\">\n<ul>\n<li>ç¬¬ 61 è¡Œ ï¼šè·å– <code>reputFromOffset</code> å¼€å§‹çš„ <code>CommitLog</code> å¯¹åº”çš„ <code>MappedFile</code> å¯¹åº”çš„ <code>MappedByteBuffer</code>ã€‚</li>\n<li>ç¬¬ 67 è¡Œ ï¼šéå† <code>MappedByteBuffer</code>ã€‚</li>\n<li>ç¬¬ 69 è¡Œ ï¼šç”Ÿæˆé‡æ”¾æ¶ˆæ¯é‡æ”¾è°ƒåº¦è¯·æ±‚ (<code>DispatchRequest</code>) ã€‚è¯·æ±‚é‡Œä¸»è¦åŒ…å«ä¸€æ¡æ¶ˆæ¯ (<code>Message</code>) æˆ–è€… æ–‡ä»¶å°¾ (<code>BLANK</code>) çš„åŸºæœ¬ä¿¡æ¯ã€‚</li>\n<li>ç¬¬ 72 è‡³ 96 è¡Œ ï¼šè¯·æ±‚æ˜¯æœ‰æ•ˆè¯·æ±‚ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†ã€‚\n<ul>\n<li>ç¬¬ 75 è‡³ 81 è¡Œ ï¼šå½“ <code>Broker</code> æ˜¯ä¸»èŠ‚ç‚¹ &amp;&amp; <code>Broker</code> å¼€å¯çš„æ˜¯é•¿è½®è¯¢ï¼Œé€šçŸ¥æ¶ˆè´¹é˜Ÿåˆ—æœ‰æ–°çš„æ¶ˆæ¯ã€‚<code>NotifyMessageArrivingListener</code> ä¼š è°ƒç”¨ <code>PullRequestHoldService#notifyMessageArriving(...)</code> æ–¹æ³•ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"#pullrequestholdservice\">PullRequestHoldService</a></li>\n</ul>\n</li>\n<li>ç¬¬ 73 è‡³ 92 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ <code>Message</code>ï¼Œè¿›è¡Œè°ƒåº¦ï¼Œç”Ÿæˆ <code>ConsumeQueue</code> å’Œ <code>IndexFile</code> å¯¹åº”çš„å†…å®¹ã€‚è¯¦ç»†è§£æè§ï¼š</li>\n<li>ç¬¬ 93 è‡³ 96 è¡Œ ï¼šè¯·æ±‚å¯¹åº”çš„æ˜¯ <code>Blank</code>ï¼Œå³æ–‡ä»¶å°¾ï¼Œè·³è½¬æŒ‡å‘ä¸‹ä¸€ä¸ª <code>MappedFile</code>ã€‚</li>\n<li>ç¬¬ 97 è‡³ 110 è¡Œ ï¼šè¯·æ±‚æ˜¯æ— æ•ˆè¯·æ±‚ã€‚å‡ºç°è¯¥æƒ…å†µï¼ŒåŸºæœ¬æ˜¯ä¸€ä¸ª<strong>BUG</strong>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 127 è‡³ 128 è¡Œ ï¼šæ¯ 1ms å¾ªç¯æ‰§è¡Œé‡æ”¾é€»è¾‘ã€‚</li>\n<li>ç¬¬ 18 è‡³ 30 è¡Œ ï¼š<code>shutdown</code>æ—¶ï¼Œå¤šæ¬¡ <code>sleep(100)</code> ç›´åˆ° <code>CommitLog</code> å›æ”¾åˆ°æœ€æ–°ä½ç½®ã€‚æ©ï¼Œå¦‚æœæœªå›æ”¾å®Œï¼Œä¼šè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚</li>\n</ul>\n<h3>DefaultMessageStore#doDispatch(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ‰§è¡Œè°ƒåº¦è¯·æ±‚</div><div class=\"line\"> 3:  * 1. éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</div><div class=\"line\"> 4:  * 2. å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</div><div class=\"line\"> 5:  *</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> req è°ƒåº¦è¯·æ±‚</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">(DispatchRequest req)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"comment\">// éäº‹åŠ¡æ¶ˆæ¯ æˆ– äº‹åŠ¡æäº¤æ¶ˆæ¯ å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</span></div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">switch</span> (tranType) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class=\"line\"><span class=\"number\">14</span>:             DefaultMessageStore.<span class=\"keyword\">this</span>.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),</div><div class=\"line\"><span class=\"number\">15</span>:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());</div><div class=\"line\"><span class=\"number\">16</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125;</div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"comment\">// å»ºç«‹ ç´¢å¼•ä¿¡æ¯ åˆ° IndexFile</span></div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">if</span> (DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().isMessageIndexEnable()) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:         DefaultMessageStore.<span class=\"keyword\">this</span>.indexService.buildIndex(req);</div><div class=\"line\"><span class=\"number\">24</span>:     &#125;</div><div class=\"line\"><span class=\"number\">25</span>: &#125;</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>: <span class=\"comment\">/**</span></div><div class=\"line\">28:  * å»ºç«‹ æ¶ˆæ¯ä½ç½®ä¿¡æ¯ åˆ° ConsumeQueue</div><div class=\"line\">29:  *</div><div class=\"line\">30:  * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">31:  * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">32:  * <span class=\"doctag\">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class=\"line\">33:  * <span class=\"doctag\">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class=\"line\">34:  * <span class=\"doctag\">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class=\"line\">35:  * <span class=\"doctag\">@param</span> storeTimestamp å­˜å‚¨æ—¶é—´</div><div class=\"line\">36:  * <span class=\"doctag\">@param</span> logicOffset é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">37:  */</div><div class=\"line\"><span class=\"number\">38</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putMessagePositionInfo</span><span class=\"params\">(String topic, <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">long</span> offset, <span class=\"keyword\">int</span> size, <span class=\"keyword\">long</span> tagsCode, <span class=\"keyword\">long</span> storeTimestamp,</span></span></div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"keyword\">long</span> logicOffset) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:     ConsumeQueue cq = <span class=\"keyword\">this</span>.findConsumeQueue(topic, queueId);</div><div class=\"line\"><span class=\"number\">41</span>:     cq.putMessagePositionInfoWrapper(offset, size, tagsCode, storeTimestamp, logicOffset);</div><div class=\"line\"><span class=\"number\">42</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>ConsumeQueue#putMessagePositionInfoWrapper(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  2:  * æ·»åŠ ä½ç½®ä¿¡æ¯å°è£…</div><div class=\"line\">  3:  *</div><div class=\"line\">  4:  * <span class=\"doctag\">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> storeTimestamp æ¶ˆæ¯å­˜å‚¨æ—¶é—´</div><div class=\"line\">  8:  * <span class=\"doctag\">@param</span> logicOffset é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">  9:  */</div><div class=\"line\"> <span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putMessagePositionInfoWrapper</span><span class=\"params\">(<span class=\"keyword\">long</span> offset, <span class=\"keyword\">int</span> size, <span class=\"keyword\">long</span> tagsCode, <span class=\"keyword\">long</span> storeTimestamp,</span></span></div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"keyword\">long</span> logicOffset) &#123;</div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxRetries = <span class=\"number\">30</span>;</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">boolean</span> canWrite = <span class=\"keyword\">this</span>.defaultMessageStore.getRunningFlags().isWriteable();</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">// å¤šæ¬¡å¾ªç¯å†™ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; maxRetries &amp;&amp; canWrite; i++) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:         <span class=\"comment\">// è°ƒç”¨æ·»åŠ ä½ç½®ä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">this</span>.putMessagePositionInfo(offset, size, tagsCode, logicOffset);</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">if</span> (result) &#123;</div><div class=\"line\"> <span class=\"number\">19</span>:             <span class=\"comment\">// æ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨check pointã€‚</span></div><div class=\"line\"> <span class=\"number\">20</span>:             <span class=\"keyword\">this</span>.defaultMessageStore.getStoreCheckpoint().setLogicsMsgTimestamp(storeTimestamp);</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">22</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">23</span>:             <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"> <span class=\"number\">24</span>:             log.warn(<span class=\"string\">\"[BUG]put commit log position info to \"</span> + topic + <span class=\"string\">\":\"</span> + queueId + <span class=\"string\">\" \"</span> + offset</div><div class=\"line\"> <span class=\"number\">25</span>:                 + <span class=\"string\">\" failed, retry \"</span> + i + <span class=\"string\">\" times\"</span>);</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">28</span>:                 Thread.sleep(<span class=\"number\">1000</span>);</div><div class=\"line\"> <span class=\"number\">29</span>:             &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:                 log.warn(<span class=\"string\">\"\"</span>, e);</div><div class=\"line\"> <span class=\"number\">31</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">32</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">33</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">34</span>: </div><div class=\"line\"> <span class=\"number\">35</span>:     <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me è®¾ç½®å¼‚å¸¸ä¸å¯å†™å…¥</span></div><div class=\"line\"> <span class=\"number\">36</span>:     log.error(<span class=\"string\">\"[BUG]consume queue can not write, &#123;&#125; &#123;&#125;\"</span>, <span class=\"keyword\">this</span>.topic, <span class=\"keyword\">this</span>.queueId);</div><div class=\"line\"> <span class=\"number\">37</span>:     <span class=\"keyword\">this</span>.defaultMessageStore.getRunningFlags().makeLogicsQueueError();</div><div class=\"line\"> <span class=\"number\">38</span>: &#125;</div><div class=\"line\"> <span class=\"number\">39</span>: </div><div class=\"line\"> <span class=\"number\">40</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 41:  * æ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸ</div><div class=\"line\"> 42:  *</div><div class=\"line\"> 43:  * <span class=\"doctag\">@param</span> offset commitLogå­˜å‚¨ä½ç½®</div><div class=\"line\"> 44:  * <span class=\"doctag\">@param</span> size æ¶ˆæ¯é•¿åº¦</div><div class=\"line\"> 45:  * <span class=\"doctag\">@param</span> tagsCode æ¶ˆæ¯tagsCode</div><div class=\"line\"> 46:  * <span class=\"doctag\">@param</span> cqOffset é˜Ÿåˆ—ä½ç½®</div><div class=\"line\"> 47:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\"> 48:  */</div><div class=\"line\"> <span class=\"number\">49</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">putMessagePositionInfo</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> tagsCode,</span></span></div><div class=\"line\"> <span class=\"number\">50</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> cqOffset) &#123;</div><div class=\"line\"> <span class=\"number\">51</span>:     <span class=\"comment\">// å¦‚æœå·²ç»é‡æ”¾è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ</span></div><div class=\"line\"> <span class=\"number\">52</span>:     <span class=\"keyword\">if</span> (offset &lt;= <span class=\"keyword\">this</span>.maxPhysicOffset) &#123;</div><div class=\"line\"> <span class=\"number\">53</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">54</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">55</span>:     <span class=\"comment\">// å†™å…¥ä½ç½®ä¿¡æ¯åˆ°byteBuffer</span></div><div class=\"line\"> <span class=\"number\">56</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.flip();</div><div class=\"line\"> <span class=\"number\">57</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);</div><div class=\"line\"> <span class=\"number\">58</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.putLong(offset);</div><div class=\"line\"> <span class=\"number\">59</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.putInt(size);</div><div class=\"line\"> <span class=\"number\">60</span>:     <span class=\"keyword\">this</span>.byteBufferIndex.putLong(tagsCode);</div><div class=\"line\"> <span class=\"number\">61</span>:     <span class=\"comment\">// è®¡ç®—consumeQueueå­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFile</span></div><div class=\"line\"> <span class=\"number\">62</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;</div><div class=\"line\"> <span class=\"number\">63</span>:     MappedFile mappedFile = <span class=\"keyword\">this</span>.mappedFileQueue.getLastMappedFile(expectLogicOffset);</div><div class=\"line\"> <span class=\"number\">64</span>:     <span class=\"keyword\">if</span> (mappedFile != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">65</span>:         <span class=\"comment\">// å½“æ˜¯ConsumeQueueç¬¬ä¸€ä¸ªMappedFile &amp;&amp; é˜Ÿåˆ—ä½ç½®éç¬¬ä¸€ä¸ª &amp;&amp; MappedFileæœªå†™å…¥å†…å®¹ï¼Œåˆ™å¡«å……å‰ç½®ç©ºç™½å ä½</span></div><div class=\"line\"> <span class=\"number\">66</span>:         <span class=\"keyword\">if</span> (mappedFile.isFirstCreateInQueue() &amp;&amp; cqOffset != <span class=\"number\">0</span> &amp;&amp; mappedFile.getWrotePosition() == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// TODO ç–‘é—®ï¼šä¸ºå•¥è¿™ä¸ªæ“ä½œã€‚ç›®å‰èƒ½å¤Ÿæƒ³è±¡åˆ°çš„æ˜¯ï¼Œä¸€äº›è€çš„æ¶ˆæ¯å¾ˆä¹…æ²¡å‘é€ï¼Œçªç„¶å‘é€ï¼Œè¿™ä¸ªæ—¶å€™åˆšå¥½æ»¡è¶³ã€‚</span></div><div class=\"line\"> <span class=\"number\">67</span>:             <span class=\"keyword\">this</span>.minLogicOffset = expectLogicOffset;</div><div class=\"line\"> <span class=\"number\">68</span>:             <span class=\"keyword\">this</span>.mappedFileQueue.setFlushedWhere(expectLogicOffset);</div><div class=\"line\"> <span class=\"number\">69</span>:             <span class=\"keyword\">this</span>.mappedFileQueue.setCommittedWhere(expectLogicOffset);</div><div class=\"line\"> <span class=\"number\">70</span>:             <span class=\"keyword\">this</span>.fillPreBlank(mappedFile, expectLogicOffset);</div><div class=\"line\"> <span class=\"number\">71</span>:             log.info(<span class=\"string\">\"fill pre blank space \"</span> + mappedFile.getFileName() + <span class=\"string\">\" \"</span> + expectLogicOffset + <span class=\"string\">\" \"</span></div><div class=\"line\"> <span class=\"number\">72</span>:                 + mappedFile.getWrotePosition());</div><div class=\"line\"> <span class=\"number\">73</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">74</span>:         <span class=\"comment\">// æ ¡éªŒconsumeQueueå­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ã€‚TODO å¦‚æœä¸åˆæ³•ï¼Œç»§ç»­å†™å…¥ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ</span></div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"keyword\">if</span> (cqOffset != <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:             <span class=\"keyword\">long</span> currentLogicOffset = mappedFile.getWrotePosition() + mappedFile.getFileFromOffset();</div><div class=\"line\"> <span class=\"number\">77</span>:             <span class=\"keyword\">if</span> (expectLogicOffset != currentLogicOffset) &#123;</div><div class=\"line\"> <span class=\"number\">78</span>:                 LOG_ERROR.warn(</div><div class=\"line\"> <span class=\"number\">79</span>:                     <span class=\"string\">\"[BUG]logic queue order maybe wrong, expectLogicOffset: &#123;&#125; currentLogicOffset: &#123;&#125; Topic: &#123;&#125; QID: &#123;&#125; Diff: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">80</span>:                     expectLogicOffset,</div><div class=\"line\"> <span class=\"number\">81</span>:                     currentLogicOffset,</div><div class=\"line\"> <span class=\"number\">82</span>:                     <span class=\"keyword\">this</span>.topic,</div><div class=\"line\"> <span class=\"number\">83</span>:                     <span class=\"keyword\">this</span>.queueId,</div><div class=\"line\"> <span class=\"number\">84</span>:                     expectLogicOffset - currentLogicOffset</div><div class=\"line\"> <span class=\"number\">85</span>:                 );</div><div class=\"line\"> <span class=\"number\">86</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">87</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"comment\">// è®¾ç½®commitLogé‡æ”¾æ¶ˆæ¯åˆ°ConsumeQueueä½ç½®ã€‚</span></div><div class=\"line\"> <span class=\"number\">89</span>:         <span class=\"keyword\">this</span>.maxPhysicOffset = offset;</div><div class=\"line\"> <span class=\"number\">90</span>:         <span class=\"comment\">// æ’å…¥mappedFile</span></div><div class=\"line\"> <span class=\"number\">91</span>:         <span class=\"keyword\">return</span> mappedFile.appendMessage(<span class=\"keyword\">this</span>.byteBufferIndex.array());</div><div class=\"line\"> <span class=\"number\">92</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">93</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">94</span>: &#125;</div><div class=\"line\"> <span class=\"number\">95</span>: </div><div class=\"line\"> <span class=\"number\">96</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 97:  * å¡«å……å‰ç½®ç©ºç™½å ä½</div><div class=\"line\"> 98:  *</div><div class=\"line\"> 99:  * <span class=\"doctag\">@param</span> mappedFile MappedFile</div><div class=\"line\">100:  * <span class=\"doctag\">@param</span> untilWhere consumeQueueå­˜å‚¨ä½ç½®</div><div class=\"line\">101:  */</div><div class=\"line\"><span class=\"number\">102</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">fillPreBlank</span><span class=\"params\">(<span class=\"keyword\">final</span> MappedFile mappedFile, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> untilWhere)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">103</span>:     <span class=\"comment\">// å†™å…¥å‰ç½®ç©ºç™½å ä½åˆ°byteBuffer</span></div><div class=\"line\"><span class=\"number\">104</span>:     ByteBuffer byteBuffer = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);</div><div class=\"line\"><span class=\"number\">105</span>:     byteBuffer.putLong(<span class=\"number\">0L</span>);</div><div class=\"line\"><span class=\"number\">106</span>:     byteBuffer.putInt(Integer.MAX_VALUE);</div><div class=\"line\"><span class=\"number\">107</span>:     byteBuffer.putLong(<span class=\"number\">0L</span>);</div><div class=\"line\"><span class=\"number\">108</span>:     <span class=\"comment\">// å¾ªç¯å¡«ç©º</span></div><div class=\"line\"><span class=\"number\">109</span>:     <span class=\"keyword\">int</span> until = (<span class=\"keyword\">int</span>) (untilWhere % <span class=\"keyword\">this</span>.mappedFileQueue.getMappedFileSize());</div><div class=\"line\"><span class=\"number\">110</span>:     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; until; i += CQ_STORE_UNIT_SIZE) &#123;</div><div class=\"line\"><span class=\"number\">111</span>:         mappedFile.appendMessage(byteBuffer.array());</div><div class=\"line\"><span class=\"number\">112</span>:     &#125;</div><div class=\"line\"><span class=\"number\">113</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>#putMessagePositionInfoWrapper(...)</code> è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° <code>ConsumeQueue</code> çš„å°è£…ï¼Œå®é™…éœ€è¦è°ƒç”¨ <code>#putMessagePositionInfo(...)</code> æ–¹æ³•ã€‚\n<ul>\n<li>ç¬¬ 13 è¡Œ ï¼šåˆ¤æ–­ <code>ConsumeQueue</code> æ˜¯å¦å…è®¸å†™å…¥ã€‚å½“å‘ç”ŸBugæ—¶ï¼Œä¸å…è®¸å†™å…¥ã€‚</li>\n<li>ç¬¬ 17 è¡Œ ï¼šè°ƒç”¨ <code>#putMessagePositionInfo(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä½ç½®ä¿¡æ¯ã€‚</li>\n<li>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ¶ˆæ¯å­˜å‚¨æ—¶é—´ ä½œä¸º å­˜å‚¨æ£€æŸ¥ç‚¹ã€‚<code>StoreCheckpoint</code> çš„è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/store-init-and-shutdown/\">Storeåˆå§‹åŒ–ä¸å…³é—­</a>ã€‚</li>\n<li>ç¬¬ 22 è‡³ 32 è¡Œ ï¼šæ·»åŠ å¤±è´¥ï¼Œç›®å‰åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯BUGã€‚</li>\n<li>ç¬¬ 35 è‡³ 37 è¡Œ ï¼šå†™å…¥å¤±è´¥æ—¶ï¼Œæ ‡è®° <code>ConsumeQueue</code> å†™å…¥å¼‚å¸¸ï¼Œä¸å…è®¸ç»§ç»­å†™å…¥ã€‚</li>\n</ul>\n</li>\n<li><code>#putMessagePositionInfo(...)</code> è¯´æ˜ ï¼šæ·»åŠ ä½ç½®ä¿¡æ¯åˆ° <code>ConsumeQueue</code>ï¼Œå¹¶è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸã€‚\n<ul>\n<li>ç¬¬ 51 è‡³ 54 è¡Œ ï¼šå¦‚æœ <code>offset</code>(å­˜å‚¨ä½ç½®) å°äºç­‰äº  <code>maxPhysicOffset</code>(<code>CommitLog</code> æ¶ˆæ¯é‡æ”¾åˆ° <code>ConsumeQueue</code> æœ€å¤§çš„ <code>CommitLog</code> å­˜å‚¨ä½ç½®)ï¼Œè¡¨ç¤ºå·²ç»é‡æ”¾è¿‡ï¼Œæ­¤æ—¶ï¼Œä¸å†é‡å¤å†™å…¥ï¼Œç›´æ¥è¿”å›å†™å…¥æˆåŠŸã€‚</li>\n<li>ç¬¬ 55 è‡³ 60 è¡Œ ï¼šå†™ ä½ç½®ä¿¡æ¯åˆ°byteBufferã€‚</li>\n<li>ç¬¬ 62 è‡³ 63 è¡Œ ï¼šè®¡ç®— <code>ConsumeQueue</code>å­˜å‚¨ä½ç½®ï¼Œå¹¶è·å¾—å¯¹åº”çš„MappedFileã€‚</li>\n<li>ç¬¬ 65 è‡³ 73 è¡Œ ï¼šå½“ <code>MappedFile</code> æ˜¯ <code>ConsumeQueue</code> å½“å‰ç¬¬ä¸€ä¸ªæ–‡ä»¶ &amp;&amp; <code>MappedFile</code> æœªå†™å…¥å†…å®¹ &amp;&amp; é‡æ”¾æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å¤§äº0ï¼Œåˆ™éœ€è¦è¿›è¡Œ <code>MappedFile</code> å¡«å……å‰ç½®  <code>BLANK</code>ã€‚\n<ul>\n<li><em>è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä¼šéœ€è¦ã€‚çŒœæµ‹äº§ç”Ÿçš„åŸå› ï¼šä¸€ä¸ª <code>Topic</code> é•¿æœŸæ— æ¶ˆæ¯äº§ç”Ÿï¼Œçªç„¶Nå¤©åè¿›è¡Œå‘é€ï¼Œ<code>Topic</code> å¯¹åº”çš„å†å²æ¶ˆæ¯ä»¥åŠå’Œæ¶ˆè´¹é˜Ÿåˆ—æ•°æ®å·²ç»è¢«æ¸…ç†ï¼Œæ–°ç”Ÿæˆçš„<code>MappedFile</code>éœ€è¦å‰ç½®å ä½ã€‚</em></li>\n</ul>\n</li>\n<li>ç¬¬ 74 è‡³ 87 è¡Œ ï¼šæ ¡éªŒ <code>ConsumeQueue</code> å­˜å‚¨ä½ç½®æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™è¾“å‡ºæ—¥å¿—ã€‚\n<ul>\n<li><em>è¿™å—æ¯”è¾ƒæœ‰ç–‘é—®ï¼Œå¦‚æœè®¡ç®—å‡ºæ¥çš„å­˜å‚¨ä½ç½®ä¸åˆæ³•ï¼Œä¸è¿”å›æ·»åŠ å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œæ·»åŠ ä½ç½®ä¿¡æ¯ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿ</em></li>\n</ul>\n</li>\n<li>ç¬¬ 89 è¡Œ ï¼šè®¾ç½® <code>CommitLog</code> é‡æ”¾æ¶ˆæ¯åˆ° <code>ConsumeQueue</code> çš„æœ€å¤§ä½ç½®ã€‚</li>\n<li>ç¬¬ 91 è¡Œ ï¼šæ’å…¥æ¶ˆæ¯ä½ç½®åˆ° <code>MappedFile</code>ã€‚</li>\n</ul>\n</li>\n</ul>\n<h2>FlushConsumeQueueService</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FlushConsumeQueueService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> RETRY_TIMES_OVER = <span class=\"number\">3</span>;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * æœ€åflushæ—¶é—´æˆ³</div><div class=\"line\"> 5:      */</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> lastFlushTimestamp = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doFlush</span><span class=\"params\">(<span class=\"keyword\">int</span> retryTimes)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">int</span> flushConsumeQueueLeastPages = DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getFlushConsumeQueueLeastPages();</div><div class=\"line\"><span class=\"number\">10</span>: </div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"comment\">// retryTimes == RETRY_TIMES_OVERæ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ä¸»è¦ç”¨äºshutdownæ—¶ã€‚</span></div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">if</span> (retryTimes == RETRY_TIMES_OVER) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:             flushConsumeQueueLeastPages = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">14</span>:         &#125;</div><div class=\"line\"><span class=\"number\">15</span>:         <span class=\"comment\">// å½“æ—¶é—´æ»¡è¶³flushConsumeQueueThoroughIntervalæ—¶ï¼Œå³ä½¿å†™å…¥çš„æ•°é‡ä¸è¶³flushConsumeQueueLeastPagesï¼Œä¹Ÿè¿›è¡Œflush</span></div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">long</span> logicsMsgTimestamp = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">int</span> flushConsumeQueueThoroughInterval = DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getFlushConsumeQueueThoroughInterval();</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">long</span> currentTimeMillis = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (currentTimeMillis &gt;= (<span class=\"keyword\">this</span>.lastFlushTimestamp + flushConsumeQueueThoroughInterval)) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">this</span>.lastFlushTimestamp = currentTimeMillis;</div><div class=\"line\"><span class=\"number\">21</span>:             flushConsumeQueueLeastPages = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">22</span>:             logicsMsgTimestamp = DefaultMessageStore.<span class=\"keyword\">this</span>.getStoreCheckpoint().getLogicsMsgTimestamp();</div><div class=\"line\"><span class=\"number\">23</span>:         &#125;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"comment\">// flushæ¶ˆè´¹é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">25</span>:         ConcurrentHashMap&lt;String, ConcurrentHashMap&lt;Integer, ConsumeQueue&gt;&gt; tables = DefaultMessageStore.<span class=\"keyword\">this</span>.consumeQueueTable;</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">for</span> (ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; maps : tables.values()) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">for</span> (ConsumeQueue cq : maps.values()) &#123;</div><div class=\"line\"><span class=\"number\">28</span>:                 <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">29</span>:                 <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; retryTimes &amp;&amp; !result; i++) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                     result = cq.flush(flushConsumeQueueLeastPages);</div><div class=\"line\"><span class=\"number\">31</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">32</span>:             &#125;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:         <span class=\"comment\">// flush å­˜å‚¨ check point</span></div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == flushConsumeQueueLeastPages) &#123;</div><div class=\"line\"><span class=\"number\">36</span>:             <span class=\"keyword\">if</span> (logicsMsgTimestamp &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:                 DefaultMessageStore.<span class=\"keyword\">this</span>.getStoreCheckpoint().setLogicsMsgTimestamp(logicsMsgTimestamp);</div><div class=\"line\"><span class=\"number\">38</span>:             &#125;</div><div class=\"line\"><span class=\"number\">39</span>:             DefaultMessageStore.<span class=\"keyword\">this</span>.getStoreCheckpoint().flush();</div><div class=\"line\"><span class=\"number\">40</span>:         &#125;</div><div class=\"line\"><span class=\"number\">41</span>:     &#125;</div><div class=\"line\"><span class=\"number\">42</span>: </div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">44</span>:         DefaultMessageStore.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">45</span>: </div><div class=\"line\"><span class=\"number\">46</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">48</span>:                 <span class=\"keyword\">int</span> interval = DefaultMessageStore.<span class=\"keyword\">this</span>.getMessageStoreConfig().getFlushIntervalConsumeQueue();</div><div class=\"line\"><span class=\"number\">49</span>:                 <span class=\"keyword\">this</span>.waitForRunning(interval);</div><div class=\"line\"><span class=\"number\">50</span>:                 <span class=\"keyword\">this</span>.doFlush(<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">51</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:                 DefaultMessageStore.log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"><span class=\"number\">53</span>:             &#125;</div><div class=\"line\"><span class=\"number\">54</span>:         &#125;</div><div class=\"line\"><span class=\"number\">55</span>: </div><div class=\"line\"><span class=\"number\">56</span>:         <span class=\"keyword\">this</span>.doFlush(RETRY_TIMES_OVER);</div><div class=\"line\"><span class=\"number\">57</span>: </div><div class=\"line\"><span class=\"number\">58</span>:         DefaultMessageStore.log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">59</span>:     &#125;</div><div class=\"line\"><span class=\"number\">60</span>: </div><div class=\"line\"><span class=\"number\">61</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">62</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">63</span>:         <span class=\"keyword\">return</span> FlushConsumeQueueService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">64</span>:     &#125;</div><div class=\"line\"><span class=\"number\">65</span>: </div><div class=\"line\"><span class=\"number\">66</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">67</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getJointime</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">68</span>:         <span class=\"keyword\">return</span> <span class=\"number\">1000</span> * <span class=\"number\">60</span>;</div><div class=\"line\"><span class=\"number\">69</span>:     &#125;</div><div class=\"line\"><span class=\"number\">70</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šflush <code>ConsumeQueue</code>(æ¶ˆè´¹é˜Ÿåˆ—) çº¿ç¨‹æœåŠ¡ã€‚</li>\n<li>ç¬¬ 11 è‡³ 14 è¡Œ ï¼šå½“ <code>retryTimes == RETRY_TIMES_OVER</code> æ—¶ï¼Œè¿›è¡Œå¼ºåˆ¶flushã€‚ç”¨äº <code>shutdown</code> æ—¶ã€‚</li>\n<li>ç¬¬ 15 è‡³ 23 è¡Œ ï¼šæ¯ flushConsumeQueueThoroughInterval å‘¨æœŸï¼Œæ‰§è¡Œä¸€æ¬¡ flush ã€‚å› ä¸ºä¸æ˜¯æ¯æ¬¡å¾ªç¯åˆ°éƒ½èƒ½æ»¡è¶³ flushConsumeQueueLeastPages å¤§å°ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸€å®šå‘¨æœŸè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶ flush ã€‚å½“ç„¶ï¼Œä¸èƒ½æ¯æ¬¡å¾ªç¯éƒ½å»æ‰§è¡Œå¼ºåˆ¶ flushï¼Œè¿™æ ·æ€§èƒ½è¾ƒå·®ã€‚</li>\n<li>ç¬¬ 24 è‡³ 33 è¡Œ ï¼šflush <code>ConsumeQueue</code>(æ¶ˆè´¹é˜Ÿåˆ—)ã€‚\n<ul>\n<li>flush é€»è¾‘ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-store/#MappedFile-%E8%90%BD%E7%9B%98\">MappedFile#è½ç›˜</a>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 34 è‡³ 40 è¡Œ ï¼šflush <code>StoreCheckpoint</code>ã€‚<code>StoreCheckpoint</code> çš„è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/store-init-and-shutdown/\">Storeåˆå§‹åŒ–ä¸å…³é—­</a>ã€‚</li>\n<li>ç¬¬ 43 è‡³ 59 è¡Œ ï¼šæ¯ 1000ms æ‰§è¡Œä¸€æ¬¡ <code>flush</code>ã€‚å¦‚æœ wakeup() æ—¶ï¼Œåˆ™ä¼šç«‹å³è¿›è¡Œä¸€æ¬¡ <code>flush</code>ã€‚ç›®å‰ï¼Œæš‚æ—¶ä¸å­˜åœ¨ wakeup() çš„è°ƒç”¨ã€‚</li>\n</ul>\n<h1>4ã€Broker æä¾›[æ‹‰å–æ¶ˆæ¯]æ¥å£</h1>\n<h2>PullMessageRequestHeader</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PullMessageRequestHeader</span> <span class=\"keyword\">implements</span> <span class=\"title\">CommandCustomHeader</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 3:      * æ¶ˆè´¹è€…åˆ†ç»„</div><div class=\"line\"> 4:      */</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> String consumerGroup;</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 8:      * Topic</div><div class=\"line\"> 9:      */</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">private</span> String topic;</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">13:      * é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">14:      */</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">private</span> Integer queueId;</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">18:      * é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class=\"line\">19:      */</div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"keyword\">private</span> Long queueOffset;</div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">23:      * æ¶ˆæ¯æ•°é‡</div><div class=\"line\">24:      */</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">private</span> Integer maxMsgNums;</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">28:      * ç³»ç»Ÿæ ‡è¯†</div><div class=\"line\">29:      */</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"keyword\">private</span> Integer sysFlag;</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">33:      * æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®</div><div class=\"line\">34:      */</div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"keyword\">private</span> Long commitOffset;</div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">38:      * æŒ‚èµ·è¶…æ—¶æ—¶é—´</div><div class=\"line\">39:      */</div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">41</span>:     <span class=\"keyword\">private</span> Long suspendTimeoutMillis;</div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">43:      * è®¢é˜…è¡¨è¾¾å¼</div><div class=\"line\">44:      */</div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"meta\">@CFNullable</span></div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">private</span> String subscription;</div><div class=\"line\"><span class=\"number\">47</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">48:      * è®¢é˜…ç‰ˆæœ¬å·</div><div class=\"line\">49:      */</div><div class=\"line\"><span class=\"number\">50</span>:     <span class=\"meta\">@CFNotNull</span></div><div class=\"line\"><span class=\"number\">51</span>:     <span class=\"keyword\">private</span> Long subVersion;</div><div class=\"line\"><span class=\"number\">52</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚Header</li>\n<li>topic +  queueId + queueOffset + maxMsgNums</li>\n<li>sysFlag ï¼šç³»ç»Ÿæ ‡è¯†ã€‚\n<ul>\n<li>ç¬¬ 0 ä½ <code>FLAG_COMMIT_OFFSET</code> ï¼šæ ‡è®°è¯·æ±‚æäº¤æ¶ˆè´¹è¿›åº¦ä½ç½®ï¼Œå’Œ <code>commitOffset</code> é…åˆã€‚</li>\n<li>ç¬¬ 1 ä½ <code>FLAG_SUSPEND</code> ï¼šæ ‡è®°è¯·æ±‚æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå’Œ <code>suspendTimeoutMillis</code> é…åˆã€‚å½“æ‹‰å–ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œ <code>Broker</code> ä¼šæŒ‚èµ·è¯·æ±‚ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ã€‚æœ€å¤§æŒ‚èµ·æ—¶é—´ï¼š<code>suspendTimeoutMillis</code> æ¯«ç§’ã€‚</li>\n<li>ç¬¬ 2 ä½ <code>FLAG_SUBSCRIPTION</code> ï¼šæ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼ï¼Œå’Œ <code>subscription</code> é…ç½®ã€‚</li>\n</ul>\n</li>\n<li>subVersion ï¼šè®¢é˜…ç‰ˆæœ¬å·ã€‚è¯·æ±‚æ—¶ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸å¯¹ï¼Œåˆ™æ— æ³•æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°è·å–è®¢é˜…ä¿¡æ¯ï¼Œä½¿ç”¨æœ€æ–°çš„è®¢é˜…ç‰ˆæœ¬å·ã€‚</li>\n</ul>\n<h2>PullMessageProcessor#processRequest(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">processRequest</span><span class=\"params\">(<span class=\"keyword\">final</span> Channel channel, RemotingCommand request, <span class=\"keyword\">boolean</span> brokerAllowSuspend)</span></span></div><div class=\"line\">  2:     <span class=\"keyword\">throws</span> RemotingCommandException &#123;</div><div class=\"line\">  <span class=\"number\">3</span>:     RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);</div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();</div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> PullMessageRequestHeader requestHeader =</div><div class=\"line\">  <span class=\"number\">6</span>:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);</div><div class=\"line\">  <span class=\"number\">7</span>: </div><div class=\"line\">  <span class=\"number\">8</span>:     response.setOpaque(request.getOpaque());</div><div class=\"line\">  <span class=\"number\">9</span>: </div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"keyword\">if</span> (LOG.isDebugEnabled()) &#123;</div><div class=\"line\"> <span class=\"number\">11</span>:         LOG.debug(<span class=\"string\">\"receive PullMessage request command, &#123;&#125;\"</span>, request);</div><div class=\"line\"> <span class=\"number\">12</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">13</span>: </div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">// æ ¡éªŒ broker æ˜¯å¦å¯è¯»</span></div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (!PermName.isReadable(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">17</span>:         response.setRemark(String.format(<span class=\"string\">\"the broker[%s] pulling message is forbidden\"</span>, <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerIP1()));</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">19</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">20</span>: </div><div class=\"line\"> <span class=\"number\">21</span>:     <span class=\"comment\">// æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">22</span>:     SubscriptionGroupConfig subscriptionGroupConfig = <span class=\"keyword\">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">23</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionGroupConfig) &#123;</div><div class=\"line\"> <span class=\"number\">24</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">25</span>:         response.setRemark(String.format(<span class=\"string\">\"subscription group [%s] does not exist, %s\"</span>, requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));</div><div class=\"line\"> <span class=\"number\">26</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">27</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"comment\">// æ ¡éªŒ consumeråˆ†ç»„é…ç½® æ˜¯å¦å¯æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">if</span> (!subscriptionGroupConfig.isConsumeEnable()) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">31</span>:         response.setRemark(<span class=\"string\">\"subscription group no permission, \"</span> + requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">32</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">33</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">34</span>: </div><div class=\"line\"> <span class=\"number\">35</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag()); <span class=\"comment\">// æ˜¯å¦æŒ‚èµ·è¯·æ±‚ï¼Œå½“æ²¡æœ‰æ¶ˆæ¯æ—¶</span></div><div class=\"line\"> <span class=\"number\">36</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag()); <span class=\"comment\">// æ˜¯å¦æäº¤æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">37</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag()); <span class=\"comment\">// æ˜¯å¦è¿‡æ»¤è®¢é˜…è¡¨è¾¾å¼(subscription)</span></div><div class=\"line\"> <span class=\"number\">38</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : <span class=\"number\">0</span>; <span class=\"comment\">// æŒ‚èµ·è¯·æ±‚è¶…æ—¶æ—¶é•¿</span></div><div class=\"line\"> <span class=\"number\">39</span>: </div><div class=\"line\"> <span class=\"number\">40</span>:     <span class=\"comment\">// æ ¡éªŒ topicé…ç½® å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">41</span>:     TopicConfig topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class=\"line\"> <span class=\"number\">42</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"> <span class=\"number\">43</span>:         LOG.error(<span class=\"string\">\"The topic &#123;&#125; not exist, consumer: &#123;&#125; \"</span>, requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));</div><div class=\"line\"> <span class=\"number\">44</span>:         response.setCode(ResponseCode.TOPIC_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">45</span>:         response.setRemark(String.format(<span class=\"string\">\"topic[%s] not exist, apply first please! %s\"</span>, requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));</div><div class=\"line\"> <span class=\"number\">46</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">47</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">48</span>:     <span class=\"comment\">// æ ¡éªŒ topicé…ç½® æƒé™å¯è¯»</span></div><div class=\"line\"> <span class=\"number\">49</span>:     <span class=\"keyword\">if</span> (!PermName.isReadable(topicConfig.getPerm())) &#123;</div><div class=\"line\"> <span class=\"number\">50</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">51</span>:         response.setRemark(<span class=\"string\">\"the topic[\"</span> + requestHeader.getTopic() + <span class=\"string\">\"] pulling message is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">52</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">53</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">54</span>:     <span class=\"comment\">// æ ¡éªŒ è¯»å–é˜Ÿåˆ— åœ¨ topicé…ç½® é˜Ÿåˆ—èŒƒå›´å†…</span></div><div class=\"line\"> <span class=\"number\">55</span>:     <span class=\"keyword\">if</span> (requestHeader.getQueueId() &lt; <span class=\"number\">0</span> || requestHeader.getQueueId() &gt;= topicConfig.getReadQueueNums()) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:         String errorInfo = String.format(<span class=\"string\">\"queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]\"</span>,</div><div class=\"line\"> <span class=\"number\">57</span>:                 requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());</div><div class=\"line\"> <span class=\"number\">58</span>:         LOG.warn(errorInfo);</div><div class=\"line\"> <span class=\"number\">59</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">60</span>:         response.setRemark(errorInfo);</div><div class=\"line\"> <span class=\"number\">61</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">62</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">63</span>: </div><div class=\"line\"> <span class=\"number\">64</span>:     <span class=\"comment\">// æ ¡éªŒ è®¢é˜…å…³ç³»</span></div><div class=\"line\"> <span class=\"number\">65</span>:     SubscriptionData subscriptionData;</div><div class=\"line\"> <span class=\"number\">66</span>:     <span class=\"keyword\">if</span> (hasSubscriptionFlag) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">68</span>:             subscriptionData = FilterAPI.buildSubscriptionData(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class=\"line\"> <span class=\"number\">69</span>:                 requestHeader.getSubscription());</div><div class=\"line\"> <span class=\"number\">70</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">71</span>:             LOG.warn(<span class=\"string\">\"Parse the consumer's subscription[&#123;&#125;] failed, group: &#123;&#125;\"</span>, requestHeader.getSubscription(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">72</span>:                     requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">73</span>:             response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);</div><div class=\"line\"> <span class=\"number\">74</span>:             response.setRemark(<span class=\"string\">\"parse the consumer's subscription failed\"</span>);</div><div class=\"line\"> <span class=\"number\">75</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">76</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">77</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">78</span>:         <span class=\"comment\">// æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ˜¯å¦å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">79</span>:         ConsumerGroupInfo consumerGroupInfo = <span class=\"keyword\">this</span>.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">80</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == consumerGroupInfo) &#123;</div><div class=\"line\"> <span class=\"number\">81</span>:             LOG.warn(<span class=\"string\">\"The consumer's group info not exist, group: &#123;&#125;\"</span>, requestHeader.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">82</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">83</span>:             response.setRemark(<span class=\"string\">\"the consumer's group info not exist\"</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class=\"line\"> <span class=\"number\">84</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">85</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>:         <span class=\"comment\">// æ ¡éªŒ æ¶ˆè´¹åˆ†ç»„ä¿¡æ¯ æ¶ˆæ¯æ¨¡å‹æ˜¯å¦åŒ¹é…</span></div><div class=\"line\"> <span class=\"number\">87</span>:         <span class=\"keyword\">if</span> (!subscriptionGroupConfig.isConsumeBroadcastEnable() <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">88</span>:             &amp;&amp; consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) &#123;</div><div class=\"line\"> <span class=\"number\">89</span>:             response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">90</span>:             response.setRemark(<span class=\"string\">\"the consumer group[\"</span> + requestHeader.getConsumerGroup() + <span class=\"string\">\"] can not consume by broadcast way\"</span>);</div><div class=\"line\"> <span class=\"number\">91</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">92</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">93</span>: </div><div class=\"line\"> <span class=\"number\">94</span>:         <span class=\"comment\">// æ ¡éªŒ è®¢é˜…ä¿¡æ¯ æ˜¯å¦å­˜åœ¨</span></div><div class=\"line\"> <span class=\"number\">95</span>:         subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());</div><div class=\"line\"> <span class=\"number\">96</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionData) &#123;</div><div class=\"line\"> <span class=\"number\">97</span>:             LOG.warn(<span class=\"string\">\"The consumer's subscription not exist, group: &#123;&#125;, topic:&#123;&#125;\"</span>, requestHeader.getConsumerGroup(), requestHeader.getTopic());</div><div class=\"line\"> <span class=\"number\">98</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">99</span>:             response.setRemark(<span class=\"string\">\"the consumer's subscription not exist\"</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class=\"line\"><span class=\"number\">100</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">101</span>:         &#125;</div><div class=\"line\"><span class=\"number\">102</span>:         <span class=\"comment\">// æ ¡éªŒ è®¢é˜…ä¿¡æ¯ç‰ˆæœ¬ æ˜¯å¦åˆæ³•</span></div><div class=\"line\"><span class=\"number\">103</span>:         <span class=\"keyword\">if</span> (subscriptionData.getSubVersion() &lt; requestHeader.getSubVersion()) &#123;</div><div class=\"line\"><span class=\"number\">104</span>:             LOG.warn(<span class=\"string\">\"The broker's subscription is not latest, group: &#123;&#125; &#123;&#125;\"</span>, requestHeader.getConsumerGroup(),</div><div class=\"line\"><span class=\"number\">105</span>:                     subscriptionData.getSubString());</div><div class=\"line\"><span class=\"number\">106</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);</div><div class=\"line\"><span class=\"number\">107</span>:             response.setRemark(<span class=\"string\">\"the consumer's subscription not latest\"</span>);</div><div class=\"line\"><span class=\"number\">108</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">109</span>:         &#125;</div><div class=\"line\"><span class=\"number\">110</span>:     &#125;</div><div class=\"line\"><span class=\"number\">111</span>: </div><div class=\"line\"><span class=\"number\">112</span>:     <span class=\"comment\">// è·å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">113</span>:     <span class=\"keyword\">final</span> GetMessageResult getMessageResult = <span class=\"keyword\">this</span>.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class=\"line\"><span class=\"number\">114</span>:             requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), subscriptionData);</div><div class=\"line\"><span class=\"number\">115</span>:     <span class=\"keyword\">if</span> (getMessageResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">116</span>:         response.setRemark(getMessageResult.getStatus().name());</div><div class=\"line\"><span class=\"number\">117</span>:         responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">118</span>:         responseHeader.setMinOffset(getMessageResult.getMinOffset());</div><div class=\"line\"><span class=\"number\">119</span>:         responseHeader.setMaxOffset(getMessageResult.getMaxOffset());</div><div class=\"line\"><span class=\"number\">120</span>: </div><div class=\"line\"><span class=\"number\">121</span>:         <span class=\"comment\">// TODO å¾…è¯»</span></div><div class=\"line\"><span class=\"number\">122</span>:         <span class=\"comment\">// è®¡ç®—å»ºè®®è¯»å–brokerId</span></div><div class=\"line\"><span class=\"number\">123</span>:         <span class=\"keyword\">if</span> (getMessageResult.isSuggestPullingFromSlave()) &#123;</div><div class=\"line\"><span class=\"number\">124</span>:             responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class=\"line\"><span class=\"number\">125</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">126</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class=\"line\"><span class=\"number\">127</span>:         &#125;</div><div class=\"line\"><span class=\"number\">128</span>: </div><div class=\"line\"><span class=\"number\">129</span>:         <span class=\"keyword\">switch</span> (<span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().getBrokerRole()) &#123;</div><div class=\"line\"><span class=\"number\">130</span>:             <span class=\"keyword\">case</span> ASYNC_MASTER:</div><div class=\"line\"><span class=\"number\">131</span>:             <span class=\"keyword\">case</span> SYNC_MASTER:</div><div class=\"line\"><span class=\"number\">132</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">133</span>:             <span class=\"keyword\">case</span> SLAVE:</div><div class=\"line\"><span class=\"number\">134</span>:                 <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123; <span class=\"comment\">// ä»èŠ‚ç‚¹ä¸å…è®¸è¯»å–ï¼Œå‘Šè¯‰consumerè¯»å–ä¸»èŠ‚ç‚¹ã€‚</span></div><div class=\"line\"><span class=\"number\">135</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class=\"line\"><span class=\"number\">136</span>:                     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class=\"line\"><span class=\"number\">137</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">138</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">139</span>:         &#125;</div><div class=\"line\"><span class=\"number\">140</span>: </div><div class=\"line\"><span class=\"number\">141</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123;</div><div class=\"line\"><span class=\"number\">142</span>:             <span class=\"comment\">// consume too slow ,redirect to another machine</span></div><div class=\"line\"><span class=\"number\">143</span>:             <span class=\"keyword\">if</span> (getMessageResult.isSuggestPullingFromSlave()) &#123;</div><div class=\"line\"><span class=\"number\">144</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class=\"line\"><span class=\"number\">145</span>:             &#125;</div><div class=\"line\"><span class=\"number\">146</span>:             <span class=\"comment\">// consume ok</span></div><div class=\"line\"><span class=\"number\">147</span>:             <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">148</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class=\"line\"><span class=\"number\">149</span>:             &#125;</div><div class=\"line\"><span class=\"number\">150</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">151</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class=\"line\"><span class=\"number\">152</span>:         &#125;</div><div class=\"line\"><span class=\"number\">153</span>: </div><div class=\"line\"><span class=\"number\">154</span>:         <span class=\"keyword\">switch</span> (getMessageResult.getStatus()) &#123;</div><div class=\"line\"><span class=\"number\">155</span>:             <span class=\"keyword\">case</span> FOUND:</div><div class=\"line\"><span class=\"number\">156</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"><span class=\"number\">157</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">158</span>:             <span class=\"keyword\">case</span> MESSAGE_WAS_REMOVING:</div><div class=\"line\"><span class=\"number\">159</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class=\"line\"><span class=\"number\">160</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">161</span>:             <span class=\"keyword\">case</span> NO_MATCHED_LOGIC_QUEUE:</div><div class=\"line\"><span class=\"number\">162</span>:             <span class=\"keyword\">case</span> NO_MESSAGE_IN_QUEUE:</div><div class=\"line\"><span class=\"number\">163</span>:                 <span class=\"keyword\">if</span> (<span class=\"number\">0</span> != requestHeader.getQueueOffset()) &#123;</div><div class=\"line\"><span class=\"number\">164</span>:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class=\"line\"><span class=\"number\">165</span>: </div><div class=\"line\"><span class=\"number\">166</span>:                     <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"><span class=\"number\">167</span>:                     LOG.info(<span class=\"string\">\"the broker store no queue data, fix the request offset &#123;&#125; to &#123;&#125;, Topic: &#123;&#125; QueueId: &#123;&#125; Consumer Group: &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">168</span>:                         requestHeader.getQueueOffset(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">169</span>:                         getMessageResult.getNextBeginOffset(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">170</span>:                         requestHeader.getTopic(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">171</span>:                         requestHeader.getQueueId(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">172</span>:                         requestHeader.getConsumerGroup()<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">173</span>:                     );</div><div class=\"line\"><span class=\"number\">174</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">175</span>:                     response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class=\"line\"><span class=\"number\">176</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">177</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">178</span>:             <span class=\"keyword\">case</span> NO_MATCHED_MESSAGE:</div><div class=\"line\"><span class=\"number\">179</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class=\"line\"><span class=\"number\">180</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">181</span>:             <span class=\"keyword\">case</span> OFFSET_FOUND_NULL:</div><div class=\"line\"><span class=\"number\">182</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class=\"line\"><span class=\"number\">183</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">184</span>:             <span class=\"keyword\">case</span> OFFSET_OVERFLOW_BADLY:</div><div class=\"line\"><span class=\"number\">185</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class=\"line\"><span class=\"number\">186</span>:                 <span class=\"comment\">// <span class=\"doctag\">XXX:</span> warn and notify me</span></div><div class=\"line\"><span class=\"number\">187</span>:                 LOG.info(<span class=\"string\">\"The request offset:&#123;&#125; over flow badly, broker max offset:&#123;&#125; , consumer: &#123;&#125;\"</span>, requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());</div><div class=\"line\"><span class=\"number\">188</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">189</span>:             <span class=\"keyword\">case</span> OFFSET_OVERFLOW_ONE:</div><div class=\"line\"><span class=\"number\">190</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class=\"line\"><span class=\"number\">191</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">192</span>:             <span class=\"keyword\">case</span> OFFSET_TOO_SMALL:</div><div class=\"line\"><span class=\"number\">193</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class=\"line\"><span class=\"number\">194</span>:                 LOG.info(<span class=\"string\">\"The request offset is too small. group=&#123;&#125;, topic=&#123;&#125;, requestOffset=&#123;&#125;, brokerMinOffset=&#123;&#125;, clientIp=&#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">195</span>:                     requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),</div><div class=\"line\"><span class=\"number\">196</span>:                     getMessageResult.getMinOffset(), channel.remoteAddress());</div><div class=\"line\"><span class=\"number\">197</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">198</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">199</span>:                 <span class=\"keyword\">assert</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">200</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">201</span>:         &#125;</div><div class=\"line\"><span class=\"number\">202</span>: </div><div class=\"line\"><span class=\"number\">203</span>:         <span class=\"comment\">// hookï¼šbefore</span></div><div class=\"line\"><span class=\"number\">204</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasConsumeMessageHook()) &#123;</div><div class=\"line\"><span class=\"number\">205</span>:             ConsumeMessageContext context = <span class=\"keyword\">new</span> ConsumeMessageContext();</div><div class=\"line\"><span class=\"number\">206</span>:             context.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class=\"line\"><span class=\"number\">207</span>:             context.setTopic(requestHeader.getTopic());</div><div class=\"line\"><span class=\"number\">208</span>:             context.setQueueId(requestHeader.getQueueId());</div><div class=\"line\"><span class=\"number\">209</span>: </div><div class=\"line\"><span class=\"number\">210</span>:             String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</div><div class=\"line\"><span class=\"number\">211</span>: </div><div class=\"line\"><span class=\"number\">212</span>:             <span class=\"keyword\">switch</span> (response.getCode()) &#123;</div><div class=\"line\"><span class=\"number\">213</span>:                 <span class=\"keyword\">case</span> ResponseCode.SUCCESS:</div><div class=\"line\"><span class=\"number\">214</span>:                     <span class=\"keyword\">int</span> commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</div><div class=\"line\"><span class=\"number\">215</span>:                     <span class=\"keyword\">int</span> incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;</div><div class=\"line\"><span class=\"number\">216</span>: </div><div class=\"line\"><span class=\"number\">217</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);</div><div class=\"line\"><span class=\"number\">218</span>:                     context.setCommercialRcvTimes(incValue);</div><div class=\"line\"><span class=\"number\">219</span>:                     context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());</div><div class=\"line\"><span class=\"number\">220</span>:                     context.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">221</span>: </div><div class=\"line\"><span class=\"number\">222</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">223</span>:                 <span class=\"keyword\">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class=\"line\"><span class=\"number\">224</span>:                     <span class=\"keyword\">if</span> (!brokerAllowSuspend) &#123;</div><div class=\"line\"><span class=\"number\">225</span>: </div><div class=\"line\"><span class=\"number\">226</span>:                         context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class=\"line\"><span class=\"number\">227</span>:                         context.setCommercialRcvTimes(<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">228</span>:                         context.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">229</span>: </div><div class=\"line\"><span class=\"number\">230</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">231</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">232</span>:                 <span class=\"keyword\">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class=\"line\"><span class=\"number\">233</span>:                 <span class=\"keyword\">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class=\"line\"><span class=\"number\">234</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class=\"line\"><span class=\"number\">235</span>:                     context.setCommercialRcvTimes(<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">236</span>:                     context.setCommercialOwner(owner);</div><div class=\"line\"><span class=\"number\">237</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">238</span>:                 <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">239</span>:                     <span class=\"keyword\">assert</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">240</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">241</span>:             &#125;</div><div class=\"line\"><span class=\"number\">242</span>: </div><div class=\"line\"><span class=\"number\">243</span>:             <span class=\"keyword\">this</span>.executeConsumeMessageHookBefore(context);</div><div class=\"line\"><span class=\"number\">244</span>:         &#125;</div><div class=\"line\"><span class=\"number\">245</span>: </div><div class=\"line\"><span class=\"number\">246</span>:         <span class=\"keyword\">switch</span> (response.getCode()) &#123;</div><div class=\"line\"><span class=\"number\">247</span>:             <span class=\"keyword\">case</span> ResponseCode.SUCCESS:</div><div class=\"line\"><span class=\"number\">248</span>: </div><div class=\"line\"><span class=\"number\">249</span>:                 <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class=\"line\"><span class=\"number\">250</span>:                     getMessageResult.getMessageCount());</div><div class=\"line\"><span class=\"number\">251</span>:                 <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class=\"line\"><span class=\"number\">252</span>:                     getMessageResult.getBufferTotalSize());</div><div class=\"line\"><span class=\"number\">253</span>:                 <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());</div><div class=\"line\"><span class=\"number\">254</span>:                 <span class=\"comment\">// è¯»å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">255</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isTransferMsgByHeap()) &#123; <span class=\"comment\">// å†…å­˜ä¸­</span></div><div class=\"line\"><span class=\"number\">256</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTimeMills = <span class=\"keyword\">this</span>.brokerController.getMessageStore().now();</div><div class=\"line\"><span class=\"number\">257</span>: </div><div class=\"line\"><span class=\"number\">258</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] r = <span class=\"keyword\">this</span>.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());</div><div class=\"line\"><span class=\"number\">259</span>: </div><div class=\"line\"><span class=\"number\">260</span>:                     <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),</div><div class=\"line\"><span class=\"number\">261</span>:                         requestHeader.getTopic(), requestHeader.getQueueId(),</div><div class=\"line\"><span class=\"number\">262</span>:                         (<span class=\"keyword\">int</span>) (<span class=\"keyword\">this</span>.brokerController.getMessageStore().now() - beginTimeMills));</div><div class=\"line\"><span class=\"number\">263</span>:                     response.setBody(r);</div><div class=\"line\"><span class=\"number\">264</span>:                 &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// zero-copy</span></div><div class=\"line\"><span class=\"number\">265</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">266</span>:                         FileRegion fileRegion = <span class=\"keyword\">new</span> ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);</div><div class=\"line\"><span class=\"number\">267</span>:                         channel.writeAndFlush(fileRegion).addListener(<span class=\"keyword\">new</span> ChannelFutureListener() &#123;</div><div class=\"line\"><span class=\"number\">268</span>:                             <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">269</span>:                             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">operationComplete</span><span class=\"params\">(ChannelFuture future)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</div><div class=\"line\"><span class=\"number\">270</span>:                                 getMessageResult.release();</div><div class=\"line\"><span class=\"number\">271</span>:                                 <span class=\"keyword\">if</span> (!future.isSuccess()) &#123;</div><div class=\"line\"><span class=\"number\">272</span>:                                     LOG.error(<span class=\"string\">\"Fail to transfer messages from page cache to &#123;&#125;\"</span>, channel.remoteAddress(), future.cause());</div><div class=\"line\"><span class=\"number\">273</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">274</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">275</span>:                         &#125;);</div><div class=\"line\"><span class=\"number\">276</span>:                     &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">277</span>:                         LOG.error(<span class=\"string\">\"Error occurred when transferring messages from page cache\"</span>, e);</div><div class=\"line\"><span class=\"number\">278</span>:                         getMessageResult.release();</div><div class=\"line\"><span class=\"number\">279</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">280</span>: </div><div class=\"line\"><span class=\"number\">281</span>:                     response = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">282</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">283</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">284</span>:             <span class=\"keyword\">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class=\"line\"><span class=\"number\">285</span>:                 <span class=\"comment\">// æ¶ˆæ¯æœªæŸ¥è¯¢åˆ° &amp;&amp; brokerå…è®¸æŒ‚èµ·è¯·æ±‚ &amp;&amp; è¯·æ±‚å…è®¸æŒ‚èµ·</span></div><div class=\"line\"><span class=\"number\">286</span>:                 <span class=\"keyword\">if</span> (brokerAllowSuspend &amp;&amp; hasSuspendFlag) &#123;</div><div class=\"line\"><span class=\"number\">287</span>:                     <span class=\"keyword\">long</span> pollingTimeMills = suspendTimeoutMillisLong;</div><div class=\"line\"><span class=\"number\">288</span>:                     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</div><div class=\"line\"><span class=\"number\">289</span>:                         pollingTimeMills = <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills();</div><div class=\"line\"><span class=\"number\">290</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">291</span>: </div><div class=\"line\"><span class=\"number\">292</span>:                     String topic = requestHeader.getTopic();</div><div class=\"line\"><span class=\"number\">293</span>:                     <span class=\"keyword\">long</span> offset = requestHeader.getQueueOffset();</div><div class=\"line\"><span class=\"number\">294</span>:                     <span class=\"keyword\">int</span> queueId = requestHeader.getQueueId();</div><div class=\"line\"><span class=\"number\">295</span>:                     PullRequest pullRequest = <span class=\"keyword\">new</span> PullRequest(request, channel, pollingTimeMills,</div><div class=\"line\"><span class=\"number\">296</span>:                         <span class=\"keyword\">this</span>.brokerController.getMessageStore().now(), offset, subscriptionData);</div><div class=\"line\"><span class=\"number\">297</span>:                     <span class=\"keyword\">this</span>.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);</div><div class=\"line\"><span class=\"number\">298</span>:                     response = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">299</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">300</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">301</span>: </div><div class=\"line\"><span class=\"number\">302</span>:             <span class=\"keyword\">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class=\"line\"><span class=\"number\">303</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">304</span>:             <span class=\"keyword\">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class=\"line\"><span class=\"number\">305</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE</div><div class=\"line\"><span class=\"number\">306</span>:                     || <span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) &#123; <span class=\"comment\">// TODO å¾…åšå®¢è¡¥å……</span></div><div class=\"line\"><span class=\"number\">307</span>:                     MessageQueue mq = <span class=\"keyword\">new</span> MessageQueue();</div><div class=\"line\"><span class=\"number\">308</span>:                     mq.setTopic(requestHeader.getTopic());</div><div class=\"line\"><span class=\"number\">309</span>:                     mq.setQueueId(requestHeader.getQueueId());</div><div class=\"line\"><span class=\"number\">310</span>:                     mq.setBrokerName(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerName());</div><div class=\"line\"><span class=\"number\">311</span>: </div><div class=\"line\"><span class=\"number\">312</span>:                     OffsetMovedEvent event = <span class=\"keyword\">new</span> OffsetMovedEvent();</div><div class=\"line\"><span class=\"number\">313</span>:                     event.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class=\"line\"><span class=\"number\">314</span>:                     event.setMessageQueue(mq);</div><div class=\"line\"><span class=\"number\">315</span>:                     event.setOffsetRequest(requestHeader.getQueueOffset());</div><div class=\"line\"><span class=\"number\">316</span>:                     event.setOffsetNew(getMessageResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">317</span>:                     <span class=\"keyword\">this</span>.generateOffsetMovedEvent(event);</div><div class=\"line\"><span class=\"number\">318</span>:                     LOG.warn(</div><div class=\"line\"><span class=\"number\">319</span>:                         <span class=\"string\">\"PULL_OFFSET_MOVED:correction offset. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, newOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">320</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),</div><div class=\"line\"><span class=\"number\">321</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class=\"line\"><span class=\"number\">322</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">323</span>:                     responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class=\"line\"><span class=\"number\">324</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class=\"line\"><span class=\"number\">325</span>:                     LOG.warn(<span class=\"string\">\"PULL_OFFSET_MOVED:none correction. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">326</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),</div><div class=\"line\"><span class=\"number\">327</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class=\"line\"><span class=\"number\">328</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">329</span>: </div><div class=\"line\"><span class=\"number\">330</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">331</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">332</span>:                 <span class=\"keyword\">assert</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">333</span>:         &#125;</div><div class=\"line\"><span class=\"number\">334</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">335</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">336</span>:         response.setRemark(<span class=\"string\">\"store getMessage return null\"</span>);</div><div class=\"line\"><span class=\"number\">337</span>:     &#125;</div><div class=\"line\"><span class=\"number\">338</span>: </div><div class=\"line\"><span class=\"number\">339</span>:     <span class=\"comment\">// è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦ &amp;&amp; brokeréä¸»ï¼Œè¿›è¡ŒæŒä¹…åŒ–è¿›åº¦ã€‚</span></div><div class=\"line\"><span class=\"number\">340</span>:     <span class=\"keyword\">boolean</span> storeOffsetEnable = brokerAllowSuspend;</div><div class=\"line\"><span class=\"number\">341</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; hasCommitOffsetFlag;</div><div class=\"line\"><span class=\"number\">342</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; <span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;</div><div class=\"line\"><span class=\"number\">343</span>:     <span class=\"keyword\">if</span> (storeOffsetEnable) &#123;</div><div class=\"line\"><span class=\"number\">344</span>:         <span class=\"keyword\">this</span>.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),</div><div class=\"line\"><span class=\"number\">345</span>:             requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());</div><div class=\"line\"><span class=\"number\">346</span>:     &#125;</div><div class=\"line\"><span class=\"number\">347</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">348</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šå¤„ç†æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œè¿”å›å“åº”ã€‚</li>\n<li>ç¬¬ 14 è‡³ 19 è¡Œ ï¼šæ ¡éªŒ <code>Broker</code> æ˜¯å¦å¯è¯»ã€‚</li>\n<li>ç¬¬ 21 è‡³ 33 è¡Œ ï¼šæ ¡éªŒ <code>SubscriptionGroupConfig</code>(è®¢é˜…åˆ†ç»„é…ç½®) æ˜¯å¦å­˜åœ¨ &amp;&amp; å¯ä»¥æ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šå¤„ç† <code>PullMessageRequestHeader.sysFlag</code> å¯¹åº”çš„æ ‡å¿—ä½ã€‚</li>\n<li>ç¬¬ 40 è‡³ 62 è¡Œ ï¼šæ ¡éªŒ <code>TopicConfig</code>(ä¸»é¢˜é…ç½®) æ˜¯å¦å­˜åœ¨ &amp;&amp; å¯è¯» &amp;&amp; é˜Ÿåˆ—ç¼–å·æ­£ç¡®ã€‚</li>\n<li>ç¬¬ 64 è‡³ 110 è¡Œ ï¼šæ ¡éªŒ <code>SubscriptionData</code>(è®¢é˜…ä¿¡æ¯) æ˜¯å¦æ­£ç¡®ã€‚</li>\n<li>ç¬¬ 113 è¡Œ ï¼šè°ƒç”¨ <code>MessageStore#getMessage(...)</code> è·å– <code>GetMessageResult</code>(æ¶ˆæ¯)ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#messagestoregetmessage\">MessageStore#getMessage(...)</a>ã€‚</li>\n<li>ç¬¬ 122 è‡³ 152 è¡Œ ï¼šè®¡ç®—å»ºè®®æ‹‰å–æ¶ˆæ¯ <code>brokerId</code> ã€‚</li>\n<li>ç¬¬ 154 è‡³ 201 è¡Œ ï¼š<img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/08.png\" alt=\"PullMessageProcessoræ‹‰å–æ¶ˆæ¯çŠ¶æ€å›¾\"></li>\n<li>ç¬¬ 204 è‡³ 244 è¡Œ ï¼š<code>Hook</code> é€»è¾‘ï¼Œ<code>#executeConsumeMessageHookBefore(...)</code> ã€‚</li>\n<li>ç¬¬ 247 è‡³ 283 è¡Œ ï¼šæ‹‰å–æ¶ˆæ¯æˆåŠŸï¼Œå³æ‹‰å–åˆ°æ¶ˆæ¯ã€‚\n<ul>\n<li>ç¬¬ 255 è‡³ 263 è¡Œ ï¼šæ–¹å¼ä¸€ ï¼šè°ƒç”¨ <code>readGetMessageResult(...)</code> è·å–æ¶ˆæ¯å†…å®¹åˆ°å †å†…å†…å­˜ï¼Œè®¾ç½®åˆ° å“åº”<code>body</code>ã€‚</li>\n<li>ç¬¬ 265 è‡³ 281 è¡Œ ï¼šæ–¹å¼äºŒ ï¼šåŸºäº <code>zero-copy</code> å®ç°ï¼Œç›´æ¥å“åº”ï¼Œæ— éœ€å †å†…å†…å­˜ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚<em>TODO ï¼šæ­¤å¤„ç­‰å¯¹zero-copyæœ‰ç ”ç©¶ï¼Œå†è¡¥å……ä¸€äº›</em>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 284 è‡³ 300 è¡Œ ï¼šæ‹‰å–ä¸åˆ°æ¶ˆæ¯ï¼Œå½“æ»¡è¶³æ¡ä»¶ (<code>Broker</code> å…è®¸æŒ‚èµ· &amp;&amp; è¯·æ±‚è¦æ±‚æŒ‚èµ·)ï¼Œæ‰§è¡ŒæŒ‚èµ·è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#pullrequestholdservice\">PullRequestHoldService</a>ã€‚</li>\n<li>ç¬¬ 304 è‡³ 328 è¡Œ ï¼š<em>TODO ï¼šæ­¤å¤„ç­‰å¯¹<code>tools</code>æ¨¡å—ç ”ç©¶åå†è¡¥å……</em>ã€‚</li>\n<li>ç¬¬ 339 è‡³ 346 ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå½“æ»¡è¶³ (<code>Broker</code> éä¸» &amp;&amp; è¯·æ±‚è¦æ±‚æŒä¹…åŒ–è¿›åº¦)ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#3broker-%E6%8F%90%E4%BE%9B%E6%9B%B4%E6%96%B0%E6%B6%88%E8%B4%B9%E8%BF%9B%E5%BA%A6%E6%8E%A5%E5%8F%A3\">æ›´æ–°æ¶ˆè´¹è¿›åº¦</a>ã€‚</li>\n</ul>\n<h2>MessageStore#getMessage(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\">  2:  * è·å–æ¶ˆæ¯ç»“æœ</div><div class=\"line\">  3:  *</div><div class=\"line\">  4:  * <span class=\"doctag\">@param</span> group æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\">  5:  * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">  6:  * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">  7:  * <span class=\"doctag\">@param</span> offset é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">  8:  * <span class=\"doctag\">@param</span> maxMsgNums æ¶ˆæ¯æ•°é‡</div><div class=\"line\">  9:  * <span class=\"doctag\">@param</span> subscriptionData è®¢é˜…ä¿¡æ¯</div><div class=\"line\"> 10:  * <span class=\"doctag\">@return</span> æ¶ˆæ¯ç»“æœ</div><div class=\"line\"> 11:  */</div><div class=\"line\"> <span class=\"number\">12</span>: <span class=\"function\"><span class=\"keyword\">public</span> GetMessageResult <span class=\"title\">getMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> String group, <span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxMsgNums,</span></span></div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">final</span> SubscriptionData subscriptionData) &#123;</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">// æ˜¯å¦å…³é—­</span></div><div class=\"line\"> <span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.shutdown) &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:         log.warn(<span class=\"string\">\"message store has shutdown, so getMessage is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">19</span>:     <span class=\"comment\">// æ˜¯å¦å¯è¯»</span></div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.runningFlags.isReadable()) &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:         log.warn(<span class=\"string\">\"message store is not readable, so getMessage is forbidden \"</span> + <span class=\"keyword\">this</span>.runningFlags.getFlagBits());</div><div class=\"line\"> <span class=\"number\">22</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">23</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">24</span>: </div><div class=\"line\"> <span class=\"number\">25</span>:     <span class=\"keyword\">long</span> beginTime = <span class=\"keyword\">this</span>.getSystemClock().now();</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:     GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"keyword\">long</span> nextBeginOffset = offset;</div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">long</span> minOffset = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">30</span>:     <span class=\"keyword\">long</span> maxOffset = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">31</span>: </div><div class=\"line\"> <span class=\"number\">32</span>:     GetMessageResult getResult = <span class=\"keyword\">new</span> GetMessageResult();</div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> maxOffsetPy = <span class=\"keyword\">this</span>.commitLog.getMaxOffset();</div><div class=\"line\"> <span class=\"number\">35</span>: </div><div class=\"line\"> <span class=\"number\">36</span>:     <span class=\"comment\">// è·å–æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">37</span>:     ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);</div><div class=\"line\"> <span class=\"number\">38</span>:     <span class=\"keyword\">if</span> (consumeQueue != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">39</span>:         minOffset = consumeQueue.getMinOffsetInQueue(); <span class=\"comment\">// æ¶ˆè´¹é˜Ÿåˆ— æœ€å°é˜Ÿåˆ—ç¼–å·</span></div><div class=\"line\"> <span class=\"number\">40</span>:         maxOffset = consumeQueue.getMaxOffsetInQueue(); <span class=\"comment\">// æ¶ˆè´¹é˜Ÿåˆ— æœ€å¤§é˜Ÿåˆ—ç¼–å·</span></div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:         <span class=\"comment\">// åˆ¤æ–­ é˜Ÿåˆ—ä½ç½®(offset)</span></div><div class=\"line\"> <span class=\"number\">43</span>:         <span class=\"keyword\">if</span> (maxOffset == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// æ¶ˆè´¹é˜Ÿåˆ—æ— æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">44</span>:             status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class=\"line\"> <span class=\"number\">45</span>:             nextBeginOffset = nextOffsetCorrection(offset, <span class=\"number\">0</span>);</div><div class=\"line\"> <span class=\"number\">46</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offset &lt; minOffset) &#123; <span class=\"comment\">// æŸ¥è¯¢offset å¤ªå°</span></div><div class=\"line\"> <span class=\"number\">47</span>:             status = GetMessageStatus.OFFSET_TOO_SMALL;</div><div class=\"line\"> <span class=\"number\">48</span>:             nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class=\"line\"> <span class=\"number\">49</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offset == maxOffset) &#123; <span class=\"comment\">// æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— ä¸€ä¸ªä½ç½®</span></div><div class=\"line\"> <span class=\"number\">50</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_ONE;</div><div class=\"line\"> <span class=\"number\">51</span>:             nextBeginOffset = nextOffsetCorrection(offset, offset);</div><div class=\"line\"> <span class=\"number\">52</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offset &gt; maxOffset) &#123; <span class=\"comment\">// æŸ¥è¯¢offset è¶…è¿‡ æ¶ˆè´¹é˜Ÿåˆ— å¤ªå¤š(å¤§äºä¸€ä¸ªä½ç½®)</span></div><div class=\"line\"> <span class=\"number\">53</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;</div><div class=\"line\"> <span class=\"number\">54</span>:             <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == minOffset) &#123; <span class=\"comment\">// TODO blog è¿™é‡Œæ˜¯ï¼Ÿï¼Ÿä¸ºå•¥0 == minOffsetåšäº†ç‰¹æ®Šåˆ¤æ–­</span></div><div class=\"line\"> <span class=\"number\">55</span>:                 nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class=\"line\"> <span class=\"number\">56</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">57</span>:                 nextBeginOffset = nextOffsetCorrection(offset, maxOffset);</div><div class=\"line\"> <span class=\"number\">58</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">59</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:             <span class=\"comment\">// è·å¾— æ˜ å°„Bufferç»“æœ(MappedFile)</span></div><div class=\"line\"> <span class=\"number\">61</span>:             SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);</div><div class=\"line\"> <span class=\"number\">62</span>:             <span class=\"keyword\">if</span> (bufferConsumeQueue != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">64</span>:                     status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class=\"line\"> <span class=\"number\">65</span>: </div><div class=\"line\"> <span class=\"number\">66</span>:                     <span class=\"keyword\">long</span> nextPhyFileStartOffset = Long.MIN_VALUE; <span class=\"comment\">// commitLogä¸‹ä¸€ä¸ªæ–‡ä»¶(MappedFile)å¯¹åº”çš„å¼€å§‹offsetã€‚</span></div><div class=\"line\"> <span class=\"number\">67</span>:                     <span class=\"keyword\">long</span> maxPhyOffsetPulling = <span class=\"number\">0</span>; <span class=\"comment\">// æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset</span></div><div class=\"line\"> <span class=\"number\">68</span>: </div><div class=\"line\"> <span class=\"number\">69</span>:                     <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">70</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxFilterMessageCount = <span class=\"number\">16000</span>;</div><div class=\"line\"> <span class=\"number\">71</span>:                     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> diskFallRecorded = <span class=\"keyword\">this</span>.messageStoreConfig.isDiskFallRecorded();</div><div class=\"line\"> <span class=\"number\">72</span>:                     <span class=\"comment\">// å¾ªç¯è·å– æ¶ˆæ¯ä½ç½®ä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">73</span>:                     <span class=\"keyword\">for</span> (; i &lt; bufferConsumeQueue.getSize() &amp;&amp; i &lt; maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:                         <span class=\"keyword\">long</span> offsetPy = bufferConsumeQueue.getByteBuffer().getLong(); <span class=\"comment\">// æ¶ˆæ¯ç‰©ç†ä½ç½®offset</span></div><div class=\"line\"> <span class=\"number\">75</span>:                         <span class=\"keyword\">int</span> sizePy = bufferConsumeQueue.getByteBuffer().getInt(); <span class=\"comment\">// æ¶ˆæ¯é•¿åº¦</span></div><div class=\"line\"> <span class=\"number\">76</span>:                         <span class=\"keyword\">long</span> tagsCode = bufferConsumeQueue.getByteBuffer().getLong(); <span class=\"comment\">// æ¶ˆæ¯tagsCode</span></div><div class=\"line\"> <span class=\"number\">77</span>:                         <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯ç‰©ç†ä½ç½®æ‹‰å–åˆ°çš„æœ€å¤§offset</span></div><div class=\"line\"> <span class=\"number\">78</span>:                         maxPhyOffsetPulling = offsetPy;</div><div class=\"line\"> <span class=\"number\">79</span>:                         <span class=\"comment\">// å½“ offsetPy å°äº nextPhyFileStartOffset æ—¶ï¼Œæ„å‘³ç€å¯¹åº”çš„ Message å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„Messageã€‚</span></div><div class=\"line\"> <span class=\"number\">80</span>:                         <span class=\"keyword\">if</span> (nextPhyFileStartOffset != Long.MIN_VALUE) &#123;</div><div class=\"line\"> <span class=\"number\">81</span>:                             <span class=\"keyword\">if</span> (offsetPy &lt; nextPhyFileStartOffset)</div><div class=\"line\"> <span class=\"number\">82</span>:                                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"> <span class=\"number\">83</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">84</span>:                         <span class=\"comment\">// æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜</span></div><div class=\"line\"> <span class=\"number\">85</span>:                         <span class=\"keyword\">boolean</span> isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);</div><div class=\"line\"> <span class=\"number\">86</span>:                         <span class=\"comment\">// æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿæ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">87</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),</div><div class=\"line\"> <span class=\"number\">88</span>:                             isInDisk)) &#123;</div><div class=\"line\"> <span class=\"number\">89</span>:                             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">90</span>:                         &#125;</div><div class=\"line\"> <span class=\"number\">91</span>:                         <span class=\"comment\">// åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶</span></div><div class=\"line\"> <span class=\"number\">92</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.messageFilter.isMessageMatched(subscriptionData, tagsCode)) &#123;</div><div class=\"line\"> <span class=\"number\">93</span>:                             <span class=\"comment\">// ä»commitLogè·å–å¯¹åº”æ¶ˆæ¯ByteBuffer</span></div><div class=\"line\"> <span class=\"number\">94</span>:                             SelectMappedBufferResult selectResult = <span class=\"keyword\">this</span>.commitLog.getMessage(offsetPy, sizePy);</div><div class=\"line\"> <span class=\"number\">95</span>:                             <span class=\"keyword\">if</span> (selectResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:                                 <span class=\"keyword\">this</span>.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();</div><div class=\"line\"> <span class=\"number\">97</span>:                                 getResult.addMessage(selectResult);</div><div class=\"line\"> <span class=\"number\">98</span>:                                 status = GetMessageStatus.FOUND;</div><div class=\"line\"> <span class=\"number\">99</span>:                                 nextPhyFileStartOffset = Long.MIN_VALUE;</div><div class=\"line\"><span class=\"number\">100</span>:                             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">101</span>:                                 <span class=\"comment\">// ä»commitLogæ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶ï¼ˆMappedFileï¼‰å·²ç»åˆ é™¤ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªMappedFileçš„èµ·å§‹ä½ç½®</span></div><div class=\"line\"><span class=\"number\">102</span>:                                 <span class=\"keyword\">if</span> (getResult.getBufferTotalSize() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">103</span>:                                     status = GetMessageStatus.MESSAGE_WAS_REMOVING;</div><div class=\"line\"><span class=\"number\">104</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">105</span>:                                 nextPhyFileStartOffset = <span class=\"keyword\">this</span>.commitLog.rollNextFile(offsetPy);</div><div class=\"line\"><span class=\"number\">106</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">107</span>:                         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">108</span>:                             <span class=\"keyword\">if</span> (getResult.getBufferTotalSize() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">109</span>:                                 status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class=\"line\"><span class=\"number\">110</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">111</span>: </div><div class=\"line\"><span class=\"number\">112</span>:                             <span class=\"keyword\">if</span> (log.isDebugEnabled()) &#123;</div><div class=\"line\"><span class=\"number\">113</span>:                                 log.debug(<span class=\"string\">\"message type not matched, client: \"</span> + subscriptionData + <span class=\"string\">\" server: \"</span> + tagsCode);</div><div class=\"line\"><span class=\"number\">114</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">115</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">116</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">117</span>:                     <span class=\"comment\">// ç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°</span></div><div class=\"line\"><span class=\"number\">118</span>:                     <span class=\"keyword\">if</span> (diskFallRecorded) &#123;</div><div class=\"line\"><span class=\"number\">119</span>:                         <span class=\"keyword\">long</span> fallBehind = maxOffsetPy - maxPhyOffsetPulling;</div><div class=\"line\"><span class=\"number\">120</span>:                         brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);</div><div class=\"line\"><span class=\"number\">121</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">122</span>:                     <span class=\"comment\">// è®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·</span></div><div class=\"line\"><span class=\"number\">123</span>:                     nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class=\"line\"><span class=\"number\">124</span>:                     <span class=\"comment\">// æ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹</span></div><div class=\"line\"><span class=\"number\">125</span>:                     <span class=\"keyword\">long</span> diff = maxOffsetPy - maxPhyOffsetPulling;</div><div class=\"line\"><span class=\"number\">126</span>:                     <span class=\"keyword\">long</span> memory = (<span class=\"keyword\">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE</div><div class=\"line\"><span class=\"number\">127</span>:                             * (<span class=\"keyword\">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class=\"number\">100.0</span>));</div><div class=\"line\"><span class=\"number\">128</span>:                     getResult.setSuggestPullingFromSlave(diff &gt; memory);</div><div class=\"line\"><span class=\"number\">129</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">130</span>:                     bufferConsumeQueue.release();</div><div class=\"line\"><span class=\"number\">131</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">132</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">133</span>:                 status = GetMessageStatus.OFFSET_FOUND_NULL;</div><div class=\"line\"><span class=\"number\">134</span>:                 nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));</div><div class=\"line\"><span class=\"number\">135</span>:                 log.warn(<span class=\"string\">\"consumer request topic: \"</span> + topic + <span class=\"string\">\"offset: \"</span> + offset + <span class=\"string\">\" minOffset: \"</span> + minOffset + <span class=\"string\">\" maxOffset: \"</span></div><div class=\"line\"><span class=\"number\">136</span>:                     + maxOffset + <span class=\"string\">\", but access logic queue failed.\"</span>);</div><div class=\"line\"><span class=\"number\">137</span>:             &#125;</div><div class=\"line\"><span class=\"number\">138</span>:         &#125;</div><div class=\"line\"><span class=\"number\">139</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">140</span>:         status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;</div><div class=\"line\"><span class=\"number\">141</span>:         nextBeginOffset = nextOffsetCorrection(offset, <span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"number\">142</span>:     &#125;</div><div class=\"line\"><span class=\"number\">143</span>:     <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"><span class=\"number\">144</span>:     <span class=\"keyword\">if</span> (GetMessageStatus.FOUND == status) &#123;</div><div class=\"line\"><span class=\"number\">145</span>:         <span class=\"keyword\">this</span>.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();</div><div class=\"line\"><span class=\"number\">146</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">147</span>:         <span class=\"keyword\">this</span>.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();</div><div class=\"line\"><span class=\"number\">148</span>:     &#125;</div><div class=\"line\"><span class=\"number\">149</span>:     <span class=\"keyword\">long</span> eclipseTime = <span class=\"keyword\">this</span>.getSystemClock().now() - beginTime;</div><div class=\"line\"><span class=\"number\">150</span>:     <span class=\"keyword\">this</span>.storeStatsService.setGetMessageEntireTimeMax(eclipseTime);</div><div class=\"line\"><span class=\"number\">151</span>:     <span class=\"comment\">// è®¾ç½®è¿”å›ç»“æœ</span></div><div class=\"line\"><span class=\"number\">152</span>:     getResult.setStatus(status);</div><div class=\"line\"><span class=\"number\">153</span>:     getResult.setNextBeginOffset(nextBeginOffset);</div><div class=\"line\"><span class=\"number\">154</span>:     getResult.setMaxOffset(maxOffset);</div><div class=\"line\"><span class=\"number\">155</span>:     getResult.setMinOffset(minOffset);</div><div class=\"line\"><span class=\"number\">156</span>:     <span class=\"keyword\">return</span> getResult;</div><div class=\"line\"><span class=\"number\">157</span>: &#125;</div><div class=\"line\"><span class=\"number\">158</span>: </div><div class=\"line\"><span class=\"number\">159</span>: <span class=\"comment\">/**</span></div><div class=\"line\">160:  * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· è·å– æ¶ˆè´¹é˜Ÿåˆ—</div><div class=\"line\">161:  *</div><div class=\"line\">162:  * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">163:  * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">164:  * <span class=\"doctag\">@return</span> æ¶ˆè´¹é˜Ÿåˆ—</div><div class=\"line\">165:  */</div><div class=\"line\"><span class=\"number\">166</span>: <span class=\"function\"><span class=\"keyword\">public</span> ConsumeQueue <span class=\"title\">findConsumeQueue</span><span class=\"params\">(String topic, <span class=\"keyword\">int</span> queueId)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">167</span>:     <span class=\"comment\">// è·å– topic å¯¹åº”çš„ æ‰€æœ‰æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">168</span>:     ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; map = consumeQueueTable.get(topic);</div><div class=\"line\"><span class=\"number\">169</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == map) &#123;</div><div class=\"line\"><span class=\"number\">170</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; newMap = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">128</span>);</div><div class=\"line\"><span class=\"number\">171</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; oldMap = consumeQueueTable.putIfAbsent(topic, newMap);</div><div class=\"line\"><span class=\"number\">172</span>:         <span class=\"keyword\">if</span> (oldMap != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">173</span>:             map = oldMap;</div><div class=\"line\"><span class=\"number\">174</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">175</span>:             map = newMap;</div><div class=\"line\"><span class=\"number\">176</span>:         &#125;</div><div class=\"line\"><span class=\"number\">177</span>:     &#125;</div><div class=\"line\"><span class=\"number\">178</span>:     <span class=\"comment\">// è·å– queueId å¯¹åº”çš„ æ¶ˆè´¹é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">179</span>:     ConsumeQueue logic = map.get(queueId);</div><div class=\"line\"><span class=\"number\">180</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == logic) &#123;</div><div class=\"line\"><span class=\"number\">181</span>:         ConsumeQueue newLogic = <span class=\"keyword\">new</span> ConsumeQueue(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">182</span>:             topic, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">183</span>:             queueId, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">184</span>:             StorePathConfigHelper.getStorePathConsumeQueue(<span class=\"keyword\">this</span>.messageStoreConfig.getStorePathRootDir()), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">185</span>:             <span class=\"keyword\">this</span>.getMessageStoreConfig().getMapedFileSizeConsumeQueue(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">186</span>:             <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">187</span>:         ConsumeQueue oldLogic = map.putIfAbsent(queueId, newLogic);</div><div class=\"line\"><span class=\"number\">188</span>:         <span class=\"keyword\">if</span> (oldLogic != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">189</span>:             logic = oldLogic;</div><div class=\"line\"><span class=\"number\">190</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">191</span>:             logic = newLogic;</div><div class=\"line\"><span class=\"number\">192</span>:         &#125;</div><div class=\"line\"><span class=\"number\">193</span>:     &#125;</div><div class=\"line\"><span class=\"number\">194</span>: </div><div class=\"line\"><span class=\"number\">195</span>:     <span class=\"keyword\">return</span> logic;</div><div class=\"line\"><span class=\"number\">196</span>: &#125;</div><div class=\"line\"><span class=\"number\">197</span>: </div><div class=\"line\"><span class=\"number\">198</span>: <span class=\"comment\">/**</span></div><div class=\"line\">199:  * ä¸‹ä¸€ä¸ªè·å–é˜Ÿåˆ—offsetä¿®æ­£</div><div class=\"line\">200:  * ä¿®æ­£æ¡ä»¶ï¼šä¸»èŠ‚ç‚¹ æˆ–è€… ä»èŠ‚ç‚¹å¼€å¯æ ¡éªŒoffsetå¼€å…³</div><div class=\"line\">201:  *</div><div class=\"line\">202:  * <span class=\"doctag\">@param</span> oldOffset è€é˜Ÿåˆ—offset</div><div class=\"line\">203:  * <span class=\"doctag\">@param</span> newOffset æ–°é˜Ÿåˆ—offset</div><div class=\"line\">204:  * <span class=\"doctag\">@return</span> ä¿®æ­£åçš„é˜Ÿåˆ—offset</div><div class=\"line\">205:  */</div><div class=\"line\"><span class=\"number\">206</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">nextOffsetCorrection</span><span class=\"params\">(<span class=\"keyword\">long</span> oldOffset, <span class=\"keyword\">long</span> newOffset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">207</span>:     <span class=\"keyword\">long</span> nextOffset = oldOffset;</div><div class=\"line\"><span class=\"number\">208</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE || <span class=\"keyword\">this</span>.getMessageStoreConfig().isOffsetCheckInSlave()) &#123;</div><div class=\"line\"><span class=\"number\">209</span>:         nextOffset = newOffset;</div><div class=\"line\"><span class=\"number\">210</span>:     &#125;</div><div class=\"line\"><span class=\"number\">211</span>:     <span class=\"keyword\">return</span> nextOffset;</div><div class=\"line\"><span class=\"number\">212</span>: &#125;</div><div class=\"line\"><span class=\"number\">213</span>: </div><div class=\"line\"><span class=\"number\">214</span>: <span class=\"comment\">/**</span></div><div class=\"line\">215:  * æ ¡éªŒ commitLog æ˜¯å¦éœ€è¦ç¡¬ç›˜ï¼Œæ— æ³•å…¨éƒ¨æ”¾åœ¨å†…å­˜</div><div class=\"line\">216:  *</div><div class=\"line\">217:  * <span class=\"doctag\">@param</span> offsetPy commitLog æŒ‡å®šoffset</div><div class=\"line\">218:  * <span class=\"doctag\">@param</span> maxOffsetPy commitLog æœ€å¤§offset</div><div class=\"line\">219:  * <span class=\"doctag\">@return</span> æ˜¯å¦éœ€è¦ç¡¬ç›˜</div><div class=\"line\">220:  */</div><div class=\"line\"><span class=\"number\">221</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">checkInDiskByCommitOffset</span><span class=\"params\">(<span class=\"keyword\">long</span> offsetPy, <span class=\"keyword\">long</span> maxOffsetPy)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">222</span>:     <span class=\"keyword\">long</span> memory = (<span class=\"keyword\">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE * (<span class=\"keyword\">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class=\"number\">100.0</span>));</div><div class=\"line\"><span class=\"number\">223</span>:     <span class=\"keyword\">return</span> (maxOffsetPy - offsetPy) &gt; memory;</div><div class=\"line\"><span class=\"number\">224</span>: &#125;</div><div class=\"line\"><span class=\"number\">225</span>: </div><div class=\"line\"><span class=\"number\">226</span>: <span class=\"comment\">/**</span></div><div class=\"line\">227:  * åˆ¤æ–­è·å–æ¶ˆæ¯æ˜¯å¦å·²ç»æ»¡</div><div class=\"line\">228:  *</div><div class=\"line\">229:  * <span class=\"doctag\">@param</span> sizePy å­—èŠ‚æ•°</div><div class=\"line\">230:  * <span class=\"doctag\">@param</span> maxMsgNums æœ€å¤§æ¶ˆæ¯æ•°</div><div class=\"line\">231:  * <span class=\"doctag\">@param</span> bufferTotal ç›®å‰å·²ç»è®¡ç®—å­—èŠ‚æ•°</div><div class=\"line\">232:  * <span class=\"doctag\">@param</span> messageTotal ç›®å‰å·²ç»è®¡ç®—æ¶ˆæ¯æ•°</div><div class=\"line\">233:  * <span class=\"doctag\">@param</span> isInDisk æ˜¯å¦åœ¨ç¡¬ç›˜ä¸­</div><div class=\"line\">234:  * <span class=\"doctag\">@return</span> æ˜¯å¦å·²æ»¡</div><div class=\"line\">235:  */</div><div class=\"line\"><span class=\"number\">236</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isTheBatchFull</span><span class=\"params\">(<span class=\"keyword\">int</span> sizePy, <span class=\"keyword\">int</span> maxMsgNums, <span class=\"keyword\">int</span> bufferTotal, <span class=\"keyword\">int</span> messageTotal, <span class=\"keyword\">boolean</span> isInDisk)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">237</span>:     <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == bufferTotal || <span class=\"number\">0</span> == messageTotal) &#123;</div><div class=\"line\"><span class=\"number\">238</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">239</span>:     &#125;</div><div class=\"line\"><span class=\"number\">240</span>:     <span class=\"comment\">// æ¶ˆæ¯æ•°é‡å·²ç»æ»¡è¶³è¯·æ±‚æ•°é‡(maxMsgNums)</span></div><div class=\"line\"><span class=\"number\">241</span>:     <span class=\"keyword\">if</span> ((messageTotal + <span class=\"number\">1</span>) &gt;= maxMsgNums) &#123;</div><div class=\"line\"><span class=\"number\">242</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">243</span>:     &#125;</div><div class=\"line\"><span class=\"number\">244</span>:     <span class=\"comment\">// æ ¹æ®æ¶ˆæ¯å­˜å‚¨é…ç½®çš„æœ€å¤§ä¼ è¾“å­—èŠ‚æ•°ã€æœ€å¤§ä¼ è¾“æ¶ˆæ¯æ•°æ˜¯å¦å·²æ»¡</span></div><div class=\"line\"><span class=\"number\">245</span>:     <span class=\"keyword\">if</span> (isInDisk) &#123;</div><div class=\"line\"><span class=\"number\">246</span>:         <span class=\"keyword\">if</span> ((bufferTotal + sizePy) &gt; <span class=\"keyword\">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInDisk()) &#123;</div><div class=\"line\"><span class=\"number\">247</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">248</span>:         &#125;</div><div class=\"line\"><span class=\"number\">249</span>: </div><div class=\"line\"><span class=\"number\">250</span>:         <span class=\"keyword\">if</span> ((messageTotal + <span class=\"number\">1</span>) &gt; <span class=\"keyword\">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInDisk()) &#123;</div><div class=\"line\"><span class=\"number\">251</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">252</span>:         &#125;</div><div class=\"line\"><span class=\"number\">253</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">254</span>:         <span class=\"keyword\">if</span> ((bufferTotal + sizePy) &gt; <span class=\"keyword\">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInMemory()) &#123;</div><div class=\"line\"><span class=\"number\">255</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">256</span>:         &#125;</div><div class=\"line\"><span class=\"number\">257</span>: </div><div class=\"line\"><span class=\"number\">258</span>:         <span class=\"keyword\">if</span> ((messageTotal + <span class=\"number\">1</span>) &gt; <span class=\"keyword\">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInMemory()) &#123;</div><div class=\"line\"><span class=\"number\">259</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">260</span>:         &#125;</div><div class=\"line\"><span class=\"number\">261</span>:     &#125;</div><div class=\"line\"><span class=\"number\">262</span>: </div><div class=\"line\"><span class=\"number\">263</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">264</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ ¹æ® æ¶ˆæ¯åˆ†ç»„(<code>group</code>) + ä¸»é¢˜(<code>Topic</code>) + é˜Ÿåˆ—ç¼–å·(<code>queueId</code>) + é˜Ÿåˆ—ä½ç½®(<code>offset</code>) + è®¢é˜…ä¿¡æ¯(<code>subscriptionData</code>) è·å– æŒ‡å®šæ¡æ•°(<code>maxMsgNums</code>) æ¶ˆæ¯(<code>Message</code>)ã€‚</li>\n<li>ç¬¬ 14 è‡³ 18 è¡Œ ï¼šåˆ¤æ–­ <code>Store</code> æ˜¯å¦å¤„äºå…³é—­çŠ¶æ€ï¼Œè‹¥å…³é—­ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 19 è‡³ 23 è¡Œ ï¼šåˆ¤æ–­å½“å‰è¿è¡ŒçŠ¶æ€æ˜¯å¦å¯è¯»ï¼Œè‹¥ä¸å¯è¯»ï¼Œåˆ™æ— æ³•è·å–æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 37 è¡Œ ï¼šæ ¹æ® ä¸»é¢˜(<code>Topic</code>) + é˜Ÿåˆ—ç¼–å·(<code>queueId</code>) è·å– æ¶ˆæ¯é˜Ÿåˆ—(<code>ConsumeQueue</code>)ã€‚\n<ul>\n<li><code>#findConsumeQueue(...)</code> ï¼šç¬¬ 159 è‡³ 196 è¡Œã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 43 è‡³ 58 è¡Œ ï¼šå„ç§é˜Ÿåˆ—ä½ç½®(<code>offset</code>) æ— æ³•è¯»å–æ¶ˆæ¯ï¼Œå¹¶é’ˆå¯¹å¯¹åº”çš„æƒ…å†µï¼Œè®¡ç®—ä¸‹ä¸€æ¬¡ <code>Client</code> é˜Ÿåˆ—æ‹‰å–ä½ç½®ã€‚\n<ul>\n<li>ç¬¬ 43 è‡³ 45 è¡Œ ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 46 è‡³ 48 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ å¤ªå°ã€‚</li>\n<li>ç¬¬ 49 è‡³ 51 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ æ°å¥½ç­‰äº æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§çš„é˜Ÿåˆ—ä½ç½®ã€‚è¯¥æƒ…å†µæ˜¯æ­£å¸¸ç°è±¡ï¼Œç›¸å½“äºæŸ¥è¯¢æœ€æ–°çš„æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 52 è‡³ 58 è¡Œ ï¼šæŸ¥è¯¢çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼ˆ<code>offset</code>ï¼‰ è¶…è¿‡è¿‡å¤šã€‚</li>\n<li><code>#nextOffsetCorrection(...)</code> ï¼šç¬¬ 198 è‡³ 212 è¡Œã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 61 è¡Œ ï¼šæ ¹æ® æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(<code>offset</code>) è·å– å¯¹åº”çš„<code>MappedFile</code>ã€‚</li>\n<li>ç¬¬ 72 è‡³ 128 è¡Œ ï¼š<strong>å¾ªç¯</strong>è·å– <code>æ¶ˆæ¯ä½ç½®ä¿¡æ¯</code>ã€‚\n<ul>\n<li>ç¬¬ 74 è‡³ 76 è¡Œ ï¼šè¯»å–æ¯ä¸€ä¸ª <code>æ¶ˆæ¯ä½ç½®ä¿¡æ¯</code>ã€‚</li>\n<li>ç¬¬ 79 è‡³ 83 è¡Œ ï¼šå½“ <code>offsetPy</code> å°äº <code>nextPhyFileStartOffset</code> æ—¶ï¼Œæ„å‘³ç€å¯¹\nåº”çš„ <code>Message</code> å·²ç»ç§»é™¤ï¼Œæ‰€ä»¥ç›´æ¥continueï¼Œç›´åˆ°å¯è¯»å–çš„ <code>Message</code>ã€‚</li>\n<li>ç¬¬ 84 è‡³ 90 è¡Œ ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»è·å¾—è¶³å¤Ÿçš„æ¶ˆæ¯ã€‚\n<ul>\n<li><code>#checkInDiskByCommitOffset(...)</code> ï¼šç¬¬ 214 è‡³ 224 è¡Œã€‚</li>\n<li><code>#isTheBatchFull(...)</code> ï¼šç¬¬ 226 è‡³ 264 è¡Œã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ç¬¬ 92 è¡Œ ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"defaultmessagefilterismessagematched\">DefaultMessageFilter#isMessageMatched(...)</a>ã€‚</li>\n<li>ç¬¬ 94 è¡Œ ï¼šä» <code>CommitLog</code> è·å–å¯¹åº” æ¶ˆæ¯çš„<code>MappedByteBuffer</code>ã€‚</li>\n<li>ç¬¬ 95 è‡³ 99 è¡Œ ï¼šè·å– <code>æ¶ˆæ¯MappedByteBuffer</code> æˆåŠŸã€‚</li>\n<li>ç¬¬ 100 è‡³ 106 è¡Œ ï¼šè·å– <code>æ¶ˆæ¯MappedByteBuffer</code> å¤±è´¥ã€‚ä» <code>CommitLog</code> æ— æ³•è¯»å–åˆ°æ¶ˆæ¯ï¼Œè¯´æ˜ è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–‡ä»¶(<code>MappedFile</code>) å·²ç»åˆ é™¤ï¼Œæ­¤æ—¶è®¡ç®—ä¸‹ä¸€ä¸ª<code>MappedFile</code>çš„èµ·å§‹ä½ç½®ã€‚<strong>è¯¥é€»è¾‘éœ€è¦é…åˆï¼ˆç¬¬ 79 è‡³ 83 è¡Œï¼‰ä¸€èµ·ç†è§£ã€‚</strong></li>\n<li>ç¬¬ 117 è‡³ 120 è¡Œ ï¼šç»Ÿè®¡å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ã€‚</li>\n<li>ç¬¬ 123 è¡Œ ï¼šè®¡ç®—ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ç¼–å·ã€‚</li>\n<li>ç¬¬ 124 è‡³ 128 è¡Œ ï¼šæ ¹æ®å‰©ä½™å¯æ‹‰å–æ¶ˆæ¯å­—èŠ‚æ•°ä¸å†…å­˜åˆ¤æ–­æ˜¯å¦å»ºè®®è¯»å–ä»èŠ‚ç‚¹ã€‚</li>\n<li>ç¬¬ 130 è¡Œ ï¼šé‡Šæ”¾ <code>bufferConsumeQueue</code> å¯¹ <code>MappedFile</code> çš„æŒ‡å‘ã€‚æ­¤å¤„ <code>MappedFile</code> æ˜¯ <code>ConsumeQueue</code> é‡Œçš„æ–‡ä»¶ï¼Œä¸æ˜¯ <code>CommitLog</code> ä¸‹çš„æ–‡ä»¶ã€‚</li>\n<li>ç¬¬ 133 è‡³ 136 è¡Œ ï¼šè·å¾—æ¶ˆè´¹é˜Ÿåˆ—ä½ç½®(<code>offset</code>) è·å– å¯¹åº”çš„<code>MappedFile</code> ä¸º<strong>ç©º</strong>ï¼Œè®¡ç®—<code>ConsumeQueue</code> ä» <code>offset</code> å¼€å§‹çš„ä¸‹ä¸€ä¸ª <code>MappedFile</code> å¯¹åº”çš„ä½ç½®ã€‚</li>\n<li>ç¬¬ 143 è‡³ 150 è¡Œ ï¼šè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼šæ¶ˆè€—æ—¶é—´ã€æ‹‰å–åˆ°æ¶ˆæ¯/æœªæ‹‰å–åˆ°æ¶ˆæ¯æ¬¡æ•°ã€‚</li>\n<li>ç¬¬ 151 è‡³ 156 è¡Œ ï¼šè®¾ç½®è¿”å›ç»“æœå¹¶è¿”å›ã€‚</li>\n</ul>\n<h2>DefaultMessageFilter#isMessageMatched(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultMessageFilter</span> <span class=\"keyword\">implements</span> <span class=\"title\">MessageFilter</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isMessageMatched</span><span class=\"params\">(SubscriptionData subscriptionData, Long tagsCode)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"comment\">// æ¶ˆæ¯tagsCode ç©º</span></div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">if</span> (tagsCode == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">8</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"comment\">// è®¢é˜…æ•°æ® ç©º</span></div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionData) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">12</span>:         &#125;</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"comment\">// classFilter</span></div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">if</span> (subscriptionData.isClassFilterMode())</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"comment\">// è®¢é˜…è¡¨è¾¾å¼ å…¨åŒ¹é…</span></div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">if</span> (subscriptionData.getSubString().equals(SubscriptionData.SUB_ALL)) &#123;</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"comment\">// è®¢é˜…æ•°æ®codeæ•°ç»„ æ˜¯å¦åŒ…å« æ¶ˆæ¯tagsCode</span></div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"keyword\">return</span> subscriptionData.getCodeSet().contains(tagsCode.intValue());</div><div class=\"line\"><span class=\"number\">22</span>:     &#125;</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ¶ˆæ¯è¿‡æ»¤å™¨é»˜è®¤å®ç°ã€‚</li>\n</ul>\n<h2>PullRequestHoldService</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PullRequestHoldService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>: </div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class=\"line\">  <span class=\"number\">4</span>: </div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_QUEUEID_SEPARATOR = <span class=\"string\">\"@\"</span>;</div><div class=\"line\">  <span class=\"number\">6</span>: </div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> BrokerController brokerController;</div><div class=\"line\">  <span class=\"number\">8</span>: </div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SystemClock systemClock = <span class=\"keyword\">new</span> SystemClock();</div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 11:      * æ¶ˆæ¯è¿‡æ»¤å™¨</div><div class=\"line\"> 12:      */</div><div class=\"line\"> <span class=\"number\">13</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MessageFilter messageFilter = <span class=\"keyword\">new</span> DefaultMessageFilter();</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 15:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é›†åˆ</div><div class=\"line\"> 16:      */</div><div class=\"line\"> <span class=\"number\">17</span>:     <span class=\"keyword\">private</span> ConcurrentHashMap&lt;String<span class=\"comment\">/* topic@queueId */</span>, ManyPullRequest&gt; pullRequestTable =</div><div class=\"line\"> <span class=\"number\">18</span>:             <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">1024</span>);</div><div class=\"line\"> <span class=\"number\">19</span>: </div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PullRequestHoldService</span><span class=\"params\">(<span class=\"keyword\">final</span> BrokerController brokerController)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">21</span>:         <span class=\"keyword\">this</span>.brokerController = brokerController;</div><div class=\"line\"> <span class=\"number\">22</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">23</span>: </div><div class=\"line\"> <span class=\"number\">24</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 25:      * æ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚</div><div class=\"line\"> 26:      *</div><div class=\"line\"> 27:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\"> 28:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\"> 29:      * <span class=\"doctag\">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 30:      */</div><div class=\"line\"> <span class=\"number\">31</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">suspendPullRequest</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">32</span>:         String key = <span class=\"keyword\">this</span>.buildKey(topic, queueId);</div><div class=\"line\"> <span class=\"number\">33</span>:         ManyPullRequest mpr = <span class=\"keyword\">this</span>.pullRequestTable.get(key);</div><div class=\"line\"> <span class=\"number\">34</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mpr) &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:             mpr = <span class=\"keyword\">new</span> ManyPullRequest();</div><div class=\"line\"> <span class=\"number\">36</span>:             ManyPullRequest prev = <span class=\"keyword\">this</span>.pullRequestTable.putIfAbsent(key, mpr);</div><div class=\"line\"> <span class=\"number\">37</span>:             <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">38</span>:                 mpr = prev;</div><div class=\"line\"> <span class=\"number\">39</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">40</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:         mpr.addPullRequest(pullRequest);</div><div class=\"line\"> <span class=\"number\">43</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">44</span>: </div><div class=\"line\"> <span class=\"number\">45</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 46:      * æ ¹æ® ä¸»é¢˜ + é˜Ÿåˆ—ç¼–å· åˆ›å»ºå”¯ä¸€æ ‡è¯†</div><div class=\"line\"> 47:      *</div><div class=\"line\"> 48:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\"> 49:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\"> 50:      * <span class=\"doctag\">@return</span> key</div><div class=\"line\"> 51:      */</div><div class=\"line\"> <span class=\"number\">52</span>:     <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">buildKey</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">53</span>:         StringBuilder sb = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\"> <span class=\"number\">54</span>:         sb.append(topic);</div><div class=\"line\"> <span class=\"number\">55</span>:         sb.append(TOPIC_QUEUEID_SEPARATOR);</div><div class=\"line\"> <span class=\"number\">56</span>:         sb.append(queueId);</div><div class=\"line\"> <span class=\"number\">57</span>:         <span class=\"keyword\">return</span> sb.toString();</div><div class=\"line\"> <span class=\"number\">58</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">59</span>: </div><div class=\"line\"> <span class=\"number\">60</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">61</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">62</span>:         log.info(<span class=\"string\">\"&#123;&#125; service started\"</span>, <span class=\"keyword\">this</span>.getServiceName());</div><div class=\"line\"> <span class=\"number\">63</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"> <span class=\"number\">64</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">65</span>:                 <span class=\"comment\">// æ ¹æ® é•¿è½®è®­ è¿˜æ˜¯ çŸ­è½®è®­ è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´</span></div><div class=\"line\"> <span class=\"number\">66</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</div><div class=\"line\"> <span class=\"number\">67</span>:                     <span class=\"keyword\">this</span>.waitForRunning(<span class=\"number\">5</span> * <span class=\"number\">1000</span>);</div><div class=\"line\"> <span class=\"number\">68</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">69</span>:                     <span class=\"keyword\">this</span>.waitForRunning(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills());</div><div class=\"line\"> <span class=\"number\">70</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">71</span>:                 <span class=\"comment\">// æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„</span></div><div class=\"line\"> <span class=\"number\">72</span>:                 <span class=\"keyword\">long</span> beginLockTimestamp = <span class=\"keyword\">this</span>.systemClock.now();</div><div class=\"line\"> <span class=\"number\">73</span>:                 <span class=\"keyword\">this</span>.checkHoldRequest();</div><div class=\"line\"> <span class=\"number\">74</span>:                 <span class=\"keyword\">long</span> costTime = <span class=\"keyword\">this</span>.systemClock.now() - beginLockTimestamp;</div><div class=\"line\"> <span class=\"number\">75</span>:                 <span class=\"keyword\">if</span> (costTime &gt; <span class=\"number\">5</span> * <span class=\"number\">1000</span>) &#123;</div><div class=\"line\"> <span class=\"number\">76</span>:                     log.info(<span class=\"string\">\"[NOTIFYME] check hold request cost &#123;&#125; ms.\"</span>, costTime);</div><div class=\"line\"> <span class=\"number\">77</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">78</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">79</span>:                 log.warn(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service has exception. \"</span>, e);</div><div class=\"line\"> <span class=\"number\">80</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">81</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">82</span>: </div><div class=\"line\"> <span class=\"number\">83</span>:         log.info(<span class=\"string\">\"&#123;&#125; service end\"</span>, <span class=\"keyword\">this</span>.getServiceName());</div><div class=\"line\"> <span class=\"number\">84</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">85</span>: </div><div class=\"line\"> <span class=\"number\">86</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">87</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">return</span> PullRequestHoldService.class.getSimpleName();</div><div class=\"line\"> <span class=\"number\">89</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">90</span>: </div><div class=\"line\"> <span class=\"number\">91</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 92:      * éå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚</div><div class=\"line\"> 93:      */</div><div class=\"line\"> <span class=\"number\">94</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">checkHoldRequest</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">95</span>:         <span class=\"keyword\">for</span> (String key : <span class=\"keyword\">this</span>.pullRequestTable.keySet()) &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:             String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);</div><div class=\"line\"> <span class=\"number\">97</span>:             <span class=\"keyword\">if</span> (<span class=\"number\">2</span> == kArray.length) &#123;</div><div class=\"line\"> <span class=\"number\">98</span>:                 String topic = kArray[<span class=\"number\">0</span>];</div><div class=\"line\"> <span class=\"number\">99</span>:                 <span class=\"keyword\">int</span> queueId = Integer.parseInt(kArray[<span class=\"number\">1</span>]);</div><div class=\"line\"><span class=\"number\">100</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset = <span class=\"keyword\">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class=\"line\"><span class=\"number\">101</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">102</span>:                     <span class=\"keyword\">this</span>.notifyMessageArriving(topic, queueId, offset);</div><div class=\"line\"><span class=\"number\">103</span>:                 &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">104</span>:                     log.error(<span class=\"string\">\"check hold request failed. topic=&#123;&#125;, queueId=&#123;&#125;\"</span>, topic, queueId, e);</div><div class=\"line\"><span class=\"number\">105</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">106</span>:             &#125;</div><div class=\"line\"><span class=\"number\">107</span>:         &#125;</div><div class=\"line\"><span class=\"number\">108</span>:     &#125;</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">111:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚</div><div class=\"line\">112:      *</div><div class=\"line\">113:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">114:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">115:      * <span class=\"doctag\">@param</span> maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset</div><div class=\"line\">116:      */</div><div class=\"line\"><span class=\"number\">117</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">notifyMessageArriving</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> maxOffset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">118</span>:         notifyMessageArriving(topic, queueId, maxOffset, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">119</span>:     &#125;</div><div class=\"line\"><span class=\"number\">120</span>: </div><div class=\"line\"><span class=\"number\">121</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">122:      * æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚</div><div class=\"line\">123:      *</div><div class=\"line\">124:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">125:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">126:      * <span class=\"doctag\">@param</span> maxOffset æ¶ˆè´¹é˜Ÿåˆ—æœ€å¤§offset</div><div class=\"line\">127:      * <span class=\"doctag\">@param</span> tagsCode è¿‡æ»¤tagsCode</div><div class=\"line\">128:      */</div><div class=\"line\"><span class=\"number\">129</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">notifyMessageArriving</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> maxOffset, <span class=\"keyword\">final</span> Long tagsCode)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">130</span>:         String key = <span class=\"keyword\">this</span>.buildKey(topic, queueId);</div><div class=\"line\"><span class=\"number\">131</span>:         ManyPullRequest mpr = <span class=\"keyword\">this</span>.pullRequestTable.get(key);</div><div class=\"line\"><span class=\"number\">132</span>:         <span class=\"keyword\">if</span> (mpr != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">133</span>:             <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">134</span>:             List&lt;PullRequest&gt; requestList = mpr.cloneListAndClear();</div><div class=\"line\"><span class=\"number\">135</span>:             <span class=\"keyword\">if</span> (requestList != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">136</span>:                 List&lt;PullRequest&gt; replayList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(); <span class=\"comment\">// ä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚æ•°ç»„</span></div><div class=\"line\"><span class=\"number\">137</span>: </div><div class=\"line\"><span class=\"number\">138</span>:                 <span class=\"keyword\">for</span> (PullRequest request : requestList) &#123;</div><div class=\"line\"><span class=\"number\">139</span>:                     <span class=\"comment\">// å¦‚æœ maxOffset è¿‡å°ï¼Œåˆ™é‡æ–°è¯»å–ä¸€æ¬¡ã€‚</span></div><div class=\"line\"><span class=\"number\">140</span>:                     <span class=\"keyword\">long</span> newestOffset = maxOffset;</div><div class=\"line\"><span class=\"number\">141</span>:                     <span class=\"keyword\">if</span> (newestOffset &lt;= request.getPullFromThisOffset()) &#123;</div><div class=\"line\"><span class=\"number\">142</span>:                         newestOffset = <span class=\"keyword\">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class=\"line\"><span class=\"number\">143</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">144</span>:                     <span class=\"comment\">// æœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class=\"line\"><span class=\"number\">145</span>:                     <span class=\"keyword\">if</span> (newestOffset &gt; request.getPullFromThisOffset()) &#123;</div><div class=\"line\"><span class=\"number\">146</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.messageFilter.isMessageMatched(request.getSubscriptionData(), tagsCode)) &#123;</div><div class=\"line\"><span class=\"number\">147</span>:                             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">148</span>:                                 <span class=\"keyword\">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class=\"line\"><span class=\"number\">149</span>:                                     request.getRequestCommand());</div><div class=\"line\"><span class=\"number\">150</span>:                             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">151</span>:                                 log.error(<span class=\"string\">\"execute request when wakeup failed.\"</span>, e);</div><div class=\"line\"><span class=\"number\">152</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">153</span>:                             <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">154</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">155</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">156</span>:                     <span class=\"comment\">// è¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class=\"line\"><span class=\"number\">157</span>:                     <span class=\"keyword\">if</span> (System.currentTimeMillis() &gt;= (request.getSuspendTimestamp() + request.getTimeoutMillis())) &#123;</div><div class=\"line\"><span class=\"number\">158</span>:                         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">159</span>:                             <span class=\"keyword\">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class=\"line\"><span class=\"number\">160</span>:                                 request.getRequestCommand());</div><div class=\"line\"><span class=\"number\">161</span>:                         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">162</span>:                             log.error(<span class=\"string\">\"execute request when wakeup failed.\"</span>, e);</div><div class=\"line\"><span class=\"number\">163</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">164</span>:                         <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">165</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">166</span>:                     <span class=\"comment\">// ä¸ç¬¦åˆå†æ¬¡æ‹‰å–çš„è¯·æ±‚ï¼Œå†æ¬¡æ·»åŠ å›å»</span></div><div class=\"line\"><span class=\"number\">167</span>:                     replayList.add(request);</div><div class=\"line\"><span class=\"number\">168</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">169</span>:                 <span class=\"comment\">// æ·»åŠ å›å»</span></div><div class=\"line\"><span class=\"number\">170</span>:                 <span class=\"keyword\">if</span> (!replayList.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">171</span>:                     mpr.addPullRequest(replayList);</div><div class=\"line\"><span class=\"number\">172</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">173</span>:             &#125;</div><div class=\"line\"><span class=\"number\">174</span>:         &#125;</div><div class=\"line\"><span class=\"number\">175</span>:     &#125;</div><div class=\"line\"><span class=\"number\">176</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>PullRequestHoldService</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯è¯·æ±‚æŒ‚èµ·ç»´æŠ¤çº¿ç¨‹æœåŠ¡ã€‚\n<ul>\n<li>å½“æ‹‰å–æ¶ˆæ¯è¯·æ±‚è·å¾—ä¸äº†æ¶ˆæ¯æ—¶ï¼Œåˆ™ä¼šå°†è¯·æ±‚è¿›è¡ŒæŒ‚èµ·ï¼Œæ·»åŠ åˆ°è¯¥æœåŠ¡ã€‚</li>\n<li>å½“æœ‰ç¬¦åˆæ¡ä»¶ä¿¡æ¯æ—¶ æˆ– æŒ‚èµ·è¶…æ—¶æ—¶ï¼Œé‡æ–°æ‰§è¡Œè·å–æ¶ˆæ¯é€»è¾‘ã€‚</li>\n</ul>\n</li>\n<li><code>#suspendPullRequest(...)</code> è¯´æ˜ ï¼šæ·»åŠ æ‹‰å–æ¶ˆæ¯æŒ‚èµ·è¯·æ±‚åˆ°é›†åˆ( <code>pullRequestTable</code> )ã€‚</li>\n<li><code>#run(...)</code> è¯´æ˜ ï¼š<strong>å®šæ—¶</strong>æ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥é‡æ–°æ‹‰å–æ¶ˆæ¯å¹¶è¿›è¡Œé€šçŸ¥ã€‚\n<ul>\n<li>ç¬¬ 65 è‡³ 70 è¡Œ ï¼šæ ¹æ®<code>é•¿è½®è®­</code>or<code>çŸ­è½®è®­</code>è®¾ç½®ä¸åŒçš„ç­‰å¾…æ—¶é—´ã€‚</li>\n<li>ç¬¬ 71 è‡³ 77 è¡Œ ï¼šæ£€æŸ¥æŒ‚èµ·è¯·æ±‚æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚</li>\n</ul>\n</li>\n<li><code>#checkHoldRequest(...)</code> è¯´æ˜ ï¼šéå†æŒ‚èµ·è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„ã€‚</li>\n<li><code>#notifyMessageArriving(...)</code> è¯´æ˜ ï¼šæ£€æŸ¥<strong>æŒ‡å®šé˜Ÿåˆ—</strong>æ˜¯å¦æœ‰éœ€è¦é€šçŸ¥çš„è¯·æ±‚ã€‚\n<ul>\n<li>ç¬¬ 139 è‡³ 143 è¡Œ ï¼šå¦‚æœ <code>maxOffset</code> è¿‡å°ï¼Œé‡æ–°è·å–ä¸€æ¬¡æœ€æ–°çš„ã€‚</li>\n<li>ç¬¬ 144 è‡³ 155 è¡Œ ï¼šæœ‰æ–°çš„åŒ¹é…æ¶ˆæ¯ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 156 è‡³ 165 è¡Œ ï¼šè¶…è¿‡æŒ‚èµ·æ—¶é—´ï¼Œå”¤é†’è¯·æ±‚ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 148 || 159 è¡Œ ï¼šå”¤é†’è¯·æ±‚ï¼Œå†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚åŸå…ˆæ‹…å¿ƒæ‹‰å–æ¶ˆæ¯æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´å½±å“æ•´ä¸ªæŒ‚èµ·è¯·æ±‚çš„éå†ï¼Œåé¢æŸ¥çœ‹<code>#executeRequestWhenWakeup(...)</code>ï¼Œå®é™…æ˜¯ä¸¢åˆ°çº¿ç¨‹æ± è¿›è¡Œä¸€æ­¥çš„æ¶ˆæ¯æ‹‰å–ï¼Œä¸ä¼šæœ‰æ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"pullmessageprocessorexecuterequestwhenwakeup\">PullMessageProcessor#executeRequestWhenWakeup(...)</a>ã€‚</li>\n<li>ç¬¬ 166 è‡³ 172 è¡Œ ï¼šä¸ç¬¦åˆå”¤é†’çš„è¯·æ±‚é‡æ–°æ·»åŠ åˆ°é›†åˆ(<code>pullRequestTable</code>)ã€‚</li>\n</ul>\n</li>\n</ul>\n<h2>PullMessageProcessor#executeRequestWhenWakeup(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executeRequestWhenWakeup</span><span class=\"params\">(<span class=\"keyword\">final</span> Channel channel, <span class=\"keyword\">final</span> RemotingCommand request)</span> <span class=\"keyword\">throws</span> RemotingCommandException </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     Runnable run = <span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:                 <span class=\"comment\">// è°ƒç”¨æ‹‰å–è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®ä¸æŒ‚èµ·è¯·æ±‚ã€‚</span></div><div class=\"line\"> <span class=\"number\">7</span>:                 <span class=\"keyword\">final</span> RemotingCommand response = PullMessageProcessor.<span class=\"keyword\">this</span>.processRequest(channel, request, <span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:                 <span class=\"keyword\">if</span> (response != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:                     response.setOpaque(request.getOpaque());</div><div class=\"line\"><span class=\"number\">11</span>:                     response.markResponseType();</div><div class=\"line\"><span class=\"number\">12</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                         channel.writeAndFlush(response).addListener(<span class=\"keyword\">new</span> ChannelFutureListener() &#123;</div><div class=\"line\"><span class=\"number\">14</span>:                             <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">15</span>:                             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">operationComplete</span><span class=\"params\">(ChannelFuture future)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:                                 <span class=\"keyword\">if</span> (!future.isSuccess()) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                                     LOG.error(<span class=\"string\">\"ProcessRequestWrapper response to &#123;&#125; failed\"</span>, future.channel().remoteAddress(), future.cause());</div><div class=\"line\"><span class=\"number\">18</span>:                                     LOG.error(request.toString());</div><div class=\"line\"><span class=\"number\">19</span>:                                     LOG.error(response.toString());</div><div class=\"line\"><span class=\"number\">20</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">21</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">22</span>:                         &#125;);</div><div class=\"line\"><span class=\"number\">23</span>:                     &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                         LOG.error(<span class=\"string\">\"ProcessRequestWrapper process request over, but response failed\"</span>, e);</div><div class=\"line\"><span class=\"number\">25</span>:                         LOG.error(request.toString());</div><div class=\"line\"><span class=\"number\">26</span>:                         LOG.error(response.toString());</div><div class=\"line\"><span class=\"number\">27</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">28</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">29</span>:             &#125; <span class=\"keyword\">catch</span> (RemotingCommandException e1) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                 LOG.error(<span class=\"string\">\"ExecuteRequestWhenWakeup run\"</span>, e1);</div><div class=\"line\"><span class=\"number\">31</span>:             &#125;</div><div class=\"line\"><span class=\"number\">32</span>:         &#125;</div><div class=\"line\"><span class=\"number\">33</span>:     &#125;;</div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">// æäº¤æ‹‰å–è¯·æ±‚åˆ°çº¿ç¨‹æ± </span></div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"keyword\">this</span>.brokerController.getPullMessageExecutor().submit(<span class=\"keyword\">new</span> RequestTask(run, channel, request));</div><div class=\"line\"><span class=\"number\">36</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ‰§è¡Œè¯·æ±‚å”¤é†’ï¼Œå³å†æ¬¡æ‹‰å–æ¶ˆæ¯ã€‚è¯¥æ–¹æ³•è°ƒç”¨çº¿ç¨‹æ± ï¼Œå› æ­¤ï¼Œä¸ä¼šé˜»å¡ã€‚</li>\n<li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚æœ¬æ¬¡è°ƒç”¨ï¼Œè®¾ç½®å³ä½¿è¯·æ±‚ä¸åˆ°æ¶ˆæ¯ï¼Œä¹Ÿä¸æŒ‚èµ·è¯·æ±‚ã€‚å¦‚æœä¸è®¾ç½®ï¼Œè¯·æ±‚å¯èƒ½è¢«æ— é™æŒ‚èµ·ï¼Œè¢« <code>Broker</code> æ— é™å¾ªç¯ã€‚</li>\n<li>ç¬¬ 35 è¡Œ ï¼š<strong>æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚åˆ°çº¿ç¨‹æ± </strong>ã€‚</li>\n</ul>\n<h1>5ã€Broker æä¾›[æ›´æ–°æ¶ˆè´¹è¿›åº¦]æ¥å£</h1>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><div class=\"line\">Yunai-MacdeMacBook-Pro-2:config yunai$ <span class=\"built_in\">pwd</span></div><div class=\"line\">/Users/yunai/store/config</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:config yunai$ ls -ls</div><div class=\"line\">total 40</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json.bak</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json.bak</div><div class=\"line\">8 -rw-r--r--  1 yunai  staff  1401  4 27 21:51 topics.json</div><div class=\"line\">Yunai-MacdeMacBook-Pro-2:config yunai$ cat consumerOffset.json</div><div class=\"line\">&#123;</div><div class=\"line\">\t<span class=\"string\">\"offsetTable\"</span>:&#123;</div><div class=\"line\">\t\t<span class=\"string\">\"%RETRY%please_rename_unique_group_name_4@please_rename_unique_group_name_4\"</span>:&#123;0:0</div><div class=\"line\">\t\t&#125;,</div><div class=\"line\">\t\t<span class=\"string\">\"TopicRead3@please_rename_unique_group_name_4\"</span>:&#123;1:5</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>consumerOffset.json</code> ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶ã€‚</li>\n<li><code>consumerOffset.json.bak</code> ï¼šæ¶ˆè´¹è¿›åº¦å­˜å‚¨æ–‡ä»¶å¤‡ä»½ã€‚</li>\n<li>æ¯æ¬¡å†™å…¥ <code>consumerOffset.json</code>ï¼Œå°†åŸå†…å®¹å¤‡ä»½åˆ° <code>consumerOffset.json.bak</code>ã€‚å®ç°è§ï¼š<a href=\"mixallstring2file\">MixAll#string2File(...)</a>ã€‚</li>\n</ul>\n<h2>BrokerController#initialize(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>:<span class=\"keyword\">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">2</span>:    <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">3</span>:    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">4</span>:        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:            BrokerController.<span class=\"keyword\">this</span>.consumerOffsetManager.persist();</div><div class=\"line\"> <span class=\"number\">6</span>:        &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:            log.error(<span class=\"string\">\"schedule persist consumerOffset error.\"</span>, e);</div><div class=\"line\"> <span class=\"number\">8</span>:        &#125;</div><div class=\"line\"> <span class=\"number\">9</span>:    &#125;</div><div class=\"line\"><span class=\"number\">10</span>:&#125;, <span class=\"number\">1000</span> * <span class=\"number\">10</span>, <span class=\"keyword\">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ¯ 5s æ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–é€»è¾‘ã€‚</li>\n</ul>\n<h2>ConfigManager</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConfigManager</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger PLOG = LoggerFactory.getLogger(LoggerName.COMMON_LOGGER_NAME);</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 5:  * ç¼–ç å†…å®¹</div><div class=\"line\"> 6:  * <span class=\"doctag\">@return</span> ç¼–ç åçš„å†…å®¹</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> String <span class=\"title\">encode</span><span class=\"params\">()</span></span>;</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"comment\">/**</span></div><div class=\"line\">11:  * åŠ è½½æ–‡ä»¶</div><div class=\"line\">12:  *</div><div class=\"line\">13:  * <span class=\"doctag\">@return</span> åŠ è½½æ˜¯å¦æˆåŠŸ</div><div class=\"line\">14:  */</div><div class=\"line\"><span class=\"number\">15</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">load</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:     String fileName = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">18</span>:         fileName = <span class=\"keyword\">this</span>.configFilePath();</div><div class=\"line\"><span class=\"number\">19</span>:         String jsonString = MixAll.file2String(fileName);</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"comment\">// å¦‚æœå†…å®¹ä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½å¤‡ä»½æ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">21</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == jsonString || jsonString.length() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.loadBak();</div><div class=\"line\"><span class=\"number\">23</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">this</span>.decode(jsonString);</div><div class=\"line\"><span class=\"number\">25</span>:             PLOG.info(<span class=\"string\">\"load &#123;&#125; OK\"</span>, fileName);</div><div class=\"line\"><span class=\"number\">26</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">27</span>:         &#125;</div><div class=\"line\"><span class=\"number\">28</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:         PLOG.error(<span class=\"string\">\"load \"</span> + fileName + <span class=\"string\">\" Failed, and try to load backup file\"</span>, e);</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.loadBak();</div><div class=\"line\"><span class=\"number\">31</span>:     &#125;</div><div class=\"line\"><span class=\"number\">32</span>: &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>: <span class=\"comment\">/**</span></div><div class=\"line\">35:  * é…ç½®æ–‡ä»¶åœ°å€</div><div class=\"line\">36:  *</div><div class=\"line\">37:  * <span class=\"doctag\">@return</span> é…ç½®æ–‡ä»¶åœ°å€</div><div class=\"line\">38:  */</div><div class=\"line\"><span class=\"number\">39</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> String <span class=\"title\">configFilePath</span><span class=\"params\">()</span></span>;</div><div class=\"line\"><span class=\"number\">40</span>: </div><div class=\"line\"><span class=\"number\">41</span>: <span class=\"comment\">/**</span></div><div class=\"line\">42:  * åŠ è½½å¤‡ä»½æ–‡ä»¶</div><div class=\"line\">43:  *</div><div class=\"line\">44:  * <span class=\"doctag\">@return</span> æ˜¯å¦æˆåŠŸ</div><div class=\"line\">45:  */</div><div class=\"line\"><span class=\"number\">46</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">loadBak</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">47</span>:     String fileName = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">48</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">49</span>:         fileName = <span class=\"keyword\">this</span>.configFilePath();</div><div class=\"line\"><span class=\"number\">50</span>:         String jsonString = MixAll.file2String(fileName + <span class=\"string\">\".bak\"</span>);</div><div class=\"line\"><span class=\"number\">51</span>:         <span class=\"keyword\">if</span> (jsonString != <span class=\"keyword\">null</span> &amp;&amp; jsonString.length() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">52</span>:             <span class=\"keyword\">this</span>.decode(jsonString);</div><div class=\"line\"><span class=\"number\">53</span>:             PLOG.info(<span class=\"string\">\"load \"</span> + fileName + <span class=\"string\">\" OK\"</span>);</div><div class=\"line\"><span class=\"number\">54</span>:             <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">55</span>:         &#125;</div><div class=\"line\"><span class=\"number\">56</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">57</span>:         PLOG.error(<span class=\"string\">\"load \"</span> + fileName + <span class=\"string\">\" Failed\"</span>, e);</div><div class=\"line\"><span class=\"number\">58</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">59</span>:     &#125;</div><div class=\"line\"><span class=\"number\">60</span>: </div><div class=\"line\"><span class=\"number\">61</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">62</span>: &#125;</div><div class=\"line\"><span class=\"number\">63</span>: </div><div class=\"line\"><span class=\"number\">64</span>: <span class=\"comment\">/**</span></div><div class=\"line\">65:  * è§£ç å†…å®¹</div><div class=\"line\">66:  *</div><div class=\"line\">67:  * <span class=\"doctag\">@param</span> jsonString å†…å®¹</div><div class=\"line\">68:  */</div><div class=\"line\"><span class=\"number\">69</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">decode</span><span class=\"params\">(<span class=\"keyword\">final</span> String jsonString)</span></span>;</div><div class=\"line\"><span class=\"number\">70</span>: </div><div class=\"line\"><span class=\"number\">71</span>: <span class=\"comment\">/**</span></div><div class=\"line\">72:  * æŒä¹…åŒ–</div><div class=\"line\">73:  */</div><div class=\"line\"><span class=\"number\">74</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">persist</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">75</span>:     String jsonString = <span class=\"keyword\">this</span>.encode(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">76</span>:     <span class=\"keyword\">if</span> (jsonString != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">77</span>:         String fileName = <span class=\"keyword\">this</span>.configFilePath();</div><div class=\"line\"><span class=\"number\">78</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">79</span>:             MixAll.string2File(jsonString, fileName);</div><div class=\"line\"><span class=\"number\">80</span>:         &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">81</span>:             PLOG.error(<span class=\"string\">\"persist file Exception, \"</span> + fileName, e);</div><div class=\"line\"><span class=\"number\">82</span>:         &#125;</div><div class=\"line\"><span class=\"number\">83</span>:     &#125;</div><div class=\"line\"><span class=\"number\">84</span>: &#125;</div><div class=\"line\"><span class=\"number\">85</span>: </div><div class=\"line\"><span class=\"number\">86</span>: <span class=\"comment\">/**</span></div><div class=\"line\">87:  * ç¼–ç å­˜å‚¨å†…å®¹</div><div class=\"line\">88:  *</div><div class=\"line\">89:  * <span class=\"doctag\">@param</span> prettyFormat æ˜¯å¦æ ¼å¼åŒ–</div><div class=\"line\">90:  * <span class=\"doctag\">@return</span> å†…å®¹</div><div class=\"line\">91:  */</div><div class=\"line\"><span class=\"number\">92</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> String <span class=\"title\">encode</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> prettyFormat)</span></span>;</div><div class=\"line\"><span class=\"number\">93</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>MixAll#string2File(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶</div><div class=\"line\"> 3:  * å®‰å…¨å†™</div><div class=\"line\"> 4:  * 1. å†™åˆ°.tmpæ–‡ä»¶</div><div class=\"line\"> 5:  * 2. å¤‡ä»½å‡†å¤‡å†™å…¥æ–‡ä»¶åˆ°.bakæ–‡ä»¶</div><div class=\"line\"> 6:  * 3. åˆ é™¤åŸæ–‡ä»¶ï¼Œå°†.tmpä¿®æ”¹æˆæ–‡ä»¶</div><div class=\"line\"> 7:  *</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> str å†…å®¹</div><div class=\"line\"> 9:  * <span class=\"doctag\">@param</span> fileName æ–‡ä»¶å</div><div class=\"line\">10:  * <span class=\"doctag\">@throws</span> IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">11:  */</div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">string2File</span><span class=\"params\">(<span class=\"keyword\">final</span> String str, <span class=\"keyword\">final</span> String fileName)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"comment\">// å†™åˆ° tmpæ–‡ä»¶</span></div><div class=\"line\"><span class=\"number\">14</span>:     String tmpFile = fileName + <span class=\"string\">\".tmp\"</span>;</div><div class=\"line\"><span class=\"number\">15</span>:     string2FileNotSafe(str, tmpFile);</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">17</span>:     String bakFile = fileName + <span class=\"string\">\".bak\"</span>;</div><div class=\"line\"><span class=\"number\">18</span>:     String prevContent = file2String(fileName);</div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">if</span> (prevContent != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:         string2FileNotSafe(prevContent, bakFile);</div><div class=\"line\"><span class=\"number\">21</span>:     &#125;</div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>:     File file = <span class=\"keyword\">new</span> File(fileName);</div><div class=\"line\"><span class=\"number\">24</span>:     file.delete();</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:     file = <span class=\"keyword\">new</span> File(tmpFile);</div><div class=\"line\"><span class=\"number\">27</span>:     file.renameTo(<span class=\"keyword\">new</span> File(fileName));</div><div class=\"line\"><span class=\"number\">28</span>: &#125;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>: <span class=\"comment\">/**</span></div><div class=\"line\">31:  * å°†å†…å®¹å†™åˆ°æ–‡ä»¶</div><div class=\"line\">32:  * éå®‰å…¨å†™</div><div class=\"line\">33:  *</div><div class=\"line\">34:  * <span class=\"doctag\">@param</span> str å†…å®¹</div><div class=\"line\">35:  * <span class=\"doctag\">@param</span> fileName æ–‡ä»¶å†…å®¹</div><div class=\"line\">36:  * <span class=\"doctag\">@throws</span> IOException å½“IOå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">37:  */</div><div class=\"line\"><span class=\"number\">38</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">string2FileNotSafe</span><span class=\"params\">(<span class=\"keyword\">final</span> String str, <span class=\"keyword\">final</span> String fileName)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</div><div class=\"line\"><span class=\"number\">39</span>:     File file = <span class=\"keyword\">new</span> File(fileName);</div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"comment\">// åˆ›å»ºä¸Šçº§ç›®å½•</span></div><div class=\"line\"><span class=\"number\">41</span>:     File fileParent = file.getParentFile();</div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"keyword\">if</span> (fileParent != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">43</span>:         fileParent.mkdirs();</div><div class=\"line\"><span class=\"number\">44</span>:     &#125;</div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"comment\">// å†™å†…å®¹</span></div><div class=\"line\"><span class=\"number\">46</span>:     FileWriter fileWriter = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">47</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">48</span>:         fileWriter = <span class=\"keyword\">new</span> FileWriter(file);</div><div class=\"line\"><span class=\"number\">49</span>:         fileWriter.write(str);</div><div class=\"line\"><span class=\"number\">50</span>:     &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:         <span class=\"keyword\">throw</span> e;</div><div class=\"line\"><span class=\"number\">52</span>:     &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">53</span>:         <span class=\"keyword\">if</span> (fileWriter != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">54</span>:             fileWriter.close();</div><div class=\"line\"><span class=\"number\">55</span>:         &#125;</div><div class=\"line\"><span class=\"number\">56</span>:     &#125;</div><div class=\"line\"><span class=\"number\">57</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h2>ConsumerOffsetManager</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConsumerOffsetManager</span> <span class=\"keyword\">extends</span> <span class=\"title\">ConfigManager</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_GROUP_SEPARATOR = <span class=\"string\">\"@\"</span>;</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 6:      * æ¶ˆè´¹è¿›åº¦é›†åˆ</div><div class=\"line\"> 7:      */</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">private</span> ConcurrentHashMap&lt;String<span class=\"comment\">/* topic@group */</span>, ConcurrentHashMap&lt;Integer, Long&gt;&gt; offsetTable = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">512</span>);</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> BrokerController brokerController;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConsumerOffsetManager</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">13</span>:     &#125;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConsumerOffsetManager</span><span class=\"params\">(BrokerController brokerController)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">this</span>.brokerController = brokerController;</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: </div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">20:      * æäº¤æ¶ˆè´¹è¿›åº¦</div><div class=\"line\">21:      *</div><div class=\"line\">22:      * <span class=\"doctag\">@param</span> clientHost æäº¤clientåœ°å€</div><div class=\"line\">23:      * <span class=\"doctag\">@param</span> group æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\">24:      * <span class=\"doctag\">@param</span> topic ä¸»é¢˜</div><div class=\"line\">25:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">26:      * <span class=\"doctag\">@param</span> offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰</div><div class=\"line\">27:      */</div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">commitOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> String clientHost, <span class=\"keyword\">final</span> String group, <span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"comment\">// topic@group</span></div><div class=\"line\"><span class=\"number\">30</span>:         String key = topic + TOPIC_GROUP_SEPARATOR + group;</div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"keyword\">this</span>.commitOffset(clientHost, key, queueId, offset);</div><div class=\"line\"><span class=\"number\">32</span>:     &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">35:      * æäº¤æ¶ˆè´¹è¿›åº¦</div><div class=\"line\">36:      *</div><div class=\"line\">37:      * <span class=\"doctag\">@param</span> clientHost æäº¤clientåœ°å€</div><div class=\"line\">38:      * <span class=\"doctag\">@param</span> key ä¸»é¢˜@æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\">39:      * <span class=\"doctag\">@param</span> queueId é˜Ÿåˆ—ç¼–å·</div><div class=\"line\">40:      * <span class=\"doctag\">@param</span> offset è¿›åº¦ï¼ˆé˜Ÿåˆ—ä½ç½®ï¼‰</div><div class=\"line\">41:      */</div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">commitOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> String clientHost, <span class=\"keyword\">final</span> String key, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> queueId, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">43</span>:         ConcurrentHashMap&lt;Integer, Long&gt; map = <span class=\"keyword\">this</span>.offsetTable.get(key);</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == map) &#123;</div><div class=\"line\"><span class=\"number\">45</span>:             map = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;(<span class=\"number\">32</span>);</div><div class=\"line\"><span class=\"number\">46</span>:             map.put(queueId, offset);</div><div class=\"line\"><span class=\"number\">47</span>:             <span class=\"keyword\">this</span>.offsetTable.put(key, map);</div><div class=\"line\"><span class=\"number\">48</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">49</span>:             Long storeOffset = map.put(queueId, offset);</div><div class=\"line\"><span class=\"number\">50</span>:             <span class=\"keyword\">if</span> (storeOffset != <span class=\"keyword\">null</span> &amp;&amp; offset &lt; storeOffset) &#123;</div><div class=\"line\"><span class=\"number\">51</span>:                 log.warn(<span class=\"string\">\"[NOTIFYME]update consumer offset less than store. clientHost=&#123;&#125;, key=&#123;&#125;, queueId=&#123;&#125;, requestOffset=&#123;&#125;, storeOffset=&#123;&#125;\"</span>, clientHost, key, queueId, offset, storeOffset);</div><div class=\"line\"><span class=\"number\">52</span>:             &#125;</div><div class=\"line\"><span class=\"number\">53</span>:         &#125;</div><div class=\"line\"><span class=\"number\">54</span>:     &#125;</div><div class=\"line\"><span class=\"number\">55</span>: </div><div class=\"line\"><span class=\"number\">56</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">encode</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">57</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.encode(<span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">58</span>:     &#125;</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">61</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">configFilePath</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">62</span>:         <span class=\"keyword\">return</span> BrokerPathConfigHelper.getConsumerOffsetPath(<span class=\"keyword\">this</span>.brokerController.getMessageStoreConfig().getStorePathRootDir());</div><div class=\"line\"><span class=\"number\">63</span>:     &#125;</div><div class=\"line\"><span class=\"number\">64</span>: </div><div class=\"line\"><span class=\"number\">65</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">66:      * è§£ç å†…å®¹</div><div class=\"line\">67:      * æ ¼å¼:JSON</div><div class=\"line\">68:      *</div><div class=\"line\">69:      * <span class=\"doctag\">@param</span> jsonString å†…å®¹</div><div class=\"line\">70:      */</div><div class=\"line\"><span class=\"number\">71</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">72</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">decode</span><span class=\"params\">(String jsonString)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">73</span>:         <span class=\"keyword\">if</span> (jsonString != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">74</span>:             ConsumerOffsetManager obj = RemotingSerializable.fromJson(jsonString, ConsumerOffsetManager.class);</div><div class=\"line\"><span class=\"number\">75</span>:             <span class=\"keyword\">if</span> (obj != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">76</span>:                 <span class=\"keyword\">this</span>.offsetTable = obj.offsetTable;</div><div class=\"line\"><span class=\"number\">77</span>:             &#125;</div><div class=\"line\"><span class=\"number\">78</span>:         &#125;</div><div class=\"line\"><span class=\"number\">79</span>:     &#125;</div><div class=\"line\"><span class=\"number\">80</span>: </div><div class=\"line\"><span class=\"number\">81</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">82:      * ç¼–ç å†…å®¹</div><div class=\"line\">83:      * æ ¼å¼ä¸ºJSON</div><div class=\"line\">84:      *</div><div class=\"line\">85:      * <span class=\"doctag\">@param</span> prettyFormat æ˜¯å¦æ ¼å¼åŒ–</div><div class=\"line\">86:      * <span class=\"doctag\">@return</span> ç¼–ç åçš„å†…å®¹</div><div class=\"line\">87:      */</div><div class=\"line\"><span class=\"number\">88</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">encode</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> prettyFormat)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">89</span>:         <span class=\"keyword\">return</span> RemotingSerializable.toJson(<span class=\"keyword\">this</span>, prettyFormat);</div><div class=\"line\"><span class=\"number\">90</span>:     &#125;</div><div class=\"line\"><span class=\"number\">91</span>: </div><div class=\"line\"><span class=\"number\">92</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ¶ˆè´¹è¿›åº¦ç®¡ç†å™¨ã€‚</li>\n</ul>\n<h1>6ã€Broker æä¾›[å‘å›æ¶ˆæ¯]æ¥å£</h1>\n<p>å¤§éƒ¨åˆ†é€»è¾‘å’Œ <a href=\"http://www.yunai.me/RocketMQ/message-send-and-receive/#3%E3%80%81Broker-%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF\"><code>Broker</code> æä¾›[æ¥æ”¶æ¶ˆæ¯]æ¥å£</a> ç±»ä¼¼ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ç›¸å…³å†…å®¹ã€‚</p>\n<h2>SendMessageProcessor#consumerSendMsgBack(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> RemotingCommand <span class=\"title\">consumerSendMsgBack</span><span class=\"params\">(<span class=\"keyword\">final</span> ChannelHandlerContext ctx, <span class=\"keyword\">final</span> RemotingCommand request)</span></span></div><div class=\"line\">  2:     <span class=\"keyword\">throws</span> RemotingCommandException &#123;</div><div class=\"line\">  <span class=\"number\">3</span>: </div><div class=\"line\">  <span class=\"number\">4</span>:     <span class=\"comment\">// åˆå§‹åŒ–å“åº”</span></div><div class=\"line\">  <span class=\"number\">5</span>:     <span class=\"keyword\">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class=\"keyword\">null</span>);</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">final</span> ConsumerSendMsgBackRequestHeader requestHeader =</div><div class=\"line\">  <span class=\"number\">7</span>:         (ConsumerSendMsgBackRequestHeader) request.decodeCommandCustomHeader(ConsumerSendMsgBackRequestHeader.class);</div><div class=\"line\">  <span class=\"number\">8</span>: </div><div class=\"line\">  <span class=\"number\">9</span>:     <span class=\"comment\">// hookï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasConsumeMessageHook() &amp;&amp; !UtilAll.isBlank(requestHeader.getOriginMsgId())) &#123;</div><div class=\"line\"> <span class=\"number\">11</span>: </div><div class=\"line\"> <span class=\"number\">12</span>:         ConsumeMessageContext context = <span class=\"keyword\">new</span> ConsumeMessageContext();</div><div class=\"line\"> <span class=\"number\">13</span>:         context.setConsumerGroup(requestHeader.getGroup());</div><div class=\"line\"> <span class=\"number\">14</span>:         context.setTopic(requestHeader.getOriginTopic());</div><div class=\"line\"> <span class=\"number\">15</span>:         context.setCommercialRcvStats(BrokerStatsManager.StatsType.SEND_BACK);</div><div class=\"line\"> <span class=\"number\">16</span>:         context.setCommercialRcvTimes(<span class=\"number\">1</span>);</div><div class=\"line\"> <span class=\"number\">17</span>:         context.setCommercialOwner(request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER));</div><div class=\"line\"> <span class=\"number\">18</span>: </div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"keyword\">this</span>.executeConsumeMessageHookAfter(context);</div><div class=\"line\"> <span class=\"number\">20</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">21</span>: </div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"comment\">// åˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">23</span>:     SubscriptionGroupConfig subscriptionGroupConfig =</div><div class=\"line\"> <span class=\"number\">24</span>:         <span class=\"keyword\">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getGroup());</div><div class=\"line\"> <span class=\"number\">25</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionGroupConfig) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class=\"line\"> <span class=\"number\">27</span>:         response.setRemark(<span class=\"string\">\"subscription group not exist, \"</span> + requestHeader.getGroup() + <span class=\"string\">\" \"</span></div><div class=\"line\"> <span class=\"number\">28</span>:             + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</div><div class=\"line\"> <span class=\"number\">29</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">30</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">31</span>: </div><div class=\"line\"> <span class=\"number\">32</span>:     <span class=\"comment\">// æ£€æŸ¥ broker æ˜¯å¦æœ‰å†™å…¥æƒé™</span></div><div class=\"line\"> <span class=\"number\">33</span>:     <span class=\"keyword\">if</span> (!PermName.isWriteable(<span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</div><div class=\"line\"> <span class=\"number\">34</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">35</span>:         response.setRemark(<span class=\"string\">\"the broker[\"</span> + <span class=\"keyword\">this</span>.brokerController.getBrokerConfig().getBrokerIP1() + <span class=\"string\">\"] sending message is forbidden\"</span>);</div><div class=\"line\"> <span class=\"number\">36</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">37</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">38</span>: </div><div class=\"line\"> <span class=\"number\">39</span>:     <span class=\"comment\">// æ£€æŸ¥ é‡è¯•é˜Ÿåˆ—æ•° æ˜¯å¦å¤§äº0ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">40</span>:     <span class=\"keyword\">if</span> (subscriptionGroupConfig.getRetryQueueNums() &lt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">41</span>:         response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"> <span class=\"number\">42</span>:         response.setRemark(<span class=\"keyword\">null</span>);</div><div class=\"line\"> <span class=\"number\">43</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">44</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">45</span>: </div><div class=\"line\"> <span class=\"number\">46</span>:     <span class=\"comment\">// è®¡ç®—retry Topic</span></div><div class=\"line\"> <span class=\"number\">47</span>:     String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());</div><div class=\"line\"> <span class=\"number\">48</span>: </div><div class=\"line\"> <span class=\"number\">49</span>:     <span class=\"comment\">// è®¡ç®—é˜Ÿåˆ—ç¼–å·ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">50</span>:     <span class=\"keyword\">int</span> queueIdInt = Math.abs(<span class=\"keyword\">this</span>.random.nextInt() % <span class=\"number\">99999999</span>) % subscriptionGroupConfig.getRetryQueueNums();</div><div class=\"line\"> <span class=\"number\">51</span>: </div><div class=\"line\"> <span class=\"number\">52</span>:     <span class=\"comment\">// è®¡ç®—sysFlagï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">53</span>:     <span class=\"keyword\">int</span> topicSysFlag = <span class=\"number\">0</span>;</div><div class=\"line\"> <span class=\"number\">54</span>:     <span class=\"keyword\">if</span> (requestHeader.isUnitMode()) &#123;</div><div class=\"line\"> <span class=\"number\">55</span>:         topicSysFlag = TopicSysFlag.buildSysFlag(<span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">56</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:     <span class=\"comment\">// è·å–topicConfigã€‚å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è¿›è¡Œåˆ›å»º</span></div><div class=\"line\"> <span class=\"number\">59</span>:     TopicConfig topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">60</span>:         newTopic, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">61</span>:         subscriptionGroupConfig.getRetryQueueNums(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">62</span>:         PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);</div><div class=\"line\"> <span class=\"number\">63</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123; <span class=\"comment\">// æ²¡æœ‰é…ç½®</span></div><div class=\"line\"> <span class=\"number\">64</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">65</span>:         response.setRemark(<span class=\"string\">\"topic[\"</span> + newTopic + <span class=\"string\">\"] not exist\"</span>);</div><div class=\"line\"> <span class=\"number\">66</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">67</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">68</span>:     <span class=\"keyword\">if</span> (!PermName.isWriteable(topicConfig.getPerm())) &#123; <span class=\"comment\">// ä¸å…è®¸å†™å…¥</span></div><div class=\"line\"> <span class=\"number\">69</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class=\"line\"> <span class=\"number\">70</span>:         response.setRemark(String.format(<span class=\"string\">\"the topic[%s] sending message is forbidden\"</span>, newTopic));</div><div class=\"line\"> <span class=\"number\">71</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">72</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">73</span>: </div><div class=\"line\"> <span class=\"number\">74</span>:     <span class=\"comment\">// æŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">75</span>:     MessageExt msgExt = <span class=\"keyword\">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());</div><div class=\"line\"> <span class=\"number\">76</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == msgExt) &#123;</div><div class=\"line\"> <span class=\"number\">77</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"> <span class=\"number\">78</span>:         response.setRemark(<span class=\"string\">\"look message by offset failed, \"</span> + requestHeader.getOffset());</div><div class=\"line\"> <span class=\"number\">79</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"> <span class=\"number\">80</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">81</span>: </div><div class=\"line\"> <span class=\"number\">82</span>:     <span class=\"comment\">// è®¾ç½®retryTopicåˆ°æ‹“å±•å±æ€§ï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"> <span class=\"number\">83</span>:     <span class=\"keyword\">final</span> String retryTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class=\"line\"> <span class=\"number\">84</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == retryTopic) &#123;</div><div class=\"line\"> <span class=\"number\">85</span>:         MessageAccessor.putProperty(msgExt, MessageConst.PROPERTY_RETRY_TOPIC, msgExt.getTopic());</div><div class=\"line\"> <span class=\"number\">86</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">87</span>: </div><div class=\"line\"> <span class=\"number\">88</span>:     <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆï¼ˆç‹¬æœ‰ï¼‰ TODO ç–‘é—®ï¼šå¦‚æœè®¾ç½®æˆä¸ç­‰å¾…å­˜å‚¨ï¼Œbrokerè®¾ç½®æˆåŒæ­¥è½ç›˜ï¼Œå²‚ä¸æ˜¯ä¸èƒ½æ‰¹é‡æäº¤äº†ï¼Ÿ</span></div><div class=\"line\"> <span class=\"number\">89</span>:     msgExt.setWaitStoreMsgOK(<span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">90</span>: </div><div class=\"line\"> <span class=\"number\">91</span>:     <span class=\"comment\">// å¤„ç† delayLevelï¼ˆç‹¬æœ‰ï¼‰ã€‚</span></div><div class=\"line\"> <span class=\"number\">92</span>:     <span class=\"keyword\">int</span> delayLevel = requestHeader.getDelayLevel();</div><div class=\"line\"> <span class=\"number\">93</span>:     <span class=\"keyword\">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class=\"line\"> <span class=\"number\">94</span>:     <span class=\"keyword\">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</div><div class=\"line\"> <span class=\"number\">95</span>:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class=\"line\"> <span class=\"number\">96</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">97</span>:     <span class=\"keyword\">if</span> (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">98</span>:         || delayLevel &lt; <span class=\"number\">0</span>) &#123; <span class=\"comment\">// å¦‚æœè¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°ï¼Œåˆ™topicä¿®æ”¹æˆ\"%DLQ%\" + åˆ†ç»„åï¼Œå³åŠ å…¥ æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)</span></div><div class=\"line\"> <span class=\"number\">99</span>:         newTopic = MixAll.getDLQTopic(requestHeader.getGroup());</div><div class=\"line\"><span class=\"number\">100</span>:         queueIdInt = Math.abs(<span class=\"keyword\">this</span>.random.nextInt() % <span class=\"number\">99999999</span>) % DLQ_NUMS_PER_GROUP;</div><div class=\"line\"><span class=\"number\">101</span>: </div><div class=\"line\"><span class=\"number\">102</span>:         topicConfig = <span class=\"keyword\">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">103</span>:             DLQ_NUMS_PER_GROUP, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">104</span>:             PermName.PERM_WRITE, <span class=\"number\">0</span></div><div class=\"line\"><span class=\"number\">105</span>:         );</div><div class=\"line\"><span class=\"number\">106</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == topicConfig) &#123;</div><div class=\"line\"><span class=\"number\">107</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">108</span>:             response.setRemark(<span class=\"string\">\"topic[\"</span> + newTopic + <span class=\"string\">\"] not exist\"</span>);</div><div class=\"line\"><span class=\"number\">109</span>:             <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">110</span>:         &#125;</div><div class=\"line\"><span class=\"number\">111</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">112</span>:         <span class=\"keyword\">if</span> (<span class=\"number\">0</span> == delayLevel) &#123;</div><div class=\"line\"><span class=\"number\">113</span>:             delayLevel = <span class=\"number\">3</span> + msgExt.getReconsumeTimes();</div><div class=\"line\"><span class=\"number\">114</span>:         &#125;</div><div class=\"line\"><span class=\"number\">115</span>:         msgExt.setDelayTimeLevel(delayLevel);</div><div class=\"line\"><span class=\"number\">116</span>:     &#125;</div><div class=\"line\"><span class=\"number\">117</span>: </div><div class=\"line\"><span class=\"number\">118</span>:     <span class=\"comment\">// åˆ›å»ºMessageExtBrokerInner</span></div><div class=\"line\"><span class=\"number\">119</span>:     MessageExtBrokerInner msgInner = <span class=\"keyword\">new</span> MessageExtBrokerInner();</div><div class=\"line\"><span class=\"number\">120</span>:     msgInner.setTopic(newTopic);</div><div class=\"line\"><span class=\"number\">121</span>:     msgInner.setBody(msgExt.getBody());</div><div class=\"line\"><span class=\"number\">122</span>:     msgInner.setFlag(msgExt.getFlag());</div><div class=\"line\"><span class=\"number\">123</span>:     MessageAccessor.setProperties(msgInner, msgExt.getProperties());</div><div class=\"line\"><span class=\"number\">124</span>:     msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</div><div class=\"line\"><span class=\"number\">125</span>:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(<span class=\"keyword\">null</span>, msgExt.getTags()));</div><div class=\"line\"><span class=\"number\">126</span>:     msgInner.setQueueId(queueIdInt);</div><div class=\"line\"><span class=\"number\">127</span>:     msgInner.setSysFlag(msgExt.getSysFlag());</div><div class=\"line\"><span class=\"number\">128</span>:     msgInner.setBornTimestamp(msgExt.getBornTimestamp());</div><div class=\"line\"><span class=\"number\">129</span>:     msgInner.setBornHost(msgExt.getBornHost());</div><div class=\"line\"><span class=\"number\">130</span>:     msgInner.setStoreHost(<span class=\"keyword\">this</span>.getStoreHost());</div><div class=\"line\"><span class=\"number\">131</span>:     msgInner.setReconsumeTimes(msgExt.getReconsumeTimes() + <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">132</span>: </div><div class=\"line\"><span class=\"number\">133</span>:     <span class=\"comment\">// è®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å­—æ®µï¼ˆç‹¬æœ‰ï¼‰</span></div><div class=\"line\"><span class=\"number\">134</span>:     String originMsgId = MessageAccessor.getOriginMessageId(msgExt);</div><div class=\"line\"><span class=\"number\">135</span>:     MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);</div><div class=\"line\"><span class=\"number\">136</span>: </div><div class=\"line\"><span class=\"number\">137</span>:     <span class=\"comment\">// æ·»åŠ æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">138</span>:     PutMessageResult putMessageResult = <span class=\"keyword\">this</span>.brokerController.getMessageStore().putMessage(msgInner);</div><div class=\"line\"><span class=\"number\">139</span>:     <span class=\"keyword\">if</span> (putMessageResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">140</span>:         <span class=\"keyword\">switch</span> (putMessageResult.getPutMessageStatus()) &#123;</div><div class=\"line\"><span class=\"number\">141</span>:             <span class=\"keyword\">case</span> PUT_OK:</div><div class=\"line\"><span class=\"number\">142</span>:                 String backTopic = msgExt.getTopic();</div><div class=\"line\"><span class=\"number\">143</span>:                 String correctTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class=\"line\"><span class=\"number\">144</span>:                 <span class=\"keyword\">if</span> (correctTopic != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">145</span>:                     backTopic = correctTopic;</div><div class=\"line\"><span class=\"number\">146</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">147</span>: </div><div class=\"line\"><span class=\"number\">148</span>:                 <span class=\"keyword\">this</span>.brokerController.getBrokerStatsManager().incSendBackNums(requestHeader.getGroup(), backTopic);</div><div class=\"line\"><span class=\"number\">149</span>: </div><div class=\"line\"><span class=\"number\">150</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class=\"line\"><span class=\"number\">151</span>:                 response.setRemark(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">152</span>: </div><div class=\"line\"><span class=\"number\">153</span>:                 <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">154</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">155</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">156</span>:         &#125;</div><div class=\"line\"><span class=\"number\">157</span>: </div><div class=\"line\"><span class=\"number\">158</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">159</span>:         response.setRemark(putMessageResult.getPutMessageStatus().name());</div><div class=\"line\"><span class=\"number\">160</span>:         <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">161</span>:     &#125;</div><div class=\"line\"><span class=\"number\">162</span>: </div><div class=\"line\"><span class=\"number\">163</span>:     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class=\"line\"><span class=\"number\">164</span>:     response.setRemark(<span class=\"string\">\"putMessageResult is null\"</span>);</div><div class=\"line\"><span class=\"number\">165</span>:     <span class=\"keyword\">return</span> response;</div><div class=\"line\"><span class=\"number\">166</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå½“ <code>Consumer</code> æ¶ˆè´¹æŸæ¡æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ¥å£å‘å›æ¶ˆæ¯ã€‚<code>Broker</code> ä¼šå­˜å‚¨å‘å›çš„æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œä¸‹æ¬¡ <code>Consumer</code> æ‹‰å–è¯¥æ¶ˆæ¯ï¼Œèƒ½å¤Ÿä» <code>CommitLog</code> å’Œ <code>ConsumeQueue</code> é¡ºåºè¯»å–ã€‚</li>\n<li>[x] å› ä¸ºå¤§å¤šæ•°é€»è¾‘å’Œ <strong><code>Broker</code> æ¥æ”¶æ™®é€šæ¶ˆæ¯</strong> å¾ˆç›¸ä¼¼ï¼Œæ—¶å€™ <code>TODO</code> æ ‡è®°æˆç‹¬æœ‰çš„é€»è¾‘ã€‚</li>\n<li>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šåˆå§‹åŒ–å“åº”ã€‚</li>\n<li>[x] ç¬¬ 9 è‡³ 20 è¡Œ ï¼šHooké€»è¾‘ã€‚</li>\n<li>[x] ç¬¬22 è‡³ 30 è¡Œ ï¼šåˆ¤æ–­æ¶ˆè´¹åˆ†ç»„æ˜¯å¦å­˜åœ¨ã€‚</li>\n<li>ç¬¬ 32 è‡³ 37 è¡Œ ï¼šæ£€æŸ¥ <code>Broker</code> æ˜¯å¦æœ‰å†™å…¥æƒé™ã€‚</li>\n<li>[x] ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæ£€æŸ¥é‡è¯•é˜Ÿåˆ—æ•°æ˜¯å¦å¤§äº0ã€‚</li>\n<li>ç¬¬ 47 è¡Œ ï¼šè®¡ç®— retry topicã€‚</li>\n<li>[x] ç¬¬ 50 è¡Œ ï¼šéšæœºåˆ†é…é˜Ÿåˆ—ç¼–å·ï¼Œä¾èµ– <code>retryQueueNums</code>ã€‚</li>\n<li>[x] ç¬¬ 52 è‡³ 56 è¡Œ ï¼šè®¡ç®— <code>sysFlag</code>ã€‚</li>\n<li>ç¬¬ 58 è‡³ 72 è¡Œ ï¼šè·å– <code>TopicConfig</code>ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚</li>\n<li>[x] ç¬¬ 74 è‡³ 80 è¡Œ ï¼šæŸ¥è¯¢æ¶ˆæ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›å¼‚å¸¸é”™è¯¯ã€‚</li>\n<li>[x] ç¬¬ 82 è‡³ 86 è¡Œ ï¼šè®¾ç½® <code>retryTopic</code> åˆ°æ¶ˆæ¯æ‹“å±•å±æ€§ã€‚</li>\n<li>[x] ç¬¬ 89 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯ä¸ç­‰å¾…å­˜å‚¨å®Œæˆã€‚\n<ul>\n<li>å½“ <code>Broker</code> åˆ·ç›˜æ–¹å¼ä¸ºåŒæ­¥ï¼Œä¼šå¯¼è‡´åŒæ­¥è½ç›˜ä¸èƒ½æ‰¹é‡æäº¤ï¼Œè¿™æ ·ä¼šä¸ä¼šå­˜åœ¨é—®é¢˜ï¼Ÿæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚ğŸ˜ˆã€‚</li>\n</ul>\n</li>\n<li>[x] ç¬¬ 91 è‡³ 116 è¡Œ ï¼šå¤„ç† <code>delayLevel</code> ã€‚</li>\n<li>ç¬¬ 118 è‡³ 131 è¡Œ ï¼šåˆ›å»º <code>MessageExtBrokerInner</code> ã€‚</li>\n<li>[x] ç¬¬ 133 è‡³ 135 è¡Œ ï¼šè®¾ç½®åŸå§‹æ¶ˆæ¯ç¼–å·åˆ°æ‹“å±•å±æ€§ã€‚</li>\n<li>ç¬¬ 137 è‡³ 161 è¡Œ ï¼šæ·»åŠ æ¶ˆæ¯ã€‚</li>\n</ul>\n<h1>7ã€ç»“å°¾</h1>\n<p>æ„Ÿè°¢åŒå­¦ä»¬å¯¹æœ¬æ–‡çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€‚</p>\n<p>ğŸ˜ˆå¦‚æœè§£æå­˜åœ¨é—®é¢˜æˆ–è€…è¡¨è¾¾è¯¯è§£çš„ï¼Œè¡¨ç¤ºæŠ±æ­‰ã€‚å¦‚æœæ–¹ä¾¿çš„è¯ï¼Œå¯ä»¥åŠ ä¸‹ <strong>QQï¼š7685413</strong>ã€‚è®©æˆ‘ä»¬æ¥ä¸€åœº 1 ï¼š1 äº¤æµï¼ˆæåŸºï¼‰ã€‚</p>\n<p>å†æ¬¡è¡¨ç¤ºååˆ†æ„Ÿè°¢ã€‚</p>\n"},{"title":"RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰","date":"2017-05-10T16:00:00.000Z","_content":"\n>  åŸæ–‡åœ°å€ï¼š[http://www.yunai.me/RocketMQ/message-pull-and-consume-second/](http://www.yunai.me/RocketMQ/message-pull-and-consume-second/)  \n> `RocketMQ` **å¸¦æ³¨é‡Šæºç **åœ°å€ ï¼š[https://github.com/YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **  \n\n![wechat_mp](http://www.yunai.me/images/common/wechat_mp.jpeg)\n\n-------\n\n- [1ã€æ¦‚è¿°](#)\n- [2ã€Consumer](#)\n- [3ã€PushConsumer ä¸€è§ˆ](#)\n- [4ã€PushConsumer è®¢é˜…](#)\n\t- [DefaultMQPushConsumerImpl#subscribe(...)](#)\n\t\t- [FilterAPI.buildSubscriptionData(...)](#)\n\t- [DefaultMQPushConsumer#registerMessageListener(...)](#)\n- [5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…](#)\n\t- [RebalanceService](#)\n\t- [MQClientInstance#doRebalance(...)](#)\n\t- [DefaultMQPushConsumerImpl#doRebalance(...)](#)\n\t- [RebalanceImpl#doRebalance(...)](#)\n\t\t- [RebalanceImpl#rebalanceByTopic(...)](#)\n\t\t- [RebalanceImpl#removeUnnecessaryMessageQueue(...)](#)\n\t\t\t- [RebalancePushImpl#removeUnnecessaryMessageQueue(...)](#)\n\t\t\t- [[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(...)](#)\n\t\t- [RebalancePushImpl#dispatchPullRequest(...)](#)\n\t\t\t- [DefaultMQPushConsumerImpl#executePullRequestImmediately(...)](#)\n\t\t- [AllocateMessageQueueStrategy](#)\n\t\t\t- [AllocateMessageQueueAveragely](#)\n\t\t\t- [AllocateMessageQueueByMachineRoom](#)\n\t\t\t- [AllocateMessageQueueAveragelyByCircle](#)\n\t\t\t- [AllocateMessageQueueByConfig](#)\n- [5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–](#)\n\t- [RebalancePushImpl#computePullFromWhere(...)](#)\n\t- [[PullConsumer] RebalancePullImpl#computePullFromWhere(...)](#)\n- [6ã€PushConsumer æ‹‰å–æ¶ˆæ¯](#)\n\t- [PullMessageService](#)\n\t- [DefaultMQPushConsumerImpl#pullMessage(...)](#)\n\t\t- [PullAPIWrapper#pullKernelImpl(...)](#)\n\t\t\t- [PullAPIWrapper#recalculatePullFromWhichNode(...)](#)\n\t\t\t- [MQClientInstance#findBrokerAddressInSubscribe(...)](#)\n\t\t- [PullAPIWrapper#processPullResult(...)](#)\n\t\t- [ProcessQueue#putMessage(...)](#)\n\t- [æ€»ç»“](#)\n- [6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯](#)\n\t- [ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚](#)\n\t\t- [ConsumeMessageConcurrentlyService#submitConsumeRequest(...)](#)\n\t\t- [ConsumeMessageConcurrentlyService#submitConsumeRequestLater](#)\n\t- [ConsumeRequest](#)\n\t- [ConsumeMessageConcurrentlyService#processConsumeResult(...)](#)\n\t\t- [ProcessQueue#removeMessage(...)](#)\n\t- [ConsumeMessageConcurrentlyService#cleanExpireMsg(...)](#)\n\t\t- [ProcessQueue#cleanExpiredMsg(...)](#)\n- [7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯](#)\n\t- [DefaultMQPushConsumerImpl#sendMessageBack(...)](#)\n\t\t- [MQClientAPIImpl#consumerSendMessageBack(...)](#)\n- [8ã€Consumer æ¶ˆè´¹è¿›åº¦](#)\n\t- [OffsetStore](#)\n\t\t- [OffsetStore#load(...)](#)\n\t\t\t- [LocalFileOffsetStore#load(...)](#)\n\t\t\t\t- [OffsetSerializeWrapper](#)\n\t\t\t- [RemoteBrokerOffsetStore#load(...)](#)\n\t\t- [OffsetStore#readOffset(...)](#)\n\t\t\t- [LocalFileOffsetStore#readOffset(...)](#)\n\t\t\t- [RemoteBrokerOffsetStore#readOffset(...)](#)\n\t\t- [OffsetStore#updateOffset(...)](#)\n\t\t- [OffsetStore#persistAll(...)](#)\n\t\t\t- [LocalFileOffsetStore#persistAll(...)](#)\n\t\t\t- [RemoteBrokerOffsetStore#persistAll(...)](#)\n\t\t\t- [MQClientInstance#persistAllConsumerOffset(...)](#)\n- [9ã€ç»“å°¾](#)\n\n-------\n\n# 1ã€æ¦‚è¿°\n\næœ¬æ–‡æ¥ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ã€‹](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/)ã€‚\n\nä¸»è¦è§£æ `Consumer` åœ¨ **æ¶ˆè´¹** é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚\n\n# 2ã€Consumer\n\nMQ æä¾›äº†ä¸¤ç±»æ¶ˆè´¹è€…ï¼š\n\n* PushConsumerï¼š\n    * åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ä½¿ç”¨ã€‚\n    * åå­—è™½ç„¶æ˜¯ `Push` å¼€å¤´ï¼Œå®é™…åœ¨å®ç°æ—¶ï¼Œä½¿ç”¨ `Pull` æ–¹å¼å®ç°ã€‚é€šè¿‡ `Pull` **ä¸æ–­ä¸æ–­ä¸æ–­**è½®è¯¢ `Broker` è·å–æ¶ˆæ¯ã€‚å½“ä¸å­˜åœ¨æ–°æ¶ˆæ¯æ—¶ï¼Œ`Broker` ä¼š**æŒ‚èµ·è¯·æ±‚**ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯äº§ç”Ÿï¼Œå–æ¶ˆæŒ‚èµ·ï¼Œè¿”å›æ–°æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒåŸºæœ¬å’Œ `Broker` ä¸»åŠ¨ `Push` åšåˆ°**æ¥è¿‘**çš„å®æ—¶æ€§ï¼ˆå½“ç„¶ï¼Œè¿˜æ˜¯æœ‰ç›¸åº”çš„å®æ—¶æ€§æŸå¤±ï¼‰ã€‚åŸç†ç±»ä¼¼ **[é•¿è½®è¯¢( `Long-Polling` )](https://www.ibm.com/developerworks/cn/web/wa-lo-comet/)**ã€‚\n* PullConsumer\n\n**æœ¬æ–‡ä¸»è¦è®²è§£`PushConsumer`ï¼Œéƒ¨åˆ†è®²è§£`PullConsumer`ï¼Œè·³è¿‡`é¡ºåºæ¶ˆè´¹`ã€‚**  \n**æœ¬æ–‡ä¸»è¦è®²è§£`PushConsumer`ï¼Œéƒ¨åˆ†è®²è§£`PullConsumer`ï¼Œè·³è¿‡`é¡ºåºæ¶ˆè´¹`ã€‚**  \n**æœ¬æ–‡ä¸»è¦è®²è§£`PushConsumer`ï¼Œéƒ¨åˆ†è®²è§£`PullConsumer`ï¼Œè·³è¿‡`é¡ºåºæ¶ˆè´¹`ã€‚**  \n\n# 3ã€PushConsumer ä¸€è§ˆ\n\nå…ˆçœ‹ä¸€å¼  `PushConsumer` åŒ…å«çš„ç»„ä»¶ä»¥åŠç»„ä»¶ä¹‹é—´çš„äº¤äº’å›¾ï¼š\n\n![PushConsumeræ‰‹ç»˜å›¾.png](http://www.yunai.me/images/RocketMQ/2017_05_04/09.png)\n\n* `RebalanceService`ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ `Consumer` å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( `MessageQueue` )ã€‚å½“æœ‰æ–°çš„ `Consumer` çš„åŠ å…¥æˆ–ç§»é™¤ï¼Œéƒ½ä¼šé‡æ–°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* `PullMessageService`ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œ**ä¸æ–­ä¸æ–­ä¸æ–­**ä» `Broker` æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° `ConsumeMessageService`ã€‚\n* `ConsumeMessageService`ï¼šæ¶ˆè´¹æ¶ˆæ¯æœåŠ¡ï¼Œ**ä¸æ–­ä¸æ–­ä¸æ–­**æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å¤„ç†æ¶ˆè´¹ç»“æœã€‚\n* `RemoteBrokerOffsetStore`ï¼š`Consumer` æ¶ˆè´¹è¿›åº¦ç®¡ç†ï¼Œè´Ÿè´£ä» `Broker` è·å–æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° `Broker`ã€‚\n* `ProcessQueue` ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚\n* `MQClientInstance` ï¼šå°è£…å¯¹ `Namesrv`ï¼Œ`Broker` çš„ APIè°ƒç”¨ï¼Œæä¾›ç»™ `Producer`ã€`Consumer` ä½¿ç”¨ã€‚\n\n# 4ã€PushConsumer è®¢é˜…\n\n## DefaultMQPushConsumerImpl#subscribe(...)\n\n```Java\n  1: public void subscribe(String topic, String subExpression) throws MQClientException {\n  2:     try {\n  3:         // åˆ›å»ºè®¢é˜…æ•°æ®\n  4:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(this.defaultMQPushConsumer.getConsumerGroup(), //\n  5:             topic, subExpression);\n  6:         this.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);\n  7:         // é€šè¿‡å¿ƒè·³åŒæ­¥Consumerä¿¡æ¯åˆ°Broker\n  8:         if (this.mQClientFactory != null) {\n  9:             this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();\n 10:         }\n 11:     } catch (Exception e) {\n 12:         throw new MQClientException(\"subscription exception\", e);\n 13:     }\n 14: }\n```\n\n* è¯´æ˜ ï¼šè®¢é˜… `Topic` ã€‚\n* ç¬¬ 3 è‡³ 6 è¡Œ ï¼šåˆ›å»ºè®¢é˜…æ•°æ®ã€‚è¯¦ç»†è§£æè§ï¼š[FilterAPI.buildSubscriptionData(...)](#filterapibuildsubscriptiondata)ã€‚\n* ç¬¬ 7 è‡³ 10 è¡Œ ï¼šé€šè¿‡å¿ƒè·³åŒæ­¥ `Consumer` ä¿¡æ¯åˆ° `Broker`ã€‚\n\n### FilterAPI.buildSubscriptionData(...)\n\n```Java\n  1: public static SubscriptionData buildSubscriptionData(final String consumerGroup, String topic,\n  2:     String subString) throws Exception {\n  3:     SubscriptionData subscriptionData = new SubscriptionData();\n  4:     subscriptionData.setTopic(topic);\n  5:     subscriptionData.setSubString(subString);\n  6:     // å¤„ç†è®¢é˜…è¡¨è¾¾å¼\n  7:     if (null == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == 0) {\n  8:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);\n  9:     } else {\n 10:         String[] tags = subString.split(\"\\\\|\\\\|\");\n 11:         if (tags.length > 0) {\n 12:             for (String tag : tags) {\n 13:                 if (tag.length() > 0) {\n 14:                     String trimString = tag.trim();\n 15:                     if (trimString.length() > 0) {\n 16:                         subscriptionData.getTagsSet().add(trimString);\n 17:                         subscriptionData.getCodeSet().add(trimString.hashCode());\n 18:                     }\n 19:                 }\n 20:             }\n 21:         } else {\n 22:             throw new Exception(\"subString split error\");\n 23:         }\n 24:     }\n 25: \n 26:     return subscriptionData;\n 27: }\n```\n\n* è¯´æ˜ ï¼šæ ¹æ® `Topic` å’Œ è®¢é˜…è¡¨è¾¾å¼ åˆ›å»ºè®¢é˜…æ•°æ®\n* subscriptionData.subVersion = System.currentTimeMillis()ã€‚\n\n## DefaultMQPushConsumer#registerMessageListener(...)\n\n```Java\n  1: public void registerMessageListener(MessageListenerConcurrently messageListener) {\n  2:     this.messageListener = messageListener;\n  3:     this.defaultMQPushConsumerImpl.registerMessageListener(messageListener);\n  4: }\n```\n\n* è¯´æ˜ ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ã€‚\n\n# 5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…\n\n![RebalanceService&PushConsumeråˆ†é…é˜Ÿåˆ—](http://www.yunai.me/images/RocketMQ/2017_05_04/10.png)\n\n## RebalanceService\n\n```Java\n  1: public class RebalanceService extends ServiceThread {\n  2: \n  3:     /**\n  4:      * ç­‰å¾…é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’\n  5:      */\n  6:     private static long waitInterval =\n  7:         Long.parseLong(System.getProperty(\n  8:             \"rocketmq.client.rebalance.waitInterval\", \"20000\"));\n  9: \n 10:     private final Logger log = ClientLogger.getLog();\n 11:     /**\n 12:      * MQClientå¯¹è±¡\n 13:      */\n 14:     private final MQClientInstance mqClientFactory;\n 15: \n 16:     public RebalanceService(MQClientInstance mqClientFactory) {\n 17:         this.mqClientFactory = mqClientFactory;\n 18:     }\n 19: \n 20:     @Override\n 21:     public void run() {\n 22:         log.info(this.getServiceName() + \" service started\");\n 23: \n 24:         while (!this.isStopped()) {\n 25:             this.waitForRunning(waitInterval);\n 26:             this.mqClientFactory.doRebalance();\n 27:         }\n 28: \n 29:         log.info(this.getServiceName() + \" service end\");\n 30:     }\n 31: \n 32:     @Override\n 33:     public String getServiceName() {\n 34:         return RebalanceService.class.getSimpleName();\n 35:     }\n 36: }\n```\n\n* è¯´æ˜ ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ `Consumer` å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( `MessageQueue` )ã€‚\n* ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ `MQClientInstance#doRebalance(...)` åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç›®å‰æœ‰ä¸‰ç§æƒ…å†µæƒ…å†µä¸‹è§¦å‘ï¼š\n    * å¦‚ `ç¬¬ 25 è¡Œ` ç­‰å¾…è¶…æ—¶ï¼Œæ¯ 20s è°ƒç”¨ä¸€æ¬¡ã€‚\n    * `PushConsumer` å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ `rebalanceService#wakeup(...)` è§¦å‘ã€‚\n    * `Broker` é€šçŸ¥ `Consumer` åŠ å…¥ æˆ– ç§»é™¤æ—¶ï¼Œ`Consumer` å“åº”é€šçŸ¥ï¼Œè°ƒç”¨ `rebalanceService#wakeup(...)` è§¦å‘ã€‚\n\n è¯¦ç»†è§£æè§ï¼š[MQClientInstance#doRebalance(...)](#mqclientinstancedorebalance)ã€‚\n\n## MQClientInstance#doRebalance(...)\n\n```Java\n  1: public void doRebalance() {\n  2:     for (Map.Entry<String, MQConsumerInner> entry : this.consumerTable.entrySet()) {\n  3:         MQConsumerInner impl = entry.getValue();\n  4:         if (impl != null) {\n  5:             try {\n  6:                 impl.doRebalance();\n  7:             } catch (Throwable e) {\n  8:                 log.error(\"doRebalance exception\", e);\n  9:             }\n 10:         }\n 11:     }\n 12: }\n```\n\n* è¯´æ˜ ï¼šéå†å½“å‰ `Client` åŒ…å«çš„ `consumerTable`( `Consumer`é›†åˆ )ï¼Œæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚\n* **ç–‘é—®**ï¼šç›®å‰ä»£ç è°ƒè¯•ä¸‹æ¥ï¼Œ`consumerTable` åªåŒ…å« `Consumer` è‡ªå·±ã€‚ğŸ˜ˆæœ‰å¤§å¤§å¯¹è¿™ä¸ªç–‘é—®æœ‰è§£ç­”çš„ï¼Œçƒ¦è¯·è§£ç­”ä¸‹ã€‚\n* ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ `MQConsumerInner#doRebalance(...)` è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚`DefaultMQPushConsumerImpl`ã€`DefaultMQPullConsumerImpl` åˆ†åˆ«å¯¹è¯¥æ¥å£æ–¹æ³•è¿›è¡Œäº†å®ç°ã€‚`DefaultMQPushConsumerImpl#doRebalance(...)` è¯¦ç»†è§£æè§ï¼š[DefaultMQPushConsumerImpl#doRebalance(...)](defaultmqpushconsumerimpldorebalance)ã€‚\n\n## DefaultMQPushConsumerImpl#doRebalance(...)\n\n```Java\n  1: public void doRebalance() {\n  2:     if (!this.pause) {\n  3:         this.rebalanceImpl.doRebalance(this.isConsumeOrderly());\n  4:     }\n  5: }\n```\n\n* è¯´æ˜ï¼šæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚\n* ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ `RebalanceImpl#doRebalance(...)` è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚è¯¦ç»†è§£æè§ï¼š[RebalancePushImpl#doRebalance(...)](#rebalancepushimpldorebalance)ã€‚\n\n## RebalanceImpl#doRebalance(...)\n\n```Java\n  1: /**\n  2:  * æ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—\n  3:  *\n  4:  * @param isOrder æ˜¯å¦é¡ºåºæ¶ˆæ¯\n  5:  */\n  6: public void doRebalance(final boolean isOrder) {\n  7:     // åˆ†é…æ¯ä¸ª topic çš„æ¶ˆæ¯é˜Ÿåˆ—\n  8:     Map<String, SubscriptionData> subTable = this.getSubscriptionInner();\n  9:     if (subTable != null) {\n 10:         for (final Map.Entry<String, SubscriptionData> entry : subTable.entrySet()) {\n 11:             final String topic = entry.getKey();\n 12:             try {\n 13:                 this.rebalanceByTopic(topic, isOrder);\n 14:             } catch (Throwable e) {\n 15:                 if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 16:                     log.warn(\"rebalanceByTopic Exception\", e);\n 17:                 }\n 18:             }\n 19:         }\n 20:     }\n 21:     // ç§»é™¤æœªè®¢é˜…çš„topicå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—\n 22:     this.truncateMessageQueueNotMyTopic();\n 23: }\n 24: \n 25: /**\n 26:  * ç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—\n 27:  */\n 28: private void truncateMessageQueueNotMyTopic() {\n 29:     Map<String, SubscriptionData> subTable = this.getSubscriptionInner();\n 30:     for (MessageQueue mq : this.processQueueTable.keySet()) {\n 31:         if (!subTable.containsKey(mq.getTopic())) {\n 32: \n 33:             ProcessQueue pq = this.processQueueTable.remove(mq);\n 34:             if (pq != null) {\n 35:                 pq.setDropped(true);\n 36:                 log.info(\"doRebalance, {}, truncateMessageQueueNotMyTopic remove unnecessary mq, {}\", consumerGroup, mq);\n 37:             }\n 38:         }\n 39:     }\n 40: }\n```\n\n* `#doRebalance(...)` è¯´æ˜ ï¼šæ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 7 è‡³ 20 è¡Œ ï¼šå¾ªç¯è®¢é˜…ä¸»é¢˜é›†åˆ( `subscriptionInner` )ï¼Œåˆ†é…æ¯ä¸€ä¸ª `Topic` çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 22 è¡Œ ï¼šç§»é™¤æœªè®¢é˜…çš„ `Topic` çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* `#truncateMessageQueueNotMyTopic(...)` è¯´æ˜ ï¼šç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚**å½“è°ƒç”¨ `DefaultMQPushConsumer#unsubscribe(topic)` æ—¶ï¼Œåªç§»é™¤è®¢é˜…ä¸»é¢˜é›†åˆ( `subscriptionInner` )ï¼Œå¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—ç§»é™¤åœ¨è¯¥æ–¹æ³•ã€‚**\n\n### RebalanceImpl#rebalanceByTopic(...)\n\n```Java\n  1: private void rebalanceByTopic(final String topic, final boolean isOrder) {\n  2:     switch (messageModel) {\n  3:         case BROADCASTING: {\n  4:             Set<MessageQueue> mqSet = this.topicSubscribeInfoTable.get(topic);\n  5:             if (mqSet != null) {\n  6:                 boolean changed = this.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);\n  7:                 if (changed) {\n  8:                     this.messageQueueChanged(topic, mqSet, mqSet);\n  9:                     log.info(\"messageQueueChanged {} {} {} {}\", //\n 10:                         consumerGroup, //\n 11:                         topic, //\n 12:                         mqSet, //\n 13:                         mqSet);\n 14:                 }\n 15:             } else {\n 16:                 log.warn(\"doRebalance, {}, but the topic[{}] not exist.\", consumerGroup, topic);\n 17:             }\n 18:             break;\n 19:         }\n 20:         case CLUSTERING: {\n 21:             // è·å– topic å¯¹åº”çš„ é˜Ÿåˆ— å’Œ consumerä¿¡æ¯\n 22:             Set<MessageQueue> mqSet = this.topicSubscribeInfoTable.get(topic);\n 23:             List<String> cidAll = this.mQClientFactory.findConsumerIdList(topic, consumerGroup);\n 24:             if (null == mqSet) {\n 25:                 if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 26:                     log.warn(\"doRebalance, {}, but the topic[{}] not exist.\", consumerGroup, topic);\n 27:                 }\n 28:             }\n 29: \n 30:             if (null == cidAll) {\n 31:                 log.warn(\"doRebalance, {} {}, get consumer id list failed\", consumerGroup, topic);\n 32:             }\n 33: \n 34:             if (mqSet != null && cidAll != null) {\n 35:                 // æ’åº æ¶ˆæ¯é˜Ÿåˆ— å’Œ æ¶ˆè´¹è€…æ•°ç»„ã€‚å› ä¸ºæ˜¯åœ¨Clientè¿›è¡Œåˆ†é…é˜Ÿåˆ—ï¼Œæ’åºåï¼Œå„Clientçš„é¡ºåºæ‰èƒ½ä¿æŒä¸€è‡´ã€‚\n 36:                 List<MessageQueue> mqAll = new ArrayList<>();\n 37:                 mqAll.addAll(mqSet);\n 38: \n 39:                 Collections.sort(mqAll);\n 40:                 Collections.sort(cidAll);\n 41: \n 42:                 AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;\n 43: \n 44:                 // æ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥ åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—\n 45:                 List<MessageQueue> allocateResult;\n 46:                 try {\n 47:                     allocateResult = strategy.allocate(//\n 48:                         this.consumerGroup, //\n 49:                         this.mQClientFactory.getClientId(), //\n 50:                         mqAll, //\n 51:                         cidAll);\n 52:                 } catch (Throwable e) {\n 53:                     log.error(\"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}\", strategy.getName(),\n 54:                         e);\n 55:                     return;\n 56:                 }\n 57: \n 58:                 Set<MessageQueue> allocateResultSet = new HashSet<>();\n 59:                 if (allocateResult != null) {\n 60:                     allocateResultSet.addAll(allocateResult);\n 61:                 }\n 62: \n 63:                 // æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—\n 64:                 boolean changed = this.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);\n 65:                 if (changed) {\n 66:                     log.info(\n 67:                         \"rebalanced result changed. allocateMessageQueueStrategyName={}, group={}, topic={}, clientId={}, mqAllSize={}, cidAllSize={}, rebalanceResultSize={}, rebalanceResultSet={}\",\n 68:                         strategy.getName(), consumerGroup, topic, this.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),\n 69:                         allocateResultSet.size(), allocateResultSet);\n 70:                     this.messageQueueChanged(topic, mqSet, allocateResultSet);\n 71:                 }\n 72:             }\n 73:             break;\n 74:         }\n 75:         default:\n 76:             break;\n 77:     }\n 78: }\n 79: \n 80: /**\n 81:  * å½“è´Ÿè½½å‡è¡¡æ—¶ï¼Œæ›´æ–° æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n 82:  * - ç§»é™¤ åœ¨processQueueTable && ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—\n 83:  * - å¢åŠ  ä¸åœ¨processQueueTable && å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—\n 84:  *\n 85:  * @param topic Topic\n 86:  * @param mqSet è´Ÿè½½å‡è¡¡ç»“æœåçš„æ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„\n 87:  * @param isOrder æ˜¯å¦é¡ºåº\n 88:  * @return æ˜¯å¦å˜æ›´\n 89:  */\n 90: private boolean updateProcessQueueTableInRebalance(final String topic, final Set<MessageQueue> mqSet, final boolean isOrder) {\n 91:     boolean changed = false;\n 92: \n 93:     // ç§»é™¤ åœ¨processQueueTable && ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—\n 94:     Iterator<Entry<MessageQueue, ProcessQueue>> it = this.processQueueTable.entrySet().iterator();\n 95:     while (it.hasNext()) { // TODO å¾…è¯»ï¼š\n 96:         Entry<MessageQueue, ProcessQueue> next = it.next();\n 97:         MessageQueue mq = next.getKey();\n 98:         ProcessQueue pq = next.getValue();\n 99: \n100:         if (mq.getTopic().equals(topic)) {\n101:             if (!mqSet.contains(mq)) { // ä¸åŒ…å«çš„é˜Ÿåˆ—\n102:                 pq.setDropped(true);\n103:                 if (this.removeUnnecessaryMessageQueue(mq, pq)) {\n104:                     it.remove();\n105:                     changed = true;\n106:                     log.info(\"doRebalance, {}, remove unnecessary mq, {}\", consumerGroup, mq);\n107:                 }\n108:             } else if (pq.isPullExpired()) { // é˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†\n109:                 switch (this.consumeType()) {\n110:                     case CONSUME_ACTIVELY:\n111:                         break;\n112:                     case CONSUME_PASSIVELY:\n113:                         pq.setDropped(true);\n114:                         if (this.removeUnnecessaryMessageQueue(mq, pq)) {\n115:                             it.remove();\n116:                             changed = true;\n117:                             log.error(\"[BUG]doRebalance, {}, remove unnecessary mq, {}, because pull is pause, so try to fixed it\",\n118:                                 consumerGroup, mq);\n119:                         }\n120:                         break;\n121:                     default:\n122:                         break;\n123:                 }\n124:             }\n125:         }\n126:     }\n127: \n128:     // å¢åŠ  ä¸åœ¨processQueueTable && å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n129:     List<PullRequest> pullRequestList = new ArrayList<>(); // æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„\n130:     for (MessageQueue mq : mqSet) {\n131:         if (!this.processQueueTable.containsKey(mq)) {\n132:             if (isOrder && !this.lock(mq)) {\n133:                 log.warn(\"doRebalance, {}, add a new mq failed, {}, because lock failed\", consumerGroup, mq);\n134:                 continue;\n135:             }\n136: \n137:             this.removeDirtyOffset(mq);\n138:             ProcessQueue pq = new ProcessQueue();\n139:             long nextOffset = this.computePullFromWhere(mq);\n140:             if (nextOffset >= 0) {\n141:                 ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq);\n142:                 if (pre != null) {\n143:                     log.info(\"doRebalance, {}, mq already exists, {}\", consumerGroup, mq);\n144:                 } else {\n145:                     log.info(\"doRebalance, {}, add a new mq, {}\", consumerGroup, mq);\n146:                     PullRequest pullRequest = new PullRequest();\n147:                     pullRequest.setConsumerGroup(consumerGroup);\n148:                     pullRequest.setNextOffset(nextOffset);\n149:                     pullRequest.setMessageQueue(mq);\n150:                     pullRequest.setProcessQueue(pq);\n151:                     pullRequestList.add(pullRequest);\n152:                     changed = true;\n153:                 }\n154:             } else {\n155:                 log.warn(\"doRebalance, {}, add new mq failed, {}\", consumerGroup, mq);\n156:             }\n157:         }\n158:     }\n159: \n160:     // å‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚\n161:     this.dispatchPullRequest(pullRequestList);\n162: \n163:     return changed;\n164: }\n```\n\n* `#rebalanceByTopic(...)` è¯´æ˜ ï¼šåˆ†é… `Topic` çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 3 è‡³ 19 è¡Œ ï¼šå¹¿æ’­æ¨¡å¼( `BROADCASTING` ) ä¸‹ï¼Œåˆ†é… `Topic` å¯¹åº”çš„**æ‰€æœ‰**æ¶ˆæ¯é˜Ÿåˆ—ã€‚   \n    * ç¬¬ 20 è‡³ 74 è¡Œ ï¼šé›†ç¾¤æ¨¡å¼( `CLUSTERING` ) ä¸‹ï¼Œåˆ†é… `Topic` å¯¹åº”çš„**éƒ¨åˆ†**æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n        * ç¬¬ 21 è‡³ 40 è¡Œ ï¼šè·å– `Topic` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ä»¬ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ’åºã€‚å› ä¸ºå„ `Consumer` æ˜¯åœ¨æœ¬åœ°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ’åºåæ‰èƒ½ä¿è¯å„ `Consumer` é¡ºåºä¸€è‡´ã€‚\n        *  ç¬¬ 42 è‡³ 61 è¡Œ ï¼šæ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥( `AllocateMessageQueueStrategy` ) åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š[AllocateMessageQueueStrategy](#allocatemessagequeuestrategy)ã€‚\n        *  ç¬¬ 63 è‡³ 72 è¡Œ ï¼šæ›´æ–° `Topic` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* `#updateProcessQueueTableInRebalance(...)` è¯´æ˜ ï¼šå½“åˆ†é…é˜Ÿåˆ—æ—¶ï¼Œæ›´æ–° `Topic` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è¿”å›æ˜¯å¦æœ‰å˜æ›´ã€‚\n    * ç¬¬ 93 è‡³ 126 è¡Œ ï¼šç§»é™¤ä¸å­˜åœ¨äºåˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( `mqSet` ) çš„ æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—( `processQueueTable` )ã€‚\n        * ç¬¬ 103 è¡Œ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š[RebalancePushImpl#removeUnnecessaryMessageQueue(...)](#rebalancepushimplremoveunnecessarymessagequeue)ã€‚\n        * ç¬¬ 108 è‡³ 120 è¡Œ ï¼šé˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œå³ `å½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶é—´ > 120s` ( 120s å¯é…ç½®)ï¼Œåˆ¤å®šå‘ç”Ÿ **BUG**ï¼Œè¿‡ä¹…æœªè¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç§»é™¤åï¼Œä¸‹é¢**#æ–°å¢é˜Ÿåˆ—é€»è¾‘#**å¯ä»¥é‡æ–°åŠ å…¥æ–°çš„è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 128 è‡³ 158 è¡Œ ï¼šå¢åŠ  åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( `mqSet` ) æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n        * ç¬¬ 132 è‡³ 135 è¡Œ ï¼š`é¡ºåºæ¶ˆè´¹` ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹](http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/)ã€‚\n        * ç¬¬ 137 è¡Œ ï¼šç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ã€‚\n        * ç¬¬ 139 è¡Œ ï¼šè·å–é˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š[RebalancePushImpl#computePullFromWhere(...)](#rebalancepushimplcomputepullfromwhere)ã€‚\n        * ç¬¬ 140 è‡³ 156 è¡Œ ï¼š**æ·»åŠ æ–°æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ï¼Œæ·»åŠ æ¶ˆè´¹æ‹‰å–æ¶ˆæ¯è¯·æ±‚**ã€‚\n    * ç¬¬ 161 è¡Œ ï¼š**å‘èµ·æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯æ‹‰å–è¯·æ±‚**ã€‚è¯¦ç»†è§£æè§ï¼š[RebalancePushImpl#dispatchPullRequest(...)](#rebalancepushimpldispatchpullrequest)ã€‚\n\n### RebalanceImpl#removeUnnecessaryMessageQueue(...)\n\n#### RebalancePushImpl#removeUnnecessaryMessageQueue(...)\n\n```Java\n  1: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {\n  2:     // åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚\n  3:     this.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);\n  4:     this.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);\n  5:     // TODO é¡ºåºæ¶ˆè´¹\n  6:     if (this.defaultMQPushConsumerImpl.isConsumeOrderly()\n  7:         && MessageModel.CLUSTERING.equals(this.defaultMQPushConsumerImpl.messageModel())) {\n  8:         try {\n  9:             if (pq.getLockConsume().tryLock(1000, TimeUnit.MILLISECONDS)) {\n 10:                 try {\n 11:                     return this.unlockDelay(mq, pq);\n 12:                 } finally {\n 13:                     pq.getLockConsume().unlock();\n 14:                 }\n 15:             } else {\n 16:                 log.warn(\"[WRONG]mq is consuming, so can not unlock it, {}. maybe hanged for a while, {}\", //\n 17:                     mq, //\n 18:                     pq.getTryUnlockTimes());\n 19: \n 20:                 pq.incTryUnlockTimes();\n 21:             }\n 22:         } catch (Exception e) {\n 23:             log.error(\"removeUnnecessaryMessageQueue Exception\", e);\n 24:         }\n 25: \n 26:         return false;\n 27:     }\n 28:     return true;\n 29: }\n```\n\n* è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›æ˜¯å¦ç§»é™¤æˆåŠŸã€‚\n* ç¬¬ 2 è‡³ 4 è¡Œ ï¼š**åŒæ­¥**é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚\n* ç¬¬ 5 è‡³ 27 è¡Œ ï¼š`é¡ºåºæ¶ˆè´¹` ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹](http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/)ã€‚\n\n#### `[PullConsumer]` RebalancePullImpl#removeUnnecessaryMessageQueue(...)\n\n```Java\n  1: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {\n  2:     this.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);\n  3:     this.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);\n  4:     return true;\n  5: }\n```\n\n* è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›ç§»é™¤æˆåŠŸã€‚**å’Œ`RebalancePushImpl#removeUnnecessaryMessageQueue(...)`åŸºæœ¬ä¸€è‡´ã€‚**\n\n### RebalancePushImpl#dispatchPullRequest(...)\n\n```Java\n  1: public void dispatchPullRequest(List<PullRequest> pullRequestList) {\n  2:     for (PullRequest pullRequest : pullRequestList) {\n  3:         this.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);\n  4:         log.info(\"doRebalance, {}, add a new pull request {}\", consumerGroup, pullRequest);\n  5:     }\n  6: }\n```\n\n* è¯´æ˜ ï¼šå‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚**è¯¥è°ƒç”¨æ˜¯`PushConsumer`ä¸æ–­ä¸æ–­ä¸æ–­æ‹‰å–æ¶ˆæ¯çš„èµ·ç‚¹**ã€‚\n\n#### DefaultMQPushConsumerImpl#executePullRequestImmediately(...)\n\n```Java\n  1: public void executePullRequestImmediately(final PullRequest pullRequest) {\n  2:     this.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);\n  3: }\n```\n\n* è¯´æ˜ ï¼šæäº¤æ‹‰å–è¯·æ±‚ã€‚æäº¤åï¼Œ`PullMessageService` **å¼‚æ­¥æ‰§è¡Œ**ï¼Œ**éé˜»å¡**ã€‚è¯¦ç»†è§£æè§ï¼š[PullMessageService](pullmessageservice)ã€‚\n\n### AllocateMessageQueueStrategy\n\n![AllocateMessageQueueStrategyç±»å›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/01.png)\n\n#### AllocateMessageQueueAveragely\n\n```Java\n  1: public class AllocateMessageQueueAveragely implements AllocateMessageQueueStrategy {\n  2:     private final Logger log = ClientLogger.getLog();\n  3: \n  4:     @Override\n  5:     public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,\n  6:         List<String> cidAll) {\n  7:         // æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®\n  8:         if (currentCID == null || currentCID.length() < 1) {\n  9:             throw new IllegalArgumentException(\"currentCID is empty\");\n 10:         }\n 11:         if (mqAll == null || mqAll.isEmpty()) {\n 12:             throw new IllegalArgumentException(\"mqAll is null or mqAll empty\");\n 13:         }\n 14:         if (cidAll == null || cidAll.isEmpty()) {\n 15:             throw new IllegalArgumentException(\"cidAll is null or cidAll empty\");\n 16:         }\n 17: \n 18:         List<MessageQueue> result = new ArrayList<>();\n 19:         if (!cidAll.contains(currentCID)) {\n 20:             log.info(\"[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}\",\n 21:                 consumerGroup,\n 22:                 currentCID,\n 23:                 cidAll);\n 24:             return result;\n 25:         }\n 26:         // å¹³å‡åˆ†é…\n 27:         int index = cidAll.indexOf(currentCID); // ç¬¬å‡ ä¸ªconsumerã€‚\n 28:         int mod = mqAll.size() % cidAll.size(); // ä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚\n 29:         int averageSize =\n 30:             mqAll.size() <= cidAll.size() ? 1 : (mod > 0 && index < mod ? mqAll.size() / cidAll.size()\n 31:                 + 1 : mqAll.size() / cidAll.size());\n 32:         int startIndex = (mod > 0 && index < mod) ? index * averageSize : index * averageSize + mod; // æœ‰ä½™æ•°çš„æƒ…å†µä¸‹ï¼Œ[0, mod) å¹³åˆ†ä½™æ•°ï¼Œå³æ¯consumerå¤šåˆ†é…ä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬indexå¼€å§‹ï¼Œè·³è¿‡å‰modä½™æ•°ã€‚\n 33:         int range = Math.min(averageSize, mqAll.size() - startIndex); // åˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦Math.min()çš„åŸå› æ˜¯ï¼ŒmqAll.size() <= cidAll.size()ï¼Œéƒ¨åˆ†consumeråˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n 34:         for (int i = 0; i < range; i++) {\n 35:             result.add(mqAll.get((startIndex + i) % mqAll.size()));\n 36:         }\n 37:         return result;\n 38:     }\n 39: \n 40:     @Override\n 41:     public String getName() {\n 42:         return \"AVG\";\n 43:     }\n 44: }\n```\n\n* è¯´æ˜ ï¼š**å¹³å‡**åˆ†é…é˜Ÿåˆ—ç­–ç•¥ã€‚\n* ç¬¬ 7 è‡³ 25 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚\n* ç¬¬ 26 è‡³ 36 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 27 è¡Œ ï¼š`index` ï¼šå½“å‰ `Consumer` åœ¨æ¶ˆè´¹é›†ç¾¤é‡Œæ˜¯ç¬¬å‡ ä¸ªã€‚è¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å¯¹ä¼ å…¥çš„ `cidAll` å‚æ•°å¿…é¡»è¿›è¡Œæ’åºçš„åŸå› ã€‚å¦‚æœä¸æ’åºï¼Œ`Consumer` åœ¨æœ¬åœ°è®¡ç®—å‡ºæ¥çš„ `index` æ— æ³•ä¸€è‡´ï¼Œå½±å“è®¡ç®—ç»“æœã€‚\n    * ç¬¬ 28 è¡Œ ï¼š`mod` ï¼šä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚\n    * ç¬¬ 29 è‡³ 31 è¡Œ ï¼š`averageSize` ï¼šä»£ç å¯ä»¥ç®€åŒ–æˆ `(mod > 0 && index < mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())`ã€‚\n        * `[ 0, mod )` ï¼š`mqAll.size() / cidAll.size() + 1`ã€‚å‰é¢ `mod` ä¸ª `Consumer` å¹³åˆ†ä½™æ•°ï¼Œå¤šè·å¾— 1 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚\n        * `[ mod, cidAll.size() )` ï¼š`mqAll.size() / cidAll.size()`ã€‚\n    * ç¬¬ 32 è¡Œ ï¼š`startIndex` ï¼š`Consumer` åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹ä½ç½®ã€‚\n    * ç¬¬ 33 è¡Œ ï¼š`range` ï¼šåˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦ `Math#min(...)` çš„åŸå› ï¼šå½“ `mqAll.size() <= cidAll.size()` æ—¶ï¼Œæœ€åå‡ ä¸ª `Consumer` åˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 34 è‡³ 36 è¡Œ ï¼šç”Ÿæˆåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç»“æœã€‚\n* ä¸¾ä¸ªä¾‹å­ï¼š\n\nå›ºå®šæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ä¸º**4**ã€‚\n\n|   | Consumer * 2 *å¯ä»¥æ•´é™¤* | Consumer * 3 *ä¸å¯æ•´é™¤* | Consumer * 5 *æ— æ³•éƒ½åˆ†é…* |\n| --- | --- | --- | --- |\n| æ¶ˆæ¯é˜Ÿåˆ—[0] | Consumer[0] | Consumer[0] | Consumer[0] |\n| æ¶ˆæ¯é˜Ÿåˆ—[1] | Consumer[0] | Consumer[0] | Consumer[1] |\n| æ¶ˆæ¯é˜Ÿåˆ—[2] | Consumer[1] | Consumer[1] | Consumer[2] |\n| æ¶ˆæ¯é˜Ÿåˆ—[3] | Consumer[1] | Consumer[2] | Consumer[3] |\n\n#### AllocateMessageQueueByMachineRoom\n\n```Java\n  1: public class AllocateMessageQueueByMachineRoom implements AllocateMessageQueueStrategy {\n  2:     /**\n  3:      * æ¶ˆè´¹è€…æ¶ˆè´¹brokerNameé›†åˆ\n  4:      */\n  5:     private Set<String> consumeridcs;\n  6: \n  7:     @Override\n  8:     public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,\n  9:         List<String> cidAll) {\n 10:         // å‚æ•°æ ¡éªŒ\n 11:         List<MessageQueue> result = new ArrayList<MessageQueue>();\n 12:         int currentIndex = cidAll.indexOf(currentCID);\n 13:         if (currentIndex < 0) {\n 14:             return result;\n 15:         }\n 16:         // è®¡ç®—ç¬¦åˆå½“å‰é…ç½®çš„æ¶ˆè´¹è€…æ•°ç»„('consumeridcs')å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—\n 17:         List<MessageQueue> premqAll = new ArrayList<MessageQueue>();\n 18:         for (MessageQueue mq : mqAll) {\n 19:             String[] temp = mq.getBrokerName().split(\"@\");\n 20:             if (temp.length == 2 && consumeridcs.contains(temp[0])) {\n 21:                 premqAll.add(mq);\n 22:             }\n 23:         }\n 24:         // å¹³å‡åˆ†é…\n 25:         int mod = premqAll.size() / cidAll.size();\n 26:         int rem = premqAll.size() % cidAll.size();\n 27:         int startIndex = mod * currentIndex;\n 28:         int endIndex = startIndex + mod;\n 29:         for (int i = startIndex; i < endIndex; i++) {\n 30:             result.add(mqAll.get(i));\n 31:         }\n 32:         if (rem > currentIndex) {\n 33:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));\n 34:         }\n 35:         return result;\n 36:     }\n 37: \n 38:     @Override\n 39:     public String getName() {\n 40:         return \"MACHINE_ROOM\";\n 41:     }\n 42: \n 43:     public Set<String> getConsumeridcs() {\n 44:         return consumeridcs;\n 45:     }\n 46: \n 47:     public void setConsumeridcs(Set<String> consumeridcs) {\n 48:         this.consumeridcs = consumeridcs;\n 49:     }\n 50: }\n```\n\n* è¯´æ˜ ï¼š**å¹³å‡**åˆ†é…**å¯æ¶ˆè´¹çš„** `Broker` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 7 è‡³ 15 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚\n* ç¬¬ 16 è‡³ 23 è¡Œ ï¼šè®¡ç®—**å¯æ¶ˆè´¹çš„** `Broker` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 25 è‡³ 34 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¥**å¹³å‡åˆ†é…**æ–¹å¼å’Œ `AllocateMessageQueueAveragely` ç•¥æœ‰ä¸åŒï¼Œå…¶æ˜¯å°†å¤šä½™çš„ç»“å°¾éƒ¨åˆ†åˆ†é…ç»™å‰ `rem` ä¸ª `Consumer`ã€‚\n* ç–‘é—®ï¼š*ä½¿ç”¨è¯¥åˆ†é…ç­–ç•¥æ—¶ï¼Œ`Consumer` å’Œ `Broker` åˆ†é…éœ€è¦æ€ä¹ˆé…ç½®*ã€‚ğŸ˜ˆç­‰ç ”ç©¶**ä¸»ä»**ç›¸å…³æºç æ—¶ï¼Œä»”ç»†è€ƒè™‘ä¸‹ã€‚\n\n#### AllocateMessageQueueAveragelyByCircle\n\n ```Java\n   1: public class AllocateMessageQueueAveragelyByCircle implements AllocateMessageQueueStrategy {\n  2:     private final Logger log = ClientLogger.getLog();\n  3: \n  4:     @Override\n  5:     public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,\n  6:         List<String> cidAll) {\n  7:         // æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®\n  8:         if (currentCID == null || currentCID.length() < 1) {\n  9:             throw new IllegalArgumentException(\"currentCID is empty\");\n 10:         }\n 11:         if (mqAll == null || mqAll.isEmpty()) {\n 12:             throw new IllegalArgumentException(\"mqAll is null or mqAll empty\");\n 13:         }\n 14:         if (cidAll == null || cidAll.isEmpty()) {\n 15:             throw new IllegalArgumentException(\"cidAll is null or cidAll empty\");\n 16:         }\n 17: \n 18:         List<MessageQueue> result = new ArrayList<MessageQueue>();\n 19:         if (!cidAll.contains(currentCID)) {\n 20:             log.info(\"[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}\",\n 21:                 consumerGroup,\n 22:                 currentCID,\n 23:                 cidAll);\n 24:             return result;\n 25:         }\n 26: \n 27:         // ç¯çŠ¶åˆ†é…\n 28:         int index = cidAll.indexOf(currentCID);\n 29:         for (int i = index; i < mqAll.size(); i++) {\n 30:             if (i % cidAll.size() == index) {\n 31:                 result.add(mqAll.get(i));\n 32:             }\n 33:         }\n 34:         return result;\n 35:     }\n 36: \n 37:     @Override\n 38:     public String getName() {\n 39:         return \"AVG_BY_CIRCLE\";\n 40:     }\n 41: }\n ```\n \n * è¯´æ˜ ï¼šç¯çŠ¶åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n\n#### AllocateMessageQueueByConfig\n\n```Java\n  1: public class AllocateMessageQueueByConfig implements AllocateMessageQueueStrategy {\n  2:     private List<MessageQueue> messageQueueList;\n  3: \n  4:     @Override\n  5:     public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,\n  6:         List<String> cidAll) {\n  7:         return this.messageQueueList;\n  8:     }\n  9: \n 10:     @Override\n 11:     public String getName() {\n 12:         return \"CONFIG\";\n 13:     }\n 14: \n 15:     public List<MessageQueue> getMessageQueueList() {\n 16:         return messageQueueList;\n 17:     }\n 18: \n 19:     public void setMessageQueueList(List<MessageQueue> messageQueueList) {\n 20:         this.messageQueueList = messageQueueList;\n 21:     }\n 22: }\n```\n\n* è¯´æ˜ ï¼šåˆ†é…**é…ç½®çš„**æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç–‘é—® ï¼š*è¯¥åˆ†é…ç­–ç•¥çš„ä½¿ç”¨åœºæ™¯ã€‚*\n\n# 5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–\n\n## RebalancePushImpl#computePullFromWhere(...)\n\n```Java\n  1: public long computePullFromWhere(MessageQueue mq) {\n  2:     long result = -1;\n  3:     final ConsumeFromWhere consumeFromWhere = this.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();\n  4:     final OffsetStore offsetStore = this.defaultMQPushConsumerImpl.getOffsetStore();\n  5:     switch (consumeFromWhere) {\n  6:         case CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: // åºŸå¼ƒ\n  7:         case CONSUME_FROM_MIN_OFFSET: // åºŸå¼ƒ\n  8:         case CONSUME_FROM_MAX_OFFSET: // åºŸå¼ƒ\n  9:         case CONSUME_FROM_LAST_OFFSET: {\n 10:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);\n 11:             if (lastOffset >= 0) {\n 12:                 result = lastOffset;\n 13:             }\n 14:             // First start,no offset\n 15:             else if (-1 == lastOffset) {\n 16:                 if (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 17:                     result = 0L;\n 18:                 } else {\n 19:                     try {\n 20:                         result = this.mQClientFactory.getMQAdminImpl().maxOffset(mq);\n 21:                     } catch (MQClientException e) {\n 22:                         result = -1;\n 23:                     }\n 24:                 }\n 25:             } else {\n 26:                 result = -1;\n 27:             }\n 28:             break;\n 29:         }\n 30:         case CONSUME_FROM_FIRST_OFFSET: {\n 31:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);\n 32:             if (lastOffset >= 0) {\n 33:                 result = lastOffset;\n 34:             } else if (-1 == lastOffset) {\n 35:                 result = 0L;\n 36:             } else {\n 37:                 result = -1;\n 38:             }\n 39:             break;\n 40:         }\n 41:         case CONSUME_FROM_TIMESTAMP: {\n 42:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);\n 43:             if (lastOffset >= 0) {\n 44:                 result = lastOffset;\n 45:             } else if (-1 == lastOffset) {\n 46:                 if (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 47:                     try {\n 48:                         result = this.mQClientFactory.getMQAdminImpl().maxOffset(mq);\n 49:                     } catch (MQClientException e) {\n 50:                         result = -1;\n 51:                     }\n 52:                 } else {\n 53:                     try {\n 54:                         long timestamp = UtilAll.parseDate(this.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),\n 55:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();\n 56:                         result = this.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);\n 57:                     } catch (MQClientException e) {\n 58:                         result = -1;\n 59:                     }\n 60:                 }\n 61:             } else {\n 62:                 result = -1;\n 63:             }\n 64:             break;\n 65:         }\n 66: \n 67:         default:\n 68:             break;\n 69:     }\n 70: \n 71:     return result;\n 72: }\n```\n\n* è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹æ¶ˆè´¹ä½ç½®ã€‚\n* `PushConsumer` è¯»å–æ¶ˆè´¹è¿›åº¦æœ‰ä¸‰ç§é€‰é¡¹ï¼š\n    * `CONSUME_FROM_LAST_OFFSET` ï¼šç¬¬ 6 è‡³ 29 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»**é˜Ÿåˆ—çš„æœ€åä½ç½®**å¼€å§‹æ¶ˆè´¹ã€‚**åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹**ã€‚\n    * `CONSUME_FROM_FIRST_OFFSET` ï¼šç¬¬ 30 è‡³ 40 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»é˜Ÿåˆ—çš„**æœ€å‰ä½ç½®**å¼€å§‹æ¶ˆè´¹ã€‚**åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹**ã€‚\n    * `CONSUME_FROM_TIMESTAMP` ï¼šç¬¬ 41 è‡³ 65 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»**æŒ‡å®šæ—¶é—´ç‚¹**å¼€å§‹æ¶ˆè´¹ã€‚**åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹**ã€‚\n\n\n## `[PullConsumer]` RebalancePullImpl#computePullFromWhere(...)\n\næš‚æ—¶è·³è¿‡ã€‚ğŸ˜ˆ\n\n# 6ã€PushConsumer æ‹‰å–æ¶ˆæ¯\n\n![DefaultMQPushConsumerImplæ‹‰å–æ¶ˆæ¯](http://www.yunai.me/images/RocketMQ/2017_05_04/05.png)\n\n## PullMessageService\n\n```Java\n  1: public class PullMessageService extends ServiceThread {\n  2:     private final Logger log = ClientLogger.getLog();\n  3:     /**\n  4:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—\n  5:      */\n  6:     private final LinkedBlockingQueue<PullRequest> pullRequestQueue = new LinkedBlockingQueue<>();\n  7:     /**\n  8:      * MQClientå¯¹è±¡\n  9:      */\n 10:     private final MQClientInstance mQClientFactory;\n 11:     /**\n 12:      * å®šæ—¶å™¨ã€‚ç”¨äºå»¶è¿Ÿæäº¤æ‹‰å–è¯·æ±‚\n 13:      */\n 14:     private final ScheduledExecutorService scheduledExecutorService = Executors\n 15:         .newSingleThreadScheduledExecutor(new ThreadFactory() {\n 16:             @Override\n 17:             public Thread newThread(Runnable r) {\n 18:                 return new Thread(r, \"PullMessageServiceScheduledThread\");\n 19:             }\n 20:         });\n 21: \n 22:     public PullMessageService(MQClientInstance mQClientFactory) {\n 23:         this.mQClientFactory = mQClientFactory;\n 24:     }\n 25: \n 26:     /**\n 27:      * æ‰§è¡Œå»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 28:      *\n 29:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 30:      * @param timeDelay å»¶è¿Ÿæ—¶é•¿\n 31:      */\n 32:     public void executePullRequestLater(final PullRequest pullRequest, final long timeDelay) {\n 33:         this.scheduledExecutorService.schedule(new Runnable() {\n 34: \n 35:             @Override\n 36:             public void run() {\n 37:                 PullMessageService.this.executePullRequestImmediately(pullRequest);\n 38:             }\n 39:         }, timeDelay, TimeUnit.MILLISECONDS);\n 40:     }\n 41: \n 42:     /**\n 43:      * æ‰§è¡Œç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 44:      *\n 45:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 46:      */\n 47:     public void executePullRequestImmediately(final PullRequest pullRequest) {\n 48:         try {\n 49:             this.pullRequestQueue.put(pullRequest);\n 50:         } catch (InterruptedException e) {\n 51:             log.error(\"executePullRequestImmediately pullRequestQueue.put\", e);\n 52:         }\n 53:     }\n 54: \n 55:     /**\n 56:      * æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡\n 57:      *\n 58:      * @param r ä»»åŠ¡\n 59:      * @param timeDelay å»¶è¿Ÿæ—¶é•¿\n 60:      */\n 61:     public void executeTaskLater(final Runnable r, final long timeDelay) {\n 62:         this.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);\n 63:     }\n 64: \n 65:     public ScheduledExecutorService getScheduledExecutorService() {\n 66:         return scheduledExecutorService;\n 67:     }\n 68: \n 69:     /**\n 70:      * æ‹‰å–æ¶ˆæ¯\n 71:      *\n 72:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 73:      */\n 74:     private void pullMessage(final PullRequest pullRequest) {\n 75:         final MQConsumerInner consumer = this.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());\n 76:         if (consumer != null) {\n 77:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;\n 78:             impl.pullMessage(pullRequest);\n 79:         } else {\n 80:             log.warn(\"No matched consumer for the PullRequest {}, drop it\", pullRequest);\n 81:         }\n 82:     }\n 83: \n 84:     @Override\n 85:     public void run() {\n 86:         log.info(this.getServiceName() + \" service started\");\n 87: \n 88:         while (!this.isStopped()) {\n 89:             try {\n 90:                 PullRequest pullRequest = this.pullRequestQueue.take();\n 91:                 if (pullRequest != null) {\n 92:                     this.pullMessage(pullRequest);\n 93:                 }\n 94:             } catch (InterruptedException e) {\n 95:             } catch (Exception e) {\n 96:                 log.error(\"Pull Message Service Run Method exception\", e);\n 97:             }\n 98:         }\n 99: \n100:         log.info(this.getServiceName() + \" service end\");\n101:     }\n102: \n103:     @Override\n104:     public String getServiceName() {\n105:         return PullMessageService.class.getSimpleName();\n106:     }\n107: \n108: }\n```\n\n* è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œä¸æ–­ä¸æ–­ä¸æ–­ä» `Broker` æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° `ConsumeMessageService`ã€‚\n* `#executePullRequestLater(...)` ï¼šç¬¬ 26 è‡³ 40 è¡Œ ï¼š æäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n* `#executePullRequestImmediately(...)` ï¼šç¬¬ 42 è‡³ 53 è¡Œ ï¼šæäº¤**ç«‹å³**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n* `#executeTaskLater(...)` ï¼šç¬¬ 55 è‡³ 63 è¡Œ ï¼šæäº¤**å»¶è¿Ÿä»»åŠ¡**ã€‚\n* `#pullMessage(...)` ï¼šç¬¬ 69 è‡³ 82 è¡Œ ï¼šæ‰§è¡Œæ‹‰å–æ¶ˆæ¯é€»è¾‘ã€‚è¯¦ç»†è§£æè§ï¼š[DefaultMQPushConsumerImpl#pullMessage(...)](#defaultmqpushconsumerimplpullmessage)ã€‚\n* `#run(...)` ï¼šç¬¬ 84 è‡³ 101 è¡Œ ï¼šå¾ªç¯æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—( `pullRequestQueue` )ï¼Œè¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚\n\n## DefaultMQPushConsumerImpl#pullMessage(...)\n\n```Java\n  1: public void pullMessage(final PullRequest pullRequest) {\n  2:     final ProcessQueue processQueue = pullRequest.getProcessQueue();\n  3:     if (processQueue.isDropped()) {\n  4:         log.info(\"the pull request[{}] is dropped.\", pullRequest.toString());\n  5:         return;\n  6:     }\n  7: \n  8:     // è®¾ç½®é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´\n  9:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());\n 10: \n 11:     // åˆ¤æ–­consumerçŠ¶æ€æ˜¯å¦è¿è¡Œä¸­ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯ã€‚\n 12:     try {\n 13:         this.makeSureStateOK();\n 14:     } catch (MQClientException e) {\n 15:         log.warn(\"pullMessage exception, consumer state not ok\", e);\n 16:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n 17:         return;\n 18:     }\n 19: \n 20:     // åˆ¤æ–­æ˜¯å¦æš‚åœä¸­ã€‚\n 21:     if (this.isPause()) {\n 22:         log.warn(\"consumer was paused, execute pull request later. instanceName={}, group={}\", this.defaultMQPushConsumer.getInstanceName(), this.defaultMQPushConsumer.getConsumerGroup());\n 23:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);\n 24:         return;\n 25:     }\n 26: \n 27:     // åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æŒæœ‰æ¶ˆæ¯æ•°é‡ã€‚é»˜è®¤æœ€å¤§å€¼ä¸º1000ã€‚\n 28:     long size = processQueue.getMsgCount().get();\n 29:     if (size > this.defaultMQPushConsumer.getPullThresholdForQueue()) {\n 30:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); // æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚\n 31:         if ((flowControlTimes1++ % 1000) == 0) {\n 32:             log.warn(\n 33:                 \"the consumer message buffer is full, so do flow control, minOffset={}, maxOffset={}, size={}, pullRequest={}, flowControlTimes={}\",\n 34:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);\n 35:         }\n 36:         return;\n 37:     }\n 38: \n 39:     if (!this.consumeOrderly) { // åˆ¤æ–­æ¶ˆæ¯è·¨åº¦æ˜¯å¦è¿‡å¤§ã€‚\n 40:         if (processQueue.getMaxSpan() > this.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) {\n 41:             this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); // æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚\n 42:             if ((flowControlTimes2++ % 1000) == 0) {\n 43:                 log.warn(\n 44:                     \"the queue's messages, span too long, so do flow control, minOffset={}, maxOffset={}, maxSpan={}, pullRequest={}, flowControlTimes={}\",\n 45:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),\n 46:                     pullRequest, flowControlTimes2);\n 47:             }\n 48:             return;\n 49:         }\n 50:     } else { // TODO é¡ºåºæ¶ˆè´¹\n 51:         if (processQueue.isLocked()) {\n 52:             if (!pullRequest.isLockedFirst()) {\n 53:                 final long offset = this.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());\n 54:                 boolean brokerBusy = offset < pullRequest.getNextOffset();\n 55:                 log.info(\"the first time to pull message, so fix offset from broker. pullRequest: {} NewOffset: {} brokerBusy: {}\",\n 56:                     pullRequest, offset, brokerBusy);\n 57:                 if (brokerBusy) {\n 58:                     log.info(\"[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: {} NewOffset: {}\",\n 59:                         pullRequest, offset);\n 60:                 }\n 61: \n 62:                 pullRequest.setLockedFirst(true);\n 63:                 pullRequest.setNextOffset(offset);\n 64:             }\n 65:         } else {\n 66:             this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n 67:             log.info(\"pull message later because not locked in broker, {}\", pullRequest);\n 68:             return;\n 69:         }\n 70:     }\n 71: \n 72:     // è·å–Topic å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯\n 73:     final SubscriptionData subscriptionData = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());\n 74:     if (null == subscriptionData) {\n 75:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n 76:         log.warn(\"find the consumer's subscription failed, {}\", pullRequest);\n 77:         return;\n 78:     }\n 79: \n 80:     final long beginTimestamp = System.currentTimeMillis();\n 81: \n 82:     PullCallback pullCallback = new PullCallback() {\n 83:         @Override\n 84:         public void onSuccess(PullResult pullResult) {\n 85:             if (pullResult != null) {\n 86:                 pullResult = DefaultMQPushConsumerImpl.this.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,\n 87:                     subscriptionData);\n 88: \n 89:                 switch (pullResult.getPullStatus()) {\n 90:                     case FOUND:\n 91:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n 92:                         long prevRequestOffset = pullRequest.getNextOffset();\n 93:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());\n 94: \n 95:                         // ç»Ÿè®¡\n 96:                         long pullRT = System.currentTimeMillis() - beginTimestamp;\n 97:                         DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),\n 98:                             pullRequest.getMessageQueue().getTopic(), pullRT);\n 99: \n100:                         long firstMsgOffset = Long.MAX_VALUE;\n101:                         if (pullResult.getMsgFoundList() == null || pullResult.getMsgFoundList().isEmpty()) {\n102:                             DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);\n103:                         } else {\n104:                             firstMsgOffset = pullResult.getMsgFoundList().get(0).getQueueOffset();\n105: \n106:                             // ç»Ÿè®¡\n107:                             DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),\n108:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());\n109: \n110:                             // æäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n111:                             boolean dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());\n112: \n113:                             // æäº¤æ¶ˆè´¹è¯·æ±‚\n114:                             DefaultMQPushConsumerImpl.this.consumeMessageService.submitConsumeRequest(//\n115:                                 pullResult.getMsgFoundList(), //\n116:                                 processQueue, //\n117:                                 pullRequest.getMessageQueue(), //\n118:                                 dispathToConsume);\n119: \n120:                             // æäº¤ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n121:                             if (DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval() > 0) {\n122:                                 DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest,\n123:                                     DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval());\n124:                             } else {\n125:                                 DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);\n126:                             }\n127:                         }\n128: \n129:                         // ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸ºBUGï¼Œè¾“å‡ºlog\n130:                         if (pullResult.getNextBeginOffset() < prevRequestOffset//\n131:                             || firstMsgOffset < prevRequestOffset) {\n132:                             log.warn(\n133:                                 \"[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}\", //\n134:                                 pullResult.getNextBeginOffset(), //\n135:                                 firstMsgOffset, //\n136:                                 prevRequestOffset);\n137:                         }\n138: \n139:                         break;\n140:                     case NO_NEW_MSG:\n141:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n142:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());\n143: \n144:                         // æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦\n145:                         DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);\n146: \n147:                         // ç«‹å³æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n148:                         DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);\n149:                         break;\n150:                     case NO_MATCHED_MSG:\n151:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n152:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());\n153: \n154:                         // æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦\n155:                         DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);\n156: \n157:                         // æäº¤ç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n158:                         DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);\n159:                         break;\n160:                     case OFFSET_ILLEGAL:\n161:                         log.warn(\"the pull request offset illegal, {} {}\", //\n162:                             pullRequest.toString(), pullResult.toString());\n163:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n164:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());\n165: \n166:                         // è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸ºdropped\n167:                         pullRequest.getProcessQueue().setDropped(true);\n168: \n169:                         // æäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ç§»é™¤ã€‚ä¸ç«‹å³ç§»é™¤çš„åŸå› ï¼šå¯èƒ½æœ‰åœ°æ–¹æ­£åœ¨ä½¿ç”¨ï¼Œé¿å…å—åˆ°å½±å“ã€‚\n170:                         DefaultMQPushConsumerImpl.this.executeTaskLater(new Runnable() {\n171: \n172:                             @Override\n173:                             public void run() {\n174:                                 try {\n175:                                     // æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ°Broker\n176:                                     DefaultMQPushConsumerImpl.this.offsetStore.updateOffset(pullRequest.getMessageQueue(),\n177:                                         pullRequest.getNextOffset(), false);\n178:                                     DefaultMQPushConsumerImpl.this.offsetStore.persist(pullRequest.getMessageQueue());\n179: \n180:                                     // ç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—\n181:                                     DefaultMQPushConsumerImpl.this.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());\n182: \n183:                                     log.warn(\"fix the pull request offset, {}\", pullRequest);\n184:                                 } catch (Throwable e) {\n185:                                     log.error(\"executeTaskLater Exception\", e);\n186:                                 }\n187:                             }\n188:                         }, 10000);\n189:                         break;\n190:                     default:\n191:                         break;\n192:                 }\n193:             }\n194:         }\n195: \n196:         @Override\n197:         public void onException(Throwable e) {\n198:             if (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n199:                 log.warn(\"execute the pull request exception\", e);\n200:             }\n201: \n202:             // æäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚\n203:             DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n204:         }\n205:     };\n206: \n207:     // é›†ç¾¤æ¶ˆæ¯æ¨¡å‹ä¸‹ï¼Œè®¡ç®—æäº¤çš„æ¶ˆè´¹è¿›åº¦ã€‚\n208:     boolean commitOffsetEnable = false;\n209:     long commitOffsetValue = 0L;\n210:     if (MessageModel.CLUSTERING == this.defaultMQPushConsumer.getMessageModel()) {\n211:         commitOffsetValue = this.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);\n212:         if (commitOffsetValue > 0) {\n213:             commitOffsetEnable = true;\n214:         }\n215:     }\n216: \n217:     // è®¡ç®—è¯·æ±‚çš„ è®¢é˜…è¡¨è¾¾å¼ å’Œ æ˜¯å¦è¿›è¡Œfiltersrvè¿‡æ»¤æ¶ˆæ¯\n218:     String subExpression = null;\n219:     boolean classFilter = false;\n220:     SubscriptionData sd = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());\n221:     if (sd != null) {\n222:         if (this.defaultMQPushConsumer.isPostSubscriptionWhenPull() && !sd.isClassFilterMode()) {\n223:             subExpression = sd.getSubString();\n224:         }\n225: \n226:         classFilter = sd.isClassFilterMode();\n227:     }\n228: \n229:     // è®¡ç®—æ‹‰å–æ¶ˆæ¯ç³»ç»Ÿæ ‡è¯†\n230:     int sysFlag = PullSysFlag.buildSysFlag(//\n231:         commitOffsetEnable, // commitOffset\n232:         true, // suspend\n233:         subExpression != null, // subscription\n234:         classFilter // class filter\n235:     );\n236: \n237:     // æ‰§è¡Œæ‹‰å–ã€‚å¦‚æœæ‹‰å–è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n238:     try {\n239:         this.pullAPIWrapper.pullKernelImpl(//\n240:             pullRequest.getMessageQueue(), // 1\n241:             subExpression, // 2\n242:             subscriptionData.getSubVersion(), // 3\n243:             pullRequest.getNextOffset(), // 4\n244:             this.defaultMQPushConsumer.getPullBatchSize(), // 5\n245:             sysFlag, // 6\n246:             commitOffsetValue, // 7\n247:             BROKER_SUSPEND_MAX_TIME_MILLIS, // 8\n248:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, // 9\n249:             CommunicationMode.ASYNC, // 10\n250:             pullCallback// 11\n251:         );\n252:     } catch (Exception e) {\n253:         log.error(\"pullKernelImpl exception\", e);\n254:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n255:     }\n256: }\n257: \n258: private void correctTagsOffset(final PullRequest pullRequest) {\n259:     if (0L == pullRequest.getProcessQueue().getMsgCount().get()) {\n260:         this.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), true);\n261:     }\n262: }\n```\n\n* `#pullMessage(...)` è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯ã€‚\n    * ç¬¬ 3 è‡³ 6 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å·²ç»ç»ˆæ­¢ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚\n    * ç¬¬ 9 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´ã€‚\n    * ç¬¬ 11 è‡³ 18 è¡Œ ï¼š`Consumer` æœªå¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 20 è‡³ 25 è¡Œ ï¼š `Consumer` å¤„äºæš‚åœä¸­ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 27 è‡³ 37 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è¶…è¿‡æœ€å¤§å…è®¸å€¼ï¼ˆé»˜è®¤ï¼š1000æ¡ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 39 è‡³ 49 è¡Œ ï¼š`Consumer` ä¸º**å¹¶å‘æ¶ˆè´¹** å¹¶ä¸” æ¶ˆæ¯é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è·¨åº¦è¿‡å¤§ï¼ˆæ¶ˆæ¯è·¨åº¦ = æŒæœ‰æ¶ˆæ¯æœ€åä¸€æ¡å’Œç¬¬ä¸€æ¡çš„æ¶ˆæ¯ä½ç½®å·®ï¼Œé»˜è®¤ï¼š2000ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 50 è‡³ 70 è¡Œ ï¼š`é¡ºåºæ¶ˆè´¹` ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹](http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/)ã€‚\n    * ç¬¬ 72 è‡³ 78 è¡Œ ï¼š`Topic` å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 222 è‡³ 224 è¡Œ ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä½¿ç”¨ `Consumer` **æœ¬åœ°**çš„è®¢é˜…ä¿¡æ¯( `SubscriptionData` )ï¼Œè€Œä¸ä½¿ç”¨ `Broker` é‡Œçš„è®¢é˜…ä¿¡æ¯ã€‚è¯¦ç»†è§£æè§ï¼š[PullMessageProcessor#processRequest(...) ç¬¬ 64 è‡³ 110 è¡Œä»£ç ](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-â€¦)ã€‚\n    * ç¬¬ 226 è¡Œ ï¼šæ˜¯å¦å¼€å¯è¿‡æ»¤ç±»è¿‡æ»¤æ¨¡å¼ã€‚è¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Filtersrvã€‹](http://www.yunai.me/RocketMQ/filtersrv/)ã€‚\n    * ç¬¬ 229 è‡³ 235 è¡Œ ï¼šè®¡ç®—æ‹‰å–æ¶ˆæ¯è¯·æ±‚ç³»ç»Ÿæ ‡è¯†ã€‚è¯¦ç»†è§£æè§ï¼š[PullMessageRequestHeader.sysFlag](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageRequestHeader)ã€‚\n    * ç¬¬ 237 è‡³ 255 è¡Œ ï¼š\n        * æ‰§è¡Œæ¶ˆæ¯æ‹‰å–**å¼‚æ­¥**è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š[PullAPIWrapper#pullKernelImpl(...)](#pullapiwrapperpullkernelimpl)ã€‚\n        * å½“å‘èµ·è¯·æ±‚äº§ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚å¯¹åº” `Broker` å¤„ç†æ‹‰å–æ¶ˆæ¯é€»è¾‘è§ï¼š[PullMessageProcessor#processRequest(...)](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-â€¦)ã€‚\n* `PullCallback` ï¼šæ‹‰å–æ¶ˆæ¯å›è°ƒï¼š\n   * ç¬¬ 86 è¡Œ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚è¯¦ç»†é€»è¾‘è§ï¼š[PullAPIWrapper#processPullResult(...)](#pullapiwrapperprocesspullresult)ã€‚\n   * ç¬¬ 89 è‡³ 192 è¡Œ ï¼šå¤„ç†æ‹‰å–çŠ¶æ€ç»“æœï¼š\n        * ç¬¬ 90 è‡³ 139 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯( `FOUND` ) ï¼š\n            * ç¬¬ 91 è‡³ 93 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚\n            * ç¬¬ 95 è‡³ 97 è¡Œ ï¼šç»Ÿè®¡ã€‚\n            * ç¬¬ 101 è‡³ 102 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯çš„æ¶ˆæ¯åˆ—è¡¨ä¸ºç©ºï¼Œæäº¤**ç«‹å³**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆæ¯ç»“æœæœªç©ºå‘¢ï¼ŸåŸå› è§ï¼š[PullAPIWrapper#processPullResult(...)](#pullapiwrapperprocesspullresult)ã€‚\n            * ç¬¬ 106 è‡³ 108 è¡Œ ï¼šç»Ÿè®¡ã€‚\n            * ç¬¬ 111 è¡Œ ï¼šæäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š[ProcessQueue#putMessage(...)](#processqueueputmessage)ã€‚\n            * ç¬¬ 113 è‡³ 118 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚åˆ° `ConsumeMessageService`ã€‚è¯¦ç»†è§£æè§ï¼š[ConsumeMessageConcurrentlyService](#consumemessageconcurrentlyservice)ã€‚\n            * ç¬¬ 120 è‡³ 126 è¡Œ ï¼šæ ¹æ®æ‹‰å–é¢‘ç‡( `pullInterval` )ï¼Œæäº¤**ç«‹å³æˆ–è€…å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚é»˜è®¤æ‹‰å–é¢‘ç‡ä¸º 0ms ï¼Œæäº¤**ç«‹å³**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n            * ç¬¬ 129 è‡³ 137 è¡Œ ï¼šä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸º**BUG**ï¼Œè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚\n       * ç¬¬ 140 è‡³ 149 è¡Œ ï¼šæ²¡æœ‰æ–°æ¶ˆæ¯( `NO_NEW_MSG` ) ï¼š\n            * ç¬¬ 142 è¡Œ ï¼š è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚\n            * ç¬¬ 145 è¡Œ ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š`#correctTagsOffset(...)`ã€‚\n            * ç¬¬ 148 è¡Œ ï¼šæäº¤**ç«‹å³**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n       * ç¬¬ 150 è‡³ 159 è¡Œ ï¼šæœ‰æ–°æ¶ˆæ¯ä½†æ˜¯ä¸åŒ¹é…( `NO_MATCHED_MSG` )ã€‚é€»è¾‘åŒ `NO_NEW_MSG` ã€‚\n       * ç¬¬ 160 è‡³ 189 è¡Œ ï¼šæ‹‰å–è¯·æ±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ä¸åˆæ³• (`OFFSET_ILLEGAL`)ã€‚\n            * ç¬¬ 164 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚\n            * ç¬¬ 167 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸º `dropped`ã€‚\n            * ç¬¬ 169 è‡³ 188 è¡Œ ï¼šæäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œé˜Ÿåˆ—ç§»é™¤ã€‚\n                * ç¬¬ 175 è‡³ 178 è¡Œ ï¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° `Broker`ã€‚\n                * ç¬¬ 181 è¡Œ ï¼šç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ã€‚\n                    * ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ç«‹å³ç§»é™¤ï¼Ÿï¼Ÿï¼Ÿ \n  * ç¬¬ 196 è‡³ 204 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n* `#correctTagsOffset(...)` ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚\n    * ç¬¬ 258 è‡³ 261 è¡Œ ï¼š å½“æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯æ•°é‡ä¸º **0** æ—¶ï¼Œæ›´æ–°æ¶ˆè´¹è¿›åº¦ä¸ºæ‹‰å–è¯·æ±‚çš„æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚\n\n### PullAPIWrapper#pullKernelImpl(...)\n\n```Java\n  1: /**\n  2:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•\n  3:  *\n  4:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n  5:  * @param subExpression è®¢é˜…è¡¨è¾¾å¼\n  6:  * @param subVersion è®¢é˜…ç‰ˆæœ¬å·\n  7:  * @param offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®\n  8:  * @param maxNums æ‹‰å–æ¶ˆæ¯æ•°é‡\n  9:  * @param sysFlag æ‹‰å–è¯·æ±‚ç³»ç»Ÿæ ‡è¯†\n 10:  * @param commitOffset æäº¤æ¶ˆè´¹è¿›åº¦\n 11:  * @param brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´\n 12:  * @param timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é•¿\n 13:  * @param communicationMode é€šè®¯æ¨¡å¼\n 14:  * @param pullCallback æ‹‰å–å›è°ƒ\n 15:  * @return æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚\n 16:  * @throws MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸\n 17:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶\n 18:  * @throws MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚\n 19:  * @throws InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶\n 20:  */\n 21: protected PullResult pullKernelImpl(\n 22:     final MessageQueue mq,\n 23:     final String subExpression,\n 24:     final long subVersion,\n 25:     final long offset,\n 26:     final int maxNums,\n 27:     final int sysFlag,\n 28:     final long commitOffset,\n 29:     final long brokerSuspendMaxTimeMillis,\n 30:     final long timeoutMillis,\n 31:     final CommunicationMode communicationMode,\n 32:     final PullCallback pullCallback\n 33: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n 34:     // è·å–Brokerä¿¡æ¯\n 35:     FindBrokerResult findBrokerResult =\n 36:         this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),\n 37:             this.recalculatePullFromWhichNode(mq), false);\n 38:     if (null == findBrokerResult) {\n 39:         this.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());\n 40:         findBrokerResult =\n 41:             this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),\n 42:                 this.recalculatePullFromWhichNode(mq), false);\n 43:     }\n 44: \n 45:     // è¯·æ±‚æ‹‰å–æ¶ˆæ¯\n 46:     if (findBrokerResult != null) {\n 47:         int sysFlagInner = sysFlag;\n 48: \n 49:         if (findBrokerResult.isSlave()) {\n 50:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);\n 51:         }\n 52: \n 53:         PullMessageRequestHeader requestHeader = new PullMessageRequestHeader();\n 54:         requestHeader.setConsumerGroup(this.consumerGroup);\n 55:         requestHeader.setTopic(mq.getTopic());\n 56:         requestHeader.setQueueId(mq.getQueueId());\n 57:         requestHeader.setQueueOffset(offset);\n 58:         requestHeader.setMaxMsgNums(maxNums);\n 59:         requestHeader.setSysFlag(sysFlagInner);\n 60:         requestHeader.setCommitOffset(commitOffset);\n 61:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);\n 62:         requestHeader.setSubscription(subExpression);\n 63:         requestHeader.setSubVersion(subVersion);\n 64: \n 65:         String brokerAddr = findBrokerResult.getBrokerAddr();\n 66:         if (PullSysFlag.hasClassFilterFlag(sysFlagInner)) { // TODO filtersrv\n 67:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);\n 68:         }\n 69: \n 70:         PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage(\n 71:             brokerAddr,\n 72:             requestHeader,\n 73:             timeoutMillis,\n 74:             communicationMode,\n 75:             pullCallback);\n 76: \n 77:         return pullResult;\n 78:     }\n 79: \n 80:     // Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n 81:     throw new MQClientException(\"The broker[\" + mq.getBrokerName() + \"] not exist\", null);\n 82: }\n```\n\n* è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚**è¯¥æ–¹æ³•å‚æ•°è¾ƒå¤šï¼Œå¯ä»¥çœ‹ä¸‹ä»£ç æ³¨é‡Šä¸Šæ¯ä¸ªå‚æ•°çš„è¯´æ˜**ğŸ˜ˆã€‚\n* ç¬¬ 34 è‡³ 43 è¡Œ ï¼šè·å– `Broker` ä¿¡æ¯(`Broker` åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚\n    * [#recalculatePullFromWhichNode(...)](#pullapiwrapperrecalculatepullfromwhichnode)\n    * [#MQClientInstance#findBrokerAddressInSubscribe(...)](#mqclientinstancefindbrokeraddressinsubscribe)\n* ç¬¬ 45 è‡³ 78 è¡Œ ï¼š**è¯·æ±‚æ‹‰å–æ¶ˆæ¯**ã€‚\n* ç¬¬ 81 è¡Œ ï¼šå½“ `Broker` ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚\n\n#### PullAPIWrapper#recalculatePullFromWhichNode(...)\n\n```Java\n  1: /**\n  2:  * æ¶ˆæ¯é˜Ÿåˆ— ä¸ æ‹‰å–Broker çš„æ˜ å°„\n  3:  * å½“æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œä¼šé€šè¿‡è¯¥æ˜ å°„è·å–æ‹‰å–è¯·æ±‚å¯¹åº”çš„Broker\n  4:  */\n  5: private ConcurrentHashMap<MessageQueue, AtomicLong/* brokerId */> pullFromWhichNodeTable =\n  6:     new ConcurrentHashMap<MessageQueue, AtomicLong>(32);\n  7: /**\n  8:  * æ˜¯å¦ä½¿ç”¨é»˜è®¤Broker\n  9:  */\n 10: private volatile boolean connectBrokerByUser = false;\n 11: /**\n 12:  * é»˜è®¤Brokerç¼–å·\n 13:  */\n 14: private volatile long defaultBrokerId = MixAll.MASTER_ID;\n 15: \n 16: /**\n 17:  * è®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„Brokerç¼–å·\n 18:  *\n 19:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n 20:  * @return Brokerç¼–å·\n 21:  */\n 22: public long recalculatePullFromWhichNode(final MessageQueue mq) {\n 23:     // è‹¥å¼€å¯é»˜è®¤Brokerå¼€å…³ï¼Œåˆ™è¿”å›é»˜è®¤Brokerç¼–å·\n 24:     if (this.isConnectBrokerByUser()) {\n 25:         return this.defaultBrokerId;\n 26:     }\n 27: \n 28:     // è‹¥æ¶ˆæ¯é˜Ÿåˆ—æ˜ å°„æ‹‰å–Brokerå­˜åœ¨ï¼Œåˆ™è¿”å›æ˜ å°„Brokerç¼–å·\n 29:     AtomicLong suggest = this.pullFromWhichNodeTable.get(mq);\n 30:     if (suggest != null) {\n 31:         return suggest.get();\n 32:     }\n 33: \n 34:     // è¿”å›Brokerä¸»èŠ‚ç‚¹ç¼–å·\n 35:     return MixAll.MASTER_ID;\n 36: }\n```\n\n* è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„ `Broker` ç¼–å·ã€‚\n\n#### MQClientInstance#findBrokerAddressInSubscribe(...)\n\n```Java\n  1: /**\n  2:  * Brokeråå­— å’Œ Brokeråœ°å€ç›¸å…³ Map\n  3:  */\n  4: private final ConcurrentHashMap<String/* Broker Name */, HashMap<Long/* brokerId */, String/* address */>> brokerAddrTable =\n  5:         new ConcurrentHashMap<>();\n  6: \n  7: /**\n  8:  * è·å¾—Brokerä¿¡æ¯\n  9:  *\n 10:  * @param brokerName brokeråå­—\n 11:  * @param brokerId brokerç¼–å·\n 12:  * @param onlyThisBroker æ˜¯å¦å¿…é¡»æ˜¯è¯¥broker\n 13:  * @return Brokerä¿¡æ¯\n 14:  */\n 15: public FindBrokerResult findBrokerAddressInSubscribe(//\n 16:     final String brokerName, //\n 17:     final long brokerId, //\n 18:     final boolean onlyThisBroker//\n 19: ) {\n 20:     String brokerAddr = null; // brokeråœ°å€\n 21:     boolean slave = false; // æ˜¯å¦ä¸ºä»èŠ‚ç‚¹\n 22:     boolean found = false; // æ˜¯å¦æ‰¾åˆ°\n 23: \n 24:     // è·å¾—Brokerä¿¡æ¯\n 25:     HashMap<Long/* brokerId */, String/* address */> map = this.brokerAddrTable.get(brokerName);\n 26:     if (map != null && !map.isEmpty()) {\n 27:         brokerAddr = map.get(brokerId);\n 28:         slave = brokerId != MixAll.MASTER_ID;\n 29:         found = brokerAddr != null;\n 30: \n 31:         // å¦‚æœä¸å¼ºåˆ¶è·å¾—ï¼Œé€‰æ‹©ä¸€ä¸ªBroker\n 32:         if (!found && !onlyThisBroker) {\n 33:             Entry<Long, String> entry = map.entrySet().iterator().next();\n 34:             brokerAddr = entry.getValue();\n 35:             slave = entry.getKey() != MixAll.MASTER_ID;\n 36:             found = true;\n 37:         }\n 38:     }\n 39: \n 40:     // æ‰¾åˆ°brokerï¼Œåˆ™è¿”å›ä¿¡æ¯\n 41:     if (found) {\n 42:         return new FindBrokerResult(brokerAddr, slave);\n 43:     }\n 44: \n 45:     // æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å›ç©º\n 46:     return null;\n 47: }\n```\n\n* è¯´æ˜ ï¼šè·å– `Broker` ä¿¡æ¯(`Broker` åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚\n\n### PullAPIWrapper#processPullResult(...)\n\n```Java\n  1: /**\n  2:  * å¤„ç†æ‹‰å–ç»“æœ\n  3:  * 1. æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„\n  4:  * 2. è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯\n  5:  *\n  6:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n  7:  * @param pullResult æ‹‰å–ç»“æœ\n  8:  * @param subscriptionData è®¢é˜…ä¿¡æ¯\n  9:  * @return æ‹‰å–ç»“æœ\n 10:  */\n 11: public PullResult processPullResult(final MessageQueue mq, final PullResult pullResult,\n 12:     final SubscriptionData subscriptionData) {\n 13:     PullResultExt pullResultExt = (PullResultExt) pullResult;\n 14: \n 15:     // æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„\n 16:     this.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());\n 17: \n 18:     // è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯\n 19:     if (PullStatus.FOUND == pullResult.getPullStatus()) {\n 20:         // è§£ææ¶ˆæ¯\n 21:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());\n 22:         List<MessageExt> msgList = MessageDecoder.decodes(byteBuffer);\n 23: \n 24:         // æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯\n 25:         List<MessageExt> msgListFilterAgain = msgList;\n 26:         if (!subscriptionData.getTagsSet().isEmpty() && !subscriptionData.isClassFilterMode()) {\n 27:             msgListFilterAgain = new ArrayList<>(msgList.size());\n 28:             for (MessageExt msg : msgList) {\n 29:                 if (msg.getTags() != null) {\n 30:                     if (subscriptionData.getTagsSet().contains(msg.getTags())) {\n 31:                         msgListFilterAgain.add(msg);\n 32:                     }\n 33:                 }\n 34:             }\n 35:         }\n 36: \n 37:         // Hook\n 38:         if (this.hasHook()) {\n 39:             FilterMessageContext filterMessageContext = new FilterMessageContext();\n 40:             filterMessageContext.setUnitMode(unitMode);\n 41:             filterMessageContext.setMsgList(msgListFilterAgain);\n 42:             this.executeHook(filterMessageContext);\n 43:         }\n 44: \n 45:         // è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µ\n 46:         for (MessageExt msg : msgListFilterAgain) {\n 47:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,\n 48:                 Long.toString(pullResult.getMinOffset()));\n 49:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,\n 50:                 Long.toString(pullResult.getMaxOffset()));\n 51:         }\n 52: \n 53:         // è®¾ç½®æ¶ˆæ¯åˆ—è¡¨\n 54:         pullResultExt.setMsgFoundList(msgListFilterAgain);\n 55:     }\n 56: \n 57:     // æ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„\n 58:     pullResultExt.setMessageBinary(null);\n 59: \n 60:     return pullResult;\n 61: }\n```\n\n* è¯´æ˜ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚\n    *  æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ `Broker` ç¼–å·çš„æ˜ å°„ã€‚\n    *  è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ `tagCode `åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚\n* ç¬¬ 16 è¡Œ ï¼šæ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ `Broker` ç¼–å·çš„æ˜ å°„ã€‚ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæœªè®¾ç½®é»˜è®¤æ‹‰å–çš„ `Broker` ç¼–å·ï¼Œä¼šä½¿ç”¨æ›´æ–°åçš„ `Broker` ç¼–å·ã€‚\n* ç¬¬ 18 è‡³ 55 è¡Œ ï¼šè§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ `tagCode` åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚\n    * ç¬¬ 20 è‡³ 22 è¡Œ ï¼šè§£ææ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” MessageåŸºç¡€ã€‹](http://www.yunai.me/RocketMQ/message/) ã€‚\n    * ç¬¬ 24 è‡³ 35 è¡Œ ï¼šæ ¹æ®è®¢é˜…ä¿¡æ¯`tagCode` åŒ¹é…æ¶ˆæ¯ã€‚\n    * ç¬¬ 37 è‡³ 43 è¡Œ ï¼š`Hook`ã€‚\n    * ç¬¬ 45 è‡³ 51 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µã€‚\n    * ç¬¬ 54 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 58 è¡Œ ï¼šæ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„ã€‚\n\n### ProcessQueue#putMessage(...)\n\n```Java\n  1:  /**\n  2:  * æ¶ˆæ¯æ˜ å°„è¯»å†™é”\n  3:  */\n  4: private final ReadWriteLock lockTreeMap = new ReentrantReadWriteLock();\n  5: /**\n  6:  * æ¶ˆæ¯æ˜ å°„\n  7:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n  8:  */\n  9: private final TreeMap<Long, MessageExt> msgTreeMap = new TreeMap<>();\n 10: /**\n 11:  * æ¶ˆæ¯æ•°\n 12:  */\n 13: private final AtomicLong msgCount = new AtomicLong();\n 14: /**\n 15:  * æ·»åŠ æ¶ˆæ¯æœ€å¤§é˜Ÿåˆ—ä½ç½®\n 16:  */\n 17: private volatile long queueOffsetMax = 0L;\n 18: /**\n 19:  * æ˜¯å¦æ­£åœ¨æ¶ˆè´¹\n 20:  */\n 21: private volatile boolean consuming = false;\n 22: /**\n 23:  * Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡\n 24:  * è®¡ç®—å…¬å¼ = queueMaxOffset - æ–°æ·»åŠ æ¶ˆæ¯æ•°ç»„[n - 1].queueOffset\n 25:  * Acc = Accumulation\n 26:  * cnt = ï¼ˆçŒœæµ‹ï¼‰å¯¹æ¯”åº¦\n 27:  */\n 28: private volatile long msgAccCnt = 0;\n 29: \n 30: /**\n 31:  * æ·»åŠ æ¶ˆæ¯ï¼Œå¹¶è¿”å›æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…\n 32:  * è¿”å›trueï¼Œå½“æœ‰æ–°æ¶ˆæ¯æ·»åŠ æˆåŠŸæ—¶ï¼Œ\n 33:  *\n 34:  * @param msgs æ¶ˆæ¯\n 35:  * @return æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…\n 36:  */\n 37: public boolean putMessage(final List<MessageExt> msgs) {\n 38:     boolean dispatchToConsume = false;\n 39:     try {\n 40:         this.lockTreeMap.writeLock().lockInterruptibly();\n 41:         try {\n 42:             // æ·»åŠ æ¶ˆæ¯\n 43:             int validMsgCnt = 0;\n 44:             for (MessageExt msg : msgs) {\n 45:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);\n 46:                 if (null == old) {\n 47:                     validMsgCnt++;\n 48:                     this.queueOffsetMax = msg.getQueueOffset();\n 49:                 }\n 50:             }\n 51:             msgCount.addAndGet(validMsgCnt);\n 52: \n 53:             // è®¡ç®—æ˜¯å¦æ­£åœ¨æ¶ˆè´¹\n 54:             if (!msgTreeMap.isEmpty() && !this.consuming) {\n 55:                 dispatchToConsume = true;\n 56:                 this.consuming = true;\n 57:             }\n 58: \n 59:             // Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡\n 60:             if (!msgs.isEmpty()) {\n 61:                 MessageExt messageExt = msgs.get(msgs.size() - 1);\n 62:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);\n 63:                 if (property != null) {\n 64:                     long accTotal = Long.parseLong(property) - messageExt.getQueueOffset();\n 65:                     if (accTotal > 0) {\n 66:                         this.msgAccCnt = accTotal;\n 67:                     }\n 68:                 }\n 69:             }\n 70:         } finally {\n 71:             this.lockTreeMap.writeLock().unlock();\n 72:         }\n 73:     } catch (InterruptedException e) {\n 74:         log.error(\"putMessage exception\", e);\n 75:     }\n 76: \n 77:     return dispatchToConsume;\n 78: }\n```\n\n## æ€»ç»“\n\nå¦‚æœç”¨æœ€ç®€å•ç²—æš´çš„æ–¹å¼æè¿° `PullConsumer` æ‹‰å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œé‚£å°±æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š\n\n```Java\nwhile (true) {\n    if (ä¸æ»¡è¶³æ‹‰å–æ¶ˆæ¯) {\n        Thread.sleep(é—´éš”);\n        continue;\n    }\n    ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯();\n}\n```\n\n# 6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯\n\n![DefaultMQPushConsumerImplæ¶ˆè´¹æ¶ˆæ¯](http://www.yunai.me/images/RocketMQ/2017_05_04/06.png)\n\n## ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚\n\n### ConsumeMessageConcurrentlyService#submitConsumeRequest(...)\n\n```Java\n  1: /**\n  2:  * æ¶ˆè´¹çº¿ç¨‹æ± é˜Ÿåˆ—\n  3:  */\n  4: private final BlockingQueue<Runnable> consumeRequestQueue;\n  5: /**\n  6:  * æ¶ˆè´¹çº¿ç¨‹æ± \n  7:  */\n  8: private final ThreadPoolExecutor consumeExecutor;\n  9: \n 10: public void submitConsumeRequest(//\n 11:     final List<MessageExt> msgs, //\n 12:     final ProcessQueue processQueue, //\n 13:     final MessageQueue messageQueue, //\n 14:     final boolean dispatchToConsume) {\n 15:     final int consumeBatchSize = this.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();\n 16:     if (msgs.size() <= consumeBatchSize) { // æäº¤æ¶ˆæ¯å°äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚\n 17:         ConsumeRequest consumeRequest = new ConsumeRequest(msgs, processQueue, messageQueue);\n 18:         try {\n 19:             this.consumeExecutor.submit(consumeRequest);\n 20:         } catch (RejectedExecutionException e) {\n 21:             this.submitConsumeRequestLater(consumeRequest);\n 22:         }\n 23:     } else { // æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªæ¶ˆè´¹è¯·æ±‚\n 24:         for (int total = 0; total < msgs.size(); ) {\n 25:             // è®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯\n 26:             List<MessageExt> msgThis = new ArrayList<>(consumeBatchSize);\n 27:             for (int i = 0; i < consumeBatchSize; i++, total++) {\n 28:                 if (total < msgs.size()) {\n 29:                     msgThis.add(msgs.get(total));\n 30:                 } else {\n 31:                     break;\n 32:                 }\n 33:             }\n 34: \n 35:             // æäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚\n 36:             ConsumeRequest consumeRequest = new ConsumeRequest(msgThis, processQueue, messageQueue);\n 37:             try {\n 38:                 this.consumeExecutor.submit(consumeRequest);\n 39:             } catch (RejectedExecutionException e) {\n 40:                 // å¦‚æœè¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯+å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚\n 41:                 for (; total < msgs.size(); total++) {\n 42:                     msgThis.add(msgs.get(total));\n 43:                 }\n 44:                 this.submitConsumeRequestLater(consumeRequest);\n 45:             }\n 46:         }\n 47:     }\n 48: }\n```\n\n* è¯´æ˜ ï¼šæäº¤**ç«‹å³**æ¶ˆè´¹è¯·æ±‚ã€‚\n* ç¬¬ 16 è‡³ 22 è¡Œ ï¼šæäº¤æ¶ˆæ¯å°äºç­‰äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚ã€‚\n* ç¬¬ 23 è‡³ 47 è¡Œ ï¼šå½“æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªè¯·æ±‚ã€‚\n    * ç¬¬ 25 è‡³ 33 è¡Œ ï¼šè®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯ã€‚\n    * ç¬¬ 35 è‡³ 38 è¡Œ ï¼šæäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚ã€‚\n    * ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæäº¤è¯·æ±‚è¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯ + å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ï¼Œç»“æŸæ‹†åˆ†å¾ªç¯ã€‚\n\n### ConsumeMessageConcurrentlyService#submitConsumeRequestLater\n \n ```Java\n   1: /**\n  2:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚\n  3:  *\n  4:  * @param msgs æ¶ˆæ¯åˆ—è¡¨\n  5:  * @param processQueue æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n  6:  * @param messageQueue æ¶ˆæ¯é˜Ÿåˆ—\n  7:  */\n  8: private void submitConsumeRequestLater(//\n  9:     final List<MessageExt> msgs, //\n 10:     final ProcessQueue processQueue, //\n 11:     final MessageQueue messageQueue//\n 12: ) {\n 13: \n 14:     this.scheduledExecutorService.schedule(new Runnable() {\n 15: \n 16:         @Override\n 17:         public void run() {\n 18:             ConsumeMessageConcurrentlyService.this.submitConsumeRequest(msgs, processQueue, messageQueue, true);\n 19:         }\n 20:     }, 5000, TimeUnit.MILLISECONDS);\n 21: }\n 22: \n 23: /**\n 24:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚\n 25:  * @param consumeRequest æ¶ˆè´¹è¯·æ±‚\n 26:  */\n 27: private void submitConsumeRequestLater(final ConsumeRequest consumeRequest//\n 28: ) {\n 29: \n 30:     this.scheduledExecutorService.schedule(new Runnable() {\n 31: \n 32:         @Override\n 33:         public void run() {\n 34:             ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest); // TODO BUG ?\n 35:         }\n 36:     }, 5000, TimeUnit.MILLISECONDS);\n 37: }\n ```\n \n* è¯´æ˜ ï¼šæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚\n* ç¬¬ 34 è¡Œ ï¼šç›´æ¥è°ƒç”¨ `ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);`ã€‚å¦‚æœæ¶ˆæ¯æ•°è¶…è¿‡æ‰¹é‡æ¶ˆè´¹ä¸Šé™ï¼Œä¼šä¸ä¼šæ˜¯**BUG**ã€‚\n \n## ConsumeRequest\n\n```Java\n  1: class ConsumeRequest implements Runnable {\n  2: \n  3:     /**\n  4:      * æ¶ˆè´¹æ¶ˆæ¯åˆ—è¡¨\n  5:      */\n  6:     private final List<MessageExt> msgs;\n  7:     /**\n  8:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n  9:      */\n 10:     private final ProcessQueue processQueue;\n 11:     /**\n 12:      * æ¶ˆæ¯é˜Ÿåˆ—\n 13:      */\n 14:     private final MessageQueue messageQueue;\n 15: \n 16:     public ConsumeRequest(List<MessageExt> msgs, ProcessQueue processQueue, MessageQueue messageQueue) {\n 17:         this.msgs = msgs;\n 18:         this.processQueue = processQueue;\n 19:         this.messageQueue = messageQueue;\n 20:     }\n 21: \n 22:     @Override\n 23:     public void run() {\n 24:         // åºŸå¼ƒé˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹\n 25:         if (this.processQueue.isDropped()) {\n 26:             log.info(\"the message queue not be able to consume, because it's dropped. group={} {}\", ConsumeMessageConcurrentlyService.this.consumerGroup, this.messageQueue);\n 27:             return;\n 28:         }\n 29: \n 30:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.this.messageListener; // ç›‘å¬å™¨\n 31:         ConsumeConcurrentlyContext context = new ConsumeConcurrentlyContext(messageQueue); // æ¶ˆè´¹Context\n 32:         ConsumeConcurrentlyStatus status = null; // æ¶ˆè´¹ç»“æœçŠ¶æ€\n 33: \n 34:         // Hook\n 35:         ConsumeMessageContext consumeMessageContext = null;\n 36:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {\n 37:             consumeMessageContext = new ConsumeMessageContext();\n 38:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());\n 39:             consumeMessageContext.setProps(new HashMap<String, String>());\n 40:             consumeMessageContext.setMq(messageQueue);\n 41:             consumeMessageContext.setMsgList(msgs);\n 42:             consumeMessageContext.setSuccess(false);\n 43:             ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);\n 44:         }\n 45: \n 46:         long beginTimestamp = System.currentTimeMillis();\n 47:         boolean hasException = false;\n 48:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; // æ¶ˆè´¹è¿”å›ç»“æœç±»å‹\n 49:         try {\n 50:             // å½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½®Topicä¸ºåŸå§‹Topic\n 51:             ConsumeMessageConcurrentlyService.this.resetRetryTopic(msgs);\n 52: \n 53:             // è®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´\n 54:             if (msgs != null && !msgs.isEmpty()) {\n 55:                 for (MessageExt msg : msgs) {\n 56:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));\n 57:                 }\n 58:             }\n 59: \n 60:             // è¿›è¡Œæ¶ˆè´¹\n 61:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);\n 62:         } catch (Throwable e) {\n 63:             log.warn(\"consumeMessage exception: {} Group: {} Msgs: {} MQ: {}\",\n 64:                 RemotingHelper.exceptionSimpleDesc(e), //\n 65:                 ConsumeMessageConcurrentlyService.this.consumerGroup,\n 66:                 msgs,\n 67:                 messageQueue);\n 68:             hasException = true;\n 69:         }\n 70: \n 71:         // è§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹\n 72:         long consumeRT = System.currentTimeMillis() - beginTimestamp;\n 73:         if (null == status) {\n 74:             if (hasException) {\n 75:                 returnType = ConsumeReturnType.EXCEPTION;\n 76:             } else {\n 77:                 returnType = ConsumeReturnType.RETURNNULL;\n 78:             }\n 79:         } else if (consumeRT >= defaultMQPushConsumer.getConsumeTimeout() * 60 * 1000) {\n 80:             returnType = ConsumeReturnType.TIME_OUT;\n 81:         } else if (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) {\n 82:             returnType = ConsumeReturnType.FAILED;\n 83:         } else if (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) {\n 84:             returnType = ConsumeReturnType.SUCCESS;\n 85:         }\n 86: \n 87:         // Hook\n 88:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {\n 89:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());\n 90:         }\n 91: \n 92:         // æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç©ºæ—¶ï¼Œåˆ™è®¾ç½®ä¸ºç¨åé‡æ–°æ¶ˆè´¹\n 93:         if (null == status) {\n 94:             log.warn(\"consumeMessage return null, Group: {} Msgs: {} MQ: {}\",\n 95:                 ConsumeMessageConcurrentlyService.this.consumerGroup,\n 96:                 msgs,\n 97:                 messageQueue);\n 98:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;\n 99:         }\n100: \n101:         // Hook\n102:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {\n103:             consumeMessageContext.setStatus(status.toString());\n104:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);\n105:             ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);\n106:         }\n107: \n108:         // ç»Ÿè®¡\n109:         ConsumeMessageConcurrentlyService.this.getConsumerStatsManager()\n110:             .incConsumeRT(ConsumeMessageConcurrentlyService.this.consumerGroup, messageQueue.getTopic(), consumeRT);\n111: \n112:         // å¤„ç†æ¶ˆè´¹ç»“æœ\n113:         if (!processQueue.isDropped()) {\n114:             ConsumeMessageConcurrentlyService.this.processConsumeResult(status, context, this);\n115:         } else {\n116:             log.warn(\"processQueue is dropped without process consume result. messageQueue={}, msgs={}\", messageQueue, msgs);\n117:         }\n118:     }\n119: \n120: }\n```\n\n* è¯´æ˜ ï¼šæ¶ˆè´¹è¯·æ±‚ã€‚æäº¤è¯·æ±‚æ‰§è¡Œæ¶ˆè´¹ã€‚\n* ç¬¬ 24 è‡³ 28 è¡Œ ï¼šåºŸå¼ƒå¤„ç†é˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹ã€‚\n* ç¬¬ 34 è‡³ 44 è¡Œ ï¼šHookã€‚\n* ç¬¬ 51 è¡Œ ï¼šå½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½® `Topic`ä¸ºåŸå§‹ `Topic`ã€‚ä¾‹å¦‚ï¼šåŸå§‹ `Topic` ä¸º `TopicTest`ï¼Œé‡è¯•æ—¶ `Topic` ä¸º `%RETRY%please_rename_unique_group_name_4`ï¼Œç»è¿‡è¯¥æ–¹æ³•ï¼Œ`Topic` è®¾ç½®å› `TopicTest`ã€‚\n* ç¬¬ 53 è‡³ 58 è¡Œ ï¼šè®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´ã€‚\n* ç¬¬ 61 è¡Œ ï¼š**è¿›è¡Œæ¶ˆè´¹**ã€‚\n* ç¬¬ 71 è‡³ 85 è¡Œ ï¼šè§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹\n* ç¬¬ 87 è‡³ 90 è¡Œ ï¼š`Hook`ã€‚\n* ç¬¬ 92 è‡³ 99 è¡Œ ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€æœªç©ºæ—¶ï¼Œåˆ™è®¾ç½®æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç¨åæ¶ˆè´¹ã€‚\n* ç¬¬ 101 è‡³ 106 è¡Œ ï¼š`Hook`ã€‚\n* ç¬¬ 108 è‡³ 110 è¡Œ ï¼šç»Ÿè®¡ã€‚\n* ç¬¬ 112 è‡³ 117 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚**å¦‚æœæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—è¢«ç§»é™¤ï¼Œæ°å¥½æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§**ã€‚è¯¦ç»†è§£æè§ï¼š[ConsumeMessageConcurrentlyService#processConsumeResult(...)](#consumemessageconcurrentlyserviceprocessconsumeresult)ã€‚\n\n## ConsumeMessageConcurrentlyService#processConsumeResult(...)\n\n```Java\n  1: public void processConsumeResult(//\n  2:     final ConsumeConcurrentlyStatus status, //\n  3:     final ConsumeConcurrentlyContext context, //\n  4:     final ConsumeRequest consumeRequest//\n  5: ) {\n  6:     int ackIndex = context.getAckIndex();\n  7: \n  8:     // æ¶ˆæ¯ä¸ºç©ºï¼Œç›´æ¥è¿”å›\n  9:     if (consumeRequest.getMsgs().isEmpty())\n 10:         return;\n 11: \n 12:     // è®¡ç®—ä»consumeRequest.msgs[0]åˆ°consumeRequest.msgs[ackIndex]çš„æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ\n 13:     switch (status) {\n 14:         case CONSUME_SUCCESS:\n 15:             if (ackIndex >= consumeRequest.getMsgs().size()) {\n 16:                 ackIndex = consumeRequest.getMsgs().size() - 1;\n 17:             }\n 18:             // ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡\n 19:             int ok = ackIndex + 1;\n 20:             int failed = consumeRequest.getMsgs().size() - ok;\n 21:             this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);\n 22:             this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);\n 23:             break;\n 24:         case RECONSUME_LATER:\n 25:             ackIndex = -1;\n 26:             // ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡\n 27:             this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),\n 28:                 consumeRequest.getMsgs().size());\n 29:             break;\n 30:         default:\n 31:             break;\n 32:     }\n 33: \n 34:     // å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯\n 35:     switch (this.defaultMQPushConsumer.getMessageModel()) {\n 36:         case BROADCASTING: // å¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ°Brokerï¼Œåªæ‰“å°Log\n 37:             for (int i = ackIndex + 1; i < consumeRequest.getMsgs().size(); i++) {\n 38:                 MessageExt msg = consumeRequest.getMsgs().get(i);\n 39:                 log.warn(\"BROADCASTING, the message consume failed, drop it, {}\", msg.toString());\n 40:             }\n 41:             break;\n 42:         case CLUSTERING:\n 43:             // å‘å›æ¶ˆæ¯å¤±è´¥åˆ°Brokerã€‚\n 44:             List<MessageExt> msgBackFailed = new ArrayList<>(consumeRequest.getMsgs().size());\n 45:             for (int i = ackIndex + 1; i < consumeRequest.getMsgs().size(); i++) {\n 46:                 MessageExt msg = consumeRequest.getMsgs().get(i);\n 47:                 boolean result = this.sendMessageBack(msg, context);\n 48:                 if (!result) {\n 49:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);\n 50:                     msgBackFailed.add(msg);\n 51:                 }\n 52:             }\n 53: \n 54:             // å‘å›Brokerå¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹\n 55:             if (!msgBackFailed.isEmpty()) {\n 56:                 consumeRequest.getMsgs().removeAll(msgBackFailed);\n 57: \n 58:                 this.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());\n 59:             }\n 60:             break;\n 61:         default:\n 62:             break;\n 63:     }\n 64: \n 65:     // ç§»é™¤æ¶ˆè´¹æˆåŠŸæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦\n 66:     long offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());\n 67:     if (offset >= 0 && !consumeRequest.getProcessQueue().isDropped()) {\n 68:         this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, true);\n 69:     }\n 70: }\n```\n\n* è¯´æ˜ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚\n* ç¬¬ 8 è‡³ 10 è¡Œ ï¼šæ¶ˆè´¹è¯·æ±‚æ¶ˆæ¯æœªç©ºæ—¶ï¼Œç›´æ¥è¿”å›ã€‚\n* ç¬¬ 12 è‡³ 32 è¡Œ ï¼šè®¡ç®— `ackIndex` å€¼ã€‚`consumeRequest.msgs[0 - ackIndex]`ä¸ºæ¶ˆè´¹æˆåŠŸï¼Œéœ€è¦è¿›è¡Œ `ack` ç¡®è®¤ã€‚\n    * ç¬¬ 14 è‡³ 23 è¡Œ ï¼š`CONSUME_SUCCESS` ï¼š`ackIndex = context.getAckIndex()`ã€‚\n    * ç¬¬ 24 è‡³ 29 è¡Œ ï¼š`RECONSUME_LATER` ï¼š`ackIndex = -1`ã€‚\n* ç¬¬34 è‡³ 63 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ã€‚\n    * ç¬¬ 36 è‡³ 41 è¡Œ ï¼š`BROADCASTING` ï¼šå¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ° `Broker`ï¼Œåªæ‰“å°æ—¥å¿—ã€‚\n    * ç¬¬ 42 è‡³ 60 è¡Œ ï¼š`CLUSTERING` ï¼šé›†ç¾¤æ¨¡å¼ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å›åˆ° `Broker`ã€‚\n        * ç¬¬ 43 è‡³ 52 è¡Œ ï¼šå‘å›æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯åˆ° `Broker`ã€‚è¯¦ç»†è§£æè§ï¼š[DefaultMQPushConsumerImpl#sendMessageBack(...)](#defaultmqpushconsumerimplsendmessageback)ã€‚\n        * ç¬¬ 54 è‡³ 59 è¡Œ ï¼šå‘å› `Broker` å¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹ã€‚\n        * **å¦‚æœå‘å› `Broker` æˆåŠŸï¼Œç»“æœå› ä¸ºä¾‹å¦‚ç½‘ç»œå¼‚å¸¸ï¼Œå¯¼è‡´ `Consumer`ä»¥ä¸ºå‘å›å¤±è´¥ï¼Œåˆ¤å®šæ¶ˆè´¹å‘å›å¤±è´¥ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§ã€‚**\n* ç¬¬ 65 è‡³ 69 è¡Œ ï¼šç§»é™¤**ã€æ¶ˆè´¹æˆåŠŸã€‘**å’Œ**ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›`Broker`æˆåŠŸã€‘**çš„æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦ã€‚\n    * ä¸ºä»€ä¹ˆä¼šæœ‰**ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›`Broker`æˆåŠŸã€‘**çš„æ¶ˆæ¯ï¼Ÿè§**ç¬¬ 56 è¡Œ**ã€‚\n    * [ProcessQueue#removeMessage(...)](#processqueueremovemessage)\n\n### ProcessQueue#removeMessage(...)\n\n```Java\n  1: /**\n  2:  * ç§»é™¤æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç¬¬ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n  3:  *\n  4:  * @param msgs æ¶ˆæ¯\n  5:  * @return æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n  6:  */\n  7: public long removeMessage(final List<MessageExt> msgs) {\n  8:     long result = -1;\n  9:     final long now = System.currentTimeMillis();\n 10:     try {\n 11:         this.lockTreeMap.writeLock().lockInterruptibly();\n 12:         this.lastConsumeTimestamp = now;\n 13:         try {\n 14:             if (!msgTreeMap.isEmpty()) {\n 15:                 result = this.queueOffsetMax + 1; // è¿™é‡Œ+1çš„åŸå› æ˜¯ï¼šå¦‚æœmsgTreeMapä¸ºç©ºæ—¶ï¼Œä¸‹ä¸€æ¡è·å¾—çš„æ¶ˆæ¯ä½ç½®ä¸ºqueueOffsetMax+1\n 16: \n 17:                 // ç§»é™¤æ¶ˆæ¯\n 18:                 int removedCnt = 0;\n 19:                 for (MessageExt msg : msgs) {\n 20:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());\n 21:                     if (prev != null) {\n 22:                         removedCnt--;\n 23:                     }\n 24:                 }\n 25:                 msgCount.addAndGet(removedCnt);\n 26: \n 27:                 if (!msgTreeMap.isEmpty()) {\n 28:                     result = msgTreeMap.firstKey();\n 29:                 }\n 30:             }\n 31:         } finally {\n 32:             this.lockTreeMap.writeLock().unlock();\n 33:         }\n 34:     } catch (Throwable t) {\n 35:         log.error(\"removeMessage exception\", t);\n 36:     }\n 37: \n 38:     return result;\n 39: }\n```\n\n## ConsumeMessageConcurrentlyService#cleanExpireMsg(...)\n\n```Java\n  1: public void start() {\n  2:     this.cleanExpireMsgExecutors.scheduleAtFixedRate(new Runnable() {\n  3: \n  4:         @Override\n  5:         public void run() {\n  6:             cleanExpireMsg();\n  7:         }\n  8: \n  9:     }, this.defaultMQPushConsumer.getConsumeTimeout(), this.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);\n 10: }\n 11: \n 12: /**\n 13:  * æ¸…ç†è¿‡æœŸæ¶ˆæ¯\n 14:  */\n 15: private void cleanExpireMsg() {\n 16:     Iterator<Map.Entry<MessageQueue, ProcessQueue>> it =\n 17:         this.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();\n 18:     while (it.hasNext()) {\n 19:         Map.Entry<MessageQueue, ProcessQueue> next = it.next();\n 20:         ProcessQueue pq = next.getValue();\n 21:         pq.cleanExpiredMsg(this.defaultMQPushConsumer);\n 22:     }\n 23: }\n```\n\n* è¯´æ˜ ï¼šå®šæ—¶æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼Œé»˜è®¤å‘¨æœŸï¼š15minã€‚\n\n### ProcessQueue#cleanExpiredMsg(...)\n\n```Java\n  1: public void cleanExpiredMsg(DefaultMQPushConsumer pushConsumer) {\n  2:     // é¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›\n  3:     if (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) {\n  4:         return;\n  5:     }\n  6: \n  7:     // å¾ªç¯ç§»é™¤æ¶ˆæ¯\n  8:     int loop = msgTreeMap.size() < 16 ? msgTreeMap.size() : 16; // æ¯æ¬¡å¾ªç¯æœ€å¤šç§»é™¤16æ¡\n  9:     for (int i = 0; i < loop; i++) {\n 10:         // è·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯\n 11:         MessageExt msg = null;\n 12:         try {\n 13:             this.lockTreeMap.readLock().lockInterruptibly();\n 14:             try {\n 15:                 if (!msgTreeMap.isEmpty() && System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) > pushConsumer.getConsumeTimeout() * 60 * 1000) {\n 16:                     msg = msgTreeMap.firstEntry().getValue();\n 17:                 } else {\n 18:                     break;\n 19:                 }\n 20:             } finally {\n 21:                 this.lockTreeMap.readLock().unlock();\n 22:             }\n 23:         } catch (InterruptedException e) {\n 24:             log.error(\"getExpiredMsg exception\", e);\n 25:         }\n 26: \n 27:         try {\n 28:             // å‘å›è¶…æ—¶æ¶ˆæ¯\n 29:             pushConsumer.sendMessageBack(msg, 3);\n 30:             log.info(\"send expire msg back. topic={}, msgId={}, storeHost={}, queueId={}, queueOffset={}\", msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());\n 31: \n 32:             // åˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤\n 33:             try {\n 34:                 this.lockTreeMap.writeLock().lockInterruptibly();\n 35:                 try {\n 36:                     if (!msgTreeMap.isEmpty() && msg.getQueueOffset() == msgTreeMap.firstKey()) {\n 37:                         try {\n 38:                             msgTreeMap.remove(msgTreeMap.firstKey());\n 39:                         } catch (Exception e) {\n 40:                             log.error(\"send expired msg exception\", e);\n 41:                         }\n 42:                     }\n 43:                 } finally {\n 44:                     this.lockTreeMap.writeLock().unlock();\n 45:                 }\n 46:             } catch (InterruptedException e) {\n 47:                 log.error(\"getExpiredMsg exception\", e);\n 48:             }\n 49:         } catch (Exception e) {\n 50:             log.error(\"send expired msg exception\", e);\n 51:         }\n 52:     }\n 53: }\n```\n\n* è¯´æ˜ ï¼šç§»é™¤è¿‡æœŸæ¶ˆæ¯ã€‚\n* ç¬¬ 2 è‡³ 5 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚\n* ç¬¬ 7 è‡³ 9 è¡Œ ï¼šå¾ªç¯ç§»é™¤æ¶ˆæ¯ã€‚é»˜è®¤æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼š16æ¬¡ã€‚\n* ç¬¬ 10 è‡³ 25 è¡Œ ï¼šè·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚\n* ç¬¬ 29 è¡Œ ï¼š**å‘å›è¶…æ—¶æ¶ˆæ¯åˆ°`Broker`**ã€‚\n* ç¬¬ 32 è‡³ 48 è¡Œ ï¼šåˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤ã€‚\n\n# 7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯\n\n## DefaultMQPushConsumerImpl#sendMessageBack(...)\n\n```Java\n  1: public void sendMessageBack(MessageExt msg, int delayLevel, final String brokerName)\n  2:     throws RemotingException, MQBrokerException, InterruptedException, MQClientException {\n  3:     try {\n  4:         // Consumerå‘å›æ¶ˆæ¯\n  5:         String brokerAddr = (null != brokerName) ? this.mQClientFactory.findBrokerAddressInPublish(brokerName)\n  6:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());\n  7:         this.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,\n  8:             this.defaultMQPushConsumer.getConsumerGroup(), delayLevel, 5000, getMaxReconsumeTimes());\n  9:     } catch (Exception e) { // TODO ç–‘é—®ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸\n 10:         // å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨Clientå†…ç½®Producerå‘å›æ¶ˆæ¯\n 11:         log.error(\"sendMessageBack Exception, \" + this.defaultMQPushConsumer.getConsumerGroup(), e);\n 12: \n 13:         Message newMsg = new Message(MixAll.getRetryTopic(this.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());\n 14: \n 15:         String originMsgId = MessageAccessor.getOriginMessageId(msg);\n 16:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);\n 17: \n 18:         newMsg.setFlag(msg.getFlag());\n 19:         MessageAccessor.setProperties(newMsg, msg.getProperties());\n 20:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());\n 21:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + 1));\n 22:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));\n 23:         newMsg.setDelayTimeLevel(3 + msg.getReconsumeTimes());\n 24: \n 25:         this.mQClientFactory.getDefaultMQProducer().send(newMsg);\n 26:     }\n 27: }\n```\n\n* è¯´æ˜ ï¼šå‘å›æ¶ˆæ¯ã€‚\n* ç¬¬ 4 è‡³ 8 è¡Œ ï¼š`Consumer` å‘å›æ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š[MQClientAPIImpl#consumerSendMessageBack(...)](#mqclientapiimplconsumersendmessageback)ã€‚\n* ç¬¬ 10 è‡³ 25 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ`Consumer` å†…ç½®é»˜è®¤ `Producer` å‘é€æ¶ˆæ¯ã€‚\n    * ğŸ˜ˆç–‘é—®ï¼šä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸å‘¢ï¼Ÿ\n\n### MQClientAPIImpl#consumerSendMessageBack(...)\n\n```Java\n  1: /**\n  2:  * Consumerå‘å›æ¶ˆæ¯\n  3:  * @param addr Brokeråœ°å€\n  4:  * @param msg æ¶ˆæ¯\n  5:  * @param consumerGroup æ¶ˆè´¹åˆ†ç»„\n  6:  * @param delayLevel å»¶è¿Ÿçº§åˆ«\n  7:  * @param timeoutMillis è¶…æ—¶\n  8:  * @param maxConsumeRetryTimes æ¶ˆè´¹æœ€å¤§é‡è¯•æ¬¡æ•°\n  9:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶\n 10:  * @throws MQBrokerException å½“Brokerå‘ç”Ÿå¼‚å¸¸æ—¶\n 11:  * @throws InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶\n 12:  */\n 13: public void consumerSendMessageBack(\n 14:     final String addr,\n 15:     final MessageExt msg,\n 16:     final String consumerGroup,\n 17:     final int delayLevel,\n 18:     final long timeoutMillis,\n 19:     final int maxConsumeRetryTimes\n 20: ) throws RemotingException, MQBrokerException, InterruptedException {\n 21:     ConsumerSendMsgBackRequestHeader requestHeader = new ConsumerSendMsgBackRequestHeader();\n 22:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);\n 23: \n 24:     requestHeader.setGroup(consumerGroup);\n 25:     requestHeader.setOriginTopic(msg.getTopic());\n 26:     requestHeader.setOffset(msg.getCommitLogOffset());\n 27:     requestHeader.setDelayLevel(delayLevel);\n 28:     requestHeader.setOriginMsgId(msg.getMsgId());\n 29:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);\n 30: \n 31:     RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),\n 32:         request, timeoutMillis);\n 33:     assert response != null;\n 34:     switch (response.getCode()) {\n 35:         case ResponseCode.SUCCESS: {\n 36:             return;\n 37:         }\n 38:         default:\n 39:             break;\n 40:     }\n 41: \n 42:     throw new MQBrokerException(response.getCode(), response.getRemark());\n 43: }\n```\n\n# 8ã€Consumer æ¶ˆè´¹è¿›åº¦\n\n## OffsetStore\n\n![OffsetStoreç±»å›¾.png](http://www.yunai.me/images/RocketMQ/2017_05_04/07.png)\n\n* `RemoteBrokerOffsetStore` ï¼š`Consumer` **é›†ç¾¤æ¨¡å¼** ä¸‹ï¼Œä½¿ç”¨è¿œç¨‹ `Broker` æ¶ˆè´¹è¿›åº¦ã€‚\n* `LocalFileOffsetStore` ï¼š`Consumer` **å¹¿æ’­æ¨¡å¼**ä¸‹ï¼Œä½¿ç”¨æœ¬åœ° `æ–‡ä»¶` æ¶ˆè´¹è¿›åº¦ã€‚\n\n### OffsetStore#load(...)\n\n#### LocalFileOffsetStore#load(...)\n\n```Java\n  1: @Override\n  2: public void load() throws MQClientException {\n  3:     // ä»æœ¬åœ°ç¡¬ç›˜è¯»å–æ¶ˆè´¹è¿›åº¦\n  4:     OffsetSerializeWrapper offsetSerializeWrapper = this.readLocalOffset();\n  5:     if (offsetSerializeWrapper != null && offsetSerializeWrapper.getOffsetTable() != null) {\n  6:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());\n  7: \n  8:         // æ‰“å°æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦\n  9:         for (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) {\n 10:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);\n 11:             log.info(\"load consumer's offset, {} {} {}\",\n 12:                 this.groupName,\n 13:                 mq,\n 14:                 offset.get());\n 15:         }\n 16:     }\n 17: }\n```\n\n* è¯´æ˜ ï¼šä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ¶ˆè´¹è¿›åº¦åˆ°å†…å­˜ã€‚\n\n##### OffsetSerializeWrapper\n\n```Java\n  1: public class OffsetSerializeWrapper extends RemotingSerializable {\n  2:     private ConcurrentHashMap<MessageQueue, AtomicLong> offsetTable =\n  3:             new ConcurrentHashMap<>();\n  4: \n  5:     public ConcurrentHashMap<MessageQueue, AtomicLong> getOffsetTable() {\n  6:         return offsetTable;\n  7:     }\n  8: \n  9:     public void setOffsetTable(ConcurrentHashMap<MessageQueue, AtomicLong> offsetTable) {\n 10:         this.offsetTable = offsetTable;\n 11:     }\n 12: }\n```\n\n* è¯´æ˜ ï¼šæœ¬åœ° `Offset` å­˜å‚¨åºåˆ—åŒ–ã€‚\n\n```Bash\nYunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json\n{\n\t\"offsetTable\":{{\n\t\t\t\"brokerName\":\"broker-a\",\n\t\t\t\"queueId\":3,\n\t\t\t\"topic\":\"TopicTest\"\n\t\t}:1470,{\n\t\t\t\"brokerName\":\"broker-a\",\n\t\t\t\"queueId\":2,\n\t\t\t\"topic\":\"TopicTest\"\n\t\t}:1471,{\n\t\t\t\"brokerName\":\"broker-a\",\n\t\t\t\"queueId\":1,\n\t\t\t\"topic\":\"TopicTest\"\n\t\t}:1470,{\n\t\t\t\"brokerName\":\"broker-a\",\n\t\t\t\"queueId\":0,\n\t\t\t\"topic\":\"TopicTest\"\n\t\t}:1470\n\t}\n}\n```\n\n#### RemoteBrokerOffsetStore#load(...)\n\n```Java\n  1: @Override\n  2: public void load() {\n  3: }\n```\n\n* è¯´æ˜ ï¼šä¸è¿›è¡ŒåŠ è½½ï¼Œå®é™…è¯»å–æ¶ˆè´¹è¿›åº¦æ—¶ï¼Œä» `Broker` è·å–ã€‚\n\n### OffsetStore#readOffset(...)\n\nè¯»å–æ¶ˆè´¹è¿›åº¦ç±»å‹ï¼š\n\n* `READ_FROM_MEMORY` ï¼šä»å†…å­˜è¯»å–ã€‚\n* `READ_FROM_STORE` ï¼šä»å­˜å‚¨( `Broker` æˆ– `æ–‡ä»¶` )è¯»å–ã€‚\n* `MEMORY_FIRST_THEN_STORE` ï¼šä¼˜å…ˆä»å†…å­˜è¯»å–ï¼Œè¯»å–ä¸åˆ°ï¼Œä»å­˜å‚¨è¯»å–ã€‚\n\n#### LocalFileOffsetStore#readOffset(...)\n\n```Java\n  1: @Override\n  2: public long readOffset(final MessageQueue mq, final ReadOffsetType type) {\n  3:     if (mq != null) {\n  4:         switch (type) {\n  5:             case MEMORY_FIRST_THEN_STORE:\n  6:             case READ_FROM_MEMORY: {\n  7:                 AtomicLong offset = this.offsetTable.get(mq);\n  8:                 if (offset != null) {\n  9:                     return offset.get();\n 10:                 } else if (ReadOffsetType.READ_FROM_MEMORY == type) {\n 11:                     return -1;\n 12:                 }\n 13:             }\n 14:             case READ_FROM_STORE: {\n 15:                 OffsetSerializeWrapper offsetSerializeWrapper;\n 16:                 try {\n 17:                     offsetSerializeWrapper = this.readLocalOffset();\n 18:                 } catch (MQClientException e) {\n 19:                     return -1;\n 20:                 }\n 21:                 if (offsetSerializeWrapper != null && offsetSerializeWrapper.getOffsetTable() != null) {\n 22:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);\n 23:                     if (offset != null) {\n 24:                         this.updateOffset(mq, offset.get(), false);\n 25:                         return offset.get();\n 26:                     }\n 27:                 }\n 28:             }\n 29:             default:\n 30:                 break;\n 31:         }\n 32:     }\n 33: \n 34:     return -1;\n 35: }\n```\n\n* ç¬¬ 16 è¡Œ ï¼šä» `æ–‡ä»¶` è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚\n\n#### RemoteBrokerOffsetStore#readOffset(...)\n\n```Java\n  1: @Override\n  2: public long readOffset(final MessageQueue mq, final ReadOffsetType type) {\n  3:     if (mq != null) {\n  4:         switch (type) {\n  5:             case MEMORY_FIRST_THEN_STORE:\n  6:             case READ_FROM_MEMORY: {\n  7:                 AtomicLong offset = this.offsetTable.get(mq);\n  8:                 if (offset != null) {\n  9:                     return offset.get();\n 10:                 } else if (ReadOffsetType.READ_FROM_MEMORY == type) {\n 11:                     return -1;\n 12:                 }\n 13:             }\n 14:             case READ_FROM_STORE: {\n 15:                 try {\n 16:                     long brokerOffset = this.fetchConsumeOffsetFromBroker(mq);\n 17:                     AtomicLong offset = new AtomicLong(brokerOffset);\n 18:                     this.updateOffset(mq, offset.get(), false);\n 19:                     return brokerOffset;\n 20:                 }\n 21:                 // No offset in broker\n 22:                 catch (MQBrokerException e) {\n 23:                     return -1;\n 24:                 }\n 25:                 //Other exceptions\n 26:                 catch (Exception e) {\n 27:                     log.warn(\"fetchConsumeOffsetFromBroker exception, \" + mq, e);\n 28:                     return -2;\n 29:                 }\n 30:             }\n 31:             default:\n 32:                 break;\n 33:         }\n 34:     }\n 35: \n 36:     return -1;\n 37: }\n```\n\n* ç¬¬ 16 è¡Œ ï¼šä» `Broker` è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚\n\n### OffsetStore#updateOffset(...)\n\nè¯¥æ–¹æ³• `RemoteBrokerOffsetStore` ä¸ `LocalFileOffsetStore` å®ç°ç›¸åŒã€‚\n\n```Java\n  1: @Override\n  2: public void updateOffset(MessageQueue mq, long offset, boolean increaseOnly) {\n  3:     if (mq != null) {\n  4:         AtomicLong offsetOld = this.offsetTable.get(mq);\n  5:         if (null == offsetOld) {\n  6:             offsetOld = this.offsetTable.putIfAbsent(mq, new AtomicLong(offset));\n  7:         }\n  8: \n  9:         if (null != offsetOld) {\n 10:             if (increaseOnly) {\n 11:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);\n 12:             } else {\n 13:                 offsetOld.set(offset);\n 14:             }\n 15:         }\n 16:     }\n 17: }\n```\n\n### OffsetStore#persistAll(...)\n\n#### LocalFileOffsetStore#persistAll(...)\n\n```Java\n  1: @Override\n  2: public void persistAll(Set<MessageQueue> mqs) {\n  3:     if (null == mqs || mqs.isEmpty())\n  4:         return;\n  5: \n  6:     OffsetSerializeWrapper offsetSerializeWrapper = new OffsetSerializeWrapper();\n  7:     for (Map.Entry<MessageQueue, AtomicLong> entry : this.offsetTable.entrySet()) {\n  8:         if (mqs.contains(entry.getKey())) {\n  9:             AtomicLong offset = entry.getValue();\n 10:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);\n 11:         }\n 12:     }\n 13: \n 14:     String jsonString = offsetSerializeWrapper.toJson(true);\n 15:     if (jsonString != null) {\n 16:         try {\n 17:             MixAll.string2File(jsonString, this.storePath);\n 18:         } catch (IOException e) {\n 19:             log.error(\"persistAll consumer offset Exception, \" + this.storePath, e);\n 20:         }\n 21:     }\n 22: }\n```\n\n* è¯´æ˜ ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ã€‚**å°†æ¶ˆè´¹è¿›åº¦å†™å…¥æ–‡ä»¶**ã€‚\n\n#### RemoteBrokerOffsetStore#persistAll(...)\n\n```Java\n  1: @Override\n  2: public void persistAll(Set<MessageQueue> mqs) {\n  3:     if (null == mqs || mqs.isEmpty())\n  4:         return;\n  5: \n  6:     // æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—\n  7:     final HashSet<MessageQueue> unusedMQ = new HashSet<>();\n  8:     if (!mqs.isEmpty()) {\n  9:         for (Map.Entry<MessageQueue, AtomicLong> entry : this.offsetTable.entrySet()) {\n 10:             MessageQueue mq = entry.getKey();\n 11:             AtomicLong offset = entry.getValue();\n 12:             if (offset != null) {\n 13:                 if (mqs.contains(mq)) {\n 14:                     try {\n 15:                         this.updateConsumeOffsetToBroker(mq, offset.get());\n 16:                         log.info(\"[persistAll] Group: {} ClientId: {} updateConsumeOffsetToBroker {} {}\",\n 17:                             this.groupName,\n 18:                             this.mQClientFactory.getClientId(),\n 19:                             mq,\n 20:                             offset.get());\n 21:                     } catch (Exception e) {\n 22:                         log.error(\"updateConsumeOffsetToBroker exception, \" + mq.toString(), e);\n 23:                     }\n 24:                 } else {\n 25:                     unusedMQ.add(mq);\n 26:                 }\n 27:             }\n 28:         }\n 29:     }\n 30: \n 31:     // ç§»é™¤ä¸é€‚ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—\n 32:     if (!unusedMQ.isEmpty()) {\n 33:         for (MessageQueue mq : unusedMQ) {\n 34:             this.offsetTable.remove(mq);\n 35:             log.info(\"remove unused mq, {}, {}\", mq, this.groupName);\n 36:         }\n 37:     }\n 38: }\n```\n\n* è¯´æ˜ ï¼šæŒä¹…åŒ–æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„çš„æ¶ˆè´¹è¿›åº¦åˆ° `Broker`ï¼Œå¹¶ç§»é™¤éæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚\n\n#### MQClientInstance#persistAllConsumerOffset(...)\n\n```Java\n  1: private void startScheduledTask() {\n  2:     // å®šæ—¶åŒæ­¥æ¶ˆè´¹è¿›åº¦\n  3:     this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n  4: \n  5:         @Override\n  6:         public void run() {\n  7:             try {\n  8:                 MQClientInstance.this.cleanOfflineBroker();\n  9:                 MQClientInstance.this.sendHeartbeatToAllBrokerWithLock();\n 10:             } catch (Exception e) {\n 11:                 log.error(\"ScheduledTask sendHeartbeatToAllBroker exception\", e);\n 12:             }\n 13:         }\n 14:     }, 1000, this.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);\n 15: }\n```\n\n* è¯´æ˜ ï¼šå®šæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œé»˜è®¤å‘¨æœŸï¼š5000msã€‚\n* **é‡è¦è¯´æ˜ ï¼š**\n    * **æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚** \n    * **æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚** \n    * **æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚** \n\n# 9ã€ç»“å°¾\n\nğŸ˜ˆå¯èƒ½æ˜¯æœ¬ç³»åˆ—æœ€é•¿çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœ‰è¡¨è¾¾é”™è¯¯å’Œä¸æ¸…æ™°ï¼Œè¯·å¤šå¤šè§è°…ã€‚  \næ„Ÿè°¢å¯¹æœ¬ç³»åˆ—çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯ç¿»åˆ°ç»“å°¾ã€‚ğŸ˜œçœŸçš„æœ‰ä¸¢ä¸¢é•¿ã€‚\n\n\n","source":"_posts/RocketMQ/2017_05_11_RocketMQæºç åˆ†æâ€”â€”Messageæ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰.md","raw":"title: RocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸‹ï¼‰\ndate: 2017-05-11\ntags:\ncategories: RocketMQ\npermalink: RocketMQ/message-pull-and-consume-second\n\n-------\n\n>  åŸæ–‡åœ°å€ï¼š[http://www.yunai.me/RocketMQ/message-pull-and-consume-second/](http://www.yunai.me/RocketMQ/message-pull-and-consume-second/)  \n> `RocketMQ` **å¸¦æ³¨é‡Šæºç **åœ°å€ ï¼š[https://github.com/YunaiV/incubator-rocketmq](https://github.com/YunaiV/incubator-rocketmq)  \n> **ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **  \n\n![wechat_mp](http://www.yunai.me/images/common/wechat_mp.jpeg)\n\n-------\n\n- [1ã€æ¦‚è¿°](#)\n- [2ã€Consumer](#)\n- [3ã€PushConsumer ä¸€è§ˆ](#)\n- [4ã€PushConsumer è®¢é˜…](#)\n\t- [DefaultMQPushConsumerImpl#subscribe(...)](#)\n\t\t- [FilterAPI.buildSubscriptionData(...)](#)\n\t- [DefaultMQPushConsumer#registerMessageListener(...)](#)\n- [5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…](#)\n\t- [RebalanceService](#)\n\t- [MQClientInstance#doRebalance(...)](#)\n\t- [DefaultMQPushConsumerImpl#doRebalance(...)](#)\n\t- [RebalanceImpl#doRebalance(...)](#)\n\t\t- [RebalanceImpl#rebalanceByTopic(...)](#)\n\t\t- [RebalanceImpl#removeUnnecessaryMessageQueue(...)](#)\n\t\t\t- [RebalancePushImpl#removeUnnecessaryMessageQueue(...)](#)\n\t\t\t- [[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(...)](#)\n\t\t- [RebalancePushImpl#dispatchPullRequest(...)](#)\n\t\t\t- [DefaultMQPushConsumerImpl#executePullRequestImmediately(...)](#)\n\t\t- [AllocateMessageQueueStrategy](#)\n\t\t\t- [AllocateMessageQueueAveragely](#)\n\t\t\t- [AllocateMessageQueueByMachineRoom](#)\n\t\t\t- [AllocateMessageQueueAveragelyByCircle](#)\n\t\t\t- [AllocateMessageQueueByConfig](#)\n- [5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–](#)\n\t- [RebalancePushImpl#computePullFromWhere(...)](#)\n\t- [[PullConsumer] RebalancePullImpl#computePullFromWhere(...)](#)\n- [6ã€PushConsumer æ‹‰å–æ¶ˆæ¯](#)\n\t- [PullMessageService](#)\n\t- [DefaultMQPushConsumerImpl#pullMessage(...)](#)\n\t\t- [PullAPIWrapper#pullKernelImpl(...)](#)\n\t\t\t- [PullAPIWrapper#recalculatePullFromWhichNode(...)](#)\n\t\t\t- [MQClientInstance#findBrokerAddressInSubscribe(...)](#)\n\t\t- [PullAPIWrapper#processPullResult(...)](#)\n\t\t- [ProcessQueue#putMessage(...)](#)\n\t- [æ€»ç»“](#)\n- [6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯](#)\n\t- [ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚](#)\n\t\t- [ConsumeMessageConcurrentlyService#submitConsumeRequest(...)](#)\n\t\t- [ConsumeMessageConcurrentlyService#submitConsumeRequestLater](#)\n\t- [ConsumeRequest](#)\n\t- [ConsumeMessageConcurrentlyService#processConsumeResult(...)](#)\n\t\t- [ProcessQueue#removeMessage(...)](#)\n\t- [ConsumeMessageConcurrentlyService#cleanExpireMsg(...)](#)\n\t\t- [ProcessQueue#cleanExpiredMsg(...)](#)\n- [7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯](#)\n\t- [DefaultMQPushConsumerImpl#sendMessageBack(...)](#)\n\t\t- [MQClientAPIImpl#consumerSendMessageBack(...)](#)\n- [8ã€Consumer æ¶ˆè´¹è¿›åº¦](#)\n\t- [OffsetStore](#)\n\t\t- [OffsetStore#load(...)](#)\n\t\t\t- [LocalFileOffsetStore#load(...)](#)\n\t\t\t\t- [OffsetSerializeWrapper](#)\n\t\t\t- [RemoteBrokerOffsetStore#load(...)](#)\n\t\t- [OffsetStore#readOffset(...)](#)\n\t\t\t- [LocalFileOffsetStore#readOffset(...)](#)\n\t\t\t- [RemoteBrokerOffsetStore#readOffset(...)](#)\n\t\t- [OffsetStore#updateOffset(...)](#)\n\t\t- [OffsetStore#persistAll(...)](#)\n\t\t\t- [LocalFileOffsetStore#persistAll(...)](#)\n\t\t\t- [RemoteBrokerOffsetStore#persistAll(...)](#)\n\t\t\t- [MQClientInstance#persistAllConsumerOffset(...)](#)\n- [9ã€ç»“å°¾](#)\n\n-------\n\n# 1ã€æ¦‚è¿°\n\næœ¬æ–‡æ¥ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ã€‹](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/)ã€‚\n\nä¸»è¦è§£æ `Consumer` åœ¨ **æ¶ˆè´¹** é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚\n\n# 2ã€Consumer\n\nMQ æä¾›äº†ä¸¤ç±»æ¶ˆè´¹è€…ï¼š\n\n* PushConsumerï¼š\n    * åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ä½¿ç”¨ã€‚\n    * åå­—è™½ç„¶æ˜¯ `Push` å¼€å¤´ï¼Œå®é™…åœ¨å®ç°æ—¶ï¼Œä½¿ç”¨ `Pull` æ–¹å¼å®ç°ã€‚é€šè¿‡ `Pull` **ä¸æ–­ä¸æ–­ä¸æ–­**è½®è¯¢ `Broker` è·å–æ¶ˆæ¯ã€‚å½“ä¸å­˜åœ¨æ–°æ¶ˆæ¯æ—¶ï¼Œ`Broker` ä¼š**æŒ‚èµ·è¯·æ±‚**ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯äº§ç”Ÿï¼Œå–æ¶ˆæŒ‚èµ·ï¼Œè¿”å›æ–°æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒåŸºæœ¬å’Œ `Broker` ä¸»åŠ¨ `Push` åšåˆ°**æ¥è¿‘**çš„å®æ—¶æ€§ï¼ˆå½“ç„¶ï¼Œè¿˜æ˜¯æœ‰ç›¸åº”çš„å®æ—¶æ€§æŸå¤±ï¼‰ã€‚åŸç†ç±»ä¼¼ **[é•¿è½®è¯¢( `Long-Polling` )](https://www.ibm.com/developerworks/cn/web/wa-lo-comet/)**ã€‚\n* PullConsumer\n\n**æœ¬æ–‡ä¸»è¦è®²è§£`PushConsumer`ï¼Œéƒ¨åˆ†è®²è§£`PullConsumer`ï¼Œè·³è¿‡`é¡ºåºæ¶ˆè´¹`ã€‚**  \n**æœ¬æ–‡ä¸»è¦è®²è§£`PushConsumer`ï¼Œéƒ¨åˆ†è®²è§£`PullConsumer`ï¼Œè·³è¿‡`é¡ºåºæ¶ˆè´¹`ã€‚**  \n**æœ¬æ–‡ä¸»è¦è®²è§£`PushConsumer`ï¼Œéƒ¨åˆ†è®²è§£`PullConsumer`ï¼Œè·³è¿‡`é¡ºåºæ¶ˆè´¹`ã€‚**  \n\n# 3ã€PushConsumer ä¸€è§ˆ\n\nå…ˆçœ‹ä¸€å¼  `PushConsumer` åŒ…å«çš„ç»„ä»¶ä»¥åŠç»„ä»¶ä¹‹é—´çš„äº¤äº’å›¾ï¼š\n\n![PushConsumeræ‰‹ç»˜å›¾.png](http://www.yunai.me/images/RocketMQ/2017_05_04/09.png)\n\n* `RebalanceService`ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ `Consumer` å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( `MessageQueue` )ã€‚å½“æœ‰æ–°çš„ `Consumer` çš„åŠ å…¥æˆ–ç§»é™¤ï¼Œéƒ½ä¼šé‡æ–°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* `PullMessageService`ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œ**ä¸æ–­ä¸æ–­ä¸æ–­**ä» `Broker` æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° `ConsumeMessageService`ã€‚\n* `ConsumeMessageService`ï¼šæ¶ˆè´¹æ¶ˆæ¯æœåŠ¡ï¼Œ**ä¸æ–­ä¸æ–­ä¸æ–­**æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å¤„ç†æ¶ˆè´¹ç»“æœã€‚\n* `RemoteBrokerOffsetStore`ï¼š`Consumer` æ¶ˆè´¹è¿›åº¦ç®¡ç†ï¼Œè´Ÿè´£ä» `Broker` è·å–æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° `Broker`ã€‚\n* `ProcessQueue` ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚\n* `MQClientInstance` ï¼šå°è£…å¯¹ `Namesrv`ï¼Œ`Broker` çš„ APIè°ƒç”¨ï¼Œæä¾›ç»™ `Producer`ã€`Consumer` ä½¿ç”¨ã€‚\n\n# 4ã€PushConsumer è®¢é˜…\n\n## DefaultMQPushConsumerImpl#subscribe(...)\n\n```Java\n  1: public void subscribe(String topic, String subExpression) throws MQClientException {\n  2:     try {\n  3:         // åˆ›å»ºè®¢é˜…æ•°æ®\n  4:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(this.defaultMQPushConsumer.getConsumerGroup(), //\n  5:             topic, subExpression);\n  6:         this.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);\n  7:         // é€šè¿‡å¿ƒè·³åŒæ­¥Consumerä¿¡æ¯åˆ°Broker\n  8:         if (this.mQClientFactory != null) {\n  9:             this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();\n 10:         }\n 11:     } catch (Exception e) {\n 12:         throw new MQClientException(\"subscription exception\", e);\n 13:     }\n 14: }\n```\n\n* è¯´æ˜ ï¼šè®¢é˜… `Topic` ã€‚\n* ç¬¬ 3 è‡³ 6 è¡Œ ï¼šåˆ›å»ºè®¢é˜…æ•°æ®ã€‚è¯¦ç»†è§£æè§ï¼š[FilterAPI.buildSubscriptionData(...)](#filterapibuildsubscriptiondata)ã€‚\n* ç¬¬ 7 è‡³ 10 è¡Œ ï¼šé€šè¿‡å¿ƒè·³åŒæ­¥ `Consumer` ä¿¡æ¯åˆ° `Broker`ã€‚\n\n### FilterAPI.buildSubscriptionData(...)\n\n```Java\n  1: public static SubscriptionData buildSubscriptionData(final String consumerGroup, String topic,\n  2:     String subString) throws Exception {\n  3:     SubscriptionData subscriptionData = new SubscriptionData();\n  4:     subscriptionData.setTopic(topic);\n  5:     subscriptionData.setSubString(subString);\n  6:     // å¤„ç†è®¢é˜…è¡¨è¾¾å¼\n  7:     if (null == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == 0) {\n  8:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);\n  9:     } else {\n 10:         String[] tags = subString.split(\"\\\\|\\\\|\");\n 11:         if (tags.length > 0) {\n 12:             for (String tag : tags) {\n 13:                 if (tag.length() > 0) {\n 14:                     String trimString = tag.trim();\n 15:                     if (trimString.length() > 0) {\n 16:                         subscriptionData.getTagsSet().add(trimString);\n 17:                         subscriptionData.getCodeSet().add(trimString.hashCode());\n 18:                     }\n 19:                 }\n 20:             }\n 21:         } else {\n 22:             throw new Exception(\"subString split error\");\n 23:         }\n 24:     }\n 25: \n 26:     return subscriptionData;\n 27: }\n```\n\n* è¯´æ˜ ï¼šæ ¹æ® `Topic` å’Œ è®¢é˜…è¡¨è¾¾å¼ åˆ›å»ºè®¢é˜…æ•°æ®\n* subscriptionData.subVersion = System.currentTimeMillis()ã€‚\n\n## DefaultMQPushConsumer#registerMessageListener(...)\n\n```Java\n  1: public void registerMessageListener(MessageListenerConcurrently messageListener) {\n  2:     this.messageListener = messageListener;\n  3:     this.defaultMQPushConsumerImpl.registerMessageListener(messageListener);\n  4: }\n```\n\n* è¯´æ˜ ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ã€‚\n\n# 5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…\n\n![RebalanceService&PushConsumeråˆ†é…é˜Ÿåˆ—](http://www.yunai.me/images/RocketMQ/2017_05_04/10.png)\n\n## RebalanceService\n\n```Java\n  1: public class RebalanceService extends ServiceThread {\n  2: \n  3:     /**\n  4:      * ç­‰å¾…é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’\n  5:      */\n  6:     private static long waitInterval =\n  7:         Long.parseLong(System.getProperty(\n  8:             \"rocketmq.client.rebalance.waitInterval\", \"20000\"));\n  9: \n 10:     private final Logger log = ClientLogger.getLog();\n 11:     /**\n 12:      * MQClientå¯¹è±¡\n 13:      */\n 14:     private final MQClientInstance mqClientFactory;\n 15: \n 16:     public RebalanceService(MQClientInstance mqClientFactory) {\n 17:         this.mqClientFactory = mqClientFactory;\n 18:     }\n 19: \n 20:     @Override\n 21:     public void run() {\n 22:         log.info(this.getServiceName() + \" service started\");\n 23: \n 24:         while (!this.isStopped()) {\n 25:             this.waitForRunning(waitInterval);\n 26:             this.mqClientFactory.doRebalance();\n 27:         }\n 28: \n 29:         log.info(this.getServiceName() + \" service end\");\n 30:     }\n 31: \n 32:     @Override\n 33:     public String getServiceName() {\n 34:         return RebalanceService.class.getSimpleName();\n 35:     }\n 36: }\n```\n\n* è¯´æ˜ ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ `Consumer` å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( `MessageQueue` )ã€‚\n* ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ `MQClientInstance#doRebalance(...)` åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç›®å‰æœ‰ä¸‰ç§æƒ…å†µæƒ…å†µä¸‹è§¦å‘ï¼š\n    * å¦‚ `ç¬¬ 25 è¡Œ` ç­‰å¾…è¶…æ—¶ï¼Œæ¯ 20s è°ƒç”¨ä¸€æ¬¡ã€‚\n    * `PushConsumer` å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ `rebalanceService#wakeup(...)` è§¦å‘ã€‚\n    * `Broker` é€šçŸ¥ `Consumer` åŠ å…¥ æˆ– ç§»é™¤æ—¶ï¼Œ`Consumer` å“åº”é€šçŸ¥ï¼Œè°ƒç”¨ `rebalanceService#wakeup(...)` è§¦å‘ã€‚\n\n è¯¦ç»†è§£æè§ï¼š[MQClientInstance#doRebalance(...)](#mqclientinstancedorebalance)ã€‚\n\n## MQClientInstance#doRebalance(...)\n\n```Java\n  1: public void doRebalance() {\n  2:     for (Map.Entry<String, MQConsumerInner> entry : this.consumerTable.entrySet()) {\n  3:         MQConsumerInner impl = entry.getValue();\n  4:         if (impl != null) {\n  5:             try {\n  6:                 impl.doRebalance();\n  7:             } catch (Throwable e) {\n  8:                 log.error(\"doRebalance exception\", e);\n  9:             }\n 10:         }\n 11:     }\n 12: }\n```\n\n* è¯´æ˜ ï¼šéå†å½“å‰ `Client` åŒ…å«çš„ `consumerTable`( `Consumer`é›†åˆ )ï¼Œæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚\n* **ç–‘é—®**ï¼šç›®å‰ä»£ç è°ƒè¯•ä¸‹æ¥ï¼Œ`consumerTable` åªåŒ…å« `Consumer` è‡ªå·±ã€‚ğŸ˜ˆæœ‰å¤§å¤§å¯¹è¿™ä¸ªç–‘é—®æœ‰è§£ç­”çš„ï¼Œçƒ¦è¯·è§£ç­”ä¸‹ã€‚\n* ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ `MQConsumerInner#doRebalance(...)` è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚`DefaultMQPushConsumerImpl`ã€`DefaultMQPullConsumerImpl` åˆ†åˆ«å¯¹è¯¥æ¥å£æ–¹æ³•è¿›è¡Œäº†å®ç°ã€‚`DefaultMQPushConsumerImpl#doRebalance(...)` è¯¦ç»†è§£æè§ï¼š[DefaultMQPushConsumerImpl#doRebalance(...)](defaultmqpushconsumerimpldorebalance)ã€‚\n\n## DefaultMQPushConsumerImpl#doRebalance(...)\n\n```Java\n  1: public void doRebalance() {\n  2:     if (!this.pause) {\n  3:         this.rebalanceImpl.doRebalance(this.isConsumeOrderly());\n  4:     }\n  5: }\n```\n\n* è¯´æ˜ï¼šæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚\n* ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ `RebalanceImpl#doRebalance(...)` è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚è¯¦ç»†è§£æè§ï¼š[RebalancePushImpl#doRebalance(...)](#rebalancepushimpldorebalance)ã€‚\n\n## RebalanceImpl#doRebalance(...)\n\n```Java\n  1: /**\n  2:  * æ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—\n  3:  *\n  4:  * @param isOrder æ˜¯å¦é¡ºåºæ¶ˆæ¯\n  5:  */\n  6: public void doRebalance(final boolean isOrder) {\n  7:     // åˆ†é…æ¯ä¸ª topic çš„æ¶ˆæ¯é˜Ÿåˆ—\n  8:     Map<String, SubscriptionData> subTable = this.getSubscriptionInner();\n  9:     if (subTable != null) {\n 10:         for (final Map.Entry<String, SubscriptionData> entry : subTable.entrySet()) {\n 11:             final String topic = entry.getKey();\n 12:             try {\n 13:                 this.rebalanceByTopic(topic, isOrder);\n 14:             } catch (Throwable e) {\n 15:                 if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 16:                     log.warn(\"rebalanceByTopic Exception\", e);\n 17:                 }\n 18:             }\n 19:         }\n 20:     }\n 21:     // ç§»é™¤æœªè®¢é˜…çš„topicå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—\n 22:     this.truncateMessageQueueNotMyTopic();\n 23: }\n 24: \n 25: /**\n 26:  * ç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—\n 27:  */\n 28: private void truncateMessageQueueNotMyTopic() {\n 29:     Map<String, SubscriptionData> subTable = this.getSubscriptionInner();\n 30:     for (MessageQueue mq : this.processQueueTable.keySet()) {\n 31:         if (!subTable.containsKey(mq.getTopic())) {\n 32: \n 33:             ProcessQueue pq = this.processQueueTable.remove(mq);\n 34:             if (pq != null) {\n 35:                 pq.setDropped(true);\n 36:                 log.info(\"doRebalance, {}, truncateMessageQueueNotMyTopic remove unnecessary mq, {}\", consumerGroup, mq);\n 37:             }\n 38:         }\n 39:     }\n 40: }\n```\n\n* `#doRebalance(...)` è¯´æ˜ ï¼šæ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 7 è‡³ 20 è¡Œ ï¼šå¾ªç¯è®¢é˜…ä¸»é¢˜é›†åˆ( `subscriptionInner` )ï¼Œåˆ†é…æ¯ä¸€ä¸ª `Topic` çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 22 è¡Œ ï¼šç§»é™¤æœªè®¢é˜…çš„ `Topic` çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* `#truncateMessageQueueNotMyTopic(...)` è¯´æ˜ ï¼šç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚**å½“è°ƒç”¨ `DefaultMQPushConsumer#unsubscribe(topic)` æ—¶ï¼Œåªç§»é™¤è®¢é˜…ä¸»é¢˜é›†åˆ( `subscriptionInner` )ï¼Œå¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—ç§»é™¤åœ¨è¯¥æ–¹æ³•ã€‚**\n\n### RebalanceImpl#rebalanceByTopic(...)\n\n```Java\n  1: private void rebalanceByTopic(final String topic, final boolean isOrder) {\n  2:     switch (messageModel) {\n  3:         case BROADCASTING: {\n  4:             Set<MessageQueue> mqSet = this.topicSubscribeInfoTable.get(topic);\n  5:             if (mqSet != null) {\n  6:                 boolean changed = this.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);\n  7:                 if (changed) {\n  8:                     this.messageQueueChanged(topic, mqSet, mqSet);\n  9:                     log.info(\"messageQueueChanged {} {} {} {}\", //\n 10:                         consumerGroup, //\n 11:                         topic, //\n 12:                         mqSet, //\n 13:                         mqSet);\n 14:                 }\n 15:             } else {\n 16:                 log.warn(\"doRebalance, {}, but the topic[{}] not exist.\", consumerGroup, topic);\n 17:             }\n 18:             break;\n 19:         }\n 20:         case CLUSTERING: {\n 21:             // è·å– topic å¯¹åº”çš„ é˜Ÿåˆ— å’Œ consumerä¿¡æ¯\n 22:             Set<MessageQueue> mqSet = this.topicSubscribeInfoTable.get(topic);\n 23:             List<String> cidAll = this.mQClientFactory.findConsumerIdList(topic, consumerGroup);\n 24:             if (null == mqSet) {\n 25:                 if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 26:                     log.warn(\"doRebalance, {}, but the topic[{}] not exist.\", consumerGroup, topic);\n 27:                 }\n 28:             }\n 29: \n 30:             if (null == cidAll) {\n 31:                 log.warn(\"doRebalance, {} {}, get consumer id list failed\", consumerGroup, topic);\n 32:             }\n 33: \n 34:             if (mqSet != null && cidAll != null) {\n 35:                 // æ’åº æ¶ˆæ¯é˜Ÿåˆ— å’Œ æ¶ˆè´¹è€…æ•°ç»„ã€‚å› ä¸ºæ˜¯åœ¨Clientè¿›è¡Œåˆ†é…é˜Ÿåˆ—ï¼Œæ’åºåï¼Œå„Clientçš„é¡ºåºæ‰èƒ½ä¿æŒä¸€è‡´ã€‚\n 36:                 List<MessageQueue> mqAll = new ArrayList<>();\n 37:                 mqAll.addAll(mqSet);\n 38: \n 39:                 Collections.sort(mqAll);\n 40:                 Collections.sort(cidAll);\n 41: \n 42:                 AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;\n 43: \n 44:                 // æ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥ åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—\n 45:                 List<MessageQueue> allocateResult;\n 46:                 try {\n 47:                     allocateResult = strategy.allocate(//\n 48:                         this.consumerGroup, //\n 49:                         this.mQClientFactory.getClientId(), //\n 50:                         mqAll, //\n 51:                         cidAll);\n 52:                 } catch (Throwable e) {\n 53:                     log.error(\"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}\", strategy.getName(),\n 54:                         e);\n 55:                     return;\n 56:                 }\n 57: \n 58:                 Set<MessageQueue> allocateResultSet = new HashSet<>();\n 59:                 if (allocateResult != null) {\n 60:                     allocateResultSet.addAll(allocateResult);\n 61:                 }\n 62: \n 63:                 // æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—\n 64:                 boolean changed = this.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);\n 65:                 if (changed) {\n 66:                     log.info(\n 67:                         \"rebalanced result changed. allocateMessageQueueStrategyName={}, group={}, topic={}, clientId={}, mqAllSize={}, cidAllSize={}, rebalanceResultSize={}, rebalanceResultSet={}\",\n 68:                         strategy.getName(), consumerGroup, topic, this.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),\n 69:                         allocateResultSet.size(), allocateResultSet);\n 70:                     this.messageQueueChanged(topic, mqSet, allocateResultSet);\n 71:                 }\n 72:             }\n 73:             break;\n 74:         }\n 75:         default:\n 76:             break;\n 77:     }\n 78: }\n 79: \n 80: /**\n 81:  * å½“è´Ÿè½½å‡è¡¡æ—¶ï¼Œæ›´æ–° æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n 82:  * - ç§»é™¤ åœ¨processQueueTable && ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—\n 83:  * - å¢åŠ  ä¸åœ¨processQueueTable && å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—\n 84:  *\n 85:  * @param topic Topic\n 86:  * @param mqSet è´Ÿè½½å‡è¡¡ç»“æœåçš„æ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„\n 87:  * @param isOrder æ˜¯å¦é¡ºåº\n 88:  * @return æ˜¯å¦å˜æ›´\n 89:  */\n 90: private boolean updateProcessQueueTableInRebalance(final String topic, final Set<MessageQueue> mqSet, final boolean isOrder) {\n 91:     boolean changed = false;\n 92: \n 93:     // ç§»é™¤ åœ¨processQueueTable && ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—\n 94:     Iterator<Entry<MessageQueue, ProcessQueue>> it = this.processQueueTable.entrySet().iterator();\n 95:     while (it.hasNext()) { // TODO å¾…è¯»ï¼š\n 96:         Entry<MessageQueue, ProcessQueue> next = it.next();\n 97:         MessageQueue mq = next.getKey();\n 98:         ProcessQueue pq = next.getValue();\n 99: \n100:         if (mq.getTopic().equals(topic)) {\n101:             if (!mqSet.contains(mq)) { // ä¸åŒ…å«çš„é˜Ÿåˆ—\n102:                 pq.setDropped(true);\n103:                 if (this.removeUnnecessaryMessageQueue(mq, pq)) {\n104:                     it.remove();\n105:                     changed = true;\n106:                     log.info(\"doRebalance, {}, remove unnecessary mq, {}\", consumerGroup, mq);\n107:                 }\n108:             } else if (pq.isPullExpired()) { // é˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†\n109:                 switch (this.consumeType()) {\n110:                     case CONSUME_ACTIVELY:\n111:                         break;\n112:                     case CONSUME_PASSIVELY:\n113:                         pq.setDropped(true);\n114:                         if (this.removeUnnecessaryMessageQueue(mq, pq)) {\n115:                             it.remove();\n116:                             changed = true;\n117:                             log.error(\"[BUG]doRebalance, {}, remove unnecessary mq, {}, because pull is pause, so try to fixed it\",\n118:                                 consumerGroup, mq);\n119:                         }\n120:                         break;\n121:                     default:\n122:                         break;\n123:                 }\n124:             }\n125:         }\n126:     }\n127: \n128:     // å¢åŠ  ä¸åœ¨processQueueTable && å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n129:     List<PullRequest> pullRequestList = new ArrayList<>(); // æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„\n130:     for (MessageQueue mq : mqSet) {\n131:         if (!this.processQueueTable.containsKey(mq)) {\n132:             if (isOrder && !this.lock(mq)) {\n133:                 log.warn(\"doRebalance, {}, add a new mq failed, {}, because lock failed\", consumerGroup, mq);\n134:                 continue;\n135:             }\n136: \n137:             this.removeDirtyOffset(mq);\n138:             ProcessQueue pq = new ProcessQueue();\n139:             long nextOffset = this.computePullFromWhere(mq);\n140:             if (nextOffset >= 0) {\n141:                 ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq);\n142:                 if (pre != null) {\n143:                     log.info(\"doRebalance, {}, mq already exists, {}\", consumerGroup, mq);\n144:                 } else {\n145:                     log.info(\"doRebalance, {}, add a new mq, {}\", consumerGroup, mq);\n146:                     PullRequest pullRequest = new PullRequest();\n147:                     pullRequest.setConsumerGroup(consumerGroup);\n148:                     pullRequest.setNextOffset(nextOffset);\n149:                     pullRequest.setMessageQueue(mq);\n150:                     pullRequest.setProcessQueue(pq);\n151:                     pullRequestList.add(pullRequest);\n152:                     changed = true;\n153:                 }\n154:             } else {\n155:                 log.warn(\"doRebalance, {}, add new mq failed, {}\", consumerGroup, mq);\n156:             }\n157:         }\n158:     }\n159: \n160:     // å‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚\n161:     this.dispatchPullRequest(pullRequestList);\n162: \n163:     return changed;\n164: }\n```\n\n* `#rebalanceByTopic(...)` è¯´æ˜ ï¼šåˆ†é… `Topic` çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 3 è‡³ 19 è¡Œ ï¼šå¹¿æ’­æ¨¡å¼( `BROADCASTING` ) ä¸‹ï¼Œåˆ†é… `Topic` å¯¹åº”çš„**æ‰€æœ‰**æ¶ˆæ¯é˜Ÿåˆ—ã€‚   \n    * ç¬¬ 20 è‡³ 74 è¡Œ ï¼šé›†ç¾¤æ¨¡å¼( `CLUSTERING` ) ä¸‹ï¼Œåˆ†é… `Topic` å¯¹åº”çš„**éƒ¨åˆ†**æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n        * ç¬¬ 21 è‡³ 40 è¡Œ ï¼šè·å– `Topic` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ä»¬ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ’åºã€‚å› ä¸ºå„ `Consumer` æ˜¯åœ¨æœ¬åœ°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ’åºåæ‰èƒ½ä¿è¯å„ `Consumer` é¡ºåºä¸€è‡´ã€‚\n        *  ç¬¬ 42 è‡³ 61 è¡Œ ï¼šæ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥( `AllocateMessageQueueStrategy` ) åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š[AllocateMessageQueueStrategy](#allocatemessagequeuestrategy)ã€‚\n        *  ç¬¬ 63 è‡³ 72 è¡Œ ï¼šæ›´æ–° `Topic` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* `#updateProcessQueueTableInRebalance(...)` è¯´æ˜ ï¼šå½“åˆ†é…é˜Ÿåˆ—æ—¶ï¼Œæ›´æ–° `Topic` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è¿”å›æ˜¯å¦æœ‰å˜æ›´ã€‚\n    * ç¬¬ 93 è‡³ 126 è¡Œ ï¼šç§»é™¤ä¸å­˜åœ¨äºåˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( `mqSet` ) çš„ æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—( `processQueueTable` )ã€‚\n        * ç¬¬ 103 è¡Œ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š[RebalancePushImpl#removeUnnecessaryMessageQueue(...)](#rebalancepushimplremoveunnecessarymessagequeue)ã€‚\n        * ç¬¬ 108 è‡³ 120 è¡Œ ï¼šé˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œå³ `å½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶é—´ > 120s` ( 120s å¯é…ç½®)ï¼Œåˆ¤å®šå‘ç”Ÿ **BUG**ï¼Œè¿‡ä¹…æœªè¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç§»é™¤åï¼Œä¸‹é¢**#æ–°å¢é˜Ÿåˆ—é€»è¾‘#**å¯ä»¥é‡æ–°åŠ å…¥æ–°çš„è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 128 è‡³ 158 è¡Œ ï¼šå¢åŠ  åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( `mqSet` ) æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n        * ç¬¬ 132 è‡³ 135 è¡Œ ï¼š`é¡ºåºæ¶ˆè´¹` ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹](http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/)ã€‚\n        * ç¬¬ 137 è¡Œ ï¼šç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ã€‚\n        * ç¬¬ 139 è¡Œ ï¼šè·å–é˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š[RebalancePushImpl#computePullFromWhere(...)](#rebalancepushimplcomputepullfromwhere)ã€‚\n        * ç¬¬ 140 è‡³ 156 è¡Œ ï¼š**æ·»åŠ æ–°æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ï¼Œæ·»åŠ æ¶ˆè´¹æ‹‰å–æ¶ˆæ¯è¯·æ±‚**ã€‚\n    * ç¬¬ 161 è¡Œ ï¼š**å‘èµ·æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯æ‹‰å–è¯·æ±‚**ã€‚è¯¦ç»†è§£æè§ï¼š[RebalancePushImpl#dispatchPullRequest(...)](#rebalancepushimpldispatchpullrequest)ã€‚\n\n### RebalanceImpl#removeUnnecessaryMessageQueue(...)\n\n#### RebalancePushImpl#removeUnnecessaryMessageQueue(...)\n\n```Java\n  1: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {\n  2:     // åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚\n  3:     this.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);\n  4:     this.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);\n  5:     // TODO é¡ºåºæ¶ˆè´¹\n  6:     if (this.defaultMQPushConsumerImpl.isConsumeOrderly()\n  7:         && MessageModel.CLUSTERING.equals(this.defaultMQPushConsumerImpl.messageModel())) {\n  8:         try {\n  9:             if (pq.getLockConsume().tryLock(1000, TimeUnit.MILLISECONDS)) {\n 10:                 try {\n 11:                     return this.unlockDelay(mq, pq);\n 12:                 } finally {\n 13:                     pq.getLockConsume().unlock();\n 14:                 }\n 15:             } else {\n 16:                 log.warn(\"[WRONG]mq is consuming, so can not unlock it, {}. maybe hanged for a while, {}\", //\n 17:                     mq, //\n 18:                     pq.getTryUnlockTimes());\n 19: \n 20:                 pq.incTryUnlockTimes();\n 21:             }\n 22:         } catch (Exception e) {\n 23:             log.error(\"removeUnnecessaryMessageQueue Exception\", e);\n 24:         }\n 25: \n 26:         return false;\n 27:     }\n 28:     return true;\n 29: }\n```\n\n* è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›æ˜¯å¦ç§»é™¤æˆåŠŸã€‚\n* ç¬¬ 2 è‡³ 4 è¡Œ ï¼š**åŒæ­¥**é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚\n* ç¬¬ 5 è‡³ 27 è¡Œ ï¼š`é¡ºåºæ¶ˆè´¹` ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹](http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/)ã€‚\n\n#### `[PullConsumer]` RebalancePullImpl#removeUnnecessaryMessageQueue(...)\n\n```Java\n  1: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {\n  2:     this.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);\n  3:     this.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);\n  4:     return true;\n  5: }\n```\n\n* è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›ç§»é™¤æˆåŠŸã€‚**å’Œ`RebalancePushImpl#removeUnnecessaryMessageQueue(...)`åŸºæœ¬ä¸€è‡´ã€‚**\n\n### RebalancePushImpl#dispatchPullRequest(...)\n\n```Java\n  1: public void dispatchPullRequest(List<PullRequest> pullRequestList) {\n  2:     for (PullRequest pullRequest : pullRequestList) {\n  3:         this.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);\n  4:         log.info(\"doRebalance, {}, add a new pull request {}\", consumerGroup, pullRequest);\n  5:     }\n  6: }\n```\n\n* è¯´æ˜ ï¼šå‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚**è¯¥è°ƒç”¨æ˜¯`PushConsumer`ä¸æ–­ä¸æ–­ä¸æ–­æ‹‰å–æ¶ˆæ¯çš„èµ·ç‚¹**ã€‚\n\n#### DefaultMQPushConsumerImpl#executePullRequestImmediately(...)\n\n```Java\n  1: public void executePullRequestImmediately(final PullRequest pullRequest) {\n  2:     this.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);\n  3: }\n```\n\n* è¯´æ˜ ï¼šæäº¤æ‹‰å–è¯·æ±‚ã€‚æäº¤åï¼Œ`PullMessageService` **å¼‚æ­¥æ‰§è¡Œ**ï¼Œ**éé˜»å¡**ã€‚è¯¦ç»†è§£æè§ï¼š[PullMessageService](pullmessageservice)ã€‚\n\n### AllocateMessageQueueStrategy\n\n![AllocateMessageQueueStrategyç±»å›¾](http://www.yunai.me/images/RocketMQ/2017_05_04/01.png)\n\n#### AllocateMessageQueueAveragely\n\n```Java\n  1: public class AllocateMessageQueueAveragely implements AllocateMessageQueueStrategy {\n  2:     private final Logger log = ClientLogger.getLog();\n  3: \n  4:     @Override\n  5:     public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,\n  6:         List<String> cidAll) {\n  7:         // æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®\n  8:         if (currentCID == null || currentCID.length() < 1) {\n  9:             throw new IllegalArgumentException(\"currentCID is empty\");\n 10:         }\n 11:         if (mqAll == null || mqAll.isEmpty()) {\n 12:             throw new IllegalArgumentException(\"mqAll is null or mqAll empty\");\n 13:         }\n 14:         if (cidAll == null || cidAll.isEmpty()) {\n 15:             throw new IllegalArgumentException(\"cidAll is null or cidAll empty\");\n 16:         }\n 17: \n 18:         List<MessageQueue> result = new ArrayList<>();\n 19:         if (!cidAll.contains(currentCID)) {\n 20:             log.info(\"[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}\",\n 21:                 consumerGroup,\n 22:                 currentCID,\n 23:                 cidAll);\n 24:             return result;\n 25:         }\n 26:         // å¹³å‡åˆ†é…\n 27:         int index = cidAll.indexOf(currentCID); // ç¬¬å‡ ä¸ªconsumerã€‚\n 28:         int mod = mqAll.size() % cidAll.size(); // ä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚\n 29:         int averageSize =\n 30:             mqAll.size() <= cidAll.size() ? 1 : (mod > 0 && index < mod ? mqAll.size() / cidAll.size()\n 31:                 + 1 : mqAll.size() / cidAll.size());\n 32:         int startIndex = (mod > 0 && index < mod) ? index * averageSize : index * averageSize + mod; // æœ‰ä½™æ•°çš„æƒ…å†µä¸‹ï¼Œ[0, mod) å¹³åˆ†ä½™æ•°ï¼Œå³æ¯consumerå¤šåˆ†é…ä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬indexå¼€å§‹ï¼Œè·³è¿‡å‰modä½™æ•°ã€‚\n 33:         int range = Math.min(averageSize, mqAll.size() - startIndex); // åˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦Math.min()çš„åŸå› æ˜¯ï¼ŒmqAll.size() <= cidAll.size()ï¼Œéƒ¨åˆ†consumeråˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n 34:         for (int i = 0; i < range; i++) {\n 35:             result.add(mqAll.get((startIndex + i) % mqAll.size()));\n 36:         }\n 37:         return result;\n 38:     }\n 39: \n 40:     @Override\n 41:     public String getName() {\n 42:         return \"AVG\";\n 43:     }\n 44: }\n```\n\n* è¯´æ˜ ï¼š**å¹³å‡**åˆ†é…é˜Ÿåˆ—ç­–ç•¥ã€‚\n* ç¬¬ 7 è‡³ 25 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚\n* ç¬¬ 26 è‡³ 36 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 27 è¡Œ ï¼š`index` ï¼šå½“å‰ `Consumer` åœ¨æ¶ˆè´¹é›†ç¾¤é‡Œæ˜¯ç¬¬å‡ ä¸ªã€‚è¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å¯¹ä¼ å…¥çš„ `cidAll` å‚æ•°å¿…é¡»è¿›è¡Œæ’åºçš„åŸå› ã€‚å¦‚æœä¸æ’åºï¼Œ`Consumer` åœ¨æœ¬åœ°è®¡ç®—å‡ºæ¥çš„ `index` æ— æ³•ä¸€è‡´ï¼Œå½±å“è®¡ç®—ç»“æœã€‚\n    * ç¬¬ 28 è¡Œ ï¼š`mod` ï¼šä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚\n    * ç¬¬ 29 è‡³ 31 è¡Œ ï¼š`averageSize` ï¼šä»£ç å¯ä»¥ç®€åŒ–æˆ `(mod > 0 && index < mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())`ã€‚\n        * `[ 0, mod )` ï¼š`mqAll.size() / cidAll.size() + 1`ã€‚å‰é¢ `mod` ä¸ª `Consumer` å¹³åˆ†ä½™æ•°ï¼Œå¤šè·å¾— 1 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚\n        * `[ mod, cidAll.size() )` ï¼š`mqAll.size() / cidAll.size()`ã€‚\n    * ç¬¬ 32 è¡Œ ï¼š`startIndex` ï¼š`Consumer` åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹ä½ç½®ã€‚\n    * ç¬¬ 33 è¡Œ ï¼š`range` ï¼šåˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦ `Math#min(...)` çš„åŸå› ï¼šå½“ `mqAll.size() <= cidAll.size()` æ—¶ï¼Œæœ€åå‡ ä¸ª `Consumer` åˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n    * ç¬¬ 34 è‡³ 36 è¡Œ ï¼šç”Ÿæˆåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç»“æœã€‚\n* ä¸¾ä¸ªä¾‹å­ï¼š\n\nå›ºå®šæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ä¸º**4**ã€‚\n\n|   | Consumer * 2 *å¯ä»¥æ•´é™¤* | Consumer * 3 *ä¸å¯æ•´é™¤* | Consumer * 5 *æ— æ³•éƒ½åˆ†é…* |\n| --- | --- | --- | --- |\n| æ¶ˆæ¯é˜Ÿåˆ—[0] | Consumer[0] | Consumer[0] | Consumer[0] |\n| æ¶ˆæ¯é˜Ÿåˆ—[1] | Consumer[0] | Consumer[0] | Consumer[1] |\n| æ¶ˆæ¯é˜Ÿåˆ—[2] | Consumer[1] | Consumer[1] | Consumer[2] |\n| æ¶ˆæ¯é˜Ÿåˆ—[3] | Consumer[1] | Consumer[2] | Consumer[3] |\n\n#### AllocateMessageQueueByMachineRoom\n\n```Java\n  1: public class AllocateMessageQueueByMachineRoom implements AllocateMessageQueueStrategy {\n  2:     /**\n  3:      * æ¶ˆè´¹è€…æ¶ˆè´¹brokerNameé›†åˆ\n  4:      */\n  5:     private Set<String> consumeridcs;\n  6: \n  7:     @Override\n  8:     public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,\n  9:         List<String> cidAll) {\n 10:         // å‚æ•°æ ¡éªŒ\n 11:         List<MessageQueue> result = new ArrayList<MessageQueue>();\n 12:         int currentIndex = cidAll.indexOf(currentCID);\n 13:         if (currentIndex < 0) {\n 14:             return result;\n 15:         }\n 16:         // è®¡ç®—ç¬¦åˆå½“å‰é…ç½®çš„æ¶ˆè´¹è€…æ•°ç»„('consumeridcs')å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—\n 17:         List<MessageQueue> premqAll = new ArrayList<MessageQueue>();\n 18:         for (MessageQueue mq : mqAll) {\n 19:             String[] temp = mq.getBrokerName().split(\"@\");\n 20:             if (temp.length == 2 && consumeridcs.contains(temp[0])) {\n 21:                 premqAll.add(mq);\n 22:             }\n 23:         }\n 24:         // å¹³å‡åˆ†é…\n 25:         int mod = premqAll.size() / cidAll.size();\n 26:         int rem = premqAll.size() % cidAll.size();\n 27:         int startIndex = mod * currentIndex;\n 28:         int endIndex = startIndex + mod;\n 29:         for (int i = startIndex; i < endIndex; i++) {\n 30:             result.add(mqAll.get(i));\n 31:         }\n 32:         if (rem > currentIndex) {\n 33:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));\n 34:         }\n 35:         return result;\n 36:     }\n 37: \n 38:     @Override\n 39:     public String getName() {\n 40:         return \"MACHINE_ROOM\";\n 41:     }\n 42: \n 43:     public Set<String> getConsumeridcs() {\n 44:         return consumeridcs;\n 45:     }\n 46: \n 47:     public void setConsumeridcs(Set<String> consumeridcs) {\n 48:         this.consumeridcs = consumeridcs;\n 49:     }\n 50: }\n```\n\n* è¯´æ˜ ï¼š**å¹³å‡**åˆ†é…**å¯æ¶ˆè´¹çš„** `Broker` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 7 è‡³ 15 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚\n* ç¬¬ 16 è‡³ 23 è¡Œ ï¼šè®¡ç®—**å¯æ¶ˆè´¹çš„** `Broker` å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 25 è‡³ 34 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¥**å¹³å‡åˆ†é…**æ–¹å¼å’Œ `AllocateMessageQueueAveragely` ç•¥æœ‰ä¸åŒï¼Œå…¶æ˜¯å°†å¤šä½™çš„ç»“å°¾éƒ¨åˆ†åˆ†é…ç»™å‰ `rem` ä¸ª `Consumer`ã€‚\n* ç–‘é—®ï¼š*ä½¿ç”¨è¯¥åˆ†é…ç­–ç•¥æ—¶ï¼Œ`Consumer` å’Œ `Broker` åˆ†é…éœ€è¦æ€ä¹ˆé…ç½®*ã€‚ğŸ˜ˆç­‰ç ”ç©¶**ä¸»ä»**ç›¸å…³æºç æ—¶ï¼Œä»”ç»†è€ƒè™‘ä¸‹ã€‚\n\n#### AllocateMessageQueueAveragelyByCircle\n\n ```Java\n   1: public class AllocateMessageQueueAveragelyByCircle implements AllocateMessageQueueStrategy {\n  2:     private final Logger log = ClientLogger.getLog();\n  3: \n  4:     @Override\n  5:     public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,\n  6:         List<String> cidAll) {\n  7:         // æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®\n  8:         if (currentCID == null || currentCID.length() < 1) {\n  9:             throw new IllegalArgumentException(\"currentCID is empty\");\n 10:         }\n 11:         if (mqAll == null || mqAll.isEmpty()) {\n 12:             throw new IllegalArgumentException(\"mqAll is null or mqAll empty\");\n 13:         }\n 14:         if (cidAll == null || cidAll.isEmpty()) {\n 15:             throw new IllegalArgumentException(\"cidAll is null or cidAll empty\");\n 16:         }\n 17: \n 18:         List<MessageQueue> result = new ArrayList<MessageQueue>();\n 19:         if (!cidAll.contains(currentCID)) {\n 20:             log.info(\"[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}\",\n 21:                 consumerGroup,\n 22:                 currentCID,\n 23:                 cidAll);\n 24:             return result;\n 25:         }\n 26: \n 27:         // ç¯çŠ¶åˆ†é…\n 28:         int index = cidAll.indexOf(currentCID);\n 29:         for (int i = index; i < mqAll.size(); i++) {\n 30:             if (i % cidAll.size() == index) {\n 31:                 result.add(mqAll.get(i));\n 32:             }\n 33:         }\n 34:         return result;\n 35:     }\n 36: \n 37:     @Override\n 38:     public String getName() {\n 39:         return \"AVG_BY_CIRCLE\";\n 40:     }\n 41: }\n ```\n \n * è¯´æ˜ ï¼šç¯çŠ¶åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n\n#### AllocateMessageQueueByConfig\n\n```Java\n  1: public class AllocateMessageQueueByConfig implements AllocateMessageQueueStrategy {\n  2:     private List<MessageQueue> messageQueueList;\n  3: \n  4:     @Override\n  5:     public List<MessageQueue> allocate(String consumerGroup, String currentCID, List<MessageQueue> mqAll,\n  6:         List<String> cidAll) {\n  7:         return this.messageQueueList;\n  8:     }\n  9: \n 10:     @Override\n 11:     public String getName() {\n 12:         return \"CONFIG\";\n 13:     }\n 14: \n 15:     public List<MessageQueue> getMessageQueueList() {\n 16:         return messageQueueList;\n 17:     }\n 18: \n 19:     public void setMessageQueueList(List<MessageQueue> messageQueueList) {\n 20:         this.messageQueueList = messageQueueList;\n 21:     }\n 22: }\n```\n\n* è¯´æ˜ ï¼šåˆ†é…**é…ç½®çš„**æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç–‘é—® ï¼š*è¯¥åˆ†é…ç­–ç•¥çš„ä½¿ç”¨åœºæ™¯ã€‚*\n\n# 5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–\n\n## RebalancePushImpl#computePullFromWhere(...)\n\n```Java\n  1: public long computePullFromWhere(MessageQueue mq) {\n  2:     long result = -1;\n  3:     final ConsumeFromWhere consumeFromWhere = this.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();\n  4:     final OffsetStore offsetStore = this.defaultMQPushConsumerImpl.getOffsetStore();\n  5:     switch (consumeFromWhere) {\n  6:         case CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: // åºŸå¼ƒ\n  7:         case CONSUME_FROM_MIN_OFFSET: // åºŸå¼ƒ\n  8:         case CONSUME_FROM_MAX_OFFSET: // åºŸå¼ƒ\n  9:         case CONSUME_FROM_LAST_OFFSET: {\n 10:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);\n 11:             if (lastOffset >= 0) {\n 12:                 result = lastOffset;\n 13:             }\n 14:             // First start,no offset\n 15:             else if (-1 == lastOffset) {\n 16:                 if (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 17:                     result = 0L;\n 18:                 } else {\n 19:                     try {\n 20:                         result = this.mQClientFactory.getMQAdminImpl().maxOffset(mq);\n 21:                     } catch (MQClientException e) {\n 22:                         result = -1;\n 23:                     }\n 24:                 }\n 25:             } else {\n 26:                 result = -1;\n 27:             }\n 28:             break;\n 29:         }\n 30:         case CONSUME_FROM_FIRST_OFFSET: {\n 31:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);\n 32:             if (lastOffset >= 0) {\n 33:                 result = lastOffset;\n 34:             } else if (-1 == lastOffset) {\n 35:                 result = 0L;\n 36:             } else {\n 37:                 result = -1;\n 38:             }\n 39:             break;\n 40:         }\n 41:         case CONSUME_FROM_TIMESTAMP: {\n 42:             long lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);\n 43:             if (lastOffset >= 0) {\n 44:                 result = lastOffset;\n 45:             } else if (-1 == lastOffset) {\n 46:                 if (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n 47:                     try {\n 48:                         result = this.mQClientFactory.getMQAdminImpl().maxOffset(mq);\n 49:                     } catch (MQClientException e) {\n 50:                         result = -1;\n 51:                     }\n 52:                 } else {\n 53:                     try {\n 54:                         long timestamp = UtilAll.parseDate(this.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),\n 55:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();\n 56:                         result = this.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);\n 57:                     } catch (MQClientException e) {\n 58:                         result = -1;\n 59:                     }\n 60:                 }\n 61:             } else {\n 62:                 result = -1;\n 63:             }\n 64:             break;\n 65:         }\n 66: \n 67:         default:\n 68:             break;\n 69:     }\n 70: \n 71:     return result;\n 72: }\n```\n\n* è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹æ¶ˆè´¹ä½ç½®ã€‚\n* `PushConsumer` è¯»å–æ¶ˆè´¹è¿›åº¦æœ‰ä¸‰ç§é€‰é¡¹ï¼š\n    * `CONSUME_FROM_LAST_OFFSET` ï¼šç¬¬ 6 è‡³ 29 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»**é˜Ÿåˆ—çš„æœ€åä½ç½®**å¼€å§‹æ¶ˆè´¹ã€‚**åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹**ã€‚\n    * `CONSUME_FROM_FIRST_OFFSET` ï¼šç¬¬ 30 è‡³ 40 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»é˜Ÿåˆ—çš„**æœ€å‰ä½ç½®**å¼€å§‹æ¶ˆè´¹ã€‚**åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹**ã€‚\n    * `CONSUME_FROM_TIMESTAMP` ï¼šç¬¬ 41 è‡³ 65 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»**æŒ‡å®šæ—¶é—´ç‚¹**å¼€å§‹æ¶ˆè´¹ã€‚**åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹**ã€‚\n\n\n## `[PullConsumer]` RebalancePullImpl#computePullFromWhere(...)\n\næš‚æ—¶è·³è¿‡ã€‚ğŸ˜ˆ\n\n# 6ã€PushConsumer æ‹‰å–æ¶ˆæ¯\n\n![DefaultMQPushConsumerImplæ‹‰å–æ¶ˆæ¯](http://www.yunai.me/images/RocketMQ/2017_05_04/05.png)\n\n## PullMessageService\n\n```Java\n  1: public class PullMessageService extends ServiceThread {\n  2:     private final Logger log = ClientLogger.getLog();\n  3:     /**\n  4:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—\n  5:      */\n  6:     private final LinkedBlockingQueue<PullRequest> pullRequestQueue = new LinkedBlockingQueue<>();\n  7:     /**\n  8:      * MQClientå¯¹è±¡\n  9:      */\n 10:     private final MQClientInstance mQClientFactory;\n 11:     /**\n 12:      * å®šæ—¶å™¨ã€‚ç”¨äºå»¶è¿Ÿæäº¤æ‹‰å–è¯·æ±‚\n 13:      */\n 14:     private final ScheduledExecutorService scheduledExecutorService = Executors\n 15:         .newSingleThreadScheduledExecutor(new ThreadFactory() {\n 16:             @Override\n 17:             public Thread newThread(Runnable r) {\n 18:                 return new Thread(r, \"PullMessageServiceScheduledThread\");\n 19:             }\n 20:         });\n 21: \n 22:     public PullMessageService(MQClientInstance mQClientFactory) {\n 23:         this.mQClientFactory = mQClientFactory;\n 24:     }\n 25: \n 26:     /**\n 27:      * æ‰§è¡Œå»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 28:      *\n 29:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 30:      * @param timeDelay å»¶è¿Ÿæ—¶é•¿\n 31:      */\n 32:     public void executePullRequestLater(final PullRequest pullRequest, final long timeDelay) {\n 33:         this.scheduledExecutorService.schedule(new Runnable() {\n 34: \n 35:             @Override\n 36:             public void run() {\n 37:                 PullMessageService.this.executePullRequestImmediately(pullRequest);\n 38:             }\n 39:         }, timeDelay, TimeUnit.MILLISECONDS);\n 40:     }\n 41: \n 42:     /**\n 43:      * æ‰§è¡Œç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 44:      *\n 45:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 46:      */\n 47:     public void executePullRequestImmediately(final PullRequest pullRequest) {\n 48:         try {\n 49:             this.pullRequestQueue.put(pullRequest);\n 50:         } catch (InterruptedException e) {\n 51:             log.error(\"executePullRequestImmediately pullRequestQueue.put\", e);\n 52:         }\n 53:     }\n 54: \n 55:     /**\n 56:      * æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡\n 57:      *\n 58:      * @param r ä»»åŠ¡\n 59:      * @param timeDelay å»¶è¿Ÿæ—¶é•¿\n 60:      */\n 61:     public void executeTaskLater(final Runnable r, final long timeDelay) {\n 62:         this.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);\n 63:     }\n 64: \n 65:     public ScheduledExecutorService getScheduledExecutorService() {\n 66:         return scheduledExecutorService;\n 67:     }\n 68: \n 69:     /**\n 70:      * æ‹‰å–æ¶ˆæ¯\n 71:      *\n 72:      * @param pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n 73:      */\n 74:     private void pullMessage(final PullRequest pullRequest) {\n 75:         final MQConsumerInner consumer = this.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());\n 76:         if (consumer != null) {\n 77:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;\n 78:             impl.pullMessage(pullRequest);\n 79:         } else {\n 80:             log.warn(\"No matched consumer for the PullRequest {}, drop it\", pullRequest);\n 81:         }\n 82:     }\n 83: \n 84:     @Override\n 85:     public void run() {\n 86:         log.info(this.getServiceName() + \" service started\");\n 87: \n 88:         while (!this.isStopped()) {\n 89:             try {\n 90:                 PullRequest pullRequest = this.pullRequestQueue.take();\n 91:                 if (pullRequest != null) {\n 92:                     this.pullMessage(pullRequest);\n 93:                 }\n 94:             } catch (InterruptedException e) {\n 95:             } catch (Exception e) {\n 96:                 log.error(\"Pull Message Service Run Method exception\", e);\n 97:             }\n 98:         }\n 99: \n100:         log.info(this.getServiceName() + \" service end\");\n101:     }\n102: \n103:     @Override\n104:     public String getServiceName() {\n105:         return PullMessageService.class.getSimpleName();\n106:     }\n107: \n108: }\n```\n\n* è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œä¸æ–­ä¸æ–­ä¸æ–­ä» `Broker` æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° `ConsumeMessageService`ã€‚\n* `#executePullRequestLater(...)` ï¼šç¬¬ 26 è‡³ 40 è¡Œ ï¼š æäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n* `#executePullRequestImmediately(...)` ï¼šç¬¬ 42 è‡³ 53 è¡Œ ï¼šæäº¤**ç«‹å³**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n* `#executeTaskLater(...)` ï¼šç¬¬ 55 è‡³ 63 è¡Œ ï¼šæäº¤**å»¶è¿Ÿä»»åŠ¡**ã€‚\n* `#pullMessage(...)` ï¼šç¬¬ 69 è‡³ 82 è¡Œ ï¼šæ‰§è¡Œæ‹‰å–æ¶ˆæ¯é€»è¾‘ã€‚è¯¦ç»†è§£æè§ï¼š[DefaultMQPushConsumerImpl#pullMessage(...)](#defaultmqpushconsumerimplpullmessage)ã€‚\n* `#run(...)` ï¼šç¬¬ 84 è‡³ 101 è¡Œ ï¼šå¾ªç¯æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—( `pullRequestQueue` )ï¼Œè¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚\n\n## DefaultMQPushConsumerImpl#pullMessage(...)\n\n```Java\n  1: public void pullMessage(final PullRequest pullRequest) {\n  2:     final ProcessQueue processQueue = pullRequest.getProcessQueue();\n  3:     if (processQueue.isDropped()) {\n  4:         log.info(\"the pull request[{}] is dropped.\", pullRequest.toString());\n  5:         return;\n  6:     }\n  7: \n  8:     // è®¾ç½®é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´\n  9:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());\n 10: \n 11:     // åˆ¤æ–­consumerçŠ¶æ€æ˜¯å¦è¿è¡Œä¸­ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯ã€‚\n 12:     try {\n 13:         this.makeSureStateOK();\n 14:     } catch (MQClientException e) {\n 15:         log.warn(\"pullMessage exception, consumer state not ok\", e);\n 16:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n 17:         return;\n 18:     }\n 19: \n 20:     // åˆ¤æ–­æ˜¯å¦æš‚åœä¸­ã€‚\n 21:     if (this.isPause()) {\n 22:         log.warn(\"consumer was paused, execute pull request later. instanceName={}, group={}\", this.defaultMQPushConsumer.getInstanceName(), this.defaultMQPushConsumer.getConsumerGroup());\n 23:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);\n 24:         return;\n 25:     }\n 26: \n 27:     // åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æŒæœ‰æ¶ˆæ¯æ•°é‡ã€‚é»˜è®¤æœ€å¤§å€¼ä¸º1000ã€‚\n 28:     long size = processQueue.getMsgCount().get();\n 29:     if (size > this.defaultMQPushConsumer.getPullThresholdForQueue()) {\n 30:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); // æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚\n 31:         if ((flowControlTimes1++ % 1000) == 0) {\n 32:             log.warn(\n 33:                 \"the consumer message buffer is full, so do flow control, minOffset={}, maxOffset={}, size={}, pullRequest={}, flowControlTimes={}\",\n 34:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);\n 35:         }\n 36:         return;\n 37:     }\n 38: \n 39:     if (!this.consumeOrderly) { // åˆ¤æ–­æ¶ˆæ¯è·¨åº¦æ˜¯å¦è¿‡å¤§ã€‚\n 40:         if (processQueue.getMaxSpan() > this.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) {\n 41:             this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); // æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚\n 42:             if ((flowControlTimes2++ % 1000) == 0) {\n 43:                 log.warn(\n 44:                     \"the queue's messages, span too long, so do flow control, minOffset={}, maxOffset={}, maxSpan={}, pullRequest={}, flowControlTimes={}\",\n 45:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),\n 46:                     pullRequest, flowControlTimes2);\n 47:             }\n 48:             return;\n 49:         }\n 50:     } else { // TODO é¡ºåºæ¶ˆè´¹\n 51:         if (processQueue.isLocked()) {\n 52:             if (!pullRequest.isLockedFirst()) {\n 53:                 final long offset = this.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());\n 54:                 boolean brokerBusy = offset < pullRequest.getNextOffset();\n 55:                 log.info(\"the first time to pull message, so fix offset from broker. pullRequest: {} NewOffset: {} brokerBusy: {}\",\n 56:                     pullRequest, offset, brokerBusy);\n 57:                 if (brokerBusy) {\n 58:                     log.info(\"[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: {} NewOffset: {}\",\n 59:                         pullRequest, offset);\n 60:                 }\n 61: \n 62:                 pullRequest.setLockedFirst(true);\n 63:                 pullRequest.setNextOffset(offset);\n 64:             }\n 65:         } else {\n 66:             this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n 67:             log.info(\"pull message later because not locked in broker, {}\", pullRequest);\n 68:             return;\n 69:         }\n 70:     }\n 71: \n 72:     // è·å–Topic å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯\n 73:     final SubscriptionData subscriptionData = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());\n 74:     if (null == subscriptionData) {\n 75:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n 76:         log.warn(\"find the consumer's subscription failed, {}\", pullRequest);\n 77:         return;\n 78:     }\n 79: \n 80:     final long beginTimestamp = System.currentTimeMillis();\n 81: \n 82:     PullCallback pullCallback = new PullCallback() {\n 83:         @Override\n 84:         public void onSuccess(PullResult pullResult) {\n 85:             if (pullResult != null) {\n 86:                 pullResult = DefaultMQPushConsumerImpl.this.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,\n 87:                     subscriptionData);\n 88: \n 89:                 switch (pullResult.getPullStatus()) {\n 90:                     case FOUND:\n 91:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n 92:                         long prevRequestOffset = pullRequest.getNextOffset();\n 93:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());\n 94: \n 95:                         // ç»Ÿè®¡\n 96:                         long pullRT = System.currentTimeMillis() - beginTimestamp;\n 97:                         DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),\n 98:                             pullRequest.getMessageQueue().getTopic(), pullRT);\n 99: \n100:                         long firstMsgOffset = Long.MAX_VALUE;\n101:                         if (pullResult.getMsgFoundList() == null || pullResult.getMsgFoundList().isEmpty()) {\n102:                             DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);\n103:                         } else {\n104:                             firstMsgOffset = pullResult.getMsgFoundList().get(0).getQueueOffset();\n105: \n106:                             // ç»Ÿè®¡\n107:                             DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),\n108:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());\n109: \n110:                             // æäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n111:                             boolean dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());\n112: \n113:                             // æäº¤æ¶ˆè´¹è¯·æ±‚\n114:                             DefaultMQPushConsumerImpl.this.consumeMessageService.submitConsumeRequest(//\n115:                                 pullResult.getMsgFoundList(), //\n116:                                 processQueue, //\n117:                                 pullRequest.getMessageQueue(), //\n118:                                 dispathToConsume);\n119: \n120:                             // æäº¤ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n121:                             if (DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval() > 0) {\n122:                                 DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest,\n123:                                     DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval());\n124:                             } else {\n125:                                 DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);\n126:                             }\n127:                         }\n128: \n129:                         // ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸ºBUGï¼Œè¾“å‡ºlog\n130:                         if (pullResult.getNextBeginOffset() < prevRequestOffset//\n131:                             || firstMsgOffset < prevRequestOffset) {\n132:                             log.warn(\n133:                                 \"[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}\", //\n134:                                 pullResult.getNextBeginOffset(), //\n135:                                 firstMsgOffset, //\n136:                                 prevRequestOffset);\n137:                         }\n138: \n139:                         break;\n140:                     case NO_NEW_MSG:\n141:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n142:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());\n143: \n144:                         // æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦\n145:                         DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);\n146: \n147:                         // ç«‹å³æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n148:                         DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);\n149:                         break;\n150:                     case NO_MATCHED_MSG:\n151:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n152:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());\n153: \n154:                         // æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦\n155:                         DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);\n156: \n157:                         // æäº¤ç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚\n158:                         DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);\n159:                         break;\n160:                     case OFFSET_ILLEGAL:\n161:                         log.warn(\"the pull request offset illegal, {} {}\", //\n162:                             pullRequest.toString(), pullResult.toString());\n163:                         // è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n164:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());\n165: \n166:                         // è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸ºdropped\n167:                         pullRequest.getProcessQueue().setDropped(true);\n168: \n169:                         // æäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ç§»é™¤ã€‚ä¸ç«‹å³ç§»é™¤çš„åŸå› ï¼šå¯èƒ½æœ‰åœ°æ–¹æ­£åœ¨ä½¿ç”¨ï¼Œé¿å…å—åˆ°å½±å“ã€‚\n170:                         DefaultMQPushConsumerImpl.this.executeTaskLater(new Runnable() {\n171: \n172:                             @Override\n173:                             public void run() {\n174:                                 try {\n175:                                     // æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ°Broker\n176:                                     DefaultMQPushConsumerImpl.this.offsetStore.updateOffset(pullRequest.getMessageQueue(),\n177:                                         pullRequest.getNextOffset(), false);\n178:                                     DefaultMQPushConsumerImpl.this.offsetStore.persist(pullRequest.getMessageQueue());\n179: \n180:                                     // ç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—\n181:                                     DefaultMQPushConsumerImpl.this.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());\n182: \n183:                                     log.warn(\"fix the pull request offset, {}\", pullRequest);\n184:                                 } catch (Throwable e) {\n185:                                     log.error(\"executeTaskLater Exception\", e);\n186:                                 }\n187:                             }\n188:                         }, 10000);\n189:                         break;\n190:                     default:\n191:                         break;\n192:                 }\n193:             }\n194:         }\n195: \n196:         @Override\n197:         public void onException(Throwable e) {\n198:             if (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {\n199:                 log.warn(\"execute the pull request exception\", e);\n200:             }\n201: \n202:             // æäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚\n203:             DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n204:         }\n205:     };\n206: \n207:     // é›†ç¾¤æ¶ˆæ¯æ¨¡å‹ä¸‹ï¼Œè®¡ç®—æäº¤çš„æ¶ˆè´¹è¿›åº¦ã€‚\n208:     boolean commitOffsetEnable = false;\n209:     long commitOffsetValue = 0L;\n210:     if (MessageModel.CLUSTERING == this.defaultMQPushConsumer.getMessageModel()) {\n211:         commitOffsetValue = this.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);\n212:         if (commitOffsetValue > 0) {\n213:             commitOffsetEnable = true;\n214:         }\n215:     }\n216: \n217:     // è®¡ç®—è¯·æ±‚çš„ è®¢é˜…è¡¨è¾¾å¼ å’Œ æ˜¯å¦è¿›è¡Œfiltersrvè¿‡æ»¤æ¶ˆæ¯\n218:     String subExpression = null;\n219:     boolean classFilter = false;\n220:     SubscriptionData sd = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());\n221:     if (sd != null) {\n222:         if (this.defaultMQPushConsumer.isPostSubscriptionWhenPull() && !sd.isClassFilterMode()) {\n223:             subExpression = sd.getSubString();\n224:         }\n225: \n226:         classFilter = sd.isClassFilterMode();\n227:     }\n228: \n229:     // è®¡ç®—æ‹‰å–æ¶ˆæ¯ç³»ç»Ÿæ ‡è¯†\n230:     int sysFlag = PullSysFlag.buildSysFlag(//\n231:         commitOffsetEnable, // commitOffset\n232:         true, // suspend\n233:         subExpression != null, // subscription\n234:         classFilter // class filter\n235:     );\n236: \n237:     // æ‰§è¡Œæ‹‰å–ã€‚å¦‚æœæ‹‰å–è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n238:     try {\n239:         this.pullAPIWrapper.pullKernelImpl(//\n240:             pullRequest.getMessageQueue(), // 1\n241:             subExpression, // 2\n242:             subscriptionData.getSubVersion(), // 3\n243:             pullRequest.getNextOffset(), // 4\n244:             this.defaultMQPushConsumer.getPullBatchSize(), // 5\n245:             sysFlag, // 6\n246:             commitOffsetValue, // 7\n247:             BROKER_SUSPEND_MAX_TIME_MILLIS, // 8\n248:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, // 9\n249:             CommunicationMode.ASYNC, // 10\n250:             pullCallback// 11\n251:         );\n252:     } catch (Exception e) {\n253:         log.error(\"pullKernelImpl exception\", e);\n254:         this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);\n255:     }\n256: }\n257: \n258: private void correctTagsOffset(final PullRequest pullRequest) {\n259:     if (0L == pullRequest.getProcessQueue().getMsgCount().get()) {\n260:         this.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), true);\n261:     }\n262: }\n```\n\n* `#pullMessage(...)` è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯ã€‚\n    * ç¬¬ 3 è‡³ 6 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å·²ç»ç»ˆæ­¢ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚\n    * ç¬¬ 9 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´ã€‚\n    * ç¬¬ 11 è‡³ 18 è¡Œ ï¼š`Consumer` æœªå¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 20 è‡³ 25 è¡Œ ï¼š `Consumer` å¤„äºæš‚åœä¸­ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 27 è‡³ 37 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è¶…è¿‡æœ€å¤§å…è®¸å€¼ï¼ˆé»˜è®¤ï¼š1000æ¡ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 39 è‡³ 49 è¡Œ ï¼š`Consumer` ä¸º**å¹¶å‘æ¶ˆè´¹** å¹¶ä¸” æ¶ˆæ¯é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è·¨åº¦è¿‡å¤§ï¼ˆæ¶ˆæ¯è·¨åº¦ = æŒæœ‰æ¶ˆæ¯æœ€åä¸€æ¡å’Œç¬¬ä¸€æ¡çš„æ¶ˆæ¯ä½ç½®å·®ï¼Œé»˜è®¤ï¼š2000ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 50 è‡³ 70 è¡Œ ï¼š`é¡ºåºæ¶ˆè´¹` ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹](http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/)ã€‚\n    * ç¬¬ 72 è‡³ 78 è¡Œ ï¼š`Topic` å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n    * ç¬¬ 222 è‡³ 224 è¡Œ ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä½¿ç”¨ `Consumer` **æœ¬åœ°**çš„è®¢é˜…ä¿¡æ¯( `SubscriptionData` )ï¼Œè€Œä¸ä½¿ç”¨ `Broker` é‡Œçš„è®¢é˜…ä¿¡æ¯ã€‚è¯¦ç»†è§£æè§ï¼š[PullMessageProcessor#processRequest(...) ç¬¬ 64 è‡³ 110 è¡Œä»£ç ](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-â€¦)ã€‚\n    * ç¬¬ 226 è¡Œ ï¼šæ˜¯å¦å¼€å¯è¿‡æ»¤ç±»è¿‡æ»¤æ¨¡å¼ã€‚è¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” Filtersrvã€‹](http://www.yunai.me/RocketMQ/filtersrv/)ã€‚\n    * ç¬¬ 229 è‡³ 235 è¡Œ ï¼šè®¡ç®—æ‹‰å–æ¶ˆæ¯è¯·æ±‚ç³»ç»Ÿæ ‡è¯†ã€‚è¯¦ç»†è§£æè§ï¼š[PullMessageRequestHeader.sysFlag](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageRequestHeader)ã€‚\n    * ç¬¬ 237 è‡³ 255 è¡Œ ï¼š\n        * æ‰§è¡Œæ¶ˆæ¯æ‹‰å–**å¼‚æ­¥**è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š[PullAPIWrapper#pullKernelImpl(...)](#pullapiwrapperpullkernelimpl)ã€‚\n        * å½“å‘èµ·è¯·æ±‚äº§ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚å¯¹åº” `Broker` å¤„ç†æ‹‰å–æ¶ˆæ¯é€»è¾‘è§ï¼š[PullMessageProcessor#processRequest(...)](http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-â€¦)ã€‚\n* `PullCallback` ï¼šæ‹‰å–æ¶ˆæ¯å›è°ƒï¼š\n   * ç¬¬ 86 è¡Œ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚è¯¦ç»†é€»è¾‘è§ï¼š[PullAPIWrapper#processPullResult(...)](#pullapiwrapperprocesspullresult)ã€‚\n   * ç¬¬ 89 è‡³ 192 è¡Œ ï¼šå¤„ç†æ‹‰å–çŠ¶æ€ç»“æœï¼š\n        * ç¬¬ 90 è‡³ 139 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯( `FOUND` ) ï¼š\n            * ç¬¬ 91 è‡³ 93 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚\n            * ç¬¬ 95 è‡³ 97 è¡Œ ï¼šç»Ÿè®¡ã€‚\n            * ç¬¬ 101 è‡³ 102 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯çš„æ¶ˆæ¯åˆ—è¡¨ä¸ºç©ºï¼Œæäº¤**ç«‹å³**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆæ¯ç»“æœæœªç©ºå‘¢ï¼ŸåŸå› è§ï¼š[PullAPIWrapper#processPullResult(...)](#pullapiwrapperprocesspullresult)ã€‚\n            * ç¬¬ 106 è‡³ 108 è¡Œ ï¼šç»Ÿè®¡ã€‚\n            * ç¬¬ 111 è¡Œ ï¼šæäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š[ProcessQueue#putMessage(...)](#processqueueputmessage)ã€‚\n            * ç¬¬ 113 è‡³ 118 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚åˆ° `ConsumeMessageService`ã€‚è¯¦ç»†è§£æè§ï¼š[ConsumeMessageConcurrentlyService](#consumemessageconcurrentlyservice)ã€‚\n            * ç¬¬ 120 è‡³ 126 è¡Œ ï¼šæ ¹æ®æ‹‰å–é¢‘ç‡( `pullInterval` )ï¼Œæäº¤**ç«‹å³æˆ–è€…å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚é»˜è®¤æ‹‰å–é¢‘ç‡ä¸º 0ms ï¼Œæäº¤**ç«‹å³**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n            * ç¬¬ 129 è‡³ 137 è¡Œ ï¼šä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸º**BUG**ï¼Œè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚\n       * ç¬¬ 140 è‡³ 149 è¡Œ ï¼šæ²¡æœ‰æ–°æ¶ˆæ¯( `NO_NEW_MSG` ) ï¼š\n            * ç¬¬ 142 è¡Œ ï¼š è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚\n            * ç¬¬ 145 è¡Œ ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š`#correctTagsOffset(...)`ã€‚\n            * ç¬¬ 148 è¡Œ ï¼šæäº¤**ç«‹å³**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n       * ç¬¬ 150 è‡³ 159 è¡Œ ï¼šæœ‰æ–°æ¶ˆæ¯ä½†æ˜¯ä¸åŒ¹é…( `NO_MATCHED_MSG` )ã€‚é€»è¾‘åŒ `NO_NEW_MSG` ã€‚\n       * ç¬¬ 160 è‡³ 189 è¡Œ ï¼šæ‹‰å–è¯·æ±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ä¸åˆæ³• (`OFFSET_ILLEGAL`)ã€‚\n            * ç¬¬ 164 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚\n            * ç¬¬ 167 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸º `dropped`ã€‚\n            * ç¬¬ 169 è‡³ 188 è¡Œ ï¼šæäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œé˜Ÿåˆ—ç§»é™¤ã€‚\n                * ç¬¬ 175 è‡³ 178 è¡Œ ï¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° `Broker`ã€‚\n                * ç¬¬ 181 è¡Œ ï¼šç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ã€‚\n                    * ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ç«‹å³ç§»é™¤ï¼Ÿï¼Ÿï¼Ÿ \n  * ç¬¬ 196 è‡³ 204 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œæäº¤**å»¶è¿Ÿ**æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚\n* `#correctTagsOffset(...)` ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚\n    * ç¬¬ 258 è‡³ 261 è¡Œ ï¼š å½“æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯æ•°é‡ä¸º **0** æ—¶ï¼Œæ›´æ–°æ¶ˆè´¹è¿›åº¦ä¸ºæ‹‰å–è¯·æ±‚çš„æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚\n\n### PullAPIWrapper#pullKernelImpl(...)\n\n```Java\n  1: /**\n  2:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•\n  3:  *\n  4:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n  5:  * @param subExpression è®¢é˜…è¡¨è¾¾å¼\n  6:  * @param subVersion è®¢é˜…ç‰ˆæœ¬å·\n  7:  * @param offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®\n  8:  * @param maxNums æ‹‰å–æ¶ˆæ¯æ•°é‡\n  9:  * @param sysFlag æ‹‰å–è¯·æ±‚ç³»ç»Ÿæ ‡è¯†\n 10:  * @param commitOffset æäº¤æ¶ˆè´¹è¿›åº¦\n 11:  * @param brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´\n 12:  * @param timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é•¿\n 13:  * @param communicationMode é€šè®¯æ¨¡å¼\n 14:  * @param pullCallback æ‹‰å–å›è°ƒ\n 15:  * @return æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚\n 16:  * @throws MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸\n 17:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶\n 18:  * @throws MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚\n 19:  * @throws InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶\n 20:  */\n 21: protected PullResult pullKernelImpl(\n 22:     final MessageQueue mq,\n 23:     final String subExpression,\n 24:     final long subVersion,\n 25:     final long offset,\n 26:     final int maxNums,\n 27:     final int sysFlag,\n 28:     final long commitOffset,\n 29:     final long brokerSuspendMaxTimeMillis,\n 30:     final long timeoutMillis,\n 31:     final CommunicationMode communicationMode,\n 32:     final PullCallback pullCallback\n 33: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {\n 34:     // è·å–Brokerä¿¡æ¯\n 35:     FindBrokerResult findBrokerResult =\n 36:         this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),\n 37:             this.recalculatePullFromWhichNode(mq), false);\n 38:     if (null == findBrokerResult) {\n 39:         this.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());\n 40:         findBrokerResult =\n 41:             this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),\n 42:                 this.recalculatePullFromWhichNode(mq), false);\n 43:     }\n 44: \n 45:     // è¯·æ±‚æ‹‰å–æ¶ˆæ¯\n 46:     if (findBrokerResult != null) {\n 47:         int sysFlagInner = sysFlag;\n 48: \n 49:         if (findBrokerResult.isSlave()) {\n 50:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);\n 51:         }\n 52: \n 53:         PullMessageRequestHeader requestHeader = new PullMessageRequestHeader();\n 54:         requestHeader.setConsumerGroup(this.consumerGroup);\n 55:         requestHeader.setTopic(mq.getTopic());\n 56:         requestHeader.setQueueId(mq.getQueueId());\n 57:         requestHeader.setQueueOffset(offset);\n 58:         requestHeader.setMaxMsgNums(maxNums);\n 59:         requestHeader.setSysFlag(sysFlagInner);\n 60:         requestHeader.setCommitOffset(commitOffset);\n 61:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);\n 62:         requestHeader.setSubscription(subExpression);\n 63:         requestHeader.setSubVersion(subVersion);\n 64: \n 65:         String brokerAddr = findBrokerResult.getBrokerAddr();\n 66:         if (PullSysFlag.hasClassFilterFlag(sysFlagInner)) { // TODO filtersrv\n 67:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);\n 68:         }\n 69: \n 70:         PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage(\n 71:             brokerAddr,\n 72:             requestHeader,\n 73:             timeoutMillis,\n 74:             communicationMode,\n 75:             pullCallback);\n 76: \n 77:         return pullResult;\n 78:     }\n 79: \n 80:     // Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n 81:     throw new MQClientException(\"The broker[\" + mq.getBrokerName() + \"] not exist\", null);\n 82: }\n```\n\n* è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚**è¯¥æ–¹æ³•å‚æ•°è¾ƒå¤šï¼Œå¯ä»¥çœ‹ä¸‹ä»£ç æ³¨é‡Šä¸Šæ¯ä¸ªå‚æ•°çš„è¯´æ˜**ğŸ˜ˆã€‚\n* ç¬¬ 34 è‡³ 43 è¡Œ ï¼šè·å– `Broker` ä¿¡æ¯(`Broker` åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚\n    * [#recalculatePullFromWhichNode(...)](#pullapiwrapperrecalculatepullfromwhichnode)\n    * [#MQClientInstance#findBrokerAddressInSubscribe(...)](#mqclientinstancefindbrokeraddressinsubscribe)\n* ç¬¬ 45 è‡³ 78 è¡Œ ï¼š**è¯·æ±‚æ‹‰å–æ¶ˆæ¯**ã€‚\n* ç¬¬ 81 è¡Œ ï¼šå½“ `Broker` ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚\n\n#### PullAPIWrapper#recalculatePullFromWhichNode(...)\n\n```Java\n  1: /**\n  2:  * æ¶ˆæ¯é˜Ÿåˆ— ä¸ æ‹‰å–Broker çš„æ˜ å°„\n  3:  * å½“æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œä¼šé€šè¿‡è¯¥æ˜ å°„è·å–æ‹‰å–è¯·æ±‚å¯¹åº”çš„Broker\n  4:  */\n  5: private ConcurrentHashMap<MessageQueue, AtomicLong/* brokerId */> pullFromWhichNodeTable =\n  6:     new ConcurrentHashMap<MessageQueue, AtomicLong>(32);\n  7: /**\n  8:  * æ˜¯å¦ä½¿ç”¨é»˜è®¤Broker\n  9:  */\n 10: private volatile boolean connectBrokerByUser = false;\n 11: /**\n 12:  * é»˜è®¤Brokerç¼–å·\n 13:  */\n 14: private volatile long defaultBrokerId = MixAll.MASTER_ID;\n 15: \n 16: /**\n 17:  * è®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„Brokerç¼–å·\n 18:  *\n 19:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n 20:  * @return Brokerç¼–å·\n 21:  */\n 22: public long recalculatePullFromWhichNode(final MessageQueue mq) {\n 23:     // è‹¥å¼€å¯é»˜è®¤Brokerå¼€å…³ï¼Œåˆ™è¿”å›é»˜è®¤Brokerç¼–å·\n 24:     if (this.isConnectBrokerByUser()) {\n 25:         return this.defaultBrokerId;\n 26:     }\n 27: \n 28:     // è‹¥æ¶ˆæ¯é˜Ÿåˆ—æ˜ å°„æ‹‰å–Brokerå­˜åœ¨ï¼Œåˆ™è¿”å›æ˜ å°„Brokerç¼–å·\n 29:     AtomicLong suggest = this.pullFromWhichNodeTable.get(mq);\n 30:     if (suggest != null) {\n 31:         return suggest.get();\n 32:     }\n 33: \n 34:     // è¿”å›Brokerä¸»èŠ‚ç‚¹ç¼–å·\n 35:     return MixAll.MASTER_ID;\n 36: }\n```\n\n* è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„ `Broker` ç¼–å·ã€‚\n\n#### MQClientInstance#findBrokerAddressInSubscribe(...)\n\n```Java\n  1: /**\n  2:  * Brokeråå­— å’Œ Brokeråœ°å€ç›¸å…³ Map\n  3:  */\n  4: private final ConcurrentHashMap<String/* Broker Name */, HashMap<Long/* brokerId */, String/* address */>> brokerAddrTable =\n  5:         new ConcurrentHashMap<>();\n  6: \n  7: /**\n  8:  * è·å¾—Brokerä¿¡æ¯\n  9:  *\n 10:  * @param brokerName brokeråå­—\n 11:  * @param brokerId brokerç¼–å·\n 12:  * @param onlyThisBroker æ˜¯å¦å¿…é¡»æ˜¯è¯¥broker\n 13:  * @return Brokerä¿¡æ¯\n 14:  */\n 15: public FindBrokerResult findBrokerAddressInSubscribe(//\n 16:     final String brokerName, //\n 17:     final long brokerId, //\n 18:     final boolean onlyThisBroker//\n 19: ) {\n 20:     String brokerAddr = null; // brokeråœ°å€\n 21:     boolean slave = false; // æ˜¯å¦ä¸ºä»èŠ‚ç‚¹\n 22:     boolean found = false; // æ˜¯å¦æ‰¾åˆ°\n 23: \n 24:     // è·å¾—Brokerä¿¡æ¯\n 25:     HashMap<Long/* brokerId */, String/* address */> map = this.brokerAddrTable.get(brokerName);\n 26:     if (map != null && !map.isEmpty()) {\n 27:         brokerAddr = map.get(brokerId);\n 28:         slave = brokerId != MixAll.MASTER_ID;\n 29:         found = brokerAddr != null;\n 30: \n 31:         // å¦‚æœä¸å¼ºåˆ¶è·å¾—ï¼Œé€‰æ‹©ä¸€ä¸ªBroker\n 32:         if (!found && !onlyThisBroker) {\n 33:             Entry<Long, String> entry = map.entrySet().iterator().next();\n 34:             brokerAddr = entry.getValue();\n 35:             slave = entry.getKey() != MixAll.MASTER_ID;\n 36:             found = true;\n 37:         }\n 38:     }\n 39: \n 40:     // æ‰¾åˆ°brokerï¼Œåˆ™è¿”å›ä¿¡æ¯\n 41:     if (found) {\n 42:         return new FindBrokerResult(brokerAddr, slave);\n 43:     }\n 44: \n 45:     // æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å›ç©º\n 46:     return null;\n 47: }\n```\n\n* è¯´æ˜ ï¼šè·å– `Broker` ä¿¡æ¯(`Broker` åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚\n\n### PullAPIWrapper#processPullResult(...)\n\n```Java\n  1: /**\n  2:  * å¤„ç†æ‹‰å–ç»“æœ\n  3:  * 1. æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„\n  4:  * 2. è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯\n  5:  *\n  6:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—\n  7:  * @param pullResult æ‹‰å–ç»“æœ\n  8:  * @param subscriptionData è®¢é˜…ä¿¡æ¯\n  9:  * @return æ‹‰å–ç»“æœ\n 10:  */\n 11: public PullResult processPullResult(final MessageQueue mq, final PullResult pullResult,\n 12:     final SubscriptionData subscriptionData) {\n 13:     PullResultExt pullResultExt = (PullResultExt) pullResult;\n 14: \n 15:     // æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„\n 16:     this.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());\n 17: \n 18:     // è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯\n 19:     if (PullStatus.FOUND == pullResult.getPullStatus()) {\n 20:         // è§£ææ¶ˆæ¯\n 21:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());\n 22:         List<MessageExt> msgList = MessageDecoder.decodes(byteBuffer);\n 23: \n 24:         // æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯\n 25:         List<MessageExt> msgListFilterAgain = msgList;\n 26:         if (!subscriptionData.getTagsSet().isEmpty() && !subscriptionData.isClassFilterMode()) {\n 27:             msgListFilterAgain = new ArrayList<>(msgList.size());\n 28:             for (MessageExt msg : msgList) {\n 29:                 if (msg.getTags() != null) {\n 30:                     if (subscriptionData.getTagsSet().contains(msg.getTags())) {\n 31:                         msgListFilterAgain.add(msg);\n 32:                     }\n 33:                 }\n 34:             }\n 35:         }\n 36: \n 37:         // Hook\n 38:         if (this.hasHook()) {\n 39:             FilterMessageContext filterMessageContext = new FilterMessageContext();\n 40:             filterMessageContext.setUnitMode(unitMode);\n 41:             filterMessageContext.setMsgList(msgListFilterAgain);\n 42:             this.executeHook(filterMessageContext);\n 43:         }\n 44: \n 45:         // è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µ\n 46:         for (MessageExt msg : msgListFilterAgain) {\n 47:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,\n 48:                 Long.toString(pullResult.getMinOffset()));\n 49:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,\n 50:                 Long.toString(pullResult.getMaxOffset()));\n 51:         }\n 52: \n 53:         // è®¾ç½®æ¶ˆæ¯åˆ—è¡¨\n 54:         pullResultExt.setMsgFoundList(msgListFilterAgain);\n 55:     }\n 56: \n 57:     // æ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„\n 58:     pullResultExt.setMessageBinary(null);\n 59: \n 60:     return pullResult;\n 61: }\n```\n\n* è¯´æ˜ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚\n    *  æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ `Broker` ç¼–å·çš„æ˜ å°„ã€‚\n    *  è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ `tagCode `åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚\n* ç¬¬ 16 è¡Œ ï¼šæ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ `Broker` ç¼–å·çš„æ˜ å°„ã€‚ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæœªè®¾ç½®é»˜è®¤æ‹‰å–çš„ `Broker` ç¼–å·ï¼Œä¼šä½¿ç”¨æ›´æ–°åçš„ `Broker` ç¼–å·ã€‚\n* ç¬¬ 18 è‡³ 55 è¡Œ ï¼šè§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ `tagCode` åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚\n    * ç¬¬ 20 è‡³ 22 è¡Œ ï¼šè§£ææ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š[ã€ŠRocketMQ æºç åˆ†æ â€”â€” MessageåŸºç¡€ã€‹](http://www.yunai.me/RocketMQ/message/) ã€‚\n    * ç¬¬ 24 è‡³ 35 è¡Œ ï¼šæ ¹æ®è®¢é˜…ä¿¡æ¯`tagCode` åŒ¹é…æ¶ˆæ¯ã€‚\n    * ç¬¬ 37 è‡³ 43 è¡Œ ï¼š`Hook`ã€‚\n    * ç¬¬ 45 è‡³ 51 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µã€‚\n    * ç¬¬ 54 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n* ç¬¬ 58 è¡Œ ï¼šæ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„ã€‚\n\n### ProcessQueue#putMessage(...)\n\n```Java\n  1:  /**\n  2:  * æ¶ˆæ¯æ˜ å°„è¯»å†™é”\n  3:  */\n  4: private final ReadWriteLock lockTreeMap = new ReentrantReadWriteLock();\n  5: /**\n  6:  * æ¶ˆæ¯æ˜ å°„\n  7:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n  8:  */\n  9: private final TreeMap<Long, MessageExt> msgTreeMap = new TreeMap<>();\n 10: /**\n 11:  * æ¶ˆæ¯æ•°\n 12:  */\n 13: private final AtomicLong msgCount = new AtomicLong();\n 14: /**\n 15:  * æ·»åŠ æ¶ˆæ¯æœ€å¤§é˜Ÿåˆ—ä½ç½®\n 16:  */\n 17: private volatile long queueOffsetMax = 0L;\n 18: /**\n 19:  * æ˜¯å¦æ­£åœ¨æ¶ˆè´¹\n 20:  */\n 21: private volatile boolean consuming = false;\n 22: /**\n 23:  * Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡\n 24:  * è®¡ç®—å…¬å¼ = queueMaxOffset - æ–°æ·»åŠ æ¶ˆæ¯æ•°ç»„[n - 1].queueOffset\n 25:  * Acc = Accumulation\n 26:  * cnt = ï¼ˆçŒœæµ‹ï¼‰å¯¹æ¯”åº¦\n 27:  */\n 28: private volatile long msgAccCnt = 0;\n 29: \n 30: /**\n 31:  * æ·»åŠ æ¶ˆæ¯ï¼Œå¹¶è¿”å›æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…\n 32:  * è¿”å›trueï¼Œå½“æœ‰æ–°æ¶ˆæ¯æ·»åŠ æˆåŠŸæ—¶ï¼Œ\n 33:  *\n 34:  * @param msgs æ¶ˆæ¯\n 35:  * @return æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…\n 36:  */\n 37: public boolean putMessage(final List<MessageExt> msgs) {\n 38:     boolean dispatchToConsume = false;\n 39:     try {\n 40:         this.lockTreeMap.writeLock().lockInterruptibly();\n 41:         try {\n 42:             // æ·»åŠ æ¶ˆæ¯\n 43:             int validMsgCnt = 0;\n 44:             for (MessageExt msg : msgs) {\n 45:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);\n 46:                 if (null == old) {\n 47:                     validMsgCnt++;\n 48:                     this.queueOffsetMax = msg.getQueueOffset();\n 49:                 }\n 50:             }\n 51:             msgCount.addAndGet(validMsgCnt);\n 52: \n 53:             // è®¡ç®—æ˜¯å¦æ­£åœ¨æ¶ˆè´¹\n 54:             if (!msgTreeMap.isEmpty() && !this.consuming) {\n 55:                 dispatchToConsume = true;\n 56:                 this.consuming = true;\n 57:             }\n 58: \n 59:             // Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡\n 60:             if (!msgs.isEmpty()) {\n 61:                 MessageExt messageExt = msgs.get(msgs.size() - 1);\n 62:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);\n 63:                 if (property != null) {\n 64:                     long accTotal = Long.parseLong(property) - messageExt.getQueueOffset();\n 65:                     if (accTotal > 0) {\n 66:                         this.msgAccCnt = accTotal;\n 67:                     }\n 68:                 }\n 69:             }\n 70:         } finally {\n 71:             this.lockTreeMap.writeLock().unlock();\n 72:         }\n 73:     } catch (InterruptedException e) {\n 74:         log.error(\"putMessage exception\", e);\n 75:     }\n 76: \n 77:     return dispatchToConsume;\n 78: }\n```\n\n## æ€»ç»“\n\nå¦‚æœç”¨æœ€ç®€å•ç²—æš´çš„æ–¹å¼æè¿° `PullConsumer` æ‹‰å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œé‚£å°±æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š\n\n```Java\nwhile (true) {\n    if (ä¸æ»¡è¶³æ‹‰å–æ¶ˆæ¯) {\n        Thread.sleep(é—´éš”);\n        continue;\n    }\n    ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯();\n}\n```\n\n# 6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯\n\n![DefaultMQPushConsumerImplæ¶ˆè´¹æ¶ˆæ¯](http://www.yunai.me/images/RocketMQ/2017_05_04/06.png)\n\n## ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚\n\n### ConsumeMessageConcurrentlyService#submitConsumeRequest(...)\n\n```Java\n  1: /**\n  2:  * æ¶ˆè´¹çº¿ç¨‹æ± é˜Ÿåˆ—\n  3:  */\n  4: private final BlockingQueue<Runnable> consumeRequestQueue;\n  5: /**\n  6:  * æ¶ˆè´¹çº¿ç¨‹æ± \n  7:  */\n  8: private final ThreadPoolExecutor consumeExecutor;\n  9: \n 10: public void submitConsumeRequest(//\n 11:     final List<MessageExt> msgs, //\n 12:     final ProcessQueue processQueue, //\n 13:     final MessageQueue messageQueue, //\n 14:     final boolean dispatchToConsume) {\n 15:     final int consumeBatchSize = this.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();\n 16:     if (msgs.size() <= consumeBatchSize) { // æäº¤æ¶ˆæ¯å°äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚\n 17:         ConsumeRequest consumeRequest = new ConsumeRequest(msgs, processQueue, messageQueue);\n 18:         try {\n 19:             this.consumeExecutor.submit(consumeRequest);\n 20:         } catch (RejectedExecutionException e) {\n 21:             this.submitConsumeRequestLater(consumeRequest);\n 22:         }\n 23:     } else { // æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªæ¶ˆè´¹è¯·æ±‚\n 24:         for (int total = 0; total < msgs.size(); ) {\n 25:             // è®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯\n 26:             List<MessageExt> msgThis = new ArrayList<>(consumeBatchSize);\n 27:             for (int i = 0; i < consumeBatchSize; i++, total++) {\n 28:                 if (total < msgs.size()) {\n 29:                     msgThis.add(msgs.get(total));\n 30:                 } else {\n 31:                     break;\n 32:                 }\n 33:             }\n 34: \n 35:             // æäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚\n 36:             ConsumeRequest consumeRequest = new ConsumeRequest(msgThis, processQueue, messageQueue);\n 37:             try {\n 38:                 this.consumeExecutor.submit(consumeRequest);\n 39:             } catch (RejectedExecutionException e) {\n 40:                 // å¦‚æœè¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯+å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚\n 41:                 for (; total < msgs.size(); total++) {\n 42:                     msgThis.add(msgs.get(total));\n 43:                 }\n 44:                 this.submitConsumeRequestLater(consumeRequest);\n 45:             }\n 46:         }\n 47:     }\n 48: }\n```\n\n* è¯´æ˜ ï¼šæäº¤**ç«‹å³**æ¶ˆè´¹è¯·æ±‚ã€‚\n* ç¬¬ 16 è‡³ 22 è¡Œ ï¼šæäº¤æ¶ˆæ¯å°äºç­‰äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚ã€‚\n* ç¬¬ 23 è‡³ 47 è¡Œ ï¼šå½“æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªè¯·æ±‚ã€‚\n    * ç¬¬ 25 è‡³ 33 è¡Œ ï¼šè®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯ã€‚\n    * ç¬¬ 35 è‡³ 38 è¡Œ ï¼šæäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚ã€‚\n    * ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæäº¤è¯·æ±‚è¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯ + å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ï¼Œç»“æŸæ‹†åˆ†å¾ªç¯ã€‚\n\n### ConsumeMessageConcurrentlyService#submitConsumeRequestLater\n \n ```Java\n   1: /**\n  2:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚\n  3:  *\n  4:  * @param msgs æ¶ˆæ¯åˆ—è¡¨\n  5:  * @param processQueue æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n  6:  * @param messageQueue æ¶ˆæ¯é˜Ÿåˆ—\n  7:  */\n  8: private void submitConsumeRequestLater(//\n  9:     final List<MessageExt> msgs, //\n 10:     final ProcessQueue processQueue, //\n 11:     final MessageQueue messageQueue//\n 12: ) {\n 13: \n 14:     this.scheduledExecutorService.schedule(new Runnable() {\n 15: \n 16:         @Override\n 17:         public void run() {\n 18:             ConsumeMessageConcurrentlyService.this.submitConsumeRequest(msgs, processQueue, messageQueue, true);\n 19:         }\n 20:     }, 5000, TimeUnit.MILLISECONDS);\n 21: }\n 22: \n 23: /**\n 24:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚\n 25:  * @param consumeRequest æ¶ˆè´¹è¯·æ±‚\n 26:  */\n 27: private void submitConsumeRequestLater(final ConsumeRequest consumeRequest//\n 28: ) {\n 29: \n 30:     this.scheduledExecutorService.schedule(new Runnable() {\n 31: \n 32:         @Override\n 33:         public void run() {\n 34:             ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest); // TODO BUG ?\n 35:         }\n 36:     }, 5000, TimeUnit.MILLISECONDS);\n 37: }\n ```\n \n* è¯´æ˜ ï¼šæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚\n* ç¬¬ 34 è¡Œ ï¼šç›´æ¥è°ƒç”¨ `ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);`ã€‚å¦‚æœæ¶ˆæ¯æ•°è¶…è¿‡æ‰¹é‡æ¶ˆè´¹ä¸Šé™ï¼Œä¼šä¸ä¼šæ˜¯**BUG**ã€‚\n \n## ConsumeRequest\n\n```Java\n  1: class ConsumeRequest implements Runnable {\n  2: \n  3:     /**\n  4:      * æ¶ˆè´¹æ¶ˆæ¯åˆ—è¡¨\n  5:      */\n  6:     private final List<MessageExt> msgs;\n  7:     /**\n  8:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—\n  9:      */\n 10:     private final ProcessQueue processQueue;\n 11:     /**\n 12:      * æ¶ˆæ¯é˜Ÿåˆ—\n 13:      */\n 14:     private final MessageQueue messageQueue;\n 15: \n 16:     public ConsumeRequest(List<MessageExt> msgs, ProcessQueue processQueue, MessageQueue messageQueue) {\n 17:         this.msgs = msgs;\n 18:         this.processQueue = processQueue;\n 19:         this.messageQueue = messageQueue;\n 20:     }\n 21: \n 22:     @Override\n 23:     public void run() {\n 24:         // åºŸå¼ƒé˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹\n 25:         if (this.processQueue.isDropped()) {\n 26:             log.info(\"the message queue not be able to consume, because it's dropped. group={} {}\", ConsumeMessageConcurrentlyService.this.consumerGroup, this.messageQueue);\n 27:             return;\n 28:         }\n 29: \n 30:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.this.messageListener; // ç›‘å¬å™¨\n 31:         ConsumeConcurrentlyContext context = new ConsumeConcurrentlyContext(messageQueue); // æ¶ˆè´¹Context\n 32:         ConsumeConcurrentlyStatus status = null; // æ¶ˆè´¹ç»“æœçŠ¶æ€\n 33: \n 34:         // Hook\n 35:         ConsumeMessageContext consumeMessageContext = null;\n 36:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {\n 37:             consumeMessageContext = new ConsumeMessageContext();\n 38:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());\n 39:             consumeMessageContext.setProps(new HashMap<String, String>());\n 40:             consumeMessageContext.setMq(messageQueue);\n 41:             consumeMessageContext.setMsgList(msgs);\n 42:             consumeMessageContext.setSuccess(false);\n 43:             ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);\n 44:         }\n 45: \n 46:         long beginTimestamp = System.currentTimeMillis();\n 47:         boolean hasException = false;\n 48:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; // æ¶ˆè´¹è¿”å›ç»“æœç±»å‹\n 49:         try {\n 50:             // å½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½®Topicä¸ºåŸå§‹Topic\n 51:             ConsumeMessageConcurrentlyService.this.resetRetryTopic(msgs);\n 52: \n 53:             // è®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´\n 54:             if (msgs != null && !msgs.isEmpty()) {\n 55:                 for (MessageExt msg : msgs) {\n 56:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));\n 57:                 }\n 58:             }\n 59: \n 60:             // è¿›è¡Œæ¶ˆè´¹\n 61:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);\n 62:         } catch (Throwable e) {\n 63:             log.warn(\"consumeMessage exception: {} Group: {} Msgs: {} MQ: {}\",\n 64:                 RemotingHelper.exceptionSimpleDesc(e), //\n 65:                 ConsumeMessageConcurrentlyService.this.consumerGroup,\n 66:                 msgs,\n 67:                 messageQueue);\n 68:             hasException = true;\n 69:         }\n 70: \n 71:         // è§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹\n 72:         long consumeRT = System.currentTimeMillis() - beginTimestamp;\n 73:         if (null == status) {\n 74:             if (hasException) {\n 75:                 returnType = ConsumeReturnType.EXCEPTION;\n 76:             } else {\n 77:                 returnType = ConsumeReturnType.RETURNNULL;\n 78:             }\n 79:         } else if (consumeRT >= defaultMQPushConsumer.getConsumeTimeout() * 60 * 1000) {\n 80:             returnType = ConsumeReturnType.TIME_OUT;\n 81:         } else if (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) {\n 82:             returnType = ConsumeReturnType.FAILED;\n 83:         } else if (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) {\n 84:             returnType = ConsumeReturnType.SUCCESS;\n 85:         }\n 86: \n 87:         // Hook\n 88:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {\n 89:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());\n 90:         }\n 91: \n 92:         // æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç©ºæ—¶ï¼Œåˆ™è®¾ç½®ä¸ºç¨åé‡æ–°æ¶ˆè´¹\n 93:         if (null == status) {\n 94:             log.warn(\"consumeMessage return null, Group: {} Msgs: {} MQ: {}\",\n 95:                 ConsumeMessageConcurrentlyService.this.consumerGroup,\n 96:                 msgs,\n 97:                 messageQueue);\n 98:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;\n 99:         }\n100: \n101:         // Hook\n102:         if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) {\n103:             consumeMessageContext.setStatus(status.toString());\n104:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);\n105:             ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);\n106:         }\n107: \n108:         // ç»Ÿè®¡\n109:         ConsumeMessageConcurrentlyService.this.getConsumerStatsManager()\n110:             .incConsumeRT(ConsumeMessageConcurrentlyService.this.consumerGroup, messageQueue.getTopic(), consumeRT);\n111: \n112:         // å¤„ç†æ¶ˆè´¹ç»“æœ\n113:         if (!processQueue.isDropped()) {\n114:             ConsumeMessageConcurrentlyService.this.processConsumeResult(status, context, this);\n115:         } else {\n116:             log.warn(\"processQueue is dropped without process consume result. messageQueue={}, msgs={}\", messageQueue, msgs);\n117:         }\n118:     }\n119: \n120: }\n```\n\n* è¯´æ˜ ï¼šæ¶ˆè´¹è¯·æ±‚ã€‚æäº¤è¯·æ±‚æ‰§è¡Œæ¶ˆè´¹ã€‚\n* ç¬¬ 24 è‡³ 28 è¡Œ ï¼šåºŸå¼ƒå¤„ç†é˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹ã€‚\n* ç¬¬ 34 è‡³ 44 è¡Œ ï¼šHookã€‚\n* ç¬¬ 51 è¡Œ ï¼šå½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½® `Topic`ä¸ºåŸå§‹ `Topic`ã€‚ä¾‹å¦‚ï¼šåŸå§‹ `Topic` ä¸º `TopicTest`ï¼Œé‡è¯•æ—¶ `Topic` ä¸º `%RETRY%please_rename_unique_group_name_4`ï¼Œç»è¿‡è¯¥æ–¹æ³•ï¼Œ`Topic` è®¾ç½®å› `TopicTest`ã€‚\n* ç¬¬ 53 è‡³ 58 è¡Œ ï¼šè®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´ã€‚\n* ç¬¬ 61 è¡Œ ï¼š**è¿›è¡Œæ¶ˆè´¹**ã€‚\n* ç¬¬ 71 è‡³ 85 è¡Œ ï¼šè§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹\n* ç¬¬ 87 è‡³ 90 è¡Œ ï¼š`Hook`ã€‚\n* ç¬¬ 92 è‡³ 99 è¡Œ ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€æœªç©ºæ—¶ï¼Œåˆ™è®¾ç½®æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç¨åæ¶ˆè´¹ã€‚\n* ç¬¬ 101 è‡³ 106 è¡Œ ï¼š`Hook`ã€‚\n* ç¬¬ 108 è‡³ 110 è¡Œ ï¼šç»Ÿè®¡ã€‚\n* ç¬¬ 112 è‡³ 117 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚**å¦‚æœæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—è¢«ç§»é™¤ï¼Œæ°å¥½æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§**ã€‚è¯¦ç»†è§£æè§ï¼š[ConsumeMessageConcurrentlyService#processConsumeResult(...)](#consumemessageconcurrentlyserviceprocessconsumeresult)ã€‚\n\n## ConsumeMessageConcurrentlyService#processConsumeResult(...)\n\n```Java\n  1: public void processConsumeResult(//\n  2:     final ConsumeConcurrentlyStatus status, //\n  3:     final ConsumeConcurrentlyContext context, //\n  4:     final ConsumeRequest consumeRequest//\n  5: ) {\n  6:     int ackIndex = context.getAckIndex();\n  7: \n  8:     // æ¶ˆæ¯ä¸ºç©ºï¼Œç›´æ¥è¿”å›\n  9:     if (consumeRequest.getMsgs().isEmpty())\n 10:         return;\n 11: \n 12:     // è®¡ç®—ä»consumeRequest.msgs[0]åˆ°consumeRequest.msgs[ackIndex]çš„æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ\n 13:     switch (status) {\n 14:         case CONSUME_SUCCESS:\n 15:             if (ackIndex >= consumeRequest.getMsgs().size()) {\n 16:                 ackIndex = consumeRequest.getMsgs().size() - 1;\n 17:             }\n 18:             // ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡\n 19:             int ok = ackIndex + 1;\n 20:             int failed = consumeRequest.getMsgs().size() - ok;\n 21:             this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);\n 22:             this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);\n 23:             break;\n 24:         case RECONSUME_LATER:\n 25:             ackIndex = -1;\n 26:             // ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡\n 27:             this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),\n 28:                 consumeRequest.getMsgs().size());\n 29:             break;\n 30:         default:\n 31:             break;\n 32:     }\n 33: \n 34:     // å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯\n 35:     switch (this.defaultMQPushConsumer.getMessageModel()) {\n 36:         case BROADCASTING: // å¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ°Brokerï¼Œåªæ‰“å°Log\n 37:             for (int i = ackIndex + 1; i < consumeRequest.getMsgs().size(); i++) {\n 38:                 MessageExt msg = consumeRequest.getMsgs().get(i);\n 39:                 log.warn(\"BROADCASTING, the message consume failed, drop it, {}\", msg.toString());\n 40:             }\n 41:             break;\n 42:         case CLUSTERING:\n 43:             // å‘å›æ¶ˆæ¯å¤±è´¥åˆ°Brokerã€‚\n 44:             List<MessageExt> msgBackFailed = new ArrayList<>(consumeRequest.getMsgs().size());\n 45:             for (int i = ackIndex + 1; i < consumeRequest.getMsgs().size(); i++) {\n 46:                 MessageExt msg = consumeRequest.getMsgs().get(i);\n 47:                 boolean result = this.sendMessageBack(msg, context);\n 48:                 if (!result) {\n 49:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);\n 50:                     msgBackFailed.add(msg);\n 51:                 }\n 52:             }\n 53: \n 54:             // å‘å›Brokerå¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹\n 55:             if (!msgBackFailed.isEmpty()) {\n 56:                 consumeRequest.getMsgs().removeAll(msgBackFailed);\n 57: \n 58:                 this.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());\n 59:             }\n 60:             break;\n 61:         default:\n 62:             break;\n 63:     }\n 64: \n 65:     // ç§»é™¤æ¶ˆè´¹æˆåŠŸæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦\n 66:     long offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());\n 67:     if (offset >= 0 && !consumeRequest.getProcessQueue().isDropped()) {\n 68:         this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, true);\n 69:     }\n 70: }\n```\n\n* è¯´æ˜ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚\n* ç¬¬ 8 è‡³ 10 è¡Œ ï¼šæ¶ˆè´¹è¯·æ±‚æ¶ˆæ¯æœªç©ºæ—¶ï¼Œç›´æ¥è¿”å›ã€‚\n* ç¬¬ 12 è‡³ 32 è¡Œ ï¼šè®¡ç®— `ackIndex` å€¼ã€‚`consumeRequest.msgs[0 - ackIndex]`ä¸ºæ¶ˆè´¹æˆåŠŸï¼Œéœ€è¦è¿›è¡Œ `ack` ç¡®è®¤ã€‚\n    * ç¬¬ 14 è‡³ 23 è¡Œ ï¼š`CONSUME_SUCCESS` ï¼š`ackIndex = context.getAckIndex()`ã€‚\n    * ç¬¬ 24 è‡³ 29 è¡Œ ï¼š`RECONSUME_LATER` ï¼š`ackIndex = -1`ã€‚\n* ç¬¬34 è‡³ 63 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ã€‚\n    * ç¬¬ 36 è‡³ 41 è¡Œ ï¼š`BROADCASTING` ï¼šå¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ° `Broker`ï¼Œåªæ‰“å°æ—¥å¿—ã€‚\n    * ç¬¬ 42 è‡³ 60 è¡Œ ï¼š`CLUSTERING` ï¼šé›†ç¾¤æ¨¡å¼ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å›åˆ° `Broker`ã€‚\n        * ç¬¬ 43 è‡³ 52 è¡Œ ï¼šå‘å›æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯åˆ° `Broker`ã€‚è¯¦ç»†è§£æè§ï¼š[DefaultMQPushConsumerImpl#sendMessageBack(...)](#defaultmqpushconsumerimplsendmessageback)ã€‚\n        * ç¬¬ 54 è‡³ 59 è¡Œ ï¼šå‘å› `Broker` å¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹ã€‚\n        * **å¦‚æœå‘å› `Broker` æˆåŠŸï¼Œç»“æœå› ä¸ºä¾‹å¦‚ç½‘ç»œå¼‚å¸¸ï¼Œå¯¼è‡´ `Consumer`ä»¥ä¸ºå‘å›å¤±è´¥ï¼Œåˆ¤å®šæ¶ˆè´¹å‘å›å¤±è´¥ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§ã€‚**\n* ç¬¬ 65 è‡³ 69 è¡Œ ï¼šç§»é™¤**ã€æ¶ˆè´¹æˆåŠŸã€‘**å’Œ**ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›`Broker`æˆåŠŸã€‘**çš„æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦ã€‚\n    * ä¸ºä»€ä¹ˆä¼šæœ‰**ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›`Broker`æˆåŠŸã€‘**çš„æ¶ˆæ¯ï¼Ÿè§**ç¬¬ 56 è¡Œ**ã€‚\n    * [ProcessQueue#removeMessage(...)](#processqueueremovemessage)\n\n### ProcessQueue#removeMessage(...)\n\n```Java\n  1: /**\n  2:  * ç§»é™¤æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç¬¬ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n  3:  *\n  4:  * @param msgs æ¶ˆæ¯\n  5:  * @return æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®\n  6:  */\n  7: public long removeMessage(final List<MessageExt> msgs) {\n  8:     long result = -1;\n  9:     final long now = System.currentTimeMillis();\n 10:     try {\n 11:         this.lockTreeMap.writeLock().lockInterruptibly();\n 12:         this.lastConsumeTimestamp = now;\n 13:         try {\n 14:             if (!msgTreeMap.isEmpty()) {\n 15:                 result = this.queueOffsetMax + 1; // è¿™é‡Œ+1çš„åŸå› æ˜¯ï¼šå¦‚æœmsgTreeMapä¸ºç©ºæ—¶ï¼Œä¸‹ä¸€æ¡è·å¾—çš„æ¶ˆæ¯ä½ç½®ä¸ºqueueOffsetMax+1\n 16: \n 17:                 // ç§»é™¤æ¶ˆæ¯\n 18:                 int removedCnt = 0;\n 19:                 for (MessageExt msg : msgs) {\n 20:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());\n 21:                     if (prev != null) {\n 22:                         removedCnt--;\n 23:                     }\n 24:                 }\n 25:                 msgCount.addAndGet(removedCnt);\n 26: \n 27:                 if (!msgTreeMap.isEmpty()) {\n 28:                     result = msgTreeMap.firstKey();\n 29:                 }\n 30:             }\n 31:         } finally {\n 32:             this.lockTreeMap.writeLock().unlock();\n 33:         }\n 34:     } catch (Throwable t) {\n 35:         log.error(\"removeMessage exception\", t);\n 36:     }\n 37: \n 38:     return result;\n 39: }\n```\n\n## ConsumeMessageConcurrentlyService#cleanExpireMsg(...)\n\n```Java\n  1: public void start() {\n  2:     this.cleanExpireMsgExecutors.scheduleAtFixedRate(new Runnable() {\n  3: \n  4:         @Override\n  5:         public void run() {\n  6:             cleanExpireMsg();\n  7:         }\n  8: \n  9:     }, this.defaultMQPushConsumer.getConsumeTimeout(), this.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);\n 10: }\n 11: \n 12: /**\n 13:  * æ¸…ç†è¿‡æœŸæ¶ˆæ¯\n 14:  */\n 15: private void cleanExpireMsg() {\n 16:     Iterator<Map.Entry<MessageQueue, ProcessQueue>> it =\n 17:         this.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();\n 18:     while (it.hasNext()) {\n 19:         Map.Entry<MessageQueue, ProcessQueue> next = it.next();\n 20:         ProcessQueue pq = next.getValue();\n 21:         pq.cleanExpiredMsg(this.defaultMQPushConsumer);\n 22:     }\n 23: }\n```\n\n* è¯´æ˜ ï¼šå®šæ—¶æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼Œé»˜è®¤å‘¨æœŸï¼š15minã€‚\n\n### ProcessQueue#cleanExpiredMsg(...)\n\n```Java\n  1: public void cleanExpiredMsg(DefaultMQPushConsumer pushConsumer) {\n  2:     // é¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›\n  3:     if (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) {\n  4:         return;\n  5:     }\n  6: \n  7:     // å¾ªç¯ç§»é™¤æ¶ˆæ¯\n  8:     int loop = msgTreeMap.size() < 16 ? msgTreeMap.size() : 16; // æ¯æ¬¡å¾ªç¯æœ€å¤šç§»é™¤16æ¡\n  9:     for (int i = 0; i < loop; i++) {\n 10:         // è·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯\n 11:         MessageExt msg = null;\n 12:         try {\n 13:             this.lockTreeMap.readLock().lockInterruptibly();\n 14:             try {\n 15:                 if (!msgTreeMap.isEmpty() && System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) > pushConsumer.getConsumeTimeout() * 60 * 1000) {\n 16:                     msg = msgTreeMap.firstEntry().getValue();\n 17:                 } else {\n 18:                     break;\n 19:                 }\n 20:             } finally {\n 21:                 this.lockTreeMap.readLock().unlock();\n 22:             }\n 23:         } catch (InterruptedException e) {\n 24:             log.error(\"getExpiredMsg exception\", e);\n 25:         }\n 26: \n 27:         try {\n 28:             // å‘å›è¶…æ—¶æ¶ˆæ¯\n 29:             pushConsumer.sendMessageBack(msg, 3);\n 30:             log.info(\"send expire msg back. topic={}, msgId={}, storeHost={}, queueId={}, queueOffset={}\", msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());\n 31: \n 32:             // åˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤\n 33:             try {\n 34:                 this.lockTreeMap.writeLock().lockInterruptibly();\n 35:                 try {\n 36:                     if (!msgTreeMap.isEmpty() && msg.getQueueOffset() == msgTreeMap.firstKey()) {\n 37:                         try {\n 38:                             msgTreeMap.remove(msgTreeMap.firstKey());\n 39:                         } catch (Exception e) {\n 40:                             log.error(\"send expired msg exception\", e);\n 41:                         }\n 42:                     }\n 43:                 } finally {\n 44:                     this.lockTreeMap.writeLock().unlock();\n 45:                 }\n 46:             } catch (InterruptedException e) {\n 47:                 log.error(\"getExpiredMsg exception\", e);\n 48:             }\n 49:         } catch (Exception e) {\n 50:             log.error(\"send expired msg exception\", e);\n 51:         }\n 52:     }\n 53: }\n```\n\n* è¯´æ˜ ï¼šç§»é™¤è¿‡æœŸæ¶ˆæ¯ã€‚\n* ç¬¬ 2 è‡³ 5 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚\n* ç¬¬ 7 è‡³ 9 è¡Œ ï¼šå¾ªç¯ç§»é™¤æ¶ˆæ¯ã€‚é»˜è®¤æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼š16æ¬¡ã€‚\n* ç¬¬ 10 è‡³ 25 è¡Œ ï¼šè·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚\n* ç¬¬ 29 è¡Œ ï¼š**å‘å›è¶…æ—¶æ¶ˆæ¯åˆ°`Broker`**ã€‚\n* ç¬¬ 32 è‡³ 48 è¡Œ ï¼šåˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤ã€‚\n\n# 7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯\n\n## DefaultMQPushConsumerImpl#sendMessageBack(...)\n\n```Java\n  1: public void sendMessageBack(MessageExt msg, int delayLevel, final String brokerName)\n  2:     throws RemotingException, MQBrokerException, InterruptedException, MQClientException {\n  3:     try {\n  4:         // Consumerå‘å›æ¶ˆæ¯\n  5:         String brokerAddr = (null != brokerName) ? this.mQClientFactory.findBrokerAddressInPublish(brokerName)\n  6:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());\n  7:         this.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,\n  8:             this.defaultMQPushConsumer.getConsumerGroup(), delayLevel, 5000, getMaxReconsumeTimes());\n  9:     } catch (Exception e) { // TODO ç–‘é—®ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸\n 10:         // å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨Clientå†…ç½®Producerå‘å›æ¶ˆæ¯\n 11:         log.error(\"sendMessageBack Exception, \" + this.defaultMQPushConsumer.getConsumerGroup(), e);\n 12: \n 13:         Message newMsg = new Message(MixAll.getRetryTopic(this.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());\n 14: \n 15:         String originMsgId = MessageAccessor.getOriginMessageId(msg);\n 16:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);\n 17: \n 18:         newMsg.setFlag(msg.getFlag());\n 19:         MessageAccessor.setProperties(newMsg, msg.getProperties());\n 20:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());\n 21:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + 1));\n 22:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));\n 23:         newMsg.setDelayTimeLevel(3 + msg.getReconsumeTimes());\n 24: \n 25:         this.mQClientFactory.getDefaultMQProducer().send(newMsg);\n 26:     }\n 27: }\n```\n\n* è¯´æ˜ ï¼šå‘å›æ¶ˆæ¯ã€‚\n* ç¬¬ 4 è‡³ 8 è¡Œ ï¼š`Consumer` å‘å›æ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š[MQClientAPIImpl#consumerSendMessageBack(...)](#mqclientapiimplconsumersendmessageback)ã€‚\n* ç¬¬ 10 è‡³ 25 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ`Consumer` å†…ç½®é»˜è®¤ `Producer` å‘é€æ¶ˆæ¯ã€‚\n    * ğŸ˜ˆç–‘é—®ï¼šä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸å‘¢ï¼Ÿ\n\n### MQClientAPIImpl#consumerSendMessageBack(...)\n\n```Java\n  1: /**\n  2:  * Consumerå‘å›æ¶ˆæ¯\n  3:  * @param addr Brokeråœ°å€\n  4:  * @param msg æ¶ˆæ¯\n  5:  * @param consumerGroup æ¶ˆè´¹åˆ†ç»„\n  6:  * @param delayLevel å»¶è¿Ÿçº§åˆ«\n  7:  * @param timeoutMillis è¶…æ—¶\n  8:  * @param maxConsumeRetryTimes æ¶ˆè´¹æœ€å¤§é‡è¯•æ¬¡æ•°\n  9:  * @throws RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶\n 10:  * @throws MQBrokerException å½“Brokerå‘ç”Ÿå¼‚å¸¸æ—¶\n 11:  * @throws InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶\n 12:  */\n 13: public void consumerSendMessageBack(\n 14:     final String addr,\n 15:     final MessageExt msg,\n 16:     final String consumerGroup,\n 17:     final int delayLevel,\n 18:     final long timeoutMillis,\n 19:     final int maxConsumeRetryTimes\n 20: ) throws RemotingException, MQBrokerException, InterruptedException {\n 21:     ConsumerSendMsgBackRequestHeader requestHeader = new ConsumerSendMsgBackRequestHeader();\n 22:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);\n 23: \n 24:     requestHeader.setGroup(consumerGroup);\n 25:     requestHeader.setOriginTopic(msg.getTopic());\n 26:     requestHeader.setOffset(msg.getCommitLogOffset());\n 27:     requestHeader.setDelayLevel(delayLevel);\n 28:     requestHeader.setOriginMsgId(msg.getMsgId());\n 29:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);\n 30: \n 31:     RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),\n 32:         request, timeoutMillis);\n 33:     assert response != null;\n 34:     switch (response.getCode()) {\n 35:         case ResponseCode.SUCCESS: {\n 36:             return;\n 37:         }\n 38:         default:\n 39:             break;\n 40:     }\n 41: \n 42:     throw new MQBrokerException(response.getCode(), response.getRemark());\n 43: }\n```\n\n# 8ã€Consumer æ¶ˆè´¹è¿›åº¦\n\n## OffsetStore\n\n![OffsetStoreç±»å›¾.png](http://www.yunai.me/images/RocketMQ/2017_05_04/07.png)\n\n* `RemoteBrokerOffsetStore` ï¼š`Consumer` **é›†ç¾¤æ¨¡å¼** ä¸‹ï¼Œä½¿ç”¨è¿œç¨‹ `Broker` æ¶ˆè´¹è¿›åº¦ã€‚\n* `LocalFileOffsetStore` ï¼š`Consumer` **å¹¿æ’­æ¨¡å¼**ä¸‹ï¼Œä½¿ç”¨æœ¬åœ° `æ–‡ä»¶` æ¶ˆè´¹è¿›åº¦ã€‚\n\n### OffsetStore#load(...)\n\n#### LocalFileOffsetStore#load(...)\n\n```Java\n  1: @Override\n  2: public void load() throws MQClientException {\n  3:     // ä»æœ¬åœ°ç¡¬ç›˜è¯»å–æ¶ˆè´¹è¿›åº¦\n  4:     OffsetSerializeWrapper offsetSerializeWrapper = this.readLocalOffset();\n  5:     if (offsetSerializeWrapper != null && offsetSerializeWrapper.getOffsetTable() != null) {\n  6:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());\n  7: \n  8:         // æ‰“å°æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦\n  9:         for (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) {\n 10:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);\n 11:             log.info(\"load consumer's offset, {} {} {}\",\n 12:                 this.groupName,\n 13:                 mq,\n 14:                 offset.get());\n 15:         }\n 16:     }\n 17: }\n```\n\n* è¯´æ˜ ï¼šä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ¶ˆè´¹è¿›åº¦åˆ°å†…å­˜ã€‚\n\n##### OffsetSerializeWrapper\n\n```Java\n  1: public class OffsetSerializeWrapper extends RemotingSerializable {\n  2:     private ConcurrentHashMap<MessageQueue, AtomicLong> offsetTable =\n  3:             new ConcurrentHashMap<>();\n  4: \n  5:     public ConcurrentHashMap<MessageQueue, AtomicLong> getOffsetTable() {\n  6:         return offsetTable;\n  7:     }\n  8: \n  9:     public void setOffsetTable(ConcurrentHashMap<MessageQueue, AtomicLong> offsetTable) {\n 10:         this.offsetTable = offsetTable;\n 11:     }\n 12: }\n```\n\n* è¯´æ˜ ï¼šæœ¬åœ° `Offset` å­˜å‚¨åºåˆ—åŒ–ã€‚\n\n```Bash\nYunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json\n{\n\t\"offsetTable\":{{\n\t\t\t\"brokerName\":\"broker-a\",\n\t\t\t\"queueId\":3,\n\t\t\t\"topic\":\"TopicTest\"\n\t\t}:1470,{\n\t\t\t\"brokerName\":\"broker-a\",\n\t\t\t\"queueId\":2,\n\t\t\t\"topic\":\"TopicTest\"\n\t\t}:1471,{\n\t\t\t\"brokerName\":\"broker-a\",\n\t\t\t\"queueId\":1,\n\t\t\t\"topic\":\"TopicTest\"\n\t\t}:1470,{\n\t\t\t\"brokerName\":\"broker-a\",\n\t\t\t\"queueId\":0,\n\t\t\t\"topic\":\"TopicTest\"\n\t\t}:1470\n\t}\n}\n```\n\n#### RemoteBrokerOffsetStore#load(...)\n\n```Java\n  1: @Override\n  2: public void load() {\n  3: }\n```\n\n* è¯´æ˜ ï¼šä¸è¿›è¡ŒåŠ è½½ï¼Œå®é™…è¯»å–æ¶ˆè´¹è¿›åº¦æ—¶ï¼Œä» `Broker` è·å–ã€‚\n\n### OffsetStore#readOffset(...)\n\nè¯»å–æ¶ˆè´¹è¿›åº¦ç±»å‹ï¼š\n\n* `READ_FROM_MEMORY` ï¼šä»å†…å­˜è¯»å–ã€‚\n* `READ_FROM_STORE` ï¼šä»å­˜å‚¨( `Broker` æˆ– `æ–‡ä»¶` )è¯»å–ã€‚\n* `MEMORY_FIRST_THEN_STORE` ï¼šä¼˜å…ˆä»å†…å­˜è¯»å–ï¼Œè¯»å–ä¸åˆ°ï¼Œä»å­˜å‚¨è¯»å–ã€‚\n\n#### LocalFileOffsetStore#readOffset(...)\n\n```Java\n  1: @Override\n  2: public long readOffset(final MessageQueue mq, final ReadOffsetType type) {\n  3:     if (mq != null) {\n  4:         switch (type) {\n  5:             case MEMORY_FIRST_THEN_STORE:\n  6:             case READ_FROM_MEMORY: {\n  7:                 AtomicLong offset = this.offsetTable.get(mq);\n  8:                 if (offset != null) {\n  9:                     return offset.get();\n 10:                 } else if (ReadOffsetType.READ_FROM_MEMORY == type) {\n 11:                     return -1;\n 12:                 }\n 13:             }\n 14:             case READ_FROM_STORE: {\n 15:                 OffsetSerializeWrapper offsetSerializeWrapper;\n 16:                 try {\n 17:                     offsetSerializeWrapper = this.readLocalOffset();\n 18:                 } catch (MQClientException e) {\n 19:                     return -1;\n 20:                 }\n 21:                 if (offsetSerializeWrapper != null && offsetSerializeWrapper.getOffsetTable() != null) {\n 22:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);\n 23:                     if (offset != null) {\n 24:                         this.updateOffset(mq, offset.get(), false);\n 25:                         return offset.get();\n 26:                     }\n 27:                 }\n 28:             }\n 29:             default:\n 30:                 break;\n 31:         }\n 32:     }\n 33: \n 34:     return -1;\n 35: }\n```\n\n* ç¬¬ 16 è¡Œ ï¼šä» `æ–‡ä»¶` è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚\n\n#### RemoteBrokerOffsetStore#readOffset(...)\n\n```Java\n  1: @Override\n  2: public long readOffset(final MessageQueue mq, final ReadOffsetType type) {\n  3:     if (mq != null) {\n  4:         switch (type) {\n  5:             case MEMORY_FIRST_THEN_STORE:\n  6:             case READ_FROM_MEMORY: {\n  7:                 AtomicLong offset = this.offsetTable.get(mq);\n  8:                 if (offset != null) {\n  9:                     return offset.get();\n 10:                 } else if (ReadOffsetType.READ_FROM_MEMORY == type) {\n 11:                     return -1;\n 12:                 }\n 13:             }\n 14:             case READ_FROM_STORE: {\n 15:                 try {\n 16:                     long brokerOffset = this.fetchConsumeOffsetFromBroker(mq);\n 17:                     AtomicLong offset = new AtomicLong(brokerOffset);\n 18:                     this.updateOffset(mq, offset.get(), false);\n 19:                     return brokerOffset;\n 20:                 }\n 21:                 // No offset in broker\n 22:                 catch (MQBrokerException e) {\n 23:                     return -1;\n 24:                 }\n 25:                 //Other exceptions\n 26:                 catch (Exception e) {\n 27:                     log.warn(\"fetchConsumeOffsetFromBroker exception, \" + mq, e);\n 28:                     return -2;\n 29:                 }\n 30:             }\n 31:             default:\n 32:                 break;\n 33:         }\n 34:     }\n 35: \n 36:     return -1;\n 37: }\n```\n\n* ç¬¬ 16 è¡Œ ï¼šä» `Broker` è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚\n\n### OffsetStore#updateOffset(...)\n\nè¯¥æ–¹æ³• `RemoteBrokerOffsetStore` ä¸ `LocalFileOffsetStore` å®ç°ç›¸åŒã€‚\n\n```Java\n  1: @Override\n  2: public void updateOffset(MessageQueue mq, long offset, boolean increaseOnly) {\n  3:     if (mq != null) {\n  4:         AtomicLong offsetOld = this.offsetTable.get(mq);\n  5:         if (null == offsetOld) {\n  6:             offsetOld = this.offsetTable.putIfAbsent(mq, new AtomicLong(offset));\n  7:         }\n  8: \n  9:         if (null != offsetOld) {\n 10:             if (increaseOnly) {\n 11:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);\n 12:             } else {\n 13:                 offsetOld.set(offset);\n 14:             }\n 15:         }\n 16:     }\n 17: }\n```\n\n### OffsetStore#persistAll(...)\n\n#### LocalFileOffsetStore#persistAll(...)\n\n```Java\n  1: @Override\n  2: public void persistAll(Set<MessageQueue> mqs) {\n  3:     if (null == mqs || mqs.isEmpty())\n  4:         return;\n  5: \n  6:     OffsetSerializeWrapper offsetSerializeWrapper = new OffsetSerializeWrapper();\n  7:     for (Map.Entry<MessageQueue, AtomicLong> entry : this.offsetTable.entrySet()) {\n  8:         if (mqs.contains(entry.getKey())) {\n  9:             AtomicLong offset = entry.getValue();\n 10:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);\n 11:         }\n 12:     }\n 13: \n 14:     String jsonString = offsetSerializeWrapper.toJson(true);\n 15:     if (jsonString != null) {\n 16:         try {\n 17:             MixAll.string2File(jsonString, this.storePath);\n 18:         } catch (IOException e) {\n 19:             log.error(\"persistAll consumer offset Exception, \" + this.storePath, e);\n 20:         }\n 21:     }\n 22: }\n```\n\n* è¯´æ˜ ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ã€‚**å°†æ¶ˆè´¹è¿›åº¦å†™å…¥æ–‡ä»¶**ã€‚\n\n#### RemoteBrokerOffsetStore#persistAll(...)\n\n```Java\n  1: @Override\n  2: public void persistAll(Set<MessageQueue> mqs) {\n  3:     if (null == mqs || mqs.isEmpty())\n  4:         return;\n  5: \n  6:     // æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—\n  7:     final HashSet<MessageQueue> unusedMQ = new HashSet<>();\n  8:     if (!mqs.isEmpty()) {\n  9:         for (Map.Entry<MessageQueue, AtomicLong> entry : this.offsetTable.entrySet()) {\n 10:             MessageQueue mq = entry.getKey();\n 11:             AtomicLong offset = entry.getValue();\n 12:             if (offset != null) {\n 13:                 if (mqs.contains(mq)) {\n 14:                     try {\n 15:                         this.updateConsumeOffsetToBroker(mq, offset.get());\n 16:                         log.info(\"[persistAll] Group: {} ClientId: {} updateConsumeOffsetToBroker {} {}\",\n 17:                             this.groupName,\n 18:                             this.mQClientFactory.getClientId(),\n 19:                             mq,\n 20:                             offset.get());\n 21:                     } catch (Exception e) {\n 22:                         log.error(\"updateConsumeOffsetToBroker exception, \" + mq.toString(), e);\n 23:                     }\n 24:                 } else {\n 25:                     unusedMQ.add(mq);\n 26:                 }\n 27:             }\n 28:         }\n 29:     }\n 30: \n 31:     // ç§»é™¤ä¸é€‚ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—\n 32:     if (!unusedMQ.isEmpty()) {\n 33:         for (MessageQueue mq : unusedMQ) {\n 34:             this.offsetTable.remove(mq);\n 35:             log.info(\"remove unused mq, {}, {}\", mq, this.groupName);\n 36:         }\n 37:     }\n 38: }\n```\n\n* è¯´æ˜ ï¼šæŒä¹…åŒ–æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„çš„æ¶ˆè´¹è¿›åº¦åˆ° `Broker`ï¼Œå¹¶ç§»é™¤éæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚\n\n#### MQClientInstance#persistAllConsumerOffset(...)\n\n```Java\n  1: private void startScheduledTask() {\n  2:     // å®šæ—¶åŒæ­¥æ¶ˆè´¹è¿›åº¦\n  3:     this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n  4: \n  5:         @Override\n  6:         public void run() {\n  7:             try {\n  8:                 MQClientInstance.this.cleanOfflineBroker();\n  9:                 MQClientInstance.this.sendHeartbeatToAllBrokerWithLock();\n 10:             } catch (Exception e) {\n 11:                 log.error(\"ScheduledTask sendHeartbeatToAllBroker exception\", e);\n 12:             }\n 13:         }\n 14:     }, 1000, this.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);\n 15: }\n```\n\n* è¯´æ˜ ï¼šå®šæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œé»˜è®¤å‘¨æœŸï¼š5000msã€‚\n* **é‡è¦è¯´æ˜ ï¼š**\n    * **æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚** \n    * **æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚** \n    * **æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚** \n\n# 9ã€ç»“å°¾\n\nğŸ˜ˆå¯èƒ½æ˜¯æœ¬ç³»åˆ—æœ€é•¿çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœ‰è¡¨è¾¾é”™è¯¯å’Œä¸æ¸…æ™°ï¼Œè¯·å¤šå¤šè§è°…ã€‚  \næ„Ÿè°¢å¯¹æœ¬ç³»åˆ—çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯ç¿»åˆ°ç»“å°¾ã€‚ğŸ˜œçœŸçš„æœ‰ä¸¢ä¸¢é•¿ã€‚\n\n\n","slug":"RocketMQ/message-pull-and-consume-second","published":1,"updated":"2017-06-08T13:17:58.000Z","_id":"cj3ndswzu001dak5dlnkm040q","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>åŸæ–‡åœ°å€ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-second/\">http://www.yunai.me/RocketMQ/message-pull-and-consume-second/</a><br>\n<code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/incubator-rocketmq</a><br>\n**ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **</p>\n</blockquote>\n<p><img src=\"http://www.yunai.me/images/common/wechat_mp.jpeg\" alt=\"wechat_mp\"></p>\n<hr>\n<ul>\n<li><a href=\"#\">1ã€æ¦‚è¿°</a></li>\n<li><a href=\"#\">2ã€Consumer</a></li>\n<li><a href=\"#\">3ã€PushConsumer ä¸€è§ˆ</a></li>\n<li><a href=\"#\">4ã€PushConsumer è®¢é˜…</a>\n<ul>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#subscribe(...)</a>\n<ul>\n<li><a href=\"#\">FilterAPI.buildSubscriptionData(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">DefaultMQPushConsumer#registerMessageListener(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</a>\n<ul>\n<li><a href=\"#\">RebalanceService</a></li>\n<li><a href=\"#\">MQClientInstance#doRebalance(...)</a></li>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#doRebalance(...)</a></li>\n<li><a href=\"#\">RebalanceImpl#doRebalance(...)</a>\n<ul>\n<li><a href=\"#\">RebalanceImpl#rebalanceByTopic(...)</a></li>\n<li><a href=\"#\">RebalanceImpl#removeUnnecessaryMessageQueue(...)</a>\n<ul>\n<li><a href=\"#\">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</a></li>\n<li><a href=\"#\">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">RebalancePushImpl#dispatchPullRequest(...)</a>\n<ul>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">AllocateMessageQueueStrategy</a>\n<ul>\n<li><a href=\"#\">AllocateMessageQueueAveragely</a></li>\n<li><a href=\"#\">AllocateMessageQueueByMachineRoom</a></li>\n<li><a href=\"#\">AllocateMessageQueueAveragelyByCircle</a></li>\n<li><a href=\"#\">AllocateMessageQueueByConfig</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</a>\n<ul>\n<li><a href=\"#\">RebalancePushImpl#computePullFromWhere(...)</a></li>\n<li><a href=\"#\">[PullConsumer] RebalancePullImpl#computePullFromWhere(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</a>\n<ul>\n<li><a href=\"#\">PullMessageService</a></li>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#pullMessage(...)</a>\n<ul>\n<li><a href=\"#\">PullAPIWrapper#pullKernelImpl(...)</a>\n<ul>\n<li><a href=\"#\">PullAPIWrapper#recalculatePullFromWhichNode(...)</a></li>\n<li><a href=\"#\">MQClientInstance#findBrokerAddressInSubscribe(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">PullAPIWrapper#processPullResult(...)</a></li>\n<li><a href=\"#\">ProcessQueue#putMessage(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">æ€»ç»“</a></li>\n</ul>\n</li>\n<li><a href=\"#\">6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</a>\n<ul>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</a>\n<ul>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</a></li>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</a></li>\n</ul>\n</li>\n<li><a href=\"#\">ConsumeRequest</a></li>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService#processConsumeResult(...)</a>\n<ul>\n<li><a href=\"#\">ProcessQueue#removeMessage(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</a>\n<ul>\n<li><a href=\"#\">ProcessQueue#cleanExpiredMsg(...)</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</a>\n<ul>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#sendMessageBack(...)</a>\n<ul>\n<li><a href=\"#\">MQClientAPIImpl#consumerSendMessageBack(...)</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">8ã€Consumer æ¶ˆè´¹è¿›åº¦</a>\n<ul>\n<li><a href=\"#\">OffsetStore</a>\n<ul>\n<li><a href=\"#\">OffsetStore#load(...)</a>\n<ul>\n<li><a href=\"#\">LocalFileOffsetStore#load(...)</a>\n<ul>\n<li><a href=\"#\">OffsetSerializeWrapper</a></li>\n</ul>\n</li>\n<li><a href=\"#\">RemoteBrokerOffsetStore#load(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">OffsetStore#readOffset(...)</a>\n<ul>\n<li><a href=\"#\">LocalFileOffsetStore#readOffset(...)</a></li>\n<li><a href=\"#\">RemoteBrokerOffsetStore#readOffset(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">OffsetStore#updateOffset(...)</a></li>\n<li><a href=\"#\">OffsetStore#persistAll(...)</a>\n<ul>\n<li><a href=\"#\">LocalFileOffsetStore#persistAll(...)</a></li>\n<li><a href=\"#\">RemoteBrokerOffsetStore#persistAll(...)</a></li>\n<li><a href=\"#\">MQClientInstance#persistAllConsumerOffset(...)</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">9ã€ç»“å°¾</a></li>\n</ul>\n<hr>\n<h1>1ã€æ¦‚è¿°</h1>\n<p>æœ¬æ–‡æ¥ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ã€‹</a>ã€‚</p>\n<p>ä¸»è¦è§£æ <code>Consumer</code> åœ¨ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚</p>\n<h1>2ã€Consumer</h1>\n<p>MQ æä¾›äº†ä¸¤ç±»æ¶ˆè´¹è€…ï¼š</p>\n<ul>\n<li>PushConsumerï¼š\n<ul>\n<li>åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ä½¿ç”¨ã€‚</li>\n<li>åå­—è™½ç„¶æ˜¯ <code>Push</code> å¼€å¤´ï¼Œå®é™…åœ¨å®ç°æ—¶ï¼Œä½¿ç”¨ <code>Pull</code> æ–¹å¼å®ç°ã€‚é€šè¿‡ <code>Pull</code> <strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>è½®è¯¢ <code>Broker</code> è·å–æ¶ˆæ¯ã€‚å½“ä¸å­˜åœ¨æ–°æ¶ˆæ¯æ—¶ï¼Œ<code>Broker</code> ä¼š<strong>æŒ‚èµ·è¯·æ±‚</strong>ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯äº§ç”Ÿï¼Œå–æ¶ˆæŒ‚èµ·ï¼Œè¿”å›æ–°æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒåŸºæœ¬å’Œ <code>Broker</code> ä¸»åŠ¨ <code>Push</code> åšåˆ°<strong>æ¥è¿‘</strong>çš„å®æ—¶æ€§ï¼ˆå½“ç„¶ï¼Œè¿˜æ˜¯æœ‰ç›¸åº”çš„å®æ—¶æ€§æŸå¤±ï¼‰ã€‚åŸç†ç±»ä¼¼ <strong><a href=\"https://www.ibm.com/developerworks/cn/web/wa-lo-comet/\" target=\"_blank\" rel=\"external\">é•¿è½®è¯¢( <code>Long-Polling</code> )</a></strong>ã€‚</li>\n</ul>\n</li>\n<li>PullConsumer</li>\n</ul>\n<p><strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br>\n<strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br>\n<strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong></p>\n<h1>3ã€PushConsumer ä¸€è§ˆ</h1>\n<p>å…ˆçœ‹ä¸€å¼  <code>PushConsumer</code> åŒ…å«çš„ç»„ä»¶ä»¥åŠç»„ä»¶ä¹‹é—´çš„äº¤äº’å›¾ï¼š</p>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/09.png\" alt=\"PushConsumeræ‰‹ç»˜å›¾.png\"></p>\n<ul>\n<li><code>RebalanceService</code>ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚å½“æœ‰æ–°çš„ <code>Consumer</code> çš„åŠ å…¥æˆ–ç§»é™¤ï¼Œéƒ½ä¼šé‡æ–°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li><code>PullMessageService</code>ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li>\n<li><code>ConsumeMessageService</code>ï¼šæ¶ˆè´¹æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>\n<li><code>RemoteBrokerOffsetStore</code>ï¼š<code>Consumer</code> æ¶ˆè´¹è¿›åº¦ç®¡ç†ï¼Œè´Ÿè´£ä» <code>Broker</code> è·å–æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li>\n<li><code>ProcessQueue</code> ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚</li>\n<li><code>MQClientInstance</code> ï¼šå°è£…å¯¹ <code>Namesrv</code>ï¼Œ<code>Broker</code> çš„ APIè°ƒç”¨ï¼Œæä¾›ç»™ <code>Producer</code>ã€<code>Consumer</code> ä½¿ç”¨ã€‚</li>\n</ul>\n<h1>4ã€PushConsumer è®¢é˜…</h1>\n<h2>DefaultMQPushConsumerImpl#subscribe(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">subscribe</span><span class=\"params\">(String topic, String subExpression)</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:         <span class=\"comment\">// åˆ›å»ºè®¢é˜…æ•°æ®</span></div><div class=\"line\"> <span class=\"number\">4</span>:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(<span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">5</span>:             topic, subExpression);</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">this</span>.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// é€šè¿‡å¿ƒè·³åŒæ­¥Consumerä¿¡æ¯åˆ°Broker</span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.mQClientFactory != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</div><div class=\"line\"><span class=\"number\">10</span>:         &#125;</div><div class=\"line\"><span class=\"number\">11</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"subscription exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">13</span>:     &#125;</div><div class=\"line\"><span class=\"number\">14</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šè®¢é˜… <code>Topic</code> ã€‚</li>\n<li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šåˆ›å»ºè®¢é˜…æ•°æ®ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#filterapibuildsubscriptiondata\">FilterAPI.buildSubscriptionData(...)</a>ã€‚</li>\n<li>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šé€šè¿‡å¿ƒè·³åŒæ­¥ <code>Consumer</code> ä¿¡æ¯åˆ° <code>Broker</code>ã€‚</li>\n</ul>\n<h3>FilterAPI.buildSubscriptionData(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> SubscriptionData <span class=\"title\">buildSubscriptionData</span><span class=\"params\">(<span class=\"keyword\">final</span> String consumerGroup, String topic,</span></span></div><div class=\"line\"> <span class=\"number\">2</span>:     String subString) <span class=\"keyword\">throws</span> Exception &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     SubscriptionData subscriptionData = <span class=\"keyword\">new</span> SubscriptionData();</div><div class=\"line\"> <span class=\"number\">4</span>:     subscriptionData.setTopic(topic);</div><div class=\"line\"> <span class=\"number\">5</span>:     subscriptionData.setSubString(subString);</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">// å¤„ç†è®¢é˜…è¡¨è¾¾å¼</span></div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);</div><div class=\"line\"> <span class=\"number\">9</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         String[] tags = subString.split(<span class=\"string\">\"\\\\|\\\\|\"</span>);</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">if</span> (tags.length &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">for</span> (String tag : tags) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">if</span> (tag.length() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:                     String trimString = tag.trim();</div><div class=\"line\"><span class=\"number\">15</span>:                     <span class=\"keyword\">if</span> (trimString.length() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                         subscriptionData.getTagsSet().add(trimString);</div><div class=\"line\"><span class=\"number\">17</span>:                         subscriptionData.getCodeSet().add(trimString.hashCode());</div><div class=\"line\"><span class=\"number\">18</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">19</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">20</span>:             &#125;</div><div class=\"line\"><span class=\"number\">21</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Exception(<span class=\"string\">\"subString split error\"</span>);</div><div class=\"line\"><span class=\"number\">23</span>:         &#125;</div><div class=\"line\"><span class=\"number\">24</span>:     &#125;</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">return</span> subscriptionData;</div><div class=\"line\"><span class=\"number\">27</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ ¹æ® <code>Topic</code> å’Œ è®¢é˜…è¡¨è¾¾å¼ åˆ›å»ºè®¢é˜…æ•°æ®</li>\n<li>subscriptionData.subVersion = System.currentTimeMillis()ã€‚</li>\n</ul>\n<h2>DefaultMQPushConsumer#registerMessageListener(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerMessageListener</span><span class=\"params\">(MessageListenerConcurrently messageListener)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">this</span>.messageListener = messageListener;</div><div class=\"line\"><span class=\"number\">3</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.registerMessageListener(messageListener);</div><div class=\"line\"><span class=\"number\">4</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ã€‚</li>\n</ul>\n<h1>5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</h1>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/10.png\" alt=\"RebalanceService&amp;amp;PushConsumeråˆ†é…é˜Ÿåˆ—\"></p>\n<h2>RebalanceService</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RebalanceService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * ç­‰å¾…é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’</div><div class=\"line\"> 5:      */</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> waitInterval =</div><div class=\"line\"> <span class=\"number\">7</span>:         Long.parseLong(System.getProperty(</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"string\">\"rocketmq.client.rebalance.waitInterval\"</span>, <span class=\"string\">\"20000\"</span>));</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log = ClientLogger.getLog();</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">12:      * MQClientå¯¹è±¡</div><div class=\"line\">13:      */</div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MQClientInstance mqClientFactory;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RebalanceService</span><span class=\"params\">(MQClientInstance mqClientFactory)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">this</span>.mqClientFactory = mqClientFactory;</div><div class=\"line\"><span class=\"number\">18</span>:     &#125;</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">22</span>:         log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"keyword\">this</span>.waitForRunning(waitInterval);</div><div class=\"line\"><span class=\"number\">26</span>:             <span class=\"keyword\">this</span>.mqClientFactory.doRebalance();</div><div class=\"line\"><span class=\"number\">27</span>:         &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:         log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">30</span>:     &#125;</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">34</span>:         <span class=\"keyword\">return</span> RebalanceService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">35</span>:     &#125;</div><div class=\"line\"><span class=\"number\">36</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚</li>\n<li>ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>MQClientInstance#doRebalance(...)</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç›®å‰æœ‰ä¸‰ç§æƒ…å†µæƒ…å†µä¸‹è§¦å‘ï¼š\n<ul>\n<li>å¦‚ <code>ç¬¬ 25 è¡Œ</code> ç­‰å¾…è¶…æ—¶ï¼Œæ¯ 20s è°ƒç”¨ä¸€æ¬¡ã€‚</li>\n<li><code>PushConsumer</code> å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li>\n<li><code>Broker</code> é€šçŸ¥ <code>Consumer</code> åŠ å…¥ æˆ– ç§»é™¤æ—¶ï¼Œ<code>Consumer</code> å“åº”é€šçŸ¥ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li>\n</ul>\n</li>\n</ul>\n<p>è¯¦ç»†è§£æè§ï¼š<a href=\"#mqclientinstancedorebalance\">MQClientInstance#doRebalance(...)</a>ã€‚</p>\n<h2>MQClientInstance#doRebalance(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doRebalance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">for</span> (Map.Entry&lt;String, MQConsumerInner&gt; entry : <span class=\"keyword\">this</span>.consumerTable.entrySet()) &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:         MQConsumerInner impl = entry.getValue();</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">if</span> (impl != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:                 impl.doRebalance();</div><div class=\"line\"> <span class=\"number\">7</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:                 log.error(<span class=\"string\">\"doRebalance exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">9</span>:             &#125;</div><div class=\"line\"><span class=\"number\">10</span>:         &#125;</div><div class=\"line\"><span class=\"number\">11</span>:     &#125;</div><div class=\"line\"><span class=\"number\">12</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šéå†å½“å‰ <code>Client</code> åŒ…å«çš„ <code>consumerTable</code>( <code>Consumer</code>é›†åˆ )ï¼Œæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li>\n<li><strong>ç–‘é—®</strong>ï¼šç›®å‰ä»£ç è°ƒè¯•ä¸‹æ¥ï¼Œ<code>consumerTable</code> åªåŒ…å« <code>Consumer</code> è‡ªå·±ã€‚ğŸ˜ˆæœ‰å¤§å¤§å¯¹è¿™ä¸ªç–‘é—®æœ‰è§£ç­”çš„ï¼Œçƒ¦è¯·è§£ç­”ä¸‹ã€‚</li>\n<li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>MQConsumerInner#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚<code>DefaultMQPushConsumerImpl</code>ã€<code>DefaultMQPullConsumerImpl</code> åˆ†åˆ«å¯¹è¯¥æ¥å£æ–¹æ³•è¿›è¡Œäº†å®ç°ã€‚<code>DefaultMQPushConsumerImpl#doRebalance(...)</code> è¯¦ç»†è§£æè§ï¼š<a href=\"defaultmqpushconsumerimpldorebalance\">DefaultMQPushConsumerImpl#doRebalance(...)</a>ã€‚</li>\n</ul>\n<h2>DefaultMQPushConsumerImpl#doRebalance(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doRebalance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.pause) &#123;</div><div class=\"line\"><span class=\"number\">3</span>:         <span class=\"keyword\">this</span>.rebalanceImpl.doRebalance(<span class=\"keyword\">this</span>.isConsumeOrderly());</div><div class=\"line\"><span class=\"number\">4</span>:     &#125;</div><div class=\"line\"><span class=\"number\">5</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li>\n<li>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>RebalanceImpl#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#rebalancepushimpldorebalance\">RebalancePushImpl#doRebalance(...)</a>ã€‚</li>\n</ul>\n<h2>RebalanceImpl#doRebalance(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> isOrder æ˜¯å¦é¡ºåºæ¶ˆæ¯</div><div class=\"line\"> 5:  */</div><div class=\"line\"> <span class=\"number\">6</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doRebalance</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrder)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">// åˆ†é…æ¯ä¸ª topic çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">8</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class=\"keyword\">this</span>.getSubscriptionInner();</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (subTable != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">final</span> Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:             <span class=\"keyword\">final</span> String topic = entry.getKey();</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">this</span>.rebalanceByTopic(topic, isOrder);</div><div class=\"line\"><span class=\"number\">14</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"keyword\">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                     log.warn(<span class=\"string\">\"rebalanceByTopic Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">17</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">18</span>:             &#125;</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125;</div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"comment\">// ç§»é™¤æœªè®¢é˜…çš„topicå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">this</span>.truncateMessageQueueNotMyTopic();</div><div class=\"line\"><span class=\"number\">23</span>: &#125;</div><div class=\"line\"><span class=\"number\">24</span>: </div><div class=\"line\"><span class=\"number\">25</span>: <span class=\"comment\">/**</span></div><div class=\"line\">26:  * ç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">27:  */</div><div class=\"line\"><span class=\"number\">28</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">truncateMessageQueueNotMyTopic</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">29</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class=\"keyword\">this</span>.getSubscriptionInner();</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">for</span> (MessageQueue mq : <span class=\"keyword\">this</span>.processQueueTable.keySet()) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"keyword\">if</span> (!subTable.containsKey(mq.getTopic())) &#123;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>:             ProcessQueue pq = <span class=\"keyword\">this</span>.processQueueTable.remove(mq);</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">if</span> (pq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:                 pq.setDropped(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">36</span>:                 log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, truncateMessageQueueNotMyTopic remove unnecessary mq, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">37</span>:             &#125;</div><div class=\"line\"><span class=\"number\">38</span>:         &#125;</div><div class=\"line\"><span class=\"number\">39</span>:     &#125;</div><div class=\"line\"><span class=\"number\">40</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>#doRebalance(...)</code> è¯´æ˜ ï¼šæ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 7 è‡³ 20 è¡Œ ï¼šå¾ªç¯è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œåˆ†é…æ¯ä¸€ä¸ª <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 22 è¡Œ ï¼šç§»é™¤æœªè®¢é˜…çš„ <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n</li>\n<li><code>#truncateMessageQueueNotMyTopic(...)</code> è¯´æ˜ ï¼šç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚<strong>å½“è°ƒç”¨ <code>DefaultMQPushConsumer#unsubscribe(topic)</code> æ—¶ï¼Œåªç§»é™¤è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œå¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—ç§»é™¤åœ¨è¯¥æ–¹æ³•ã€‚</strong></li>\n</ul>\n<h3>RebalanceImpl#rebalanceByTopic(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">rebalanceByTopic</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrder)</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">switch</span> (messageModel) &#123;</div><div class=\"line\">  <span class=\"number\">3</span>:         <span class=\"keyword\">case</span> BROADCASTING: &#123;</div><div class=\"line\">  <span class=\"number\">4</span>:             Set&lt;MessageQueue&gt; mqSet = <span class=\"keyword\">this</span>.topicSubscribeInfoTable.get(topic);</div><div class=\"line\">  <span class=\"number\">5</span>:             <span class=\"keyword\">if</span> (mqSet != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">  <span class=\"number\">6</span>:                 <span class=\"keyword\">boolean</span> changed = <span class=\"keyword\">this</span>.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);</div><div class=\"line\">  <span class=\"number\">7</span>:                 <span class=\"keyword\">if</span> (changed) &#123;</div><div class=\"line\">  <span class=\"number\">8</span>:                     <span class=\"keyword\">this</span>.messageQueueChanged(topic, mqSet, mqSet);</div><div class=\"line\">  <span class=\"number\">9</span>:                     log.info(<span class=\"string\">\"messageQueueChanged &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">10</span>:                         consumerGroup, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">11</span>:                         topic, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">12</span>:                         mqSet, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">13</span>:                         mqSet);</div><div class=\"line\"> <span class=\"number\">14</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">15</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist.\"</span>, consumerGroup, topic);</div><div class=\"line\"> <span class=\"number\">17</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">18</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">19</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"keyword\">case</span> CLUSTERING: &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"comment\">// è·å– topic å¯¹åº”çš„ é˜Ÿåˆ— å’Œ consumerä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">22</span>:             Set&lt;MessageQueue&gt; mqSet = <span class=\"keyword\">this</span>.topicSubscribeInfoTable.get(topic);</div><div class=\"line\"> <span class=\"number\">23</span>:             List&lt;String&gt; cidAll = <span class=\"keyword\">this</span>.mQClientFactory.findConsumerIdList(topic, consumerGroup);</div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mqSet) &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:                 <span class=\"keyword\">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:                     log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist.\"</span>, consumerGroup, topic);</div><div class=\"line\"> <span class=\"number\">27</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">28</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == cidAll) &#123;</div><div class=\"line\"> <span class=\"number\">31</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125; &#123;&#125;, get consumer id list failed\"</span>, consumerGroup, topic);</div><div class=\"line\"> <span class=\"number\">32</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:             <span class=\"keyword\">if</span> (mqSet != <span class=\"keyword\">null</span> &amp;&amp; cidAll != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"comment\">// æ’åº æ¶ˆæ¯é˜Ÿåˆ— å’Œ æ¶ˆè´¹è€…æ•°ç»„ã€‚å› ä¸ºæ˜¯åœ¨Clientè¿›è¡Œåˆ†é…é˜Ÿåˆ—ï¼Œæ’åºåï¼Œå„Clientçš„é¡ºåºæ‰èƒ½ä¿æŒä¸€è‡´ã€‚</span></div><div class=\"line\"> <span class=\"number\">36</span>:                 List&lt;MessageQueue&gt; mqAll = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">37</span>:                 mqAll.addAll(mqSet);</div><div class=\"line\"> <span class=\"number\">38</span>: </div><div class=\"line\"> <span class=\"number\">39</span>:                 Collections.sort(mqAll);</div><div class=\"line\"> <span class=\"number\">40</span>:                 Collections.sort(cidAll);</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:                 AllocateMessageQueueStrategy strategy = <span class=\"keyword\">this</span>.allocateMessageQueueStrategy;</div><div class=\"line\"> <span class=\"number\">43</span>: </div><div class=\"line\"> <span class=\"number\">44</span>:                 <span class=\"comment\">// æ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥ åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">45</span>:                 List&lt;MessageQueue&gt; allocateResult;</div><div class=\"line\"> <span class=\"number\">46</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">47</span>:                     allocateResult = strategy.allocate(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">48</span>:                         <span class=\"keyword\">this</span>.consumerGroup, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">49</span>:                         <span class=\"keyword\">this</span>.mQClientFactory.getClientId(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">50</span>:                         mqAll, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">51</span>:                         cidAll);</div><div class=\"line\"> <span class=\"number\">52</span>:                 &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">53</span>:                     log.error(<span class=\"string\">\"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName=&#123;&#125;\"</span>, strategy.getName(),</div><div class=\"line\"> <span class=\"number\">54</span>:                         e);</div><div class=\"line\"> <span class=\"number\">55</span>:                     <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">56</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:                 Set&lt;MessageQueue&gt; allocateResultSet = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">59</span>:                 <span class=\"keyword\">if</span> (allocateResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:                     allocateResultSet.addAll(allocateResult);</div><div class=\"line\"> <span class=\"number\">61</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">62</span>: </div><div class=\"line\"> <span class=\"number\">63</span>:                 <span class=\"comment\">// æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">64</span>:                 <span class=\"keyword\">boolean</span> changed = <span class=\"keyword\">this</span>.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);</div><div class=\"line\"> <span class=\"number\">65</span>:                 <span class=\"keyword\">if</span> (changed) &#123;</div><div class=\"line\"> <span class=\"number\">66</span>:                     log.info(</div><div class=\"line\"> <span class=\"number\">67</span>:                         <span class=\"string\">\"rebalanced result changed. allocateMessageQueueStrategyName=&#123;&#125;, group=&#123;&#125;, topic=&#123;&#125;, clientId=&#123;&#125;, mqAllSize=&#123;&#125;, cidAllSize=&#123;&#125;, rebalanceResultSize=&#123;&#125;, rebalanceResultSet=&#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">68</span>:                         strategy.getName(), consumerGroup, topic, <span class=\"keyword\">this</span>.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),</div><div class=\"line\"> <span class=\"number\">69</span>:                         allocateResultSet.size(), allocateResultSet);</div><div class=\"line\"> <span class=\"number\">70</span>:                     <span class=\"keyword\">this</span>.messageQueueChanged(topic, mqSet, allocateResultSet);</div><div class=\"line\"> <span class=\"number\">71</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">72</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">73</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">74</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">76</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">77</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">78</span>: &#125;</div><div class=\"line\"> <span class=\"number\">79</span>: </div><div class=\"line\"> <span class=\"number\">80</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 81:  * å½“è´Ÿè½½å‡è¡¡æ—¶ï¼Œæ›´æ–° æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\"> 82:  * - ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 83:  * - å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 84:  *</div><div class=\"line\"> 85:  * <span class=\"doctag\">@param</span> topic Topic</div><div class=\"line\"> 86:  * <span class=\"doctag\">@param</span> mqSet è´Ÿè½½å‡è¡¡ç»“æœåçš„æ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„</div><div class=\"line\"> 87:  * <span class=\"doctag\">@param</span> isOrder æ˜¯å¦é¡ºåº</div><div class=\"line\"> 88:  * <span class=\"doctag\">@return</span> æ˜¯å¦å˜æ›´</div><div class=\"line\"> 89:  */</div><div class=\"line\"> <span class=\"number\">90</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">updateProcessQueueTableInRebalance</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> Set&lt;MessageQueue&gt; mqSet, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrder)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">91</span>:     <span class=\"keyword\">boolean</span> changed = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:     <span class=\"comment\">// ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">94</span>:     Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = <span class=\"keyword\">this</span>.processQueueTable.entrySet().iterator();</div><div class=\"line\"> <span class=\"number\">95</span>:     <span class=\"keyword\">while</span> (it.hasNext()) &#123; <span class=\"comment\">// TODO å¾…è¯»ï¼š</span></div><div class=\"line\"> <span class=\"number\">96</span>:         Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class=\"line\"> <span class=\"number\">97</span>:         MessageQueue mq = next.getKey();</div><div class=\"line\"> <span class=\"number\">98</span>:         ProcessQueue pq = next.getValue();</div><div class=\"line\"> <span class=\"number\">99</span>: </div><div class=\"line\"><span class=\"number\">100</span>:         <span class=\"keyword\">if</span> (mq.getTopic().equals(topic)) &#123;</div><div class=\"line\"><span class=\"number\">101</span>:             <span class=\"keyword\">if</span> (!mqSet.contains(mq)) &#123; <span class=\"comment\">// ä¸åŒ…å«çš„é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">102</span>:                 pq.setDropped(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">103</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class=\"line\"><span class=\"number\">104</span>:                     it.remove();</div><div class=\"line\"><span class=\"number\">105</span>:                     changed = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">106</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">107</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">108</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pq.isPullExpired()) &#123; <span class=\"comment\">// é˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†</span></div><div class=\"line\"><span class=\"number\">109</span>:                 <span class=\"keyword\">switch</span> (<span class=\"keyword\">this</span>.consumeType()) &#123;</div><div class=\"line\"><span class=\"number\">110</span>:                     <span class=\"keyword\">case</span> CONSUME_ACTIVELY:</div><div class=\"line\"><span class=\"number\">111</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">112</span>:                     <span class=\"keyword\">case</span> CONSUME_PASSIVELY:</div><div class=\"line\"><span class=\"number\">113</span>:                         pq.setDropped(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">114</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class=\"line\"><span class=\"number\">115</span>:                             it.remove();</div><div class=\"line\"><span class=\"number\">116</span>:                             changed = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">117</span>:                             log.error(<span class=\"string\">\"[BUG]doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;, because pull is pause, so try to fixed it\"</span>,</div><div class=\"line\"><span class=\"number\">118</span>:                                 consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">119</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">120</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">121</span>:                     <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">122</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">123</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">124</span>:             &#125;</div><div class=\"line\"><span class=\"number\">125</span>:         &#125;</div><div class=\"line\"><span class=\"number\">126</span>:     &#125;</div><div class=\"line\"><span class=\"number\">127</span>: </div><div class=\"line\"><span class=\"number\">128</span>:     <span class=\"comment\">// å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class=\"line\"><span class=\"number\">129</span>:     List&lt;PullRequest&gt; pullRequestList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(); <span class=\"comment\">// æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„</span></div><div class=\"line\"><span class=\"number\">130</span>:     <span class=\"keyword\">for</span> (MessageQueue mq : mqSet) &#123;</div><div class=\"line\"><span class=\"number\">131</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class=\"line\"><span class=\"number\">132</span>:             <span class=\"keyword\">if</span> (isOrder &amp;&amp; !<span class=\"keyword\">this</span>.lock(mq)) &#123;</div><div class=\"line\"><span class=\"number\">133</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">134</span>:                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">135</span>:             &#125;</div><div class=\"line\"><span class=\"number\">136</span>: </div><div class=\"line\"><span class=\"number\">137</span>:             <span class=\"keyword\">this</span>.removeDirtyOffset(mq);</div><div class=\"line\"><span class=\"number\">138</span>:             ProcessQueue pq = <span class=\"keyword\">new</span> ProcessQueue();</div><div class=\"line\"><span class=\"number\">139</span>:             <span class=\"keyword\">long</span> nextOffset = <span class=\"keyword\">this</span>.computePullFromWhere(mq);</div><div class=\"line\"><span class=\"number\">140</span>:             <span class=\"keyword\">if</span> (nextOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">141</span>:                 ProcessQueue pre = <span class=\"keyword\">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class=\"line\"><span class=\"number\">142</span>:                 <span class=\"keyword\">if</span> (pre != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">143</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">144</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">145</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">146</span>:                     PullRequest pullRequest = <span class=\"keyword\">new</span> PullRequest();</div><div class=\"line\"><span class=\"number\">147</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class=\"line\"><span class=\"number\">148</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class=\"line\"><span class=\"number\">149</span>:                     pullRequest.setMessageQueue(mq);</div><div class=\"line\"><span class=\"number\">150</span>:                     pullRequest.setProcessQueue(pq);</div><div class=\"line\"><span class=\"number\">151</span>:                     pullRequestList.add(pullRequest);</div><div class=\"line\"><span class=\"number\">152</span>:                     changed = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">153</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">154</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">155</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">156</span>:             &#125;</div><div class=\"line\"><span class=\"number\">157</span>:         &#125;</div><div class=\"line\"><span class=\"number\">158</span>:     &#125;</div><div class=\"line\"><span class=\"number\">159</span>: </div><div class=\"line\"><span class=\"number\">160</span>:     <span class=\"comment\">// å‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">161</span>:     <span class=\"keyword\">this</span>.dispatchPullRequest(pullRequestList);</div><div class=\"line\"><span class=\"number\">162</span>: </div><div class=\"line\"><span class=\"number\">163</span>:     <span class=\"keyword\">return</span> changed;</div><div class=\"line\"><span class=\"number\">164</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>#rebalanceByTopic(...)</code> è¯´æ˜ ï¼šåˆ†é… <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 3 è‡³ 19 è¡Œ ï¼šå¹¿æ’­æ¨¡å¼( <code>BROADCASTING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>æ‰€æœ‰</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 20 è‡³ 74 è¡Œ ï¼šé›†ç¾¤æ¨¡å¼( <code>CLUSTERING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>éƒ¨åˆ†</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 21 è‡³ 40 è¡Œ ï¼šè·å– <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ä»¬ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ’åºã€‚å› ä¸ºå„ <code>Consumer</code> æ˜¯åœ¨æœ¬åœ°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ’åºåæ‰èƒ½ä¿è¯å„ <code>Consumer</code> é¡ºåºä¸€è‡´ã€‚</li>\n<li>ç¬¬ 42 è‡³ 61 è¡Œ ï¼šæ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥( <code>AllocateMessageQueueStrategy</code> ) åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#allocatemessagequeuestrategy\">AllocateMessageQueueStrategy</a>ã€‚</li>\n<li>ç¬¬ 63 è‡³ 72 è¡Œ ï¼šæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>#updateProcessQueueTableInRebalance(...)</code> è¯´æ˜ ï¼šå½“åˆ†é…é˜Ÿåˆ—æ—¶ï¼Œæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è¿”å›æ˜¯å¦æœ‰å˜æ›´ã€‚\n<ul>\n<li>ç¬¬ 93 è‡³ 126 è¡Œ ï¼šç§»é™¤ä¸å­˜åœ¨äºåˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) çš„ æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—( <code>processQueueTable</code> )ã€‚\n<ul>\n<li>ç¬¬ 103 è¡Œ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#rebalancepushimplremoveunnecessarymessagequeue\">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</a>ã€‚</li>\n<li>ç¬¬ 108 è‡³ 120 è¡Œ ï¼šé˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œå³ <code>å½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶é—´ &gt; 120s</code> ( 120s å¯é…ç½®)ï¼Œåˆ¤å®šå‘ç”Ÿ <strong>BUG</strong>ï¼Œè¿‡ä¹…æœªè¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç§»é™¤åï¼Œä¸‹é¢**#æ–°å¢é˜Ÿåˆ—é€»è¾‘#**å¯ä»¥é‡æ–°åŠ å…¥æ–°çš„è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 128 è‡³ 158 è¡Œ ï¼šå¢åŠ  åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 132 è‡³ 135 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>\n<li>ç¬¬ 137 è¡Œ ï¼šç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ã€‚</li>\n<li>ç¬¬ 139 è¡Œ ï¼šè·å–é˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#rebalancepushimplcomputepullfromwhere\">RebalancePushImpl#computePullFromWhere(...)</a>ã€‚</li>\n<li>ç¬¬ 140 è‡³ 156 è¡Œ ï¼š<strong>æ·»åŠ æ–°æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ï¼Œæ·»åŠ æ¶ˆè´¹æ‹‰å–æ¶ˆæ¯è¯·æ±‚</strong>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 161 è¡Œ ï¼š<strong>å‘èµ·æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯æ‹‰å–è¯·æ±‚</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#rebalancepushimpldispatchpullrequest\">RebalancePushImpl#dispatchPullRequest(...)</a>ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3>RebalanceImpl#removeUnnecessaryMessageQueue(...)</h3>\n<h4>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">removeUnnecessaryMessageQueue</span><span class=\"params\">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">// åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</span></div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"comment\">// TODO é¡ºåºæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class=\"line\"> <span class=\"number\">7</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">if</span> (pq.getLockConsume().tryLock(<span class=\"number\">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.unlockDelay(mq, pq);</div><div class=\"line\"><span class=\"number\">12</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                     pq.getLockConsume().unlock();</div><div class=\"line\"><span class=\"number\">14</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">15</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                 log.warn(<span class=\"string\">\"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">17</span>:                     mq, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">18</span>:                     pq.getTryUnlockTimes());</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:                 pq.incTryUnlockTimes();</div><div class=\"line\"><span class=\"number\">21</span>:             &#125;</div><div class=\"line\"><span class=\"number\">22</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:             log.error(<span class=\"string\">\"removeUnnecessaryMessageQueue Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">24</span>:         &#125;</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">27</span>:     &#125;</div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">29</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›æ˜¯å¦ç§»é™¤æˆåŠŸã€‚</li>\n<li>ç¬¬ 2 è‡³ 4 è¡Œ ï¼š<strong>åŒæ­¥</strong>é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</li>\n<li>ç¬¬ 5 è‡³ 27 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>\n</ul>\n<h4><code>[PullConsumer]</code> RebalancePullImpl#removeUnnecessaryMessageQueue(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">removeUnnecessaryMessageQueue</span><span class=\"params\">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">this</span>.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);</div><div class=\"line\"><span class=\"number\">3</span>:     <span class=\"keyword\">this</span>.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class=\"line\"><span class=\"number\">4</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">5</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›ç§»é™¤æˆåŠŸã€‚<strong>å’Œ<code>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</code>åŸºæœ¬ä¸€è‡´ã€‚</strong></li>\n</ul>\n<h3>RebalancePushImpl#dispatchPullRequest(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">dispatchPullRequest</span><span class=\"params\">(List&lt;PullRequest&gt; pullRequestList)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">for</span> (PullRequest pullRequest : pullRequestList) &#123;</div><div class=\"line\"><span class=\"number\">3</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">4</span>:         log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new pull request &#123;&#125;\"</span>, consumerGroup, pullRequest);</div><div class=\"line\"><span class=\"number\">5</span>:     &#125;</div><div class=\"line\"><span class=\"number\">6</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚<strong>è¯¥è°ƒç”¨æ˜¯<code>PushConsumer</code>ä¸æ–­ä¸æ–­ä¸æ–­æ‹‰å–æ¶ˆæ¯çš„èµ·ç‚¹</strong>ã€‚</li>\n</ul>\n<h4>DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executePullRequestImmediately</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">this</span>.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">3</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæäº¤æ‹‰å–è¯·æ±‚ã€‚æäº¤åï¼Œ<code>PullMessageService</code> <strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼Œ<strong>éé˜»å¡</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"pullmessageservice\">PullMessageService</a>ã€‚</li>\n</ul>\n<h3>AllocateMessageQueueStrategy</h3>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/01.png\" alt=\"AllocateMessageQueueStrategyç±»å›¾\"></p>\n<h4>AllocateMessageQueueAveragely</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllocateMessageQueueAveragely</span> <span class=\"keyword\">implements</span> <span class=\"title\">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log = ClientLogger.getLog();</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">allocate</span><span class=\"params\">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class=\"line\"> <span class=\"number\">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®</span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">if</span> (currentCID == <span class=\"keyword\">null</span> || currentCID.length() &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"currentCID is empty\"</span>);</div><div class=\"line\"><span class=\"number\">10</span>:         &#125;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">if</span> (mqAll == <span class=\"keyword\">null</span> || mqAll.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"mqAll is null or mqAll empty\"</span>);</div><div class=\"line\"><span class=\"number\">13</span>:         &#125;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">if</span> (cidAll == <span class=\"keyword\">null</span> || cidAll.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"cidAll is null or cidAll empty\"</span>);</div><div class=\"line\"><span class=\"number\">16</span>:         &#125;</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:         List&lt;MessageQueue&gt; result = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             log.info(<span class=\"string\">\"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">21</span>:                 consumerGroup,</div><div class=\"line\"><span class=\"number\">22</span>:                 currentCID,</div><div class=\"line\"><span class=\"number\">23</span>:                 cidAll);</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"comment\">// å¹³å‡åˆ†é…</span></div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"keyword\">int</span> index = cidAll.indexOf(currentCID); <span class=\"comment\">// ç¬¬å‡ ä¸ªconsumerã€‚</span></div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">int</span> mod = mqAll.size() % cidAll.size(); <span class=\"comment\">// ä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</span></div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">int</span> averageSize =</div><div class=\"line\"><span class=\"number\">30</span>:             mqAll.size() &lt;= cidAll.size() ? <span class=\"number\">1</span> : (mod &gt; <span class=\"number\">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()</div><div class=\"line\"><span class=\"number\">31</span>:                 + <span class=\"number\">1</span> : mqAll.size() / cidAll.size());</div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"keyword\">int</span> startIndex = (mod &gt; <span class=\"number\">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod; <span class=\"comment\">// æœ‰ä½™æ•°çš„æƒ…å†µä¸‹ï¼Œ[0, mod) å¹³åˆ†ä½™æ•°ï¼Œå³æ¯consumerå¤šåˆ†é…ä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬indexå¼€å§‹ï¼Œè·³è¿‡å‰modä½™æ•°ã€‚</span></div><div class=\"line\"><span class=\"number\">33</span>:         <span class=\"keyword\">int</span> range = Math.min(averageSize, mqAll.size() - startIndex); <span class=\"comment\">// åˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦Math.min()çš„åŸå› æ˜¯ï¼ŒmqAll.size() &lt;= cidAll.size()ï¼Œéƒ¨åˆ†consumeråˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class=\"line\"><span class=\"number\">34</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; range; i++) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:             result.add(mqAll.get((startIndex + i) % mqAll.size()));</div><div class=\"line\"><span class=\"number\">36</span>:         &#125;</div><div class=\"line\"><span class=\"number\">37</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">38</span>:     &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">41</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">return</span> <span class=\"string\">\"AVG\"</span>;</div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…é˜Ÿåˆ—ç­–ç•¥ã€‚</li>\n<li>ç¬¬ 7 è‡³ 25 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li>\n<li>ç¬¬ 26 è‡³ 36 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 27 è¡Œ ï¼š<code>index</code> ï¼šå½“å‰ <code>Consumer</code> åœ¨æ¶ˆè´¹é›†ç¾¤é‡Œæ˜¯ç¬¬å‡ ä¸ªã€‚è¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å¯¹ä¼ å…¥çš„ <code>cidAll</code> å‚æ•°å¿…é¡»è¿›è¡Œæ’åºçš„åŸå› ã€‚å¦‚æœä¸æ’åºï¼Œ<code>Consumer</code> åœ¨æœ¬åœ°è®¡ç®—å‡ºæ¥çš„ <code>index</code> æ— æ³•ä¸€è‡´ï¼Œå½±å“è®¡ç®—ç»“æœã€‚</li>\n<li>ç¬¬ 28 è¡Œ ï¼š<code>mod</code> ï¼šä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</li>\n<li>ç¬¬ 29 è‡³ 31 è¡Œ ï¼š<code>averageSize</code> ï¼šä»£ç å¯ä»¥ç®€åŒ–æˆ <code>(mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())</code>ã€‚\n<ul>\n<li><code>[ 0, mod )</code> ï¼š<code>mqAll.size() / cidAll.size() + 1</code>ã€‚å‰é¢ <code>mod</code> ä¸ª <code>Consumer</code> å¹³åˆ†ä½™æ•°ï¼Œå¤šè·å¾— 1 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li><code>[ mod, cidAll.size() )</code> ï¼š<code>mqAll.size() / cidAll.size()</code>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 32 è¡Œ ï¼š<code>startIndex</code> ï¼š<code>Consumer</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹ä½ç½®ã€‚</li>\n<li>ç¬¬ 33 è¡Œ ï¼š<code>range</code> ï¼šåˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦ <code>Math#min(...)</code> çš„åŸå› ï¼šå½“ <code>mqAll.size() &lt;= cidAll.size()</code> æ—¶ï¼Œæœ€åå‡ ä¸ª <code>Consumer</code> åˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 34 è‡³ 36 è¡Œ ï¼šç”Ÿæˆåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç»“æœã€‚</li>\n</ul>\n</li>\n<li>ä¸¾ä¸ªä¾‹å­ï¼š</li>\n</ul>\n<p>å›ºå®šæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ä¸º<strong>4</strong>ã€‚</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Consumer * 2 <em>å¯ä»¥æ•´é™¤</em></th>\n<th>Consumer * 3 <em>ä¸å¯æ•´é™¤</em></th>\n<th>Consumer * 5 <em>æ— æ³•éƒ½åˆ†é…</em></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ¶ˆæ¯é˜Ÿåˆ—[0]</td>\n<td>Consumer[0]</td>\n<td>Consumer[0]</td>\n<td>Consumer[0]</td>\n</tr>\n<tr>\n<td>æ¶ˆæ¯é˜Ÿåˆ—[1]</td>\n<td>Consumer[0]</td>\n<td>Consumer[0]</td>\n<td>Consumer[1]</td>\n</tr>\n<tr>\n<td>æ¶ˆæ¯é˜Ÿåˆ—[2]</td>\n<td>Consumer[1]</td>\n<td>Consumer[1]</td>\n<td>Consumer[2]</td>\n</tr>\n<tr>\n<td>æ¶ˆæ¯é˜Ÿåˆ—[3]</td>\n<td>Consumer[1]</td>\n<td>Consumer[2]</td>\n<td>Consumer[3]</td>\n</tr>\n</tbody>\n</table>\n<h4>AllocateMessageQueueByMachineRoom</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllocateMessageQueueByMachineRoom</span> <span class=\"keyword\">implements</span> <span class=\"title\">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 3:      * æ¶ˆè´¹è€…æ¶ˆè´¹brokerNameé›†åˆ</div><div class=\"line\"> 4:      */</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> Set&lt;String&gt; consumeridcs;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">allocate</span><span class=\"params\">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class=\"line\"> <span class=\"number\">9</span>:         List&lt;String&gt; cidAll) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"comment\">// å‚æ•°æ ¡éªŒ</span></div><div class=\"line\"><span class=\"number\">11</span>:         List&lt;MessageQueue&gt; result = <span class=\"keyword\">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">int</span> currentIndex = cidAll.indexOf(currentCID);</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">if</span> (currentIndex &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">15</span>:         &#125;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"comment\">// è®¡ç®—ç¬¦åˆå½“å‰é…ç½®çš„æ¶ˆè´¹è€…æ•°ç»„('consumeridcs')å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">17</span>:         List&lt;MessageQueue&gt; premqAll = <span class=\"keyword\">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">for</span> (MessageQueue mq : mqAll) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             String[] temp = mq.getBrokerName().split(<span class=\"string\">\"@\"</span>);</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">if</span> (temp.length == <span class=\"number\">2</span> &amp;&amp; consumeridcs.contains(temp[<span class=\"number\">0</span>])) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                 premqAll.add(mq);</div><div class=\"line\"><span class=\"number\">22</span>:             &#125;</div><div class=\"line\"><span class=\"number\">23</span>:         &#125;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"comment\">// å¹³å‡åˆ†é…</span></div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">int</span> mod = premqAll.size() / cidAll.size();</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">int</span> rem = premqAll.size() % cidAll.size();</div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"keyword\">int</span> startIndex = mod * currentIndex;</div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">int</span> endIndex = startIndex + mod;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = startIndex; i &lt; endIndex; i++) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             result.add(mqAll.get(i));</div><div class=\"line\"><span class=\"number\">31</span>:         &#125;</div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"keyword\">if</span> (rem &gt; currentIndex) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));</div><div class=\"line\"><span class=\"number\">34</span>:         &#125;</div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">36</span>:     &#125;</div><div class=\"line\"><span class=\"number\">37</span>: </div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">return</span> <span class=\"string\">\"MACHINE_ROOM\"</span>;</div><div class=\"line\"><span class=\"number\">41</span>:     &#125;</div><div class=\"line\"><span class=\"number\">42</span>: </div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"function\"><span class=\"keyword\">public</span> Set&lt;String&gt; <span class=\"title\">getConsumeridcs</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"keyword\">return</span> consumeridcs;</div><div class=\"line\"><span class=\"number\">45</span>:     &#125;</div><div class=\"line\"><span class=\"number\">46</span>: </div><div class=\"line\"><span class=\"number\">47</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setConsumeridcs</span><span class=\"params\">(Set&lt;String&gt; consumeridcs)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">48</span>:         <span class=\"keyword\">this</span>.consumeridcs = consumeridcs;</div><div class=\"line\"><span class=\"number\">49</span>:     &#125;</div><div class=\"line\"><span class=\"number\">50</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li>\n<li>ç¬¬ 16 è‡³ 23 è¡Œ ï¼šè®¡ç®—<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 25 è‡³ 34 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¥<strong>å¹³å‡åˆ†é…</strong>æ–¹å¼å’Œ <code>AllocateMessageQueueAveragely</code> ç•¥æœ‰ä¸åŒï¼Œå…¶æ˜¯å°†å¤šä½™çš„ç»“å°¾éƒ¨åˆ†åˆ†é…ç»™å‰ <code>rem</code> ä¸ª <code>Consumer</code>ã€‚</li>\n<li>ç–‘é—®ï¼š<em>ä½¿ç”¨è¯¥åˆ†é…ç­–ç•¥æ—¶ï¼Œ<code>Consumer</code> å’Œ <code>Broker</code> åˆ†é…éœ€è¦æ€ä¹ˆé…ç½®</em>ã€‚ğŸ˜ˆç­‰ç ”ç©¶<strong>ä¸»ä»</strong>ç›¸å…³æºç æ—¶ï¼Œä»”ç»†è€ƒè™‘ä¸‹ã€‚</li>\n</ul>\n<h4>AllocateMessageQueueAveragelyByCircle</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllocateMessageQueueAveragelyByCircle</span> <span class=\"keyword\">implements</span> <span class=\"title\">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log = ClientLogger.getLog();</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">allocate</span><span class=\"params\">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class=\"line\"> <span class=\"number\">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®</span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">if</span> (currentCID == <span class=\"keyword\">null</span> || currentCID.length() &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"currentCID is empty\"</span>);</div><div class=\"line\"><span class=\"number\">10</span>:         &#125;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">if</span> (mqAll == <span class=\"keyword\">null</span> || mqAll.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"mqAll is null or mqAll empty\"</span>);</div><div class=\"line\"><span class=\"number\">13</span>:         &#125;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">if</span> (cidAll == <span class=\"keyword\">null</span> || cidAll.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"cidAll is null or cidAll empty\"</span>);</div><div class=\"line\"><span class=\"number\">16</span>:         &#125;</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:         List&lt;MessageQueue&gt; result = <span class=\"keyword\">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             log.info(<span class=\"string\">\"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">21</span>:                 consumerGroup,</div><div class=\"line\"><span class=\"number\">22</span>:                 currentCID,</div><div class=\"line\"><span class=\"number\">23</span>:                 cidAll);</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"comment\">// ç¯çŠ¶åˆ†é…</span></div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">int</span> index = cidAll.indexOf(currentCID);</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = index; i &lt; mqAll.size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             <span class=\"keyword\">if</span> (i % cidAll.size() == index) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                 result.add(mqAll.get(i));</div><div class=\"line\"><span class=\"number\">32</span>:             &#125;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">35</span>:     &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"keyword\">return</span> <span class=\"string\">\"AVG_BY_CIRCLE\"</span>;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šç¯çŠ¶åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n<h4>AllocateMessageQueueByConfig</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllocateMessageQueueByConfig</span> <span class=\"keyword\">implements</span> <span class=\"title\">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> List&lt;MessageQueue&gt; messageQueueList;</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">allocate</span><span class=\"params\">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class=\"line\"> <span class=\"number\">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.messageQueueList;</div><div class=\"line\"> <span class=\"number\">8</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">return</span> <span class=\"string\">\"CONFIG\"</span>;</div><div class=\"line\"><span class=\"number\">13</span>:     &#125;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">getMessageQueueList</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">return</span> messageQueueList;</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: </div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setMessageQueueList</span><span class=\"params\">(List&lt;MessageQueue&gt; messageQueueList)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"keyword\">this</span>.messageQueueList = messageQueueList;</div><div class=\"line\"><span class=\"number\">21</span>:     &#125;</div><div class=\"line\"><span class=\"number\">22</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šåˆ†é…<strong>é…ç½®çš„</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç–‘é—® ï¼š<em>è¯¥åˆ†é…ç­–ç•¥çš„ä½¿ç”¨åœºæ™¯ã€‚</em></li>\n</ul>\n<h1>5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</h1>\n<h2>RebalancePushImpl#computePullFromWhere(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">computePullFromWhere</span><span class=\"params\">(MessageQueue mq)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">long</span> result = -<span class=\"number\">1</span>;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> ConsumeFromWhere consumeFromWhere = <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> OffsetStore offsetStore = <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore();</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">switch</span> (consumeFromWhere) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: <span class=\"comment\">// åºŸå¼ƒ</span></div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_MIN_OFFSET: <span class=\"comment\">// åºŸå¼ƒ</span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_MAX_OFFSET: <span class=\"comment\">// åºŸå¼ƒ</span></div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_LAST_OFFSET: &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class=\"line\"><span class=\"number\">11</span>:             <span class=\"keyword\">if</span> (lastOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:                 result = lastOffset;</div><div class=\"line\"><span class=\"number\">13</span>:             &#125;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"comment\">// First start,no offset</span></div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == lastOffset) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                 <span class=\"keyword\">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                     result = <span class=\"number\">0L</span>;</div><div class=\"line\"><span class=\"number\">18</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">19</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                         result = <span class=\"keyword\">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class=\"line\"><span class=\"number\">21</span>:                     &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                         result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">23</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">24</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">25</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">29</span>:         &#125;</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_FIRST_OFFSET: &#123;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">if</span> (lastOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:                 result = lastOffset;</div><div class=\"line\"><span class=\"number\">34</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == lastOffset) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:                 result = <span class=\"number\">0L</span>;</div><div class=\"line\"><span class=\"number\">36</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">37</span>:                 result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">38</span>:             &#125;</div><div class=\"line\"><span class=\"number\">39</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">40</span>:         &#125;</div><div class=\"line\"><span class=\"number\">41</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_TIMESTAMP: &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             <span class=\"keyword\">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"keyword\">if</span> (lastOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">44</span>:                 result = lastOffset;</div><div class=\"line\"><span class=\"number\">45</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == lastOffset) &#123;</div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">48</span>:                         result = <span class=\"keyword\">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class=\"line\"><span class=\"number\">49</span>:                     &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"><span class=\"number\">50</span>:                         result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">51</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">52</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">53</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">54</span>:                         <span class=\"keyword\">long</span> timestamp = UtilAll.parseDate(<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),</div><div class=\"line\"><span class=\"number\">55</span>:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();</div><div class=\"line\"><span class=\"number\">56</span>:                         result = <span class=\"keyword\">this</span>.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);</div><div class=\"line\"><span class=\"number\">57</span>:                     &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"><span class=\"number\">58</span>:                         result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">59</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">60</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">61</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">62</span>:                 result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">63</span>:             &#125;</div><div class=\"line\"><span class=\"number\">64</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">65</span>:         &#125;</div><div class=\"line\"><span class=\"number\">66</span>: </div><div class=\"line\"><span class=\"number\">67</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">68</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">69</span>:     &#125;</div><div class=\"line\"><span class=\"number\">70</span>: </div><div class=\"line\"><span class=\"number\">71</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">72</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹æ¶ˆè´¹ä½ç½®ã€‚</li>\n<li><code>PushConsumer</code> è¯»å–æ¶ˆè´¹è¿›åº¦æœ‰ä¸‰ç§é€‰é¡¹ï¼š\n<ul>\n<li><code>CONSUME_FROM_LAST_OFFSET</code> ï¼šç¬¬ 6 è‡³ 29 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>é˜Ÿåˆ—çš„æœ€åä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>\n<li><code>CONSUME_FROM_FIRST_OFFSET</code> ï¼šç¬¬ 30 è‡³ 40 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»é˜Ÿåˆ—çš„<strong>æœ€å‰ä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>\n<li><code>CONSUME_FROM_TIMESTAMP</code> ï¼šç¬¬ 41 è‡³ 65 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>æŒ‡å®šæ—¶é—´ç‚¹</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>\n</ul>\n</li>\n</ul>\n<h2><code>[PullConsumer]</code> RebalancePullImpl#computePullFromWhere(...)</h2>\n<p>æš‚æ—¶è·³è¿‡ã€‚ğŸ˜ˆ</p>\n<h1>6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</h1>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/05.png\" alt=\"DefaultMQPushConsumerImplæ‹‰å–æ¶ˆæ¯\"></p>\n<h2>PullMessageService</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PullMessageService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log = ClientLogger.getLog();</div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  4:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—</div><div class=\"line\">  5:      */</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LinkedBlockingQueue&lt;PullRequest&gt; pullRequestQueue = <span class=\"keyword\">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  8:      * MQClientå¯¹è±¡</div><div class=\"line\">  9:      */</div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MQClientInstance mQClientFactory;</div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 12:      * å®šæ—¶å™¨ã€‚ç”¨äºå»¶è¿Ÿæäº¤æ‹‰å–è¯·æ±‚</div><div class=\"line\"> 13:      */</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ScheduledExecutorService scheduledExecutorService = Executors</div><div class=\"line\"> <span class=\"number\">15</span>:         .newSingleThreadScheduledExecutor(<span class=\"keyword\">new</span> ThreadFactory() &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:             <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">17</span>:             <span class=\"function\"><span class=\"keyword\">public</span> Thread <span class=\"title\">newThread</span><span class=\"params\">(Runnable r)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">18</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Thread(r, <span class=\"string\">\"PullMessageServiceScheduledThread\"</span>);</div><div class=\"line\"> <span class=\"number\">19</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">20</span>:         &#125;);</div><div class=\"line\"> <span class=\"number\">21</span>: </div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PullMessageService</span><span class=\"params\">(MQClientInstance mQClientFactory)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">23</span>:         <span class=\"keyword\">this</span>.mQClientFactory = mQClientFactory;</div><div class=\"line\"> <span class=\"number\">24</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">25</span>: </div><div class=\"line\"> <span class=\"number\">26</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 27:      * æ‰§è¡Œå»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 28:      *</div><div class=\"line\"> 29:      * <span class=\"doctag\">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 30:      * <span class=\"doctag\">@param</span> timeDelay å»¶è¿Ÿæ—¶é•¿</div><div class=\"line\"> 31:      */</div><div class=\"line\"> <span class=\"number\">32</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executePullRequestLater</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeDelay)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"keyword\">this</span>.scheduledExecutorService.schedule(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">34</span>: </div><div class=\"line\"> <span class=\"number\">35</span>:             <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">36</span>:             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">37</span>:                 PullMessageService.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"> <span class=\"number\">38</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">39</span>:         &#125;, timeDelay, TimeUnit.MILLISECONDS);</div><div class=\"line\"> <span class=\"number\">40</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 43:      * æ‰§è¡Œç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 44:      *</div><div class=\"line\"> 45:      * <span class=\"doctag\">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 46:      */</div><div class=\"line\"> <span class=\"number\">47</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executePullRequestImmediately</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">49</span>:             <span class=\"keyword\">this</span>.pullRequestQueue.put(pullRequest);</div><div class=\"line\"> <span class=\"number\">50</span>:         &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">51</span>:             log.error(<span class=\"string\">\"executePullRequestImmediately pullRequestQueue.put\"</span>, e);</div><div class=\"line\"> <span class=\"number\">52</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">53</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">54</span>: </div><div class=\"line\"> <span class=\"number\">55</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 56:      * æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡</div><div class=\"line\"> 57:      *</div><div class=\"line\"> 58:      * <span class=\"doctag\">@param</span> r ä»»åŠ¡</div><div class=\"line\"> 59:      * <span class=\"doctag\">@param</span> timeDelay å»¶è¿Ÿæ—¶é•¿</div><div class=\"line\"> 60:      */</div><div class=\"line\"> <span class=\"number\">61</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executeTaskLater</span><span class=\"params\">(<span class=\"keyword\">final</span> Runnable r, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeDelay)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">62</span>:         <span class=\"keyword\">this</span>.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);</div><div class=\"line\"> <span class=\"number\">63</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">64</span>: </div><div class=\"line\"> <span class=\"number\">65</span>:     <span class=\"function\"><span class=\"keyword\">public</span> ScheduledExecutorService <span class=\"title\">getScheduledExecutorService</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">66</span>:         <span class=\"keyword\">return</span> scheduledExecutorService;</div><div class=\"line\"> <span class=\"number\">67</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">68</span>: </div><div class=\"line\"> <span class=\"number\">69</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 70:      * æ‹‰å–æ¶ˆæ¯</div><div class=\"line\"> 71:      *</div><div class=\"line\"> 72:      * <span class=\"doctag\">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 73:      */</div><div class=\"line\"> <span class=\"number\">74</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">pullMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"keyword\">final</span> MQConsumerInner consumer = <span class=\"keyword\">this</span>.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">76</span>:         <span class=\"keyword\">if</span> (consumer != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">77</span>:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;</div><div class=\"line\"> <span class=\"number\">78</span>:             impl.pullMessage(pullRequest);</div><div class=\"line\"> <span class=\"number\">79</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">80</span>:             log.warn(<span class=\"string\">\"No matched consumer for the PullRequest &#123;&#125;, drop it\"</span>, pullRequest);</div><div class=\"line\"> <span class=\"number\">81</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">82</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">83</span>: </div><div class=\"line\"> <span class=\"number\">84</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">85</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">86</span>:         log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"> <span class=\"number\">87</span>: </div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"> <span class=\"number\">89</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">90</span>:                 PullRequest pullRequest = <span class=\"keyword\">this</span>.pullRequestQueue.take();</div><div class=\"line\"> <span class=\"number\">91</span>:                 <span class=\"keyword\">if</span> (pullRequest != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">92</span>:                     <span class=\"keyword\">this</span>.pullMessage(pullRequest);</div><div class=\"line\"> <span class=\"number\">93</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">94</span>:             &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">95</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:                 log.error(<span class=\"string\">\"Pull Message Service Run Method exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">97</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">98</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">99</span>: </div><div class=\"line\"><span class=\"number\">100</span>:         log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">101</span>:     &#125;</div><div class=\"line\"><span class=\"number\">102</span>: </div><div class=\"line\"><span class=\"number\">103</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">104</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">105</span>:         <span class=\"keyword\">return</span> PullMessageService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">106</span>:     &#125;</div><div class=\"line\"><span class=\"number\">107</span>: </div><div class=\"line\"><span class=\"number\">108</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œä¸æ–­ä¸æ–­ä¸æ–­ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li>\n<li><code>#executePullRequestLater(...)</code> ï¼šç¬¬ 26 è‡³ 40 è¡Œ ï¼š æäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li><code>#executePullRequestImmediately(...)</code> ï¼šç¬¬ 42 è‡³ 53 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li><code>#executeTaskLater(...)</code> ï¼šç¬¬ 55 è‡³ 63 è¡Œ ï¼šæäº¤<strong>å»¶è¿Ÿä»»åŠ¡</strong>ã€‚</li>\n<li><code>#pullMessage(...)</code> ï¼šç¬¬ 69 è‡³ 82 è¡Œ ï¼šæ‰§è¡Œæ‹‰å–æ¶ˆæ¯é€»è¾‘ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#defaultmqpushconsumerimplpullmessage\">DefaultMQPushConsumerImpl#pullMessage(...)</a>ã€‚</li>\n<li><code>#run(...)</code> ï¼šç¬¬ 84 è‡³ 101 è¡Œ ï¼šå¾ªç¯æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—( <code>pullRequestQueue</code> )ï¼Œè¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li>\n</ul>\n<h2>DefaultMQPushConsumerImpl#pullMessage(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">pullMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">final</span> ProcessQueue processQueue = pullRequest.getProcessQueue();</div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (processQueue.isDropped()) &#123;</div><div class=\"line\">  <span class=\"number\">4</span>:         log.info(<span class=\"string\">\"the pull request[&#123;&#125;] is dropped.\"</span>, pullRequest.toString());</div><div class=\"line\">  <span class=\"number\">5</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\">  <span class=\"number\">6</span>:     &#125;</div><div class=\"line\">  <span class=\"number\">7</span>: </div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"comment\">// è®¾ç½®é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´</span></div><div class=\"line\">  <span class=\"number\">9</span>:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());</div><div class=\"line\"> <span class=\"number\">10</span>: </div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"comment\">// åˆ¤æ–­consumerçŠ¶æ€æ˜¯å¦è¿è¡Œä¸­ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">13</span>:         <span class=\"keyword\">this</span>.makeSureStateOK();</div><div class=\"line\"> <span class=\"number\">14</span>:     &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"> <span class=\"number\">15</span>:         log.warn(<span class=\"string\">\"pullMessage exception, consumer state not ok\"</span>, e);</div><div class=\"line\"> <span class=\"number\">16</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">19</span>: </div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"comment\">// åˆ¤æ–­æ˜¯å¦æš‚åœä¸­ã€‚</span></div><div class=\"line\"> <span class=\"number\">21</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isPause()) &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:         log.warn(<span class=\"string\">\"consumer was paused, execute pull request later. instanceName=&#123;&#125;, group=&#123;&#125;\"</span>, <span class=\"keyword\">this</span>.defaultMQPushConsumer.getInstanceName(), <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">23</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);</div><div class=\"line\"> <span class=\"number\">24</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">25</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:     <span class=\"comment\">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æŒæœ‰æ¶ˆæ¯æ•°é‡ã€‚é»˜è®¤æœ€å¤§å€¼ä¸º1000ã€‚</span></div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"keyword\">long</span> size = processQueue.getMsgCount().get();</div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">if</span> (size &gt; <span class=\"keyword\">this</span>.defaultMQPushConsumer.getPullThresholdForQueue()) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class=\"comment\">// æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚</span></div><div class=\"line\"> <span class=\"number\">31</span>:         <span class=\"keyword\">if</span> ((flowControlTimes1++ % <span class=\"number\">1000</span>) == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">32</span>:             log.warn(</div><div class=\"line\"> <span class=\"number\">33</span>:                 <span class=\"string\">\"the consumer message buffer is full, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, size=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">34</span>:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);</div><div class=\"line\"> <span class=\"number\">35</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">36</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">37</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">38</span>: </div><div class=\"line\"> <span class=\"number\">39</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.consumeOrderly) &#123; <span class=\"comment\">// åˆ¤æ–­æ¶ˆæ¯è·¨åº¦æ˜¯å¦è¿‡å¤§ã€‚</span></div><div class=\"line\"> <span class=\"number\">40</span>:         <span class=\"keyword\">if</span> (processQueue.getMaxSpan() &gt; <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) &#123;</div><div class=\"line\"> <span class=\"number\">41</span>:             <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class=\"comment\">// æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚</span></div><div class=\"line\"> <span class=\"number\">42</span>:             <span class=\"keyword\">if</span> ((flowControlTimes2++ % <span class=\"number\">1000</span>) == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">43</span>:                 log.warn(</div><div class=\"line\"> <span class=\"number\">44</span>:                     <span class=\"string\">\"the queue's messages, span too long, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, maxSpan=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">45</span>:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),</div><div class=\"line\"> <span class=\"number\">46</span>:                     pullRequest, flowControlTimes2);</div><div class=\"line\"> <span class=\"number\">47</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">48</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">49</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">50</span>:     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// TODO é¡ºåºæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">51</span>:         <span class=\"keyword\">if</span> (processQueue.isLocked()) &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:             <span class=\"keyword\">if</span> (!pullRequest.isLockedFirst()) &#123;</div><div class=\"line\"> <span class=\"number\">53</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset = <span class=\"keyword\">this</span>.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());</div><div class=\"line\"> <span class=\"number\">54</span>:                 <span class=\"keyword\">boolean</span> brokerBusy = offset &lt; pullRequest.getNextOffset();</div><div class=\"line\"> <span class=\"number\">55</span>:                 log.info(<span class=\"string\">\"the first time to pull message, so fix offset from broker. pullRequest: &#123;&#125; NewOffset: &#123;&#125; brokerBusy: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">56</span>:                     pullRequest, offset, brokerBusy);</div><div class=\"line\"> <span class=\"number\">57</span>:                 <span class=\"keyword\">if</span> (brokerBusy) &#123;</div><div class=\"line\"> <span class=\"number\">58</span>:                     log.info(<span class=\"string\">\"[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: &#123;&#125; NewOffset: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">59</span>:                         pullRequest, offset);</div><div class=\"line\"> <span class=\"number\">60</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">61</span>: </div><div class=\"line\"> <span class=\"number\">62</span>:                 pullRequest.setLockedFirst(<span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">63</span>:                 pullRequest.setNextOffset(offset);</div><div class=\"line\"> <span class=\"number\">64</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">65</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">66</span>:             <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"> <span class=\"number\">67</span>:             log.info(<span class=\"string\">\"pull message later because not locked in broker, &#123;&#125;\"</span>, pullRequest);</div><div class=\"line\"> <span class=\"number\">68</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">70</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">71</span>: </div><div class=\"line\"> <span class=\"number\">72</span>:     <span class=\"comment\">// è·å–Topic å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">73</span>:     <span class=\"keyword\">final</span> SubscriptionData subscriptionData = <span class=\"keyword\">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class=\"line\"> <span class=\"number\">74</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionData) &#123;</div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"> <span class=\"number\">76</span>:         log.warn(<span class=\"string\">\"find the consumer's subscription failed, &#123;&#125;\"</span>, pullRequest);</div><div class=\"line\"> <span class=\"number\">77</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">78</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">79</span>: </div><div class=\"line\"> <span class=\"number\">80</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">81</span>: </div><div class=\"line\"> <span class=\"number\">82</span>:     PullCallback pullCallback = <span class=\"keyword\">new</span> PullCallback() &#123;</div><div class=\"line\"> <span class=\"number\">83</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">84</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onSuccess</span><span class=\"params\">(PullResult pullResult)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">85</span>:             <span class=\"keyword\">if</span> (pullResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">86</span>:                 pullResult = DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,</div><div class=\"line\"> <span class=\"number\">87</span>:                     subscriptionData);</div><div class=\"line\"> <span class=\"number\">88</span>: </div><div class=\"line\"> <span class=\"number\">89</span>:                 <span class=\"keyword\">switch</span> (pullResult.getPullStatus()) &#123;</div><div class=\"line\"> <span class=\"number\">90</span>:                     <span class=\"keyword\">case</span> FOUND:</div><div class=\"line\"> <span class=\"number\">91</span>:                         <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class=\"line\"> <span class=\"number\">92</span>:                         <span class=\"keyword\">long</span> prevRequestOffset = pullRequest.getNextOffset();</div><div class=\"line\"> <span class=\"number\">93</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class=\"line\"> <span class=\"number\">94</span>: </div><div class=\"line\"> <span class=\"number\">95</span>:                         <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"> <span class=\"number\">96</span>:                         <span class=\"keyword\">long</span> pullRT = System.currentTimeMillis() - beginTimestamp;</div><div class=\"line\"> <span class=\"number\">97</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),</div><div class=\"line\"> <span class=\"number\">98</span>:                             pullRequest.getMessageQueue().getTopic(), pullRT);</div><div class=\"line\"> <span class=\"number\">99</span>: </div><div class=\"line\"><span class=\"number\">100</span>:                         <span class=\"keyword\">long</span> firstMsgOffset = Long.MAX_VALUE;</div><div class=\"line\"><span class=\"number\">101</span>:                         <span class=\"keyword\">if</span> (pullResult.getMsgFoundList() == <span class=\"keyword\">null</span> || pullResult.getMsgFoundList().isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">102</span>:                             DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">103</span>:                         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">104</span>:                             firstMsgOffset = pullResult.getMsgFoundList().get(<span class=\"number\">0</span>).getQueueOffset();</div><div class=\"line\"><span class=\"number\">105</span>: </div><div class=\"line\"><span class=\"number\">106</span>:                             <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"><span class=\"number\">107</span>:                             DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</div><div class=\"line\"><span class=\"number\">108</span>:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>:                             <span class=\"comment\">// æäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">111</span>:                             <span class=\"keyword\">boolean</span> dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</div><div class=\"line\"><span class=\"number\">112</span>: </div><div class=\"line\"><span class=\"number\">113</span>:                             <span class=\"comment\">// æäº¤æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">114</span>:                             DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.consumeMessageService.submitConsumeRequest(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">115</span>:                                 pullResult.getMsgFoundList(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">116</span>:                                 processQueue, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">117</span>:                                 pullRequest.getMessageQueue(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">118</span>:                                 dispathToConsume);</div><div class=\"line\"><span class=\"number\">119</span>: </div><div class=\"line\"><span class=\"number\">120</span>:                             <span class=\"comment\">// æäº¤ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">121</span>:                             <span class=\"keyword\">if</span> (DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.defaultMQPushConsumer.getPullInterval() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">122</span>:                                 DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestLater(pullRequest,</div><div class=\"line\"><span class=\"number\">123</span>:                                     DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.defaultMQPushConsumer.getPullInterval());</div><div class=\"line\"><span class=\"number\">124</span>:                             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">125</span>:                                 DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">126</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">127</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">128</span>: </div><div class=\"line\"><span class=\"number\">129</span>:                         <span class=\"comment\">// ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸ºBUGï¼Œè¾“å‡ºlog</span></div><div class=\"line\"><span class=\"number\">130</span>:                         <span class=\"keyword\">if</span> (pullResult.getNextBeginOffset() &lt; prevRequestOffset<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">131</span>:                             || firstMsgOffset &lt; prevRequestOffset) &#123;</div><div class=\"line\"><span class=\"number\">132</span>:                             log.warn(</div><div class=\"line\"><span class=\"number\">133</span>:                                 <span class=\"string\">\"[BUG] pull message result maybe data wrong, nextBeginOffset: &#123;&#125; firstMsgOffset: &#123;&#125; prevRequestOffset: &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">134</span>:                                 pullResult.getNextBeginOffset(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">135</span>:                                 firstMsgOffset, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">136</span>:                                 prevRequestOffset);</div><div class=\"line\"><span class=\"number\">137</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">138</span>: </div><div class=\"line\"><span class=\"number\">139</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">140</span>:                     <span class=\"keyword\">case</span> NO_NEW_MSG:</div><div class=\"line\"><span class=\"number\">141</span>:                         <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class=\"line\"><span class=\"number\">142</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">143</span>: </div><div class=\"line\"><span class=\"number\">144</span>:                         <span class=\"comment\">// æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">145</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.correctTagsOffset(pullRequest);</div><div class=\"line\"><span class=\"number\">146</span>: </div><div class=\"line\"><span class=\"number\">147</span>:                         <span class=\"comment\">// ç«‹å³æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">148</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">149</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">150</span>:                     <span class=\"keyword\">case</span> NO_MATCHED_MSG:</div><div class=\"line\"><span class=\"number\">151</span>:                         <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class=\"line\"><span class=\"number\">152</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">153</span>: </div><div class=\"line\"><span class=\"number\">154</span>:                         <span class=\"comment\">// æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">155</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.correctTagsOffset(pullRequest);</div><div class=\"line\"><span class=\"number\">156</span>: </div><div class=\"line\"><span class=\"number\">157</span>:                         <span class=\"comment\">// æäº¤ç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">158</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">159</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">160</span>:                     <span class=\"keyword\">case</span> OFFSET_ILLEGAL:</div><div class=\"line\"><span class=\"number\">161</span>:                         log.warn(<span class=\"string\">\"the pull request offset illegal, &#123;&#125; &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">162</span>:                             pullRequest.toString(), pullResult.toString());</div><div class=\"line\"><span class=\"number\">163</span>:                         <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class=\"line\"><span class=\"number\">164</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">165</span>: </div><div class=\"line\"><span class=\"number\">166</span>:                         <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸ºdropped</span></div><div class=\"line\"><span class=\"number\">167</span>:                         pullRequest.getProcessQueue().setDropped(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">168</span>: </div><div class=\"line\"><span class=\"number\">169</span>:                         <span class=\"comment\">// æäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ç§»é™¤ã€‚ä¸ç«‹å³ç§»é™¤çš„åŸå› ï¼šå¯èƒ½æœ‰åœ°æ–¹æ­£åœ¨ä½¿ç”¨ï¼Œé¿å…å—åˆ°å½±å“ã€‚</span></div><div class=\"line\"><span class=\"number\">170</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executeTaskLater(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"><span class=\"number\">171</span>: </div><div class=\"line\"><span class=\"number\">172</span>:                             <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">173</span>:                             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">174</span>:                                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">175</span>:                                     <span class=\"comment\">// æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ°Broker</span></div><div class=\"line\"><span class=\"number\">176</span>:                                     DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(),</div><div class=\"line\"><span class=\"number\">177</span>:                                         pullRequest.getNextOffset(), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">178</span>:                                     DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.offsetStore.persist(pullRequest.getMessageQueue());</div><div class=\"line\"><span class=\"number\">179</span>: </div><div class=\"line\"><span class=\"number\">180</span>:                                     <span class=\"comment\">// ç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">181</span>:                                     DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());</div><div class=\"line\"><span class=\"number\">182</span>: </div><div class=\"line\"><span class=\"number\">183</span>:                                     log.warn(<span class=\"string\">\"fix the pull request offset, &#123;&#125;\"</span>, pullRequest);</div><div class=\"line\"><span class=\"number\">184</span>:                                 &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">185</span>:                                     log.error(<span class=\"string\">\"executeTaskLater Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">186</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">187</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">188</span>:                         &#125;, <span class=\"number\">10000</span>);</div><div class=\"line\"><span class=\"number\">189</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">190</span>:                     <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">191</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">192</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">193</span>:             &#125;</div><div class=\"line\"><span class=\"number\">194</span>:         &#125;</div><div class=\"line\"><span class=\"number\">195</span>: </div><div class=\"line\"><span class=\"number\">196</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">197</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onException</span><span class=\"params\">(Throwable e)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">198</span>:             <span class=\"keyword\">if</span> (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">199</span>:                 log.warn(<span class=\"string\">\"execute the pull request exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">200</span>:             &#125;</div><div class=\"line\"><span class=\"number\">201</span>: </div><div class=\"line\"><span class=\"number\">202</span>:             <span class=\"comment\">// æäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">203</span>:             DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"><span class=\"number\">204</span>:         &#125;</div><div class=\"line\"><span class=\"number\">205</span>:     &#125;;</div><div class=\"line\"><span class=\"number\">206</span>: </div><div class=\"line\"><span class=\"number\">207</span>:     <span class=\"comment\">// é›†ç¾¤æ¶ˆæ¯æ¨¡å‹ä¸‹ï¼Œè®¡ç®—æäº¤çš„æ¶ˆè´¹è¿›åº¦ã€‚</span></div><div class=\"line\"><span class=\"number\">208</span>:     <span class=\"keyword\">boolean</span> commitOffsetEnable = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">209</span>:     <span class=\"keyword\">long</span> commitOffsetValue = <span class=\"number\">0L</span>;</div><div class=\"line\"><span class=\"number\">210</span>:     <span class=\"keyword\">if</span> (MessageModel.CLUSTERING == <span class=\"keyword\">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class=\"line\"><span class=\"number\">211</span>:         commitOffsetValue = <span class=\"keyword\">this</span>.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);</div><div class=\"line\"><span class=\"number\">212</span>:         <span class=\"keyword\">if</span> (commitOffsetValue &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">213</span>:             commitOffsetEnable = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">214</span>:         &#125;</div><div class=\"line\"><span class=\"number\">215</span>:     &#125;</div><div class=\"line\"><span class=\"number\">216</span>: </div><div class=\"line\"><span class=\"number\">217</span>:     <span class=\"comment\">// è®¡ç®—è¯·æ±‚çš„ è®¢é˜…è¡¨è¾¾å¼ å’Œ æ˜¯å¦è¿›è¡Œfiltersrvè¿‡æ»¤æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">218</span>:     String subExpression = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">219</span>:     <span class=\"keyword\">boolean</span> classFilter = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">220</span>:     SubscriptionData sd = <span class=\"keyword\">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class=\"line\"><span class=\"number\">221</span>:     <span class=\"keyword\">if</span> (sd != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">222</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) &#123;</div><div class=\"line\"><span class=\"number\">223</span>:             subExpression = sd.getSubString();</div><div class=\"line\"><span class=\"number\">224</span>:         &#125;</div><div class=\"line\"><span class=\"number\">225</span>: </div><div class=\"line\"><span class=\"number\">226</span>:         classFilter = sd.isClassFilterMode();</div><div class=\"line\"><span class=\"number\">227</span>:     &#125;</div><div class=\"line\"><span class=\"number\">228</span>: </div><div class=\"line\"><span class=\"number\">229</span>:     <span class=\"comment\">// è®¡ç®—æ‹‰å–æ¶ˆæ¯ç³»ç»Ÿæ ‡è¯†</span></div><div class=\"line\"><span class=\"number\">230</span>:     <span class=\"keyword\">int</span> sysFlag = PullSysFlag.buildSysFlag(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">231</span>:         commitOffsetEnable, <span class=\"comment\">// commitOffset</span></div><div class=\"line\"><span class=\"number\">232</span>:         <span class=\"keyword\">true</span>, <span class=\"comment\">// suspend</span></div><div class=\"line\"><span class=\"number\">233</span>:         subExpression != <span class=\"keyword\">null</span>, <span class=\"comment\">// subscription</span></div><div class=\"line\"><span class=\"number\">234</span>:         classFilter <span class=\"comment\">// class filter</span></div><div class=\"line\"><span class=\"number\">235</span>:     );</div><div class=\"line\"><span class=\"number\">236</span>: </div><div class=\"line\"><span class=\"number\">237</span>:     <span class=\"comment\">// æ‰§è¡Œæ‹‰å–ã€‚å¦‚æœæ‹‰å–è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</span></div><div class=\"line\"><span class=\"number\">238</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">239</span>:         <span class=\"keyword\">this</span>.pullAPIWrapper.pullKernelImpl(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">240</span>:             pullRequest.getMessageQueue(), <span class=\"comment\">// 1</span></div><div class=\"line\"><span class=\"number\">241</span>:             subExpression, <span class=\"comment\">// 2</span></div><div class=\"line\"><span class=\"number\">242</span>:             subscriptionData.getSubVersion(), <span class=\"comment\">// 3</span></div><div class=\"line\"><span class=\"number\">243</span>:             pullRequest.getNextOffset(), <span class=\"comment\">// 4</span></div><div class=\"line\"><span class=\"number\">244</span>:             <span class=\"keyword\">this</span>.defaultMQPushConsumer.getPullBatchSize(), <span class=\"comment\">// 5</span></div><div class=\"line\"><span class=\"number\">245</span>:             sysFlag, <span class=\"comment\">// 6</span></div><div class=\"line\"><span class=\"number\">246</span>:             commitOffsetValue, <span class=\"comment\">// 7</span></div><div class=\"line\"><span class=\"number\">247</span>:             BROKER_SUSPEND_MAX_TIME_MILLIS, <span class=\"comment\">// 8</span></div><div class=\"line\"><span class=\"number\">248</span>:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, <span class=\"comment\">// 9</span></div><div class=\"line\"><span class=\"number\">249</span>:             CommunicationMode.ASYNC, <span class=\"comment\">// 10</span></div><div class=\"line\"><span class=\"number\">250</span>:             pullCallback<span class=\"comment\">// 11</span></div><div class=\"line\"><span class=\"number\">251</span>:         );</div><div class=\"line\"><span class=\"number\">252</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">253</span>:         log.error(<span class=\"string\">\"pullKernelImpl exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">254</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"><span class=\"number\">255</span>:     &#125;</div><div class=\"line\"><span class=\"number\">256</span>: &#125;</div><div class=\"line\"><span class=\"number\">257</span>: </div><div class=\"line\"><span class=\"number\">258</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">correctTagsOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">259</span>:     <span class=\"keyword\">if</span> (<span class=\"number\">0L</span> == pullRequest.getProcessQueue().getMsgCount().get()) &#123;</div><div class=\"line\"><span class=\"number\">260</span>:         <span class=\"keyword\">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">261</span>:     &#125;</div><div class=\"line\"><span class=\"number\">262</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>#pullMessage(...)</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯ã€‚\n<ul>\n<li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å·²ç»ç»ˆæ­¢ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li>\n<li>ç¬¬ 9 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´ã€‚</li>\n<li>ç¬¬ 11 è‡³ 18 è¡Œ ï¼š<code>Consumer</code> æœªå¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 20 è‡³ 25 è¡Œ ï¼š <code>Consumer</code> å¤„äºæš‚åœä¸­ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 27 è‡³ 37 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è¶…è¿‡æœ€å¤§å…è®¸å€¼ï¼ˆé»˜è®¤ï¼š1000æ¡ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 39 è‡³ 49 è¡Œ ï¼š<code>Consumer</code> ä¸º<strong>å¹¶å‘æ¶ˆè´¹</strong> å¹¶ä¸” æ¶ˆæ¯é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è·¨åº¦è¿‡å¤§ï¼ˆæ¶ˆæ¯è·¨åº¦ = æŒæœ‰æ¶ˆæ¯æœ€åä¸€æ¡å’Œç¬¬ä¸€æ¡çš„æ¶ˆæ¯ä½ç½®å·®ï¼Œé»˜è®¤ï¼š2000ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 50 è‡³ 70 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>\n<li>ç¬¬ 72 è‡³ 78 è¡Œ ï¼š<code>Topic</code> å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 222 è‡³ 224 è¡Œ ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä½¿ç”¨ <code>Consumer</code> <strong>æœ¬åœ°</strong>çš„è®¢é˜…ä¿¡æ¯( <code>SubscriptionData</code> )ï¼Œè€Œä¸ä½¿ç”¨ <code>Broker</code> é‡Œçš„è®¢é˜…ä¿¡æ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-%E2%80%A6\">PullMessageProcessor#processRequest(...) ç¬¬ 64 è‡³ 110 è¡Œä»£ç </a>ã€‚</li>\n<li>ç¬¬ 226 è¡Œ ï¼šæ˜¯å¦å¼€å¯è¿‡æ»¤ç±»è¿‡æ»¤æ¨¡å¼ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/filtersrv/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Filtersrvã€‹</a>ã€‚</li>\n<li>ç¬¬ 229 è‡³ 235 è¡Œ ï¼šè®¡ç®—æ‹‰å–æ¶ˆæ¯è¯·æ±‚ç³»ç»Ÿæ ‡è¯†ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageRequestHeader\">PullMessageRequestHeader.sysFlag</a>ã€‚</li>\n<li>ç¬¬ 237 è‡³ 255 è¡Œ ï¼š\n<ul>\n<li>æ‰§è¡Œæ¶ˆæ¯æ‹‰å–<strong>å¼‚æ­¥</strong>è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#pullapiwrapperpullkernelimpl\">PullAPIWrapper#pullKernelImpl(...)</a>ã€‚</li>\n<li>å½“å‘èµ·è¯·æ±‚äº§ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚å¯¹åº” <code>Broker</code> å¤„ç†æ‹‰å–æ¶ˆæ¯é€»è¾‘è§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-%E2%80%A6\">PullMessageProcessor#processRequest(...)</a>ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>PullCallback</code> ï¼šæ‹‰å–æ¶ˆæ¯å›è°ƒï¼š\n<ul>\n<li>ç¬¬ 86 è¡Œ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚è¯¦ç»†é€»è¾‘è§ï¼š<a href=\"#pullapiwrapperprocesspullresult\">PullAPIWrapper#processPullResult(...)</a>ã€‚</li>\n<li>ç¬¬ 89 è‡³ 192 è¡Œ ï¼šå¤„ç†æ‹‰å–çŠ¶æ€ç»“æœï¼š\n<ul>\n<li>ç¬¬ 90 è‡³ 139 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯( <code>FOUND</code> ) ï¼š\n<ul>\n<li>ç¬¬ 91 è‡³ 93 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>\n<li>ç¬¬ 95 è‡³ 97 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>\n<li>ç¬¬ 101 è‡³ 102 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯çš„æ¶ˆæ¯åˆ—è¡¨ä¸ºç©ºï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆæ¯ç»“æœæœªç©ºå‘¢ï¼ŸåŸå› è§ï¼š<a href=\"#pullapiwrapperprocesspullresult\">PullAPIWrapper#processPullResult(...)</a>ã€‚</li>\n<li>ç¬¬ 106 è‡³ 108 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>\n<li>ç¬¬ 111 è¡Œ ï¼šæäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#processqueueputmessage\">ProcessQueue#putMessage(...)</a>ã€‚</li>\n<li>ç¬¬ 113 è‡³ 118 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚åˆ° <code>ConsumeMessageService</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#consumemessageconcurrentlyservice\">ConsumeMessageConcurrentlyService</a>ã€‚</li>\n<li>ç¬¬ 120 è‡³ 126 è¡Œ ï¼šæ ¹æ®æ‹‰å–é¢‘ç‡( <code>pullInterval</code> )ï¼Œæäº¤<strong>ç«‹å³æˆ–è€…å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚é»˜è®¤æ‹‰å–é¢‘ç‡ä¸º 0ms ï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 129 è‡³ 137 è¡Œ ï¼šä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸º<strong>BUG</strong>ï¼Œè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 140 è‡³ 149 è¡Œ ï¼šæ²¡æœ‰æ–°æ¶ˆæ¯( <code>NO_NEW_MSG</code> ) ï¼š\n<ul>\n<li>ç¬¬ 142 è¡Œ ï¼š è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>\n<li>ç¬¬ 145 è¡Œ ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<code>#correctTagsOffset(...)</code>ã€‚</li>\n<li>ç¬¬ 148 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 150 è‡³ 159 è¡Œ ï¼šæœ‰æ–°æ¶ˆæ¯ä½†æ˜¯ä¸åŒ¹é…( <code>NO_MATCHED_MSG</code> )ã€‚é€»è¾‘åŒ <code>NO_NEW_MSG</code> ã€‚</li>\n<li>ç¬¬ 160 è‡³ 189 è¡Œ ï¼šæ‹‰å–è¯·æ±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ä¸åˆæ³• (<code>OFFSET_ILLEGAL</code>)ã€‚\n<ul>\n<li>ç¬¬ 164 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>\n<li>ç¬¬ 167 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸º <code>dropped</code>ã€‚</li>\n<li>ç¬¬ 169 è‡³ 188 è¡Œ ï¼šæäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œé˜Ÿåˆ—ç§»é™¤ã€‚\n<ul>\n<li>ç¬¬ 175 è‡³ 178 è¡Œ ï¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li>\n<li>ç¬¬ 181 è¡Œ ï¼šç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ç«‹å³ç§»é™¤ï¼Ÿï¼Ÿï¼Ÿ</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ç¬¬ 196 è‡³ 204 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n</ul>\n</li>\n<li><code>#correctTagsOffset(...)</code> ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚\n<ul>\n<li>ç¬¬ 258 è‡³ 261 è¡Œ ï¼š å½“æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯æ•°é‡ä¸º <strong>0</strong> æ—¶ï¼Œæ›´æ–°æ¶ˆè´¹è¿›åº¦ä¸ºæ‹‰å–è¯·æ±‚çš„æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3>PullAPIWrapper#pullKernelImpl(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> subExpression è®¢é˜…è¡¨è¾¾å¼</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> subVersion è®¢é˜…ç‰ˆæœ¬å·</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> maxNums æ‹‰å–æ¶ˆæ¯æ•°é‡</div><div class=\"line\"> 9:  * <span class=\"doctag\">@param</span> sysFlag æ‹‰å–è¯·æ±‚ç³»ç»Ÿæ ‡è¯†</div><div class=\"line\">10:  * <span class=\"doctag\">@param</span> commitOffset æäº¤æ¶ˆè´¹è¿›åº¦</div><div class=\"line\">11:  * <span class=\"doctag\">@param</span> brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´</div><div class=\"line\">12:  * <span class=\"doctag\">@param</span> timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é•¿</div><div class=\"line\">13:  * <span class=\"doctag\">@param</span> communicationMode é€šè®¯æ¨¡å¼</div><div class=\"line\">14:  * <span class=\"doctag\">@param</span> pullCallback æ‹‰å–å›è°ƒ</div><div class=\"line\">15:  * <span class=\"doctag\">@return</span> æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚</div><div class=\"line\">16:  * <span class=\"doctag\">@throws</span> MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸</div><div class=\"line\">17:  * <span class=\"doctag\">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">18:  * <span class=\"doctag\">@throws</span> MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚</div><div class=\"line\">19:  * <span class=\"doctag\">@throws</span> InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶</div><div class=\"line\">20:  */</div><div class=\"line\"><span class=\"number\">21</span>: <span class=\"function\"><span class=\"keyword\">protected</span> PullResult <span class=\"title\">pullKernelImpl</span><span class=\"params\">(</span></span></div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">final</span> MessageQueue mq,</div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"keyword\">final</span> String subExpression,</div><div class=\"line\"><span class=\"number\">24</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> subVersion,</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset,</div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxNums,</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> sysFlag,</div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> commitOffset,</div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> brokerSuspendMaxTimeMillis,</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeoutMillis,</div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode,</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"keyword\">final</span> PullCallback pullCallback</div><div class=\"line\"><span class=\"number\">33</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">// è·å–Brokerä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">35</span>:     FindBrokerResult findBrokerResult =</div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">this</span>.recalculatePullFromWhichNode(mq), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == findBrokerResult) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"keyword\">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());</div><div class=\"line\"><span class=\"number\">40</span>:         findBrokerResult =</div><div class=\"line\"><span class=\"number\">41</span>:             <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class=\"line\"><span class=\"number\">42</span>:                 <span class=\"keyword\">this</span>.recalculatePullFromWhichNode(mq), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"comment\">// è¯·æ±‚æ‹‰å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">if</span> (findBrokerResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:         <span class=\"keyword\">int</span> sysFlagInner = sysFlag;</div><div class=\"line\"><span class=\"number\">48</span>: </div><div class=\"line\"><span class=\"number\">49</span>:         <span class=\"keyword\">if</span> (findBrokerResult.isSlave()) &#123;</div><div class=\"line\"><span class=\"number\">50</span>:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);</div><div class=\"line\"><span class=\"number\">51</span>:         &#125;</div><div class=\"line\"><span class=\"number\">52</span>: </div><div class=\"line\"><span class=\"number\">53</span>:         PullMessageRequestHeader requestHeader = <span class=\"keyword\">new</span> PullMessageRequestHeader();</div><div class=\"line\"><span class=\"number\">54</span>:         requestHeader.setConsumerGroup(<span class=\"keyword\">this</span>.consumerGroup);</div><div class=\"line\"><span class=\"number\">55</span>:         requestHeader.setTopic(mq.getTopic());</div><div class=\"line\"><span class=\"number\">56</span>:         requestHeader.setQueueId(mq.getQueueId());</div><div class=\"line\"><span class=\"number\">57</span>:         requestHeader.setQueueOffset(offset);</div><div class=\"line\"><span class=\"number\">58</span>:         requestHeader.setMaxMsgNums(maxNums);</div><div class=\"line\"><span class=\"number\">59</span>:         requestHeader.setSysFlag(sysFlagInner);</div><div class=\"line\"><span class=\"number\">60</span>:         requestHeader.setCommitOffset(commitOffset);</div><div class=\"line\"><span class=\"number\">61</span>:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);</div><div class=\"line\"><span class=\"number\">62</span>:         requestHeader.setSubscription(subExpression);</div><div class=\"line\"><span class=\"number\">63</span>:         requestHeader.setSubVersion(subVersion);</div><div class=\"line\"><span class=\"number\">64</span>: </div><div class=\"line\"><span class=\"number\">65</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class=\"line\"><span class=\"number\">66</span>:         <span class=\"keyword\">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123; <span class=\"comment\">// TODO filtersrv</span></div><div class=\"line\"><span class=\"number\">67</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class=\"line\"><span class=\"number\">68</span>:         &#125;</div><div class=\"line\"><span class=\"number\">69</span>: </div><div class=\"line\"><span class=\"number\">70</span>:         PullResult pullResult = <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class=\"line\"><span class=\"number\">71</span>:             brokerAddr,</div><div class=\"line\"><span class=\"number\">72</span>:             requestHeader,</div><div class=\"line\"><span class=\"number\">73</span>:             timeoutMillis,</div><div class=\"line\"><span class=\"number\">74</span>:             communicationMode,</div><div class=\"line\"><span class=\"number\">75</span>:             pullCallback);</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:         <span class=\"keyword\">return</span> pullResult;</div><div class=\"line\"><span class=\"number\">78</span>:     &#125;</div><div class=\"line\"><span class=\"number\">79</span>: </div><div class=\"line\"><span class=\"number\">80</span>:     <span class=\"comment\">// Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">81</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"The broker[\"</span> + mq.getBrokerName() + <span class=\"string\">\"] not exist\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">82</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚<strong>è¯¥æ–¹æ³•å‚æ•°è¾ƒå¤šï¼Œå¯ä»¥çœ‹ä¸‹ä»£ç æ³¨é‡Šä¸Šæ¯ä¸ªå‚æ•°çš„è¯´æ˜</strong>ğŸ˜ˆã€‚</li>\n<li>ç¬¬ 34 è‡³ 43 è¡Œ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚\n<ul>\n<li><a href=\"#pullapiwrapperrecalculatepullfromwhichnode\">#recalculatePullFromWhichNode(...)</a></li>\n<li><a href=\"#mqclientinstancefindbrokeraddressinsubscribe\">#MQClientInstance#findBrokerAddressInSubscribe(...)</a></li>\n</ul>\n</li>\n<li>ç¬¬ 45 è‡³ 78 è¡Œ ï¼š<strong>è¯·æ±‚æ‹‰å–æ¶ˆæ¯</strong>ã€‚</li>\n<li>ç¬¬ 81 è¡Œ ï¼šå½“ <code>Broker</code> ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>\n</ul>\n<h4>PullAPIWrapper#recalculatePullFromWhichNode(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ¶ˆæ¯é˜Ÿåˆ— ä¸ æ‹‰å–Broker çš„æ˜ å°„</div><div class=\"line\"> 3:  * å½“æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œä¼šé€šè¿‡è¯¥æ˜ å°„è·å–æ‹‰å–è¯·æ±‚å¯¹åº”çš„Broker</div><div class=\"line\"> 4:  */</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"keyword\">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong<span class=\"comment\">/* brokerId */</span>&gt; pullFromWhichNodeTable =</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">new</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt;(<span class=\"number\">32</span>);</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 8:  * æ˜¯å¦ä½¿ç”¨é»˜è®¤Broker</div><div class=\"line\"> 9:  */</div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">boolean</span> connectBrokerByUser = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"comment\">/**</span></div><div class=\"line\">12:  * é»˜è®¤Brokerç¼–å·</div><div class=\"line\">13:  */</div><div class=\"line\"><span class=\"number\">14</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> defaultBrokerId = MixAll.MASTER_ID;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>: <span class=\"comment\">/**</span></div><div class=\"line\">17:  * è®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„Brokerç¼–å·</div><div class=\"line\">18:  *</div><div class=\"line\">19:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">20:  * <span class=\"doctag\">@return</span> Brokerç¼–å·</div><div class=\"line\">21:  */</div><div class=\"line\"><span class=\"number\">22</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">recalculatePullFromWhichNode</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"comment\">// è‹¥å¼€å¯é»˜è®¤Brokerå¼€å…³ï¼Œåˆ™è¿”å›é»˜è®¤Brokerç¼–å·</span></div><div class=\"line\"><span class=\"number\">24</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isConnectBrokerByUser()) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.defaultBrokerId;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"comment\">// è‹¥æ¶ˆæ¯é˜Ÿåˆ—æ˜ å°„æ‹‰å–Brokerå­˜åœ¨ï¼Œåˆ™è¿”å›æ˜ å°„Brokerç¼–å·</span></div><div class=\"line\"><span class=\"number\">29</span>:     AtomicLong suggest = <span class=\"keyword\">this</span>.pullFromWhichNodeTable.get(mq);</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">if</span> (suggest != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"keyword\">return</span> suggest.get();</div><div class=\"line\"><span class=\"number\">32</span>:     &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">// è¿”å›Brokerä¸»èŠ‚ç‚¹ç¼–å·</span></div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"keyword\">return</span> MixAll.MASTER_ID;</div><div class=\"line\"><span class=\"number\">36</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„ <code>Broker</code> ç¼–å·ã€‚</li>\n</ul>\n<h4>MQClientInstance#findBrokerAddressInSubscribe(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * Brokeråå­— å’Œ Brokeråœ°å€ç›¸å…³ Map</div><div class=\"line\"> 3:  */</div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConcurrentHashMap&lt;String<span class=\"comment\">/* Broker Name */</span>, HashMap&lt;Long<span class=\"comment\">/* brokerId */</span>, String<span class=\"comment\">/* address */</span>&gt;&gt; brokerAddrTable =</div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 8:  * è·å¾—Brokerä¿¡æ¯</div><div class=\"line\"> 9:  *</div><div class=\"line\">10:  * <span class=\"doctag\">@param</span> brokerName brokeråå­—</div><div class=\"line\">11:  * <span class=\"doctag\">@param</span> brokerId brokerç¼–å·</div><div class=\"line\">12:  * <span class=\"doctag\">@param</span> onlyThisBroker æ˜¯å¦å¿…é¡»æ˜¯è¯¥broker</div><div class=\"line\">13:  * <span class=\"doctag\">@return</span> Brokerä¿¡æ¯</div><div class=\"line\">14:  */</div><div class=\"line\"><span class=\"number\">15</span>: <span class=\"function\"><span class=\"keyword\">public</span> FindBrokerResult <span class=\"title\">findBrokerAddressInSubscribe</span><span class=\"params\">(//</span></span></div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">final</span> String brokerName, //</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> brokerId, //</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> onlyThisBroker//</div><div class=\"line\"><span class=\"number\">19</span>: ) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:     String brokerAddr = <span class=\"keyword\">null</span>; <span class=\"comment\">// brokeråœ°å€</span></div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"keyword\">boolean</span> slave = <span class=\"keyword\">false</span>; <span class=\"comment\">// æ˜¯å¦ä¸ºä»èŠ‚ç‚¹</span></div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">boolean</span> found = <span class=\"keyword\">false</span>; <span class=\"comment\">// æ˜¯å¦æ‰¾åˆ°</span></div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:     <span class=\"comment\">// è·å¾—Brokerä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">25</span>:     HashMap&lt;Long<span class=\"comment\">/* brokerId */</span>, String<span class=\"comment\">/* address */</span>&gt; map = <span class=\"keyword\">this</span>.brokerAddrTable.get(brokerName);</div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">if</span> (map != <span class=\"keyword\">null</span> &amp;&amp; !map.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:         brokerAddr = map.get(brokerId);</div><div class=\"line\"><span class=\"number\">28</span>:         slave = brokerId != MixAll.MASTER_ID;</div><div class=\"line\"><span class=\"number\">29</span>:         found = brokerAddr != <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"comment\">// å¦‚æœä¸å¼ºåˆ¶è·å¾—ï¼Œé€‰æ‹©ä¸€ä¸ªBroker</span></div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"keyword\">if</span> (!found &amp;&amp; !onlyThisBroker) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:             Entry&lt;Long, String&gt; entry = map.entrySet().iterator().next();</div><div class=\"line\"><span class=\"number\">34</span>:             brokerAddr = entry.getValue();</div><div class=\"line\"><span class=\"number\">35</span>:             slave = entry.getKey() != MixAll.MASTER_ID;</div><div class=\"line\"><span class=\"number\">36</span>:             found = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">37</span>:         &#125;</div><div class=\"line\"><span class=\"number\">38</span>:     &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"comment\">// æ‰¾åˆ°brokerï¼Œåˆ™è¿”å›ä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">41</span>:     <span class=\"keyword\">if</span> (found) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> FindBrokerResult(brokerAddr, slave);</div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"comment\">// æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å›ç©º</span></div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">47</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚</li>\n</ul>\n<h3>PullAPIWrapper#processPullResult(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * å¤„ç†æ‹‰å–ç»“æœ</div><div class=\"line\"> 3:  * 1. æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„</div><div class=\"line\"> 4:  * 2. è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</div><div class=\"line\"> 5:  *</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> pullResult æ‹‰å–ç»“æœ</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> subscriptionData è®¢é˜…ä¿¡æ¯</div><div class=\"line\"> 9:  * <span class=\"doctag\">@return</span> æ‹‰å–ç»“æœ</div><div class=\"line\">10:  */</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"function\"><span class=\"keyword\">public</span> PullResult <span class=\"title\">processPullResult</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq, <span class=\"keyword\">final</span> PullResult pullResult,</span></span></div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> SubscriptionData subscriptionData) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:     PullResultExt pullResultExt = (PullResultExt) pullResult;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"comment\">// æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„</span></div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">this</span>.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"comment\">// è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">if</span> (PullStatus.FOUND == pullResult.getPullStatus()) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"comment\">// è§£ææ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">21</span>:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());</div><div class=\"line\"><span class=\"number\">22</span>:         List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"comment\">// æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">25</span>:         List&lt;MessageExt&gt; msgListFilterAgain = msgList;</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">if</span> (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:             msgListFilterAgain = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(msgList.size());</div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"keyword\">for</span> (MessageExt msg : msgList) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:                 <span class=\"keyword\">if</span> (msg.getTags() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"keyword\">if</span> (subscriptionData.getTagsSet().contains(msg.getTags())) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                         msgListFilterAgain.add(msg);</div><div class=\"line\"><span class=\"number\">32</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">33</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">34</span>:             &#125;</div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:         <span class=\"comment\">// Hook</span></div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasHook()) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:             FilterMessageContext filterMessageContext = <span class=\"keyword\">new</span> FilterMessageContext();</div><div class=\"line\"><span class=\"number\">40</span>:             filterMessageContext.setUnitMode(unitMode);</div><div class=\"line\"><span class=\"number\">41</span>:             filterMessageContext.setMsgList(msgListFilterAgain);</div><div class=\"line\"><span class=\"number\">42</span>:             <span class=\"keyword\">this</span>.executeHook(filterMessageContext);</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:         <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µ</span></div><div class=\"line\"><span class=\"number\">46</span>:         <span class=\"keyword\">for</span> (MessageExt msg : msgListFilterAgain) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,</div><div class=\"line\"><span class=\"number\">48</span>:                 Long.toString(pullResult.getMinOffset()));</div><div class=\"line\"><span class=\"number\">49</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,</div><div class=\"line\"><span class=\"number\">50</span>:                 Long.toString(pullResult.getMaxOffset()));</div><div class=\"line\"><span class=\"number\">51</span>:         &#125;</div><div class=\"line\"><span class=\"number\">52</span>: </div><div class=\"line\"><span class=\"number\">53</span>:         <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯åˆ—è¡¨</span></div><div class=\"line\"><span class=\"number\">54</span>:         pullResultExt.setMsgFoundList(msgListFilterAgain);</div><div class=\"line\"><span class=\"number\">55</span>:     &#125;</div><div class=\"line\"><span class=\"number\">56</span>: </div><div class=\"line\"><span class=\"number\">57</span>:     <span class=\"comment\">// æ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„</span></div><div class=\"line\"><span class=\"number\">58</span>:     pullResultExt.setMessageBinary(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:     <span class=\"keyword\">return</span> pullResult;</div><div class=\"line\"><span class=\"number\">61</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚\n<ul>\n<li>æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚</li>\n<li>è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code>åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 16 è¡Œ ï¼šæ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæœªè®¾ç½®é»˜è®¤æ‹‰å–çš„ <code>Broker</code> ç¼–å·ï¼Œä¼šä½¿ç”¨æ›´æ–°åçš„ <code>Broker</code> ç¼–å·ã€‚</li>\n<li>ç¬¬ 18 è‡³ 55 è¡Œ ï¼šè§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code> åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚\n<ul>\n<li>ç¬¬ 20 è‡³ 22 è¡Œ ï¼šè§£ææ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” MessageåŸºç¡€ã€‹</a> ã€‚</li>\n<li>ç¬¬ 24 è‡³ 35 è¡Œ ï¼šæ ¹æ®è®¢é˜…ä¿¡æ¯<code>tagCode</code> åŒ¹é…æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 37 è‡³ 43 è¡Œ ï¼š<code>Hook</code>ã€‚</li>\n<li>ç¬¬ 45 è‡³ 51 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µã€‚</li>\n<li>ç¬¬ 54 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 58 è¡Œ ï¼šæ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„ã€‚</li>\n</ul>\n<h3>ProcessQueue#putMessage(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>:  <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ¶ˆæ¯æ˜ å°„è¯»å†™é”</div><div class=\"line\"> 3:  */</div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ReadWriteLock lockTreeMap = <span class=\"keyword\">new</span> ReentrantReadWriteLock();</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 6:  * æ¶ˆæ¯æ˜ å°„</div><div class=\"line\"> 7:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class=\"line\"> 8:  */</div><div class=\"line\"> <span class=\"number\">9</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class=\"keyword\">new</span> TreeMap&lt;&gt;();</div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"comment\">/**</span></div><div class=\"line\">11:  * æ¶ˆæ¯æ•°</div><div class=\"line\">12:  */</div><div class=\"line\"><span class=\"number\">13</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AtomicLong msgCount = <span class=\"keyword\">new</span> AtomicLong();</div><div class=\"line\"><span class=\"number\">14</span>: <span class=\"comment\">/**</span></div><div class=\"line\">15:  * æ·»åŠ æ¶ˆæ¯æœ€å¤§é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">16:  */</div><div class=\"line\"><span class=\"number\">17</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> queueOffsetMax = <span class=\"number\">0L</span>;</div><div class=\"line\"><span class=\"number\">18</span>: <span class=\"comment\">/**</span></div><div class=\"line\">19:  * æ˜¯å¦æ­£åœ¨æ¶ˆè´¹</div><div class=\"line\">20:  */</div><div class=\"line\"><span class=\"number\">21</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">boolean</span> consuming = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">22</span>: <span class=\"comment\">/**</span></div><div class=\"line\">23:  * Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡</div><div class=\"line\">24:  * è®¡ç®—å…¬å¼ = queueMaxOffset - æ–°æ·»åŠ æ¶ˆæ¯æ•°ç»„[n - 1].queueOffset</div><div class=\"line\">25:  * Acc = Accumulation</div><div class=\"line\">26:  * cnt = ï¼ˆçŒœæµ‹ï¼‰å¯¹æ¯”åº¦</div><div class=\"line\">27:  */</div><div class=\"line\"><span class=\"number\">28</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> msgAccCnt = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>: <span class=\"comment\">/**</span></div><div class=\"line\">31:  * æ·»åŠ æ¶ˆæ¯ï¼Œå¹¶è¿”å›æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…</div><div class=\"line\">32:  * è¿”å›trueï¼Œå½“æœ‰æ–°æ¶ˆæ¯æ·»åŠ æˆåŠŸæ—¶ï¼Œ</div><div class=\"line\">33:  *</div><div class=\"line\">34:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\">35:  * <span class=\"doctag\">@return</span> æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…</div><div class=\"line\">36:  */</div><div class=\"line\"><span class=\"number\">37</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">putMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"keyword\">boolean</span> dispatchToConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"><span class=\"number\">41</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             <span class=\"comment\">// æ·»åŠ æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"keyword\">int</span> validMsgCnt = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">44</span>:             <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"><span class=\"number\">45</span>:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == old) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:                     validMsgCnt++;</div><div class=\"line\"><span class=\"number\">48</span>:                     <span class=\"keyword\">this</span>.queueOffsetMax = msg.getQueueOffset();</div><div class=\"line\"><span class=\"number\">49</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">50</span>:             &#125;</div><div class=\"line\"><span class=\"number\">51</span>:             msgCount.addAndGet(validMsgCnt);</div><div class=\"line\"><span class=\"number\">52</span>: </div><div class=\"line\"><span class=\"number\">53</span>:             <span class=\"comment\">// è®¡ç®—æ˜¯å¦æ­£åœ¨æ¶ˆè´¹</span></div><div class=\"line\"><span class=\"number\">54</span>:             <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty() &amp;&amp; !<span class=\"keyword\">this</span>.consuming) &#123;</div><div class=\"line\"><span class=\"number\">55</span>:                 dispatchToConsume = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">56</span>:                 <span class=\"keyword\">this</span>.consuming = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">57</span>:             &#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>:             <span class=\"comment\">// Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡</span></div><div class=\"line\"><span class=\"number\">60</span>:             <span class=\"keyword\">if</span> (!msgs.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">61</span>:                 MessageExt messageExt = msgs.get(msgs.size() - <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">62</span>:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);</div><div class=\"line\"><span class=\"number\">63</span>:                 <span class=\"keyword\">if</span> (property != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">64</span>:                     <span class=\"keyword\">long</span> accTotal = Long.parseLong(property) - messageExt.getQueueOffset();</div><div class=\"line\"><span class=\"number\">65</span>:                     <span class=\"keyword\">if</span> (accTotal &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">66</span>:                         <span class=\"keyword\">this</span>.msgAccCnt = accTotal;</div><div class=\"line\"><span class=\"number\">67</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">68</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">69</span>:             &#125;</div><div class=\"line\"><span class=\"number\">70</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">71</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"><span class=\"number\">72</span>:         &#125;</div><div class=\"line\"><span class=\"number\">73</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">74</span>:         log.error(<span class=\"string\">\"putMessage exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">75</span>:     &#125;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"keyword\">return</span> dispatchToConsume;</div><div class=\"line\"><span class=\"number\">78</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h2>æ€»ç»“</h2>\n<p>å¦‚æœç”¨æœ€ç®€å•ç²—æš´çš„æ–¹å¼æè¿° <code>PullConsumer</code> æ‹‰å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œé‚£å°±æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (ä¸æ»¡è¶³æ‹‰å–æ¶ˆæ¯) &#123;</div><div class=\"line\">        Thread.sleep(é—´éš”);</div><div class=\"line\">        <span class=\"keyword\">continue</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h1>6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</h1>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/06.png\" alt=\"DefaultMQPushConsumerImplæ¶ˆè´¹æ¶ˆæ¯\"></p>\n<h2>ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</h2>\n<h3>ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ¶ˆè´¹çº¿ç¨‹æ± é˜Ÿåˆ—</div><div class=\"line\"> 3:  */</div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> BlockingQueue&lt;Runnable&gt; consumeRequestQueue;</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 6:  * æ¶ˆè´¹çº¿ç¨‹æ± </div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadPoolExecutor consumeExecutor;</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">submitConsumeRequest</span><span class=\"params\">(//</span></span></div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs, //</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> ProcessQueue processQueue, //</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">final</span> MessageQueue messageQueue, //</div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> dispatchToConsume) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> consumeBatchSize = <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">if</span> (msgs.size() &lt;= consumeBatchSize) &#123; <span class=\"comment\">// æäº¤æ¶ˆæ¯å°äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">17</span>:         ConsumeRequest consumeRequest = <span class=\"keyword\">new</span> ConsumeRequest(msgs, processQueue, messageQueue);</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">this</span>.consumeExecutor.submit(consumeRequest);</div><div class=\"line\"><span class=\"number\">20</span>:         &#125; <span class=\"keyword\">catch</span> (RejectedExecutionException e) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"keyword\">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class=\"line\"><span class=\"number\">22</span>:         &#125;</div><div class=\"line\"><span class=\"number\">23</span>:     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªæ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> total = <span class=\"number\">0</span>; total &lt; msgs.size(); ) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"comment\">// è®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">26</span>:             List&lt;MessageExt&gt; msgThis = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(consumeBatchSize);</div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; consumeBatchSize; i++, total++) &#123;</div><div class=\"line\"><span class=\"number\">28</span>:                 <span class=\"keyword\">if</span> (total &lt; msgs.size()) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:                     msgThis.add(msgs.get(total));</div><div class=\"line\"><span class=\"number\">30</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">32</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">33</span>:             &#125;</div><div class=\"line\"><span class=\"number\">34</span>: </div><div class=\"line\"><span class=\"number\">35</span>:             <span class=\"comment\">// æäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">36</span>:             ConsumeRequest consumeRequest = <span class=\"keyword\">new</span> ConsumeRequest(msgThis, processQueue, messageQueue);</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"keyword\">this</span>.consumeExecutor.submit(consumeRequest);</div><div class=\"line\"><span class=\"number\">39</span>:             &#125; <span class=\"keyword\">catch</span> (RejectedExecutionException e) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                 <span class=\"comment\">// å¦‚æœè¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯+å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</span></div><div class=\"line\"><span class=\"number\">41</span>:                 <span class=\"keyword\">for</span> (; total &lt; msgs.size(); total++) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:                     msgThis.add(msgs.get(total));</div><div class=\"line\"><span class=\"number\">43</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"keyword\">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class=\"line\"><span class=\"number\">45</span>:             &#125;</div><div class=\"line\"><span class=\"number\">46</span>:         &#125;</div><div class=\"line\"><span class=\"number\">47</span>:     &#125;</div><div class=\"line\"><span class=\"number\">48</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæäº¤<strong>ç«‹å³</strong>æ¶ˆè´¹è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šæäº¤æ¶ˆæ¯å°äºç­‰äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 23 è‡³ 47 è¡Œ ï¼šå½“æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªè¯·æ±‚ã€‚\n<ul>\n<li>ç¬¬ 25 è‡³ 33 è¡Œ ï¼šè®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šæäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæäº¤è¯·æ±‚è¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯ + å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ï¼Œç»“æŸæ‹†åˆ†å¾ªç¯ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3>ConsumeMessageConcurrentlyService#submitConsumeRequestLater</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯åˆ—è¡¨</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> processQueue æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> messageQueue æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">submitConsumeRequestLater</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs, //</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">final</span> ProcessQueue processQueue, //</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">final</span> MessageQueue messageQueue//</div><div class=\"line\"><span class=\"number\">12</span>: ) &#123;</div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">this</span>.scheduledExecutorService.schedule(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">18</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.submitConsumeRequest(msgs, processQueue, messageQueue, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125;, <span class=\"number\">5000</span>, TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">21</span>: &#125;</div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>: <span class=\"comment\">/**</span></div><div class=\"line\">24:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</div><div class=\"line\">25:  * <span class=\"doctag\">@param</span> consumeRequest æ¶ˆè´¹è¯·æ±‚</div><div class=\"line\">26:  */</div><div class=\"line\"><span class=\"number\">27</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">submitConsumeRequestLater</span><span class=\"params\">(<span class=\"keyword\">final</span> ConsumeRequest consumeRequest//</span></span></div><div class=\"line\"><span class=\"number\">28</span>: ) &#123;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">this</span>.scheduledExecutorService.schedule(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">33</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">34</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumeExecutor.submit(consumeRequest); <span class=\"comment\">// TODO BUG ?</span></div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>:     &#125;, <span class=\"number\">5000</span>, TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">37</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 34 è¡Œ ï¼šç›´æ¥è°ƒç”¨ <code>ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);</code>ã€‚å¦‚æœæ¶ˆæ¯æ•°è¶…è¿‡æ‰¹é‡æ¶ˆè´¹ä¸Šé™ï¼Œä¼šä¸ä¼šæ˜¯<strong>BUG</strong>ã€‚</li>\n</ul>\n<h2>ConsumeRequest</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConsumeRequest</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>: </div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  4:      * æ¶ˆè´¹æ¶ˆæ¯åˆ—è¡¨</div><div class=\"line\">  5:      */</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs;</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  8:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\">  9:      */</div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ProcessQueue processQueue;</div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 12:      * æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 13:      */</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MessageQueue messageQueue;</div><div class=\"line\"> <span class=\"number\">15</span>: </div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConsumeRequest</span><span class=\"params\">(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">this</span>.msgs = msgs;</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">this</span>.processQueue = processQueue;</div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"keyword\">this</span>.messageQueue = messageQueue;</div><div class=\"line\"> <span class=\"number\">20</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">21</span>: </div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">23</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">24</span>:         <span class=\"comment\">// åºŸå¼ƒé˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">25</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:             log.info(<span class=\"string\">\"the message queue not be able to consume, because it's dropped. group=&#123;&#125; &#123;&#125;\"</span>, ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumerGroup, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">28</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.messageListener; <span class=\"comment\">// ç›‘å¬å™¨</span></div><div class=\"line\"> <span class=\"number\">31</span>:         ConsumeConcurrentlyContext context = <span class=\"keyword\">new</span> ConsumeConcurrentlyContext(messageQueue); <span class=\"comment\">// æ¶ˆè´¹Context</span></div><div class=\"line\"> <span class=\"number\">32</span>:         ConsumeConcurrentlyStatus status = <span class=\"keyword\">null</span>; <span class=\"comment\">// æ¶ˆè´¹ç»“æœçŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:         <span class=\"comment\">// Hook</span></div><div class=\"line\"> <span class=\"number\">35</span>:         ConsumeMessageContext consumeMessageContext = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">36</span>:         <span class=\"keyword\">if</span> (ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class=\"line\"> <span class=\"number\">37</span>:             consumeMessageContext = <span class=\"keyword\">new</span> ConsumeMessageContext();</div><div class=\"line\"> <span class=\"number\">38</span>:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">39</span>:             consumeMessageContext.setProps(<span class=\"keyword\">new</span> HashMap&lt;String, String&gt;());</div><div class=\"line\"> <span class=\"number\">40</span>:             consumeMessageContext.setMq(messageQueue);</div><div class=\"line\"> <span class=\"number\">41</span>:             consumeMessageContext.setMsgList(msgs);</div><div class=\"line\"> <span class=\"number\">42</span>:             consumeMessageContext.setSuccess(<span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">43</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);</div><div class=\"line\"> <span class=\"number\">44</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">45</span>: </div><div class=\"line\"> <span class=\"number\">46</span>:         <span class=\"keyword\">long</span> beginTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"keyword\">boolean</span> hasException = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">48</span>:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; <span class=\"comment\">// æ¶ˆè´¹è¿”å›ç»“æœç±»å‹</span></div><div class=\"line\"> <span class=\"number\">49</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">50</span>:             <span class=\"comment\">// å½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½®Topicä¸ºåŸå§‹Topic</span></div><div class=\"line\"> <span class=\"number\">51</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.resetRetryTopic(msgs);</div><div class=\"line\"> <span class=\"number\">52</span>: </div><div class=\"line\"> <span class=\"number\">53</span>:             <span class=\"comment\">// è®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´</span></div><div class=\"line\"> <span class=\"number\">54</span>:             <span class=\"keyword\">if</span> (msgs != <span class=\"keyword\">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">55</span>:                 <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));</div><div class=\"line\"> <span class=\"number\">57</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">58</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">59</span>: </div><div class=\"line\"> <span class=\"number\">60</span>:             <span class=\"comment\">// è¿›è¡Œæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">61</span>:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class=\"line\"> <span class=\"number\">62</span>:         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:             log.warn(<span class=\"string\">\"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">64</span>:                 RemotingHelper.exceptionSimpleDesc(e), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">65</span>:                 ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumerGroup,</div><div class=\"line\"> <span class=\"number\">66</span>:                 msgs,</div><div class=\"line\"> <span class=\"number\">67</span>:                 messageQueue);</div><div class=\"line\"> <span class=\"number\">68</span>:             hasException = <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">70</span>: </div><div class=\"line\"> <span class=\"number\">71</span>:         <span class=\"comment\">// è§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</span></div><div class=\"line\"> <span class=\"number\">72</span>:         <span class=\"keyword\">long</span> consumeRT = System.currentTimeMillis() - beginTimestamp;</div><div class=\"line\"> <span class=\"number\">73</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == status) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:             <span class=\"keyword\">if</span> (hasException) &#123;</div><div class=\"line\"> <span class=\"number\">75</span>:                 returnType = ConsumeReturnType.EXCEPTION;</div><div class=\"line\"> <span class=\"number\">76</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">77</span>:                 returnType = ConsumeReturnType.RETURNNULL;</div><div class=\"line\"> <span class=\"number\">78</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">79</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * <span class=\"number\">60</span> * <span class=\"number\">1000</span>) &#123;</div><div class=\"line\"> <span class=\"number\">80</span>:             returnType = ConsumeReturnType.TIME_OUT;</div><div class=\"line\"> <span class=\"number\">81</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) &#123;</div><div class=\"line\"> <span class=\"number\">82</span>:             returnType = ConsumeReturnType.FAILED;</div><div class=\"line\"> <span class=\"number\">83</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) &#123;</div><div class=\"line\"> <span class=\"number\">84</span>:             returnType = ConsumeReturnType.SUCCESS;</div><div class=\"line\"> <span class=\"number\">85</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>: </div><div class=\"line\"> <span class=\"number\">87</span>:         <span class=\"comment\">// Hook</span></div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">if</span> (ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class=\"line\"> <span class=\"number\">89</span>:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());</div><div class=\"line\"> <span class=\"number\">90</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">91</span>: </div><div class=\"line\"> <span class=\"number\">92</span>:         <span class=\"comment\">// æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç©ºæ—¶ï¼Œåˆ™è®¾ç½®ä¸ºç¨åé‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">93</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == status) &#123;</div><div class=\"line\"> <span class=\"number\">94</span>:             log.warn(<span class=\"string\">\"consumeMessage return null, Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">95</span>:                 ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumerGroup,</div><div class=\"line\"> <span class=\"number\">96</span>:                 msgs,</div><div class=\"line\"> <span class=\"number\">97</span>:                 messageQueue);</div><div class=\"line\"> <span class=\"number\">98</span>:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;</div><div class=\"line\"> <span class=\"number\">99</span>:         &#125;</div><div class=\"line\"><span class=\"number\">100</span>: </div><div class=\"line\"><span class=\"number\">101</span>:         <span class=\"comment\">// Hook</span></div><div class=\"line\"><span class=\"number\">102</span>:         <span class=\"keyword\">if</span> (ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class=\"line\"><span class=\"number\">103</span>:             consumeMessageContext.setStatus(status.toString());</div><div class=\"line\"><span class=\"number\">104</span>:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);</div><div class=\"line\"><span class=\"number\">105</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);</div><div class=\"line\"><span class=\"number\">106</span>:         &#125;</div><div class=\"line\"><span class=\"number\">107</span>: </div><div class=\"line\"><span class=\"number\">108</span>:         <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"><span class=\"number\">109</span>:         ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.getConsumerStatsManager()</div><div class=\"line\"><span class=\"number\">110</span>:             .incConsumeRT(ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class=\"line\"><span class=\"number\">111</span>: </div><div class=\"line\"><span class=\"number\">112</span>:         <span class=\"comment\">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></div><div class=\"line\"><span class=\"number\">113</span>:         <span class=\"keyword\">if</span> (!processQueue.isDropped()) &#123;</div><div class=\"line\"><span class=\"number\">114</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.processConsumeResult(status, context, <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">115</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">116</span>:             log.warn(<span class=\"string\">\"processQueue is dropped without process consume result. messageQueue=&#123;&#125;, msgs=&#123;&#125;\"</span>, messageQueue, msgs);</div><div class=\"line\"><span class=\"number\">117</span>:         &#125;</div><div class=\"line\"><span class=\"number\">118</span>:     &#125;</div><div class=\"line\"><span class=\"number\">119</span>: </div><div class=\"line\"><span class=\"number\">120</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ¶ˆè´¹è¯·æ±‚ã€‚æäº¤è¯·æ±‚æ‰§è¡Œæ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 24 è‡³ 28 è¡Œ ï¼šåºŸå¼ƒå¤„ç†é˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 34 è‡³ 44 è¡Œ ï¼šHookã€‚</li>\n<li>ç¬¬ 51 è¡Œ ï¼šå½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½® <code>Topic</code>ä¸ºåŸå§‹ <code>Topic</code>ã€‚ä¾‹å¦‚ï¼šåŸå§‹ <code>Topic</code> ä¸º <code>TopicTest</code>ï¼Œé‡è¯•æ—¶ <code>Topic</code> ä¸º <code>%RETRY%please_rename_unique_group_name_4</code>ï¼Œç»è¿‡è¯¥æ–¹æ³•ï¼Œ<code>Topic</code> è®¾ç½®å› <code>TopicTest</code>ã€‚</li>\n<li>ç¬¬ 53 è‡³ 58 è¡Œ ï¼šè®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´ã€‚</li>\n<li>ç¬¬ 61 è¡Œ ï¼š<strong>è¿›è¡Œæ¶ˆè´¹</strong>ã€‚</li>\n<li>ç¬¬ 71 è‡³ 85 è¡Œ ï¼šè§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</li>\n<li>ç¬¬ 87 è‡³ 90 è¡Œ ï¼š<code>Hook</code>ã€‚</li>\n<li>ç¬¬ 92 è‡³ 99 è¡Œ ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€æœªç©ºæ—¶ï¼Œåˆ™è®¾ç½®æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç¨åæ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 101 è‡³ 106 è¡Œ ï¼š<code>Hook</code>ã€‚</li>\n<li>ç¬¬ 108 è‡³ 110 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>\n<li>ç¬¬ 112 è‡³ 117 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚<strong>å¦‚æœæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—è¢«ç§»é™¤ï¼Œæ°å¥½æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#consumemessageconcurrentlyserviceprocessconsumeresult\">ConsumeMessageConcurrentlyService#processConsumeResult(...)</a>ã€‚</li>\n</ul>\n<h2>ConsumeMessageConcurrentlyService#processConsumeResult(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processConsumeResult</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">final</span> ConsumeConcurrentlyStatus status, //</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> ConsumeConcurrentlyContext context, //</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> ConsumeRequest consumeRequest//</div><div class=\"line\"> <span class=\"number\">5</span>: ) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">int</span> ackIndex = context.getAckIndex();</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"comment\">// æ¶ˆæ¯ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (consumeRequest.getMsgs().isEmpty())</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"comment\">// è®¡ç®—ä»consumeRequest.msgs[0]åˆ°consumeRequest.msgs[ackIndex]çš„æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ</span></div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">switch</span> (status) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">case</span> CONSUME_SUCCESS:</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">if</span> (ackIndex &gt;= consumeRequest.getMsgs().size()) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                 ackIndex = consumeRequest.getMsgs().size() - <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">17</span>:             &#125;</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"comment\">// ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡</span></div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">int</span> ok = ackIndex + <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">int</span> failed = consumeRequest.getMsgs().size() - ok;</div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">case</span> RECONSUME_LATER:</div><div class=\"line\"><span class=\"number\">25</span>:             ackIndex = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">26</span>:             <span class=\"comment\">// ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡</span></div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),</div><div class=\"line\"><span class=\"number\">28</span>:                 consumeRequest.getMsgs().size());</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">32</span>:     &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">// å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"keyword\">switch</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">case</span> BROADCASTING: <span class=\"comment\">// å¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ°Brokerï¼Œåªæ‰“å°Log</span></div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = ackIndex + <span class=\"number\">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class=\"line\"><span class=\"number\">39</span>:                 log.warn(<span class=\"string\">\"BROADCASTING, the message consume failed, drop it, &#123;&#125;\"</span>, msg.toString());</div><div class=\"line\"><span class=\"number\">40</span>:             &#125;</div><div class=\"line\"><span class=\"number\">41</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">case</span> CLUSTERING:</div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"comment\">// å‘å›æ¶ˆæ¯å¤±è´¥åˆ°Brokerã€‚</span></div><div class=\"line\"><span class=\"number\">44</span>:             List&lt;MessageExt&gt; msgBackFailed = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(consumeRequest.getMsgs().size());</div><div class=\"line\"><span class=\"number\">45</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = ackIndex + <span class=\"number\">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">46</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class=\"line\"><span class=\"number\">47</span>:                 <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">this</span>.sendMessageBack(msg, context);</div><div class=\"line\"><span class=\"number\">48</span>:                 <span class=\"keyword\">if</span> (!result) &#123;</div><div class=\"line\"><span class=\"number\">49</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">50</span>:                     msgBackFailed.add(msg);</div><div class=\"line\"><span class=\"number\">51</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">52</span>:             &#125;</div><div class=\"line\"><span class=\"number\">53</span>: </div><div class=\"line\"><span class=\"number\">54</span>:             <span class=\"comment\">// å‘å›Brokerå¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"><span class=\"number\">55</span>:             <span class=\"keyword\">if</span> (!msgBackFailed.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">56</span>:                 consumeRequest.getMsgs().removeAll(msgBackFailed);</div><div class=\"line\"><span class=\"number\">57</span>: </div><div class=\"line\"><span class=\"number\">58</span>:                 <span class=\"keyword\">this</span>.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());</div><div class=\"line\"><span class=\"number\">59</span>:             &#125;</div><div class=\"line\"><span class=\"number\">60</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">61</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">62</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">63</span>:     &#125;</div><div class=\"line\"><span class=\"number\">64</span>: </div><div class=\"line\"><span class=\"number\">65</span>:     <span class=\"comment\">// ç§»é™¤æ¶ˆè´¹æˆåŠŸæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">66</span>:     <span class=\"keyword\">long</span> offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());</div><div class=\"line\"><span class=\"number\">67</span>:     <span class=\"keyword\">if</span> (offset &gt;= <span class=\"number\">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class=\"line\"><span class=\"number\">68</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">69</span>:     &#125;</div><div class=\"line\"><span class=\"number\">70</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>\n<li>ç¬¬ 8 è‡³ 10 è¡Œ ï¼šæ¶ˆè´¹è¯·æ±‚æ¶ˆæ¯æœªç©ºæ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li>\n<li>ç¬¬ 12 è‡³ 32 è¡Œ ï¼šè®¡ç®— <code>ackIndex</code> å€¼ã€‚<code>consumeRequest.msgs[0 - ackIndex]</code>ä¸ºæ¶ˆè´¹æˆåŠŸï¼Œéœ€è¦è¿›è¡Œ <code>ack</code> ç¡®è®¤ã€‚\n<ul>\n<li>ç¬¬ 14 è‡³ 23 è¡Œ ï¼š<code>CONSUME_SUCCESS</code> ï¼š<code>ackIndex = context.getAckIndex()</code>ã€‚</li>\n<li>ç¬¬ 24 è‡³ 29 è¡Œ ï¼š<code>RECONSUME_LATER</code> ï¼š<code>ackIndex = -1</code>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬34 è‡³ 63 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ã€‚\n<ul>\n<li>ç¬¬ 36 è‡³ 41 è¡Œ ï¼š<code>BROADCASTING</code> ï¼šå¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ° <code>Broker</code>ï¼Œåªæ‰“å°æ—¥å¿—ã€‚</li>\n<li>ç¬¬ 42 è‡³ 60 è¡Œ ï¼š<code>CLUSTERING</code> ï¼šé›†ç¾¤æ¨¡å¼ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code>ã€‚\n<ul>\n<li>ç¬¬ 43 è‡³ 52 è¡Œ ï¼šå‘å›æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯åˆ° <code>Broker</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#defaultmqpushconsumerimplsendmessageback\">DefaultMQPushConsumerImpl#sendMessageBack(...)</a>ã€‚</li>\n<li>ç¬¬ 54 è‡³ 59 è¡Œ ï¼šå‘å› <code>Broker</code> å¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹ã€‚</li>\n<li><strong>å¦‚æœå‘å› <code>Broker</code> æˆåŠŸï¼Œç»“æœå› ä¸ºä¾‹å¦‚ç½‘ç»œå¼‚å¸¸ï¼Œå¯¼è‡´ <code>Consumer</code>ä»¥ä¸ºå‘å›å¤±è´¥ï¼Œåˆ¤å®šæ¶ˆè´¹å‘å›å¤±è´¥ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§ã€‚</strong></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ç¬¬ 65 è‡³ 69 è¡Œ ï¼šç§»é™¤**ã€æ¶ˆè´¹æˆåŠŸã€‘<strong>å’Œ</strong>ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘**çš„æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦ã€‚\n<ul>\n<li>ä¸ºä»€ä¹ˆä¼šæœ‰**ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘<strong>çš„æ¶ˆæ¯ï¼Ÿè§</strong>ç¬¬ 56 è¡Œ**ã€‚</li>\n<li><a href=\"#processqueueremovemessage\">ProcessQueue#removeMessage(...)</a></li>\n</ul>\n</li>\n</ul>\n<h3>ProcessQueue#removeMessage(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * ç§»é™¤æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç¬¬ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\"> 5:  * <span class=\"doctag\">@return</span> æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class=\"line\"> 6:  */</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">removeMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">long</span> result = -<span class=\"number\">1</span>;</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">this</span>.lastConsumeTimestamp = now;</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 result = <span class=\"keyword\">this</span>.queueOffsetMax + <span class=\"number\">1</span>; <span class=\"comment\">// è¿™é‡Œ+1çš„åŸå› æ˜¯ï¼šå¦‚æœmsgTreeMapä¸ºç©ºæ—¶ï¼Œä¸‹ä¸€æ¡è·å¾—çš„æ¶ˆæ¯ä½ç½®ä¸ºqueueOffsetMax+1</span></div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// ç§»é™¤æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"keyword\">int</span> removedCnt = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());</div><div class=\"line\"><span class=\"number\">21</span>:                     <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                         removedCnt--;</div><div class=\"line\"><span class=\"number\">23</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">24</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">25</span>:                 msgCount.addAndGet(removedCnt);</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:                 <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">28</span>:                     result = msgTreeMap.firstKey();</div><div class=\"line\"><span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">30</span>:             &#125;</div><div class=\"line\"><span class=\"number\">31</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:     &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:         log.error(<span class=\"string\">\"removeMessage exception\"</span>, t);</div><div class=\"line\"><span class=\"number\">36</span>:     &#125;</div><div class=\"line\"><span class=\"number\">37</span>: </div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">39</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h2>ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">this</span>.cleanExpireMsgExecutors.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:             cleanExpireMsg();</div><div class=\"line\"> <span class=\"number\">7</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:     &#125;, <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeTimeout(), <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);</div><div class=\"line\"><span class=\"number\">10</span>: &#125;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"comment\">/**</span></div><div class=\"line\">13:  * æ¸…ç†è¿‡æœŸæ¶ˆæ¯</div><div class=\"line\">14:  */</div><div class=\"line\"><span class=\"number\">15</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">cleanExpireMsg</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:     Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it =</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">while</span> (it.hasNext()) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:         Map.Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class=\"line\"><span class=\"number\">20</span>:         ProcessQueue pq = next.getValue();</div><div class=\"line\"><span class=\"number\">21</span>:         pq.cleanExpiredMsg(<span class=\"keyword\">this</span>.defaultMQPushConsumer);</div><div class=\"line\"><span class=\"number\">22</span>:     &#125;</div><div class=\"line\"><span class=\"number\">23</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå®šæ—¶æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼Œé»˜è®¤å‘¨æœŸï¼š15minã€‚</li>\n</ul>\n<h3>ProcessQueue#cleanExpiredMsg(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">cleanExpiredMsg</span><span class=\"params\">(DefaultMQPushConsumer pushConsumer)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">// é¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›</span></div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">5</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">// å¾ªç¯ç§»é™¤æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">int</span> loop = msgTreeMap.size() &lt; <span class=\"number\">16</span> ? msgTreeMap.size() : <span class=\"number\">16</span>; <span class=\"comment\">// æ¯æ¬¡å¾ªç¯æœ€å¤šç§»é™¤16æ¡</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; loop; i++) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"comment\">// è·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯</span></div><div class=\"line\"><span class=\"number\">11</span>:         MessageExt msg = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">this</span>.lockTreeMap.readLock().lockInterruptibly();</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty() &amp;&amp; System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) &gt; pushConsumer.getConsumeTimeout() * <span class=\"number\">60</span> * <span class=\"number\">1000</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                     msg = msgTreeMap.firstEntry().getValue();</div><div class=\"line\"><span class=\"number\">17</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">18</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">19</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">20</span>:             &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                 <span class=\"keyword\">this</span>.lockTreeMap.readLock().unlock();</div><div class=\"line\"><span class=\"number\">22</span>:             &#125;</div><div class=\"line\"><span class=\"number\">23</span>:         &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:             log.error(<span class=\"string\">\"getExpiredMsg exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"comment\">// å‘å›è¶…æ—¶æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">29</span>:             pushConsumer.sendMessageBack(msg, <span class=\"number\">3</span>);</div><div class=\"line\"><span class=\"number\">30</span>:             log.info(<span class=\"string\">\"send expire msg back. topic=&#123;&#125;, msgId=&#123;&#125;, storeHost=&#123;&#125;, queueId=&#123;&#125;, queueOffset=&#123;&#125;\"</span>, msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"comment\">// åˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤</span></div><div class=\"line\"><span class=\"number\">33</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">34</span>:                 <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"><span class=\"number\">35</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">36</span>:                     <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey()) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:                         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                             msgTreeMap.remove(msgTreeMap.firstKey());</div><div class=\"line\"><span class=\"number\">39</span>:                         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                             log.error(<span class=\"string\">\"send expired msg exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">41</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">42</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">43</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">44</span>:                     <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"><span class=\"number\">45</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">46</span>:             &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:                 log.error(<span class=\"string\">\"getExpiredMsg exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">48</span>:             &#125;</div><div class=\"line\"><span class=\"number\">49</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">50</span>:             log.error(<span class=\"string\">\"send expired msg exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">51</span>:         &#125;</div><div class=\"line\"><span class=\"number\">52</span>:     &#125;</div><div class=\"line\"><span class=\"number\">53</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šç§»é™¤è¿‡æœŸæ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 2 è‡³ 5 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li>\n<li>ç¬¬ 7 è‡³ 9 è¡Œ ï¼šå¾ªç¯ç§»é™¤æ¶ˆæ¯ã€‚é»˜è®¤æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼š16æ¬¡ã€‚</li>\n<li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šè·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚</li>\n<li>ç¬¬ 29 è¡Œ ï¼š<strong>å‘å›è¶…æ—¶æ¶ˆæ¯åˆ°<code>Broker</code></strong>ã€‚</li>\n<li>ç¬¬ 32 è‡³ 48 è¡Œ ï¼šåˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤ã€‚</li>\n</ul>\n<h1>7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</h1>\n<h2>DefaultMQPushConsumerImpl#sendMessageBack(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendMessageBack</span><span class=\"params\">(MessageExt msg, <span class=\"keyword\">int</span> delayLevel, <span class=\"keyword\">final</span> String brokerName)</span></span></div><div class=\"line\"> 2:     <span class=\"keyword\">throws</span> RemotingException, MQBrokerException, InterruptedException, MQClientException &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"comment\">// Consumerå‘å›æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">5</span>:         String brokerAddr = (<span class=\"keyword\">null</span> != brokerName) ? <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInPublish(brokerName)</div><div class=\"line\"> <span class=\"number\">6</span>:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup(), delayLevel, <span class=\"number\">5000</span>, getMaxReconsumeTimes());</div><div class=\"line\"> <span class=\"number\">9</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123; <span class=\"comment\">// TODO ç–‘é—®ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"comment\">// å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨Clientå†…ç½®Producerå‘å›æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">11</span>:         log.error(<span class=\"string\">\"sendMessageBack Exception, \"</span> + <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup(), e);</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:         Message newMsg = <span class=\"keyword\">new</span> Message(MixAll.getRetryTopic(<span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class=\"line\"><span class=\"number\">16</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:         newMsg.setFlag(msg.getFlag());</div><div class=\"line\"><span class=\"number\">19</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class=\"line\"><span class=\"number\">20</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class=\"line\"><span class=\"number\">21</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + <span class=\"number\">1</span>));</div><div class=\"line\"><span class=\"number\">22</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class=\"line\"><span class=\"number\">23</span>:         newMsg.setDelayTimeLevel(<span class=\"number\">3</span> + msg.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">24</span>: </div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">this</span>.mQClientFactory.getDefaultMQProducer().send(newMsg);</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå‘å›æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 4 è‡³ 8 è¡Œ ï¼š<code>Consumer</code> å‘å›æ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#mqclientapiimplconsumersendmessageback\">MQClientAPIImpl#consumerSendMessageBack(...)</a>ã€‚</li>\n<li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ<code>Consumer</code> å†…ç½®é»˜è®¤ <code>Producer</code> å‘é€æ¶ˆæ¯ã€‚\n<ul>\n<li>ğŸ˜ˆç–‘é—®ï¼šä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸å‘¢ï¼Ÿ</li>\n</ul>\n</li>\n</ul>\n<h3>MQClientAPIImpl#consumerSendMessageBack(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * Consumerå‘å›æ¶ˆæ¯</div><div class=\"line\"> 3:  * <span class=\"doctag\">@param</span> addr Brokeråœ°å€</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> consumerGroup æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> timeoutMillis è¶…æ—¶</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> maxConsumeRetryTimes æ¶ˆè´¹æœ€å¤§é‡è¯•æ¬¡æ•°</div><div class=\"line\"> 9:  * <span class=\"doctag\">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">10:  * <span class=\"doctag\">@throws</span> MQBrokerException å½“Brokerå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">11:  * <span class=\"doctag\">@throws</span> InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶</div><div class=\"line\">12:  */</div><div class=\"line\"><span class=\"number\">13</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">consumerSendMessageBack</span><span class=\"params\">(</span></span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">final</span> String addr,</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">final</span> MessageExt msg,</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">final</span> String consumerGroup,</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> delayLevel,</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeoutMillis,</div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxConsumeRetryTimes</div><div class=\"line\"><span class=\"number\">20</span>: ) <span class=\"keyword\">throws</span> RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"><span class=\"number\">21</span>:     ConsumerSendMsgBackRequestHeader requestHeader = <span class=\"keyword\">new</span> ConsumerSendMsgBackRequestHeader();</div><div class=\"line\"><span class=\"number\">22</span>:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:     requestHeader.setGroup(consumerGroup);</div><div class=\"line\"><span class=\"number\">25</span>:     requestHeader.setOriginTopic(msg.getTopic());</div><div class=\"line\"><span class=\"number\">26</span>:     requestHeader.setOffset(msg.getCommitLogOffset());</div><div class=\"line\"><span class=\"number\">27</span>:     requestHeader.setDelayLevel(delayLevel);</div><div class=\"line\"><span class=\"number\">28</span>:     requestHeader.setOriginMsgId(msg.getMsgId());</div><div class=\"line\"><span class=\"number\">29</span>:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:     RemotingCommand response = <span class=\"keyword\">this</span>.remotingClient.invokeSync(MixAll.brokerVIPChannel(<span class=\"keyword\">this</span>.clientConfig.isVipChannelEnabled(), addr),</div><div class=\"line\"><span class=\"number\">32</span>:         request, timeoutMillis);</div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"keyword\">assert</span> response != <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"keyword\">switch</span> (response.getCode()) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">case</span> ResponseCode.SUCCESS: &#123;</div><div class=\"line\"><span class=\"number\">36</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">37</span>:         &#125;</div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">39</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQBrokerException(response.getCode(), response.getRemark());</div><div class=\"line\"><span class=\"number\">43</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h1>8ã€Consumer æ¶ˆè´¹è¿›åº¦</h1>\n<h2>OffsetStore</h2>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/07.png\" alt=\"OffsetStoreç±»å›¾.png\"></p>\n<ul>\n<li><code>RemoteBrokerOffsetStore</code> ï¼š<code>Consumer</code> <strong>é›†ç¾¤æ¨¡å¼</strong> ä¸‹ï¼Œä½¿ç”¨è¿œç¨‹ <code>Broker</code> æ¶ˆè´¹è¿›åº¦ã€‚</li>\n<li><code>LocalFileOffsetStore</code> ï¼š<code>Consumer</code> <strong>å¹¿æ’­æ¨¡å¼</strong>ä¸‹ï¼Œä½¿ç”¨æœ¬åœ° <code>æ–‡ä»¶</code> æ¶ˆè´¹è¿›åº¦ã€‚</li>\n</ul>\n<h3>OffsetStore#load(...)</h3>\n<h4>LocalFileOffsetStore#load(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">load</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// ä»æœ¬åœ°ç¡¬ç›˜è¯»å–æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">4</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class=\"keyword\">this</span>.readLocalOffset();</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (offsetSerializeWrapper != <span class=\"keyword\">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"comment\">// æ‰“å°æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">for</span> (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class=\"line\"><span class=\"number\">11</span>:             log.info(<span class=\"string\">\"load consumer's offset, &#123;&#125; &#123;&#125; &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">12</span>:                 <span class=\"keyword\">this</span>.groupName,</div><div class=\"line\"><span class=\"number\">13</span>:                 mq,</div><div class=\"line\"><span class=\"number\">14</span>:                 offset.get());</div><div class=\"line\"><span class=\"number\">15</span>:         &#125;</div><div class=\"line\"><span class=\"number\">16</span>:     &#125;</div><div class=\"line\"><span class=\"number\">17</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ¶ˆè´¹è¿›åº¦åˆ°å†…å­˜ã€‚</li>\n</ul>\n<h5>OffsetSerializeWrapper</h5>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OffsetSerializeWrapper</span> <span class=\"keyword\">extends</span> <span class=\"title\">RemotingSerializable</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable =</div><div class=\"line\"> <span class=\"number\">3</span>:             <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; <span class=\"title\">getOffsetTable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">return</span> offsetTable;</div><div class=\"line\"> <span class=\"number\">7</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setOffsetTable</span><span class=\"params\">(ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">this</span>.offsetTable = offsetTable;</div><div class=\"line\"><span class=\"number\">11</span>:     &#125;</div><div class=\"line\"><span class=\"number\">12</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæœ¬åœ° <code>Offset</code> å­˜å‚¨åºåˆ—åŒ–ã€‚</li>\n</ul>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><div class=\"line\">Yunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json</div><div class=\"line\">&#123;</div><div class=\"line\">\t<span class=\"string\">\"offsetTable\"</span>:&#123;&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"brokerName\"</span>:<span class=\"string\">\"broker-a\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"queueId\"</span>:3,</div><div class=\"line\">\t\t\t<span class=\"string\">\"topic\"</span>:<span class=\"string\">\"TopicTest\"</span></div><div class=\"line\">\t\t&#125;:1470,&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"brokerName\"</span>:<span class=\"string\">\"broker-a\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"queueId\"</span>:2,</div><div class=\"line\">\t\t\t<span class=\"string\">\"topic\"</span>:<span class=\"string\">\"TopicTest\"</span></div><div class=\"line\">\t\t&#125;:1471,&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"brokerName\"</span>:<span class=\"string\">\"broker-a\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"queueId\"</span>:1,</div><div class=\"line\">\t\t\t<span class=\"string\">\"topic\"</span>:<span class=\"string\">\"TopicTest\"</span></div><div class=\"line\">\t\t&#125;:1470,&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"brokerName\"</span>:<span class=\"string\">\"broker-a\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"queueId\"</span>:0,</div><div class=\"line\">\t\t\t<span class=\"string\">\"topic\"</span>:<span class=\"string\">\"TopicTest\"</span></div><div class=\"line\">\t\t&#125;:1470</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h4>RemoteBrokerOffsetStore#load(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">load</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">3</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šä¸è¿›è¡ŒåŠ è½½ï¼Œå®é™…è¯»å–æ¶ˆè´¹è¿›åº¦æ—¶ï¼Œä» <code>Broker</code> è·å–ã€‚</li>\n</ul>\n<h3>OffsetStore#readOffset(...)</h3>\n<p>è¯»å–æ¶ˆè´¹è¿›åº¦ç±»å‹ï¼š</p>\n<ul>\n<li><code>READ_FROM_MEMORY</code> ï¼šä»å†…å­˜è¯»å–ã€‚</li>\n<li><code>READ_FROM_STORE</code> ï¼šä»å­˜å‚¨( <code>Broker</code> æˆ– <code>æ–‡ä»¶</code> )è¯»å–ã€‚</li>\n<li><code>MEMORY_FIRST_THEN_STORE</code> ï¼šä¼˜å…ˆä»å†…å­˜è¯»å–ï¼Œè¯»å–ä¸åˆ°ï¼Œä»å­˜å‚¨è¯»å–ã€‚</li>\n</ul>\n<h4>LocalFileOffsetStore#readOffset(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">readOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq, <span class=\"keyword\">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (mq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">switch</span> (type) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">case</span> MEMORY_FIRST_THEN_STORE:</div><div class=\"line\"> <span class=\"number\">6</span>:             <span class=\"keyword\">case</span> READ_FROM_MEMORY: &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:                 AtomicLong offset = <span class=\"keyword\">this</span>.offsetTable.get(mq);</div><div class=\"line\"> <span class=\"number\">8</span>:                 <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:                     <span class=\"keyword\">return</span> offset.get();</div><div class=\"line\"><span class=\"number\">10</span>:                 &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">12</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">13</span>:             &#125;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">case</span> READ_FROM_STORE: &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 OffsetSerializeWrapper offsetSerializeWrapper;</div><div class=\"line\"><span class=\"number\">16</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                     offsetSerializeWrapper = <span class=\"keyword\">this</span>.readLocalOffset();</div><div class=\"line\"><span class=\"number\">18</span>:                 &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">20</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">21</span>:                 <span class=\"keyword\">if</span> (offsetSerializeWrapper != <span class=\"keyword\">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class=\"line\"><span class=\"number\">23</span>:                     <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                         <span class=\"keyword\">this</span>.updateOffset(mq, offset.get(), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">25</span>:                         <span class=\"keyword\">return</span> offset.get();</div><div class=\"line\"><span class=\"number\">26</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">27</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">28</span>:             &#125;</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">31</span>:         &#125;</div><div class=\"line\"><span class=\"number\">32</span>:     &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">35</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>ç¬¬ 16 è¡Œ ï¼šä» <code>æ–‡ä»¶</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li>\n</ul>\n<h4>RemoteBrokerOffsetStore#readOffset(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">readOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq, <span class=\"keyword\">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (mq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">switch</span> (type) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">case</span> MEMORY_FIRST_THEN_STORE:</div><div class=\"line\"> <span class=\"number\">6</span>:             <span class=\"keyword\">case</span> READ_FROM_MEMORY: &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:                 AtomicLong offset = <span class=\"keyword\">this</span>.offsetTable.get(mq);</div><div class=\"line\"> <span class=\"number\">8</span>:                 <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:                     <span class=\"keyword\">return</span> offset.get();</div><div class=\"line\"><span class=\"number\">10</span>:                 &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">12</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">13</span>:             &#125;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">case</span> READ_FROM_STORE: &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                     <span class=\"keyword\">long</span> brokerOffset = <span class=\"keyword\">this</span>.fetchConsumeOffsetFromBroker(mq);</div><div class=\"line\"><span class=\"number\">17</span>:                     AtomicLong offset = <span class=\"keyword\">new</span> AtomicLong(brokerOffset);</div><div class=\"line\"><span class=\"number\">18</span>:                     <span class=\"keyword\">this</span>.updateOffset(mq, offset.get(), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">19</span>:                     <span class=\"keyword\">return</span> brokerOffset;</div><div class=\"line\"><span class=\"number\">20</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">21</span>:                 <span class=\"comment\">// No offset in broker</span></div><div class=\"line\"><span class=\"number\">22</span>:                 <span class=\"keyword\">catch</span> (MQBrokerException e) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">24</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"comment\">//Other exceptions</span></div><div class=\"line\"><span class=\"number\">26</span>:                 <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:                     log.warn(<span class=\"string\">\"fetchConsumeOffsetFromBroker exception, \"</span> + mq, e);</div><div class=\"line\"><span class=\"number\">28</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">2</span>;</div><div class=\"line\"><span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">30</span>:             &#125;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:     &#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">37</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>ç¬¬ 16 è¡Œ ï¼šä» <code>Broker</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li>\n</ul>\n<h3>OffsetStore#updateOffset(...)</h3>\n<p>è¯¥æ–¹æ³• <code>RemoteBrokerOffsetStore</code> ä¸ <code>LocalFileOffsetStore</code> å®ç°ç›¸åŒã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updateOffset</span><span class=\"params\">(MessageQueue mq, <span class=\"keyword\">long</span> offset, <span class=\"keyword\">boolean</span> increaseOnly)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (mq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         AtomicLong offsetOld = <span class=\"keyword\">this</span>.offsetTable.get(mq);</div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == offsetOld) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:             offsetOld = <span class=\"keyword\">this</span>.offsetTable.putIfAbsent(mq, <span class=\"keyword\">new</span> AtomicLong(offset));</div><div class=\"line\"> <span class=\"number\">7</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != offsetOld) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">if</span> (increaseOnly) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);</div><div class=\"line\"><span class=\"number\">12</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 offsetOld.set(offset);</div><div class=\"line\"><span class=\"number\">14</span>:             &#125;</div><div class=\"line\"><span class=\"number\">15</span>:         &#125;</div><div class=\"line\"><span class=\"number\">16</span>:     &#125;</div><div class=\"line\"><span class=\"number\">17</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>OffsetStore#persistAll(...)</h3>\n<h4>LocalFileOffsetStore#persistAll(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">persistAll</span><span class=\"params\">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mqs || mqs.isEmpty())</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">5</span>: </div><div class=\"line\"> <span class=\"number\">6</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class=\"keyword\">new</span> OffsetSerializeWrapper();</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class=\"keyword\">this</span>.offsetTable.entrySet()) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">if</span> (mqs.contains(entry.getKey())) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             AtomicLong offset = entry.getValue();</div><div class=\"line\"><span class=\"number\">10</span>:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);</div><div class=\"line\"><span class=\"number\">11</span>:         &#125;</div><div class=\"line\"><span class=\"number\">12</span>:     &#125;</div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:     String jsonString = offsetSerializeWrapper.toJson(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (jsonString != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">17</span>:             MixAll.string2File(jsonString, <span class=\"keyword\">this</span>.storePath);</div><div class=\"line\"><span class=\"number\">18</span>:         &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             log.error(<span class=\"string\">\"persistAll consumer offset Exception, \"</span> + <span class=\"keyword\">this</span>.storePath, e);</div><div class=\"line\"><span class=\"number\">20</span>:         &#125;</div><div class=\"line\"><span class=\"number\">21</span>:     &#125;</div><div class=\"line\"><span class=\"number\">22</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ã€‚<strong>å°†æ¶ˆè´¹è¿›åº¦å†™å…¥æ–‡ä»¶</strong>ã€‚</li>\n</ul>\n<h4>RemoteBrokerOffsetStore#persistAll(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">persistAll</span><span class=\"params\">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mqs || mqs.isEmpty())</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">5</span>: </div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">// æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">final</span> HashSet&lt;MessageQueue&gt; unusedMQ = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">if</span> (!mqs.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class=\"keyword\">this</span>.offsetTable.entrySet()) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             MessageQueue mq = entry.getKey();</div><div class=\"line\"><span class=\"number\">11</span>:             AtomicLong offset = entry.getValue();</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">if</span> (mqs.contains(mq)) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                         <span class=\"keyword\">this</span>.updateConsumeOffsetToBroker(mq, offset.get());</div><div class=\"line\"><span class=\"number\">16</span>:                         log.info(<span class=\"string\">\"[persistAll] Group: &#123;&#125; ClientId: &#123;&#125; updateConsumeOffsetToBroker &#123;&#125; &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">17</span>:                             <span class=\"keyword\">this</span>.groupName,</div><div class=\"line\"><span class=\"number\">18</span>:                             <span class=\"keyword\">this</span>.mQClientFactory.getClientId(),</div><div class=\"line\"><span class=\"number\">19</span>:                             mq,</div><div class=\"line\"><span class=\"number\">20</span>:                             offset.get());</div><div class=\"line\"><span class=\"number\">21</span>:                     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                         log.error(<span class=\"string\">\"updateConsumeOffsetToBroker exception, \"</span> + mq.toString(), e);</div><div class=\"line\"><span class=\"number\">23</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">24</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">25</span>:                     unusedMQ.add(mq);</div><div class=\"line\"><span class=\"number\">26</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>:     &#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"comment\">// ç§»é™¤ä¸é€‚ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"keyword\">if</span> (!unusedMQ.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:         <span class=\"keyword\">for</span> (MessageQueue mq : unusedMQ) &#123;</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">this</span>.offsetTable.remove(mq);</div><div class=\"line\"><span class=\"number\">35</span>:             log.info(<span class=\"string\">\"remove unused mq, &#123;&#125;, &#123;&#125;\"</span>, mq, <span class=\"keyword\">this</span>.groupName);</div><div class=\"line\"><span class=\"number\">36</span>:         &#125;</div><div class=\"line\"><span class=\"number\">37</span>:     &#125;</div><div class=\"line\"><span class=\"number\">38</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæŒä¹…åŒ–æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„çš„æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ï¼Œå¹¶ç§»é™¤éæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n<h4>MQClientInstance#persistAllConsumerOffset(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">startScheduledTask</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">// å®šæ—¶åŒæ­¥æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">7</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:                 MQClientInstance.<span class=\"keyword\">this</span>.cleanOfflineBroker();</div><div class=\"line\"> <span class=\"number\">9</span>:                 MQClientInstance.<span class=\"keyword\">this</span>.sendHeartbeatToAllBrokerWithLock();</div><div class=\"line\"><span class=\"number\">10</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                 log.error(<span class=\"string\">\"ScheduledTask sendHeartbeatToAllBroker exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">12</span>:             &#125;</div><div class=\"line\"><span class=\"number\">13</span>:         &#125;</div><div class=\"line\"><span class=\"number\">14</span>:     &#125;, <span class=\"number\">1000</span>, <span class=\"keyword\">this</span>.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">15</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå®šæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œé»˜è®¤å‘¨æœŸï¼š5000msã€‚</li>\n<li><strong>é‡è¦è¯´æ˜ ï¼š</strong>\n<ul>\n<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>\n<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>\n<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>\n</ul>\n</li>\n</ul>\n<h1>9ã€ç»“å°¾</h1>\n<p>ğŸ˜ˆå¯èƒ½æ˜¯æœ¬ç³»åˆ—æœ€é•¿çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœ‰è¡¨è¾¾é”™è¯¯å’Œä¸æ¸…æ™°ï¼Œè¯·å¤šå¤šè§è°…ã€‚<br>\næ„Ÿè°¢å¯¹æœ¬ç³»åˆ—çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯ç¿»åˆ°ç»“å°¾ã€‚ğŸ˜œçœŸçš„æœ‰ä¸¢ä¸¢é•¿ã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>åŸæ–‡åœ°å€ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-second/\">http://www.yunai.me/RocketMQ/message-pull-and-consume-second/</a><br>\n<code>RocketMQ</code> <strong>å¸¦æ³¨é‡Šæºç </strong>åœ°å€ ï¼š<a href=\"https://github.com/YunaiV/incubator-rocketmq\" target=\"_blank\" rel=\"external\">https://github.com/YunaiV/incubator-rocketmq</a><br>\n**ğŸ˜ˆæœ¬ç³»åˆ—æ¯ 1-2 å‘¨æ›´æ–°ä¸€ç¯‡ï¼Œæ¬¢è¿è®¢é˜…ã€å…³æ³¨ã€æ”¶è— å…¬ä¼—å· **</p>\n</blockquote>\n<p><img src=\"http://www.yunai.me/images/common/wechat_mp.jpeg\" alt=\"wechat_mp\"></p>\n<hr>\n<ul>\n<li><a href=\"#\">1ã€æ¦‚è¿°</a></li>\n<li><a href=\"#\">2ã€Consumer</a></li>\n<li><a href=\"#\">3ã€PushConsumer ä¸€è§ˆ</a></li>\n<li><a href=\"#\">4ã€PushConsumer è®¢é˜…</a>\n<ul>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#subscribe(...)</a>\n<ul>\n<li><a href=\"#\">FilterAPI.buildSubscriptionData(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">DefaultMQPushConsumer#registerMessageListener(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</a>\n<ul>\n<li><a href=\"#\">RebalanceService</a></li>\n<li><a href=\"#\">MQClientInstance#doRebalance(...)</a></li>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#doRebalance(...)</a></li>\n<li><a href=\"#\">RebalanceImpl#doRebalance(...)</a>\n<ul>\n<li><a href=\"#\">RebalanceImpl#rebalanceByTopic(...)</a></li>\n<li><a href=\"#\">RebalanceImpl#removeUnnecessaryMessageQueue(...)</a>\n<ul>\n<li><a href=\"#\">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</a></li>\n<li><a href=\"#\">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">RebalancePushImpl#dispatchPullRequest(...)</a>\n<ul>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">AllocateMessageQueueStrategy</a>\n<ul>\n<li><a href=\"#\">AllocateMessageQueueAveragely</a></li>\n<li><a href=\"#\">AllocateMessageQueueByMachineRoom</a></li>\n<li><a href=\"#\">AllocateMessageQueueAveragelyByCircle</a></li>\n<li><a href=\"#\">AllocateMessageQueueByConfig</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</a>\n<ul>\n<li><a href=\"#\">RebalancePushImpl#computePullFromWhere(...)</a></li>\n<li><a href=\"#\">[PullConsumer] RebalancePullImpl#computePullFromWhere(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</a>\n<ul>\n<li><a href=\"#\">PullMessageService</a></li>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#pullMessage(...)</a>\n<ul>\n<li><a href=\"#\">PullAPIWrapper#pullKernelImpl(...)</a>\n<ul>\n<li><a href=\"#\">PullAPIWrapper#recalculatePullFromWhichNode(...)</a></li>\n<li><a href=\"#\">MQClientInstance#findBrokerAddressInSubscribe(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">PullAPIWrapper#processPullResult(...)</a></li>\n<li><a href=\"#\">ProcessQueue#putMessage(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">æ€»ç»“</a></li>\n</ul>\n</li>\n<li><a href=\"#\">6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</a>\n<ul>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</a>\n<ul>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</a></li>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</a></li>\n</ul>\n</li>\n<li><a href=\"#\">ConsumeRequest</a></li>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService#processConsumeResult(...)</a>\n<ul>\n<li><a href=\"#\">ProcessQueue#removeMessage(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</a>\n<ul>\n<li><a href=\"#\">ProcessQueue#cleanExpiredMsg(...)</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</a>\n<ul>\n<li><a href=\"#\">DefaultMQPushConsumerImpl#sendMessageBack(...)</a>\n<ul>\n<li><a href=\"#\">MQClientAPIImpl#consumerSendMessageBack(...)</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">8ã€Consumer æ¶ˆè´¹è¿›åº¦</a>\n<ul>\n<li><a href=\"#\">OffsetStore</a>\n<ul>\n<li><a href=\"#\">OffsetStore#load(...)</a>\n<ul>\n<li><a href=\"#\">LocalFileOffsetStore#load(...)</a>\n<ul>\n<li><a href=\"#\">OffsetSerializeWrapper</a></li>\n</ul>\n</li>\n<li><a href=\"#\">RemoteBrokerOffsetStore#load(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">OffsetStore#readOffset(...)</a>\n<ul>\n<li><a href=\"#\">LocalFileOffsetStore#readOffset(...)</a></li>\n<li><a href=\"#\">RemoteBrokerOffsetStore#readOffset(...)</a></li>\n</ul>\n</li>\n<li><a href=\"#\">OffsetStore#updateOffset(...)</a></li>\n<li><a href=\"#\">OffsetStore#persistAll(...)</a>\n<ul>\n<li><a href=\"#\">LocalFileOffsetStore#persistAll(...)</a></li>\n<li><a href=\"#\">RemoteBrokerOffsetStore#persistAll(...)</a></li>\n<li><a href=\"#\">MQClientInstance#persistAllConsumerOffset(...)</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#\">9ã€ç»“å°¾</a></li>\n</ul>\n<hr>\n<h1>1ã€æ¦‚è¿°</h1>\n<p>æœ¬æ–‡æ¥ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message æ‹‰å–ä¸æ¶ˆè´¹ï¼ˆä¸Šï¼‰ã€‹</a>ã€‚</p>\n<p>ä¸»è¦è§£æ <code>Consumer</code> åœ¨ <strong>æ¶ˆè´¹</strong> é€»è¾‘æ¶‰åŠåˆ°çš„æºç ã€‚</p>\n<h1>2ã€Consumer</h1>\n<p>MQ æä¾›äº†ä¸¤ç±»æ¶ˆè´¹è€…ï¼š</p>\n<ul>\n<li>PushConsumerï¼š\n<ul>\n<li>åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ä½¿ç”¨ã€‚</li>\n<li>åå­—è™½ç„¶æ˜¯ <code>Push</code> å¼€å¤´ï¼Œå®é™…åœ¨å®ç°æ—¶ï¼Œä½¿ç”¨ <code>Pull</code> æ–¹å¼å®ç°ã€‚é€šè¿‡ <code>Pull</code> <strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>è½®è¯¢ <code>Broker</code> è·å–æ¶ˆæ¯ã€‚å½“ä¸å­˜åœ¨æ–°æ¶ˆæ¯æ—¶ï¼Œ<code>Broker</code> ä¼š<strong>æŒ‚èµ·è¯·æ±‚</strong>ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯äº§ç”Ÿï¼Œå–æ¶ˆæŒ‚èµ·ï¼Œè¿”å›æ–°æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒåŸºæœ¬å’Œ <code>Broker</code> ä¸»åŠ¨ <code>Push</code> åšåˆ°<strong>æ¥è¿‘</strong>çš„å®æ—¶æ€§ï¼ˆå½“ç„¶ï¼Œè¿˜æ˜¯æœ‰ç›¸åº”çš„å®æ—¶æ€§æŸå¤±ï¼‰ã€‚åŸç†ç±»ä¼¼ <strong><a href=\"https://www.ibm.com/developerworks/cn/web/wa-lo-comet/\" target=\"_blank\" rel=\"external\">é•¿è½®è¯¢( <code>Long-Polling</code> )</a></strong>ã€‚</li>\n</ul>\n</li>\n<li>PullConsumer</li>\n</ul>\n<p><strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br>\n<strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong><br>\n<strong>æœ¬æ–‡ä¸»è¦è®²è§£<code>PushConsumer</code>ï¼Œéƒ¨åˆ†è®²è§£<code>PullConsumer</code>ï¼Œè·³è¿‡<code>é¡ºåºæ¶ˆè´¹</code>ã€‚</strong></p>\n<h1>3ã€PushConsumer ä¸€è§ˆ</h1>\n<p>å…ˆçœ‹ä¸€å¼  <code>PushConsumer</code> åŒ…å«çš„ç»„ä»¶ä»¥åŠç»„ä»¶ä¹‹é—´çš„äº¤äº’å›¾ï¼š</p>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/09.png\" alt=\"PushConsumeræ‰‹ç»˜å›¾.png\"></p>\n<ul>\n<li><code>RebalanceService</code>ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚å½“æœ‰æ–°çš„ <code>Consumer</code> çš„åŠ å…¥æˆ–ç§»é™¤ï¼Œéƒ½ä¼šé‡æ–°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li><code>PullMessageService</code>ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li>\n<li><code>ConsumeMessageService</code>ï¼šæ¶ˆè´¹æ¶ˆæ¯æœåŠ¡ï¼Œ<strong>ä¸æ–­ä¸æ–­ä¸æ–­</strong>æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>\n<li><code>RemoteBrokerOffsetStore</code>ï¼š<code>Consumer</code> æ¶ˆè´¹è¿›åº¦ç®¡ç†ï¼Œè´Ÿè´£ä» <code>Broker</code> è·å–æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li>\n<li><code>ProcessQueue</code> ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚</li>\n<li><code>MQClientInstance</code> ï¼šå°è£…å¯¹ <code>Namesrv</code>ï¼Œ<code>Broker</code> çš„ APIè°ƒç”¨ï¼Œæä¾›ç»™ <code>Producer</code>ã€<code>Consumer</code> ä½¿ç”¨ã€‚</li>\n</ul>\n<h1>4ã€PushConsumer è®¢é˜…</h1>\n<h2>DefaultMQPushConsumerImpl#subscribe(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">subscribe</span><span class=\"params\">(String topic, String subExpression)</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:         <span class=\"comment\">// åˆ›å»ºè®¢é˜…æ•°æ®</span></div><div class=\"line\"> <span class=\"number\">4</span>:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(<span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">5</span>:             topic, subExpression);</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">this</span>.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// é€šè¿‡å¿ƒè·³åŒæ­¥Consumerä¿¡æ¯åˆ°Broker</span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.mQClientFactory != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</div><div class=\"line\"><span class=\"number\">10</span>:         &#125;</div><div class=\"line\"><span class=\"number\">11</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"subscription exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">13</span>:     &#125;</div><div class=\"line\"><span class=\"number\">14</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šè®¢é˜… <code>Topic</code> ã€‚</li>\n<li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šåˆ›å»ºè®¢é˜…æ•°æ®ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#filterapibuildsubscriptiondata\">FilterAPI.buildSubscriptionData(...)</a>ã€‚</li>\n<li>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šé€šè¿‡å¿ƒè·³åŒæ­¥ <code>Consumer</code> ä¿¡æ¯åˆ° <code>Broker</code>ã€‚</li>\n</ul>\n<h3>FilterAPI.buildSubscriptionData(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> SubscriptionData <span class=\"title\">buildSubscriptionData</span><span class=\"params\">(<span class=\"keyword\">final</span> String consumerGroup, String topic,</span></span></div><div class=\"line\"> <span class=\"number\">2</span>:     String subString) <span class=\"keyword\">throws</span> Exception &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     SubscriptionData subscriptionData = <span class=\"keyword\">new</span> SubscriptionData();</div><div class=\"line\"> <span class=\"number\">4</span>:     subscriptionData.setTopic(topic);</div><div class=\"line\"> <span class=\"number\">5</span>:     subscriptionData.setSubString(subString);</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">// å¤„ç†è®¢é˜…è¡¨è¾¾å¼</span></div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);</div><div class=\"line\"> <span class=\"number\">9</span>:     &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         String[] tags = subString.split(<span class=\"string\">\"\\\\|\\\\|\"</span>);</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">if</span> (tags.length &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">for</span> (String tag : tags) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">if</span> (tag.length() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:                     String trimString = tag.trim();</div><div class=\"line\"><span class=\"number\">15</span>:                     <span class=\"keyword\">if</span> (trimString.length() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                         subscriptionData.getTagsSet().add(trimString);</div><div class=\"line\"><span class=\"number\">17</span>:                         subscriptionData.getCodeSet().add(trimString.hashCode());</div><div class=\"line\"><span class=\"number\">18</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">19</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">20</span>:             &#125;</div><div class=\"line\"><span class=\"number\">21</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Exception(<span class=\"string\">\"subString split error\"</span>);</div><div class=\"line\"><span class=\"number\">23</span>:         &#125;</div><div class=\"line\"><span class=\"number\">24</span>:     &#125;</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">return</span> subscriptionData;</div><div class=\"line\"><span class=\"number\">27</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ ¹æ® <code>Topic</code> å’Œ è®¢é˜…è¡¨è¾¾å¼ åˆ›å»ºè®¢é˜…æ•°æ®</li>\n<li>subscriptionData.subVersion = System.currentTimeMillis()ã€‚</li>\n</ul>\n<h2>DefaultMQPushConsumer#registerMessageListener(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerMessageListener</span><span class=\"params\">(MessageListenerConcurrently messageListener)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">this</span>.messageListener = messageListener;</div><div class=\"line\"><span class=\"number\">3</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.registerMessageListener(messageListener);</div><div class=\"line\"><span class=\"number\">4</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ã€‚</li>\n</ul>\n<h1>5ã€PushConsumer æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…</h1>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/10.png\" alt=\"RebalanceService&amp;amp;PushConsumeråˆ†é…é˜Ÿåˆ—\"></p>\n<h2>RebalanceService</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RebalanceService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>: </div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 4:      * ç­‰å¾…é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’</div><div class=\"line\"> 5:      */</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">long</span> waitInterval =</div><div class=\"line\"> <span class=\"number\">7</span>:         Long.parseLong(System.getProperty(</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"string\">\"rocketmq.client.rebalance.waitInterval\"</span>, <span class=\"string\">\"20000\"</span>));</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log = ClientLogger.getLog();</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">12:      * MQClientå¯¹è±¡</div><div class=\"line\">13:      */</div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MQClientInstance mqClientFactory;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RebalanceService</span><span class=\"params\">(MQClientInstance mqClientFactory)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">this</span>.mqClientFactory = mqClientFactory;</div><div class=\"line\"><span class=\"number\">18</span>:     &#125;</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">22</span>:         log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"keyword\">this</span>.waitForRunning(waitInterval);</div><div class=\"line\"><span class=\"number\">26</span>:             <span class=\"keyword\">this</span>.mqClientFactory.doRebalance();</div><div class=\"line\"><span class=\"number\">27</span>:         &#125;</div><div class=\"line\"><span class=\"number\">28</span>: </div><div class=\"line\"><span class=\"number\">29</span>:         log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">30</span>:     &#125;</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">34</span>:         <span class=\"keyword\">return</span> RebalanceService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">35</span>:     &#125;</div><div class=\"line\"><span class=\"number\">36</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå‡è¡¡æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£åˆ†é…å½“å‰ <code>Consumer</code> å¯æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>MessageQueue</code> )ã€‚</li>\n<li>ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>MQClientInstance#doRebalance(...)</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç›®å‰æœ‰ä¸‰ç§æƒ…å†µæƒ…å†µä¸‹è§¦å‘ï¼š\n<ul>\n<li>å¦‚ <code>ç¬¬ 25 è¡Œ</code> ç­‰å¾…è¶…æ—¶ï¼Œæ¯ 20s è°ƒç”¨ä¸€æ¬¡ã€‚</li>\n<li><code>PushConsumer</code> å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li>\n<li><code>Broker</code> é€šçŸ¥ <code>Consumer</code> åŠ å…¥ æˆ– ç§»é™¤æ—¶ï¼Œ<code>Consumer</code> å“åº”é€šçŸ¥ï¼Œè°ƒç”¨ <code>rebalanceService#wakeup(...)</code> è§¦å‘ã€‚</li>\n</ul>\n</li>\n</ul>\n<p>è¯¦ç»†è§£æè§ï¼š<a href=\"#mqclientinstancedorebalance\">MQClientInstance#doRebalance(...)</a>ã€‚</p>\n<h2>MQClientInstance#doRebalance(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doRebalance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">for</span> (Map.Entry&lt;String, MQConsumerInner&gt; entry : <span class=\"keyword\">this</span>.consumerTable.entrySet()) &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:         MQConsumerInner impl = entry.getValue();</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">if</span> (impl != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:                 impl.doRebalance();</div><div class=\"line\"> <span class=\"number\">7</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:                 log.error(<span class=\"string\">\"doRebalance exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">9</span>:             &#125;</div><div class=\"line\"><span class=\"number\">10</span>:         &#125;</div><div class=\"line\"><span class=\"number\">11</span>:     &#125;</div><div class=\"line\"><span class=\"number\">12</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šéå†å½“å‰ <code>Client</code> åŒ…å«çš„ <code>consumerTable</code>( <code>Consumer</code>é›†åˆ )ï¼Œæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li>\n<li><strong>ç–‘é—®</strong>ï¼šç›®å‰ä»£ç è°ƒè¯•ä¸‹æ¥ï¼Œ<code>consumerTable</code> åªåŒ…å« <code>Consumer</code> è‡ªå·±ã€‚ğŸ˜ˆæœ‰å¤§å¤§å¯¹è¿™ä¸ªç–‘é—®æœ‰è§£ç­”çš„ï¼Œçƒ¦è¯·è§£ç­”ä¸‹ã€‚</li>\n<li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>MQConsumerInner#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚<code>DefaultMQPushConsumerImpl</code>ã€<code>DefaultMQPullConsumerImpl</code> åˆ†åˆ«å¯¹è¯¥æ¥å£æ–¹æ³•è¿›è¡Œäº†å®ç°ã€‚<code>DefaultMQPushConsumerImpl#doRebalance(...)</code> è¯¦ç»†è§£æè§ï¼š<a href=\"defaultmqpushconsumerimpldorebalance\">DefaultMQPushConsumerImpl#doRebalance(...)</a>ã€‚</li>\n</ul>\n<h2>DefaultMQPushConsumerImpl#doRebalance(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doRebalance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.pause) &#123;</div><div class=\"line\"><span class=\"number\">3</span>:         <span class=\"keyword\">this</span>.rebalanceImpl.doRebalance(<span class=\"keyword\">this</span>.isConsumeOrderly());</div><div class=\"line\"><span class=\"number\">4</span>:     &#125;</div><div class=\"line\"><span class=\"number\">5</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ï¼šæ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ã€‚</li>\n<li>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>RebalanceImpl#doRebalance(...)</code> è¿›è¡Œé˜Ÿåˆ—åˆ†é…ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#rebalancepushimpldorebalance\">RebalancePushImpl#doRebalance(...)</a>ã€‚</li>\n</ul>\n<h2>RebalanceImpl#doRebalance(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> isOrder æ˜¯å¦é¡ºåºæ¶ˆæ¯</div><div class=\"line\"> 5:  */</div><div class=\"line\"> <span class=\"number\">6</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doRebalance</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrder)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">// åˆ†é…æ¯ä¸ª topic çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">8</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class=\"keyword\">this</span>.getSubscriptionInner();</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (subTable != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">final</span> Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:             <span class=\"keyword\">final</span> String topic = entry.getKey();</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">this</span>.rebalanceByTopic(topic, isOrder);</div><div class=\"line\"><span class=\"number\">14</span>:             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"keyword\">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                     log.warn(<span class=\"string\">\"rebalanceByTopic Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">17</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">18</span>:             &#125;</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125;</div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"comment\">// ç§»é™¤æœªè®¢é˜…çš„topicå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">this</span>.truncateMessageQueueNotMyTopic();</div><div class=\"line\"><span class=\"number\">23</span>: &#125;</div><div class=\"line\"><span class=\"number\">24</span>: </div><div class=\"line\"><span class=\"number\">25</span>: <span class=\"comment\">/**</span></div><div class=\"line\">26:  * ç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">27:  */</div><div class=\"line\"><span class=\"number\">28</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">truncateMessageQueueNotMyTopic</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">29</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class=\"keyword\">this</span>.getSubscriptionInner();</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">for</span> (MessageQueue mq : <span class=\"keyword\">this</span>.processQueueTable.keySet()) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"keyword\">if</span> (!subTable.containsKey(mq.getTopic())) &#123;</div><div class=\"line\"><span class=\"number\">32</span>: </div><div class=\"line\"><span class=\"number\">33</span>:             ProcessQueue pq = <span class=\"keyword\">this</span>.processQueueTable.remove(mq);</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">if</span> (pq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:                 pq.setDropped(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">36</span>:                 log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, truncateMessageQueueNotMyTopic remove unnecessary mq, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">37</span>:             &#125;</div><div class=\"line\"><span class=\"number\">38</span>:         &#125;</div><div class=\"line\"><span class=\"number\">39</span>:     &#125;</div><div class=\"line\"><span class=\"number\">40</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>#doRebalance(...)</code> è¯´æ˜ ï¼šæ‰§è¡Œåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 7 è‡³ 20 è¡Œ ï¼šå¾ªç¯è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œåˆ†é…æ¯ä¸€ä¸ª <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 22 è¡Œ ï¼šç§»é™¤æœªè®¢é˜…çš„ <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n</li>\n<li><code>#truncateMessageQueueNotMyTopic(...)</code> è¯´æ˜ ï¼šç§»é™¤æœªè®¢é˜…çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚<strong>å½“è°ƒç”¨ <code>DefaultMQPushConsumer#unsubscribe(topic)</code> æ—¶ï¼Œåªç§»é™¤è®¢é˜…ä¸»é¢˜é›†åˆ( <code>subscriptionInner</code> )ï¼Œå¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—ç§»é™¤åœ¨è¯¥æ–¹æ³•ã€‚</strong></li>\n</ul>\n<h3>RebalanceImpl#rebalanceByTopic(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">rebalanceByTopic</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrder)</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">switch</span> (messageModel) &#123;</div><div class=\"line\">  <span class=\"number\">3</span>:         <span class=\"keyword\">case</span> BROADCASTING: &#123;</div><div class=\"line\">  <span class=\"number\">4</span>:             Set&lt;MessageQueue&gt; mqSet = <span class=\"keyword\">this</span>.topicSubscribeInfoTable.get(topic);</div><div class=\"line\">  <span class=\"number\">5</span>:             <span class=\"keyword\">if</span> (mqSet != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">  <span class=\"number\">6</span>:                 <span class=\"keyword\">boolean</span> changed = <span class=\"keyword\">this</span>.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);</div><div class=\"line\">  <span class=\"number\">7</span>:                 <span class=\"keyword\">if</span> (changed) &#123;</div><div class=\"line\">  <span class=\"number\">8</span>:                     <span class=\"keyword\">this</span>.messageQueueChanged(topic, mqSet, mqSet);</div><div class=\"line\">  <span class=\"number\">9</span>:                     log.info(<span class=\"string\">\"messageQueueChanged &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">10</span>:                         consumerGroup, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">11</span>:                         topic, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">12</span>:                         mqSet, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">13</span>:                         mqSet);</div><div class=\"line\"> <span class=\"number\">14</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">15</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist.\"</span>, consumerGroup, topic);</div><div class=\"line\"> <span class=\"number\">17</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">18</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">19</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">20</span>:         <span class=\"keyword\">case</span> CLUSTERING: &#123;</div><div class=\"line\"> <span class=\"number\">21</span>:             <span class=\"comment\">// è·å– topic å¯¹åº”çš„ é˜Ÿåˆ— å’Œ consumerä¿¡æ¯</span></div><div class=\"line\"> <span class=\"number\">22</span>:             Set&lt;MessageQueue&gt; mqSet = <span class=\"keyword\">this</span>.topicSubscribeInfoTable.get(topic);</div><div class=\"line\"> <span class=\"number\">23</span>:             List&lt;String&gt; cidAll = <span class=\"keyword\">this</span>.mQClientFactory.findConsumerIdList(topic, consumerGroup);</div><div class=\"line\"> <span class=\"number\">24</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mqSet) &#123;</div><div class=\"line\"> <span class=\"number\">25</span>:                 <span class=\"keyword\">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:                     log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist.\"</span>, consumerGroup, topic);</div><div class=\"line\"> <span class=\"number\">27</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">28</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:             <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == cidAll) &#123;</div><div class=\"line\"> <span class=\"number\">31</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125; &#123;&#125;, get consumer id list failed\"</span>, consumerGroup, topic);</div><div class=\"line\"> <span class=\"number\">32</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:             <span class=\"keyword\">if</span> (mqSet != <span class=\"keyword\">null</span> &amp;&amp; cidAll != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">35</span>:                 <span class=\"comment\">// æ’åº æ¶ˆæ¯é˜Ÿåˆ— å’Œ æ¶ˆè´¹è€…æ•°ç»„ã€‚å› ä¸ºæ˜¯åœ¨Clientè¿›è¡Œåˆ†é…é˜Ÿåˆ—ï¼Œæ’åºåï¼Œå„Clientçš„é¡ºåºæ‰èƒ½ä¿æŒä¸€è‡´ã€‚</span></div><div class=\"line\"> <span class=\"number\">36</span>:                 List&lt;MessageQueue&gt; mqAll = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">37</span>:                 mqAll.addAll(mqSet);</div><div class=\"line\"> <span class=\"number\">38</span>: </div><div class=\"line\"> <span class=\"number\">39</span>:                 Collections.sort(mqAll);</div><div class=\"line\"> <span class=\"number\">40</span>:                 Collections.sort(cidAll);</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:                 AllocateMessageQueueStrategy strategy = <span class=\"keyword\">this</span>.allocateMessageQueueStrategy;</div><div class=\"line\"> <span class=\"number\">43</span>: </div><div class=\"line\"> <span class=\"number\">44</span>:                 <span class=\"comment\">// æ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥ åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">45</span>:                 List&lt;MessageQueue&gt; allocateResult;</div><div class=\"line\"> <span class=\"number\">46</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">47</span>:                     allocateResult = strategy.allocate(<span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">48</span>:                         <span class=\"keyword\">this</span>.consumerGroup, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">49</span>:                         <span class=\"keyword\">this</span>.mQClientFactory.getClientId(), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">50</span>:                         mqAll, <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">51</span>:                         cidAll);</div><div class=\"line\"> <span class=\"number\">52</span>:                 &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">53</span>:                     log.error(<span class=\"string\">\"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName=&#123;&#125;\"</span>, strategy.getName(),</div><div class=\"line\"> <span class=\"number\">54</span>:                         e);</div><div class=\"line\"> <span class=\"number\">55</span>:                     <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">56</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">57</span>: </div><div class=\"line\"> <span class=\"number\">58</span>:                 Set&lt;MessageQueue&gt; allocateResultSet = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">59</span>:                 <span class=\"keyword\">if</span> (allocateResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">60</span>:                     allocateResultSet.addAll(allocateResult);</div><div class=\"line\"> <span class=\"number\">61</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">62</span>: </div><div class=\"line\"> <span class=\"number\">63</span>:                 <span class=\"comment\">// æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">64</span>:                 <span class=\"keyword\">boolean</span> changed = <span class=\"keyword\">this</span>.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);</div><div class=\"line\"> <span class=\"number\">65</span>:                 <span class=\"keyword\">if</span> (changed) &#123;</div><div class=\"line\"> <span class=\"number\">66</span>:                     log.info(</div><div class=\"line\"> <span class=\"number\">67</span>:                         <span class=\"string\">\"rebalanced result changed. allocateMessageQueueStrategyName=&#123;&#125;, group=&#123;&#125;, topic=&#123;&#125;, clientId=&#123;&#125;, mqAllSize=&#123;&#125;, cidAllSize=&#123;&#125;, rebalanceResultSize=&#123;&#125;, rebalanceResultSet=&#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">68</span>:                         strategy.getName(), consumerGroup, topic, <span class=\"keyword\">this</span>.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),</div><div class=\"line\"> <span class=\"number\">69</span>:                         allocateResultSet.size(), allocateResultSet);</div><div class=\"line\"> <span class=\"number\">70</span>:                     <span class=\"keyword\">this</span>.messageQueueChanged(topic, mqSet, allocateResultSet);</div><div class=\"line\"> <span class=\"number\">71</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">72</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">73</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">74</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"> <span class=\"number\">76</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"> <span class=\"number\">77</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">78</span>: &#125;</div><div class=\"line\"> <span class=\"number\">79</span>: </div><div class=\"line\"> <span class=\"number\">80</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 81:  * å½“è´Ÿè½½å‡è¡¡æ—¶ï¼Œæ›´æ–° æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\"> 82:  * - ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 83:  * - å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 84:  *</div><div class=\"line\"> 85:  * <span class=\"doctag\">@param</span> topic Topic</div><div class=\"line\"> 86:  * <span class=\"doctag\">@param</span> mqSet è´Ÿè½½å‡è¡¡ç»“æœåçš„æ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„</div><div class=\"line\"> 87:  * <span class=\"doctag\">@param</span> isOrder æ˜¯å¦é¡ºåº</div><div class=\"line\"> 88:  * <span class=\"doctag\">@return</span> æ˜¯å¦å˜æ›´</div><div class=\"line\"> 89:  */</div><div class=\"line\"> <span class=\"number\">90</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">updateProcessQueueTableInRebalance</span><span class=\"params\">(<span class=\"keyword\">final</span> String topic, <span class=\"keyword\">final</span> Set&lt;MessageQueue&gt; mqSet, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrder)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">91</span>:     <span class=\"keyword\">boolean</span> changed = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">92</span>: </div><div class=\"line\"> <span class=\"number\">93</span>:     <span class=\"comment\">// ç§»é™¤ åœ¨processQueueTable &amp;&amp; ä¸å­˜åœ¨äº mqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">94</span>:     Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = <span class=\"keyword\">this</span>.processQueueTable.entrySet().iterator();</div><div class=\"line\"> <span class=\"number\">95</span>:     <span class=\"keyword\">while</span> (it.hasNext()) &#123; <span class=\"comment\">// TODO å¾…è¯»ï¼š</span></div><div class=\"line\"> <span class=\"number\">96</span>:         Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class=\"line\"> <span class=\"number\">97</span>:         MessageQueue mq = next.getKey();</div><div class=\"line\"> <span class=\"number\">98</span>:         ProcessQueue pq = next.getValue();</div><div class=\"line\"> <span class=\"number\">99</span>: </div><div class=\"line\"><span class=\"number\">100</span>:         <span class=\"keyword\">if</span> (mq.getTopic().equals(topic)) &#123;</div><div class=\"line\"><span class=\"number\">101</span>:             <span class=\"keyword\">if</span> (!mqSet.contains(mq)) &#123; <span class=\"comment\">// ä¸åŒ…å«çš„é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">102</span>:                 pq.setDropped(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">103</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class=\"line\"><span class=\"number\">104</span>:                     it.remove();</div><div class=\"line\"><span class=\"number\">105</span>:                     changed = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">106</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">107</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">108</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pq.isPullExpired()) &#123; <span class=\"comment\">// é˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†</span></div><div class=\"line\"><span class=\"number\">109</span>:                 <span class=\"keyword\">switch</span> (<span class=\"keyword\">this</span>.consumeType()) &#123;</div><div class=\"line\"><span class=\"number\">110</span>:                     <span class=\"keyword\">case</span> CONSUME_ACTIVELY:</div><div class=\"line\"><span class=\"number\">111</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">112</span>:                     <span class=\"keyword\">case</span> CONSUME_PASSIVELY:</div><div class=\"line\"><span class=\"number\">113</span>:                         pq.setDropped(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">114</span>:                         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class=\"line\"><span class=\"number\">115</span>:                             it.remove();</div><div class=\"line\"><span class=\"number\">116</span>:                             changed = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">117</span>:                             log.error(<span class=\"string\">\"[BUG]doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;, because pull is pause, so try to fixed it\"</span>,</div><div class=\"line\"><span class=\"number\">118</span>:                                 consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">119</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">120</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">121</span>:                     <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">122</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">123</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">124</span>:             &#125;</div><div class=\"line\"><span class=\"number\">125</span>:         &#125;</div><div class=\"line\"><span class=\"number\">126</span>:     &#125;</div><div class=\"line\"><span class=\"number\">127</span>: </div><div class=\"line\"><span class=\"number\">128</span>:     <span class=\"comment\">// å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class=\"line\"><span class=\"number\">129</span>:     List&lt;PullRequest&gt; pullRequestList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(); <span class=\"comment\">// æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„</span></div><div class=\"line\"><span class=\"number\">130</span>:     <span class=\"keyword\">for</span> (MessageQueue mq : mqSet) &#123;</div><div class=\"line\"><span class=\"number\">131</span>:         <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class=\"line\"><span class=\"number\">132</span>:             <span class=\"keyword\">if</span> (isOrder &amp;&amp; !<span class=\"keyword\">this</span>.lock(mq)) &#123;</div><div class=\"line\"><span class=\"number\">133</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">134</span>:                 <span class=\"keyword\">continue</span>;</div><div class=\"line\"><span class=\"number\">135</span>:             &#125;</div><div class=\"line\"><span class=\"number\">136</span>: </div><div class=\"line\"><span class=\"number\">137</span>:             <span class=\"keyword\">this</span>.removeDirtyOffset(mq);</div><div class=\"line\"><span class=\"number\">138</span>:             ProcessQueue pq = <span class=\"keyword\">new</span> ProcessQueue();</div><div class=\"line\"><span class=\"number\">139</span>:             <span class=\"keyword\">long</span> nextOffset = <span class=\"keyword\">this</span>.computePullFromWhere(mq);</div><div class=\"line\"><span class=\"number\">140</span>:             <span class=\"keyword\">if</span> (nextOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">141</span>:                 ProcessQueue pre = <span class=\"keyword\">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class=\"line\"><span class=\"number\">142</span>:                 <span class=\"keyword\">if</span> (pre != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">143</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">144</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">145</span>:                     log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">146</span>:                     PullRequest pullRequest = <span class=\"keyword\">new</span> PullRequest();</div><div class=\"line\"><span class=\"number\">147</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class=\"line\"><span class=\"number\">148</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class=\"line\"><span class=\"number\">149</span>:                     pullRequest.setMessageQueue(mq);</div><div class=\"line\"><span class=\"number\">150</span>:                     pullRequest.setProcessQueue(pq);</div><div class=\"line\"><span class=\"number\">151</span>:                     pullRequestList.add(pullRequest);</div><div class=\"line\"><span class=\"number\">152</span>:                     changed = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">153</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">154</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">155</span>:                 log.warn(<span class=\"string\">\"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;\"</span>, consumerGroup, mq);</div><div class=\"line\"><span class=\"number\">156</span>:             &#125;</div><div class=\"line\"><span class=\"number\">157</span>:         &#125;</div><div class=\"line\"><span class=\"number\">158</span>:     &#125;</div><div class=\"line\"><span class=\"number\">159</span>: </div><div class=\"line\"><span class=\"number\">160</span>:     <span class=\"comment\">// å‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">161</span>:     <span class=\"keyword\">this</span>.dispatchPullRequest(pullRequestList);</div><div class=\"line\"><span class=\"number\">162</span>: </div><div class=\"line\"><span class=\"number\">163</span>:     <span class=\"keyword\">return</span> changed;</div><div class=\"line\"><span class=\"number\">164</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>#rebalanceByTopic(...)</code> è¯´æ˜ ï¼šåˆ†é… <code>Topic</code> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 3 è‡³ 19 è¡Œ ï¼šå¹¿æ’­æ¨¡å¼( <code>BROADCASTING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>æ‰€æœ‰</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 20 è‡³ 74 è¡Œ ï¼šé›†ç¾¤æ¨¡å¼( <code>CLUSTERING</code> ) ä¸‹ï¼Œåˆ†é… <code>Topic</code> å¯¹åº”çš„<strong>éƒ¨åˆ†</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 21 è‡³ 40 è¡Œ ï¼šè·å– <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ä»¬ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ’åºã€‚å› ä¸ºå„ <code>Consumer</code> æ˜¯åœ¨æœ¬åœ°åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ’åºåæ‰èƒ½ä¿è¯å„ <code>Consumer</code> é¡ºåºä¸€è‡´ã€‚</li>\n<li>ç¬¬ 42 è‡³ 61 è¡Œ ï¼šæ ¹æ® é˜Ÿåˆ—åˆ†é…ç­–ç•¥( <code>AllocateMessageQueueStrategy</code> ) åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#allocatemessagequeuestrategy\">AllocateMessageQueueStrategy</a>ã€‚</li>\n<li>ç¬¬ 63 è‡³ 72 è¡Œ ï¼šæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>#updateProcessQueueTableInRebalance(...)</code> è¯´æ˜ ï¼šå½“åˆ†é…é˜Ÿåˆ—æ—¶ï¼Œæ›´æ–° <code>Topic</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è¿”å›æ˜¯å¦æœ‰å˜æ›´ã€‚\n<ul>\n<li>ç¬¬ 93 è‡³ 126 è¡Œ ï¼šç§»é™¤ä¸å­˜åœ¨äºåˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) çš„ æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—( <code>processQueueTable</code> )ã€‚\n<ul>\n<li>ç¬¬ 103 è¡Œ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#rebalancepushimplremoveunnecessarymessagequeue\">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</a>ã€‚</li>\n<li>ç¬¬ 108 è‡³ 120 è¡Œ ï¼šé˜Ÿåˆ—æ‹‰å–è¶…æ—¶ï¼Œå³ <code>å½“å‰æ—¶é—´ - æœ€åä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶é—´ &gt; 120s</code> ( 120s å¯é…ç½®)ï¼Œåˆ¤å®šå‘ç”Ÿ <strong>BUG</strong>ï¼Œè¿‡ä¹…æœªè¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—ã€‚ç§»é™¤åï¼Œä¸‹é¢**#æ–°å¢é˜Ÿåˆ—é€»è¾‘#**å¯ä»¥é‡æ–°åŠ å…¥æ–°çš„è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 128 è‡³ 158 è¡Œ ï¼šå¢åŠ  åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—( <code>mqSet</code> ) æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 132 è‡³ 135 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>\n<li>ç¬¬ 137 è¡Œ ï¼šç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ã€‚</li>\n<li>ç¬¬ 139 è¡Œ ï¼šè·å–é˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#rebalancepushimplcomputepullfromwhere\">RebalancePushImpl#computePullFromWhere(...)</a>ã€‚</li>\n<li>ç¬¬ 140 è‡³ 156 è¡Œ ï¼š<strong>æ·»åŠ æ–°æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ï¼Œæ·»åŠ æ¶ˆè´¹æ‹‰å–æ¶ˆæ¯è¯·æ±‚</strong>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 161 è¡Œ ï¼š<strong>å‘èµ·æ–°å¢çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯æ‹‰å–è¯·æ±‚</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#rebalancepushimpldispatchpullrequest\">RebalancePushImpl#dispatchPullRequest(...)</a>ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3>RebalanceImpl#removeUnnecessaryMessageQueue(...)</h3>\n<h4>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">removeUnnecessaryMessageQueue</span><span class=\"params\">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">// åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</span></div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"comment\">// TODO é¡ºåºæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class=\"line\"> <span class=\"number\">7</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">if</span> (pq.getLockConsume().tryLock(<span class=\"number\">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                     <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.unlockDelay(mq, pq);</div><div class=\"line\"><span class=\"number\">12</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                     pq.getLockConsume().unlock();</div><div class=\"line\"><span class=\"number\">14</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">15</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                 log.warn(<span class=\"string\">\"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">17</span>:                     mq, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">18</span>:                     pq.getTryUnlockTimes());</div><div class=\"line\"><span class=\"number\">19</span>: </div><div class=\"line\"><span class=\"number\">20</span>:                 pq.incTryUnlockTimes();</div><div class=\"line\"><span class=\"number\">21</span>:             &#125;</div><div class=\"line\"><span class=\"number\">22</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:             log.error(<span class=\"string\">\"removeUnnecessaryMessageQueue Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">24</span>:         &#125;</div><div class=\"line\"><span class=\"number\">25</span>: </div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">27</span>:     &#125;</div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">29</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›æ˜¯å¦ç§»é™¤æˆåŠŸã€‚</li>\n<li>ç¬¬ 2 è‡³ 4 è¡Œ ï¼š<strong>åŒæ­¥</strong>é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚</li>\n<li>ç¬¬ 5 è‡³ 27 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>\n</ul>\n<h4><code>[PullConsumer]</code> RebalancePullImpl#removeUnnecessaryMessageQueue(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">removeUnnecessaryMessageQueue</span><span class=\"params\">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">this</span>.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);</div><div class=\"line\"><span class=\"number\">3</span>:     <span class=\"keyword\">this</span>.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class=\"line\"><span class=\"number\">4</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">5</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›ç§»é™¤æˆåŠŸã€‚<strong>å’Œ<code>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</code>åŸºæœ¬ä¸€è‡´ã€‚</strong></li>\n</ul>\n<h3>RebalancePushImpl#dispatchPullRequest(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">dispatchPullRequest</span><span class=\"params\">(List&lt;PullRequest&gt; pullRequestList)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">for</span> (PullRequest pullRequest : pullRequestList) &#123;</div><div class=\"line\"><span class=\"number\">3</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">4</span>:         log.info(<span class=\"string\">\"doRebalance, &#123;&#125;, add a new pull request &#123;&#125;\"</span>, consumerGroup, pullRequest);</div><div class=\"line\"><span class=\"number\">5</span>:     &#125;</div><div class=\"line\"><span class=\"number\">6</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚<strong>è¯¥è°ƒç”¨æ˜¯<code>PushConsumer</code>ä¸æ–­ä¸æ–­ä¸æ–­æ‹‰å–æ¶ˆæ¯çš„èµ·ç‚¹</strong>ã€‚</li>\n</ul>\n<h4>DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executePullRequestImmediately</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">2</span>:     <span class=\"keyword\">this</span>.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">3</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæäº¤æ‹‰å–è¯·æ±‚ã€‚æäº¤åï¼Œ<code>PullMessageService</code> <strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼Œ<strong>éé˜»å¡</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"pullmessageservice\">PullMessageService</a>ã€‚</li>\n</ul>\n<h3>AllocateMessageQueueStrategy</h3>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/01.png\" alt=\"AllocateMessageQueueStrategyç±»å›¾\"></p>\n<h4>AllocateMessageQueueAveragely</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllocateMessageQueueAveragely</span> <span class=\"keyword\">implements</span> <span class=\"title\">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log = ClientLogger.getLog();</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">allocate</span><span class=\"params\">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class=\"line\"> <span class=\"number\">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®</span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">if</span> (currentCID == <span class=\"keyword\">null</span> || currentCID.length() &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"currentCID is empty\"</span>);</div><div class=\"line\"><span class=\"number\">10</span>:         &#125;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">if</span> (mqAll == <span class=\"keyword\">null</span> || mqAll.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"mqAll is null or mqAll empty\"</span>);</div><div class=\"line\"><span class=\"number\">13</span>:         &#125;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">if</span> (cidAll == <span class=\"keyword\">null</span> || cidAll.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"cidAll is null or cidAll empty\"</span>);</div><div class=\"line\"><span class=\"number\">16</span>:         &#125;</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:         List&lt;MessageQueue&gt; result = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             log.info(<span class=\"string\">\"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">21</span>:                 consumerGroup,</div><div class=\"line\"><span class=\"number\">22</span>:                 currentCID,</div><div class=\"line\"><span class=\"number\">23</span>:                 cidAll);</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"comment\">// å¹³å‡åˆ†é…</span></div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"keyword\">int</span> index = cidAll.indexOf(currentCID); <span class=\"comment\">// ç¬¬å‡ ä¸ªconsumerã€‚</span></div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">int</span> mod = mqAll.size() % cidAll.size(); <span class=\"comment\">// ä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</span></div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">int</span> averageSize =</div><div class=\"line\"><span class=\"number\">30</span>:             mqAll.size() &lt;= cidAll.size() ? <span class=\"number\">1</span> : (mod &gt; <span class=\"number\">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()</div><div class=\"line\"><span class=\"number\">31</span>:                 + <span class=\"number\">1</span> : mqAll.size() / cidAll.size());</div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"keyword\">int</span> startIndex = (mod &gt; <span class=\"number\">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod; <span class=\"comment\">// æœ‰ä½™æ•°çš„æƒ…å†µä¸‹ï¼Œ[0, mod) å¹³åˆ†ä½™æ•°ï¼Œå³æ¯consumerå¤šåˆ†é…ä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬indexå¼€å§‹ï¼Œè·³è¿‡å‰modä½™æ•°ã€‚</span></div><div class=\"line\"><span class=\"number\">33</span>:         <span class=\"keyword\">int</span> range = Math.min(averageSize, mqAll.size() - startIndex); <span class=\"comment\">// åˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦Math.min()çš„åŸå› æ˜¯ï¼ŒmqAll.size() &lt;= cidAll.size()ï¼Œéƒ¨åˆ†consumeråˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class=\"line\"><span class=\"number\">34</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; range; i++) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:             result.add(mqAll.get((startIndex + i) % mqAll.size()));</div><div class=\"line\"><span class=\"number\">36</span>:         &#125;</div><div class=\"line\"><span class=\"number\">37</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">38</span>:     &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">41</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">return</span> <span class=\"string\">\"AVG\"</span>;</div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…é˜Ÿåˆ—ç­–ç•¥ã€‚</li>\n<li>ç¬¬ 7 è‡³ 25 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li>\n<li>ç¬¬ 26 è‡³ 36 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç¬¬ 27 è¡Œ ï¼š<code>index</code> ï¼šå½“å‰ <code>Consumer</code> åœ¨æ¶ˆè´¹é›†ç¾¤é‡Œæ˜¯ç¬¬å‡ ä¸ªã€‚è¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å¯¹ä¼ å…¥çš„ <code>cidAll</code> å‚æ•°å¿…é¡»è¿›è¡Œæ’åºçš„åŸå› ã€‚å¦‚æœä¸æ’åºï¼Œ<code>Consumer</code> åœ¨æœ¬åœ°è®¡ç®—å‡ºæ¥çš„ <code>index</code> æ— æ³•ä¸€è‡´ï¼Œå½±å“è®¡ç®—ç»“æœã€‚</li>\n<li>ç¬¬ 28 è¡Œ ï¼š<code>mod</code> ï¼šä½™æ•°ï¼Œå³å¤šå°‘æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å¹³å‡åˆ†é…ã€‚</li>\n<li>ç¬¬ 29 è‡³ 31 è¡Œ ï¼š<code>averageSize</code> ï¼šä»£ç å¯ä»¥ç®€åŒ–æˆ <code>(mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())</code>ã€‚\n<ul>\n<li><code>[ 0, mod )</code> ï¼š<code>mqAll.size() / cidAll.size() + 1</code>ã€‚å‰é¢ <code>mod</code> ä¸ª <code>Consumer</code> å¹³åˆ†ä½™æ•°ï¼Œå¤šè·å¾— 1 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li><code>[ mod, cidAll.size() )</code> ï¼š<code>mqAll.size() / cidAll.size()</code>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 32 è¡Œ ï¼š<code>startIndex</code> ï¼š<code>Consumer</code> åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹ä½ç½®ã€‚</li>\n<li>ç¬¬ 33 è¡Œ ï¼š<code>range</code> ï¼šåˆ†é…é˜Ÿåˆ—æ•°é‡ã€‚ä¹‹æ‰€ä»¥è¦ <code>Math#min(...)</code> çš„åŸå› ï¼šå½“ <code>mqAll.size() &lt;= cidAll.size()</code> æ—¶ï¼Œæœ€åå‡ ä¸ª <code>Consumer</code> åˆ†é…ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 34 è‡³ 36 è¡Œ ï¼šç”Ÿæˆåˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç»“æœã€‚</li>\n</ul>\n</li>\n<li>ä¸¾ä¸ªä¾‹å­ï¼š</li>\n</ul>\n<p>å›ºå®šæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦ä¸º<strong>4</strong>ã€‚</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Consumer * 2 <em>å¯ä»¥æ•´é™¤</em></th>\n<th>Consumer * 3 <em>ä¸å¯æ•´é™¤</em></th>\n<th>Consumer * 5 <em>æ— æ³•éƒ½åˆ†é…</em></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ¶ˆæ¯é˜Ÿåˆ—[0]</td>\n<td>Consumer[0]</td>\n<td>Consumer[0]</td>\n<td>Consumer[0]</td>\n</tr>\n<tr>\n<td>æ¶ˆæ¯é˜Ÿåˆ—[1]</td>\n<td>Consumer[0]</td>\n<td>Consumer[0]</td>\n<td>Consumer[1]</td>\n</tr>\n<tr>\n<td>æ¶ˆæ¯é˜Ÿåˆ—[2]</td>\n<td>Consumer[1]</td>\n<td>Consumer[1]</td>\n<td>Consumer[2]</td>\n</tr>\n<tr>\n<td>æ¶ˆæ¯é˜Ÿåˆ—[3]</td>\n<td>Consumer[1]</td>\n<td>Consumer[2]</td>\n<td>Consumer[3]</td>\n</tr>\n</tbody>\n</table>\n<h4>AllocateMessageQueueByMachineRoom</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllocateMessageQueueByMachineRoom</span> <span class=\"keyword\">implements</span> <span class=\"title\">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 3:      * æ¶ˆè´¹è€…æ¶ˆè´¹brokerNameé›†åˆ</div><div class=\"line\"> 4:      */</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">private</span> Set&lt;String&gt; consumeridcs;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">allocate</span><span class=\"params\">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class=\"line\"> <span class=\"number\">9</span>:         List&lt;String&gt; cidAll) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"comment\">// å‚æ•°æ ¡éªŒ</span></div><div class=\"line\"><span class=\"number\">11</span>:         List&lt;MessageQueue&gt; result = <span class=\"keyword\">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">int</span> currentIndex = cidAll.indexOf(currentCID);</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">if</span> (currentIndex &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">15</span>:         &#125;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"comment\">// è®¡ç®—ç¬¦åˆå½“å‰é…ç½®çš„æ¶ˆè´¹è€…æ•°ç»„('consumeridcs')å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">17</span>:         List&lt;MessageQueue&gt; premqAll = <span class=\"keyword\">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">for</span> (MessageQueue mq : mqAll) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             String[] temp = mq.getBrokerName().split(<span class=\"string\">\"@\"</span>);</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">if</span> (temp.length == <span class=\"number\">2</span> &amp;&amp; consumeridcs.contains(temp[<span class=\"number\">0</span>])) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                 premqAll.add(mq);</div><div class=\"line\"><span class=\"number\">22</span>:             &#125;</div><div class=\"line\"><span class=\"number\">23</span>:         &#125;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"comment\">// å¹³å‡åˆ†é…</span></div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">int</span> mod = premqAll.size() / cidAll.size();</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">int</span> rem = premqAll.size() % cidAll.size();</div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"keyword\">int</span> startIndex = mod * currentIndex;</div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">int</span> endIndex = startIndex + mod;</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = startIndex; i &lt; endIndex; i++) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             result.add(mqAll.get(i));</div><div class=\"line\"><span class=\"number\">31</span>:         &#125;</div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"keyword\">if</span> (rem &gt; currentIndex) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));</div><div class=\"line\"><span class=\"number\">34</span>:         &#125;</div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">36</span>:     &#125;</div><div class=\"line\"><span class=\"number\">37</span>: </div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">return</span> <span class=\"string\">\"MACHINE_ROOM\"</span>;</div><div class=\"line\"><span class=\"number\">41</span>:     &#125;</div><div class=\"line\"><span class=\"number\">42</span>: </div><div class=\"line\"><span class=\"number\">43</span>:     <span class=\"function\"><span class=\"keyword\">public</span> Set&lt;String&gt; <span class=\"title\">getConsumeridcs</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">44</span>:         <span class=\"keyword\">return</span> consumeridcs;</div><div class=\"line\"><span class=\"number\">45</span>:     &#125;</div><div class=\"line\"><span class=\"number\">46</span>: </div><div class=\"line\"><span class=\"number\">47</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setConsumeridcs</span><span class=\"params\">(Set&lt;String&gt; consumeridcs)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">48</span>:         <span class=\"keyword\">this</span>.consumeridcs = consumeridcs;</div><div class=\"line\"><span class=\"number\">49</span>:     &#125;</div><div class=\"line\"><span class=\"number\">50</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼š<strong>å¹³å‡</strong>åˆ†é…<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šå‚æ•°æ ¡éªŒã€‚</li>\n<li>ç¬¬ 16 è‡³ 23 è¡Œ ï¼šè®¡ç®—<strong>å¯æ¶ˆè´¹çš„</strong> <code>Broker</code> å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬ 25 è‡³ 34 è¡Œ ï¼šå¹³å‡åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¥<strong>å¹³å‡åˆ†é…</strong>æ–¹å¼å’Œ <code>AllocateMessageQueueAveragely</code> ç•¥æœ‰ä¸åŒï¼Œå…¶æ˜¯å°†å¤šä½™çš„ç»“å°¾éƒ¨åˆ†åˆ†é…ç»™å‰ <code>rem</code> ä¸ª <code>Consumer</code>ã€‚</li>\n<li>ç–‘é—®ï¼š<em>ä½¿ç”¨è¯¥åˆ†é…ç­–ç•¥æ—¶ï¼Œ<code>Consumer</code> å’Œ <code>Broker</code> åˆ†é…éœ€è¦æ€ä¹ˆé…ç½®</em>ã€‚ğŸ˜ˆç­‰ç ”ç©¶<strong>ä¸»ä»</strong>ç›¸å…³æºç æ—¶ï¼Œä»”ç»†è€ƒè™‘ä¸‹ã€‚</li>\n</ul>\n<h4>AllocateMessageQueueAveragelyByCircle</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllocateMessageQueueAveragelyByCircle</span> <span class=\"keyword\">implements</span> <span class=\"title\">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log = ClientLogger.getLog();</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">allocate</span><span class=\"params\">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class=\"line\"> <span class=\"number\">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"comment\">// æ ¡éªŒå‚æ•°æ˜¯å¦æ­£ç¡®</span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">if</span> (currentCID == <span class=\"keyword\">null</span> || currentCID.length() &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"currentCID is empty\"</span>);</div><div class=\"line\"><span class=\"number\">10</span>:         &#125;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">if</span> (mqAll == <span class=\"keyword\">null</span> || mqAll.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"mqAll is null or mqAll empty\"</span>);</div><div class=\"line\"><span class=\"number\">13</span>:         &#125;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">if</span> (cidAll == <span class=\"keyword\">null</span> || cidAll.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"cidAll is null or cidAll empty\"</span>);</div><div class=\"line\"><span class=\"number\">16</span>:         &#125;</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:         List&lt;MessageQueue&gt; result = <span class=\"keyword\">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class=\"line\"><span class=\"number\">19</span>:         <span class=\"keyword\">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:             log.info(<span class=\"string\">\"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">21</span>:                 consumerGroup,</div><div class=\"line\"><span class=\"number\">22</span>:                 currentCID,</div><div class=\"line\"><span class=\"number\">23</span>:                 cidAll);</div><div class=\"line\"><span class=\"number\">24</span>:             <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"comment\">// ç¯çŠ¶åˆ†é…</span></div><div class=\"line\"><span class=\"number\">28</span>:         <span class=\"keyword\">int</span> index = cidAll.indexOf(currentCID);</div><div class=\"line\"><span class=\"number\">29</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = index; i &lt; mqAll.size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:             <span class=\"keyword\">if</span> (i % cidAll.size() == index) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                 result.add(mqAll.get(i));</div><div class=\"line\"><span class=\"number\">32</span>:             &#125;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:         <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">35</span>:     &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"keyword\">return</span> <span class=\"string\">\"AVG_BY_CIRCLE\"</span>;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šç¯çŠ¶åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n<h4>AllocateMessageQueueByConfig</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllocateMessageQueueByConfig</span> <span class=\"keyword\">implements</span> <span class=\"title\">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> List&lt;MessageQueue&gt; messageQueueList;</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">allocate</span><span class=\"params\">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class=\"line\"> <span class=\"number\">6</span>:         List&lt;String&gt; cidAll) &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.messageQueueList;</div><div class=\"line\"> <span class=\"number\">8</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">return</span> <span class=\"string\">\"CONFIG\"</span>;</div><div class=\"line\"><span class=\"number\">13</span>:     &#125;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MessageQueue&gt; <span class=\"title\">getMessageQueueList</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">return</span> messageQueueList;</div><div class=\"line\"><span class=\"number\">17</span>:     &#125;</div><div class=\"line\"><span class=\"number\">18</span>: </div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setMessageQueueList</span><span class=\"params\">(List&lt;MessageQueue&gt; messageQueueList)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"keyword\">this</span>.messageQueueList = messageQueueList;</div><div class=\"line\"><span class=\"number\">21</span>:     &#125;</div><div class=\"line\"><span class=\"number\">22</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šåˆ†é…<strong>é…ç½®çš„</strong>æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n<li>ç–‘é—® ï¼š<em>è¯¥åˆ†é…ç­–ç•¥çš„ä½¿ç”¨åœºæ™¯ã€‚</em></li>\n</ul>\n<h1>5ã€PushConsumer æ¶ˆè´¹è¿›åº¦è¯»å–</h1>\n<h2>RebalancePushImpl#computePullFromWhere(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">computePullFromWhere</span><span class=\"params\">(MessageQueue mq)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">long</span> result = -<span class=\"number\">1</span>;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> ConsumeFromWhere consumeFromWhere = <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> OffsetStore offsetStore = <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore();</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">switch</span> (consumeFromWhere) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: <span class=\"comment\">// åºŸå¼ƒ</span></div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_MIN_OFFSET: <span class=\"comment\">// åºŸå¼ƒ</span></div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_MAX_OFFSET: <span class=\"comment\">// åºŸå¼ƒ</span></div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_LAST_OFFSET: &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class=\"line\"><span class=\"number\">11</span>:             <span class=\"keyword\">if</span> (lastOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">12</span>:                 result = lastOffset;</div><div class=\"line\"><span class=\"number\">13</span>:             &#125;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"comment\">// First start,no offset</span></div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == lastOffset) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                 <span class=\"keyword\">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                     result = <span class=\"number\">0L</span>;</div><div class=\"line\"><span class=\"number\">18</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">19</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                         result = <span class=\"keyword\">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class=\"line\"><span class=\"number\">21</span>:                     &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                         result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">23</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">24</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">25</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">26</span>:                 result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">29</span>:         &#125;</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_FIRST_OFFSET: &#123;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">if</span> (lastOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:                 result = lastOffset;</div><div class=\"line\"><span class=\"number\">34</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == lastOffset) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:                 result = <span class=\"number\">0L</span>;</div><div class=\"line\"><span class=\"number\">36</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">37</span>:                 result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">38</span>:             &#125;</div><div class=\"line\"><span class=\"number\">39</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">40</span>:         &#125;</div><div class=\"line\"><span class=\"number\">41</span>:         <span class=\"keyword\">case</span> CONSUME_FROM_TIMESTAMP: &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             <span class=\"keyword\">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"keyword\">if</span> (lastOffset &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">44</span>:                 result = lastOffset;</div><div class=\"line\"><span class=\"number\">45</span>:             &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (-<span class=\"number\">1</span> == lastOffset) &#123;</div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">48</span>:                         result = <span class=\"keyword\">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class=\"line\"><span class=\"number\">49</span>:                     &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"><span class=\"number\">50</span>:                         result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">51</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">52</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">53</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">54</span>:                         <span class=\"keyword\">long</span> timestamp = UtilAll.parseDate(<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),</div><div class=\"line\"><span class=\"number\">55</span>:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();</div><div class=\"line\"><span class=\"number\">56</span>:                         result = <span class=\"keyword\">this</span>.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);</div><div class=\"line\"><span class=\"number\">57</span>:                     &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"><span class=\"number\">58</span>:                         result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">59</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">60</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">61</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">62</span>:                 result = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">63</span>:             &#125;</div><div class=\"line\"><span class=\"number\">64</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">65</span>:         &#125;</div><div class=\"line\"><span class=\"number\">66</span>: </div><div class=\"line\"><span class=\"number\">67</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">68</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">69</span>:     &#125;</div><div class=\"line\"><span class=\"number\">70</span>: </div><div class=\"line\"><span class=\"number\">71</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">72</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—å¼€å§‹æ¶ˆè´¹ä½ç½®ã€‚</li>\n<li><code>PushConsumer</code> è¯»å–æ¶ˆè´¹è¿›åº¦æœ‰ä¸‰ç§é€‰é¡¹ï¼š\n<ul>\n<li><code>CONSUME_FROM_LAST_OFFSET</code> ï¼šç¬¬ 6 è‡³ 29 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>é˜Ÿåˆ—çš„æœ€åä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>\n<li><code>CONSUME_FROM_FIRST_OFFSET</code> ï¼šç¬¬ 30 è‡³ 40 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»é˜Ÿåˆ—çš„<strong>æœ€å‰ä½ç½®</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>\n<li><code>CONSUME_FROM_TIMESTAMP</code> ï¼šç¬¬ 41 è‡³ 65 è¡Œ ï¼šä¸€ä¸ªæ–°çš„æ¶ˆè´¹é›†ç¾¤ç¬¬ä¸€æ¬¡å¯åŠ¨ä»<strong>æŒ‡å®šæ—¶é—´ç‚¹</strong>å¼€å§‹æ¶ˆè´¹ã€‚<strong>åç»­å†å¯åŠ¨æ¥ç€ä¸Šæ¬¡æ¶ˆè´¹çš„è¿›åº¦å¼€å§‹æ¶ˆè´¹</strong>ã€‚</li>\n</ul>\n</li>\n</ul>\n<h2><code>[PullConsumer]</code> RebalancePullImpl#computePullFromWhere(...)</h2>\n<p>æš‚æ—¶è·³è¿‡ã€‚ğŸ˜ˆ</p>\n<h1>6ã€PushConsumer æ‹‰å–æ¶ˆæ¯</h1>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/05.png\" alt=\"DefaultMQPushConsumerImplæ‹‰å–æ¶ˆæ¯\"></p>\n<h2>PullMessageService</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PullMessageService</span> <span class=\"keyword\">extends</span> <span class=\"title\">ServiceThread</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log = ClientLogger.getLog();</div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  4:      * æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—</div><div class=\"line\">  5:      */</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LinkedBlockingQueue&lt;PullRequest&gt; pullRequestQueue = <span class=\"keyword\">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  8:      * MQClientå¯¹è±¡</div><div class=\"line\">  9:      */</div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MQClientInstance mQClientFactory;</div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 12:      * å®šæ—¶å™¨ã€‚ç”¨äºå»¶è¿Ÿæäº¤æ‹‰å–è¯·æ±‚</div><div class=\"line\"> 13:      */</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ScheduledExecutorService scheduledExecutorService = Executors</div><div class=\"line\"> <span class=\"number\">15</span>:         .newSingleThreadScheduledExecutor(<span class=\"keyword\">new</span> ThreadFactory() &#123;</div><div class=\"line\"> <span class=\"number\">16</span>:             <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">17</span>:             <span class=\"function\"><span class=\"keyword\">public</span> Thread <span class=\"title\">newThread</span><span class=\"params\">(Runnable r)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">18</span>:                 <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Thread(r, <span class=\"string\">\"PullMessageServiceScheduledThread\"</span>);</div><div class=\"line\"> <span class=\"number\">19</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">20</span>:         &#125;);</div><div class=\"line\"> <span class=\"number\">21</span>: </div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PullMessageService</span><span class=\"params\">(MQClientInstance mQClientFactory)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">23</span>:         <span class=\"keyword\">this</span>.mQClientFactory = mQClientFactory;</div><div class=\"line\"> <span class=\"number\">24</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">25</span>: </div><div class=\"line\"> <span class=\"number\">26</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 27:      * æ‰§è¡Œå»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 28:      *</div><div class=\"line\"> 29:      * <span class=\"doctag\">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 30:      * <span class=\"doctag\">@param</span> timeDelay å»¶è¿Ÿæ—¶é•¿</div><div class=\"line\"> 31:      */</div><div class=\"line\"> <span class=\"number\">32</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executePullRequestLater</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeDelay)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">33</span>:         <span class=\"keyword\">this</span>.scheduledExecutorService.schedule(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">34</span>: </div><div class=\"line\"> <span class=\"number\">35</span>:             <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">36</span>:             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">37</span>:                 PullMessageService.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"> <span class=\"number\">38</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">39</span>:         &#125;, timeDelay, TimeUnit.MILLISECONDS);</div><div class=\"line\"> <span class=\"number\">40</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">41</span>: </div><div class=\"line\"> <span class=\"number\">42</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 43:      * æ‰§è¡Œç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 44:      *</div><div class=\"line\"> 45:      * <span class=\"doctag\">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 46:      */</div><div class=\"line\"> <span class=\"number\">47</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executePullRequestImmediately</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">48</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">49</span>:             <span class=\"keyword\">this</span>.pullRequestQueue.put(pullRequest);</div><div class=\"line\"> <span class=\"number\">50</span>:         &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">51</span>:             log.error(<span class=\"string\">\"executePullRequestImmediately pullRequestQueue.put\"</span>, e);</div><div class=\"line\"> <span class=\"number\">52</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">53</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">54</span>: </div><div class=\"line\"> <span class=\"number\">55</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 56:      * æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡</div><div class=\"line\"> 57:      *</div><div class=\"line\"> 58:      * <span class=\"doctag\">@param</span> r ä»»åŠ¡</div><div class=\"line\"> 59:      * <span class=\"doctag\">@param</span> timeDelay å»¶è¿Ÿæ—¶é•¿</div><div class=\"line\"> 60:      */</div><div class=\"line\"> <span class=\"number\">61</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">executeTaskLater</span><span class=\"params\">(<span class=\"keyword\">final</span> Runnable r, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeDelay)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">62</span>:         <span class=\"keyword\">this</span>.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);</div><div class=\"line\"> <span class=\"number\">63</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">64</span>: </div><div class=\"line\"> <span class=\"number\">65</span>:     <span class=\"function\"><span class=\"keyword\">public</span> ScheduledExecutorService <span class=\"title\">getScheduledExecutorService</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">66</span>:         <span class=\"keyword\">return</span> scheduledExecutorService;</div><div class=\"line\"> <span class=\"number\">67</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">68</span>: </div><div class=\"line\"> <span class=\"number\">69</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 70:      * æ‹‰å–æ¶ˆæ¯</div><div class=\"line\"> 71:      *</div><div class=\"line\"> 72:      * <span class=\"doctag\">@param</span> pullRequest æ‹‰å–æ¶ˆæ¯è¯·æ±‚</div><div class=\"line\"> 73:      */</div><div class=\"line\"> <span class=\"number\">74</span>:     <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">pullMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"keyword\">final</span> MQConsumerInner consumer = <span class=\"keyword\">this</span>.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">76</span>:         <span class=\"keyword\">if</span> (consumer != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">77</span>:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;</div><div class=\"line\"> <span class=\"number\">78</span>:             impl.pullMessage(pullRequest);</div><div class=\"line\"> <span class=\"number\">79</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">80</span>:             log.warn(<span class=\"string\">\"No matched consumer for the PullRequest &#123;&#125;, drop it\"</span>, pullRequest);</div><div class=\"line\"> <span class=\"number\">81</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">82</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">83</span>: </div><div class=\"line\"> <span class=\"number\">84</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">85</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">86</span>:         log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service started\"</span>);</div><div class=\"line\"> <span class=\"number\">87</span>: </div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">while</span> (!<span class=\"keyword\">this</span>.isStopped()) &#123;</div><div class=\"line\"> <span class=\"number\">89</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">90</span>:                 PullRequest pullRequest = <span class=\"keyword\">this</span>.pullRequestQueue.take();</div><div class=\"line\"> <span class=\"number\">91</span>:                 <span class=\"keyword\">if</span> (pullRequest != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">92</span>:                     <span class=\"keyword\">this</span>.pullMessage(pullRequest);</div><div class=\"line\"> <span class=\"number\">93</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">94</span>:             &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"> <span class=\"number\">95</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"> <span class=\"number\">96</span>:                 log.error(<span class=\"string\">\"Pull Message Service Run Method exception\"</span>, e);</div><div class=\"line\"> <span class=\"number\">97</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">98</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">99</span>: </div><div class=\"line\"><span class=\"number\">100</span>:         log.info(<span class=\"keyword\">this</span>.getServiceName() + <span class=\"string\">\" service end\"</span>);</div><div class=\"line\"><span class=\"number\">101</span>:     &#125;</div><div class=\"line\"><span class=\"number\">102</span>: </div><div class=\"line\"><span class=\"number\">103</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">104</span>:     <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServiceName</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">105</span>:         <span class=\"keyword\">return</span> PullMessageService.class.getSimpleName();</div><div class=\"line\"><span class=\"number\">106</span>:     &#125;</div><div class=\"line\"><span class=\"number\">107</span>: </div><div class=\"line\"><span class=\"number\">108</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æœåŠ¡ï¼Œä¸æ–­ä¸æ–­ä¸æ–­ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤æ¶ˆè´¹ä»»åŠ¡åˆ° <code>ConsumeMessageService</code>ã€‚</li>\n<li><code>#executePullRequestLater(...)</code> ï¼šç¬¬ 26 è‡³ 40 è¡Œ ï¼š æäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li><code>#executePullRequestImmediately(...)</code> ï¼šç¬¬ 42 è‡³ 53 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li><code>#executeTaskLater(...)</code> ï¼šç¬¬ 55 è‡³ 63 è¡Œ ï¼šæäº¤<strong>å»¶è¿Ÿä»»åŠ¡</strong>ã€‚</li>\n<li><code>#pullMessage(...)</code> ï¼šç¬¬ 69 è‡³ 82 è¡Œ ï¼šæ‰§è¡Œæ‹‰å–æ¶ˆæ¯é€»è¾‘ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#defaultmqpushconsumerimplpullmessage\">DefaultMQPushConsumerImpl#pullMessage(...)</a>ã€‚</li>\n<li><code>#run(...)</code> ï¼šç¬¬ 84 è‡³ 101 è¡Œ ï¼šå¾ªç¯æ‹‰å–æ¶ˆæ¯è¯·æ±‚é˜Ÿåˆ—( <code>pullRequestQueue</code> )ï¼Œè¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li>\n</ul>\n<h2>DefaultMQPushConsumerImpl#pullMessage(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">pullMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>:     <span class=\"keyword\">final</span> ProcessQueue processQueue = pullRequest.getProcessQueue();</div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (processQueue.isDropped()) &#123;</div><div class=\"line\">  <span class=\"number\">4</span>:         log.info(<span class=\"string\">\"the pull request[&#123;&#125;] is dropped.\"</span>, pullRequest.toString());</div><div class=\"line\">  <span class=\"number\">5</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\">  <span class=\"number\">6</span>:     &#125;</div><div class=\"line\">  <span class=\"number\">7</span>: </div><div class=\"line\">  <span class=\"number\">8</span>:     <span class=\"comment\">// è®¾ç½®é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´</span></div><div class=\"line\">  <span class=\"number\">9</span>:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());</div><div class=\"line\"> <span class=\"number\">10</span>: </div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"comment\">// åˆ¤æ–­consumerçŠ¶æ€æ˜¯å¦è¿è¡Œä¸­ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯ã€‚</span></div><div class=\"line\"> <span class=\"number\">12</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">13</span>:         <span class=\"keyword\">this</span>.makeSureStateOK();</div><div class=\"line\"> <span class=\"number\">14</span>:     &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"> <span class=\"number\">15</span>:         log.warn(<span class=\"string\">\"pullMessage exception, consumer state not ok\"</span>, e);</div><div class=\"line\"> <span class=\"number\">16</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">18</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">19</span>: </div><div class=\"line\"> <span class=\"number\">20</span>:     <span class=\"comment\">// åˆ¤æ–­æ˜¯å¦æš‚åœä¸­ã€‚</span></div><div class=\"line\"> <span class=\"number\">21</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isPause()) &#123;</div><div class=\"line\"> <span class=\"number\">22</span>:         log.warn(<span class=\"string\">\"consumer was paused, execute pull request later. instanceName=&#123;&#125;, group=&#123;&#125;\"</span>, <span class=\"keyword\">this</span>.defaultMQPushConsumer.getInstanceName(), <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">23</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);</div><div class=\"line\"> <span class=\"number\">24</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">25</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">26</span>: </div><div class=\"line\"> <span class=\"number\">27</span>:     <span class=\"comment\">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æŒæœ‰æ¶ˆæ¯æ•°é‡ã€‚é»˜è®¤æœ€å¤§å€¼ä¸º1000ã€‚</span></div><div class=\"line\"> <span class=\"number\">28</span>:     <span class=\"keyword\">long</span> size = processQueue.getMsgCount().get();</div><div class=\"line\"> <span class=\"number\">29</span>:     <span class=\"keyword\">if</span> (size &gt; <span class=\"keyword\">this</span>.defaultMQPushConsumer.getPullThresholdForQueue()) &#123;</div><div class=\"line\"> <span class=\"number\">30</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class=\"comment\">// æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚</span></div><div class=\"line\"> <span class=\"number\">31</span>:         <span class=\"keyword\">if</span> ((flowControlTimes1++ % <span class=\"number\">1000</span>) == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">32</span>:             log.warn(</div><div class=\"line\"> <span class=\"number\">33</span>:                 <span class=\"string\">\"the consumer message buffer is full, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, size=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">34</span>:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);</div><div class=\"line\"> <span class=\"number\">35</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">36</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">37</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">38</span>: </div><div class=\"line\"> <span class=\"number\">39</span>:     <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.consumeOrderly) &#123; <span class=\"comment\">// åˆ¤æ–­æ¶ˆæ¯è·¨åº¦æ˜¯å¦è¿‡å¤§ã€‚</span></div><div class=\"line\"> <span class=\"number\">40</span>:         <span class=\"keyword\">if</span> (processQueue.getMaxSpan() &gt; <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) &#123;</div><div class=\"line\"> <span class=\"number\">41</span>:             <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class=\"comment\">// æäº¤å»¶è¿Ÿæ¶ˆæ¯æ‹‰å–è¯·æ±‚ã€‚50msã€‚</span></div><div class=\"line\"> <span class=\"number\">42</span>:             <span class=\"keyword\">if</span> ((flowControlTimes2++ % <span class=\"number\">1000</span>) == <span class=\"number\">0</span>) &#123;</div><div class=\"line\"> <span class=\"number\">43</span>:                 log.warn(</div><div class=\"line\"> <span class=\"number\">44</span>:                     <span class=\"string\">\"the queue's messages, span too long, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, maxSpan=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">45</span>:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),</div><div class=\"line\"> <span class=\"number\">46</span>:                     pullRequest, flowControlTimes2);</div><div class=\"line\"> <span class=\"number\">47</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">48</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">49</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">50</span>:     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// TODO é¡ºåºæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">51</span>:         <span class=\"keyword\">if</span> (processQueue.isLocked()) &#123;</div><div class=\"line\"> <span class=\"number\">52</span>:             <span class=\"keyword\">if</span> (!pullRequest.isLockedFirst()) &#123;</div><div class=\"line\"> <span class=\"number\">53</span>:                 <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset = <span class=\"keyword\">this</span>.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());</div><div class=\"line\"> <span class=\"number\">54</span>:                 <span class=\"keyword\">boolean</span> brokerBusy = offset &lt; pullRequest.getNextOffset();</div><div class=\"line\"> <span class=\"number\">55</span>:                 log.info(<span class=\"string\">\"the first time to pull message, so fix offset from broker. pullRequest: &#123;&#125; NewOffset: &#123;&#125; brokerBusy: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">56</span>:                     pullRequest, offset, brokerBusy);</div><div class=\"line\"> <span class=\"number\">57</span>:                 <span class=\"keyword\">if</span> (brokerBusy) &#123;</div><div class=\"line\"> <span class=\"number\">58</span>:                     log.info(<span class=\"string\">\"[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: &#123;&#125; NewOffset: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">59</span>:                         pullRequest, offset);</div><div class=\"line\"> <span class=\"number\">60</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">61</span>: </div><div class=\"line\"> <span class=\"number\">62</span>:                 pullRequest.setLockedFirst(<span class=\"keyword\">true</span>);</div><div class=\"line\"> <span class=\"number\">63</span>:                 pullRequest.setNextOffset(offset);</div><div class=\"line\"> <span class=\"number\">64</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">65</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">66</span>:             <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"> <span class=\"number\">67</span>:             log.info(<span class=\"string\">\"pull message later because not locked in broker, &#123;&#125;\"</span>, pullRequest);</div><div class=\"line\"> <span class=\"number\">68</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">70</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">71</span>: </div><div class=\"line\"> <span class=\"number\">72</span>:     <span class=\"comment\">// è·å–Topic å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">73</span>:     <span class=\"keyword\">final</span> SubscriptionData subscriptionData = <span class=\"keyword\">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class=\"line\"> <span class=\"number\">74</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == subscriptionData) &#123;</div><div class=\"line\"> <span class=\"number\">75</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"> <span class=\"number\">76</span>:         log.warn(<span class=\"string\">\"find the consumer's subscription failed, &#123;&#125;\"</span>, pullRequest);</div><div class=\"line\"> <span class=\"number\">77</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">78</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">79</span>: </div><div class=\"line\"> <span class=\"number\">80</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> beginTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">81</span>: </div><div class=\"line\"> <span class=\"number\">82</span>:     PullCallback pullCallback = <span class=\"keyword\">new</span> PullCallback() &#123;</div><div class=\"line\"> <span class=\"number\">83</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">84</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onSuccess</span><span class=\"params\">(PullResult pullResult)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">85</span>:             <span class=\"keyword\">if</span> (pullResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">86</span>:                 pullResult = DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,</div><div class=\"line\"> <span class=\"number\">87</span>:                     subscriptionData);</div><div class=\"line\"> <span class=\"number\">88</span>: </div><div class=\"line\"> <span class=\"number\">89</span>:                 <span class=\"keyword\">switch</span> (pullResult.getPullStatus()) &#123;</div><div class=\"line\"> <span class=\"number\">90</span>:                     <span class=\"keyword\">case</span> FOUND:</div><div class=\"line\"> <span class=\"number\">91</span>:                         <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class=\"line\"> <span class=\"number\">92</span>:                         <span class=\"keyword\">long</span> prevRequestOffset = pullRequest.getNextOffset();</div><div class=\"line\"> <span class=\"number\">93</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class=\"line\"> <span class=\"number\">94</span>: </div><div class=\"line\"> <span class=\"number\">95</span>:                         <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"> <span class=\"number\">96</span>:                         <span class=\"keyword\">long</span> pullRT = System.currentTimeMillis() - beginTimestamp;</div><div class=\"line\"> <span class=\"number\">97</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),</div><div class=\"line\"> <span class=\"number\">98</span>:                             pullRequest.getMessageQueue().getTopic(), pullRT);</div><div class=\"line\"> <span class=\"number\">99</span>: </div><div class=\"line\"><span class=\"number\">100</span>:                         <span class=\"keyword\">long</span> firstMsgOffset = Long.MAX_VALUE;</div><div class=\"line\"><span class=\"number\">101</span>:                         <span class=\"keyword\">if</span> (pullResult.getMsgFoundList() == <span class=\"keyword\">null</span> || pullResult.getMsgFoundList().isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">102</span>:                             DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">103</span>:                         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">104</span>:                             firstMsgOffset = pullResult.getMsgFoundList().get(<span class=\"number\">0</span>).getQueueOffset();</div><div class=\"line\"><span class=\"number\">105</span>: </div><div class=\"line\"><span class=\"number\">106</span>:                             <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"><span class=\"number\">107</span>:                             DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</div><div class=\"line\"><span class=\"number\">108</span>:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</div><div class=\"line\"><span class=\"number\">109</span>: </div><div class=\"line\"><span class=\"number\">110</span>:                             <span class=\"comment\">// æäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">111</span>:                             <span class=\"keyword\">boolean</span> dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</div><div class=\"line\"><span class=\"number\">112</span>: </div><div class=\"line\"><span class=\"number\">113</span>:                             <span class=\"comment\">// æäº¤æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">114</span>:                             DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.consumeMessageService.submitConsumeRequest(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">115</span>:                                 pullResult.getMsgFoundList(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">116</span>:                                 processQueue, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">117</span>:                                 pullRequest.getMessageQueue(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">118</span>:                                 dispathToConsume);</div><div class=\"line\"><span class=\"number\">119</span>: </div><div class=\"line\"><span class=\"number\">120</span>:                             <span class=\"comment\">// æäº¤ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">121</span>:                             <span class=\"keyword\">if</span> (DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.defaultMQPushConsumer.getPullInterval() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">122</span>:                                 DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestLater(pullRequest,</div><div class=\"line\"><span class=\"number\">123</span>:                                     DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.defaultMQPushConsumer.getPullInterval());</div><div class=\"line\"><span class=\"number\">124</span>:                             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">125</span>:                                 DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">126</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">127</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">128</span>: </div><div class=\"line\"><span class=\"number\">129</span>:                         <span class=\"comment\">// ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸ºBUGï¼Œè¾“å‡ºlog</span></div><div class=\"line\"><span class=\"number\">130</span>:                         <span class=\"keyword\">if</span> (pullResult.getNextBeginOffset() &lt; prevRequestOffset<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">131</span>:                             || firstMsgOffset &lt; prevRequestOffset) &#123;</div><div class=\"line\"><span class=\"number\">132</span>:                             log.warn(</div><div class=\"line\"><span class=\"number\">133</span>:                                 <span class=\"string\">\"[BUG] pull message result maybe data wrong, nextBeginOffset: &#123;&#125; firstMsgOffset: &#123;&#125; prevRequestOffset: &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">134</span>:                                 pullResult.getNextBeginOffset(), <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">135</span>:                                 firstMsgOffset, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">136</span>:                                 prevRequestOffset);</div><div class=\"line\"><span class=\"number\">137</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">138</span>: </div><div class=\"line\"><span class=\"number\">139</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">140</span>:                     <span class=\"keyword\">case</span> NO_NEW_MSG:</div><div class=\"line\"><span class=\"number\">141</span>:                         <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class=\"line\"><span class=\"number\">142</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">143</span>: </div><div class=\"line\"><span class=\"number\">144</span>:                         <span class=\"comment\">// æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">145</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.correctTagsOffset(pullRequest);</div><div class=\"line\"><span class=\"number\">146</span>: </div><div class=\"line\"><span class=\"number\">147</span>:                         <span class=\"comment\">// ç«‹å³æäº¤æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">148</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">149</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">150</span>:                     <span class=\"keyword\">case</span> NO_MATCHED_MSG:</div><div class=\"line\"><span class=\"number\">151</span>:                         <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class=\"line\"><span class=\"number\">152</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">153</span>: </div><div class=\"line\"><span class=\"number\">154</span>:                         <span class=\"comment\">// æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">155</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.correctTagsOffset(pullRequest);</div><div class=\"line\"><span class=\"number\">156</span>: </div><div class=\"line\"><span class=\"number\">157</span>:                         <span class=\"comment\">// æäº¤ç«‹å³æ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">158</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestImmediately(pullRequest);</div><div class=\"line\"><span class=\"number\">159</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">160</span>:                     <span class=\"keyword\">case</span> OFFSET_ILLEGAL:</div><div class=\"line\"><span class=\"number\">161</span>:                         log.warn(<span class=\"string\">\"the pull request offset illegal, &#123;&#125; &#123;&#125;\"</span>, <span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">162</span>:                             pullRequest.toString(), pullResult.toString());</div><div class=\"line\"><span class=\"number\">163</span>:                         <span class=\"comment\">// è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</span></div><div class=\"line\"><span class=\"number\">164</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class=\"line\"><span class=\"number\">165</span>: </div><div class=\"line\"><span class=\"number\">166</span>:                         <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸ºdropped</span></div><div class=\"line\"><span class=\"number\">167</span>:                         pullRequest.getProcessQueue().setDropped(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">168</span>: </div><div class=\"line\"><span class=\"number\">169</span>:                         <span class=\"comment\">// æäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ç§»é™¤ã€‚ä¸ç«‹å³ç§»é™¤çš„åŸå› ï¼šå¯èƒ½æœ‰åœ°æ–¹æ­£åœ¨ä½¿ç”¨ï¼Œé¿å…å—åˆ°å½±å“ã€‚</span></div><div class=\"line\"><span class=\"number\">170</span>:                         DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executeTaskLater(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"><span class=\"number\">171</span>: </div><div class=\"line\"><span class=\"number\">172</span>:                             <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">173</span>:                             <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">174</span>:                                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">175</span>:                                     <span class=\"comment\">// æ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ°Broker</span></div><div class=\"line\"><span class=\"number\">176</span>:                                     DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(),</div><div class=\"line\"><span class=\"number\">177</span>:                                         pullRequest.getNextOffset(), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">178</span>:                                     DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.offsetStore.persist(pullRequest.getMessageQueue());</div><div class=\"line\"><span class=\"number\">179</span>: </div><div class=\"line\"><span class=\"number\">180</span>:                                     <span class=\"comment\">// ç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">181</span>:                                     DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());</div><div class=\"line\"><span class=\"number\">182</span>: </div><div class=\"line\"><span class=\"number\">183</span>:                                     log.warn(<span class=\"string\">\"fix the pull request offset, &#123;&#125;\"</span>, pullRequest);</div><div class=\"line\"><span class=\"number\">184</span>:                                 &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"><span class=\"number\">185</span>:                                     log.error(<span class=\"string\">\"executeTaskLater Exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">186</span>:                                 &#125;</div><div class=\"line\"><span class=\"number\">187</span>:                             &#125;</div><div class=\"line\"><span class=\"number\">188</span>:                         &#125;, <span class=\"number\">10000</span>);</div><div class=\"line\"><span class=\"number\">189</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">190</span>:                     <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">191</span>:                         <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">192</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">193</span>:             &#125;</div><div class=\"line\"><span class=\"number\">194</span>:         &#125;</div><div class=\"line\"><span class=\"number\">195</span>: </div><div class=\"line\"><span class=\"number\">196</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">197</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onException</span><span class=\"params\">(Throwable e)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">198</span>:             <span class=\"keyword\">if</span> (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class=\"line\"><span class=\"number\">199</span>:                 log.warn(<span class=\"string\">\"execute the pull request exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">200</span>:             &#125;</div><div class=\"line\"><span class=\"number\">201</span>: </div><div class=\"line\"><span class=\"number\">202</span>:             <span class=\"comment\">// æäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">203</span>:             DefaultMQPushConsumerImpl.<span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"><span class=\"number\">204</span>:         &#125;</div><div class=\"line\"><span class=\"number\">205</span>:     &#125;;</div><div class=\"line\"><span class=\"number\">206</span>: </div><div class=\"line\"><span class=\"number\">207</span>:     <span class=\"comment\">// é›†ç¾¤æ¶ˆæ¯æ¨¡å‹ä¸‹ï¼Œè®¡ç®—æäº¤çš„æ¶ˆè´¹è¿›åº¦ã€‚</span></div><div class=\"line\"><span class=\"number\">208</span>:     <span class=\"keyword\">boolean</span> commitOffsetEnable = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">209</span>:     <span class=\"keyword\">long</span> commitOffsetValue = <span class=\"number\">0L</span>;</div><div class=\"line\"><span class=\"number\">210</span>:     <span class=\"keyword\">if</span> (MessageModel.CLUSTERING == <span class=\"keyword\">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class=\"line\"><span class=\"number\">211</span>:         commitOffsetValue = <span class=\"keyword\">this</span>.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);</div><div class=\"line\"><span class=\"number\">212</span>:         <span class=\"keyword\">if</span> (commitOffsetValue &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">213</span>:             commitOffsetEnable = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">214</span>:         &#125;</div><div class=\"line\"><span class=\"number\">215</span>:     &#125;</div><div class=\"line\"><span class=\"number\">216</span>: </div><div class=\"line\"><span class=\"number\">217</span>:     <span class=\"comment\">// è®¡ç®—è¯·æ±‚çš„ è®¢é˜…è¡¨è¾¾å¼ å’Œ æ˜¯å¦è¿›è¡Œfiltersrvè¿‡æ»¤æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">218</span>:     String subExpression = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">219</span>:     <span class=\"keyword\">boolean</span> classFilter = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">220</span>:     SubscriptionData sd = <span class=\"keyword\">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class=\"line\"><span class=\"number\">221</span>:     <span class=\"keyword\">if</span> (sd != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">222</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) &#123;</div><div class=\"line\"><span class=\"number\">223</span>:             subExpression = sd.getSubString();</div><div class=\"line\"><span class=\"number\">224</span>:         &#125;</div><div class=\"line\"><span class=\"number\">225</span>: </div><div class=\"line\"><span class=\"number\">226</span>:         classFilter = sd.isClassFilterMode();</div><div class=\"line\"><span class=\"number\">227</span>:     &#125;</div><div class=\"line\"><span class=\"number\">228</span>: </div><div class=\"line\"><span class=\"number\">229</span>:     <span class=\"comment\">// è®¡ç®—æ‹‰å–æ¶ˆæ¯ç³»ç»Ÿæ ‡è¯†</span></div><div class=\"line\"><span class=\"number\">230</span>:     <span class=\"keyword\">int</span> sysFlag = PullSysFlag.buildSysFlag(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">231</span>:         commitOffsetEnable, <span class=\"comment\">// commitOffset</span></div><div class=\"line\"><span class=\"number\">232</span>:         <span class=\"keyword\">true</span>, <span class=\"comment\">// suspend</span></div><div class=\"line\"><span class=\"number\">233</span>:         subExpression != <span class=\"keyword\">null</span>, <span class=\"comment\">// subscription</span></div><div class=\"line\"><span class=\"number\">234</span>:         classFilter <span class=\"comment\">// class filter</span></div><div class=\"line\"><span class=\"number\">235</span>:     );</div><div class=\"line\"><span class=\"number\">236</span>: </div><div class=\"line\"><span class=\"number\">237</span>:     <span class=\"comment\">// æ‰§è¡Œæ‹‰å–ã€‚å¦‚æœæ‹‰å–è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤å»¶è¿Ÿæ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</span></div><div class=\"line\"><span class=\"number\">238</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">239</span>:         <span class=\"keyword\">this</span>.pullAPIWrapper.pullKernelImpl(<span class=\"comment\">//</span></div><div class=\"line\"><span class=\"number\">240</span>:             pullRequest.getMessageQueue(), <span class=\"comment\">// 1</span></div><div class=\"line\"><span class=\"number\">241</span>:             subExpression, <span class=\"comment\">// 2</span></div><div class=\"line\"><span class=\"number\">242</span>:             subscriptionData.getSubVersion(), <span class=\"comment\">// 3</span></div><div class=\"line\"><span class=\"number\">243</span>:             pullRequest.getNextOffset(), <span class=\"comment\">// 4</span></div><div class=\"line\"><span class=\"number\">244</span>:             <span class=\"keyword\">this</span>.defaultMQPushConsumer.getPullBatchSize(), <span class=\"comment\">// 5</span></div><div class=\"line\"><span class=\"number\">245</span>:             sysFlag, <span class=\"comment\">// 6</span></div><div class=\"line\"><span class=\"number\">246</span>:             commitOffsetValue, <span class=\"comment\">// 7</span></div><div class=\"line\"><span class=\"number\">247</span>:             BROKER_SUSPEND_MAX_TIME_MILLIS, <span class=\"comment\">// 8</span></div><div class=\"line\"><span class=\"number\">248</span>:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, <span class=\"comment\">// 9</span></div><div class=\"line\"><span class=\"number\">249</span>:             CommunicationMode.ASYNC, <span class=\"comment\">// 10</span></div><div class=\"line\"><span class=\"number\">250</span>:             pullCallback<span class=\"comment\">// 11</span></div><div class=\"line\"><span class=\"number\">251</span>:         );</div><div class=\"line\"><span class=\"number\">252</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">253</span>:         log.error(<span class=\"string\">\"pullKernelImpl exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">254</span>:         <span class=\"keyword\">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class=\"line\"><span class=\"number\">255</span>:     &#125;</div><div class=\"line\"><span class=\"number\">256</span>: &#125;</div><div class=\"line\"><span class=\"number\">257</span>: </div><div class=\"line\"><span class=\"number\">258</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">correctTagsOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">259</span>:     <span class=\"keyword\">if</span> (<span class=\"number\">0L</span> == pullRequest.getProcessQueue().getMsgCount().get()) &#123;</div><div class=\"line\"><span class=\"number\">260</span>:         <span class=\"keyword\">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">261</span>:     &#125;</div><div class=\"line\"><span class=\"number\">262</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li><code>#pullMessage(...)</code> è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯ã€‚\n<ul>\n<li>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å·²ç»ç»ˆæ­¢ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</li>\n<li>ç¬¬ 9 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœ€åæ‹‰å–æ¶ˆæ¯æ—¶é—´ã€‚</li>\n<li>ç¬¬ 11 è‡³ 18 è¡Œ ï¼š<code>Consumer</code> æœªå¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 20 è‡³ 25 è¡Œ ï¼š <code>Consumer</code> å¤„äºæš‚åœä¸­ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 27 è‡³ 37 è¡Œ ï¼šæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è¶…è¿‡æœ€å¤§å…è®¸å€¼ï¼ˆé»˜è®¤ï¼š1000æ¡ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 39 è‡³ 49 è¡Œ ï¼š<code>Consumer</code> ä¸º<strong>å¹¶å‘æ¶ˆè´¹</strong> å¹¶ä¸” æ¶ˆæ¯é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯è·¨åº¦è¿‡å¤§ï¼ˆæ¶ˆæ¯è·¨åº¦ = æŒæœ‰æ¶ˆæ¯æœ€åä¸€æ¡å’Œç¬¬ä¸€æ¡çš„æ¶ˆæ¯ä½ç½®å·®ï¼Œé»˜è®¤ï¼š2000ï¼‰ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 50 è‡³ 70 è¡Œ ï¼š<code>é¡ºåºæ¶ˆè´¹</code> ç›¸å…³è·³è¿‡ï¼Œè¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Message é¡ºåºå‘é€ä¸æ¶ˆè´¹ã€‹</a>ã€‚</li>\n<li>ç¬¬ 72 è‡³ 78 è¡Œ ï¼š<code>Topic</code> å¯¹åº”çš„è®¢é˜…ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 222 è‡³ 224 è¡Œ ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä½¿ç”¨ <code>Consumer</code> <strong>æœ¬åœ°</strong>çš„è®¢é˜…ä¿¡æ¯( <code>SubscriptionData</code> )ï¼Œè€Œä¸ä½¿ç”¨ <code>Broker</code> é‡Œçš„è®¢é˜…ä¿¡æ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-%E2%80%A6\">PullMessageProcessor#processRequest(...) ç¬¬ 64 è‡³ 110 è¡Œä»£ç </a>ã€‚</li>\n<li>ç¬¬ 226 è¡Œ ï¼šæ˜¯å¦å¼€å¯è¿‡æ»¤ç±»è¿‡æ»¤æ¨¡å¼ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/filtersrv/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” Filtersrvã€‹</a>ã€‚</li>\n<li>ç¬¬ 229 è‡³ 235 è¡Œ ï¼šè®¡ç®—æ‹‰å–æ¶ˆæ¯è¯·æ±‚ç³»ç»Ÿæ ‡è¯†ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageRequestHeader\">PullMessageRequestHeader.sysFlag</a>ã€‚</li>\n<li>ç¬¬ 237 è‡³ 255 è¡Œ ï¼š\n<ul>\n<li>æ‰§è¡Œæ¶ˆæ¯æ‹‰å–<strong>å¼‚æ­¥</strong>è¯·æ±‚ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#pullapiwrapperpullkernelimpl\">PullAPIWrapper#pullKernelImpl(...)</a>ã€‚</li>\n<li>å½“å‘èµ·è¯·æ±‚äº§ç”Ÿå¼‚å¸¸æ—¶ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚å¯¹åº” <code>Broker</code> å¤„ç†æ‹‰å–æ¶ˆæ¯é€»è¾‘è§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-%E2%80%A6\">PullMessageProcessor#processRequest(...)</a>ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>PullCallback</code> ï¼šæ‹‰å–æ¶ˆæ¯å›è°ƒï¼š\n<ul>\n<li>ç¬¬ 86 è¡Œ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚è¯¦ç»†é€»è¾‘è§ï¼š<a href=\"#pullapiwrapperprocesspullresult\">PullAPIWrapper#processPullResult(...)</a>ã€‚</li>\n<li>ç¬¬ 89 è‡³ 192 è¡Œ ï¼šå¤„ç†æ‹‰å–çŠ¶æ€ç»“æœï¼š\n<ul>\n<li>ç¬¬ 90 è‡³ 139 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯( <code>FOUND</code> ) ï¼š\n<ul>\n<li>ç¬¬ 91 è‡³ 93 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>\n<li>ç¬¬ 95 è‡³ 97 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>\n<li>ç¬¬ 101 è‡³ 102 è¡Œ ï¼šæ‹‰å–åˆ°æ¶ˆæ¯çš„æ¶ˆæ¯åˆ—è¡¨ä¸ºç©ºï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆæ¯ç»“æœæœªç©ºå‘¢ï¼ŸåŸå› è§ï¼š<a href=\"#pullapiwrapperprocesspullresult\">PullAPIWrapper#processPullResult(...)</a>ã€‚</li>\n<li>ç¬¬ 106 è‡³ 108 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>\n<li>ç¬¬ 111 è¡Œ ï¼šæäº¤æ‹‰å–åˆ°çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#processqueueputmessage\">ProcessQueue#putMessage(...)</a>ã€‚</li>\n<li>ç¬¬ 113 è‡³ 118 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚åˆ° <code>ConsumeMessageService</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#consumemessageconcurrentlyservice\">ConsumeMessageConcurrentlyService</a>ã€‚</li>\n<li>ç¬¬ 120 è‡³ 126 è¡Œ ï¼šæ ¹æ®æ‹‰å–é¢‘ç‡( <code>pullInterval</code> )ï¼Œæäº¤<strong>ç«‹å³æˆ–è€…å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚é»˜è®¤æ‹‰å–é¢‘ç‡ä¸º 0ms ï¼Œæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 129 è‡³ 137 è¡Œ ï¼šä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½® æˆ–è€… ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®å°äºä¸Šæ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ï¼Œåˆ™åˆ¤å®šä¸º<strong>BUG</strong>ï¼Œè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 140 è‡³ 149 è¡Œ ï¼šæ²¡æœ‰æ–°æ¶ˆæ¯( <code>NO_NEW_MSG</code> ) ï¼š\n<ul>\n<li>ç¬¬ 142 è¡Œ ï¼š è®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>\n<li>ç¬¬ 145 è¡Œ ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚è¯¦ç»†è§£æè§ï¼š<code>#correctTagsOffset(...)</code>ã€‚</li>\n<li>ç¬¬ 148 è¡Œ ï¼šæäº¤<strong>ç«‹å³</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 150 è‡³ 159 è¡Œ ï¼šæœ‰æ–°æ¶ˆæ¯ä½†æ˜¯ä¸åŒ¹é…( <code>NO_MATCHED_MSG</code> )ã€‚é€»è¾‘åŒ <code>NO_NEW_MSG</code> ã€‚</li>\n<li>ç¬¬ 160 è‡³ 189 è¡Œ ï¼šæ‹‰å–è¯·æ±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ä¸åˆæ³• (<code>OFFSET_ILLEGAL</code>)ã€‚\n<ul>\n<li>ç¬¬ 164 è¡Œ ï¼šè®¾ç½®ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>\n<li>ç¬¬ 167 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸º <code>dropped</code>ã€‚</li>\n<li>ç¬¬ 169 è‡³ 188 è¡Œ ï¼šæäº¤å»¶è¿Ÿä»»åŠ¡ï¼Œè¿›è¡Œé˜Ÿåˆ—ç§»é™¤ã€‚\n<ul>\n<li>ç¬¬ 175 è‡³ 178 è¡Œ ï¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼ŒåŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ã€‚</li>\n<li>ç¬¬ 181 è¡Œ ï¼šç§»é™¤æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—ã€‚\n<ul>\n<li>ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ç«‹å³ç§»é™¤ï¼Ÿï¼Ÿï¼Ÿ</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ç¬¬ 196 è‡³ 204 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œæäº¤<strong>å»¶è¿Ÿ</strong>æ‹‰å–æ¶ˆæ¯è¯·æ±‚ã€‚</li>\n</ul>\n</li>\n<li><code>#correctTagsOffset(...)</code> ï¼šæ›´æ­£æ¶ˆè´¹è¿›åº¦ã€‚\n<ul>\n<li>ç¬¬ 258 è‡³ 261 è¡Œ ï¼š å½“æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—æŒæœ‰æ¶ˆæ¯æ•°é‡ä¸º <strong>0</strong> æ—¶ï¼Œæ›´æ–°æ¶ˆè´¹è¿›åº¦ä¸ºæ‹‰å–è¯·æ±‚çš„æ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3>PullAPIWrapper#pullKernelImpl(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> subExpression è®¢é˜…è¡¨è¾¾å¼</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> subVersion è®¢é˜…ç‰ˆæœ¬å·</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> offset æ‹‰å–é˜Ÿåˆ—å¼€å§‹ä½ç½®</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> maxNums æ‹‰å–æ¶ˆæ¯æ•°é‡</div><div class=\"line\"> 9:  * <span class=\"doctag\">@param</span> sysFlag æ‹‰å–è¯·æ±‚ç³»ç»Ÿæ ‡è¯†</div><div class=\"line\">10:  * <span class=\"doctag\">@param</span> commitOffset æäº¤æ¶ˆè´¹è¿›åº¦</div><div class=\"line\">11:  * <span class=\"doctag\">@param</span> brokerSuspendMaxTimeMillis brokeræŒ‚èµ·è¯·æ±‚æœ€å¤§æ—¶é—´</div><div class=\"line\">12:  * <span class=\"doctag\">@param</span> timeoutMillis è¯·æ±‚brokerè¶…æ—¶æ—¶é•¿</div><div class=\"line\">13:  * <span class=\"doctag\">@param</span> communicationMode é€šè®¯æ¨¡å¼</div><div class=\"line\">14:  * <span class=\"doctag\">@param</span> pullCallback æ‹‰å–å›è°ƒ</div><div class=\"line\">15:  * <span class=\"doctag\">@return</span> æ‹‰å–æ¶ˆæ¯ç»“æœã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶ï¼Œæ‰è¿”å›ç»“æœï¼Œå¦åˆ™è¿”å›nullã€‚</div><div class=\"line\">16:  * <span class=\"doctag\">@throws</span> MQClientException å½“å¯»æ‰¾ä¸åˆ° broker æ—¶ï¼Œæˆ–å‘ç”Ÿå…¶ä»–clientå¼‚å¸¸</div><div class=\"line\">17:  * <span class=\"doctag\">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">18:  * <span class=\"doctag\">@throws</span> MQBrokerException å½“ broker å‘ç”Ÿå¼‚å¸¸æ—¶ã€‚åªæœ‰é€šè®¯æ¨¡å¼ä¸ºåŒæ­¥æ—¶æ‰ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚</div><div class=\"line\">19:  * <span class=\"doctag\">@throws</span> InterruptedException å½“å‘ç”Ÿä¸­æ–­å¼‚å¸¸æ—¶</div><div class=\"line\">20:  */</div><div class=\"line\"><span class=\"number\">21</span>: <span class=\"function\"><span class=\"keyword\">protected</span> PullResult <span class=\"title\">pullKernelImpl</span><span class=\"params\">(</span></span></div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">final</span> MessageQueue mq,</div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"keyword\">final</span> String subExpression,</div><div class=\"line\"><span class=\"number\">24</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> subVersion,</div><div class=\"line\"><span class=\"number\">25</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> offset,</div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxNums,</div><div class=\"line\"><span class=\"number\">27</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> sysFlag,</div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> commitOffset,</div><div class=\"line\"><span class=\"number\">29</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> brokerSuspendMaxTimeMillis,</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeoutMillis,</div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"keyword\">final</span> CommunicationMode communicationMode,</div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"keyword\">final</span> PullCallback pullCallback</div><div class=\"line\"><span class=\"number\">33</span>: ) <span class=\"keyword\">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">// è·å–Brokerä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">35</span>:     FindBrokerResult findBrokerResult =</div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">this</span>.recalculatePullFromWhichNode(mq), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == findBrokerResult) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:         <span class=\"keyword\">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());</div><div class=\"line\"><span class=\"number\">40</span>:         findBrokerResult =</div><div class=\"line\"><span class=\"number\">41</span>:             <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class=\"line\"><span class=\"number\">42</span>:                 <span class=\"keyword\">this</span>.recalculatePullFromWhichNode(mq), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"comment\">// è¯·æ±‚æ‹‰å–æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">if</span> (findBrokerResult != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:         <span class=\"keyword\">int</span> sysFlagInner = sysFlag;</div><div class=\"line\"><span class=\"number\">48</span>: </div><div class=\"line\"><span class=\"number\">49</span>:         <span class=\"keyword\">if</span> (findBrokerResult.isSlave()) &#123;</div><div class=\"line\"><span class=\"number\">50</span>:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);</div><div class=\"line\"><span class=\"number\">51</span>:         &#125;</div><div class=\"line\"><span class=\"number\">52</span>: </div><div class=\"line\"><span class=\"number\">53</span>:         PullMessageRequestHeader requestHeader = <span class=\"keyword\">new</span> PullMessageRequestHeader();</div><div class=\"line\"><span class=\"number\">54</span>:         requestHeader.setConsumerGroup(<span class=\"keyword\">this</span>.consumerGroup);</div><div class=\"line\"><span class=\"number\">55</span>:         requestHeader.setTopic(mq.getTopic());</div><div class=\"line\"><span class=\"number\">56</span>:         requestHeader.setQueueId(mq.getQueueId());</div><div class=\"line\"><span class=\"number\">57</span>:         requestHeader.setQueueOffset(offset);</div><div class=\"line\"><span class=\"number\">58</span>:         requestHeader.setMaxMsgNums(maxNums);</div><div class=\"line\"><span class=\"number\">59</span>:         requestHeader.setSysFlag(sysFlagInner);</div><div class=\"line\"><span class=\"number\">60</span>:         requestHeader.setCommitOffset(commitOffset);</div><div class=\"line\"><span class=\"number\">61</span>:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);</div><div class=\"line\"><span class=\"number\">62</span>:         requestHeader.setSubscription(subExpression);</div><div class=\"line\"><span class=\"number\">63</span>:         requestHeader.setSubVersion(subVersion);</div><div class=\"line\"><span class=\"number\">64</span>: </div><div class=\"line\"><span class=\"number\">65</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class=\"line\"><span class=\"number\">66</span>:         <span class=\"keyword\">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123; <span class=\"comment\">// TODO filtersrv</span></div><div class=\"line\"><span class=\"number\">67</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class=\"line\"><span class=\"number\">68</span>:         &#125;</div><div class=\"line\"><span class=\"number\">69</span>: </div><div class=\"line\"><span class=\"number\">70</span>:         PullResult pullResult = <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class=\"line\"><span class=\"number\">71</span>:             brokerAddr,</div><div class=\"line\"><span class=\"number\">72</span>:             requestHeader,</div><div class=\"line\"><span class=\"number\">73</span>:             timeoutMillis,</div><div class=\"line\"><span class=\"number\">74</span>:             communicationMode,</div><div class=\"line\"><span class=\"number\">75</span>:             pullCallback);</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:         <span class=\"keyword\">return</span> pullResult;</div><div class=\"line\"><span class=\"number\">78</span>:     &#125;</div><div class=\"line\"><span class=\"number\">79</span>: </div><div class=\"line\"><span class=\"number\">80</span>:     <span class=\"comment\">// Brokerä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">81</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQClientException(<span class=\"string\">\"The broker[\"</span> + mq.getBrokerName() + <span class=\"string\">\"] not exist\"</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">82</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ‹‰å–æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•ã€‚<strong>è¯¥æ–¹æ³•å‚æ•°è¾ƒå¤šï¼Œå¯ä»¥çœ‹ä¸‹ä»£ç æ³¨é‡Šä¸Šæ¯ä¸ªå‚æ•°çš„è¯´æ˜</strong>ğŸ˜ˆã€‚</li>\n<li>ç¬¬ 34 è‡³ 43 è¡Œ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚\n<ul>\n<li><a href=\"#pullapiwrapperrecalculatepullfromwhichnode\">#recalculatePullFromWhichNode(...)</a></li>\n<li><a href=\"#mqclientinstancefindbrokeraddressinsubscribe\">#MQClientInstance#findBrokerAddressInSubscribe(...)</a></li>\n</ul>\n</li>\n<li>ç¬¬ 45 è‡³ 78 è¡Œ ï¼š<strong>è¯·æ±‚æ‹‰å–æ¶ˆæ¯</strong>ã€‚</li>\n<li>ç¬¬ 81 è¡Œ ï¼šå½“ <code>Broker</code> ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>\n</ul>\n<h4>PullAPIWrapper#recalculatePullFromWhichNode(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ¶ˆæ¯é˜Ÿåˆ— ä¸ æ‹‰å–Broker çš„æ˜ å°„</div><div class=\"line\"> 3:  * å½“æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œä¼šé€šè¿‡è¯¥æ˜ å°„è·å–æ‹‰å–è¯·æ±‚å¯¹åº”çš„Broker</div><div class=\"line\"> 4:  */</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"keyword\">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong<span class=\"comment\">/* brokerId */</span>&gt; pullFromWhichNodeTable =</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">new</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt;(<span class=\"number\">32</span>);</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 8:  * æ˜¯å¦ä½¿ç”¨é»˜è®¤Broker</div><div class=\"line\"> 9:  */</div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">boolean</span> connectBrokerByUser = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"comment\">/**</span></div><div class=\"line\">12:  * é»˜è®¤Brokerç¼–å·</div><div class=\"line\">13:  */</div><div class=\"line\"><span class=\"number\">14</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> defaultBrokerId = MixAll.MASTER_ID;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>: <span class=\"comment\">/**</span></div><div class=\"line\">17:  * è®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„Brokerç¼–å·</div><div class=\"line\">18:  *</div><div class=\"line\">19:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\">20:  * <span class=\"doctag\">@return</span> Brokerç¼–å·</div><div class=\"line\">21:  */</div><div class=\"line\"><span class=\"number\">22</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">recalculatePullFromWhichNode</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">23</span>:     <span class=\"comment\">// è‹¥å¼€å¯é»˜è®¤Brokerå¼€å…³ï¼Œåˆ™è¿”å›é»˜è®¤Brokerç¼–å·</span></div><div class=\"line\"><span class=\"number\">24</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isConnectBrokerByUser()) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.defaultBrokerId;</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: </div><div class=\"line\"><span class=\"number\">28</span>:     <span class=\"comment\">// è‹¥æ¶ˆæ¯é˜Ÿåˆ—æ˜ å°„æ‹‰å–Brokerå­˜åœ¨ï¼Œåˆ™è¿”å›æ˜ å°„Brokerç¼–å·</span></div><div class=\"line\"><span class=\"number\">29</span>:     AtomicLong suggest = <span class=\"keyword\">this</span>.pullFromWhichNodeTable.get(mq);</div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">if</span> (suggest != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"keyword\">return</span> suggest.get();</div><div class=\"line\"><span class=\"number\">32</span>:     &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">// è¿”å›Brokerä¸»èŠ‚ç‚¹ç¼–å·</span></div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"keyword\">return</span> MixAll.MASTER_ID;</div><div class=\"line\"><span class=\"number\">36</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šè®¡ç®—æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯å¯¹åº”çš„ <code>Broker</code> ç¼–å·ã€‚</li>\n</ul>\n<h4>MQClientInstance#findBrokerAddressInSubscribe(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * Brokeråå­— å’Œ Brokeråœ°å€ç›¸å…³ Map</div><div class=\"line\"> 3:  */</div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConcurrentHashMap&lt;String<span class=\"comment\">/* Broker Name */</span>, HashMap&lt;Long<span class=\"comment\">/* brokerId */</span>, String<span class=\"comment\">/* address */</span>&gt;&gt; brokerAddrTable =</div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 8:  * è·å¾—Brokerä¿¡æ¯</div><div class=\"line\"> 9:  *</div><div class=\"line\">10:  * <span class=\"doctag\">@param</span> brokerName brokeråå­—</div><div class=\"line\">11:  * <span class=\"doctag\">@param</span> brokerId brokerç¼–å·</div><div class=\"line\">12:  * <span class=\"doctag\">@param</span> onlyThisBroker æ˜¯å¦å¿…é¡»æ˜¯è¯¥broker</div><div class=\"line\">13:  * <span class=\"doctag\">@return</span> Brokerä¿¡æ¯</div><div class=\"line\">14:  */</div><div class=\"line\"><span class=\"number\">15</span>: <span class=\"function\"><span class=\"keyword\">public</span> FindBrokerResult <span class=\"title\">findBrokerAddressInSubscribe</span><span class=\"params\">(//</span></span></div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">final</span> String brokerName, //</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> brokerId, //</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> onlyThisBroker//</div><div class=\"line\"><span class=\"number\">19</span>: ) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:     String brokerAddr = <span class=\"keyword\">null</span>; <span class=\"comment\">// brokeråœ°å€</span></div><div class=\"line\"><span class=\"number\">21</span>:     <span class=\"keyword\">boolean</span> slave = <span class=\"keyword\">false</span>; <span class=\"comment\">// æ˜¯å¦ä¸ºä»èŠ‚ç‚¹</span></div><div class=\"line\"><span class=\"number\">22</span>:     <span class=\"keyword\">boolean</span> found = <span class=\"keyword\">false</span>; <span class=\"comment\">// æ˜¯å¦æ‰¾åˆ°</span></div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:     <span class=\"comment\">// è·å¾—Brokerä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">25</span>:     HashMap&lt;Long<span class=\"comment\">/* brokerId */</span>, String<span class=\"comment\">/* address */</span>&gt; map = <span class=\"keyword\">this</span>.brokerAddrTable.get(brokerName);</div><div class=\"line\"><span class=\"number\">26</span>:     <span class=\"keyword\">if</span> (map != <span class=\"keyword\">null</span> &amp;&amp; !map.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:         brokerAddr = map.get(brokerId);</div><div class=\"line\"><span class=\"number\">28</span>:         slave = brokerId != MixAll.MASTER_ID;</div><div class=\"line\"><span class=\"number\">29</span>:         found = brokerAddr != <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:         <span class=\"comment\">// å¦‚æœä¸å¼ºåˆ¶è·å¾—ï¼Œé€‰æ‹©ä¸€ä¸ªBroker</span></div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"keyword\">if</span> (!found &amp;&amp; !onlyThisBroker) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:             Entry&lt;Long, String&gt; entry = map.entrySet().iterator().next();</div><div class=\"line\"><span class=\"number\">34</span>:             brokerAddr = entry.getValue();</div><div class=\"line\"><span class=\"number\">35</span>:             slave = entry.getKey() != MixAll.MASTER_ID;</div><div class=\"line\"><span class=\"number\">36</span>:             found = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">37</span>:         &#125;</div><div class=\"line\"><span class=\"number\">38</span>:     &#125;</div><div class=\"line\"><span class=\"number\">39</span>: </div><div class=\"line\"><span class=\"number\">40</span>:     <span class=\"comment\">// æ‰¾åˆ°brokerï¼Œåˆ™è¿”å›ä¿¡æ¯</span></div><div class=\"line\"><span class=\"number\">41</span>:     <span class=\"keyword\">if</span> (found) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> FindBrokerResult(brokerAddr, slave);</div><div class=\"line\"><span class=\"number\">43</span>:     &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:     <span class=\"comment\">// æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å›ç©º</span></div><div class=\"line\"><span class=\"number\">46</span>:     <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">47</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šè·å– <code>Broker</code> ä¿¡æ¯(<code>Broker</code> åœ°å€ã€æ˜¯å¦ä¸ºä»èŠ‚ç‚¹)ã€‚</li>\n</ul>\n<h3>PullAPIWrapper#processPullResult(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * å¤„ç†æ‹‰å–ç»“æœ</div><div class=\"line\"> 3:  * 1. æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„</div><div class=\"line\"> 4:  * 2. è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</div><div class=\"line\"> 5:  *</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> mq æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> pullResult æ‹‰å–ç»“æœ</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> subscriptionData è®¢é˜…ä¿¡æ¯</div><div class=\"line\"> 9:  * <span class=\"doctag\">@return</span> æ‹‰å–ç»“æœ</div><div class=\"line\">10:  */</div><div class=\"line\"><span class=\"number\">11</span>: <span class=\"function\"><span class=\"keyword\">public</span> PullResult <span class=\"title\">processPullResult</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq, <span class=\"keyword\">final</span> PullResult pullResult,</span></span></div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> SubscriptionData subscriptionData) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:     PullResultExt pullResultExt = (PullResultExt) pullResult;</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"comment\">// æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯Brokerç¼–å·çš„æ˜ å°„</span></div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">this</span>.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"comment\">// è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">if</span> (PullStatus.FOUND == pullResult.getPullStatus()) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:         <span class=\"comment\">// è§£ææ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">21</span>:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());</div><div class=\"line\"><span class=\"number\">22</span>:         List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"comment\">// æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯tagCodeåŒ¹é…åˆé€‚æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">25</span>:         List&lt;MessageExt&gt; msgListFilterAgain = msgList;</div><div class=\"line\"><span class=\"number\">26</span>:         <span class=\"keyword\">if</span> (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:             msgListFilterAgain = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(msgList.size());</div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"keyword\">for</span> (MessageExt msg : msgList) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:                 <span class=\"keyword\">if</span> (msg.getTags() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">30</span>:                     <span class=\"keyword\">if</span> (subscriptionData.getTagsSet().contains(msg.getTags())) &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                         msgListFilterAgain.add(msg);</div><div class=\"line\"><span class=\"number\">32</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">33</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">34</span>:             &#125;</div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>: </div><div class=\"line\"><span class=\"number\">37</span>:         <span class=\"comment\">// Hook</span></div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasHook()) &#123;</div><div class=\"line\"><span class=\"number\">39</span>:             FilterMessageContext filterMessageContext = <span class=\"keyword\">new</span> FilterMessageContext();</div><div class=\"line\"><span class=\"number\">40</span>:             filterMessageContext.setUnitMode(unitMode);</div><div class=\"line\"><span class=\"number\">41</span>:             filterMessageContext.setMsgList(msgListFilterAgain);</div><div class=\"line\"><span class=\"number\">42</span>:             <span class=\"keyword\">this</span>.executeHook(filterMessageContext);</div><div class=\"line\"><span class=\"number\">43</span>:         &#125;</div><div class=\"line\"><span class=\"number\">44</span>: </div><div class=\"line\"><span class=\"number\">45</span>:         <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µ</span></div><div class=\"line\"><span class=\"number\">46</span>:         <span class=\"keyword\">for</span> (MessageExt msg : msgListFilterAgain) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,</div><div class=\"line\"><span class=\"number\">48</span>:                 Long.toString(pullResult.getMinOffset()));</div><div class=\"line\"><span class=\"number\">49</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,</div><div class=\"line\"><span class=\"number\">50</span>:                 Long.toString(pullResult.getMaxOffset()));</div><div class=\"line\"><span class=\"number\">51</span>:         &#125;</div><div class=\"line\"><span class=\"number\">52</span>: </div><div class=\"line\"><span class=\"number\">53</span>:         <span class=\"comment\">// è®¾ç½®æ¶ˆæ¯åˆ—è¡¨</span></div><div class=\"line\"><span class=\"number\">54</span>:         pullResultExt.setMsgFoundList(msgListFilterAgain);</div><div class=\"line\"><span class=\"number\">55</span>:     &#125;</div><div class=\"line\"><span class=\"number\">56</span>: </div><div class=\"line\"><span class=\"number\">57</span>:     <span class=\"comment\">// æ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„</span></div><div class=\"line\"><span class=\"number\">58</span>:     pullResultExt.setMessageBinary(<span class=\"keyword\">null</span>);</div><div class=\"line\"><span class=\"number\">59</span>: </div><div class=\"line\"><span class=\"number\">60</span>:     <span class=\"keyword\">return</span> pullResult;</div><div class=\"line\"><span class=\"number\">61</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå¤„ç†æ‹‰å–ç»“æœã€‚\n<ul>\n<li>æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚</li>\n<li>è§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code>åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 16 è¡Œ ï¼šæ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–æ¶ˆæ¯ <code>Broker</code> ç¼–å·çš„æ˜ å°„ã€‚ä¸‹æ¬¡æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæœªè®¾ç½®é»˜è®¤æ‹‰å–çš„ <code>Broker</code> ç¼–å·ï¼Œä¼šä½¿ç”¨æ›´æ–°åçš„ <code>Broker</code> ç¼–å·ã€‚</li>\n<li>ç¬¬ 18 è‡³ 55 è¡Œ ï¼šè§£ææ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è®¢é˜…ä¿¡æ¯æ¶ˆæ¯ <code>tagCode</code> åŒ¹é…åˆé€‚æ¶ˆæ¯ã€‚\n<ul>\n<li>ç¬¬ 20 è‡³ 22 è¡Œ ï¼šè§£ææ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"http://www.yunai.me/RocketMQ/message/\">ã€ŠRocketMQ æºç åˆ†æ â€”â€” MessageåŸºç¡€ã€‹</a> ã€‚</li>\n<li>ç¬¬ 24 è‡³ 35 è¡Œ ï¼šæ ¹æ®è®¢é˜…ä¿¡æ¯<code>tagCode</code> åŒ¹é…æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 37 è‡³ 43 è¡Œ ï¼š<code>Hook</code>ã€‚</li>\n<li>ç¬¬ 45 è‡³ 51 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—å½“å‰æœ€å°/æœ€å¤§ä½ç½®åˆ°æ¶ˆæ¯æ‹“å±•å­—æ®µã€‚</li>\n<li>ç¬¬ 54 è¡Œ ï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬ 58 è¡Œ ï¼šæ¸…ç©ºæ¶ˆæ¯äºŒè¿›åˆ¶æ•°ç»„ã€‚</li>\n</ul>\n<h3>ProcessQueue#putMessage(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>:  <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ¶ˆæ¯æ˜ å°„è¯»å†™é”</div><div class=\"line\"> 3:  */</div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ReadWriteLock lockTreeMap = <span class=\"keyword\">new</span> ReentrantReadWriteLock();</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 6:  * æ¶ˆæ¯æ˜ å°„</div><div class=\"line\"> 7:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class=\"line\"> 8:  */</div><div class=\"line\"> <span class=\"number\">9</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class=\"keyword\">new</span> TreeMap&lt;&gt;();</div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"comment\">/**</span></div><div class=\"line\">11:  * æ¶ˆæ¯æ•°</div><div class=\"line\">12:  */</div><div class=\"line\"><span class=\"number\">13</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AtomicLong msgCount = <span class=\"keyword\">new</span> AtomicLong();</div><div class=\"line\"><span class=\"number\">14</span>: <span class=\"comment\">/**</span></div><div class=\"line\">15:  * æ·»åŠ æ¶ˆæ¯æœ€å¤§é˜Ÿåˆ—ä½ç½®</div><div class=\"line\">16:  */</div><div class=\"line\"><span class=\"number\">17</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> queueOffsetMax = <span class=\"number\">0L</span>;</div><div class=\"line\"><span class=\"number\">18</span>: <span class=\"comment\">/**</span></div><div class=\"line\">19:  * æ˜¯å¦æ­£åœ¨æ¶ˆè´¹</div><div class=\"line\">20:  */</div><div class=\"line\"><span class=\"number\">21</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">boolean</span> consuming = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">22</span>: <span class=\"comment\">/**</span></div><div class=\"line\">23:  * Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡</div><div class=\"line\">24:  * è®¡ç®—å…¬å¼ = queueMaxOffset - æ–°æ·»åŠ æ¶ˆæ¯æ•°ç»„[n - 1].queueOffset</div><div class=\"line\">25:  * Acc = Accumulation</div><div class=\"line\">26:  * cnt = ï¼ˆçŒœæµ‹ï¼‰å¯¹æ¯”åº¦</div><div class=\"line\">27:  */</div><div class=\"line\"><span class=\"number\">28</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> msgAccCnt = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>: <span class=\"comment\">/**</span></div><div class=\"line\">31:  * æ·»åŠ æ¶ˆæ¯ï¼Œå¹¶è¿”å›æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…</div><div class=\"line\">32:  * è¿”å›trueï¼Œå½“æœ‰æ–°æ¶ˆæ¯æ·»åŠ æˆåŠŸæ—¶ï¼Œ</div><div class=\"line\">33:  *</div><div class=\"line\">34:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\">35:  * <span class=\"doctag\">@return</span> æ˜¯å¦æäº¤ç»™æ¶ˆè´¹è€…</div><div class=\"line\">36:  */</div><div class=\"line\"><span class=\"number\">37</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">putMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"keyword\">boolean</span> dispatchToConsume = <span class=\"keyword\">false</span>;</div><div class=\"line\"><span class=\"number\">39</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">40</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"><span class=\"number\">41</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">42</span>:             <span class=\"comment\">// æ·»åŠ æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"keyword\">int</span> validMsgCnt = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">44</span>:             <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"><span class=\"number\">45</span>:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class=\"line\"><span class=\"number\">46</span>:                 <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == old) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:                     validMsgCnt++;</div><div class=\"line\"><span class=\"number\">48</span>:                     <span class=\"keyword\">this</span>.queueOffsetMax = msg.getQueueOffset();</div><div class=\"line\"><span class=\"number\">49</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">50</span>:             &#125;</div><div class=\"line\"><span class=\"number\">51</span>:             msgCount.addAndGet(validMsgCnt);</div><div class=\"line\"><span class=\"number\">52</span>: </div><div class=\"line\"><span class=\"number\">53</span>:             <span class=\"comment\">// è®¡ç®—æ˜¯å¦æ­£åœ¨æ¶ˆè´¹</span></div><div class=\"line\"><span class=\"number\">54</span>:             <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty() &amp;&amp; !<span class=\"keyword\">this</span>.consuming) &#123;</div><div class=\"line\"><span class=\"number\">55</span>:                 dispatchToConsume = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">56</span>:                 <span class=\"keyword\">this</span>.consuming = <span class=\"keyword\">true</span>;</div><div class=\"line\"><span class=\"number\">57</span>:             &#125;</div><div class=\"line\"><span class=\"number\">58</span>: </div><div class=\"line\"><span class=\"number\">59</span>:             <span class=\"comment\">// Brokerç´¯è®¡æ¶ˆæ¯æ•°é‡</span></div><div class=\"line\"><span class=\"number\">60</span>:             <span class=\"keyword\">if</span> (!msgs.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">61</span>:                 MessageExt messageExt = msgs.get(msgs.size() - <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">62</span>:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);</div><div class=\"line\"><span class=\"number\">63</span>:                 <span class=\"keyword\">if</span> (property != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">64</span>:                     <span class=\"keyword\">long</span> accTotal = Long.parseLong(property) - messageExt.getQueueOffset();</div><div class=\"line\"><span class=\"number\">65</span>:                     <span class=\"keyword\">if</span> (accTotal &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\"><span class=\"number\">66</span>:                         <span class=\"keyword\">this</span>.msgAccCnt = accTotal;</div><div class=\"line\"><span class=\"number\">67</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">68</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">69</span>:             &#125;</div><div class=\"line\"><span class=\"number\">70</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">71</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"><span class=\"number\">72</span>:         &#125;</div><div class=\"line\"><span class=\"number\">73</span>:     &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">74</span>:         log.error(<span class=\"string\">\"putMessage exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">75</span>:     &#125;</div><div class=\"line\"><span class=\"number\">76</span>: </div><div class=\"line\"><span class=\"number\">77</span>:     <span class=\"keyword\">return</span> dispatchToConsume;</div><div class=\"line\"><span class=\"number\">78</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h2>æ€»ç»“</h2>\n<p>å¦‚æœç”¨æœ€ç®€å•ç²—æš´çš„æ–¹å¼æè¿° <code>PullConsumer</code> æ‹‰å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œé‚£å°±æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (ä¸æ»¡è¶³æ‹‰å–æ¶ˆæ¯) &#123;</div><div class=\"line\">        Thread.sleep(é—´éš”);</div><div class=\"line\">        <span class=\"keyword\">continue</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h1>6ã€PushConsumer æ¶ˆè´¹æ¶ˆæ¯</h1>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/06.png\" alt=\"DefaultMQPushConsumerImplæ¶ˆè´¹æ¶ˆæ¯\"></p>\n<h2>ConsumeMessageConcurrentlyService æäº¤æ¶ˆè´¹è¯·æ±‚</h2>\n<h3>ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æ¶ˆè´¹çº¿ç¨‹æ± é˜Ÿåˆ—</div><div class=\"line\"> 3:  */</div><div class=\"line\"> <span class=\"number\">4</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> BlockingQueue&lt;Runnable&gt; consumeRequestQueue;</div><div class=\"line\"> <span class=\"number\">5</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 6:  * æ¶ˆè´¹çº¿ç¨‹æ± </div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadPoolExecutor consumeExecutor;</div><div class=\"line\"> <span class=\"number\">9</span>: </div><div class=\"line\"><span class=\"number\">10</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">submitConsumeRequest</span><span class=\"params\">(//</span></span></div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs, //</div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"keyword\">final</span> ProcessQueue processQueue, //</div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">final</span> MessageQueue messageQueue, //</div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> dispatchToConsume) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> consumeBatchSize = <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">if</span> (msgs.size() &lt;= consumeBatchSize) &#123; <span class=\"comment\">// æäº¤æ¶ˆæ¯å°äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">17</span>:         ConsumeRequest consumeRequest = <span class=\"keyword\">new</span> ConsumeRequest(msgs, processQueue, messageQueue);</div><div class=\"line\"><span class=\"number\">18</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">this</span>.consumeExecutor.submit(consumeRequest);</div><div class=\"line\"><span class=\"number\">20</span>:         &#125; <span class=\"keyword\">catch</span> (RejectedExecutionException e) &#123;</div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"keyword\">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class=\"line\"><span class=\"number\">22</span>:         &#125;</div><div class=\"line\"><span class=\"number\">23</span>:     &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆæ¯æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªæ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> total = <span class=\"number\">0</span>; total &lt; msgs.size(); ) &#123;</div><div class=\"line\"><span class=\"number\">25</span>:             <span class=\"comment\">// è®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">26</span>:             List&lt;MessageExt&gt; msgThis = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(consumeBatchSize);</div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; consumeBatchSize; i++, total++) &#123;</div><div class=\"line\"><span class=\"number\">28</span>:                 <span class=\"keyword\">if</span> (total &lt; msgs.size()) &#123;</div><div class=\"line\"><span class=\"number\">29</span>:                     msgThis.add(msgs.get(total));</div><div class=\"line\"><span class=\"number\">30</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">31</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">32</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">33</span>:             &#125;</div><div class=\"line\"><span class=\"number\">34</span>: </div><div class=\"line\"><span class=\"number\">35</span>:             <span class=\"comment\">// æäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚</span></div><div class=\"line\"><span class=\"number\">36</span>:             ConsumeRequest consumeRequest = <span class=\"keyword\">new</span> ConsumeRequest(msgThis, processQueue, messageQueue);</div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                 <span class=\"keyword\">this</span>.consumeExecutor.submit(consumeRequest);</div><div class=\"line\"><span class=\"number\">39</span>:             &#125; <span class=\"keyword\">catch</span> (RejectedExecutionException e) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                 <span class=\"comment\">// å¦‚æœè¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯+å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</span></div><div class=\"line\"><span class=\"number\">41</span>:                 <span class=\"keyword\">for</span> (; total &lt; msgs.size(); total++) &#123;</div><div class=\"line\"><span class=\"number\">42</span>:                     msgThis.add(msgs.get(total));</div><div class=\"line\"><span class=\"number\">43</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">44</span>:                 <span class=\"keyword\">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class=\"line\"><span class=\"number\">45</span>:             &#125;</div><div class=\"line\"><span class=\"number\">46</span>:         &#125;</div><div class=\"line\"><span class=\"number\">47</span>:     &#125;</div><div class=\"line\"><span class=\"number\">48</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæäº¤<strong>ç«‹å³</strong>æ¶ˆè´¹è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šæäº¤æ¶ˆæ¯å°äºç­‰äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œç›´æ¥æäº¤æ¶ˆè´¹è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 23 è‡³ 47 è¡Œ ï¼šå½“æäº¤æ¶ˆæ¯å¤§äºæ‰¹é‡æ¶ˆè´¹æ•°ï¼Œè¿›è¡Œåˆ†æ‹†æˆå¤šä¸ªè¯·æ±‚ã€‚\n<ul>\n<li>ç¬¬ 25 è‡³ 33 è¡Œ ï¼šè®¡ç®—å½“å‰æ‹†åˆ†è¯·æ±‚åŒ…å«çš„æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 35 è‡³ 38 è¡Œ ï¼šæäº¤æ‹†åˆ†æ¶ˆè´¹è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 39 è‡³ 44 è¡Œ ï¼šæäº¤è¯·æ±‚è¢«æ‹’ç»ï¼Œåˆ™å°†å½“å‰æ‹†åˆ†æ¶ˆæ¯ + å‰©ä½™æ¶ˆæ¯æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ï¼Œç»“æŸæ‹†åˆ†å¾ªç¯ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3>ConsumeMessageConcurrentlyService#submitConsumeRequestLater</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯åˆ—è¡¨</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> processQueue æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> messageQueue æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 7:  */</div><div class=\"line\"> <span class=\"number\">8</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">submitConsumeRequestLater</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs, //</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">final</span> ProcessQueue processQueue, //</div><div class=\"line\"><span class=\"number\">11</span>:     <span class=\"keyword\">final</span> MessageQueue messageQueue//</div><div class=\"line\"><span class=\"number\">12</span>: ) &#123;</div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">this</span>.scheduledExecutorService.schedule(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"><span class=\"number\">15</span>: </div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">18</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.submitConsumeRequest(msgs, processQueue, messageQueue, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">19</span>:         &#125;</div><div class=\"line\"><span class=\"number\">20</span>:     &#125;, <span class=\"number\">5000</span>, TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">21</span>: &#125;</div><div class=\"line\"><span class=\"number\">22</span>: </div><div class=\"line\"><span class=\"number\">23</span>: <span class=\"comment\">/**</span></div><div class=\"line\">24:  * æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚</div><div class=\"line\">25:  * <span class=\"doctag\">@param</span> consumeRequest æ¶ˆè´¹è¯·æ±‚</div><div class=\"line\">26:  */</div><div class=\"line\"><span class=\"number\">27</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">submitConsumeRequestLater</span><span class=\"params\">(<span class=\"keyword\">final</span> ConsumeRequest consumeRequest//</span></span></div><div class=\"line\"><span class=\"number\">28</span>: ) &#123;</div><div class=\"line\"><span class=\"number\">29</span>: </div><div class=\"line\"><span class=\"number\">30</span>:     <span class=\"keyword\">this</span>.scheduledExecutorService.schedule(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">33</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">34</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumeExecutor.submit(consumeRequest); <span class=\"comment\">// TODO BUG ?</span></div><div class=\"line\"><span class=\"number\">35</span>:         &#125;</div><div class=\"line\"><span class=\"number\">36</span>:     &#125;, <span class=\"number\">5000</span>, TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">37</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚</li>\n<li>ç¬¬ 34 è¡Œ ï¼šç›´æ¥è°ƒç”¨ <code>ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);</code>ã€‚å¦‚æœæ¶ˆæ¯æ•°è¶…è¿‡æ‰¹é‡æ¶ˆè´¹ä¸Šé™ï¼Œä¼šä¸ä¼šæ˜¯<strong>BUG</strong>ã€‚</li>\n</ul>\n<h2>ConsumeRequest</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\">  <span class=\"number\">1</span>: <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConsumeRequest</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</div><div class=\"line\">  <span class=\"number\">2</span>: </div><div class=\"line\">  <span class=\"number\">3</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  4:      * æ¶ˆè´¹æ¶ˆæ¯åˆ—è¡¨</div><div class=\"line\">  5:      */</div><div class=\"line\">  <span class=\"number\">6</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs;</div><div class=\"line\">  <span class=\"number\">7</span>:     <span class=\"comment\">/**</span></div><div class=\"line\">  8:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</div><div class=\"line\">  9:      */</div><div class=\"line\"> <span class=\"number\">10</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ProcessQueue processQueue;</div><div class=\"line\"> <span class=\"number\">11</span>:     <span class=\"comment\">/**</span></div><div class=\"line\"> 12:      * æ¶ˆæ¯é˜Ÿåˆ—</div><div class=\"line\"> 13:      */</div><div class=\"line\"> <span class=\"number\">14</span>:     <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MessageQueue messageQueue;</div><div class=\"line\"> <span class=\"number\">15</span>: </div><div class=\"line\"> <span class=\"number\">16</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConsumeRequest</span><span class=\"params\">(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">17</span>:         <span class=\"keyword\">this</span>.msgs = msgs;</div><div class=\"line\"> <span class=\"number\">18</span>:         <span class=\"keyword\">this</span>.processQueue = processQueue;</div><div class=\"line\"> <span class=\"number\">19</span>:         <span class=\"keyword\">this</span>.messageQueue = messageQueue;</div><div class=\"line\"> <span class=\"number\">20</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">21</span>: </div><div class=\"line\"> <span class=\"number\">22</span>:     <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">23</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">24</span>:         <span class=\"comment\">// åºŸå¼ƒé˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">25</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.processQueue.isDropped()) &#123;</div><div class=\"line\"> <span class=\"number\">26</span>:             log.info(<span class=\"string\">\"the message queue not be able to consume, because it's dropped. group=&#123;&#125; &#123;&#125;\"</span>, ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumerGroup, <span class=\"keyword\">this</span>.messageQueue);</div><div class=\"line\"> <span class=\"number\">27</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">28</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">29</span>: </div><div class=\"line\"> <span class=\"number\">30</span>:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.messageListener; <span class=\"comment\">// ç›‘å¬å™¨</span></div><div class=\"line\"> <span class=\"number\">31</span>:         ConsumeConcurrentlyContext context = <span class=\"keyword\">new</span> ConsumeConcurrentlyContext(messageQueue); <span class=\"comment\">// æ¶ˆè´¹Context</span></div><div class=\"line\"> <span class=\"number\">32</span>:         ConsumeConcurrentlyStatus status = <span class=\"keyword\">null</span>; <span class=\"comment\">// æ¶ˆè´¹ç»“æœçŠ¶æ€</span></div><div class=\"line\"> <span class=\"number\">33</span>: </div><div class=\"line\"> <span class=\"number\">34</span>:         <span class=\"comment\">// Hook</span></div><div class=\"line\"> <span class=\"number\">35</span>:         ConsumeMessageContext consumeMessageContext = <span class=\"keyword\">null</span>;</div><div class=\"line\"> <span class=\"number\">36</span>:         <span class=\"keyword\">if</span> (ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class=\"line\"> <span class=\"number\">37</span>:             consumeMessageContext = <span class=\"keyword\">new</span> ConsumeMessageContext();</div><div class=\"line\"> <span class=\"number\">38</span>:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());</div><div class=\"line\"> <span class=\"number\">39</span>:             consumeMessageContext.setProps(<span class=\"keyword\">new</span> HashMap&lt;String, String&gt;());</div><div class=\"line\"> <span class=\"number\">40</span>:             consumeMessageContext.setMq(messageQueue);</div><div class=\"line\"> <span class=\"number\">41</span>:             consumeMessageContext.setMsgList(msgs);</div><div class=\"line\"> <span class=\"number\">42</span>:             consumeMessageContext.setSuccess(<span class=\"keyword\">false</span>);</div><div class=\"line\"> <span class=\"number\">43</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);</div><div class=\"line\"> <span class=\"number\">44</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">45</span>: </div><div class=\"line\"> <span class=\"number\">46</span>:         <span class=\"keyword\">long</span> beginTimestamp = System.currentTimeMillis();</div><div class=\"line\"> <span class=\"number\">47</span>:         <span class=\"keyword\">boolean</span> hasException = <span class=\"keyword\">false</span>;</div><div class=\"line\"> <span class=\"number\">48</span>:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; <span class=\"comment\">// æ¶ˆè´¹è¿”å›ç»“æœç±»å‹</span></div><div class=\"line\"> <span class=\"number\">49</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">50</span>:             <span class=\"comment\">// å½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½®Topicä¸ºåŸå§‹Topic</span></div><div class=\"line\"> <span class=\"number\">51</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.resetRetryTopic(msgs);</div><div class=\"line\"> <span class=\"number\">52</span>: </div><div class=\"line\"> <span class=\"number\">53</span>:             <span class=\"comment\">// è®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´</span></div><div class=\"line\"> <span class=\"number\">54</span>:             <span class=\"keyword\">if</span> (msgs != <span class=\"keyword\">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">55</span>:                 <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"> <span class=\"number\">56</span>:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));</div><div class=\"line\"> <span class=\"number\">57</span>:                 &#125;</div><div class=\"line\"> <span class=\"number\">58</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">59</span>: </div><div class=\"line\"> <span class=\"number\">60</span>:             <span class=\"comment\">// è¿›è¡Œæ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">61</span>:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class=\"line\"> <span class=\"number\">62</span>:         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</div><div class=\"line\"> <span class=\"number\">63</span>:             log.warn(<span class=\"string\">\"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">64</span>:                 RemotingHelper.exceptionSimpleDesc(e), <span class=\"comment\">//</span></div><div class=\"line\"> <span class=\"number\">65</span>:                 ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumerGroup,</div><div class=\"line\"> <span class=\"number\">66</span>:                 msgs,</div><div class=\"line\"> <span class=\"number\">67</span>:                 messageQueue);</div><div class=\"line\"> <span class=\"number\">68</span>:             hasException = <span class=\"keyword\">true</span>;</div><div class=\"line\"> <span class=\"number\">69</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">70</span>: </div><div class=\"line\"> <span class=\"number\">71</span>:         <span class=\"comment\">// è§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</span></div><div class=\"line\"> <span class=\"number\">72</span>:         <span class=\"keyword\">long</span> consumeRT = System.currentTimeMillis() - beginTimestamp;</div><div class=\"line\"> <span class=\"number\">73</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == status) &#123;</div><div class=\"line\"> <span class=\"number\">74</span>:             <span class=\"keyword\">if</span> (hasException) &#123;</div><div class=\"line\"> <span class=\"number\">75</span>:                 returnType = ConsumeReturnType.EXCEPTION;</div><div class=\"line\"> <span class=\"number\">76</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"> <span class=\"number\">77</span>:                 returnType = ConsumeReturnType.RETURNNULL;</div><div class=\"line\"> <span class=\"number\">78</span>:             &#125;</div><div class=\"line\"> <span class=\"number\">79</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * <span class=\"number\">60</span> * <span class=\"number\">1000</span>) &#123;</div><div class=\"line\"> <span class=\"number\">80</span>:             returnType = ConsumeReturnType.TIME_OUT;</div><div class=\"line\"> <span class=\"number\">81</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) &#123;</div><div class=\"line\"> <span class=\"number\">82</span>:             returnType = ConsumeReturnType.FAILED;</div><div class=\"line\"> <span class=\"number\">83</span>:         &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) &#123;</div><div class=\"line\"> <span class=\"number\">84</span>:             returnType = ConsumeReturnType.SUCCESS;</div><div class=\"line\"> <span class=\"number\">85</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">86</span>: </div><div class=\"line\"> <span class=\"number\">87</span>:         <span class=\"comment\">// Hook</span></div><div class=\"line\"> <span class=\"number\">88</span>:         <span class=\"keyword\">if</span> (ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class=\"line\"> <span class=\"number\">89</span>:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());</div><div class=\"line\"> <span class=\"number\">90</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">91</span>: </div><div class=\"line\"> <span class=\"number\">92</span>:         <span class=\"comment\">// æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç©ºæ—¶ï¼Œåˆ™è®¾ç½®ä¸ºç¨åé‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"> <span class=\"number\">93</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == status) &#123;</div><div class=\"line\"> <span class=\"number\">94</span>:             log.warn(<span class=\"string\">\"consumeMessage return null, Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;\"</span>,</div><div class=\"line\"> <span class=\"number\">95</span>:                 ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumerGroup,</div><div class=\"line\"> <span class=\"number\">96</span>:                 msgs,</div><div class=\"line\"> <span class=\"number\">97</span>:                 messageQueue);</div><div class=\"line\"> <span class=\"number\">98</span>:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;</div><div class=\"line\"> <span class=\"number\">99</span>:         &#125;</div><div class=\"line\"><span class=\"number\">100</span>: </div><div class=\"line\"><span class=\"number\">101</span>:         <span class=\"comment\">// Hook</span></div><div class=\"line\"><span class=\"number\">102</span>:         <span class=\"keyword\">if</span> (ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class=\"line\"><span class=\"number\">103</span>:             consumeMessageContext.setStatus(status.toString());</div><div class=\"line\"><span class=\"number\">104</span>:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);</div><div class=\"line\"><span class=\"number\">105</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);</div><div class=\"line\"><span class=\"number\">106</span>:         &#125;</div><div class=\"line\"><span class=\"number\">107</span>: </div><div class=\"line\"><span class=\"number\">108</span>:         <span class=\"comment\">// ç»Ÿè®¡</span></div><div class=\"line\"><span class=\"number\">109</span>:         ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.getConsumerStatsManager()</div><div class=\"line\"><span class=\"number\">110</span>:             .incConsumeRT(ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class=\"line\"><span class=\"number\">111</span>: </div><div class=\"line\"><span class=\"number\">112</span>:         <span class=\"comment\">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></div><div class=\"line\"><span class=\"number\">113</span>:         <span class=\"keyword\">if</span> (!processQueue.isDropped()) &#123;</div><div class=\"line\"><span class=\"number\">114</span>:             ConsumeMessageConcurrentlyService.<span class=\"keyword\">this</span>.processConsumeResult(status, context, <span class=\"keyword\">this</span>);</div><div class=\"line\"><span class=\"number\">115</span>:         &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">116</span>:             log.warn(<span class=\"string\">\"processQueue is dropped without process consume result. messageQueue=&#123;&#125;, msgs=&#123;&#125;\"</span>, messageQueue, msgs);</div><div class=\"line\"><span class=\"number\">117</span>:         &#125;</div><div class=\"line\"><span class=\"number\">118</span>:     &#125;</div><div class=\"line\"><span class=\"number\">119</span>: </div><div class=\"line\"><span class=\"number\">120</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæ¶ˆè´¹è¯·æ±‚ã€‚æäº¤è¯·æ±‚æ‰§è¡Œæ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 24 è‡³ 28 è¡Œ ï¼šåºŸå¼ƒå¤„ç†é˜Ÿåˆ—ä¸è¿›è¡Œæ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 34 è‡³ 44 è¡Œ ï¼šHookã€‚</li>\n<li>ç¬¬ 51 è¡Œ ï¼šå½“æ¶ˆæ¯ä¸ºé‡è¯•æ¶ˆæ¯ï¼Œè®¾ç½® <code>Topic</code>ä¸ºåŸå§‹ <code>Topic</code>ã€‚ä¾‹å¦‚ï¼šåŸå§‹ <code>Topic</code> ä¸º <code>TopicTest</code>ï¼Œé‡è¯•æ—¶ <code>Topic</code> ä¸º <code>%RETRY%please_rename_unique_group_name_4</code>ï¼Œç»è¿‡è¯¥æ–¹æ³•ï¼Œ<code>Topic</code> è®¾ç½®å› <code>TopicTest</code>ã€‚</li>\n<li>ç¬¬ 53 è‡³ 58 è¡Œ ï¼šè®¾ç½®å¼€å§‹æ¶ˆè´¹æ—¶é—´ã€‚</li>\n<li>ç¬¬ 61 è¡Œ ï¼š<strong>è¿›è¡Œæ¶ˆè´¹</strong>ã€‚</li>\n<li>ç¬¬ 71 è‡³ 85 è¡Œ ï¼šè§£ææ¶ˆè´¹è¿”å›ç»“æœç±»å‹</li>\n<li>ç¬¬ 87 è‡³ 90 è¡Œ ï¼š<code>Hook</code>ã€‚</li>\n<li>ç¬¬ 92 è‡³ 99 è¡Œ ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€æœªç©ºæ—¶ï¼Œåˆ™è®¾ç½®æ¶ˆè´¹ç»“æœçŠ¶æ€ä¸ºç¨åæ¶ˆè´¹ã€‚</li>\n<li>ç¬¬ 101 è‡³ 106 è¡Œ ï¼š<code>Hook</code>ã€‚</li>\n<li>ç¬¬ 108 è‡³ 110 è¡Œ ï¼šç»Ÿè®¡ã€‚</li>\n<li>ç¬¬ 112 è‡³ 117 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚<strong>å¦‚æœæ¶ˆè´¹å¤„ç†é˜Ÿåˆ—è¢«ç§»é™¤ï¼Œæ°å¥½æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§</strong>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#consumemessageconcurrentlyserviceprocessconsumeresult\">ConsumeMessageConcurrentlyService#processConsumeResult(...)</a>ã€‚</li>\n</ul>\n<h2>ConsumeMessageConcurrentlyService#processConsumeResult(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processConsumeResult</span><span class=\"params\">(//</span></span></div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">final</span> ConsumeConcurrentlyStatus status, //</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">final</span> ConsumeConcurrentlyContext context, //</div><div class=\"line\"> <span class=\"number\">4</span>:     <span class=\"keyword\">final</span> ConsumeRequest consumeRequest//</div><div class=\"line\"> <span class=\"number\">5</span>: ) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"keyword\">int</span> ackIndex = context.getAckIndex();</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"comment\">// æ¶ˆæ¯ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">if</span> (consumeRequest.getMsgs().isEmpty())</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>:     <span class=\"comment\">// è®¡ç®—ä»consumeRequest.msgs[0]åˆ°consumeRequest.msgs[ackIndex]çš„æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ</span></div><div class=\"line\"><span class=\"number\">13</span>:     <span class=\"keyword\">switch</span> (status) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:         <span class=\"keyword\">case</span> CONSUME_SUCCESS:</div><div class=\"line\"><span class=\"number\">15</span>:             <span class=\"keyword\">if</span> (ackIndex &gt;= consumeRequest.getMsgs().size()) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                 ackIndex = consumeRequest.getMsgs().size() - <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">17</span>:             &#125;</div><div class=\"line\"><span class=\"number\">18</span>:             <span class=\"comment\">// ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡</span></div><div class=\"line\"><span class=\"number\">19</span>:             <span class=\"keyword\">int</span> ok = ackIndex + <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">20</span>:             <span class=\"keyword\">int</span> failed = consumeRequest.getMsgs().size() - ok;</div><div class=\"line\"><span class=\"number\">21</span>:             <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);</div><div class=\"line\"><span class=\"number\">22</span>:             <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);</div><div class=\"line\"><span class=\"number\">23</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">24</span>:         <span class=\"keyword\">case</span> RECONSUME_LATER:</div><div class=\"line\"><span class=\"number\">25</span>:             ackIndex = -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">26</span>:             <span class=\"comment\">// ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡</span></div><div class=\"line\"><span class=\"number\">27</span>:             <span class=\"keyword\">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),</div><div class=\"line\"><span class=\"number\">28</span>:                 consumeRequest.getMsgs().size());</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">30</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">32</span>:     &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"comment\">// å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">35</span>:     <span class=\"keyword\">switch</span> (<span class=\"keyword\">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class=\"line\"><span class=\"number\">36</span>:         <span class=\"keyword\">case</span> BROADCASTING: <span class=\"comment\">// å¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ°Brokerï¼Œåªæ‰“å°Log</span></div><div class=\"line\"><span class=\"number\">37</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = ackIndex + <span class=\"number\">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class=\"line\"><span class=\"number\">39</span>:                 log.warn(<span class=\"string\">\"BROADCASTING, the message consume failed, drop it, &#123;&#125;\"</span>, msg.toString());</div><div class=\"line\"><span class=\"number\">40</span>:             &#125;</div><div class=\"line\"><span class=\"number\">41</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">42</span>:         <span class=\"keyword\">case</span> CLUSTERING:</div><div class=\"line\"><span class=\"number\">43</span>:             <span class=\"comment\">// å‘å›æ¶ˆæ¯å¤±è´¥åˆ°Brokerã€‚</span></div><div class=\"line\"><span class=\"number\">44</span>:             List&lt;MessageExt&gt; msgBackFailed = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(consumeRequest.getMsgs().size());</div><div class=\"line\"><span class=\"number\">45</span>:             <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = ackIndex + <span class=\"number\">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class=\"line\"><span class=\"number\">46</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class=\"line\"><span class=\"number\">47</span>:                 <span class=\"keyword\">boolean</span> result = <span class=\"keyword\">this</span>.sendMessageBack(msg, context);</div><div class=\"line\"><span class=\"number\">48</span>:                 <span class=\"keyword\">if</span> (!result) &#123;</div><div class=\"line\"><span class=\"number\">49</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"number\">50</span>:                     msgBackFailed.add(msg);</div><div class=\"line\"><span class=\"number\">51</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">52</span>:             &#125;</div><div class=\"line\"><span class=\"number\">53</span>: </div><div class=\"line\"><span class=\"number\">54</span>:             <span class=\"comment\">// å‘å›Brokerå¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹</span></div><div class=\"line\"><span class=\"number\">55</span>:             <span class=\"keyword\">if</span> (!msgBackFailed.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">56</span>:                 consumeRequest.getMsgs().removeAll(msgBackFailed);</div><div class=\"line\"><span class=\"number\">57</span>: </div><div class=\"line\"><span class=\"number\">58</span>:                 <span class=\"keyword\">this</span>.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());</div><div class=\"line\"><span class=\"number\">59</span>:             &#125;</div><div class=\"line\"><span class=\"number\">60</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">61</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">62</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">63</span>:     &#125;</div><div class=\"line\"><span class=\"number\">64</span>: </div><div class=\"line\"><span class=\"number\">65</span>:     <span class=\"comment\">// ç§»é™¤æ¶ˆè´¹æˆåŠŸæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"><span class=\"number\">66</span>:     <span class=\"keyword\">long</span> offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());</div><div class=\"line\"><span class=\"number\">67</span>:     <span class=\"keyword\">if</span> (offset &gt;= <span class=\"number\">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class=\"line\"><span class=\"number\">68</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, <span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">69</span>:     &#125;</div><div class=\"line\"><span class=\"number\">70</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>\n<li>ç¬¬ 8 è‡³ 10 è¡Œ ï¼šæ¶ˆè´¹è¯·æ±‚æ¶ˆæ¯æœªç©ºæ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li>\n<li>ç¬¬ 12 è‡³ 32 è¡Œ ï¼šè®¡ç®— <code>ackIndex</code> å€¼ã€‚<code>consumeRequest.msgs[0 - ackIndex]</code>ä¸ºæ¶ˆè´¹æˆåŠŸï¼Œéœ€è¦è¿›è¡Œ <code>ack</code> ç¡®è®¤ã€‚\n<ul>\n<li>ç¬¬ 14 è‡³ 23 è¡Œ ï¼š<code>CONSUME_SUCCESS</code> ï¼š<code>ackIndex = context.getAckIndex()</code>ã€‚</li>\n<li>ç¬¬ 24 è‡³ 29 è¡Œ ï¼š<code>RECONSUME_LATER</code> ï¼š<code>ackIndex = -1</code>ã€‚</li>\n</ul>\n</li>\n<li>ç¬¬34 è‡³ 63 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ã€‚\n<ul>\n<li>ç¬¬ 36 è‡³ 41 è¡Œ ï¼š<code>BROADCASTING</code> ï¼šå¹¿æ’­æ¨¡å¼ï¼Œæ— è®ºæ˜¯å¦æ¶ˆè´¹å¤±è´¥ï¼Œä¸å‘å›æ¶ˆæ¯åˆ° <code>Broker</code>ï¼Œåªæ‰“å°æ—¥å¿—ã€‚</li>\n<li>ç¬¬ 42 è‡³ 60 è¡Œ ï¼š<code>CLUSTERING</code> ï¼šé›†ç¾¤æ¨¡å¼ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å‘å›åˆ° <code>Broker</code>ã€‚\n<ul>\n<li>ç¬¬ 43 è‡³ 52 è¡Œ ï¼šå‘å›æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯åˆ° <code>Broker</code>ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#defaultmqpushconsumerimplsendmessageback\">DefaultMQPushConsumerImpl#sendMessageBack(...)</a>ã€‚</li>\n<li>ç¬¬ 54 è‡³ 59 è¡Œ ï¼šå‘å› <code>Broker</code> å¤±è´¥çš„æ¶ˆæ¯ï¼Œç›´æ¥æäº¤å»¶è¿Ÿé‡æ–°æ¶ˆè´¹ã€‚</li>\n<li><strong>å¦‚æœå‘å› <code>Broker</code> æˆåŠŸï¼Œç»“æœå› ä¸ºä¾‹å¦‚ç½‘ç»œå¼‚å¸¸ï¼Œå¯¼è‡´ <code>Consumer</code>ä»¥ä¸ºå‘å›å¤±è´¥ï¼Œåˆ¤å®šæ¶ˆè´¹å‘å›å¤±è´¥ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯æ¶ˆè´¹è¦å°½æœ€å¤§å¯èƒ½æ€§å®ç°å¹‚ç­‰æ€§ã€‚</strong></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ç¬¬ 65 è‡³ 69 è¡Œ ï¼šç§»é™¤**ã€æ¶ˆè´¹æˆåŠŸã€‘<strong>å’Œ</strong>ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘**çš„æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æœ€æ–°æ¶ˆè´¹è¿›åº¦ã€‚\n<ul>\n<li>ä¸ºä»€ä¹ˆä¼šæœ‰**ã€æ¶ˆè´¹å¤±è´¥ä½†å‘å›<code>Broker</code>æˆåŠŸã€‘<strong>çš„æ¶ˆæ¯ï¼Ÿè§</strong>ç¬¬ 56 è¡Œ**ã€‚</li>\n<li><a href=\"#processqueueremovemessage\">ProcessQueue#removeMessage(...)</a></li>\n</ul>\n</li>\n</ul>\n<h3>ProcessQueue#removeMessage(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * ç§»é™¤æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç¬¬ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class=\"line\"> 3:  *</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> msgs æ¶ˆæ¯</div><div class=\"line\"> 5:  * <span class=\"doctag\">@return</span> æ¶ˆæ¯é˜Ÿåˆ—ä½ç½®</div><div class=\"line\"> 6:  */</div><div class=\"line\"> <span class=\"number\">7</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">removeMessage</span><span class=\"params\">(<span class=\"keyword\">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">long</span> result = -<span class=\"number\">1</span>;</div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now = System.currentTimeMillis();</div><div class=\"line\"><span class=\"number\">10</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">11</span>:         <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">this</span>.lastConsumeTimestamp = now;</div><div class=\"line\"><span class=\"number\">13</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 result = <span class=\"keyword\">this</span>.queueOffsetMax + <span class=\"number\">1</span>; <span class=\"comment\">// è¿™é‡Œ+1çš„åŸå› æ˜¯ï¼šå¦‚æœmsgTreeMapä¸ºç©ºæ—¶ï¼Œä¸‹ä¸€æ¡è·å¾—çš„æ¶ˆæ¯ä½ç½®ä¸ºqueueOffsetMax+1</span></div><div class=\"line\"><span class=\"number\">16</span>: </div><div class=\"line\"><span class=\"number\">17</span>:                 <span class=\"comment\">// ç§»é™¤æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">18</span>:                 <span class=\"keyword\">int</span> removedCnt = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"number\">19</span>:                 <span class=\"keyword\">for</span> (MessageExt msg : msgs) &#123;</div><div class=\"line\"><span class=\"number\">20</span>:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());</div><div class=\"line\"><span class=\"number\">21</span>:                     <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                         removedCnt--;</div><div class=\"line\"><span class=\"number\">23</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">24</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">25</span>:                 msgCount.addAndGet(removedCnt);</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:                 <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">28</span>:                     result = msgTreeMap.firstKey();</div><div class=\"line\"><span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">30</span>:             &#125;</div><div class=\"line\"><span class=\"number\">31</span>:         &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:     &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:         log.error(<span class=\"string\">\"removeMessage exception\"</span>, t);</div><div class=\"line\"><span class=\"number\">36</span>:     &#125;</div><div class=\"line\"><span class=\"number\">37</span>: </div><div class=\"line\"><span class=\"number\">38</span>:     <span class=\"keyword\">return</span> result;</div><div class=\"line\"><span class=\"number\">39</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h2>ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">this</span>.cleanExpireMsgExecutors.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">3</span>: </div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:             cleanExpireMsg();</div><div class=\"line\"> <span class=\"number\">7</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:     &#125;, <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeTimeout(), <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);</div><div class=\"line\"><span class=\"number\">10</span>: &#125;</div><div class=\"line\"><span class=\"number\">11</span>: </div><div class=\"line\"><span class=\"number\">12</span>: <span class=\"comment\">/**</span></div><div class=\"line\">13:  * æ¸…ç†è¿‡æœŸæ¶ˆæ¯</div><div class=\"line\">14:  */</div><div class=\"line\"><span class=\"number\">15</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">cleanExpireMsg</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">16</span>:     Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it =</div><div class=\"line\"><span class=\"number\">17</span>:         <span class=\"keyword\">this</span>.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">while</span> (it.hasNext()) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:         Map.Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class=\"line\"><span class=\"number\">20</span>:         ProcessQueue pq = next.getValue();</div><div class=\"line\"><span class=\"number\">21</span>:         pq.cleanExpiredMsg(<span class=\"keyword\">this</span>.defaultMQPushConsumer);</div><div class=\"line\"><span class=\"number\">22</span>:     &#125;</div><div class=\"line\"><span class=\"number\">23</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå®šæ—¶æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼Œé»˜è®¤å‘¨æœŸï¼š15minã€‚</li>\n</ul>\n<h3>ProcessQueue#cleanExpiredMsg(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">cleanExpiredMsg</span><span class=\"params\">(DefaultMQPushConsumer pushConsumer)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">// é¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›</span></div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">5</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">6</span>: </div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"comment\">// å¾ªç¯ç§»é™¤æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">int</span> loop = msgTreeMap.size() &lt; <span class=\"number\">16</span> ? msgTreeMap.size() : <span class=\"number\">16</span>; <span class=\"comment\">// æ¯æ¬¡å¾ªç¯æœ€å¤šç§»é™¤16æ¡</span></div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; loop; i++) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"comment\">// è·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯</span></div><div class=\"line\"><span class=\"number\">11</span>:         MessageExt msg = <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">12</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:             <span class=\"keyword\">this</span>.lockTreeMap.readLock().lockInterruptibly();</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty() &amp;&amp; System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) &gt; pushConsumer.getConsumeTimeout() * <span class=\"number\">60</span> * <span class=\"number\">1000</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                     msg = msgTreeMap.firstEntry().getValue();</div><div class=\"line\"><span class=\"number\">17</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">18</span>:                     <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">19</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">20</span>:             &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">21</span>:                 <span class=\"keyword\">this</span>.lockTreeMap.readLock().unlock();</div><div class=\"line\"><span class=\"number\">22</span>:             &#125;</div><div class=\"line\"><span class=\"number\">23</span>:         &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:             log.error(<span class=\"string\">\"getExpiredMsg exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">25</span>:         &#125;</div><div class=\"line\"><span class=\"number\">26</span>: </div><div class=\"line\"><span class=\"number\">27</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">28</span>:             <span class=\"comment\">// å‘å›è¶…æ—¶æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">29</span>:             pushConsumer.sendMessageBack(msg, <span class=\"number\">3</span>);</div><div class=\"line\"><span class=\"number\">30</span>:             log.info(<span class=\"string\">\"send expire msg back. topic=&#123;&#125;, msgId=&#123;&#125;, storeHost=&#123;&#125;, queueId=&#123;&#125;, queueOffset=&#123;&#125;\"</span>, msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());</div><div class=\"line\"><span class=\"number\">31</span>: </div><div class=\"line\"><span class=\"number\">32</span>:             <span class=\"comment\">// åˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤</span></div><div class=\"line\"><span class=\"number\">33</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">34</span>:                 <span class=\"keyword\">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class=\"line\"><span class=\"number\">35</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">36</span>:                     <span class=\"keyword\">if</span> (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey()) &#123;</div><div class=\"line\"><span class=\"number\">37</span>:                         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">38</span>:                             msgTreeMap.remove(msgTreeMap.firstKey());</div><div class=\"line\"><span class=\"number\">39</span>:                         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">40</span>:                             log.error(<span class=\"string\">\"send expired msg exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">41</span>:                         &#125;</div><div class=\"line\"><span class=\"number\">42</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">43</span>:                 &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\"><span class=\"number\">44</span>:                     <span class=\"keyword\">this</span>.lockTreeMap.writeLock().unlock();</div><div class=\"line\"><span class=\"number\">45</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">46</span>:             &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\"><span class=\"number\">47</span>:                 log.error(<span class=\"string\">\"getExpiredMsg exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">48</span>:             &#125;</div><div class=\"line\"><span class=\"number\">49</span>:         &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">50</span>:             log.error(<span class=\"string\">\"send expired msg exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">51</span>:         &#125;</div><div class=\"line\"><span class=\"number\">52</span>:     &#125;</div><div class=\"line\"><span class=\"number\">53</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šç§»é™¤è¿‡æœŸæ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 2 è‡³ 5 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚</li>\n<li>ç¬¬ 7 è‡³ 9 è¡Œ ï¼šå¾ªç¯ç§»é™¤æ¶ˆæ¯ã€‚é»˜è®¤æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼š16æ¬¡ã€‚</li>\n<li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šè·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè‹¥ä¸è¶…æ—¶ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚</li>\n<li>ç¬¬ 29 è¡Œ ï¼š<strong>å‘å›è¶…æ—¶æ¶ˆæ¯åˆ°<code>Broker</code></strong>ã€‚</li>\n<li>ç¬¬ 32 è‡³ 48 è¡Œ ï¼šåˆ¤æ–­æ­¤æ—¶æ¶ˆæ¯æ˜¯å¦ä¾ç„¶æ˜¯ç¬¬ä¸€æ¡ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¿›è¡Œç§»é™¤ã€‚</li>\n</ul>\n<h1>7ã€PushConsumer å‘å›æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯</h1>\n<h2>DefaultMQPushConsumerImpl#sendMessageBack(...)</h2>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendMessageBack</span><span class=\"params\">(MessageExt msg, <span class=\"keyword\">int</span> delayLevel, <span class=\"keyword\">final</span> String brokerName)</span></span></div><div class=\"line\"> 2:     <span class=\"keyword\">throws</span> RemotingException, MQBrokerException, InterruptedException, MQClientException &#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"comment\">// Consumerå‘å›æ¶ˆæ¯</span></div><div class=\"line\"> <span class=\"number\">5</span>:         String brokerAddr = (<span class=\"keyword\">null</span> != brokerName) ? <span class=\"keyword\">this</span>.mQClientFactory.findBrokerAddressInPublish(brokerName)</div><div class=\"line\"> <span class=\"number\">6</span>:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());</div><div class=\"line\"> <span class=\"number\">7</span>:         <span class=\"keyword\">this</span>.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,</div><div class=\"line\"> <span class=\"number\">8</span>:             <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup(), delayLevel, <span class=\"number\">5000</span>, getMaxReconsumeTimes());</div><div class=\"line\"> <span class=\"number\">9</span>:     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123; <span class=\"comment\">// TODO ç–‘é—®ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸</span></div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"comment\">// å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨Clientå†…ç½®Producerå‘å›æ¶ˆæ¯</span></div><div class=\"line\"><span class=\"number\">11</span>:         log.error(<span class=\"string\">\"sendMessageBack Exception, \"</span> + <span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup(), e);</div><div class=\"line\"><span class=\"number\">12</span>: </div><div class=\"line\"><span class=\"number\">13</span>:         Message newMsg = <span class=\"keyword\">new</span> Message(MixAll.getRetryTopic(<span class=\"keyword\">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class=\"line\"><span class=\"number\">14</span>: </div><div class=\"line\"><span class=\"number\">15</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class=\"line\"><span class=\"number\">16</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class=\"line\"><span class=\"number\">17</span>: </div><div class=\"line\"><span class=\"number\">18</span>:         newMsg.setFlag(msg.getFlag());</div><div class=\"line\"><span class=\"number\">19</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class=\"line\"><span class=\"number\">20</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class=\"line\"><span class=\"number\">21</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + <span class=\"number\">1</span>));</div><div class=\"line\"><span class=\"number\">22</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class=\"line\"><span class=\"number\">23</span>:         newMsg.setDelayTimeLevel(<span class=\"number\">3</span> + msg.getReconsumeTimes());</div><div class=\"line\"><span class=\"number\">24</span>: </div><div class=\"line\"><span class=\"number\">25</span>:         <span class=\"keyword\">this</span>.mQClientFactory.getDefaultMQProducer().send(newMsg);</div><div class=\"line\"><span class=\"number\">26</span>:     &#125;</div><div class=\"line\"><span class=\"number\">27</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå‘å›æ¶ˆæ¯ã€‚</li>\n<li>ç¬¬ 4 è‡³ 8 è¡Œ ï¼š<code>Consumer</code> å‘å›æ¶ˆæ¯ã€‚è¯¦ç»†è§£æè§ï¼š<a href=\"#mqclientapiimplconsumersendmessageback\">MQClientAPIImpl#consumerSendMessageBack(...)</a>ã€‚</li>\n<li>ç¬¬ 10 è‡³ 25 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ<code>Consumer</code> å†…ç½®é»˜è®¤ <code>Producer</code> å‘é€æ¶ˆæ¯ã€‚\n<ul>\n<li>ğŸ˜ˆç–‘é—®ï¼šä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸å‘¢ï¼Ÿ</li>\n</ul>\n</li>\n</ul>\n<h3>MQClientAPIImpl#consumerSendMessageBack(...)</h3>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"comment\">/**</span></div><div class=\"line\"> 2:  * Consumerå‘å›æ¶ˆæ¯</div><div class=\"line\"> 3:  * <span class=\"doctag\">@param</span> addr Brokeråœ°å€</div><div class=\"line\"> 4:  * <span class=\"doctag\">@param</span> msg æ¶ˆæ¯</div><div class=\"line\"> 5:  * <span class=\"doctag\">@param</span> consumerGroup æ¶ˆè´¹åˆ†ç»„</div><div class=\"line\"> 6:  * <span class=\"doctag\">@param</span> delayLevel å»¶è¿Ÿçº§åˆ«</div><div class=\"line\"> 7:  * <span class=\"doctag\">@param</span> timeoutMillis è¶…æ—¶</div><div class=\"line\"> 8:  * <span class=\"doctag\">@param</span> maxConsumeRetryTimes æ¶ˆè´¹æœ€å¤§é‡è¯•æ¬¡æ•°</div><div class=\"line\"> 9:  * <span class=\"doctag\">@throws</span> RemotingException å½“è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">10:  * <span class=\"doctag\">@throws</span> MQBrokerException å½“Brokerå‘ç”Ÿå¼‚å¸¸æ—¶</div><div class=\"line\">11:  * <span class=\"doctag\">@throws</span> InterruptedException å½“çº¿ç¨‹ä¸­æ–­æ—¶</div><div class=\"line\">12:  */</div><div class=\"line\"><span class=\"number\">13</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">consumerSendMessageBack</span><span class=\"params\">(</span></span></div><div class=\"line\"><span class=\"number\">14</span>:     <span class=\"keyword\">final</span> String addr,</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">final</span> MessageExt msg,</div><div class=\"line\"><span class=\"number\">16</span>:     <span class=\"keyword\">final</span> String consumerGroup,</div><div class=\"line\"><span class=\"number\">17</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> delayLevel,</div><div class=\"line\"><span class=\"number\">18</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> timeoutMillis,</div><div class=\"line\"><span class=\"number\">19</span>:     <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxConsumeRetryTimes</div><div class=\"line\"><span class=\"number\">20</span>: ) <span class=\"keyword\">throws</span> RemotingException, MQBrokerException, InterruptedException &#123;</div><div class=\"line\"><span class=\"number\">21</span>:     ConsumerSendMsgBackRequestHeader requestHeader = <span class=\"keyword\">new</span> ConsumerSendMsgBackRequestHeader();</div><div class=\"line\"><span class=\"number\">22</span>:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</div><div class=\"line\"><span class=\"number\">23</span>: </div><div class=\"line\"><span class=\"number\">24</span>:     requestHeader.setGroup(consumerGroup);</div><div class=\"line\"><span class=\"number\">25</span>:     requestHeader.setOriginTopic(msg.getTopic());</div><div class=\"line\"><span class=\"number\">26</span>:     requestHeader.setOffset(msg.getCommitLogOffset());</div><div class=\"line\"><span class=\"number\">27</span>:     requestHeader.setDelayLevel(delayLevel);</div><div class=\"line\"><span class=\"number\">28</span>:     requestHeader.setOriginMsgId(msg.getMsgId());</div><div class=\"line\"><span class=\"number\">29</span>:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:     RemotingCommand response = <span class=\"keyword\">this</span>.remotingClient.invokeSync(MixAll.brokerVIPChannel(<span class=\"keyword\">this</span>.clientConfig.isVipChannelEnabled(), addr),</div><div class=\"line\"><span class=\"number\">32</span>:         request, timeoutMillis);</div><div class=\"line\"><span class=\"number\">33</span>:     <span class=\"keyword\">assert</span> response != <span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"keyword\">switch</span> (response.getCode()) &#123;</div><div class=\"line\"><span class=\"number\">35</span>:         <span class=\"keyword\">case</span> ResponseCode.SUCCESS: &#123;</div><div class=\"line\"><span class=\"number\">36</span>:             <span class=\"keyword\">return</span>;</div><div class=\"line\"><span class=\"number\">37</span>:         &#125;</div><div class=\"line\"><span class=\"number\">38</span>:         <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">39</span>:             <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">40</span>:     &#125;</div><div class=\"line\"><span class=\"number\">41</span>: </div><div class=\"line\"><span class=\"number\">42</span>:     <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MQBrokerException(response.getCode(), response.getRemark());</div><div class=\"line\"><span class=\"number\">43</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h1>8ã€Consumer æ¶ˆè´¹è¿›åº¦</h1>\n<h2>OffsetStore</h2>\n<p><img src=\"http://www.yunai.me/images/RocketMQ/2017_05_04/07.png\" alt=\"OffsetStoreç±»å›¾.png\"></p>\n<ul>\n<li><code>RemoteBrokerOffsetStore</code> ï¼š<code>Consumer</code> <strong>é›†ç¾¤æ¨¡å¼</strong> ä¸‹ï¼Œä½¿ç”¨è¿œç¨‹ <code>Broker</code> æ¶ˆè´¹è¿›åº¦ã€‚</li>\n<li><code>LocalFileOffsetStore</code> ï¼š<code>Consumer</code> <strong>å¹¿æ’­æ¨¡å¼</strong>ä¸‹ï¼Œä½¿ç”¨æœ¬åœ° <code>æ–‡ä»¶</code> æ¶ˆè´¹è¿›åº¦ã€‚</li>\n</ul>\n<h3>OffsetStore#load(...)</h3>\n<h4>LocalFileOffsetStore#load(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">load</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"comment\">// ä»æœ¬åœ°ç¡¬ç›˜è¯»å–æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">4</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class=\"keyword\">this</span>.readLocalOffset();</div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"keyword\">if</span> (offsetSerializeWrapper != <span class=\"keyword\">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());</div><div class=\"line\"> <span class=\"number\">7</span>: </div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"comment\">// æ‰“å°æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">for</span> (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class=\"line\"><span class=\"number\">11</span>:             log.info(<span class=\"string\">\"load consumer's offset, &#123;&#125; &#123;&#125; &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">12</span>:                 <span class=\"keyword\">this</span>.groupName,</div><div class=\"line\"><span class=\"number\">13</span>:                 mq,</div><div class=\"line\"><span class=\"number\">14</span>:                 offset.get());</div><div class=\"line\"><span class=\"number\">15</span>:         &#125;</div><div class=\"line\"><span class=\"number\">16</span>:     &#125;</div><div class=\"line\"><span class=\"number\">17</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ¶ˆè´¹è¿›åº¦åˆ°å†…å­˜ã€‚</li>\n</ul>\n<h5>OffsetSerializeWrapper</h5>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OffsetSerializeWrapper</span> <span class=\"keyword\">extends</span> <span class=\"title\">RemotingSerializable</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"keyword\">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable =</div><div class=\"line\"> <span class=\"number\">3</span>:             <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:     <span class=\"function\"><span class=\"keyword\">public</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; <span class=\"title\">getOffsetTable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"keyword\">return</span> offsetTable;</div><div class=\"line\"> <span class=\"number\">7</span>:     &#125;</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setOffsetTable</span><span class=\"params\">(ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable)</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">10</span>:         <span class=\"keyword\">this</span>.offsetTable = offsetTable;</div><div class=\"line\"><span class=\"number\">11</span>:     &#125;</div><div class=\"line\"><span class=\"number\">12</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæœ¬åœ° <code>Offset</code> å­˜å‚¨åºåˆ—åŒ–ã€‚</li>\n</ul>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><div class=\"line\">Yunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json</div><div class=\"line\">&#123;</div><div class=\"line\">\t<span class=\"string\">\"offsetTable\"</span>:&#123;&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"brokerName\"</span>:<span class=\"string\">\"broker-a\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"queueId\"</span>:3,</div><div class=\"line\">\t\t\t<span class=\"string\">\"topic\"</span>:<span class=\"string\">\"TopicTest\"</span></div><div class=\"line\">\t\t&#125;:1470,&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"brokerName\"</span>:<span class=\"string\">\"broker-a\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"queueId\"</span>:2,</div><div class=\"line\">\t\t\t<span class=\"string\">\"topic\"</span>:<span class=\"string\">\"TopicTest\"</span></div><div class=\"line\">\t\t&#125;:1471,&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"brokerName\"</span>:<span class=\"string\">\"broker-a\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"queueId\"</span>:1,</div><div class=\"line\">\t\t\t<span class=\"string\">\"topic\"</span>:<span class=\"string\">\"TopicTest\"</span></div><div class=\"line\">\t\t&#125;:1470,&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"brokerName\"</span>:<span class=\"string\">\"broker-a\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"queueId\"</span>:0,</div><div class=\"line\">\t\t\t<span class=\"string\">\"topic\"</span>:<span class=\"string\">\"TopicTest\"</span></div><div class=\"line\">\t\t&#125;:1470</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h4>RemoteBrokerOffsetStore#load(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">load</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"><span class=\"number\">3</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šä¸è¿›è¡ŒåŠ è½½ï¼Œå®é™…è¯»å–æ¶ˆè´¹è¿›åº¦æ—¶ï¼Œä» <code>Broker</code> è·å–ã€‚</li>\n</ul>\n<h3>OffsetStore#readOffset(...)</h3>\n<p>è¯»å–æ¶ˆè´¹è¿›åº¦ç±»å‹ï¼š</p>\n<ul>\n<li><code>READ_FROM_MEMORY</code> ï¼šä»å†…å­˜è¯»å–ã€‚</li>\n<li><code>READ_FROM_STORE</code> ï¼šä»å­˜å‚¨( <code>Broker</code> æˆ– <code>æ–‡ä»¶</code> )è¯»å–ã€‚</li>\n<li><code>MEMORY_FIRST_THEN_STORE</code> ï¼šä¼˜å…ˆä»å†…å­˜è¯»å–ï¼Œè¯»å–ä¸åˆ°ï¼Œä»å­˜å‚¨è¯»å–ã€‚</li>\n</ul>\n<h4>LocalFileOffsetStore#readOffset(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">readOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq, <span class=\"keyword\">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (mq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">switch</span> (type) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">case</span> MEMORY_FIRST_THEN_STORE:</div><div class=\"line\"> <span class=\"number\">6</span>:             <span class=\"keyword\">case</span> READ_FROM_MEMORY: &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:                 AtomicLong offset = <span class=\"keyword\">this</span>.offsetTable.get(mq);</div><div class=\"line\"> <span class=\"number\">8</span>:                 <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:                     <span class=\"keyword\">return</span> offset.get();</div><div class=\"line\"><span class=\"number\">10</span>:                 &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">12</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">13</span>:             &#125;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">case</span> READ_FROM_STORE: &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 OffsetSerializeWrapper offsetSerializeWrapper;</div><div class=\"line\"><span class=\"number\">16</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">17</span>:                     offsetSerializeWrapper = <span class=\"keyword\">this</span>.readLocalOffset();</div><div class=\"line\"><span class=\"number\">18</span>:                 &#125; <span class=\"keyword\">catch</span> (MQClientException e) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">20</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">21</span>:                 <span class=\"keyword\">if</span> (offsetSerializeWrapper != <span class=\"keyword\">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class=\"line\"><span class=\"number\">23</span>:                     <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">24</span>:                         <span class=\"keyword\">this</span>.updateOffset(mq, offset.get(), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">25</span>:                         <span class=\"keyword\">return</span> offset.get();</div><div class=\"line\"><span class=\"number\">26</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">27</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">28</span>:             &#125;</div><div class=\"line\"><span class=\"number\">29</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">30</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">31</span>:         &#125;</div><div class=\"line\"><span class=\"number\">32</span>:     &#125;</div><div class=\"line\"><span class=\"number\">33</span>: </div><div class=\"line\"><span class=\"number\">34</span>:     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">35</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>ç¬¬ 16 è¡Œ ï¼šä» <code>æ–‡ä»¶</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li>\n</ul>\n<h4>RemoteBrokerOffsetStore#readOffset(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">readOffset</span><span class=\"params\">(<span class=\"keyword\">final</span> MessageQueue mq, <span class=\"keyword\">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (mq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">switch</span> (type) &#123;</div><div class=\"line\"> <span class=\"number\">5</span>:             <span class=\"keyword\">case</span> MEMORY_FIRST_THEN_STORE:</div><div class=\"line\"> <span class=\"number\">6</span>:             <span class=\"keyword\">case</span> READ_FROM_MEMORY: &#123;</div><div class=\"line\"> <span class=\"number\">7</span>:                 AtomicLong offset = <span class=\"keyword\">this</span>.offsetTable.get(mq);</div><div class=\"line\"> <span class=\"number\">8</span>:                 <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:                     <span class=\"keyword\">return</span> offset.get();</div><div class=\"line\"><span class=\"number\">10</span>:                 &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">12</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">13</span>:             &#125;</div><div class=\"line\"><span class=\"number\">14</span>:             <span class=\"keyword\">case</span> READ_FROM_STORE: &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                 <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">16</span>:                     <span class=\"keyword\">long</span> brokerOffset = <span class=\"keyword\">this</span>.fetchConsumeOffsetFromBroker(mq);</div><div class=\"line\"><span class=\"number\">17</span>:                     AtomicLong offset = <span class=\"keyword\">new</span> AtomicLong(brokerOffset);</div><div class=\"line\"><span class=\"number\">18</span>:                     <span class=\"keyword\">this</span>.updateOffset(mq, offset.get(), <span class=\"keyword\">false</span>);</div><div class=\"line\"><span class=\"number\">19</span>:                     <span class=\"keyword\">return</span> brokerOffset;</div><div class=\"line\"><span class=\"number\">20</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">21</span>:                 <span class=\"comment\">// No offset in broker</span></div><div class=\"line\"><span class=\"number\">22</span>:                 <span class=\"keyword\">catch</span> (MQBrokerException e) &#123;</div><div class=\"line\"><span class=\"number\">23</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">24</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">25</span>:                 <span class=\"comment\">//Other exceptions</span></div><div class=\"line\"><span class=\"number\">26</span>:                 <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">27</span>:                     log.warn(<span class=\"string\">\"fetchConsumeOffsetFromBroker exception, \"</span> + mq, e);</div><div class=\"line\"><span class=\"number\">28</span>:                     <span class=\"keyword\">return</span> -<span class=\"number\">2</span>;</div><div class=\"line\"><span class=\"number\">29</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">30</span>:             &#125;</div><div class=\"line\"><span class=\"number\">31</span>:             <span class=\"keyword\">default</span>:</div><div class=\"line\"><span class=\"number\">32</span>:                 <span class=\"keyword\">break</span>;</div><div class=\"line\"><span class=\"number\">33</span>:         &#125;</div><div class=\"line\"><span class=\"number\">34</span>:     &#125;</div><div class=\"line\"><span class=\"number\">35</span>: </div><div class=\"line\"><span class=\"number\">36</span>:     <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"number\">37</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>ç¬¬ 16 è¡Œ ï¼šä» <code>Broker</code> è¯»å–æ¶ˆè´¹è¿›åº¦ã€‚</li>\n</ul>\n<h3>OffsetStore#updateOffset(...)</h3>\n<p>è¯¥æ–¹æ³• <code>RemoteBrokerOffsetStore</code> ä¸ <code>LocalFileOffsetStore</code> å®ç°ç›¸åŒã€‚</p>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updateOffset</span><span class=\"params\">(MessageQueue mq, <span class=\"keyword\">long</span> offset, <span class=\"keyword\">boolean</span> increaseOnly)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (mq != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"> <span class=\"number\">4</span>:         AtomicLong offsetOld = <span class=\"keyword\">this</span>.offsetTable.get(mq);</div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == offsetOld) &#123;</div><div class=\"line\"> <span class=\"number\">6</span>:             offsetOld = <span class=\"keyword\">this</span>.offsetTable.putIfAbsent(mq, <span class=\"keyword\">new</span> AtomicLong(offset));</div><div class=\"line\"> <span class=\"number\">7</span>:         &#125;</div><div class=\"line\"> <span class=\"number\">8</span>: </div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != offsetOld) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             <span class=\"keyword\">if</span> (increaseOnly) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);</div><div class=\"line\"><span class=\"number\">12</span>:             &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 offsetOld.set(offset);</div><div class=\"line\"><span class=\"number\">14</span>:             &#125;</div><div class=\"line\"><span class=\"number\">15</span>:         &#125;</div><div class=\"line\"><span class=\"number\">16</span>:     &#125;</div><div class=\"line\"><span class=\"number\">17</span>: &#125;</div></pre></td></tr></table></figure></p>\n<h3>OffsetStore#persistAll(...)</h3>\n<h4>LocalFileOffsetStore#persistAll(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">persistAll</span><span class=\"params\">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mqs || mqs.isEmpty())</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">5</span>: </div><div class=\"line\"> <span class=\"number\">6</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class=\"keyword\">new</span> OffsetSerializeWrapper();</div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class=\"keyword\">this</span>.offsetTable.entrySet()) &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:         <span class=\"keyword\">if</span> (mqs.contains(entry.getKey())) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:             AtomicLong offset = entry.getValue();</div><div class=\"line\"><span class=\"number\">10</span>:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);</div><div class=\"line\"><span class=\"number\">11</span>:         &#125;</div><div class=\"line\"><span class=\"number\">12</span>:     &#125;</div><div class=\"line\"><span class=\"number\">13</span>: </div><div class=\"line\"><span class=\"number\">14</span>:     String jsonString = offsetSerializeWrapper.toJson(<span class=\"keyword\">true</span>);</div><div class=\"line\"><span class=\"number\">15</span>:     <span class=\"keyword\">if</span> (jsonString != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">16</span>:         <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">17</span>:             MixAll.string2File(jsonString, <span class=\"keyword\">this</span>.storePath);</div><div class=\"line\"><span class=\"number\">18</span>:         &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\"><span class=\"number\">19</span>:             log.error(<span class=\"string\">\"persistAll consumer offset Exception, \"</span> + <span class=\"keyword\">this</span>.storePath, e);</div><div class=\"line\"><span class=\"number\">20</span>:         &#125;</div><div class=\"line\"><span class=\"number\">21</span>:     &#125;</div><div class=\"line\"><span class=\"number\">22</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ã€‚<strong>å°†æ¶ˆè´¹è¿›åº¦å†™å…¥æ–‡ä»¶</strong>ã€‚</li>\n</ul>\n<h4>RemoteBrokerOffsetStore#persistAll(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">2</span>: <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">persistAll</span><span class=\"params\">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == mqs || mqs.isEmpty())</div><div class=\"line\"> <span class=\"number\">4</span>:         <span class=\"keyword\">return</span>;</div><div class=\"line\"> <span class=\"number\">5</span>: </div><div class=\"line\"> <span class=\"number\">6</span>:     <span class=\"comment\">// æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"> <span class=\"number\">7</span>:     <span class=\"keyword\">final</span> HashSet&lt;MessageQueue&gt; unusedMQ = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</div><div class=\"line\"> <span class=\"number\">8</span>:     <span class=\"keyword\">if</span> (!mqs.isEmpty()) &#123;</div><div class=\"line\"> <span class=\"number\">9</span>:         <span class=\"keyword\">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class=\"keyword\">this</span>.offsetTable.entrySet()) &#123;</div><div class=\"line\"><span class=\"number\">10</span>:             MessageQueue mq = entry.getKey();</div><div class=\"line\"><span class=\"number\">11</span>:             AtomicLong offset = entry.getValue();</div><div class=\"line\"><span class=\"number\">12</span>:             <span class=\"keyword\">if</span> (offset != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\"><span class=\"number\">13</span>:                 <span class=\"keyword\">if</span> (mqs.contains(mq)) &#123;</div><div class=\"line\"><span class=\"number\">14</span>:                     <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"number\">15</span>:                         <span class=\"keyword\">this</span>.updateConsumeOffsetToBroker(mq, offset.get());</div><div class=\"line\"><span class=\"number\">16</span>:                         log.info(<span class=\"string\">\"[persistAll] Group: &#123;&#125; ClientId: &#123;&#125; updateConsumeOffsetToBroker &#123;&#125; &#123;&#125;\"</span>,</div><div class=\"line\"><span class=\"number\">17</span>:                             <span class=\"keyword\">this</span>.groupName,</div><div class=\"line\"><span class=\"number\">18</span>:                             <span class=\"keyword\">this</span>.mQClientFactory.getClientId(),</div><div class=\"line\"><span class=\"number\">19</span>:                             mq,</div><div class=\"line\"><span class=\"number\">20</span>:                             offset.get());</div><div class=\"line\"><span class=\"number\">21</span>:                     &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">22</span>:                         log.error(<span class=\"string\">\"updateConsumeOffsetToBroker exception, \"</span> + mq.toString(), e);</div><div class=\"line\"><span class=\"number\">23</span>:                     &#125;</div><div class=\"line\"><span class=\"number\">24</span>:                 &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\"><span class=\"number\">25</span>:                     unusedMQ.add(mq);</div><div class=\"line\"><span class=\"number\">26</span>:                 &#125;</div><div class=\"line\"><span class=\"number\">27</span>:             &#125;</div><div class=\"line\"><span class=\"number\">28</span>:         &#125;</div><div class=\"line\"><span class=\"number\">29</span>:     &#125;</div><div class=\"line\"><span class=\"number\">30</span>: </div><div class=\"line\"><span class=\"number\">31</span>:     <span class=\"comment\">// ç§»é™¤ä¸é€‚ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class=\"line\"><span class=\"number\">32</span>:     <span class=\"keyword\">if</span> (!unusedMQ.isEmpty()) &#123;</div><div class=\"line\"><span class=\"number\">33</span>:         <span class=\"keyword\">for</span> (MessageQueue mq : unusedMQ) &#123;</div><div class=\"line\"><span class=\"number\">34</span>:             <span class=\"keyword\">this</span>.offsetTable.remove(mq);</div><div class=\"line\"><span class=\"number\">35</span>:             log.info(<span class=\"string\">\"remove unused mq, &#123;&#125;, &#123;&#125;\"</span>, mq, <span class=\"keyword\">this</span>.groupName);</div><div class=\"line\"><span class=\"number\">36</span>:         &#125;</div><div class=\"line\"><span class=\"number\">37</span>:     &#125;</div><div class=\"line\"><span class=\"number\">38</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šæŒä¹…åŒ–æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ•°ç»„çš„æ¶ˆè´¹è¿›åº¦åˆ° <code>Broker</code>ï¼Œå¹¶ç§»é™¤éæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>\n</ul>\n<h4>MQClientInstance#persistAllConsumerOffset(...)</h4>\n<p><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><div class=\"line\"> <span class=\"number\">1</span>: <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">startScheduledTask</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">2</span>:     <span class=\"comment\">// å®šæ—¶åŒæ­¥æ¶ˆè´¹è¿›åº¦</span></div><div class=\"line\"> <span class=\"number\">3</span>:     <span class=\"keyword\">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"> <span class=\"number\">4</span>: </div><div class=\"line\"> <span class=\"number\">5</span>:         <span class=\"meta\">@Override</span></div><div class=\"line\"> <span class=\"number\">6</span>:         <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"> <span class=\"number\">7</span>:             <span class=\"keyword\">try</span> &#123;</div><div class=\"line\"> <span class=\"number\">8</span>:                 MQClientInstance.<span class=\"keyword\">this</span>.cleanOfflineBroker();</div><div class=\"line\"> <span class=\"number\">9</span>:                 MQClientInstance.<span class=\"keyword\">this</span>.sendHeartbeatToAllBrokerWithLock();</div><div class=\"line\"><span class=\"number\">10</span>:             &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"><span class=\"number\">11</span>:                 log.error(<span class=\"string\">\"ScheduledTask sendHeartbeatToAllBroker exception\"</span>, e);</div><div class=\"line\"><span class=\"number\">12</span>:             &#125;</div><div class=\"line\"><span class=\"number\">13</span>:         &#125;</div><div class=\"line\"><span class=\"number\">14</span>:     &#125;, <span class=\"number\">1000</span>, <span class=\"keyword\">this</span>.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);</div><div class=\"line\"><span class=\"number\">15</span>: &#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>è¯´æ˜ ï¼šå®šæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œé»˜è®¤å‘¨æœŸï¼š5000msã€‚</li>\n<li><strong>é‡è¦è¯´æ˜ ï¼š</strong>\n<ul>\n<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>\n<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>\n<li><strong>æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ä¸ä»…ä»…åªæœ‰å®šæ—¶æŒä¹…åŒ–ï¼Œæ‹‰å–æ¶ˆæ¯ã€åˆ†é…æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰æ“ä½œï¼Œéƒ½ä¼šè¿›è¡Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–ã€‚</strong></li>\n</ul>\n</li>\n</ul>\n<h1>9ã€ç»“å°¾</h1>\n<p>ğŸ˜ˆå¯èƒ½æ˜¯æœ¬ç³»åˆ—æœ€é•¿çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœ‰è¡¨è¾¾é”™è¯¯å’Œä¸æ¸…æ™°ï¼Œè¯·å¤šå¤šè§è°…ã€‚<br>\næ„Ÿè°¢å¯¹æœ¬ç³»åˆ—çš„é˜…è¯»ã€æ”¶è—ã€ç‚¹èµã€åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯ç¿»åˆ°ç»“å°¾ã€‚ğŸ˜œçœŸçš„æœ‰ä¸¢ä¸¢é•¿ã€‚</p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cj3ndswxz0000ak5ddsagcmr8","category_id":"cj3ndswy50002ak5dnd6bu0d3","_id":"cj3ndswyc0006ak5df7ivrdrs"},{"post_id":"cj3ndswy30001ak5dkacfib7t","category_id":"cj3ndswy50002ak5dnd6bu0d3","_id":"cj3ndswyd0008ak5df6tcq791"},{"post_id":"cj3ndswy70003ak5dqar5ogs2","category_id":"cj3ndswyd0007ak5dmtdscxhm","_id":"cj3ndswyd000aak5dx3wydoit"},{"post_id":"cj3ndswy80004ak5dvdnx5nx1","category_id":"cj3ndswyd0009ak5d4emm1j22","_id":"cj3ndswye000bak5dgvb4kqoy"},{"post_id":"cj3ndswyy000cak5dqlledbkt","category_id":"cj3ndswyd0009ak5d4emm1j22","_id":"cj3ndswz6000fak5d6iv0kkdw"},{"post_id":"cj3ndswyz000dak5dznt95eyt","category_id":"cj3ndswyd0009ak5d4emm1j22","_id":"cj3ndswz7000iak5d1ni8uy3z"},{"post_id":"cj3ndswz7000jak5d4ye8mk4a","category_id":"cj3ndswyd0009ak5d4emm1j22","_id":"cj3ndswzd000nak5d4mioz9cz"},{"post_id":"cj3ndswz3000eak5d6n0gq9x6","category_id":"cj3ndswz7000hak5dxnh6u0px","_id":"cj3ndswzf000pak5dkefwrk25"},{"post_id":"cj3ndswze000oak5do25uq5u2","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzk000tak5dh0ss2two"},{"post_id":"cj3ndswz6000gak5d0cr5vqer","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzl000wak5drm77oaw4"},{"post_id":"cj3ndswzf000qak5dc6vlm9fr","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzm000yak5dwwqdp8o6"},{"post_id":"cj3ndswzi000sak5d6egdlx0e","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzn0010ak5dr1at03j2"},{"post_id":"cj3ndswz9000kak5dpc1b2yxg","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzo0012ak5dv7u4ks79"},{"post_id":"cj3ndswzk000uak5dwrxn81cd","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzp0014ak5duufy6y1f"},{"post_id":"cj3ndswzl000xak5dw4kls0uc","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzq0016ak5dto2jvu2f"},{"post_id":"cj3ndswzb000lak5dyr1721jo","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzq0017ak5dn3eqtwtx"},{"post_id":"cj3ndswzm000zak5d4zpi9pvo","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzq0018ak5dnlela0y2"},{"post_id":"cj3ndswzn0011ak5dpbi560lr","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzq0019ak5db356etk2"},{"post_id":"cj3ndswzo0013ak5dms6d77z0","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzq001aak5dxb0ydno6"},{"post_id":"cj3ndswzp0015ak5dhn54abq7","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzq001bak5dmrsxj0zr"},{"post_id":"cj3ndswzt001cak5df0zlrv6s","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzx001eak5dzpvzk5e8"},{"post_id":"cj3ndswzu001dak5dlnkm040q","category_id":"cj3ndswzd000mak5d0zzzjv6s","_id":"cj3ndswzx001fak5d93ko3101"}],"PostTag":[],"Tag":[]}}